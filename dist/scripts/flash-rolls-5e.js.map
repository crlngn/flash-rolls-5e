{"version":3,"file":"flash-rolls-5e.js","sources":["../../src/constants/Settings.mjs","../../src/constants/General.mjs","../../src/constants/Hooks.mjs","../../src/components/LogUtil.mjs","../../src/components/SocketUtil.mjs","../../src/components/DiceConfigUtil.mjs","../../src/components/helpers/GeneralUtil.mjs","../../src/components/dialogs/ModuleSettingsMenu.mjs","../../src/constants/SettingMenus.mjs","../../src/components/SettingsUtil.mjs","../../src/components/dialogs/gm-dialogs/GMRollConfigMixin.mjs","../../src/components/helpers/Helpers.mjs","../../src/components/helpers/RollHelpers.mjs","../../src/components/dialogs/gm-dialogs/GMRollConfigDialog.mjs","../../src/components/dialogs/gm-dialogs/GMHitDieConfigDialog.mjs","../../src/components/dialogs/gm-dialogs/GMSkillToolConfigDialog.mjs","../../src/components/dialogs/gm-dialogs/GMDamageConfigDialog.mjs","../../src/components/dialogs/gm-dialogs/GMAttackConfigDialog.mjs","../../src/components/helpers/ModuleHelpers.mjs","../../src/components/ActivityUtil.mjs","../../src/components/dialogs/CustomRollDialog.mjs","../../src/components/ChatMessageUtils.mjs","../../src/components/RollHandlers.mjs","../../src/components/helpers/RollValidationHelpers.mjs","../../src/components/RollInterceptor.mjs","../../src/components/utils/RollMenuActorUtil.mjs","../../src/components/utils/RollMenuConfigUtil.mjs","../../src/components/utils/RollMenuOrchestrationUtil.mjs","../../src/components/utils/RollMenuDragUtil.mjs","../../src/components/RollRequestsMenu.mjs","../../src/components/SidebarUtil.mjs","../../src/components/HooksUtil.mjs","../../src/components/RollRequestUtil.mjs","../../src/components/Main.mjs","../../src/module.mjs"],"sourcesContent":["export const SETTING_INPUT = {\n  select: \"select\", \n  checkbox: \"checkbox\"\n}\nexport const SETTING_SCOPE = {\n  client: \"client\",\n  world: \"world\"\n}\n\n/**\n * Get all module settings\n * @returns {Object} Module settings\n */\nexport const getSettings = () => {\n  return {\n    generalSettings: {\n      tag: \"flash5e-general-settings\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'rollInterceptionEnabled',\n        'useGMTargetTokens',\n        'templateAutoTarget',\n        'showOfflineNotifications',\n        'initiateCombatOnRequest',\n        'showOnlyPCsWithToken'\n      ],\n      default: {\n        rollInterceptionEnabled: true,\n        useGMTargetTokens: true,\n        templateAutoTarget: 1,\n        showOfflineNotifications: true,\n        initiateCombatOnRequest: true,\n        showOnlyPCsWithToken: true\n      },\n      scope: SETTING_SCOPE.world,\n      config: false, \n      requiresReload: false \n    },\n\n    groupRollsSettings: {\n      tag: \"flash5e-group-rolls-settings\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"),\n      title: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      propType: Object,\n      fields: [\n        'groupRollsMsgEnabled',\n        'groupRollResultMode',\n        'showGroupDCToPlayers'\n      ],\n      default: {\n        groupRollsMsgEnabled: true,\n        groupRollResultMode: 1,\n        showGroupDCToPlayers: false\n      },\n      scope: SETTING_SCOPE.world,\n      config: false, \n      requiresReload: false \n    },\n\n    showGroupDCToPlayers: {\n      tag: \"show-group-dc-to-players\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showGroupDCToPlayers.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showGroupDCToPlayers.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    \n    rollRequestsEnabled: {\n      tag: \"roll-requests-enabled\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.rollRequestsEnabled.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.rollRequestsEnabled.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: true\n    },\n    \n    groupRollsMsgEnabled: {\n      tag: \"group-roll-enabled\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollsMsgEnabled.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollsMsgEnabled.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    groupRollResultMode: {\n      tag: \"group-roll-result-mode\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.hint\"),\n      propType: Number, \n      inputType: SETTING_INPUT.select,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.1\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.2\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.3\"),\n        4: game.i18n.localize(\"FLASH_ROLLS.settings.groupRollResultMode.choices.4\")\n      },\n      default: 1,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    consumptionConfigMode: {\n      tag: \"consumption-config-mode\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.hint\"),\n      propType: Number, \n      inputType: SETTING_INPUT.select,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.1\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.2\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.3\"),\n        4: game.i18n.localize(\"FLASH_ROLLS.settings.consumptionConfigMode.choices.4\")\n      },\n      default: 4,\n      scope: SETTING_SCOPE.world,\n      config: true\n    },\n\n    skipRollDialog: {\n      tag: \"skip-roll-dialog\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialog.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.skipRollDialog.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.world,\n      config: true\n    },\n    useGMTargetTokens: {\n      tag: \"use-gm-target-tokens\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.useGMTargetTokens.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.useGMTargetTokens.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    rollInterceptionEnabled: {\n      tag: \"roll-interception-enabled\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.rollInterceptionEnabled.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.rollInterceptionEnabled.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n    publicPlayerRolls: {\n      tag: \"public-player-rolls\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.publicPlayerRolls.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.publicPlayerRolls.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: true\n    },\n\n    showOfflineNotifications: {\n      tag: \"show-offline-notifications\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showOfflineNotifications.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showOfflineNotifications.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showRequestNotifications: {\n      tag: \"show-request-notifications\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showRequestNotifications.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showRequestNotifications.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    initiateCombatOnRequest: {\n      tag: \"initiate-combat-on-request\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.initiateCombatOnRequest.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.initiateCombatOnRequest.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    showOnlyPCsWithToken: {\n      tag: \"show-only-pcs-with-token\",\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.showOnlyPCsWithToken.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.showOnlyPCsWithToken.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: true,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    templateAutoTarget: { \n      tag: \"template-auto-target\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.hint\"),\n      propType: Number,\n      choices: {\n        1: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.choices.all.label\"),\n        2: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.choices.notFriendly.label\"),\n        3: game.i18n.localize(\"FLASH_ROLLS.settings.templateAutoTarget.choices.none.label\"),\n      },\n      inputType: SETTING_INPUT.select,\n      default: 1,\n      scope: SETTING_SCOPE.world,\n      config: false\n    },\n\n    debugMode: {\n      tag: \"debug-mode-on\", \n      label: game.i18n.localize(\"FLASH_ROLLS.settings.debugMode.label\"),\n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.debugMode.hint\"),\n      propType: Boolean,\n      inputType: SETTING_INPUT.checkbox,\n      default: false,\n      scope: SETTING_SCOPE.client,\n      config: true\n    }\n  };\n};\n","/**\n * Module ID constant\n * @constant\n * @type {string}\n */\nexport const MODULE_ID = \"flash-rolls-5e\";\n\n/**\n * Debug tag for console logging\n * @constant\n * @type {Array}\n */\nexport const DEBUG_TAG = [\n  `%cFlash Rolls 5e`,\n  `color:rgb(47, 151, 161); font-weight: bold;`,\n  `|`,\n];\n\nexport const SOCKET_CALLS = {\n  receiveDiceConfig: \"receiveDiceConfig\",\n  getDiceConfig: \"getDiceConfig\",\n  handleRollRequest: \"handleRollRequest\"\n};\n\nexport const HOOK_NAMES = {\n  // \"\" (empty string) - General roll\n  ATTACK: { name: \"attack\", requestType: \"attack\" }, // Attack Activity\n  DAMAGE: { name: \"damage\", requestType: \"damage\" }, // Damage Activity\n  SAVE: { name: \"save\", requestType: \"damage\" }, // Save Activity (usually with damage)\n  SAVING_THROW: { name: \"savingthrow\", requestType: \"check\" }, // Saving throws\n  ABILITY_CHECK: { name: \"abilitycheck\", requestType: \"check\" }, // Ability checks\n  CONCENTRATION: { name: \"concentration\", requestType: \"check\" }, // Concentration checks\n  DEATH_SAVE: { name: \"deathsave\", requestType: \"save\" }, // Death saving throws\n  SKILL: { name: \"skill\", requestType: \"check\" }, // Skill checks\n  TOOL: { name: \"tool\", requestType: \"check\" }, // Tool checks\n  HIT_DIE: { name: \"hitdie\", requestType: \"formula\" }, // Hit die rolls\n  INITIATIVE: { name: \"initiative\", requestType: \"check\" }, // Initiative rolls\n  FORMULA: { name: \"formula\", requestType: \"formula\" }, // Formula rolls\n  RECHARGE: { name: \"recharge\", requestType: \"formula\" }, // Recharge rolls\n  D20_TEST: { name: \"d20Test\", requestType: \"formula\" }, // D20 test\n  SHORT_REST: { name: \"shortRest\", requestType: \"formula\" }, // Short rest\n  LONG_REST: { name: \"longRest\", requestType: \"formula\" }, // Long rest\n};\n\nexport const ACTIVITY_TYPES = {\n  ATTACK: \"attack\",\n  CAST: \"cast\",\n  CHECK: \"check\",\n  DAMAGE: \"damage\",\n  ENCHANT: \"enchant\",\n  FORWARD: \"forward\",\n  HEAL: \"heal\",\n  ORDER: \"order\",\n  SAVE: \"save\",\n  SUMMON: \"summon\",\n  TRANSFORM: \"transform\",\n  UTILITY: \"utility\"\n};\n\nexport const CALL_TYPE = {\n  ACTIVITY: \"activity\",\n  CHECK: \"check\",\n}\n\nexport const BUTTON_ACTION_TYPES = {\n  ROLL_REQUEST: \"rollRequest\",\n  ROLL_ATTACK: \"rollAttack\",\n  ROLL_DAMAGE: \"rollDamage\"\n}\n\n/**\n * Roll types used throughout the module\n * @constant\n * @type {Object}\n */\nexport const ROLL_TYPES = {\n  ABILITY: \"ability\",\n  ABILITY_CHECK: \"abilitycheck\",\n  ATTACK: \"attack\",\n  CONCENTRATION: \"concentration\",\n  CUSTOM: \"custom\",\n  DEATH_SAVE: \"deathsave\",\n  FORMULA: \"formula\",\n  DAMAGE: \"damage\",\n  HEALING: \"healing\",\n  HIT_DIE: \"hitdie\",\n  INITIATIVE: \"initiative\",\n  INITIATIVE_DIALOG: \"initiativedialog\",\n  ITEM_SAVE: \"itemsave\",\n  SAVE: \"save\",\n  SAVING_THROW: \"savingthrow\",\n  SKILL: \"skill\",\n  TOOL: \"tool\"\n}\n\nexport const ROLL_REQUEST_OPTIONS = {\n  ABILITY_CHECK: { name: ROLL_TYPES.ABILITY_CHECK, label: \"Ability Check\", subList: \"abilities\", actorPath: 'system.abilities' },\n  SAVING_THROW: { name: ROLL_TYPES.SAVING_THROW, label: \"Saving Throw\", subList: \"abilities\", actorPath: 'system.abilities' },\n  SKILL: { name: ROLL_TYPES.SKILL, label: \"Skill Check\", subList: \"skills\", actorPath: 'system.skills' },\n  TOOL: { name: ROLL_TYPES.TOOL, label: \"Tool Check\", subList: \"tools\", actorPath: 'system.tools' },\n  CONCENTRATION: { name: ROLL_TYPES.CONCENTRATION, label: \"Concentration Check\", subList: null, actorPath: '' },\n  INITIATIVE: { name: ROLL_TYPES.INITIATIVE, label: \"Initiative Roll\", subList: null, actorPath: '' },\n  DEATH_SAVE: { name: ROLL_TYPES.DEATH_SAVE, label: \"Death Save\", subList: null, actorPath: '' },\n  // ITEM_SAVE: { name: ROLL_TYPES.ITEM_SAVE, label: \"Item Save\", subList: null, actorPath: '' },\n  HIT_DIE: { name: ROLL_TYPES.HIT_DIE, label: \"Hit Die\", subList: null, actorPath: '' },\n  CUSTOM: { name: ROLL_TYPES.CUSTOM, label: \"Custom Roll\", subList: null, actorPath: '' },\n}\n\n/**\n * Module configuration object\n * @constant\n * @type {Object}\n */\nexport const MODULE = {\n  ID: MODULE_ID,\n  ROLL_REQUEST_OPTIONS: ROLL_REQUEST_OPTIONS\n}\n","/**\n * Core Foundry hooks\n * @constant\n * @type {Object}\n */\nexport const HOOKS_CORE = {\n  INIT: \"init\",\n  READY: \"ready\",\n  RENDER_CHAT_MESSAGE: \"renderChatMessageHTML\",\n  RENDER_CHAT_LOG: \"renderChatLog\",\n  RENDER_CHAT_INPUT: \"renderChatInput\",\n  // RENDER_SIDEBAR_TAB: \"renderSidebarTab\",\n  CHANGE_SIDEBAR_TAB: \"changeSidebarTab\", \n  RENDER_SIDEBAR: \"renderSidebar\",\n  RENDER_APPLICATION_V2: \"renderApplicationV2\",\n  UPDATE_SCENE: \"updateScene\",\n  RENDER_SCENE_NAVIGATION: \"renderSceneNavigation\",\n  RENDER_ROLL_RESOLVER: \"renderRollResolver\",\n  USER_CONNECTED: \"userConnected\",\n  PRE_CREATE_CHAT_MESSAGE: \"preCreateChatMessage\",\n  CREATE_CHAT_MESSAGE: \"createChatMessage\",\n  RENDER_ROLL_CONFIGURATION_DIALOG: \"renderRollConfigurationDialog\",\n  COLLAPSE_SIDE_BAR: \"collapseSidebar\",\n  REFRESH_MEASURED_TEMPLATE: \"refreshMeasuredTemplate\",\n  CONTROL_TOKEN: \"controlToken\",\n  UPDATE_ACTOR: \"updateActor\",\n  UPDATE_ITEM: \"updateItem\",\n  CREATE_ITEM: \"createItem\",\n  DELETE_ITEM: \"deleteItem\",\n  UPDATE_SETTING: \"updateSetting\"\n};\n\n/**\n * Socketlib hooks\n */\nexport const HOOKS_SOCKET = {\n  READY: \"socketlib.ready\"\n}\n\n/**\n * Midi-QOL hooks\n */\nexport const HOOKS_MIDI_QOL = {\n  READY: \"midi-qol.ready\"\n}\n\n/**\n * DnD5e hooks\n */\nexport const HOOKS_DND5E = {\n  // General Rolling Process\n  PRE_ROLL_V2: \"dnd5e.preRollV2\",\n\n  // Activity\n  PRE_USE_ACTIVITY: \"dnd5e.preUseActivity\",\n  POST_USE_ACTIVITY: \"dnd5e.postUseActivity\",\n  \n  // Ability Checks & Saving Throws\n  PRE_ROLL_ABILITY_CHECK: \"dnd5e.preRollAbilityCheckV2\",\n  PRE_ROLL_SAVING_THROW: \"dnd5e.preRollSavingThrowV2\",\n  ROLL_ABILITY_CHECK: \"dnd5e.rollAbilityCheckV2\",\n  ROLL_SAVING_THROW: \"dnd5e.rollSavingThrowV2\",\n  \n  // Concentration\n  PRE_BEGIN_CONCENTRATING: \"dnd5e.preBeginConcentrating\",\n  BEGIN_CONCENTRATING: \"dnd5e.beginConcentrating\",\n  PRE_END_CONCENTRATION: \"dnd5e.preEndConcentration\",\n  END_CONCENTRATION: \"dnd5e.endConcentration\",\n  PRE_ROLL_CONCENTRATION_V2: \"dnd5e.preRollConcentrationV2\",\n  ROLL_CONCENTRATION_V2: \"dnd5e.rollConcentrationV2\",\n  \n  // Damage\n  PRE_CALCULATE_DAMAGE: \"dnd5e.preCalculateDamage\",\n  CALCULATE_DAMAGE: \"dnd5e.calculateDamage\",\n  PRE_APPLY_DAMAGE: \"dnd5e.preApplyDamage\",\n  APPLY_DAMAGE: \"dnd5e.applyDamage\",\n  \n  // Death Saves\n  PRE_ROLL_DEATH_SAVE_V2: \"dnd5e.preRollDeathSaveV2\",\n  ROLL_DEATH_SAVE_V2: \"dnd5e.rollDeathSaveV2\",\n  POST_ROLL_DEATH_SAVE: \"dnd5e.postRollDeathSave\",\n  \n  // Skills & Tools\n  PRE_ROLL_SKILL_V2: \"dnd5e.preRollSkillV2\",\n  PRE_ROLL_TOOL_V2: \"dnd5e.preRollToolV2\",\n  ROLL_SKILL_V2: \"dnd5e.rollSkillV2\",\n  ROLL_TOOL_V2: \"dnd5e.rollToolV2\",\n  \n  // Hit Dice\n  PRE_ROLL_HIT_DIE_V2: \"dnd5e.preRollHitDieV2\",\n  ROLL_HIT_DIE_V2: \"dnd5e.rollHitDieV2\",\n  \n  // Hit Points\n  PRE_ROLL_CLASS_HIT_POINTS: \"dnd5e.preRollClassHitPoints\",\n  ROLL_CLASS_HIT_POINTS: \"dnd5e.rollClassHitPoints\",\n  PRE_ROLL_NPC_HIT_POINTS: \"dnd5e.preRollNPCHitPoints\",\n  ROLL_NPC_HIT_POINTS: \"dnd5e.rollNPChitPoints\",\n  \n  // Initiative\n  PRE_CONFIGURE_INITIATIVE: \"dnd5e.preConfigureInitiative\",\n  PRE_ROLL_INITIATIVE_DIALOG: \"dnd5e.preRollInitiativeDialog\",\n  // PRE_ROLL_INITIATIVE_DIALOG_V2: \"dnd5e.preRollInitiativeDialogV2\",\n  PRE_ROLL_INITIATIVE: \"dnd5e.preRollInitiative\",\n  ROLL_INITIATIVE: \"dnd5e.rollInitiative\",\n  \n  // Attacks\n  PRE_ROLL_ATTACK_V2: \"dnd5e.preRollAttackV2\",\n  ROLL_ATTACK_V2: \"dnd5e.rollAttackV2\",\n  POST_ROLL_ATTACK: \"dnd5e.postRollAttack\",\n  \n  // Damage Rolls\n  PRE_ROLL_DAMAGE_V2: \"dnd5e.preRollDamageV2\",\n  ROLL_DAMAGE_V2: \"dnd5e.rollDamageV2\",\n  \n  // Formula Rolls\n  PRE_ROLL_FORMULA_V2: \"dnd5e.preRollFormulaV2\",\n  ROLL_FORMULA_V2: \"dnd5e.rollFormulaV2\",\n  \n  // Recharge Rolls\n  PRE_ROLL_RECHARGE_V2: \"dnd5e.preRollRechargeV2\",\n  ROLL_RECHARGE_V2: \"dnd5e.rollRechargeV2\",\n  \n  // Car Display\n  PRE_DISPLAY_CARD_V2: \"dnd5e.preDisplayCardV2\",\n  DISPLAY_CARD: \"dnd5e.displayCard\",\n\n  // Config\n  BUILD_ROLL_CONFIG: \"dnd5e.buildRollConfig\",\n  POST_BUILD_ROLL_CONFIG: \"dnd5e.postBuildRollConfig\",\n  POST_ROLL_CONFIG: \"dnd5e.postRollConfiguration\",\n  RENDER_ROLL_CONFIGURATION_DIALOG: \"renderRollConfigurationDialog\",\n  RENDER_SKILL_TOOL_ROLL_DIALOG: \"renderSkillToolRollConfigurationDialog\",\n  RENDER_FORMULA_ROLL_DIALOG: \"renderFormulaRollConfigurationDialog\"\n}","import { DEBUG_TAG, MODULE_ID } from \"../constants/General.mjs\";\n\n/**\n * Utility class for handling logging operations in the module\n * Provides methods for debug, warning, and error logging with module context\n */\nexport class LogUtil {\n  /** @type {boolean} Whether debug logging is enabled */\n  static debugOn = false;\n\n  /**\n   * Logs information to the console, adding module name and reference\n   * @param {string} ref - Reference information to log after module name\n   * @param {Array|*} data - array of items to log on console, or a single item that will be wrapped in an array\n   * @param {boolean} [bypassSettings=false] - Whether to bypass debug settings check\n   */\n  static log(ref=\"\", data=[], bypassSettings=false) {\n    try {\n      const debugSetting = game.settings.get(MODULE_ID, \"debug-mode-on\") || LogUtil.debugOn;\n      const isDebugModeOn = bypassSettings || debugSetting;\n      if(!isDebugModeOn) { return; }\n      \n      // Ensure data is an array\n      const dataArray = Array.isArray(data) ? data : [data];\n      console.log(...DEBUG_TAG, ref, ...dataArray);\n    } catch(e) {\n      // If settings aren't available yet, check bypassSettings\n      if (bypassSettings || LogUtil.debugOn) {\n        // Ensure data is an array\n        const dataArray = Array.isArray(data) ? data : [data];\n        console.log(...DEBUG_TAG, ref, ...dataArray);\n      }\n    }\n  }\n\n  /**\n   * Outputs warning on console, adding module name and reference\n   * @param {string} ref - Reference information to log after module name\n   * @param {Array|*} data - array of items to log on console, or a single item that will be wrapped in an array\n   */\n  static warn(ref=\"\", data=[]) {\n    // Ensure data is an array\n    const dataArray = Array.isArray(data) ? data : [data];\n    console.warn(...DEBUG_TAG, ref, ...dataArray);\n  }\n\n  /**\n   * Logs an error to the console and/or UI notification\n   * @param {string} strRef - Reference string for the error\n   * @param {Array|*} data - array of items to log on console, or a single item that will be wrapped in an array\n   * @param {object} options - Error logging configuration\n   * @param {boolean} [options.ui=false] - Whether to show UI notification\n   * @param {boolean} [options.console=true] - Whether to log to console\n   * @param {boolean} [options.permanent=false] - Whether UI notification should be permanent\n   * @static\n   */\n  static error(strRef, data=[], options = { ui: false, console: true, permanent: false }) {\n    // Ensure data is an array\n    const dataArray = Array.isArray(data) ? data : [data];\n    \n    if(options.ui) {\n      ui.notifications?.error(strRef, { localize: true, permanent: options.permanent });\n    }\n    if(options.console) console.error(...DEBUG_TAG, strRef, ...dataArray);\n  }\n}","import { MODULE_ID } from \"../constants/General.mjs\";\nimport { HOOKS_SOCKET } from \"../constants/Hooks.mjs\";\nimport { LogUtil } from \"./LogUtil.mjs\";\n\n/**\n * Utility class for managing socket communication using socketlib.\n */\nexport class SocketUtil {\n  static socket;\n  static _activeExecutions = new Map();\n\n  /**\n   * Initializes the socket module and registers it with socketlib.\n   * This should be called once during FoundryVTT initialization.\n   * \n   * @param {Function} callbackFunc - Optional callback to execute after registration.\n   */\n  static initialize = (callbackFunc) => {\n    LogUtil.log('initialize', [callbackFunc]);\n\n    Hooks.once(HOOKS_SOCKET.READY, () => { \n      // Check if socketlib is available before registering the module\n      if (typeof socketlib === \"undefined\") {\n        LogUtil.error(\"SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled.\");\n        ui.notifications.error(game.i18n.localize(\"FLASH_ROLLS.notifications.socketlibMissing\"), {permanent: true});\n        return;\n      }\n\n      try { \n        // Register the module with socketlib\n        SocketUtil.socket = socketlib.registerModule(MODULE_ID);\n\n        // Execute callback function if provided\n        if (callbackFunc) {\n          callbackFunc();\n        }\n\n      } catch (e) {\n      }\n    });\n  }\n\n  /**\n   * Registers a callback function that can be called remotely via the socket.\n   * \n   * @param {string} name - The name of the remote function.\n   * @param {Function} func - The function to be executed remotely.\n   */\n  static registerCall = (name, func) => {\n    LogUtil.log('registerCall', [name]);\n    if (SocketUtil.socket) {\n      SocketUtil.socket.register(name, func);\n    } else {\n    }\n  }\n\n  /**\n   * Sends a message via the socket (currently only logs it and calls a callback).\n   * \n   * @param {*} value - The message or data to send.\n   * @param {Function} callback - The callback function to execute after sending.\n   */\n  static sendMessage = (value, callback) => {\n    LogUtil.log('sendMessage', [value]);\n    if (callback) {\n        callback();\n    }\n  }\n\n  /**\n   * Executes a function as the GM.\n   * \n   * @param {Function} handler - The function to execute.\n   * @param {...*} parameters - The parameters to pass to the function.\n   * @returns {Promise} A promise resolving when the function executes.\n   */\n  static execForGMs = async (handler, ...parameters) => {\n    LogUtil.log('execForGMs', [handler, ...parameters]);\n    if (!SocketUtil.socket) {\n      return;\n    }\n    return await SocketUtil.socket.executeForAllGMs(handler, ...parameters);\n  }\n\n  /**\n   * Executes a function for all connected clients.\n   * \n   * @param {Function} handler - The function to execute.\n   * @param {...*} parameters - The parameters to pass to the function.\n   * @returns {Promise} A promise resolving when the function executes for all clients.\n   */\n  static execForAll = async (handler, ...parameters) => {\n    if (!SocketUtil.socket) {\n      return;\n    }\n    return await SocketUtil.socket.executeForEveryone(handler, ...parameters);\n  }\n\n\n  /**\n   * Executes a function as the specified user.\n   * @param {Function|string} handler - The function to execute or the name of a registered function.\n   * @param {String} userId - the id of the user that should execute this function\n   * @param {...*} parameters - The parameters to pass to the function.\n   * @returns {Promise} A promise resolving when the function executes.\n   */\n  static execForUser = async (handler, userId, ...parameters) => {\n    LogUtil.log('execForUser #0', [handler, userId, ...parameters]);\n    if (!SocketUtil.socket) {\n        return;\n    }\n\n    LogUtil.log('execForUser #1', [userId === game.user.id]);\n    if(userId === game.user.id){\n      return null; // Break the recursion\n    }\n    const executionKey = `${handler}-${userId}`;\n    \n    LogUtil.log('execForUser #2', [SocketUtil._activeExecutions.has(executionKey)]);\n    // Check if this exact execution is already in progress\n    if (SocketUtil._activeExecutions.has(executionKey)) {\n        return null; // Break the recursion\n    }\n    // Mark this execution as active\n    SocketUtil._activeExecutions.set(executionKey, true);\n    \n    try {\n      const resp = await SocketUtil.socket.executeAsUser(handler, userId, ...parameters);\n      LogUtil.log('execForUser #3 - response', [resp]);\n      return resp;\n    } catch (error) {\n      LogUtil.error('execForUser #4 - error', [error]);\n      return null;\n    } finally {\n      LogUtil.log('execForUser #5 - success', []);\n      // Always clean up, even if there was an error\n      SocketUtil._activeExecutions.delete(executionKey);\n    }\n  }\n\n  /**\n   * Serializes an object for transport, handling Roll objects properly\n   * @param {*} data - The data to serialize\n   * @returns {*} - Serialized data\n   */\n  static serializeForTransport(data, hasRolls=false) { \n    LogUtil.log('serializeForTransport', [data, hasRolls]);\n    // Handle null or undefined\n    if (data == null) return data;\n    \n    if (hasRolls && data.rolls && Array.isArray(data.rolls)) {\n      // data.rolls = data.rolls.map(r => SocketUtil.serializeForTransport(r));\n      \n      data.rolls = data.rolls.map(r => {\n        if(r instanceof Roll){\n          let serialized = r.toJSON();\n          return serialized;\n        }else{\n          return r;\n        }\n      });\n    }\n    \n    return data;\n  }\n\n  /**\n   * Deserializes data received from transport, reconstructing Roll objects\n   * @param {*} data - The serialized data\n   * @returns {*} - Deserialized data with reconstructed objects\n   */\n  static deserializeFromTransport(data, hasRolls=false) {\n    LogUtil.log('deserializeFromTransport', [data, hasRolls]);\n    let result = { ...data };\n    if (!data) return result;\n\n    if(hasRolls && data.rolls && data.rolls.length > 0){\n      const rolls = result.rolls.map(r => {\n        let roll = r;\n        if(typeof r === 'string'){\n          roll = Roll.fromJSON(r);\n        }else {\n          roll = Roll.fromJSON(JSON.stringify(r));\n        }\n        return roll;\n      })\n      result.rolls = [...rolls];\n      return result;\n    }\n    \n    return result;\n  }\n\n}\n","import { SocketUtil } from './SocketUtil.mjs';\n\n/**\n * Utility class for managing dice configurations across users\n */\nexport class DiceConfigUtil {\n  /**\n   * @type {Object} Current user's dice configuration\n   */\n  static diceConfig = {};\n  \n  /**\n   * @type {Object} All player dice configurations (GM only)\n   */\n  static playerDiceConfigs = {};\n  \n  /**\n   * Initialize the dice configuration for current user\n   */\n  static initialize() {\n    this.setDiceConfig();\n  }\n  \n  /**\n   * Set dice configuration from client settings\n   * @returns {Object} The dice configuration\n   */\n  static setDiceConfig() {\n    if (!game.user) return {};\n    \n    const clientSettings = game.settings.storage.get(\"client\");\n    this.diceConfig = clientSettings[`core.diceConfiguration`] || '';\n    \n    return this.diceConfig;\n  }\n  \n  /**\n   * Get the current user's dice configuration\n   * @returns {Object} The dice configuration\n   */\n  static getDiceConfig() {\n    if (!game.user) return {};\n    \n    // Ensure we have the latest configuration\n    this.setDiceConfig();\n    \n    // If GM, send config to GMs via socket\n    if (game.user.isGM) {\n      this._sendDiceConfigToGMs();\n    }\n    \n    return this.diceConfig;\n  }\n  \n  /**\n   * Send dice configuration to all GMs\n   * @private\n   */\n  static _sendDiceConfigToGMs() {\n    SocketUtil.execForGMs('receiveDiceConfig', game.user.id, this.diceConfig);\n  }\n  \n  /**\n   * Receive and store dice configuration from a player\n   * @param {string} userId - The user ID\n   * @param {string} diceConfig - The serialized dice configuration\n   */\n  static receiveDiceConfig(userId, diceConfig) {\n    if (game.user?.isGM || userId === game.user?.id) {\n      this.playerDiceConfigs[userId] = diceConfig ? JSON.parse(diceConfig) : {};\n    }\n  }\n  \n  /**\n   * Get dice configuration for a specific user\n   * @param {string} userId - The user ID\n   * @returns {Object} The user's dice configuration\n   */\n  static getUserDiceConfig(userId) {\n    if (userId === game.user?.id) {\n      return this.diceConfig;\n    }\n    \n    return this.playerDiceConfigs[userId] || {};\n  }\n  \n  /**\n   * Request dice configuration from a specific user\n   * @param {string} userId - The user ID to request from\n   */\n  static requestDiceConfigFromUser(userId) {\n    SocketUtil.execForUser('getDiceConfig', userId);\n  }\n  \n  /**\n   * Request dice configuration from all active non-GM users\n   */\n  static requestDiceConfigFromAllPlayers() {\n    if (!game.user?.isGM) return;\n    \n    game.users.forEach(user => {\n      if (user.active && !user.isGM && user.id !== game.user.id) {\n        this.requestDiceConfigFromUser(user.id);\n      }\n    });\n  }\n  \n  /**\n   * Clear all stored player dice configurations\n   */\n  static clearPlayerConfigs() {\n    this.playerDiceConfigs = {};\n  }\n  \n  /**\n   * Check if a user has dice configuration stored\n   * @param {string} userId - The user ID\n   * @returns {boolean} True if configuration exists\n   */\n  static hasUserConfig(userId) {\n    if (userId === game.user?.id) {\n      return !!this.diceConfig;\n    }\n    \n    return !!this.playerDiceConfigs[userId];\n  }\n}","import { LogUtil } from \"../LogUtil.mjs\";\nimport { SettingsUtil } from \"../SettingsUtil.mjs\";\n\n/**\n * Utility class providing general-purpose functionality for the module */\nexport class GeneralUtil {\n  /**\n   * Checks if module is currently installed and active\n   * @param {string} moduleName \n   * @returns {boolean}\n   */\n  static isModuleOn(moduleName){\n    const module = game.modules?.get(moduleName);\n    return Boolean(module?.active);\n  }\n\n  /**\n   * Finds and returns the first element matching the selector within the parent element\n   * @param {HTMLElement} parent - The parent element to search within\n   * @param {string} selector - CSS selector string\n   * @returns {HTMLElement|null} The first matching element or null if not found\n   */\n  static html(parent, selector) {\n    return parent.querySelector(selector);\n  }\n\n  /**\n   * Gets the full width of an element including margins and borders\n   * @param {HTMLElement} element - The element to measure\n   * @returns {number} The full width in pixels\n   */\n  static getFullWidth(element) {\n    const style = window.getComputedStyle(element);\n    if (style.width === '0px') {\n      return 0;\n    }\n    return element.offsetWidth;\n  }\n\n  /**\n   * Prevents dialog flicker by applying opacity transition\n   * @param {HTMLElement} element - The dialog element to apply the transition to\n   * @param {number} delay - Delay in milliseconds before fading in (default: 100)\n   */\n  static preventDialogFlicker(element, delay = 100) {\n    if (!element) return;\n    \n    element.style.opacity = '0';\n    element.style.transition = 'opacity 0.15s ease-in';\n    \n    setTimeout(() => {\n      if (element) {\n        element.style.opacity = '1';\n      }\n    }, delay);\n  }\n\n  /**\n   * Adds CSS variables to a style element\n   * @param {string} varName \n   * @param {string} varValue \n   */\n  static addCSSVars(varName, varValue) {\n    let bodyStyle = document.querySelector('#flash5e-vars');\n    \n    if (!bodyStyle) {\n      const body = document.querySelector('body.flash5e');\n      if(!body){return}\n      bodyStyle = document.createElement('style');\n      bodyStyle.id = 'flash5e-vars';\n      bodyStyle.textContent = 'body.flash5e {\\n}\\n';\n      body.prepend(bodyStyle);\n    }\n    \n    let cssText = bodyStyle.textContent;\n    \n    let ruleStart = cssText.indexOf('body.flash5e {');\n    let ruleEnd = cssText.indexOf('}', ruleStart);\n    \n    if (ruleStart === -1) {\n      cssText = 'body.flash5e {\\n}\\n';\n      ruleStart = 0;\n      ruleEnd = cssText.indexOf('}');\n    }\n    \n    const rulePart = cssText.substring(ruleStart + 'body.flash5e {'.length, ruleEnd);\n    \n    const declarations = rulePart.split(';')\n      .map(decl => decl.trim())\n      .filter(decl => decl !== '');\n    \n    const varsMap = {};\n    declarations.forEach(decl => {\n      const parts = decl.split(':');\n      if (parts.length >= 2) {\n        const name = parts[0].trim();\n        const value = parts.slice(1).join(':').trim(); // Handle values that might contain colons\n        if (name) varsMap[name] = value;\n      }\n    });\n    \n    if (varName.includes('i18n') && \n        typeof varValue === 'string' && \n        !varValue.startsWith('\"') && \n        !varValue.startsWith(\"'\") && \n        !varValue.match(/^url\\(|^rgba?\\(|^hsla?\\(/)) {\n      varValue = `\"${varValue}\"`;\n    }\n    \n    varsMap[varName] = varValue;\n    \n    const newRuleContent = Object.entries(varsMap)\n      .map(([name, value]) => `  ${name}: ${value};`)\n      .join('\\n');\n    \n    const newCss = \n      cssText.substring(0, ruleStart) + \n      'body.flash5e {\\n' + \n      newRuleContent + \n      '\\n}' + \n      cssText.substring(ruleEnd + 1);\n    \n    bodyStyle.textContent = newCss;\n  }\n  \n  /**\n   * Gets the offset bottom of an element\n   * @param {HTMLElement} element \n   * @returns {number}\n   */\n  static getOffsetBottom(element) {\n    const offsetTop = element.offsetTop;\n    const elementHeight = element.offsetHeight;\n    return window.innerHeight - (offsetTop + elementHeight);\n  }\n\n  /**\n   * Retrieves a list of all available fonts\n   * @returns {Promise<string[]>}\n   */\n  static async getAllFonts() {\n    const foundryFonts = new Set(Object.keys(CONFIG.fontDefinitions));\n    const customFontsObj = game.settings.get(\"core\", \"fonts\") || {};\n    const customFonts = Object.entries(customFontsObj).map(([fontFamily]) => fontFamily);\n  \n    const cssImportedFonts = await this.processStyleSheets();\n  \n    const allFonts = Array.from(new Set([\n      ...foundryFonts,\n      ...customFonts,\n      ...cssImportedFonts\n    ]))\n    .filter(f => !/FontAwesome|Font Awesome|FoundryVTT/.test(f))\n    .map(f => f.replace(/['\"]/g, '').trim())\n    .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));\n\n    return allFonts || [];\n  }\n\n  // Helper function to format font names\n  /**\n   * Formats a font name by cleaning it and wrapping it in quotes if it contains spaces\n   * @param {string} fontName - The font name to format\n   * @returns {string} The formatted font name\n   */\n  static wrapFontName = (fontName) => {\n    const cleanName = fontName.replace(/['\"`]/g, '');\n    return cleanName.includes(' ') ? `\"${cleanName}\"` : cleanName;\n  }\n\n  /**\n   * Adds custom CSS to a style element\n   * @param {string} content - CSS content to add\n   * @param {string} [id='flash5e-custom-css'] - ID for the style element\n   * @param {boolean} [checkForDuplicates=true] - Whether to check for duplicate rules\n   */\n  static addCustomCSS(content, id = 'flash5e-custom-css', checkForDuplicates = true) {\n    if (!content) {\n      return;\n    }\n    \n    let customStyle = document.querySelector('#' + id);\n    \n    if (!customStyle) {\n      customStyle = document.createElement('style');\n      customStyle.id = id;\n      customStyle.textContent = '';\n      document.head.appendChild(customStyle);\n    }\n\n    const importRegex = /@import\\s+(?:url\\()?\\s*['\"]?[^'\")]+['\"]?\\s*\\)?\\s*;/g;\n    const imports = [];\n    let contentWithoutImports = content;\n    let match;\n    while ((match = importRegex.exec(content)) !== null) {\n      imports.push(match[0]);\n    }\n    \n    contentWithoutImports = content.replace(importRegex, '').trim();\n    \n    if (!checkForDuplicates) {\n      customStyle.textContent = imports.join('\\n') + (imports.length ? '\\n\\n' : '') + contentWithoutImports;\n      return;\n    }\n    \n    if (!customStyle.textContent.includes(contentWithoutImports)) {\n      const currentContent = customStyle.textContent;\n      const existingImports = [];\n      let currentMatch;\n      while ((currentMatch = importRegex.exec(currentContent)) !== null) {\n        existingImports.push(currentMatch[0]);\n      }\n      \n      const currentContentWithoutImports = currentContent.replace(importRegex, '').trim();\n      const newImports = imports.filter(imp => !existingImports.includes(imp));\n      const allImports = [...existingImports, ...newImports];\n      customStyle.textContent = allImports.join('\\n') + \n                               (allImports.length ? '\\n\\n' : '') + \n                               currentContentWithoutImports +\n                               (currentContentWithoutImports && contentWithoutImports ? '\\n\\n' : '') +\n                               contentWithoutImports;\n    }\n  }\n  \n  /**\n   * Performs a smooth scroll with custom duration\n   * @param {HTMLElement} element - The element to scroll\n   * @param {number} to - The target scroll position\n   * @param {string} [direction=\"horizontal\"] - The scroll direction (\"horizontal\" or \"vertical\")\n   * @param {number} [duration=300] - Duration of the animation in milliseconds\n   * @param {Function} [onComplete] - Optional callback to run when animation completes\n   * @returns {number} Animation ID that can be used to cancel the animation\n   */\n  static smoothScrollTo(element, to, direction = \"horizontal\", duration = 300, onComplete = null) {\n    // Cancel any existing animation if it has the same ID as the element\n    const animationId = element.dataset.scrollAnimationId;\n    if (animationId) {\n      cancelAnimationFrame(Number(animationId));\n    }\n    \n    // Determine if we're scrolling horizontally or vertically\n    const isHorizontal = direction === \"horizontal\";\n    const start = isHorizontal ? element.scrollLeft : element.scrollTop;\n    const change = to - start;\n    \n    // If there's no change or the element isn't scrollable, exit early\n    if (change === 0) {\n      if (onComplete) onComplete();\n      return null;\n    }\n    \n    const startTime = performance.now();\n    \n    const animateScroll = (currentTime) => {\n      const elapsedTime = currentTime - startTime;\n      \n      if (elapsedTime >= duration) {\n        if (isHorizontal) {\n          element.scrollLeft = to;\n        } else {\n          element.scrollTop = to;\n        }\n        \n        delete element.dataset.scrollAnimationId;\n        if (onComplete) onComplete();\n        return;\n      }\n      \n      const progress = elapsedTime / duration;\n      const easeProgress = progress < 0.5 \n        ? 2 * progress * progress \n        : 1 - Math.pow(-2 * progress + 2, 2) / 2;\n      \n      if (isHorizontal) {\n        element.scrollLeft = start + change * easeProgress;\n      } else {\n        element.scrollTop = start + change * easeProgress;\n      }\n      \n      const newAnimationId = requestAnimationFrame(animateScroll);\n      element.dataset.scrollAnimationId = newAnimationId;\n      return newAnimationId;\n    };\n    \n    const newAnimationId = requestAnimationFrame(animateScroll);\n    element.dataset.scrollAnimationId = newAnimationId;\n    return newAnimationId;\n  }\n\n  /**\n   * Opens a confirmation dialog to reload the page using DialogV2\n   * @param {string} [title=\"\"] - The title of the confirmation dialog\n   * @param {string} [content=\"\"] - The content message\n   * @param {Object} [options={}] - Additional dialog options\n   * @returns {Promise<boolean>} Resolves to true if confirmed, false otherwise\n   */\n  static confirmReload(\n    title = game.i18n.localize(\"FLASH_ROLLS.ui.reloadRequiredTitle\"), \n    content = game.i18n.localize(\"FLASH_ROLLS.ui.reloadRequiredLabel\"),\n    options = {}) {\n    \n    const dialogConfig = {\n      window: {\n        title\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      },\n      content,\n      yes: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.reloadButton\"),\n        callback: () => {\n          LogUtil.log(\"Reloading page after confirmation\");\n          window.location.reload();\n          return true;\n        }\n      },\n      no: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.cancelButton\"),\n        callback: () => false\n      },\n      defaultYes: false,\n      rejectClose: false\n    };\n    \n    mergeObject(dialogConfig, options);\n    return foundry.applications.api.DialogV2.confirm(dialogConfig);\n  }\n\n  /**\n   * Alias for Foundry's method to render Handlebars template\n   * @param {string} templatePath \n   * @param {Object} data \n   * @returns {Promise<string>} Rendered template HTML\n   */\n  static renderTemplate(templatePath, data){\n    return foundry.applications.handlebars.renderTemplate(templatePath, data);\n  }\n\n  /**\n   * Alias for Foundry's method to load Handlebars template\n   * @param {string} templatePath \n   * @returns {Promise<HandlebarsTemplate>} Loaded template object\n   */\n  static loadTemplate(templatePath){\n    return foundry.applications.handlebars.loadTemplate(templatePath);\n  }\n\n  /**\n   * Alias for Foundry's method to load Handlebars template\n   * @param {string[]} templatePaths \n   * @returns {Promise<HandlebarsTemplate>} Loaded template object\n   */\n  static loadTemplates(templatePaths){\n    if(!Array.isArray(templatePaths)) templatePaths = [templatePaths];\n    return foundry.applications.handlebars.loadTemplates(templatePaths);\n  }\n\n  /**\n   * Validates if a string is a valid CSS rule or selector\n   * @param {string} cssString - CSS rule or selector to validate\n   * @return {boolean} Whether the CSS is valid\n   */\n  static isValidCSSRule(cssString) {\n    if (!cssString || typeof cssString !== \"string\") return false;\n    const trimmedCSS = cssString.trim();\n    if (!trimmedCSS) return false;\n    try {\n      const style = document.createElement(\"style\");\n      const testCSS = `${trimmedCSS} { color: inherit; }`;\n      style.textContent = testCSS;\n      document.head.appendChild(style);\n      const isValid = Boolean(style.sheet && style.sheet.cssRules && style.sheet.cssRules.length > 0);\n      document.head.removeChild(style);\n      return isValid;\n    } catch (error) {\n      LogUtil.log(\"CSS validation error:\", [error, cssString]);\n      return false;\n    }\n  }\n\n  /**\n   * Processes CSS rules with nested selectors to create valid CSS for multiple target selectors\n   * @param {string} cssRules - CSS rules that may contain nested selectors\n   * @param {string} targetSelectors - Comma-separated list of selectors to apply the rules to\n   * @return {string} Valid CSS with properly combined selectors\n   */\n  static processCSSRules(cssRules, targetSelectors) {\n    if (!cssRules || !targetSelectors) return \"\";\n    const parsedCSS = this.#parseCSS(cssRules);\n    const mainStyle = targetSelectors + \" {\\n\" + parsedCSS.baseProperties.join(\"\\n\") + \"\\n}\";\n    const processedRules = [];\n    const rulesByContent = new Map();\n    \n    parsedCSS.nestedRules.forEach(rule => {\n      const { selector, content } = rule;\n      \n      if (selector.startsWith(\"&\")) {\n        const pseudoSelector = selector.substring(1);\n        const combinedSelectors = targetSelectors.split(\",\")\n          .map(s => s.trim())\n          .filter(Boolean)\n          .map(s => s + pseudoSelector)\n          .join(\", \");\n        \n        processedRules.push(`${combinedSelectors} {\\n${content}\\n}`);\n        return;\n      }\n      \n      if (!rulesByContent.has(content)) {\n        rulesByContent.set(content, []);\n      }\n      \n      const selectors = selector.split(\",\").map(s => s.trim());\n      const targetList = targetSelectors.split(\",\").map(s => s.trim()).filter(Boolean);\n      \n      selectors.forEach(nestedSelector => {\n        targetList.forEach(targetSelector => {\n          rulesByContent.get(content).push(`${targetSelector} ${nestedSelector}`);\n        });\n      });\n    });\n    \n    rulesByContent.forEach((selectors, content) => {\n      processedRules.push(`${selectors.join(\", \")} {\\n${content}\\n}`);\n    });\n    \n    return mainStyle + \"\\n\\n\" + processedRules.join(\"\\n\\n\");\n  }\n  \n  /**\n   * Parses CSS string into a structured format with base properties and nested rules\n   * @param {string} css - CSS string to parse\n   * @return {Object} Object with baseProperties array and nestedRules array\n   * @private\n   */\n  static #parseCSS(css) {\n    const baseProperties = [];\n    const nestedRules = [];\n    const lines = css.split(\"\\n\");\n    \n    let currentNested = null;\n    let braceCount = 0;\n    \n    for (let i = 0; i < lines.length; i++) {\n      const line = lines[i].trim();\n      if (!line) continue;\n      \n      const openBraces = (line.match(/{/g) || []).length;\n      const closeBraces = (line.match(/}/g) || []).length;\n      \n      if (line.includes(\"{\") && !currentNested) {\n        const selector = line.substring(0, line.indexOf(\"{\")).trim();\n        currentNested = { selector, content: \"\", startLine: i };\n        braceCount = 1;\n        \n        const contentAfterBrace = line.substring(line.indexOf(\"{\") + 1).trim();\n        if (contentAfterBrace && !contentAfterBrace.includes(\"}\")) {\n          currentNested.content += contentAfterBrace + \"\\n\";\n        }\n      } else if (currentNested) {\n        braceCount += openBraces - closeBraces;\n        \n        if (braceCount > 0) {\n          currentNested.content += line + \"\\n\";\n        } \n        else {\n          currentNested.content = currentNested.content.replace(/}\\s*$/, \"\").trim();\n          nestedRules.push(currentNested);\n          currentNested = null;\n        }\n      } else if (!line.includes(\"{\") && !line.includes(\"}\")) {\n        baseProperties.push(line);\n      }\n    }\n    \n    return { baseProperties, nestedRules };\n  }\n\n  /**\n   * Get the player owner of an actor\n   * @param {Actor} actor \n   * @returns {User|null}\n   */\n  static getActorOwner(actor) {\n    const ownership = actor.ownership || {};\n\n    for (const [userId, level] of Object.entries(ownership)) {\n      if (level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER) {\n        const user = game.users.get(userId);\n        if (user && !user.isGM) {\n          return user;\n        }\n      }\n    }\n\n    if(ownership?.default >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){\n      const user = game.users.filter(user => !user.isGM)[0];\n      if (user) {\n        return user;\n      }\n    }\n    \n    return null;\n  }\n\n  /**\n   * Opens a confirmation dialog to reload the page using DialogV2\n   * @param {string} [title=\"\"] - The title of the confirmation dialog\n   * @param {string} [content=\"\"] - The content message\n   * @param {Object} [options={}] - Additional dialog options\n   * @returns {Promise<boolean>} Resolves to true if confirmed, false otherwise\n   */\n  static confirmReload(\n    title = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.reloadRequiredTitle\"), \n    content = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.reloadRequiredLabel\"),\n    options = {}) {\n    \n    const dialogConfig = {\n      window: {\n        title\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      },\n      content,\n      yes: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.buttons.reloadButton\"),\n        callback: () => {\n          LogUtil.log(\"Reloading page after confirmation\");\n          window.location.reload();\n          return true;\n        }\n      },\n      no: {\n        label: game.i18n.localize(\"FLASH_ROLLS.ui.buttons.cancelButton\"),\n        callback: () => false\n      },\n      defaultYes: false,\n      rejectClose: false\n    };\n    \n    mergeObject(dialogConfig, options);\n    return foundry.applications.api.DialogV2.confirm(dialogConfig);\n  }\n}\n","import { getSettings } from \"../../constants/Settings.mjs\";\nimport { getSettingMenus } from \"../../constants/SettingMenus.mjs\";\nimport { LogUtil } from \"../LogUtil.mjs\";\nimport { SettingsUtil } from \"../SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../helpers/GeneralUtil.mjs\";\n\nconst { FormDataExtended } = foundry.utils;\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Tabbed Settings Menu application for managing all module settings in a unified interface.\n * Provides a tabbed form interface for accessing all settings categories in one place.\n * @extends {HandlebarsApplicationMixin(ApplicationV2)}\n */ \nexport class ModuleSettingsMenu extends HandlebarsApplicationMixin(ApplicationV2) {\n  static #element;\n  static #activeTab;\n  static #requireReload;\n  static selectedTheme;\n\n  /**\n   * Default application options\n   * @static\n   */\n  static DEFAULT_OPTIONS = {\n    id: \"flash-rolls-settings\",\n    tag: \"form\",\n    window: {\n      icon: \"fas fa-cog\",\n      title: \"FLASH_ROLLS.settings.moduleSettingsMenu.title\",\n      contentClasses: [\"standard-form\", \"crlngn\", \"tabbed-settings\"],\n      resizable: true\n    },\n    position: {\n      width: 700,\n      height: \"auto\"\n    },\n    actions: {\n      redefine: ModuleSettingsMenu.#onReset\n    },\n    form: {\n      handler: ModuleSettingsMenu.#onSubmit,\n      closeOnSubmit: true\n    }\n  }\n\n  /**\n   * Template parts used for rendering the application\n   * @static\n   */\n  static PARTS = {\n    tabs: {\n      template: \"templates/generic/tab-navigation.hbs\",\n      isGMOnly: false\n    },\n    generalSettings: {\n      menuKey: \"generalSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-general.hbs\",\n      isGMOnly: true\n    },\n    groupRolls: {\n      menuKey: \"groupRollsSettings\",\n      template: \"modules/flash-rolls-5e/templates/settings-group-rolls.hbs\",\n      isGMOnly: true\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n      isGMOnly: false\n    }\n  };\n\n  /**\n   * Tab configuration for the application\n   * @static\n   */\n  static TABS = {\n    primary: {\n      initial: \"generalSettings\",\n      tabs: ModuleSettingsMenu.#getTabs(),\n      labelPrefix: \"\"\n    }\n  };\n\n  /** @inheritDoc */\n  _configureRenderParts(options) {\n    const parts = super._configureRenderParts(options);\n    const restrictedTabs = ModuleSettingsMenu.getRestrictedTabs();\n\n    if(!game.user.isGM){\n      restrictedTabs.forEach(tab => {\n        delete parts[tab];\n      })\n    }\n\n    return parts;\n  }\n\n  /** @inheritDoc */\n  async _prepareContext(options) {\n    const context = await super._prepareContext(options);\n    context.activeTab = options.activeTab || Object.keys(context.tabs)[0];\n    context.isGM = game.user.isGM;\n    \n    return context;\n  }\n\n   /** @inheritDoc */\n   async _preparePartContext(partId, context, options) {\n    const partContext = await super._preparePartContext(partId, context, options);\n    if ( partId in context.tabs ) partContext.tab = partContext.tabs[partId];\n    const SETTINGS = getSettings();\n    const SETTINGS_MENUS = getSettingMenus();\n    const restrictedTabs = ModuleSettingsMenu.getRestrictedTabs();\n\n    if(!game.user.isGM){\n      restrictedTabs.forEach(tab => {\n        delete partContext.tabs[tab];\n      })\n    }\n    switch ( partId ) {\n      case \"tabs\": {\n        break;\n      }\n      case \"footer\": {\n        partContext.buttons = [\n          { type: \"button\", icon: \"\", label: \"FLASH_ROLLS.ui.buttons.reset\", action: 'redefine' },\n          { type: \"submit\", icon: \"\", label: \"FLASH_ROLLS.ui.buttons.save\" }\n        ];\n        break;\n      }\n      default: {\n        partContext.tab = partContext.tabs[partId];\n        const partKey = ModuleSettingsMenu.PARTS[partId]?.menuKey || null;\n        if(partKey){\n          const menuContext = ModuleSettingsMenu.getMenuContext(partKey);\n          \n          if (menuContext.fields) {\n            partContext.fields = {\n              ...partContext.fields,\n              ...menuContext.fields\n            }\n          }\n\n          if (menuContext.fieldDefaults) {\n            partContext.fieldDefaults = {\n              ...partContext.fieldDefaults,\n              ...menuContext.fieldDefaults\n            }\n          }\n\n          if (menuContext.fieldValues) {\n            Object.assign(partContext, menuContext.fieldValues);\n          }\n\n          partContext.sidebarTabs = Object.values(foundry.applications?.sidebar?.tabs || {}).map(tab => ({\n            tabName: tab.tabName,\n            name: tab.name,\n            hideForGM: false,\n            hideForPlayer: false,\n            localizedName: `FLASH_ROLLS.settings.sidebarTabs.${tab.name}`\n          }));\n        }\n        break;\n      }\n    }\n    LogUtil.log(\"_preparePartContext\", [partContext, partId]);\n    return partContext;\n  }\n\n  /**\n   * Retrieves the context object containing fields, field values, and field defaults for a specific menu\n   * @param {string} menuKey - The key of the setting menu\n   * @returns {object} The context object containing fields, field values, and field defaults\n   */\n  static getMenuContext(menuKey){\n    const SETTINGS = getSettings();\n    const fieldNames = SETTINGS[menuKey]?.fields || null;\n    if(!fieldNames) return {};\n    const fields = {};\n    const fieldValues = {};\n    const fieldDefaults = {};\n\n    fieldNames.forEach((fieldName) => {\n      if(SETTINGS[fieldName]) {\n        const value = SettingsUtil.get(SETTINGS[fieldName].tag);\n        fields[fieldName] = SETTINGS[fieldName];\n        fieldValues[fieldName] = value!== undefined ? value : SETTINGS[fieldName].default;\n        fieldDefaults[fieldName] = SETTINGS[fieldName].default;\n      }\n    });\n\n    return {fields: fields, fieldValues: fieldValues, fieldDefaults: fieldDefaults};\n  }\n\n  /**\n   * Retrieves the keys of setting menus that are restricted to GMs\n   * @returns {string[]} Array of setting menu keys\n   */\n  static getRestrictedTabs(){\n    const restrictedTabs = [];\n    Object.entries(ModuleSettingsMenu.PARTS).forEach((entry, index) => {\n      if(entry[0]!==\"tabs\" && entry[0]!==\"footer\" && entry[1].isGMOnly){\n        restrictedTabs.push(entry[0]);\n      }\n    });\n    return restrictedTabs;\n  }\n\n  /**\n   * Handles post-render operations\n   * @protected\n   * @param {object} context - The render context\n   * @param {object} options - The render options\n   */\n  _onRender = (context, options) => {\n    const SETTINGS = getSettings();\n    ModuleSettingsMenu.#element = this.element;\n\n    const hintToggles = ModuleSettingsMenu.#element.querySelectorAll('.toggle-hint');\n    LogUtil.log(\"_onRender\", [context, options, this.element]);\n    hintToggles.forEach(toggle => {\n      toggle.addEventListener('click', () => {\n        ModuleSettingsMenu.#element.querySelectorAll('p.hint').forEach(p => p.classList.toggle('shown'));\n      });\n    });\n    \n    const selects = ModuleSettingsMenu.#element.querySelectorAll('select[data-current-value]');\n    selects.forEach(select => {\n      const currentValue = String(select.dataset.currentValue);\n      const option = select.querySelector(`option[value=\"${currentValue}\"]`);\n      if (option) {\n        option.selected = true;\n      }\n    });\n\n    LogUtil.log(\"_onRender\", [context, options]);\n  }\n\n  /**\n   * Handles form submission and updates left controls settings\n   * @private\n   * @static\n   * @param {Event} event - The form submission event\n   * @param {HTMLFormElement} form - The form element\n   * @param {FormData} formData - The form data object\n   * @returns {Promise<void>}\n   */\n  static async #onSubmit(event, form, formData) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    let confirmReload = ModuleSettingsMenu.updateSettings(formData);\n\n    if(confirmReload){\n      GeneralUtil.confirmReload();\n    }\n  }\n\n  static updateSettings(formData){\n    let confirmReload = false;\n    const SETTINGS = getSettings();\n    const html = ModuleSettingsMenu.#element;\n    const activeContent = html.querySelector(\".form-content.active\");\n    const activeTab = activeContent.dataset.tab;\n    ModuleSettingsMenu.#activeTab = activeTab;\n\n    if(!formData){\n      return;\n    }\n\n    // Convert FormData into an object with proper keys\n    let settings;\n    if (formData.object) {\n      settings = foundry.utils.expandObject(formData.object);\n    } \n\n    let fieldNames = [];\n\n    Object.entries(settings).forEach(([fieldName, value]) => {\n      // Skip auxiliary form fields like range value inputs\n      if(fieldName.endsWith('_value')) return;\n      \n      LogUtil.log(\"updateSettings #1\", [SETTINGS, SETTINGS[fieldName]]);\n      if(settings[fieldName] !== undefined && SETTINGS[fieldName]) {\n        const currSetting = SettingsUtil.get(SETTINGS[fieldName].tag);\n        SettingsUtil.set(SETTINGS[fieldName].tag, settings[fieldName]);\n        \n        if(SETTINGS[fieldName]?.requiresReload && currSetting !== settings[fieldName]){\n          confirmReload = true;\n        }\n      }\n    });\n\n    ui.notifications.info(game.i18n.localize('FLASH_ROLLS.notifications.settingsUpdated'));\n    return confirmReload;\n  }\n\n  /** @inheritDoc */\n  changeTab(tab, group, options) {\n    super.changeTab(tab, group, options);\n    ModuleSettingsMenu.#activeTab = tab;\n  }\n\n  /**\n   * Resets form fields to their default values\n   * @private\n   * @static\n   * @param {Event} a - The reset event\n   * @param {HTMLElement} b - The form element\n   * @returns {Promise<void>}\n   */\n  static async #onReset(a, b){\n    const SETTINGS = getSettings();\n    const html = ModuleSettingsMenu.#element;\n    const activeContent = html.querySelector(\".form-content.active\");\n    const activeTab = activeContent.dataset.tab;\n    const menuKey = ModuleSettingsMenu.PARTS[activeTab].menuKey;\n    const defaults = SETTINGS[menuKey].default;\n\n    const inputs = activeContent.querySelectorAll(\"input, select\");\n    inputs.forEach(inputField => {\n      inputField.value = defaults[inputField.name];\n      if(inputField.type==='checkbox'){\n        inputField.checked = defaults[inputField.name];\n      }\n    });\n\n    LogUtil.log(\"#onReset\", [ModuleSettingsMenu.#activeTab, activeTab, a, b]);\n  }\n\n  static #getTabs() {\n    const tabList = [];\n    Object.entries(ModuleSettingsMenu.PARTS).forEach(([key, value]) => {\n      if(value.menuKey) {\n        tabList.push({\n          id: key,\n          icon: '',\n          group: 'primary-tabs',\n          label: `FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${key}`\n        })\n      }\n    })\n    return tabList;\n  }\n\n}\n","import { ModuleSettingsMenu } from '../components/dialogs/ModuleSettingsMenu.mjs';\n\nexport function getSettingMenus() {\n  return {\n    moduleSettingsMenu: {\n      tab: '',\n      tag: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      name: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.title\"),\n      label: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.label\"), \n      hint: game.i18n.localize(\"FLASH_ROLLS.settings.moduleSettingsMenu.hint\"),\n      icon: \"fas fa-cog\",  \n      propType: ModuleSettingsMenu,\n      restricted: true\n    }\n  };\n}","import { MODULE_ID } from \"../constants/General.mjs\";\nimport { getSettings, SETTING_SCOPE } from \"../constants/Settings.mjs\";\nimport { getSettingMenus } from \"../constants/SettingMenus.mjs\";\nimport { LogUtil } from \"./LogUtil.mjs\";\n\n/**\n * Utility class for managing module settings\n */\nexport class SettingsUtil {\n  /**\n   * Register all module settings\n   * @static\n   */\n  static registerSettings() {\n    const SETTINGS = getSettings();\n\n    /* Register each of the settings defined in the SETTINGS constant */\n    const settingsList = Object.entries(SETTINGS);\n    settingsList.forEach((entry) => {\n      const setting = entry[1]; \n\n      const settingObj = { \n        name: setting.label,\n        hint: setting.hint,\n        default: setting.default,\n        type: setting.propType,\n        scope: setting.scope,\n        config: setting.config,\n        requiresReload: setting.requiresReload || false,\n        restricted: setting.scope === SETTING_SCOPE.world,\n        onChange: value => SettingsUtil.apply(setting.tag, value)\n      }\n      if(setting.choices){\n        settingObj.choices = setting.choices;\n      }\n\n      LogUtil.log('registerSettings', [settingObj, settingObj.scope], true);\n\n      try {\n        game.settings.register(MODULE_ID, setting.tag, settingObj);\n      } catch (error) {\n        // Setting might already be registered, that's ok\n        LogUtil.log(`Setting ${setting.tag} already registered or error:`, error);\n      }\n    });\n  }\n\n  /**\n   * Register the settings menu - should be called during ready hook\n   * @static\n   */\n  static registerSettingsMenu() {\n    const settingMenus = Object.entries(getSettingMenus());\n    const tabbedMenu = settingMenus.find(entry => entry[0] === 'moduleSettingsMenu');\n    if (tabbedMenu) {\n      const tabbedMenuData = tabbedMenu[1];\n      if ((tabbedMenuData.restricted && game.user?.isGM) || !tabbedMenuData.restricted) {\n        const tabbedMenuObj = {\n          name: tabbedMenuData.tag,\n          label: tabbedMenuData.label, \n          hint: tabbedMenuData.hint,\n          icon: tabbedMenuData.icon, \n          type: tabbedMenuData.propType,\n          restricted: tabbedMenuData.restricted\n        };\n        game.settings.registerMenu(MODULE_ID, tabbedMenuData.tag, tabbedMenuObj);\n      }\n    }\n  }\n  \n  /**\n   * Retrieves the value of a module setting\n   * @param {string} settingName - Name of the setting to retrieve\n   * @param {string} [moduleName=MODULE_ID] - ID of the module the setting belongs to\n   * @returns {*} Current value of the setting\n   */\n  static get(settingName, moduleName=MODULE_ID){\n    if(!settingName){ return null; }\n\n    let setting = false;\n\n    try {\n      if(moduleName===MODULE_ID){\n        setting = game.settings.get(moduleName, settingName);\n      }else{\n        const client = game.settings.storage.get(\"client\");\n        let selectedSetting = client[`${moduleName}.${settingName}`];\n        //\n        if(selectedSetting===undefined){\n          const world = game.settings.storage.get(\"world\");\n          selectedSetting = world.getSetting(`${moduleName}.${settingName}`);\n          setting = selectedSetting?.value;\n        }\n      }\n    } catch (error) {\n      // Setting not registered yet, return default\n      LogUtil.log(`Setting ${moduleName}.${settingName} not found, returning false`);\n      return false;\n    }\n\n    return setting;\n  }\n  \n  /**\n   * Updates the value of a module setting\n   * @param {string} settingName - Name of the setting to update\n   * @param {*} newValue - New value to set\n   * @param {string} [moduleName=MODULE_ID] - ID of the module the setting belongs to\n   * @returns {boolean} True if setting was updated successfully\n   */\n  static set(settingName, newValue, moduleName=MODULE_ID){ \n    if(!settingName){ return false; }\n\n    let selectedSetting = game.settings.storage.get(\"client\")[`${moduleName}.${settingName}`];\n\n    if(!selectedSetting){\n      const world = game.settings.storage.get(\"world\");\n      selectedSetting = world.getSetting(`${moduleName}.${settingName}`);\n      LogUtil.log('SettingsUtil.set - world Setting?', [selectedSetting]);\n    } \n\n    try{\n      game.settings.set(moduleName, settingName, newValue);\n      LogUtil.log('SettingsUtil.set - success', [moduleName, settingName, newValue]);\n    }catch(e){\n      LogUtil.error('SettingsUtil.set - error', [e]);\n    }\n\n    return true;\n  }\n\n  static apply(settingName, newValue){\n    const SETTINGS = getSettings();\n    switch(settingName){\n      case SETTINGS.rollRequestsEnabled.tag:\n        SettingsUtil.applyRollRequestsEnabled(newValue);\n        break;\n      default:\n        break;\n    }\n  }\n\n  static applyRollRequestsEnabled(newValue){\n    const requestsIcon = document.querySelector(\".chat-controls .flash-rolls-icon\");\n    if(!requestsIcon){ return; }\n    \n    if(newValue){\n      requestsIcon.classList.add(\"active\");\n      // requestsIcon.setAttribute(\"aria-pressed\", \"true\");\n    }else{\n      requestsIcon.classList.remove(\"active\");\n      // requestsIcon.setAttribute(\"aria-pressed\", \"false\");\n    }\n  }\n}\n","import { LogUtil } from \"../../LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../constants/General.mjs\";\nimport { HOOKS_CORE } from \"../../../constants/Hooks.mjs\";\nimport { GeneralUtil } from \"../../helpers/GeneralUtil.mjs\";\n\n// Check if required D&D5e classes exist\nHooks.once(HOOKS_CORE.READY, () => {\n  if (!dnd5e.applications.dice.DamageRollConfigurationDialog) {\n    LogUtil.warn(\"DamageRollConfigurationDialog not found in dnd5e.applications.dice\");\n  }\n});\n\n/**\n * Mixin that provides GM-specific functionality for roll configuration dialogs\n * @param {Class} Base - The base dialog class to extend\n * @returns {Class} The extended class with GM functionality\n */\nexport function GMRollConfigMixin(Base) {\n  return class extends Base {\n    constructor(config = {}, message = {}, options = {}) {\n      super(config, message, options);\n      \n      this.actors = options.actors || [];\n      this.sendRequest = options.sendRequest ?? options.sendRequest ?? true;\n      this.showDC = options.showDC || false;\n      this.dcValue = options.dcValue || null;\n      \n      this.rollKey = options.rollKey || config.skill || config.ability || null;\n      this.rollTypeString = options.rollTypeString || null;\n      \n      this.windowTitle = options.window?.title || \"\";\n      this.windowSubtitle = options.window?.subtitle || \"\";\n    }\n    \n    /**\n     * Build a roll configuration from form data.\n     * Handles situational bonuses, ability selection, and DC values.\n     * @param {BasicRollConfiguration} config - Individual roll configuration from the rolls array\n     * @param {FormDataExtended} formData - Data from the dialog form\n     * @param {number} index - Index of this roll in the rolls array\n     * @returns {BasicRollConfiguration} The modified individual roll configuration\n     * @protected\n     * @override\n     */\n    _buildConfig(config, formData, index) {\n      const abilityFromForm = formData?.get(\"ability\");\n      const dcFromForm = formData?.get(\"dc\");\n      \n      const situational = formData?.get(`rolls.${index}.situational`);\n      LogUtil.log('_buildConfig', [situational, formData, config]);\n      if (situational) {\n        if (!config.parts) config.parts = [];\n        config.parts.push(\"@situational\");\n        if (!config.data) config.data = {};\n        config.data.situational = situational;\n      }else if (config.parts) {\n        const idx = config.parts.indexOf(\"@situational\");\n        if (idx !== -1) config.parts.splice(idx, 1);\n      }\n      \n      if (abilityFromForm) {\n        config.ability = abilityFromForm;\n        this.config.ability = abilityFromForm;\n      }\n      \n      const result = super._buildConfig(config, formData, index);\n      \n      if (dcFromForm) {\n        const dcValue = parseInt(dcFromForm);\n        if (!isNaN(dcValue)) {\n          result.options = result.options || {};\n          result.options.target = dcValue;\n        }\n      } else if (this.dcValue !== undefined && this.dcValue !== null) {\n        result.options = result.options || {};\n        result.options.target = this.dcValue;\n      }\n      \n      LogUtil.log(`${this.constructor.name}._buildConfig`, [this.config, formData, result]);\n      return result;\n    }\n    \n    /**\n     * Handle form changes to capture GM-specific fields.\n     * @param {Object} formConfig - The form configuration object\n     * @param {Event} event - The change event\n     * @protected\n     * @override\n     */\n    _onChangeForm(formConfig, event) {\n      LogUtil.log(`_onChangeForm`, [event.target.value]);\n      super._onChangeForm(formConfig, event);\n\n      const sendRequestCheckbox = this.element.querySelector('input[name=\"flash5e-send-request\"]');\n      if (sendRequestCheckbox) {\n        this.sendRequest = sendRequestCheckbox.checked;\n      }\n      \n      const dcInput = this.element.querySelector('input[name=\"dc\"]');\n      if (dcInput && dcInput.value) {\n        this.dcValue = parseInt(dcInput.value) || null;\n      }\n      \n    }\n    \n    /**\n     * Finalize rolls based on the action button clicked.\n     * @param {string} action - The action button that was clicked\n     * @returns {D20Roll[]} Array of finalized rolls ready for execution\n     * @protected\n     * @override\n     */\n    _finalizeRolls(action) {\n      const finalizedRolls = super._finalizeRolls(action);\n      LogUtil.log(`_finalizeRolls #1`, [finalizedRolls, this.sendRequest]);\n      \n      if (this.dcValue !== undefined && this.dcValue !== null) {\n        for (const roll of finalizedRolls) {\n          roll.options.target = this.dcValue;\n        }\n      }\n      \n      this.config.sendRequest = this.sendRequest;\n      \n      return finalizedRolls;\n    }\n    \n    /**\n     * Handle post-render actions for the dialog.\n     * Triggers initial formula rebuild if there's a situational bonus.\n     * @param {ApplicationRenderContext} context - The render context.\n     * @param {HandlebarsRenderOptions} options - Rendering options.\n     * @returns {Promise<void>}\n     * @protected\n     * @override\n     */\n    async _onRender(context, options) {\n      await super._onRender(context, options);\n      \n      if (this.config.rolls?.[0]?.data?.situational || this.config.situational) {\n        LogUtil.log(`${this.constructor.name}._onRender`, ['Triggering rebuild for initial situational bonus']);\n        setTimeout(() => {\n          this.rebuild();\n        }, 100);\n      }\n    }\n  };\n}","/**\n * Helper functions for the Flash Rolls 5e module\n */\nimport { MODULE, ROLL_TYPES } from '../../constants/General.mjs';\nimport { GeneralUtil } from './GeneralUtil.mjs';\n\n/**\n * Get display name for roll type with optional details\n * @param {string} rollType - The type of roll\n * @param {string} rollKey - Optional key for the specific roll (ability, skill, etc.)\n * @returns {string} Formatted display string\n */\nexport function getRollTypeDisplay(rollType, rollKey) {\n  let display = game.i18n.localize(`FLASH_ROLLS.rollTypes.${rollType}`) || rollType;\n  \n  // Normalize rollType to lowercase for consistent comparisons\n  const normalizedRollType = rollType?.toLowerCase();\n  \n  if (rollKey) {\n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        display += ` (${CONFIG.DND5E.skills[rollKey]?.label || rollKey})`;\n        break;\n      case ROLL_TYPES.SAVE:\n        display += ` (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n        break;\n      case ROLL_TYPES.ABILITY:\n        display += ` (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n        break;\n      case ROLL_TYPES.TOOL:\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          display += ` (${toolItem?.name || rollKey})`;\n        } else {\n          display += ` (${rollKey})`;\n        }\n        break;\n      case ROLL_TYPES.CUSTOM:\n        display = `${display}: ${rollKey}`;\n        break;\n    }\n  }\n  \n  return display;\n}\n\n/**\n * Show batched notifications to player\n * @param {Array} pendingNotifications - Array of notification objects\n * @param {Function} getRollTypeDisplayFn - Function to get roll type display (default: getRollTypeDisplay)\n */\nexport function showBatchedNotifications(pendingNotifications, getRollTypeDisplayFn = getRollTypeDisplay) {\n  if (pendingNotifications.length === 0) return;\n  \n  // Group by roll type\n  const notificationsByType = {};\n  for (const notif of pendingNotifications) {\n    const key = `${notif.rollType}_${notif.rollKey || ''}`;\n    if (!notificationsByType[key]) {\n      notificationsByType[key] = {\n        rollType: notif.rollType,\n        rollKey: notif.rollKey,\n        actors: [],\n        gm: notif.gm\n      };\n    }\n    notificationsByType[key].actors.push(notif.actor);\n  }\n  \n  const entries = Object.values(notificationsByType);\n  if (entries.length === 1 && entries[0].actors.length === 1) {\n    // Single roll request - use original format\n    const entry = entries[0];\n    ui.notifications.info(game.i18n.format('FLASH_ROLLS.notifications.rollRequestReceived', {\n      gm: entry.gm,\n      rollType: getRollTypeDisplayFn(entry.rollType, entry.rollKey)\n    }));\n  } else {\n    // Multiple requests - create consolidated message\n    const messages = [];\n    for (const entry of entries) {\n      const rollTypeDisplay = getRollTypeDisplayFn(entry.rollType, entry.rollKey);\n      const actorNames = entry.actors.join(\", \");\n      messages.push(`${rollTypeDisplay} (${actorNames})`);\n    }\n    \n    ui.notifications.info(game.i18n.format('FLASH_ROLLS.notifications.rollRequestsReceivedMultiple', {\n      gm: entries[0].gm,\n      requests: messages.join(\"; \")\n    }));\n  }\n}\n\n/**\n * Check if an actor is owned by a player (not GM)\n * @param {Actor} actor - The actor to check\n * @returns {User|null} The player owner, or null if not player-owned\n */\nexport function getPlayerOwner(actor) {\n  const ownership = actor.ownership || {};\n  \n  for (const [userId, level] of Object.entries(ownership)) {\n    if (level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER) {\n      const user = game.users.get(userId);\n      if (user && !user.isGM) {\n        return user;\n      }\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Get actor stats for display (ability scores and modifiers)\n * @param {Actor} actor - The actor to get stats for\n * @returns {Array} Array of stat objects with name, value, and modifier\n */\nexport function getActorStats(actor) {\n  if (!actor?.system?.abilities) return [];\n  \n  return Object.entries(actor.system.abilities).map(([key, ability]) => ({\n    name: key.toUpperCase(),\n    value: ability.value || 10,\n    modifier: ability.mod >= 0 ? `+${ability.mod}` : `${ability.mod}`\n  }));\n}\n\n/**\n * Apply target tokens to user\n * @param {Array<string>} tokenIds - Array of token IDs to target\n * @param {User} user - User to apply targets for (default: game.user)\n */\nexport function applyTargetTokens(tokenIds, user = game.user) {\n  if (!tokenIds?.length) return;\n  \n  const tokens = tokenIds\n    .map(id => canvas.tokens.get(id))\n    .filter(t => t);\n    \n  tokens.forEach(t => t.setTarget(true, { user }));\n}\n\n/**\n * Clear all target tokens for user\n * @param {User} user - User to clear targets for (default: game.user)\n */\nexport function clearTargetTokens(user = game.user) {\n  user.targets.forEach(t => t.setTarget(false, { user }));\n}\n\n/**\n * Format a notification message for multiple actors\n * @param {Array<string>} actorNames - Array of actor names\n * @param {string} action - The action being performed\n * @returns {string} Formatted message\n */\nexport function formatMultiActorNotification(actorNames, action) {\n  if (actorNames.length === 0) return \"\";\n  if (actorNames.length === 1) return `${actorNames[0]} ${action}`;\n  \n  const and = game.i18n.localize(\"FLASH_ROLLS.common.and\");\n  \n  if (actorNames.length === 2) return `${actorNames[0]} ${and} ${actorNames[1]} ${action}`;\n  \n  const lastActor = actorNames[actorNames.length - 1];\n  const otherActors = actorNames.slice(0, -1).join(\", \");\n  return `${otherActors}, ${and} ${lastActor} ${action}`;\n}\n\n/**\n * Check if an actor is owned by a player (not GM)\n * @param {Actor} actor - The actor to check\n * @returns {boolean} True if owned by a player\n */\nexport function isPlayerOwned(actor) {\n  // Skip non-character actors\n  if (actor.type !== 'character' && actor.type !== 'npc') return false;\n  \n  return Object.entries(actor.ownership)\n    .some(([userId, level]) => {\n      const user = game.users.get(userId);\n      return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n    });\n}\n\n/**\n * Check if actor has token in current scene\n * @param {Actor} actor - The actor to check\n * @returns {boolean} True if actor has token in current scene\n */\nexport function hasTokenInScene(actor) {\n  // Skip non-character actors\n  if (actor.type !== 'character' && actor.type !== 'npc') return false;\n  \n  const currentScene = game.scenes.active;\n  return currentScene && currentScene.tokens.some(token => token.actorId === actor.id);\n}\n\n/**\n * Update token selection on canvas based on actor selection\n * @param {string} actorId - The actor ID\n * @param {boolean} selected - Whether to select or deselect\n */\nexport function updateCanvasTokenSelection(actorId, selected) {\n  const scene = game.scenes.active;\n  if (!scene) return;\n  \n  // Find all tokens for this actor in the current scene\n  const tokens = canvas.tokens.placeables.filter(t => t.actor?.id === actorId);\n  \n  for (const token of tokens) {\n    if (selected) {\n      // Add to selection without clearing others\n      token.control({ releaseOthers: false });\n    } else {\n      // Release this token\n      token.release();\n    }\n  }\n}\n\n/**\n * Delay execution for a specified time\n * @param {number} ms - Milliseconds to delay\n * @returns {Promise} Promise that resolves after the delay\n */\nexport function delay(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Check if the sidebar is expanded\n * @returns {boolean} True if sidebar is expanded\n */\nexport function isSidebarExpanded() {\n  return ui?.sidebar?.expanded || false;\n}\n\n/**\n * Update body class based on sidebar state\n * @param {boolean} isExpanded - Whether sidebar is expanded\n */\nexport function updateSidebarClass(isExpanded) {\n  const body = document.querySelector(\"body\"); \n  if (isExpanded) {\n    body.classList.add(\"flash5e-sidebar-expanded\"); \n  } else {\n    body.classList.remove(\"flash5e-sidebar-expanded\"); \n  }\n  adjustMenuOffset();\n}\n\n/**\n * Build roll types array for a selected request type\n * @param {string} selectedRequestType - The type of roll request\n * @param {Set} selectedActors - Set of selected actor IDs\n * @returns {Array} Array of roll type objects with id, name, and rollable properties\n */\nexport function buildRollTypes(selectedRequestType, selectedActors) {\n  const rollTypes = [];\n  \n  if (!selectedRequestType || selectedActors.size === 0) {\n    return rollTypes;\n  }\n  \n  const selectedOption = MODULE.ROLL_REQUEST_OPTIONS[selectedRequestType];\n  if (!selectedOption || !selectedOption.subList) {\n    return rollTypes;\n  }\n  \n  // Get first selected actor as reference for available options\n  const firstActorId = Array.from(selectedActors)[0];\n  const actor = game.actors.get(firstActorId);\n  \n  // Special handling for tools - show all available tools\n  if (selectedOption.subList === 'tools') {\n    // Get all tools from CONFIG.DND5E.tools or enrichmentLookup\n    const allTools = CONFIG.DND5E.enrichmentLookup?.tools || CONFIG.DND5E.tools || {};\n    \n    for (const [key, toolData] of Object.entries(allTools)) {\n      let label = key;\n      \n      // Use enrichmentLookup to get tool UUID and then fetch the name\n      if (toolData?.id) {\n        // Get the tool name using Trait.getBaseItem\n        const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n        label = toolItem?.name || key;\n      }\n      // Fallback - format the key\n      else {\n        label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).trim();\n      }\n      \n      rollTypes.push({\n        id: key,\n        name: label,\n        rollable: true\n      });\n    }\n    \n    // Sort tools alphabetically by name\n    rollTypes.sort((a, b) => a.name.localeCompare(b.name));\n  }\n  // For other types, use actor data\n  else if (actor && selectedOption.actorPath) {\n    const rollData = foundry.utils.getProperty(actor, selectedOption.actorPath) || {};\n    \n    // Check if we should use CONFIG.DND5E for enrichment\n    const configData = CONFIG.DND5E[selectedOption.subList];\n    \n    for (const [key, data] of Object.entries(rollData)) {\n      let label = '';\n      \n      // For skills, use CONFIG.DND5E.skills for full names\n      if (selectedOption.subList === 'skills' && configData?.[key]) {\n        label = configData[key].label;\n      }\n      // For abilities (saving throws), use the label from data\n      else if (selectedOption.subList === 'abilities' && configData?.[key]) {\n        label = configData[key].label;\n      }\n      // Default fallback\n      else {\n        label = data.label || game.i18n.localize(data.name || key) || key;\n      }\n      \n      rollTypes.push({\n        id: key,\n        name: label,\n        rollable: true\n      });\n    }\n    \n    // Sort skills alphabetically by name\n    if (selectedOption.subList === 'skills') {\n      rollTypes.sort((a, b) => a.name.localeCompare(b.name));\n    }\n  }\n  \n  return rollTypes;\n}\n\n/**\n * Unified notification system with batching support\n */\nexport class NotificationManager {\n  static pendingNotifications = [];\n  static notificationTimer = null;\n  static NOTIFICATION_BATCH_DELAY = 500; // ms to wait for additional notifications\n  \n  /**\n   * Show a notification with optional batching for roll requests\n   * @param {string} type - Notification type (info, warn, error)\n   * @param {string} message - Message to display\n   * @param {Object} options - Options for the notification\n   * @param {boolean} options.batch - Whether to batch this notification\n   * @param {Object} options.batchData - Data for batched notifications\n   */\n  static notify(type, message, options = {}) {\n    // If not batching, show immediately\n    if (!options.batch) {\n      ui.notifications[type](message);\n      return;\n    }\n    \n    // Add to pending notifications for batching\n    if (options.batchData) {\n      NotificationManager.pendingNotifications.push(options.batchData);\n      \n      // Clear existing timer and set new one\n      if (NotificationManager.notificationTimer) {\n        clearTimeout(NotificationManager.notificationTimer);\n      }\n      \n      NotificationManager.notificationTimer = setTimeout(() => {\n        showBatchedNotifications(NotificationManager.pendingNotifications);\n        NotificationManager.pendingNotifications = [];\n        NotificationManager.notificationTimer = null;\n      }, NotificationManager.NOTIFICATION_BATCH_DELAY);\n    }\n  }\n  \n  /**\n   * Show roll request sent notifications (GM side)\n   * @param {Object} requestsByPlayer - Grouped requests by player\n   * @param {string} rollTypeName - Display name of the roll type\n   */\n  static notifyRollRequestsSent(requestsByPlayer, rollTypeName) {\n    const successfulRequests = Object.entries(requestsByPlayer);\n    \n    if (successfulRequests.length === 0) return;\n    \n    // Single player, single actor\n    if (successfulRequests.length === 1) {\n      const playerData = Object.values(requestsByPlayer)[0];\n      const actorNames = playerData.actors.map(a => a.name).join(\", \");\n      ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.rollRequestsSentSingle\", { \n        rollType: rollTypeName,\n        actors: actorNames,\n        player: playerData.player.name\n      }));\n    } else {\n      // Multiple players\n      const playerSummaries = successfulRequests.map(([playerId, data]) => {\n        const actorNames = data.actors.map(a => a.name).join(\", \");\n        return `${data.player.name} (${actorNames})`;\n      });\n      ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.rollRequestsSentMultiple\", { \n        rollType: rollTypeName,\n        count: successfulRequests.length,\n        players: playerSummaries.join(\"; \")\n      }));\n    }\n  }\n  \n  /**\n   * Clear any pending notifications\n   */\n  static clearPending() {\n    if (NotificationManager.notificationTimer) {\n      clearTimeout(NotificationManager.notificationTimer);\n      NotificationManager.notificationTimer = null;\n    }\n    NotificationManager.pendingNotifications = [];\n  }\n}\n\n/**\n * Filter actors based on death save requirements\n * @param {Actor[]} actors - Array of actors to filter\n * @returns {Actor[]} Array of actors that need death saves\n */\nexport function filterActorsForDeathSaves(actors) {\n  const actorsNeedingDeathSaves = [];\n  const actorsSkippingDeathSaves = [];\n  \n  for (const actor of actors) {\n    const hp = actor.system.attributes.hp?.value || 0;\n    const deathSaves = actor.system.attributes.death || {};\n    const successes = deathSaves.success || 0;\n    const failures = deathSaves.failure || 0;\n    \n    // Check if actor needs a death save\n    if (hp <= 0 && successes < 3 && failures < 3) {\n      actorsNeedingDeathSaves.push(actor);\n    } else {\n      actorsSkippingDeathSaves.push(actor.name);\n    }\n  }\n  \n  // Notify about actors that don't need death saves\n  if (actorsSkippingDeathSaves.length > 0) {\n    NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.actorsSkippingDeathSave\", {\n      actors: actorsSkippingDeathSaves.join(\", \")\n    }));\n  }\n  \n  return actorsNeedingDeathSaves;\n}\n\n/**\n * Categorize actors by ownership (PC vs NPC)\n * @param {Actor[]} actors - Array of actors to categorize\n * @returns {{pcActors: Array, npcActors: Actor[]}} Object with categorized actors\n */\nexport function categorizeActorsByOwnership(actors) {\n  const pcActors = [];\n  const npcActors = [];\n  \n  for (const actor of actors) {\n    const owner = getPlayerOwner(actor);\n    if (owner) {\n      pcActors.push({ actor, owner });\n    } else {\n      npcActors.push(actor);\n    }\n  }\n  \n  return { pcActors, npcActors };\n}\n\nexport function addHDUpdate(updates, newUpdate){\n  const existingIndex = updates.findIndex(update => update._id === newUpdate._id);\n  if(existingIndex > -1){\n    updates[existingIndex] = foundry.utils.mergeObject(\n      updates[existingIndex],\n      newUpdate\n    )\n  }else{\n    updates.push(newUpdate);\n  }\n}\n\n/**\n * Adjust the offset vars for the roll menu based on the state of the roll privacy controls\n */\nexport function adjustMenuOffset(isExpanded=true){\n  const rollPrivacyVertical = document.querySelector('#chat-notifications #roll-privacy');\n  const controlsWidth = rollPrivacyVertical ? GeneralUtil.getFullWidth(rollPrivacyVertical) : 36;\n  GeneralUtil.addCSSVars('--flash-rolls-menu-offset', controlsWidth + 'px');\n}","import { LogUtil } from \"../LogUtil.mjs\";\nimport { ROLL_TYPES } from \"../../constants/General.mjs\";\nimport { getSettings } from \"../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../SettingsUtil.mjs\";\nimport { getPlayerOwner } from \"./Helpers.mjs\";\n\n/**\n * Helper functions for roll handling\n */\nexport const RollHelpers = {\n  /**\n   * Add situational bonus to a roll configuration\n   * @param {BasicRollProcessConfiguration} config - The process configuration with rolls array\n   * @param {string} situational - The situational bonus formula\n   * @returns {BasicRollProcessConfiguration} The modified config\n   */\n  addSituationalBonus(config, situational) {\n    LogUtil.log(\"Config before adding bonus:\", [situational, config]);\n    if (situational && config.rolls?.[0]) {\n      // Ensure the roll has proper structure\n      if (!config.rolls[0].parts) config.rolls[0].parts = [];\n      if (!config.rolls[0].data) config.rolls[0].data = {};\n      \n      config.rolls[0].data.situational = situational;\n      \n      // Only add @situational if it's not already in parts\n      if (!config.rolls[0].parts.includes(\"@situational\")) {\n        config.rolls[0].parts.push(\"@situational\");\n      }\n      LogUtil.log(\"Config after adding bonus:\", [config]);\n    }\n    // config.situational = situational;\n    return config;\n  },\n\n  /**\n   * Build base configuration for all roll types\n   * @param {Object} requestData - The roll request data\n   * @param {Object} requestData.config - Configuration from the request\n   * @param {boolean} [requestData.config.advantage] - Roll with advantage\n   * @param {boolean} [requestData.config.disadvantage] - Roll with disadvantage\n   * @param {string} [requestData.config.situational] - Situational bonus formula\n   * @param {number} [requestData.config.target] - DC value\n   * @param {string} [requestData.config.requestedBy] - Name of requester\n   * @param {BasicRollConfiguration} rollConfig - Individual roll configuration with parts[], data{}, options{}\n   * @param {string[]} [rollConfig.parts=[]] - Roll formula parts\n   * @param {Object} [rollConfig.data={}] - Roll data for formula resolution\n   * @param {Object} [rollConfig.options={}] - Roll options\n   * @param {Object} [additionalConfig={}] - Additional configuration specific to the roll type\n   * @returns {BasicRollProcessConfiguration} The process configuration for D&D5e actor roll methods\n   */\n  buildRollConfig(requestData, rollConfig, additionalConfig = {}) {\n    // Build BasicRollProcessConfiguration\n    const config = {\n      rolls: [{\n        parts: rollConfig.parts || [],\n        data: rollConfig.data || {},\n        options: {\n          ...rollConfig.options || {},\n          // Preserve the _fromFlashRolls flag if it exists\n          ...(rollConfig.options?._fromFlashRolls && { _fromFlashRolls: true })\n        }\n      }],\n      advantage: requestData.config.advantage || false,\n      disadvantage: requestData.config.disadvantage || false,\n      target: requestData.config.target,\n      subject: null,\n      chatMessage: true,\n      legacy: false,\n      // Include rollMode if it's in the config\n      ...(requestData.config.rollMode && { rollMode: requestData.config.rollMode }),\n      ...additionalConfig\n    };\n    \n    const situational = requestData.config.situational;\n    if (situational) {\n      this.addSituationalBonus(config, situational);\n    }\n    \n    return this.ensureRollFlags(config, requestData);\n  },\n\n  /**\n   * Ensure roll config has the required flags to prevent re-interception\n   * @param {BasicRollProcessConfiguration} config - The process configuration\n   * @param {Object} requestData - The roll request data\n   * @param {Object} requestData.config - Configuration object\n   * @param {string} [requestData.config.requestedBy] - Name of requester\n   * @returns {BasicRollProcessConfiguration} The updated config with required flags\n   */\n  ensureRollFlags(config, requestData) {\n    config.isRollRequest = game.user.isGM ? false : true;\n    config._showRequestedBy = true;\n    config._requestedBy = requestData.config.requestedBy || 'GM';\n\n    return config;\n  },\n\n  /**\n   * Validate and normalize actors array\n   * @param {Actor[]|string[]} actors - Array of Actor documents or actor IDs\n   * @returns {Actor[]|null} Array of valid actors or null if no valid actors\n   */\n  validateActors(actors) {\n    if (!actors || actors.length === 0) return null;\n    \n    // Convert actor IDs to Actor documents if needed\n    if (typeof actors[0] === 'string') {\n      actors = actors.map(actorId => game.actors.get(actorId)).filter(a => a);\n    }\n    \n    return actors.length > 0 ? actors : null;\n  },\n\n  /**\n   * Determine the appropriate roll class based on roll type\n   * @param {string} rollType - The type of roll\n   * @returns {typeof BasicRoll} The appropriate roll class\n   */\n  getRollClass(rollType) {\n    const normalizedType = rollType?.toLowerCase();\n    \n    if ([ROLL_TYPES.DAMAGE, ROLL_TYPES.HEALING].includes(normalizedType)) {\n      return CONFIG.Dice.DamageRoll || CONFIG.Dice.BasicRoll;\n    } else if ([ROLL_TYPES.FORMULA, ROLL_TYPES.CUSTOM, ROLL_TYPES.HIT_DIE].includes(normalizedType)) {\n      return CONFIG.Dice.BasicRoll;\n    }\n    \n    return CONFIG.Dice.D20Roll;\n  },\n\n  /**\n   * Check if DC field should be shown for a roll type\n   * @param {string} rollType - The type of roll\n   * @returns {boolean} Whether to show DC field\n   */\n  shouldShowDC(rollType) {\n    const normalizedType = rollType?.toLowerCase();\n    return [\n      ROLL_TYPES.SAVE,\n      ROLL_TYPES.SAVING_THROW,\n      ROLL_TYPES.ABILITY,\n      ROLL_TYPES.ABILITY_CHECK,\n      ROLL_TYPES.CONCENTRATION,\n      ROLL_TYPES.SKILL,\n      ROLL_TYPES.TOOL\n    ].includes(normalizedType);\n  },\n\n  /**\n   * Create base roll configuration for dialog\n   * @param {Actor} actor - The actor to roll for\n   * @param {string} rollType - The type of roll\n   * @param {string} rollKey - The specific roll key\n   * @returns {Object} Base roll configuration\n   */\n  createBaseRollConfig(actor, rollType, rollKey) {\n    const normalizedType = rollType?.toLowerCase();\n    \n    const rollConfig = {\n      data: actor.getRollData(),\n      subject: actor,\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n    \n    // Add roll-specific data\n    switch (normalizedType) {\n      case ROLL_TYPES.SKILL:\n        rollConfig.skill = rollKey;\n        break;\n      case ROLL_TYPES.TOOL:\n        rollConfig.tool = rollKey;\n        break;\n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        rollConfig.ability = rollKey;\n        break;\n      case ROLL_TYPES.HIT_DIE:\n        rollConfig.rolls[0].options.flavor = \"Hit Die\";\n        break;\n    }\n    \n    return rollConfig;\n  },\n\n  /**\n   * Create standard message configuration\n   * @param {Actor} actor - The actor creating the message\n   * @param {string} [rollMode] - Optional roll mode to set\n   * @returns {Object} Message configuration\n   */\n  createMessageConfig(actor, rollMode = null) {\n    const config = {\n      create: false,\n      data: {\n        speaker: ChatMessage.getSpeaker({ actor })\n      }\n    };\n    \n    if (rollMode) {\n      config.rollMode = rollMode;\n    }\n    \n    return config;\n  },\n\n  /**\n   * Execute a roll dialog and return the result\n   * @param {Class} DialogClass - The dialog class to instantiate\n   * @param {Object} rollConfig - Roll configuration\n   * @param {Object} messageConfig - Message configuration\n   * @param {Object} dialogOptions - Dialog options\n   * @returns {Promise<Object|null>} Dialog result or null if cancelled\n   */\n  async triggerRollDialog(DialogClass, rollConfig, messageConfig, dialogOptions) {\n    const app = new DialogClass(rollConfig, messageConfig, dialogOptions);\n    \n    const result = await new Promise(resolve => {\n      app.addEventListener(\"close\", () => {\n        resolve({\n          rolls: app.rolls,\n          config: app.config,\n          message: app.message,\n          sendRequest: app.sendRequest,\n          critical: app.config.critical,\n          isCritical: app.config.isCritical\n        });\n      }, { once: true });\n      app.render({ force: true });\n    });\n    \n    return result;\n  },\n\n  /**\n   * Process dialog result into final roll configuration\n   * @param {Object} result - Result from dialog\n   * @param {Actor[]} actors - Array of actors\n   * @param {string} rollType - The type of roll\n   * @param {string} rollKey - The specific roll key\n   * @param {Object} options - Additional options\n   * @returns {Object|null} Final roll process configuration or null if cancelled\n   */\n  processDialogResult(result, actors, rollType, rollKey, options = {}) {\n    // If no rolls or user cancelled\n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    const normalizedType = rollType?.toLowerCase();\n    const firstRoll = result.rolls[0];\n    \n    // Extract advantage mode\n    let advantage = false;\n    let disadvantage = false;\n    \n    if (firstRoll?.options?.advantageMode !== undefined) {\n      advantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE;\n      disadvantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE;\n    }\n    \n    // Extract roll data\n    const situational = firstRoll?.data?.situational || \"\";\n    const target = firstRoll?.options?.target;\n    \n    // Build roll process configuration\n    const rollProcessConfig = {\n      rolls: [{\n        parts: firstRoll?.parts?.slice() || [],\n        data: situational ? { situational } : {},\n        options: target ? { target } : {}\n      }],\n      subject: actors[0],\n      advantage,\n      disadvantage,\n      target,\n      sendRequest: result.sendRequest,\n      isRollRequest: result.sendRequest,\n      skipRollDialog: options.skipRollDialog || false,\n      chatMessage: true\n    };\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = this.determineRollMode(isPublicRollsOn, result.message?.rollMode);\n    rollProcessConfig.rollMode = rollMode;\n    \n    if (result.config?.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedType)) {\n      rollProcessConfig.ability = result.config.ability;\n    }\n    \n    return rollProcessConfig;\n  },\n\n  /**\n   * Determine the final roll mode\n   * @param {boolean} isPublicRollsOn - Whether public rolls setting is enabled\n   * @param {string} messageRollMode - Roll mode from message (user's selection in dialog)\n   * @returns {string} Final roll mode\n   */\n  determineRollMode(isPublicRollsOn, messageRollMode) {\n    // If user explicitly selected a roll mode in the dialog, use it\n    if (messageRollMode) {\n      return messageRollMode;\n    }\n    \n    // Otherwise, use the default based on settings\n    return isPublicRollsOn ? \n      CONST.DICE_ROLL_MODES.PUBLIC : \n      game.settings.get(\"core\", \"rollMode\");\n  },\n\n  /**\n   * Check if actor is player owned\n   * @param {Actor} actor - The actor to check\n   * @returns {boolean} Whether the actor is player owned\n   */\n  isPlayerOwned(actor) {\n    return Object.entries(actor.ownership)\n      .some(([userId, level]) => {\n        const user = game.users.get(userId);\n        return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n      });\n  },\n\n  /**\n   * Check if actor is player owned\n   * @param {Actor} actor - The actor to check\n   * @returns {boolean} Whether the actor is player owned\n   */\n  isPlayerOwnerActive(actor) {\n    const playerOwner = getPlayerOwner(actor);\n    return playerOwner && playerOwner.active;\n  },\n\n  /* -------------------------------------------- */\n  /*  Group Roll Calculation Methods              */\n  /* -------------------------------------------- */\n\n  /**\n   * Calculate group roll result using Standard Rule - At least half the group must succeed\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total, success, failure }\n   * @param {number} dc - The DC to check against\n   * @returns {Object} Result object with { finalResult, successes, failures, summary }\n   */\n  calculateStandardRule(rollResults, dc) {\n    const successes = rollResults.filter(r => r.total >= dc).length;\n    const failures = rollResults.length - successes;\n    const halfThreshold = Math.ceil(rollResults.length / 2);\n    \n    return {\n      finalResult: successes >= halfThreshold,\n      successes,\n      failures,\n      summary: game.i18n.format(\"FLASH_ROLLS.groupRoll.standardRule.summary\", {\n        successes,\n        total: rollResults.length,\n        threshold: halfThreshold\n      }),\n      method: 'Standard Rule'\n    };\n  },\n\n  /**\n   * Calculate group roll result using Group Average - Simple average of all rolls, rounded down\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total }\n   * @param {number} dc - The DC to check against\n   * @returns {Object} Result object with { finalResult, average, success, summary }\n   */\n  calculateGroupAverage(rollResults, dc) {\n    const sum = rollResults.reduce((acc, r) => acc + r.total, 0);\n    const average = Math.floor(sum / rollResults.length);\n    \n    return {\n      finalResult: average,\n      average,\n      success: average >= dc,\n      summary: game.i18n.format(\"FLASH_ROLLS.groupRoll.groupAverage.summary\", {\n        average,\n        dc\n      }),\n      method: 'Group Average'\n    };\n  },\n\n  /**\n   * Calculate group roll result using Leader with Help - Result from actor with highest bonus, plus successes minus failures\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total, modifier }\n   * @param {number} dc - The DC to check against\n   * @param {Actor[]} actors - Array of actors to get modifiers from\n   * @param {string} rollType - Type of roll (skill, save, ability)\n   * @param {string} rollKey - The specific roll key (e.g., 'ath', 'dex')\n   * @returns {Object} Result object with { finalResult, leaderRoll, bonus, penalty, success, summary }\n   */\n  calculateLeaderWithHelp(rollResults, dc, actors, rollType, rollKey) {\n    let highestModifier = -999;\n    let leaderActorId = null;\n    let leaderModifier = 0;\n    \n    for (const actor of actors) {\n      const modifier = this._getActorModifier(actor, rollType, rollKey);\n      if (modifier > highestModifier) {\n        highestModifier = modifier;\n        leaderActorId = actor.id;\n        leaderModifier = modifier;\n      }\n    }\n    \n    const leaderResult = rollResults.find(r => r.actorId === leaderActorId);\n    if (!leaderResult) {\n      return {\n        finalResult: 0,\n        error: 'Leader actor did not roll',\n        method: 'Leader with Help'\n      };\n    }\n    \n    // Count successes and failures (excluding the leader)\n    const otherResults = rollResults.filter(r => r.actorId !== leaderActorId);\n    const successes = otherResults.filter(r => r.total >= dc).length;\n    const failures = otherResults.filter(r => r.total < dc).length;\n    const adjustedResult = leaderResult.total + successes - failures;\n    \n    return {\n      finalResult: adjustedResult,\n      leaderRoll: leaderResult.total,\n      leaderName: actors.find(a => a.id === leaderActorId)?.name,\n      leaderModifier,\n      bonus: successes,\n      penalty: failures,\n      success: adjustedResult >= dc,\n      summary: game.i18n.format(\"FLASH_ROLLS.groupRoll.leaderWithHelp.summary\", {\n        leaderRoll: leaderResult.total,\n        bonus: successes,\n        penalty: failures,\n        adjustedResult,\n        dc\n      }),\n      method: 'Leader with Help'\n    };\n  },\n\n  /**\n   * Calculate group roll result using Weakest Link - Result from actor with lowest modifier, plus number of group successes\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total }\n   * @param {number} dc - The DC to check against\n   * @param {Actor[]} actors - Array of actors to get modifiers from\n   * @param {string} rollType - Type of roll (skill, save, ability)\n   * @param {string} rollKey - The specific roll key (e.g., 'ath', 'dex')\n   * @returns {Object} Result object with { finalResult, weakestRoll, bonus, success, summary }\n   */\n  calculateWeakestLink(rollResults, dc, actors, rollType, rollKey) {\n    let lowestModifier = 999;\n    let weakestActorId = null;\n    let weakestModifierValue = 0;\n    \n    for (const actor of actors) {\n      const modifier = this._getActorModifier(actor, rollType, rollKey);\n      if (modifier < lowestModifier) {\n        lowestModifier = modifier;\n        weakestActorId = actor.id;\n        weakestModifierValue = modifier;\n      }\n    }\n    \n    const weakestResult = rollResults.find(r => r.actorId === weakestActorId);\n    if (!weakestResult) {\n      return {\n        finalResult: 0,\n        error: 'Weakest link actor did not roll',\n        method: 'Weakest Link'\n      };\n    }\n    \n    // Count successes excluding the weakest actor\n    const successes = rollResults.filter(r => r.actorId !== weakestActorId && r.total >= dc).length;\n    const adjustedResult = weakestResult.total + successes;\n    \n    const successWord = successes === 1 ? \n      game.i18n.localize(\"FLASH_ROLLS.groupRoll.weakestLink.successSingular\") : \n      game.i18n.localize(\"FLASH_ROLLS.groupRoll.weakestLink.successPlural\");\n    \n    return {\n      finalResult: adjustedResult,\n      weakestRoll: weakestResult.total,\n      weakestName: actors.find(a => a.id === weakestActorId)?.name,\n      weakestModifier: weakestModifierValue,\n      bonus: successes,\n      success: adjustedResult >= dc,\n      summary: game.i18n.format(\"FLASH_ROLLS.groupRoll.weakestLink.summary\", {\n        weakestRoll: weakestResult.total,\n        bonus: successes,\n        successWord,\n        adjustedResult,\n        dc\n      }),\n      method: 'Weakest Link'\n    };\n  },\n\n  /**\n   * Get the modifier for a specific roll type and key from an actor\n   * @private\n   * @param {Actor} actor - The actor to get the modifier from\n   * @param {string} rollType - Type of roll (skill, save, ability)\n   * @param {string} rollKey - The specific roll key\n   * @returns {number} The modifier value\n   */\n  _getActorModifier(actor, rollType, rollKey) {\n    const normalizedType = rollType?.toLowerCase();\n    \n    switch (normalizedType) {\n      case ROLL_TYPES.SKILL:\n        return actor.system.skills[rollKey]?.total || \n               actor.system.skills[rollKey]?.mod || 0;\n      \n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n        // Support both old and new D&D 5e data structure\n        return actor.system.abilities[rollKey]?.save?.value || \n               actor.system.abilities[rollKey]?.save || 0;\n      \n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        return actor.system.abilities[rollKey]?.mod || 0;\n      \n      case ROLL_TYPES.TOOL:\n        if (actor.system.tools?.[rollKey]) {\n          return actor.system.tools[rollKey].total || \n                 actor.system.tools[rollKey].mod || 0;\n        }\n        const tool = actor.items.find(i => \n          i.type === 'tool' && \n          i.system.toolType === rollKey\n        );\n        return tool?.system.bonus || 0;\n      \n      default:\n        return 0;\n    }\n  },\n\n  /**\n   * Get the group roll result based on the selected calculation method\n   * @param {Object[]} rollResults - Array of roll results with { actorId, total }\n   * @param {number} dc - The DC to check against\n   * @param {Actor[]} actors - Array of actors (needed for some methods)\n   * @param {string} rollType - Type of roll (needed for modifier calculation)\n   * @param {string} rollKey - The specific roll key (needed for modifier calculation)\n   * @returns {Object} Result object with { complete, success, result }\n   */\n  getGroupResult(rollResults, dc, actors, rollType, rollKey) {\n    const complete = rollResults.every(r => r.total !== null && r.total !== undefined);\n    \n    if (!complete) {\n      return {\n        complete: false,\n        success: false,\n        result: 0\n      };\n    }\n\n    const SETTINGS = getSettings();\n    const resultMode = SettingsUtil.get(SETTINGS.groupRollResultMode.tag) || 1;\n    \n    let calculationResult;\n    \n    switch (resultMode) {\n      case 1: // Standard Rule\n        calculationResult = this.calculateStandardRule(rollResults, dc);\n        return {\n          complete: true,\n          success: calculationResult.finalResult,\n          result: calculationResult.finalResult ? 1 : 0,\n          details: calculationResult\n        };\n        \n      case 2: // Group Average\n        calculationResult = this.calculateGroupAverage(rollResults, dc);\n        return {\n          complete: true,\n          success: calculationResult.success,\n          result: calculationResult.finalResult,\n          details: calculationResult\n        };\n        \n      case 3: // Leader with Help\n        calculationResult = this.calculateLeaderWithHelp(rollResults, dc, actors, rollType, rollKey);\n        return {\n          complete: true,\n          success: calculationResult.success,\n          result: calculationResult.finalResult,\n          details: calculationResult\n        };\n        \n      case 4: // Weakest Link\n        calculationResult = this.calculateWeakestLink(rollResults, dc, actors, rollType, rollKey);\n        return {\n          complete: true,\n          success: calculationResult.success,\n          result: calculationResult.finalResult,\n          details: calculationResult\n        };\n        \n      default:\n        calculationResult = this.calculateStandardRule(rollResults, dc);\n        return {\n          complete: true,\n          success: calculationResult.finalResult,\n          result: calculationResult.finalResult ? 1 : 0,\n          details: calculationResult\n        };\n    }\n  }\n};\n\n","import { LogUtil } from \"../../LogUtil.mjs\";\nimport { MODULE_ID, ROLL_TYPES } from \"../../../constants/General.mjs\";\nimport { getSettings } from \"../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../helpers/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\n\n/**\n * GM Roll Configuration Dialog\n * Extends the standard D&D5e roll configuration dialogs to add DC field and send request toggle\n */\nexport class GMRollConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.D20RollConfigurationDialog) {\n  /**\n   * Create a new GM Roll Configuration Dialog.\n   * @param {BasicRollProcessConfiguration} [config={}] - Process configuration containing rolls array of BasicRollConfiguration objects.\n   * @param {BasicRollMessageConfiguration} [message={}] - Message configuration for chat output.\n   * @param {BasicRollConfigurationDialogOptions} [options={}] - Dialog rendering options.\n   * @param {Actor[]} [options.actors] - Array of actors this roll is being made for.\n   * @param {boolean} [options.sendRequest] - Whether to send this as a roll request to players.\n   * @param {boolean} [options.showDC] - Whether to show the DC input field.\n   * @param {string} [options.rollKey] - The specific roll key (e.g., \"str\" for strength save).\n   * @param {typeof BasicRoll} [options.rollType] - The roll class to use (D20Roll, DamageRoll, etc.).\n   * @param {string} [options.rollTypeString] - The roll type as a string for identification.\n   * @param {object} [options.window] - Window configuration options.\n   * @param {string} [options.window.title] - The window title.\n   * @param {string} [options.window.subtitle] - The window subtitle.\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    options.rollType = options.rollType || CONFIG.Dice.D20Roll;\n    super(config, message, options);\n    \n    LogUtil.log('constructor - initializing GM Dialog', [config, message, options]);\n  }\n  \n  /**\n   * Default rendering options for the GM roll configuration dialog.\n   * Extends the parent's default options to add custom CSS classes.\n   * @returns {object} The default options object.\n   * @override\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Get the window title for the dialog.\n   * Uses the window title from options if provided, otherwise falls back to parent implementation.\n   * The parent class constructs the title from options.window.title or uses a default localized string.\n   * @returns {string} The localized window title\n   * @override\n   */\n  get title() {\n    return this.windowTitle || super.title;\n  }\n  \n  /**\n   * Prepare the configuration data for rendering the dialog.\n   * This method is called internally by the parent class during rendering.\n   * Extends parent to add DC and send request options. The parent method prepares\n   * advantage/disadvantage toggles, roll mode selector, and situational bonus field.\n   * @param {BasicRoll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration containing rolls array\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration with rendering options\n   * @param {BasicRollMessageConfiguration} message - Message configuration for chat output\n   * @returns {Object} The prepared configuration data for rendering with added fields:\n   *   - showDC: Whether to display the DC input field\n   *   - dcValue: The current DC value if set\n   *   - sendRequest: Whether rolls should be sent to players\n   *   - actorCount: Number of actors this roll applies to\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('_prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    data.showDC = this.showDC;\n    data.dcValue = this.dcValue;\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare the rendering context for a specific dialog part.\n   * Adds GM-specific data like DC value and send request option to the configuration part.\n   * The parent method builds the base context for each part (\"configuration\", \"formulas\", \"buttons\").\n   * @param {string} partId - The ID of the part being prepared (\"configuration\", \"formulas\", \"buttons\")\n   * @param {ApplicationRenderContext} context - The rendering context to modify\n   * @param {HandlebarsRenderOptions} options - Options which configure application rendering behavior\n   * @returns {Promise<ApplicationRenderContext>} The modified context with GM-specific data added to configuration part:\n   *   - showDC: Whether to display the DC input field\n   *   - dcValue: The current DC value if set\n   *   - sendRequest: Whether rolls should be sent to players\n   *   - actorCount: Number of actors this roll applies to\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    LogUtil.log('_preparePartContext', [partId, context, options]);\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.showDC = this.showDC;\n      context.dcValue = this.dcValue;\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render actions for the dialog.\n   * Injects custom GM fields (DC input, send request checkbox) into the dialog after rendering.\n   * Also attaches event listeners and triggers initial formula rebuild if needed.\n   * @param {ApplicationRenderContext} context - The render context.\n   * @param {HandlebarsRenderOptions} options - Rendering options.\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    LogUtil.log('_onRender', [context, options]);\n    super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && (this.showDC || this.actors.length > 0)) {\n      const templateData = {\n        showDC: this.showDC,\n        dcValue: this.dcValue,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n    \n    this._attachButtonListeners();\n  }\n  \n  /**\n   * Attach listeners to advantage/disadvantage buttons.\n   * Sets up click handlers for the advantage mode toggle buttons.\n   * Currently logs the action but does not implement custom behavior.\n   * @private\n   */\n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', [this.element]);\n    const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    buttons.forEach(button => {\n      button.addEventListener('click', (event) => {\n        const action = event.currentTarget.dataset.action;\n      });\n    });\n  }\n  \n  \n  /**\n   * Static method to create and display the GM roll configuration dialog.\n   * Creates a BasicRollProcessConfiguration and shows dialog for user configuration.\n   * @param {Actor[]|string[]} actors - Array of Actor documents or actor IDs to roll for\n   * @param {string} rollType - The type of roll (e.g., \"save\", \"ability\", \"skill\", \"tool\")\n   * @param {string} rollKey - The specific roll key (e.g., \"str\" for strength, \"athletics\" for skill)\n   * @param {Object} options - Additional options for dialog configuration\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {number} [options.dcValue] - Initial DC value\n   * @param {boolean} [options.advantage] - Whether to roll with advantage\n   * @param {boolean} [options.disadvantage] - Whether to roll with disadvantage\n   * @param {string} [options.rollMode] - Roll visibility mode\n   * @param {string} [options.situational] - Situational bonus formula\n   * @returns {Promise<BasicRollProcessConfiguration|null>} Process configuration with rolls array, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}) {\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMRollConfigDialog, initConfiguration', []);\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn);\n    \n    const showDC = RollHelpers.shouldShowDC(normalizedRollType);\n    const rollClass = RollHelpers.getRollClass(normalizedRollType);\n    const rollConfig = RollHelpers.createBaseRollConfig(actor, rollType, rollKey);\n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        showDC,\n        rollKey,\n        rollType: rollClass,  // Set the roll type class here\n        rollTypeString: normalizedRollType,  // Store the roll type string\n        window: {\n          title: GMRollConfigDialog._getRollTitle(normalizedRollType, rollKey, actor),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        position: {\n          width: 420,\n          height: \"auto\"\n        },\n        ...options\n      }\n    };\n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    \n    const rollProcessConfig = RollHelpers.processDialogResult(result, actors, rollType, rollKey, options);\n    if (!rollProcessConfig) return null;\n    \n    if (result.config?.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      const defaultAbility = actor.system.skills?.[rollKey]?.ability || CONFIG.DND5E.skills?.[rollKey]?.ability;\n      if (result.config.ability !== defaultAbility) {\n        rollProcessConfig.ability = result.config.ability;\n      }\n    }\n    \n    let finalTitle = dialogConfig.options.window.title;\n    if (result.config.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      const selectedAbilityLabel = CONFIG.DND5E.abilities[result.config.ability]?.label || result.config.ability;\n      if (normalizedRollType === ROLL_TYPES.SKILL) {\n        const skillLabel = CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n        finalTitle = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n          skill: skillLabel,\n          ability: selectedAbilityLabel \n        });\n      } else if (normalizedRollType === ROLL_TYPES.TOOL) {\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        let toolLabel = rollKey;\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          toolLabel = toolItem?.name || rollKey;\n        }\n        finalTitle = game.i18n.format(\"DND5E.ToolPromptTitle\", { \n          tool: toolLabel,\n          ability: selectedAbilityLabel \n        });\n      }\n    }\n    \n    rollProcessConfig.rollTitle = finalTitle;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    return rollProcessConfig;\n  }\n  \n  /**\n   * Get a formatted title for the roll type\n   * @private\n   * @param {string} rollType - The type of roll\n   * @param {string} rollKey - The specific roll key\n   * @param {Actor} actor - The actor (used to get default ability for skills)\n   * @returns {string} The formatted title\n   */\n  static _getRollTitle(rollType, rollKey, actor) {\n    let title = \"\";\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    if ([ROLL_TYPES.SAVE, ROLL_TYPES.ABILITY, ROLL_TYPES.ABILITY_CHECK].includes(normalizedRollType) && !rollKey) {\n      LogUtil.warn('Missing rollKey for roll type', [normalizedRollType, rollKey]);\n    }\n    \n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        const skillLabel = CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n        const skill = actor?.system.skills?.[rollKey];\n        const defaultAbility = skill?.ability || CONFIG.DND5E.skills[rollKey]?.ability || 'int';\n        const abilityLabel = CONFIG.DND5E.abilities[defaultAbility]?.label || defaultAbility;\n        title = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n          skill: skillLabel,\n          ability: abilityLabel \n        });\n        break;\n      case ROLL_TYPES.SAVE:\n      case ROLL_TYPES.SAVING_THROW:\n        const saveAbility = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        title = game.i18n.format(\"DND5E.SavePromptTitle\", { ability: saveAbility });\n        break;\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.ABILITY_CHECK:\n        const checkAbility = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        title = game.i18n.format(\"DND5E.AbilityPromptTitle\", { ability: checkAbility });\n        break;\n      case ROLL_TYPES.CONCENTRATION:\n        title = game.i18n.localize(\"DND5E.Concentration\");\n        break;\n      case ROLL_TYPES.TOOL:\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        let toolLabel = rollKey;\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          toolLabel = toolItem?.name || rollKey;\n        }\n        const tool = actor?.system.tools?.[rollKey];\n        const toolDefaultAbility = tool?.ability || CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey]?.ability || 'int';\n        const toolAbilityLabel = CONFIG.DND5E.abilities[toolDefaultAbility]?.label || toolDefaultAbility;\n        title = game.i18n.format(\"DND5E.ToolPromptTitle\", { \n          tool: toolLabel,\n          ability: toolAbilityLabel\n        });\n        break;\n      case ROLL_TYPES.DEATH_SAVE:\n        title = game.i18n.localize(\"DND5E.DeathSave\");\n        break;\n      case ROLL_TYPES.INITIATIVE: \n      case ROLL_TYPES.INITIATIVE_DIALOG: // Handle alternate case\n        title = game.i18n.localize(\"DND5E.Initiative\");\n        break;\n      default:\n        title = game.i18n.localize(\"DND5E.Roll\");\n    }\n    LogUtil.log('_getRollTitle', [normalizedRollType, title]);\n    \n    return title;\n  }\n\n  static _getSubtitle(actors = []) {\n    if (actors.length === 1) {\n      return actors[0].name;\n    } else if (actors.length > 1) {\n      return game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.multipleActors\");\n    } else {\n      return \"\";\n    }\n  }\n}","import { LogUtil } from \"../../LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../constants/General.mjs\";\nimport { getSettings } from \"../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../helpers/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\n\n/**\n * GM Hit Die Configuration Dialog\n * Extends base RollConfigurationDialog for hit die rolls\n * @extends {dnd5e.applications.dice.RollConfigurationDialog}\n */\nexport class GMHitDieConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.RollConfigurationDialog) {\n  /**\n   * Creates an instance of GMHitDieConfigDialog.\n   * Configures the dialog for hit die rolls with GM-specific options.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration\n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    options.rollType = CONFIG.Dice.BasicRoll || Roll;\n    options.showDC = false;\n    \n    super(config, message, options);\n    \n    LogUtil.log('constructor', [config, message, options]);\n  }\n  \n  /**\n   * Get default options for the hit die dialog.\n   * Extends parent options to add hit die specific CSS classes.\n   * @returns {Object} Default dialog options with \"hit-die-config\" class added\n   * @static\n   * @override\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\", \"hit-die-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * Overrides the formula display to show \"Hit Die (varies by actor)\" since\n   * different actors may have different hit die sizes.\n   * @param {BasicRoll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with custom formula display\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    LogUtil.log('GMHitDieConfigDialog._prepareConfigurationData', [data]);\n    \n    data.formula = \"Hit Die (varies by actor)\";\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare context for rendering specific dialog parts.\n   * Adds send request toggle and actor count to the configuration part.\n   * @param {string} partId - The part ID being rendered\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<ApplicationRenderContext>} Modified context\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n      context.formula = \"Hit Die (varies by actor)\";\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render tasks for the dialog.\n   * Injects the send request toggle field for GM control.\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n    \n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && this.actors.length > 0) {\n      const templateData = {\n        showDC: false,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n  }\n  \n  /**\n   * Process form submission data.\n   * Extracts and stores send request preference from the form.\n   * @param {SubmitEvent} event - The submission event\n   * @param {HTMLFormElement} form - The form element\n   * @param {FormDataExtended} formData - Processed form data\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _processSubmitData(event, form, formData) {\n    await super._processSubmitData(event, form, formData);\n    this.sendRequest = formData.get(\"flash5e-send-request\") !== \"false\";\n    \n    LogUtil.log('_processSubmitData', [formData, this.config]);\n  }\n  \n  /**\n   * Finalize rolls based on the action button clicked.\n   * Stores the send request flag in the configuration.\n   * For hit die rolls, merge situational bonuses into the main formula.\n   * @param {string} action - The action button clicked\n   * @returns {BasicRoll[]} Array of finalized rolls\n   * @protected\n   * @override\n   */\n  _finalizeRolls(action) {\n    const finalizedRolls = super._finalizeRolls(action);\n    this.config.sendRequest = this.sendRequest;\n\n    return finalizedRolls;\n  }\n  \n  /**\n   * Static method to create and display the hit die configuration dialog.\n   * Creates appropriate hit die formulas based on each actor's available hit dice.\n   * @param {Actor[]} actors - Array of actors to roll hit dice for\n   * @param {string} rollType - The roll type (should be \"hitdie\")\n   * @param {string} rollKey - Not used for hit die rolls\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @returns {Promise<Object|null>} Configuration with rolls array and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}) {\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMHitDieConfigDialog, initConfiguration', []);\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn);\n    \n    const rollConfig = {\n      data: actor.getRollData(),\n      subject: actor,\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {\n          flavor: \"Hit Die Roll\"\n        }\n      }]\n    };\n    \n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        rollKey,\n        rollType: CONFIG.Dice.BasicRoll || Roll,\n        window: {\n          title: game.i18n.localize(\"DND5E.HitDice\"),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        position: {\n          width: 420,\n          height: \"auto\"\n        },\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    LogUtil.log('GMHitDieConfigDialog - dialog result', [result.rolls]);\n    \n    const rollProcessConfig = RollHelpers.processDialogResult(result, actors, rollType, rollKey, options);\n    if (!rollProcessConfig) return null;\n    \n    if (result.config?.ability) {\n      rollProcessConfig.ability = result.config.ability;\n    }\n    \n    return rollProcessConfig;\n  }\n}","import { LogUtil } from \"../../LogUtil.mjs\";\nimport { MODULE_ID, ROLL_TYPES } from \"../../../constants/General.mjs\";\nimport { getSettings } from \"../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../helpers/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\n\n/**\n * GM Skill/Tool Configuration Dialog\n * Extends SkillToolRollConfigurationDialog for ability selection\n * @extends {dnd5e.applications.dice.SkillToolRollConfigurationDialog}\n */\nexport class GMSkillToolConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.SkillToolRollConfigurationDialog) {\n  /**\n   * Creates an instance of GMSkillToolConfigDialog.\n   * Forces ability selection and adds GM-specific options.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration  \n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   *   @param {boolean} [options.showDC=false] - Whether to show DC field\n   *   @param {number} [options.dcValue] - Initial DC value\n   *   @param {string} [options.rollKey] - The skill/tool key being rolled\n   *   @param {string} [options.rollTypeString] - Display name for the roll type\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    const skillConfig = foundry.utils.mergeObject(config, {\n      chooseAbility: true\n    });\n    options.rollType = options.rollType || CONFIG.Dice.D20Roll;\n    super(skillConfig, message, options);\n    \n    LogUtil.log('constructor', [config, message, options]);\n  }\n  \n  /**\n   * @inheritDoc\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * Extends parent to add DC and send request options.\n   * The parent handles ability selection UI for skills and tools.\n   * @param {D20Roll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with GM-specific fields added\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('_prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    // GM-specific data\n    data.showDC = this.showDC;\n    data.dcValue = this.dcValue;\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare context for rendering specific dialog parts.\n   * Adds GM-specific context data to the configuration part.\n   * @param {string} partId - The part ID being rendered\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<ApplicationRenderContext>} Modified context\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    LogUtil.log('_preparePartContext', [partId, context, options]);\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.showDC = this.showDC;\n      context.dcValue = this.dcValue;\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render tasks for the dialog.\n   * Injects GM-specific form fields (DC and send request toggle).\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    LogUtil.log('_onRender', [context, options]);\n    super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n\n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n\n    if (configSection && (this.showDC || this.actors.length > 0)) {\n      const templateData = {\n        showDC: this.showDC,\n        dcValue: this.dcValue,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n    \n    this._attachButtonListeners();\n  }\n  \n  /**\n   * Attach listeners to advantage/disadvantage buttons.\n   * Sets up click handlers for the advantage mode toggle buttons.\n   * Currently logs the action but does not implement custom behavior.\n   * @private\n   */\n  _attachButtonListeners() {\n    LogUtil.log('_attachButtonListeners', []);\n\n    const buttons = this.element.querySelectorAll('[data-action=\"advantage\"], [data-action=\"normal\"], [data-action=\"disadvantage\"]');\n    buttons.forEach(button => {\n      button.addEventListener('click', (event) => {\n        const action = event.currentTarget.dataset.action;\n      });\n    });\n  }\n  \n  /**\n   * Static method to create and display the skill/tool configuration dialog.\n   * Handles ability selection for skills and tools with GM-specific options.\n   * @param {Actor[]} actors - Array of actors to roll for\n   * @param {string} rollType - The roll type (\"skill\" or \"tool\")\n   * @param {string} rollKey - The specific skill/tool key (e.g., \"athletics\", \"thieves\")\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {number} [options.dcValue] - Initial DC value\n   * @param {string} [options.ability] - Override ability selection\n   * @returns {Promise<Object|null>} Configuration with rolls array, ability selection, and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}) {\n    // Validate and normalize actors\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMSkillToolConfigDialog, initConfiguration', []);\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn);\n    \n    const showDC = RollHelpers.shouldShowDC(normalizedRollType);\n    const rollClass = CONFIG.Dice.D20Roll;\n    \n    let defaultAbility = null;\n    if (normalizedRollType === ROLL_TYPES.SKILL) {\n      const skill = actor.system.skills[rollKey];\n      defaultAbility = skill?.ability || CONFIG.DND5E.skills[rollKey]?.ability || 'int';\n    } else if (normalizedRollType === ROLL_TYPES.TOOL) {\n      const tool = actor.system.tools?.[rollKey];\n      defaultAbility = tool?.ability || CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey]?.ability || 'int';\n    }\n    \n    const rollConfig = {\n      data: actor.getRollData(),\n      subject: actor,\n      ability: defaultAbility,\n      chooseAbility: true,\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n    \n    if (normalizedRollType === ROLL_TYPES.SKILL) {\n      rollConfig.skill = rollKey;\n    } else if (normalizedRollType === ROLL_TYPES.TOOL) {\n      rollConfig.tool = rollKey;\n    }\n    \n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        showDC,\n        rollKey,\n        rollType: rollClass,  // Set the roll type class here\n        rollTypeString: normalizedRollType,\n        window: {\n          title: GMRollConfigDialog._getRollTitle(normalizedRollType, rollKey, actor),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        position: {\n          width: 420,\n          height: \"auto\"\n        },\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    \n    const rollProcessConfig = RollHelpers.processDialogResult(result, actors, rollType, rollKey, options);\n    if (!rollProcessConfig) return null;\n    \n    if (result.config?.ability && [ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      rollProcessConfig.ability = result.config.ability;\n    }\n    \n    rollProcessConfig.rollTitle = dialogConfig.options.window.title;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    return rollProcessConfig;\n  }\n}","import { LogUtil } from \"../../LogUtil.mjs\";\nimport { getSettings } from \"../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../helpers/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\n\n/**\n * GM Damage Roll Configuration Dialog\n * Extends DamageRollConfigurationDialog to add send request toggle\n * @extends {dnd5e.applications.dice.DamageRollConfigurationDialog}\n */\nexport class GMDamageConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.DamageRollConfigurationDialog) {\n  /**\n   * Creates an instance of GMDamageConfigDialog.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration  \n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    // Ensure the dialog is configured to show\n    const dialogConfig = foundry.utils.mergeObject({\n      configure: true\n    }, config);\n    \n    super(dialogConfig, message, options);\n    \n    LogUtil.log('GMDamageConfigDialog.constructor', [dialogConfig, message, options]);\n  }\n  \n  /**\n   * @inheritDoc\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"damage-roll\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * @param {DamageRoll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with GM-specific fields added\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('GMDamageConfigDialog._prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    // Add GM-specific data\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  \n  /**\n   * Handle initial rendering of the dialog.\n   * @param {ApplicationRenderContext} context - The render context.\n   * @param {HandlebarsRenderOptions} options - Rendering options.\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    await super._onRender(context, options);\n    \n    // Prevent dialog flicker\n    GeneralUtil.preventDialogFlicker(this.element);\n    \n    // Inject send request checkbox if we have actors\n    if (this.actors.length > 0) {\n      const buttonGroup = this.element.querySelector('.rolls + .dialog-buttons');\n      if (buttonGroup && !this.element.querySelector('.gm-roll-config-fields')) {\n        const wrapper = document.createElement('div');\n        wrapper.className = 'gm-roll-config-fields';\n        wrapper.innerHTML = `\n          <div class=\"form-group\">\n            <label class=\"checkbox\">\n              <input type=\"checkbox\" name=\"flash5e-send-request\" ${this.sendRequest ? 'checked' : ''}>\n              ${game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.sendRequestToPlayers\")}\n            </label>\n          </div>\n        `;\n        buttonGroup.insertAdjacentElement('beforebegin', wrapper);\n      }\n    }\n  }\n\n  /**\n   * Static method to create and display the attack configuration dialog.\n   * SIMPLIFIED VERSION: Matches ability check pattern without attack-specific configs\n   * @param {Actor[]} actors - Array of actors to roll for\n   * @param {string} rollType - The roll type (\"attack\")\n   * @param {string} rollKey - The item ID for the attack\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {Object} originalConfig - The original roll configuration from the intercepted roll\n   * @param {Object} originalDialog - The original dialog configuration from the intercepted roll\n   * @returns {Promise<Object|null>} Configuration with rolls array and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}, originalConfig = {}, originalDialog = {}) {\n    actors = RollHelpers.validateActors(actors);\n    LogUtil.log('GMDamageConfigDialog, initConfiguration actors', [actors]);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn, originalConfig.rollMode);\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    const rollConfig = {\n      subject: originalConfig.subject || actor, \n      data: actor.getRollData(),\n      critical: originalConfig.critical || {},\n      rolls: originalConfig.rolls || [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n    LogUtil.log('GMDamageConfigDialog, initConfiguration #1', [rollConfig]);\n    \n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    LogUtil.log('GMDamageConfigDialog, initConfiguration #2', [messageConfig]);\n    \n    const { position, ...dialogOptions } = originalDialog?.options || {}; \n    \n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        rollKey,\n        rollType: CONFIG.Dice.DamageRoll,\n        rollTypeString: normalizedRollType,\n        window: {\n          title: game.i18n.localize(\"DND5E.DamageRoll\"),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        ...dialogOptions,\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    \n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    const firstRoll = result.rolls[0];\n    \n    const situational = firstRoll?.data?.situational || \"\";\n    const target = firstRoll?.options?.target;\n    \n    const rollProcessConfig = {\n      rolls: [{\n        parts: [],\n        data: situational ? { situational } : {},\n        options: {\n          ...(target && { target }),\n          isCritical: firstRoll?.options?.isCritical || firstRoll?.isCritical || false\n        }\n      }],\n      subject: originalConfig.subject || actor,\n      target,\n      isCritical: firstRoll?.options?.isCritical || firstRoll?.isCritical || false,\n      sendRequest: result.sendRequest,\n      isRollRequest: result.sendRequest,\n      skipRollDialog: options.skipRollDialog || false,\n      chatMessage: true\n    };\n    LogUtil.log('GMDamageConfigDialog, initConfiguration #6', [rollProcessConfig]); \n    \n    const finalRollMode = RollHelpers.determineRollMode(isPublicRollsOn, result.message?.rollMode);\n    rollProcessConfig.rollMode = finalRollMode;\n    \n    rollProcessConfig.rollTitle = dialogConfig.options.window.title;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    LogUtil.log('GMDamageConfigDialog, initConfiguration - result', [rollProcessConfig]);\n    \n    return rollProcessConfig;\n  }\n}","import { LogUtil } from \"../../LogUtil.mjs\";\nimport { MODULE_ID } from \"../../../constants/General.mjs\";\nimport { getSettings } from \"../../../constants/Settings.mjs\";\nimport { SettingsUtil } from \"../../SettingsUtil.mjs\";\nimport { GeneralUtil } from \"../../helpers/GeneralUtil.mjs\";\nimport { RollHelpers } from \"../../helpers/RollHelpers.mjs\";\nimport { GMRollConfigMixin } from \"./GMRollConfigMixin.mjs\";\nimport { GMRollConfigDialog } from \"./GMRollConfigDialog.mjs\";\n\n/**\n * GM Attack Roll Configuration Dialog\n * Extends AttackRollConfigurationDialog to add send request toggle\n * @extends {dnd5e.applications.dice.AttackRollConfigurationDialog}\n */\nexport class GMAttackConfigDialog extends GMRollConfigMixin(dnd5e.applications.dice.AttackRollConfigurationDialog) {\n  /**\n   * Creates an instance of GMAttackConfigDialog.\n   * @param {BasicRollProcessConfiguration} config - Roll configuration\n   * @param {BasicRollMessageConfiguration} message - Chat message configuration  \n   * @param {BasicRollConfigurationDialogOptions} options - Dialog options including:\n   *   @param {Actor[]} [options.actors=[]] - Array of actors being rolled for\n   *   @param {boolean} [options.sendRequest=true] - Whether to send roll to players by default\n   *   @param {boolean} [options.sendRequest] - Override for sendRequest default\n   */\n  constructor(config = {}, message = {}, options = {}) {\n    super(config, message, options);\n    \n    LogUtil.log('GMAttackConfigDialog.constructor', [config, message, options]);\n  }\n  \n  /**\n   * @inheritDoc\n   */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"dnd5e2\", \"roll-configuration\", \"gm-roll-config\"]\n    });\n  }\n  \n  /**\n   * Prepare configuration data for rendering.\n   * @param {D20Roll} roll - The roll being configured\n   * @param {BasicRollProcessConfiguration} config - Roll process configuration\n   * @param {BasicRollDialogConfiguration} dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} message - Message configuration\n   * @returns {Object} Configuration data with GM-specific fields added\n   * @protected\n   * @override\n   */\n  _prepareConfigurationData(roll, config, dialog, message) {\n    LogUtil.log('GMAttackConfigDialog._prepareConfigurationData', [roll, config, dialog, message]);\n    const data = super._prepareConfigurationData(roll, config, dialog, message);\n    \n    // Add GM-specific data\n    data.sendRequest = this.sendRequest;\n    data.actorCount = this.actors.length;\n    \n    return data;\n  }\n  \n  /**\n   * Prepare context for rendering specific dialog parts.\n   * @param {string} partId - The part ID being rendered\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<ApplicationRenderContext>} Modified context\n   * @protected\n   * @override\n   */\n  async _preparePartContext(partId, context, options) {\n    context = await super._preparePartContext(partId, context, options);\n    \n    if (partId === \"configuration\") {\n      context.sendRequest = this.sendRequest;\n      context.actorCount = this.actors.length;\n    }\n    \n    return context;\n  }\n  \n  /**\n   * Handle post-render tasks for the dialog.\n   * @param {ApplicationRenderContext} context - The render context\n   * @param {HandlebarsRenderOptions} options - Rendering options\n   * @returns {Promise<void>}\n   * @protected\n   * @override\n   */\n  async _onRender(context, options) {\n    await super._onRender(context, options);\n    \n    GeneralUtil.preventDialogFlicker(this.element);\n    \n    if (this.element.querySelector('.gm-roll-config-fields')) {\n      return;\n    }\n    \n    let configSection = this.element.querySelector('.rolls .formulas');\n    \n    if (configSection && this.actors.length > 0) {\n      const templateData = {\n        showDC: false,\n        showSendRequest: this.actors.length > 0,\n        sendRequest: this.sendRequest\n      };\n      \n      const template = await GeneralUtil.renderTemplate(`modules/${MODULE_ID}/templates/gm-roll-config-fields.hbs`, templateData);\n      \n      const wrapper = document.createElement('div');\n      wrapper.className = 'gm-roll-config-fields';\n      wrapper.innerHTML = template;\n      \n      configSection.parentNode.insertBefore(wrapper, configSection);\n    }\n  }\n  \n  /**\n   * Override _finalizeRolls to prevent re-rendering when sendRequest is toggled off\n   * @param {string} action - The action button clicked\n   * @returns {BasicRoll[]} Array of finalized rolls\n   * @protected\n   * @override\n   */\n  _finalizeRolls(action) {\n    this.config.sendRequest = this.sendRequest;\n    \n    if (!this.sendRequest && this.config.isRollRequest) {\n      this.config.isRollRequest = false;\n    }\n    \n    return super._finalizeRolls(action);\n  }\n  \n  /**\n   * Static method to create and display the attack configuration dialog.\n   * SIMPLIFIED VERSION: Matches ability check pattern without attack-specific configs\n   * @param {Actor[]} actors - Array of actors to roll for\n   * @param {string} rollType - The roll type (\"attack\")\n   * @param {string} rollKey - The item ID for the attack\n   * @param {Object} options - Additional options\n   * @param {boolean} [options.sendRequest=true] - Default state for send request toggle\n   * @param {Object} originalConfig - The original roll configuration from the intercepted roll\n   * @param {Object} originalDialog - The original dialog configuration from the intercepted roll\n   * @returns {Promise<Object|null>} Configuration with rolls array and sendRequest flag, or null if cancelled\n   * @static\n   */\n  static async initConfiguration(actors, rollType, rollKey, options = {}, originalConfig = {}, originalDialog = {}) {\n    // Validate and normalize actors\n    actors = RollHelpers.validateActors(actors);\n    if (!actors) return null;\n    \n    const actor = actors[0];\n    LogUtil.log('GMAttackConfigDialog, initConfiguration', []);\n    \n    const SETTINGS = getSettings();\n    const isPublicRollsOn = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag) === true;\n    \n    const normalizedRollType = rollType?.toLowerCase();\n    \n    const rollConfig = {\n      subject: originalConfig.subject || actor,\n      data: actor.getRollData(),\n      rolls: [{\n        parts: [],\n        data: actor.getRollData(),\n        options: {}\n      }]\n    };\n\n    const rollMode = RollHelpers.determineRollMode(isPublicRollsOn);\n    \n    const messageConfig = RollHelpers.createMessageConfig(actor, rollMode);\n    \n    const { position, ...dialogOptions } = originalDialog?.options || {};\n    const dialogConfig = {\n      options: {\n        actors,\n        sendRequest: actors.some(a => RollHelpers.isPlayerOwned(a)),\n        rollKey,\n        rollType: CONFIG.Dice.D20Roll,\n        rollTypeString: normalizedRollType,\n        window: {\n          title: game.i18n.localize(\"DND5E.Attack\"),\n          subtitle: GMRollConfigDialog._getSubtitle(actors)\n        },\n        ...dialogOptions,\n        ...options\n      }\n    };\n    \n    const result = await RollHelpers.triggerRollDialog(this, rollConfig, messageConfig, dialogConfig.options);\n    LogUtil.log('GMAttackConfigDialog, initConfiguration', [result?.sendRequest]);\n    \n    if (!result?.rolls || result.rolls.length === 0) return null;\n    \n    const firstRoll = result.rolls[0];\n    let advantage = false;\n    let disadvantage = false;\n    \n    if (firstRoll?.options?.advantageMode !== undefined) {\n      advantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE;\n      disadvantage = firstRoll.options.advantageMode === CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE;\n    }\n    \n    const situational = firstRoll?.data?.situational || \"\";\n    const target = firstRoll?.options?.target;\n    \n    const rollProcessConfig = {\n      rolls: [{\n        parts: [],\n        data: situational ? { situational } : {},\n        options: {\n          ...(target && { target }),\n          // Include attack-specific options from the roll\n          ...(firstRoll?.options?.ammunition && { ammunition: firstRoll.options.ammunition }),\n          ...(firstRoll?.options?.attackMode && { attackMode: firstRoll.options.attackMode }),\n          ...(firstRoll?.options?.mastery !== undefined && { mastery: firstRoll.options.mastery })\n        }\n      }],\n      subject: originalConfig.subject || actor,\n      advantage,\n      disadvantage,\n      target,\n      sendRequest: result.sendRequest,\n      isRollRequest: result.sendRequest,\n      skipDialog: options.skipDialogs || false,\n      chatMessage: !GeneralUtil.isModuleOn('midi-qol') || true\n    };\n    \n    const finalRollMode = RollHelpers.determineRollMode(isPublicRollsOn, result.message?.rollMode);\n    rollProcessConfig.rollMode = finalRollMode;\n    \n    rollProcessConfig.rollTitle = dialogConfig.options.window.title;\n    rollProcessConfig.rollType = normalizedRollType;\n    rollProcessConfig.rollKey = rollKey;\n    \n    LogUtil.log('GMAttackConfigDialog, initConfiguration - SIMPLIFIED result', [rollProcessConfig]);\n    \n    return rollProcessConfig;\n  }\n}","import { MODULE_ID } from \"../../constants/General.mjs\";\nimport { HooksUtil } from \"../HooksUtil.mjs\";\nimport { LogUtil } from \"../LogUtil.mjs\";\nimport { SettingsUtil } from \"../SettingsUtil.mjs\";\n\n/**\n * Helper functions for module management\n */\nexport class ModuleHelpers {\n  static midiTimeout = null;\n\n  /**\n   * Check if a module is installed and active\n   * @param {string} moduleId - The module ID to check\n   * @returns {boolean} - True if the module is installed and active\n   */\n  static isModuleActive(moduleId) {\n    const module = game.modules.get(moduleId);\n    return module && module.active;\n  }\n\n  /**\n   * Get the MidiQOL API if available\n   * @returns {Object|null} - The MidiQOL API or null if not available\n   */\n  static getMidiQOL() {\n    if (this.isModuleActive('midi-qol') && typeof MidiQOL !== 'undefined') {\n      return MidiQOL;\n    }\n    return null;\n  }\n\n  /**\n   * Set MidiQOL settings temporarily\n   * These settings are available as per MidiQOL docs\n   * lateTargeting: boolean to force enable/disable target confirmation for the items workflow\n   * autoRollAttack: boolean force enable/disable auto rolling of the attack,\n   * autoFastAttack: boolean force enable/disable fast forwarding of the attack\n   * autoRollDamage: string (always, onHit, none)\n   * autoFastDamage: boolean force enable/disable fastForward of the damage roll.\n   */\n  static async prepareMidiQOLSettings(){\n    let previousSettings = null;\n    LogUtil.log(\"prepareMidiQOLSettings #0\", [game.settings]);\n    \n    if(ModuleHelpers.isModuleActive(\"midi-qol\")){\n      LogUtil.log(\"prepareMidiQOLSettings #1\", [MidiQOL]);\n      previousSettings = {\n        autoFastForwardAbilityRolls: SettingsUtil.get(\"AutoFastForwardAbilityRolls\", \"midi-qol\"),\n        // configSettings: SettingsUtil.get(\"ConfigSettings\", \"midi-qol\")\n      }\n\n      clearTimeout(ModuleHelpers.midiTimeout);\n      ModuleHelpers.midiTimeout = setTimeout(() => {\n        if(previousSettings){\n          SettingsUtil.set(\"AutoFastForwardAbilityRolls\", previousSettings.autoFastForwardAbilityRolls, \"midi-qol\");\n          // SettingsUtil.set(\"ConfigSettings\", previousSettings.configSettings, \"midi-qol\");\n        }\n\n        LogUtil.log(\"prepareMidiQOLSettings #timeout 1\", [game.user.getFlag(MODULE_ID, 'savedMidiQOLSettings')]);\n        game.user.unsetFlag(MODULE_ID, 'savedMidiQOLSettings');\n        LogUtil.log(\"prepareMidiQOLSettings #timeout 2\", [game.user.getFlag(MODULE_ID, 'savedMidiQOLSettings')]);\n      }, 4000);\n\n      try{\n        LogUtil.log(\"prepareMidiQOLSettings #before\", [SettingsUtil.get(\"AutoFastForwardAbilityRolls\", \"midi-qol\")]);\n        await game.user.setFlag(MODULE_ID, 'savedMidiQOLSettings', previousSettings);\n        await SettingsUtil.set(\"AutoFastForwardAbilityRolls\", false, \"midi-qol\");\n        LogUtil.log(\"prepareMidiQOLSettings #after\", [SettingsUtil.get(\"AutoFastForwardAbilityRolls\", \"midi-qol\"), MidiQOL]);\n        // await SettingsUtil.set(\"ConfigSettings\", {\n        //   ...previousSettings.configSettings,\n        //   autoRollAttack: false,\n        //   autoRollDamage: false\n        // }, \"midi-qol\");\n      } catch(error){\n        LogUtil.error(\"prepareMidiQOLSettings\", [error]);\n      } finally {\n        LogUtil.log(\"prepareMidiQOLSettings - saved temporary settings for MidiQOL\", []);\n      }\n    }\n    return;\n  }\n\n\n}","import { LogUtil } from './LogUtil.mjs';\nimport { ROLL_TYPES, MODULE_ID, ACTIVITY_TYPES } from '../constants/General.mjs';\nimport { ModuleHelpers } from './helpers/ModuleHelpers.mjs';\n\n/**\n * @typedef {Object} ActivityUseConfiguration\n * @property {object|false} create\n * @property {boolean} create.measuredTemplate - Should this item create a template?\n * @property {object} concentration\n * @property {boolean} concentration.begin - Should this usage initiate concentration?\n * @property {string|null} concentration.end - ID of an active effect to end concentration on.\n * @property {object|false} consume\n * @property {boolean} consume.action - Should action economy be tracked? Currently only handles legendary actions.\n * @property {boolean|number[]} consume.resources - Set to `true` or `false` to enable or disable all resource\n *                                                   consumption or provide a list of consumption target indexes\n *                                                   to only enable those targets.\n * @property {boolean} consume.spellSlot - Should this spell consume a spell slot?\n * @property {Event} event - The browser event which triggered the item usage, if any.\n * @property {boolean|number} scaling - Number of steps above baseline to scale this usage, or `false` if\n *                                      scaling is not allowed.\n * @property {object} spell\n * @property {number} spell.slot - The spell slot to consume.\n * @property {boolean} [subsequentActions=true] - Trigger subsequent actions defined by this activity.\n * @property {object} [cause]\n * @property {string} [cause.activity] - Relative UUID to the activity that caused this one to be used.\n *                                       Activity must be on the same actor as this one.\n * @property {boolean|number[]} [cause.resources] - Control resource consumption on linked item.\n * @property {BasicRollConfiguration[]} [rolls] - Roll configurations for this activity\n */\n\n/**\n * Utility class for handling D&D5e 4.x activities\n */\nexport class ActivityUtil {\n  \n  /**\n   * Find the appropriate activity for a given roll type on an item\n   * @param {Item5e} item - The item to search for activities\n   * @param {string} rollType - The type of roll (attack, damage, itemSave)\n   * @returns {Activity5e|null} - The found activity or null\n   */\n  static findActivityForRoll(item, rollType) {\n    if (!item?.system?.activities) return null;\n    \n    const activities = item.system.activities;\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    switch (normalizedRollType) {\n      case ROLL_TYPES.ATTACK:\n        const attackActivities = activities.getByType(\"attack\");\n        return attackActivities?.[0] || null;\n        \n      case ROLL_TYPES.DAMAGE:\n        const damageAttackActivities = activities.getByType(\"attack\");\n        if (damageAttackActivities?.length > 0) return damageAttackActivities[0];\n        \n        const damageActivities = activities.getByType(\"damage\");\n        if (damageActivities?.length > 0) return damageActivities[0];\n        \n        const saveActivities = activities.getByType(\"save\");\n        if (saveActivities?.length > 0) return saveActivities[0];\n        \n        return null;\n        \n      case ROLL_TYPES.ITEM_SAVE:\n        const itemSaveActivities = activities.getByType(\"save\");\n        return itemSaveActivities?.[0] || null;\n        \n      default:\n        return null;\n    }\n  }\n  \n  /**\n   * Get all activities of a specific type from an item\n   * @param {Item5e} item - The item to search\n   * @param {string} activityType - The activity type (attack, damage, save, etc.)\n   * @returns {Activity5e[]} - Array of activities\n   */\n  static getActivitiesByType(item, activityType) {\n    if (!item?.system?.activities) return [];\n    return item.system.activities.getByType(activityType);\n  }\n  \n  /**\n   * Check if an item has activities suitable for a given roll type\n   * @param {Item5e} item - The item to check\n   * @param {string} rollType - The type of roll\n   * @returns {boolean} - Whether the item has suitable activities\n   */\n  static hasActivityForRoll(item, rollType) {\n    LogUtil.log('hasActivityForRoll', [item, rollType]);\n    return !!this.findActivityForRoll(item, rollType);\n  }\n  \n  /**\n   * Execute a roll using the appropriate activity method\n   * @param {Actor5e} actor - The actor performing the roll\n   * @param {string} rollType - The type of roll\n   * @param {string} itemId - The item ID\n   * @param {string} activityId - The activity ID (optional)\n   * @param {Object} config - Roll configuration\n   * @param {ActivityUseConfiguration} config.usage - Activity usage configuration\n   * @param {BasicRollDialogConfiguration} config.dialog - Dialog configuration\n   * @param {BasicRollMessageConfiguration} config.message - Message configuration\n   */\n  static async executeActivityRoll(actor, rollType, itemId, activityId, config) {\n    LogUtil.log('executeActivityRoll', [actor, rollType, itemId, activityId, config]);\n    const isMidiActive = ModuleHelpers.isModuleActive('midi-qol');\n    const item = actor.items.get(itemId);\n    if (!item) {\n      throw new Error(`Item ${itemId} not found on actor ${actor.name}`);\n    }\n    \n    let activity = null;\n    let damageConfig = null;\n    \n    // If activity ID provided, use it directly\n    if (activityId) {\n      activity = item.system.activities?.get(activityId);\n    }\n    activity = activity || this.findActivityForRoll(item, rollType);\n\n    if (!activity) {\n      throw new Error(`Activity not found on item ${item.name}`);\n    }\n    LogUtil.log('executeActivityRoll - activity', [activity, rollType]);\n    \n    // Normalize rollType to lowercase for consistent comparisons\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    // Execute the roll based on type\n    if (activity) {\n      switch (normalizedRollType) {\n        case ROLL_TYPES.ATTACK:\n          LogUtil.log('executeActivityRoll - is attack activity', [config]);\n          \n          // Workaround for _triggerSubsequentActions stripping off usage config\n          // Store request configuration in flags and retrieve in the preRollAttackV2 hook\n          const rollRequestConfig = {\n            attackMode: config.usage.attackMode,\n            ammunition: config.usage.ammunition,\n            mastery: config.usage.mastery,\n            situational: config.usage.rolls?.[0]?.data?.situational,\n            advantage: config.usage.advantage,\n            disadvantage: config.usage.disadvantage,\n            rollMode: config.message?.rollMode\n          };\n          await activity.item.setFlag(MODULE_ID, 'tempAttackConfig', rollRequestConfig);\n          \n          LogUtil.log('executeActivityRoll - stored temp config as flag', [rollRequestConfig]);\n          \n          try {\n            config.message.create = true;\n            await activity.use(config.usage, config.dialog, config.message);\n            LogUtil.log('FLASH_ROLLS TEST', [config]);\n            if(isMidiActive) {\n              const MidiQOL = ModuleHelpers.getMidiQOL();\n              if (MidiQOL) {\n                // const workflow = await ActivityUtil.syntheticItemRoll(item, {\n                //   ...config,\n                //   midiOptions: {\n                //     autoFastAttack: false,\n                //     autoFastDamage: false,\n                //     autoRollAttack: false,\n                //     autoRollDamage: false\n                //   }\n                // });\n                return\n              }\n            }\n          } catch (error) {\n            LogUtil.error('executeActivityRoll - attack roll error', [error]);\n          } finally {\n            // Only clean up the flag if we set it\n            await activity.item.unsetFlag(MODULE_ID, 'tempAttackConfig');\n          }\n          return;\n        case ROLL_TYPES.DAMAGE:\n          LogUtil.log('executeActivityRoll - damage roll', [activity, config]);\n          if(!isMidiActive) {\n            config.message.create = true;\n          }\n          // Extract the roll configuration from the usage config\n          damageConfig = {\n            critical: config.usage.critical || {},\n            situational: config.usage.rolls[0].data.situational || \"\",\n            rollMode: config.message?.rollMode,\n            create: config.message?.create !== false\n          };\n\n          if(activity.type === ACTIVITY_TYPES.SAVE || activity?.damageOnly){\n            await activity.use(config.usage, config.dialog, config.message);\n          }\n          await activity.item.setFlag(MODULE_ID, 'tempDamageConfig', damageConfig);\n          LogUtil.log('executeActivityRoll - damage config with situational', [damageConfig]);\n          \n          try {\n            if(isMidiActive) {\n              const MidiQOL = ModuleHelpers.getMidiQOL();\n              if (MidiQOL) {\n                const workflow = MidiQOL.Workflow?.getWorkflow(activity.uuid);\n                LogUtil.log('executeActivityRoll - workflow', [workflow]);\n                if(workflow){\n                  const damageRoll = await workflow.activity.rollDamage({\n                    ...config,\n                    workflow: workflow,\n                    // autoFastAttack: false,\n                    // autoFastDamage: false,\n                    // autoRollAttack: false,\n                    // autoRollDamage: false\n                  });\n                }\n                \n                // await activity.rollDamage(damageConfig, config.dialog, config.message);\n                return;\n              }\n            }else{\n              LogUtil.log('executeActivityRoll - damage roll', [activity, damageConfig, config]);\n              // if(activity?.previousAttack || activity?.damageOnly) {\n              await activity.rollDamage(damageConfig, config.dialog, config.message);\n              // }\n            }\n          } catch (error) {\n            LogUtil.error(['executeActivityRoll - damage roll error', error]);\n          } finally {\n            await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n          }\n          return;\n        // case ROLL_TYPES.ITEM_SAVE:\n        //   // if(ModuleHelpers.isModuleActive('midi-qol')) {\n        //   //   const MidiQOL = ModuleHelpers.getMidiQOL();\n        //   //   if (MidiQOL) {\n        //   //     const workflow = MidiQOL.Workflow?.getWorkflow(activity.uuid);\n        //   //     const damageRoll = await workflow.activity.rollDamage({\n        //   //       ...config,\n        //   //       workflow: workflow\n        //   //     });\n        //   //     return;\n        //   //   }\n        //   // }\n\n        //   // we need to check if the activity has a previous attack\n        //   // or if it is a damage only roll, like from a spell with save\n        //   LogUtil.log('executeActivityRoll - save damage roll', [activity, config]);\n          \n        //   // Extract the roll configuration from the usage config\n        //   damageConfig = {\n        //     critical: config.usage.critical || {},\n        //     situational: config.usage.rolls[0].data.situational || \"\",\n        //     rollMode: config.message?.rollMode,\n        //     create: config.message?.create !== false\n        //   };\n\n        //   await activity.item.setFlag(MODULE_ID, 'tempDamageConfig', damageConfig);\n        //   LogUtil.log('executeActivityRoll - savedamage config with situational', [damageConfig]);\n        //   try {\n        //     await activity.use(config.usage, config.dialog, {\n        //       ...config.message,\n        //       create: true\n        //     });\n        //     await activity.rollDamage(damageConfig, config.dialog, config.message);\n        //   } catch (error) {\n        //     LogUtil.error(['executeActivityRoll - save damage roll error', error]);\n        //   } finally {\n        //     await activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig');\n        //   }\n        //   return;\n        //   // // For save activities, use the item's use() method to show the save card\n        //   // return await item.use({ activity: activity.id }, { skipRollDialog: config.fastForward });\n        default:\n          LogUtil.log('executeActivityRoll - unknown roll type', [normalizedRollType]);\n          await activity.use(config.usage, config.dialog, config.message);\n          return;\n      }\n    }\n      \n    throw new Error(`No suitable method found for ${normalizedRollType} on item ${item.name}`);\n  }\n  \n  /**\n   * Get display information for an activity\n   * @param {Activity5e} activity - The activity\n   * @returns {Object} - Display information\n   */\n  static getActivityDisplayInfo(activity) {\n    LogUtil.log('getActivityDisplayInfo', [activity]);\n    if (!activity) return null;\n    \n    return {\n      name: activity.name || activity.constructor.metadata.label,\n      type: activity.type,\n      icon: activity.constructor.metadata.icon,\n      canAttack: activity.type === 'attack',\n      canDamage: ['attack', 'damage', 'save'].includes(activity.type),\n      canSave: activity.type === 'save'\n    };\n  }\n  \n  /**\n   * Get damage formula string from an activity\n   * @param {Activity5e} activity - The activity\n   * @returns {string|null} - Combined damage formula or null\n   */\n  static getDamageFormula(activity) {\n    LogUtil.log('getDamageFormula', [activity]);\n    if (!activity?.damage?.parts?.length) return null;\n    \n    // Extract all damage formulas and combine them\n    const formulas = activity.damage.parts.map(part => part.formula).filter(f => f);\n    return formulas.length > 0 ? formulas.join(' + ') : null;\n  }\n\n  static async syntheticItemRoll(item, config = {}) {\n    LogUtil.log('syntheticItemRoll', [item, config]);\n    \n    const MidiQOL = ModuleHelpers.getMidiQOL();\n    if (!MidiQOL) {\n      LogUtil.warn('MidiQOL is not active');\n      return;\n    }\n    \n    let defaultConfig = {\n        consumeUsage: false,\n        consumeSpellSlot: false\n    };\n    let defaultOptions = {\n      fastForward: false,\n      fastForwardAttack: false,\n      dialogOptions: {\n        fastForward: false,\n        fastForwardAttack: false,\n        // fastForwardDamage: false\n      },\n      // targetUuids: targets.map(i => i.document.uuid),\n      configureDialog: true,\n      // ignoreUserTargets: true,\n      workflowOptions: {\n        // autoRollAttack: false,\n        // autoFastAttack: false,\n        // autoRollDamage: 'none',\n        // autoFastDamage: false,\n        fastForward: false,\n        fastForwardAttack: false,\n        // fastForwardDamage: false\n      }\n    };\n\n    // options = genericUtils.mergeObject(defaultOptions, options);\n    config = {...defaultConfig, ...config};\n    return await MidiQOL.completeItemUse(item, config, defaultOptions);\n  }\n\n}","import { MODULE } from \"../../constants/General.mjs\";\nimport { LogUtil } from \"../LogUtil.mjs\";\n\n/**\n * Custom Roll Dialog - ApplicationV2 component for custom roll formulas\n */\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\nexport class CustomRollDialog extends HandlebarsApplicationMixin(ApplicationV2) {\n  constructor(options = {}) {\n    super(options);\n    this.formula = options.formula || \"\";\n    this.readonly = options.readonly || false;\n    this.actor = options.actor;\n    this.callback = options.callback;\n    this.diceCounts = {};\n  }\n\n  /**\n   * Default application configuration\n   */\n  static get DEFAULT_OPTIONS() {\n    return foundry.utils.mergeObject(super.DEFAULT_OPTIONS, {\n      id: \"flash5e-custom-roll-dialog\",\n      classes: [\"flash5e-dialog\", \"flash5e-custom-roll-dialog\"],\n      tag: \"div\",\n      window: {\n        title: \"FLASH_ROLLS.ui.dialogs.customRollTitle\",\n        icon: \"fas fa-dice-d20\",\n        resizable: false,\n        positioned: true,\n        frame: true\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      }\n    });\n  }\n  \n  /**\n   * Override to handle action clicks\n   */\n  _onClickAction(event, target) {\n    const action = target.dataset.action;\n    switch (action) {\n      case \"rollDice\":\n        return this.rollDice(event, target);\n      case \"addDie\":\n        return this.addDie(event, target);\n      case \"cancel\":\n        return this.cancel(event, target);\n    }\n  }\n\n  /**\n   * Prepare application rendering context\n   */\n  async _prepareContext(options = {}) {\n    const context = await super._prepareContext(options);\n    return {\n      ...context,\n      formula: this.formula,\n      readonly: this.readonly\n    };\n  }\n\n  /**\n   * Define template parts\n   */\n  static PARTS = {\n    main: {\n      template: `modules/${MODULE.ID}/templates/custom-roll-dialog.hbs`\n    },\n    footer: {\n      template: `modules/${MODULE.ID}/templates/custom-roll-dialog-footer.hbs`\n    }\n  };\n\n  /**\n   * Add event listeners\n   */\n  _attachPartListeners(partId, htmlElement, options) {\n    super._attachPartListeners(partId, htmlElement, options);\n    \n    const formulaInput = htmlElement.querySelector('#custom-roll-formula');\n    const validationMessage = htmlElement.querySelector('#formula-validation-message');\n    \n    if (formulaInput && !this.readonly) {\n      formulaInput.addEventListener('input', (event) => {\n        this.formula = event.target.value.trim();\n        this.updateValidationMessage(validationMessage);\n      });\n      \n      if (this.formula) {\n        this.updateValidationMessage(validationMessage);\n      }\n    }\n  }\n  \n  /**\n   * Update the validation message based on formula validity\n   * @param {HTMLElement} messageElement - The validation message element\n   */\n  updateValidationMessage(messageElement) {\n    if (!messageElement) return;\n    \n    if (!this.formula) {\n      messageElement.textContent = '&nbsp;';\n      messageElement.classList.remove('error', 'success');\n      return;\n    }\n    \n    const isValid = this.validateFormula(this.formula);\n    \n    if (isValid) {\n      messageElement.textContent = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.formulaValid\");\n      messageElement.classList.remove('error');\n      messageElement.classList.add('success');\n    } else {\n      messageElement.textContent = game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.formulaInvalid\");\n      messageElement.classList.remove('success');\n      messageElement.classList.add('error');\n    }\n  }\n\n  /**\n   * Handle dice button click\n   * @param {Event} event\n   * @param {HTMLElement} target\n   */\n  addDie(event, target) {\n    const die = target.dataset.die;\n    \n    const formulaInput = this.element.querySelector('#custom-roll-formula');\n    if (!formulaInput) return;\n    \n    const currentFormula = formulaInput.value.trim();\n    \n    if (currentFormula) {\n      const diceRegex = /(\\d*)d(\\d+)/g;\n      const diceMap = new Map();\n      \n      let remainingFormula = currentFormula;\n      let match;\n      \n      while ((match = diceRegex.exec(currentFormula)) !== null) {\n        const count = parseInt(match[1] || '1');\n        const dieType = match[2];\n        diceMap.set(dieType, (diceMap.get(dieType) || 0) + count);\n        remainingFormula = remainingFormula.replace(match[0], '').trim();\n      }\n      \n      // Add the new die\n      const newDieType = die.substring(1); // Remove 'd' prefix\n      diceMap.set(newDieType, (diceMap.get(newDieType) || 0) + 1);\n      \n      // Rebuild the formula\n      const diceParts = [];\n      for (const [dieType, count] of diceMap) {\n        diceParts.push(`${count}d${dieType}`);\n      }\n      \n      remainingFormula = remainingFormula.replace(/^\\+\\s*|\\s*\\+\\s*$|\\s*\\+\\s*\\+/g, '').trim();\n      \n      if (remainingFormula && remainingFormula !== '+') {\n        this.formula = `${diceParts.join(' + ')} + ${remainingFormula}`;\n      } else {\n        this.formula = diceParts.join(' + ');\n      }\n    } else {\n      this.formula = `1${die}`;\n    }\n    formulaInput.value = this.formula;\n    \n    formulaInput.dispatchEvent(new Event('input'));\n  }\n\n  /**\n   * Validate the formula using Roll.validate\n   * @param {string} formula\n   * @returns {boolean}\n   */\n  validateFormula(formula) {\n    if (!formula || formula.trim() === \"\") return false;\n    \n    try {\n      return Roll.validate(formula);\n    } catch (error) {\n      try {\n        new Roll(formula, this.actor?.getRollData() || {});\n        return true;\n      } catch (e) {\n        return false;\n      }\n    }\n  }\n\n  /**\n   * Handle roll button click\n   */\n  async rollDice() {\n    LogUtil.log('rollDice');\n    if (!this.validateFormula(this.formula)) {\n      ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.notifications.invalidFormula\", {\n        formula: this.formula || \"empty\"\n      }));\n      return;\n    }\n    \n    if (this.callback) {\n      await this.callback(this.formula);\n    }\n    \n    this.close();\n  }\n\n  /**\n   * Handle cancel button click\n   */\n  cancel() {\n    this.close();\n  }\n\n  /**\n   * Show the dialog and return a promise for the formula\n   * @param {Object} options\n   * @returns {Promise<string|null>}\n   */\n  static async prompt(options = {}) {\n    return new Promise((resolve) => {\n      const dialog = new this({\n        ...options,\n        callback: (formula) => resolve(formula)\n      });\n      \n      dialog.addEventListener(\"close\", () => {\n        if (!dialog._resolved) {\n          resolve(null);\n        }\n      });\n      \n      dialog.render(true);\n    });\n  }\n\n  /**\n   * Override close to track resolution\n   */\n  async close(options = {}) {\n    this._resolved = true;\n    return super.close(options);\n  }\n}","import { HOOKS_CORE } from \"../constants/Hooks.mjs\";\nimport { MODULE_ID, ROLL_TYPES } from \"../constants/General.mjs\";\nimport { getSettings } from \"../constants/Settings.mjs\";\nimport { GeneralUtil } from \"./helpers/GeneralUtil.mjs\";\nimport { LogUtil } from \"./LogUtil.mjs\";\nimport { SettingsUtil } from \"./SettingsUtil.mjs\";\nimport { RollHelpers } from \"./helpers/RollHelpers.mjs\";\nimport { RollHandlers } from \"./RollHandlers.mjs\";\n\n/**\n * Utility class for managing group roll chat messages\n */\nexport class ChatMessageUtils {\n  /**\n   * Map of requestId to chat message document\n   * @type {Map<string, ChatMessage>}\n   */\n  static groupRollMessages = new Map();\n  \n  /**\n   * Map of requestId to pending roll data\n   * @type {Map<string, Object>}\n   */\n  static pendingRolls = new Map();\n  \n  /**\n   * Set of message IDs that are scheduled for deletion\n   * @type {Set<string>}\n   */\n  static messagesScheduledForDeletion = new Set();\n  \n  /**\n   * Path to the group roll template\n   * @type {string}\n   */\n  static templatePath = 'modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs';\n  \n  /**\n   * Initialize the ChatMessageUtils\n   */\n  static async initialize() {\n    LogUtil.log('ChatMessageUtils.initialize');\n    await this.preloadTemplate();\n    this.registerEventListeners();\n  }\n  \n  /**\n   * Register event listeners for group roll messages\n   */\n  static registerEventListeners() {\n    const attachGroupRollListeners = (html, message) => {\n      html.querySelectorAll('.actor-result').forEach(element => {\n        element.addEventListener('click', (event) => {\n          if (event.target.closest('.dice-btn.rollable')) {\n            return;\n          }\n          \n          event.preventDefault();\n          event.stopPropagation();\n          \n          const actorResult = element;\n          \n          LogUtil.log('actor-result click', [element]);\n\n          if (actorResult.classList.contains('expanded')) {\n            actorResult.classList.remove('expanded');\n          } else {\n            actorResult.classList.add('expanded');\n          }\n        });\n      });\n      \n      html.querySelectorAll('.dice-btn.rollable').forEach(diceBtn => {\n        diceBtn.addEventListener('click', async (event) => {\n          event.preventDefault();\n          event.stopPropagation();\n          event.stopImmediatePropagation();\n          \n          const dataset = diceBtn.dataset;\n          const actorId = dataset.actorId;\n          const actor = game.actors.get(actorId);\n          \n          if (!actor) {\n            ui.notifications.warn(`Actor not found`);\n            return;\n          }\n          \n          const canRoll = game.user.isGM || actor.isOwner;\n          if (!canRoll) {\n            ui.notifications.warn(`You don't have permission to roll for ${actor.name}`);\n            return;\n          }\n          \n          const rollType = dataset.type?.toLowerCase();\n          const rollKey = dataset.rollKey;\n          const groupRollId = dataset.groupRollId;\n          const dc = dataset.dc ? parseInt(dataset.dc) : null;\n          \n          LogUtil.log('Rollable dice clicked', [rollType, rollKey, actorId, groupRollId]);\n          \n          const requestData = {\n            rollKey: rollKey,\n            groupRollId: groupRollId,\n            config: {\n              advantage: false,\n              disadvantage: false,\n              target: dc,\n              rollMode: game.settings.get(\"core\", \"rollMode\")\n            }\n          };\n          \n          // Dialog configuration - show dialog for rolls\n          const dialogConfig = {\n            configure: true,\n            isRollRequest: true\n          };\n          \n          const messageConfig = {\n            rollMode: game.settings.get(\"core\", \"rollMode\"),\n            create: true,\n            isRollRequest: true\n          };\n          \n          const rollConfig = {\n            parts: [],\n            data: {},\n            options: {}\n          };\n          \n          try {\n            const handler = RollHandlers[rollType];\n            if (handler) {\n              await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n            } else {\n              let rollMethod;\n              switch(rollType) {\n                case ROLL_TYPES.SKILL:\n                  rollMethod = 'rollSkill';\n                  break;\n                case ROLL_TYPES.ABILITY:\n                case ROLL_TYPES.ABILITY_CHECK:\n                  rollMethod = 'rollAbilityTest';\n                  break;\n                case ROLL_TYPES.SAVE:\n                case ROLL_TYPES.SAVING_THROW:\n                  rollMethod = 'rollAbilitySave';\n                  break;\n                case ROLL_TYPES.TOOL:\n                  rollMethod = 'rollToolCheck';\n                  break;\n                default:\n                  ui.notifications.warn(`Unknown roll type: ${rollType}`);\n                  return;\n              }\n              \n              if (rollMethod && actor[rollMethod]) {\n                await actor[rollMethod](rollKey, {\n                  ...requestData.config,\n                  messageOptions: { \"flags.flash-rolls-5e.groupRollId\": groupRollId }\n                });\n              }\n            }\n          } catch (error) {\n            LogUtil.error('Error executing roll from chat', error);\n            ui.notifications.error(`Failed to execute roll: ${error.message}`);\n          }\n        });\n      });\n      \n      // Handle DC control visibility and input\n      const dcControl = html.querySelector('.group-roll-dc-control');\n      const dcInput = html.querySelector('.dc-input');\n      \n      if (dcControl) {\n        const showToPlayers = dcControl.dataset.showToPlayers === 'true';\n        if (!game.user.isGM) {\n          dcControl.style.display = 'none';\n        }\n        if (!game.user.isGM && !showToPlayers) {\n          const groupFooterDetails = html.querySelector('.group-roll-footer .group-result-details');\n          if (groupFooterDetails) {\n            groupFooterDetails.style.display = 'none';\n          }\n        }\n      }\n      \n      if (dcInput) {\n        if (!game.user.isGM) {\n          dcInput.readOnly = true;\n          dcInput.style.cursor = 'not-allowed';\n        } else {\n          let debounceTimer = null;\n          \n          const handleDCChange = async () => {\n            const newDC = parseInt(dcInput.value);\n            \n            if (!dcInput.value) return;\n            \n            if (isNaN(newDC) || newDC < 1 || newDC > 99) {\n              dcInput.value = '';\n              // ui.notifications.warn(\"Please enter a valid DC between 1 and 99\");\n              return;\n            }\n            \n            const messageId = dcInput.dataset.messageId;\n            const targetMessage = game.messages.get(messageId);\n            \n            if (targetMessage) {\n              await this.updateGroupRollDC(targetMessage, newDC);\n            }\n          };\n          \n          dcInput.addEventListener('input', (e) => {\n            if (debounceTimer) {\n              clearTimeout(debounceTimer);\n            }\n            \n            debounceTimer = setTimeout(() => {\n              handleDCChange();\n            }, 1000);\n          });\n          \n          dcInput.addEventListener('keypress', (e) => {\n            if (e.key === 'Enter') {\n              if (debounceTimer) {\n                clearTimeout(debounceTimer);\n              }\n              handleDCChange();\n            }\n          });\n        }\n      }\n    };\n    \n    Hooks.on(HOOKS_CORE.RENDER_CHAT_MESSAGE, (message, html) => {\n      if (!message.getFlag(MODULE_ID, 'isGroupRoll')) return;\n      attachGroupRollListeners(html, message);\n    });\n    \n    Hooks.on(HOOKS_CORE.RENDER_CHAT_LOG, (app, html) => {\n      const groupRollElements = html.querySelectorAll('.flash5e-group-roll');\n      groupRollElements.forEach(element => {\n        const messageElement = element.closest('.chat-message');\n        if (messageElement) {\n          const messageId = messageElement.dataset.messageId;\n          const message = game.messages.get(messageId);\n          if (message && message.getFlag(MODULE_ID, 'isGroupRoll')) {\n            attachGroupRollListeners(element, message);\n          }\n        }\n      });\n    });\n  }\n  \n  /**\n   * Preload the Handlebars template\n   */\n  static async preloadTemplate() {\n    LogUtil.log('ChatMessageUtils.preloadTemplate');\n    try {\n      await GeneralUtil.loadTemplates([this.templatePath]);\n    } catch (error) {\n      LogUtil.error('Failed to preload template', error);\n    }\n  }\n  \n  /**\n   * Create a group roll message for multiple actors\n   * @param {Actor[]} actors - Array of actors\n   * @param {string} rollType - Type of roll\n   * @param {string} rollKey - Specific roll key\n   * @param {Object} config - Roll configuration\n   * @param {string} groupRollId - Unique group roll identifier\n   * @returns {Promise<ChatMessage>} The created chat message\n   */\n  static async createGroupRollMessage(actors, rollType, rollKey, config, groupRollId) {\n    LogUtil.log('ChatMessageUtils.createGroupRollMessage', [actors.length, rollType, rollKey, groupRollId]);\n    \n    const data = this.buildGroupRollData(actors, rollType, rollKey, config);\n    data.groupRollId = groupRollId;\n    \n    const hasPlayerOwnedActor = actors.some(actor => RollHelpers.isPlayerOwnerActive(actor));\n    const rollMode = hasPlayerOwnedActor ? \n      CONST.DICE_ROLL_MODES.PUBLIC : \n      game.settings.get(\"core\", \"rollMode\");\n    LogUtil.log('hasPlayerOwnedActor', [hasPlayerOwnedActor, rollMode]);\n    \n    // Store pending roll data\n    this.pendingRolls.set(groupRollId, {\n      actors: actors.map(a => a.id),\n      rollType,\n      rollKey,\n      config,\n      results: new Map()\n    });\n    \n    const message = await this.postGroupMessage(data, rollMode);\n    \n    if (message) {\n      this.groupRollMessages.set(groupRollId, message);\n    }\n    \n    return message;\n  }\n  \n  /**\n   * Build the data object for the group roll template\n   * @param {Actor[]} actors - Array of actors\n   * @param {string} rollType - Type of roll\n   * @param {string} rollKey - Specific roll key\n   * @param {Object} config - Roll configuration\n   * @returns {Object} Template data\n   */\n  static buildGroupRollData(actors, rollType, rollKey, config) {\n    LogUtil.log('ChatMessageUtils.buildGroupRollData', [actors.length, rollType, rollKey, config]);\n    \n    let flavor = this._buildFlavorText(rollType, rollKey, config);\n    const dc = config?.dc || config?.target;\n    const results = actors.map(actor => ({\n      actorId: actor.id,\n      actorImg: actor.img || actor.prototypeToken?.texture?.src || 'icons/svg/mystery-man.svg',\n      actorName: actor.name,\n      rolled: false,\n      showDice: true,\n      total: null,\n      success: false,\n      failure: false\n    }));\n    \n    const supportsDC = RollHelpers.shouldShowDC(rollType);\n    const SETTINGS = getSettings();\n    const showDCToPlayers = SettingsUtil.get(SETTINGS.showGroupDCToPlayers.tag);\n    \n    return {\n      flavor,\n      results,\n      showDC: dc !== undefined && dc !== null,\n      dc,\n      rollType,\n      rollKey,\n      supportsDC,\n      showDCToPlayers,\n      actors: actors.map(a => a.id), // Store actor IDs for later retrieval\n      moduleId: MODULE_ID\n    };\n  }\n  \n  /**\n   * Build flavor text for the roll\n   * @private\n   */\n  static _buildFlavorText(rollType, rollKey, config) {\n    let flavor = '';\n    \n    switch(rollType?.toLowerCase()) {\n      case 'ability':\n      case 'abilitycheck':\n        const abilityLabel = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        flavor = game.i18n.format(\"DND5E.AbilityPromptTitle\", { ability: abilityLabel });\n        break;\n      case 'save':\n      case 'savingthrow':\n        const saveLabel = CONFIG.DND5E.abilities[rollKey]?.label || rollKey;\n        flavor = game.i18n.format(\"DND5E.SavePromptTitle\", { ability: saveLabel });\n        break;\n      case 'skill':\n        const skillLabel = CONFIG.DND5E.skills[rollKey]?.label || rollKey;\n        const skillAbility = config?.ability || CONFIG.DND5E.skills[rollKey]?.ability || 'int';\n        const skillAbilityLabel = CONFIG.DND5E.abilities[skillAbility]?.label || skillAbility;\n        flavor = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n          skill: skillLabel,\n          ability: skillAbilityLabel\n        });\n        break;\n      case 'tool':\n        flavor = `Tool Check: ${rollKey}`;\n        break;\n      case 'initiative':\n        flavor = game.i18n.localize(\"DND5E.Initiative\");\n        break;\n      case 'attack':\n        flavor = config?.flavor || \"Attack Roll\";\n        break;\n      case 'damage':\n        flavor = config?.flavor || \"Damage Roll\";\n        break;\n      default:\n        flavor = config?.flavor || \"Roll Request\";\n    }\n    \n    return flavor;\n  }\n  \n  /**\n   * Post a group message to chat\n   * @param {Object} data - Message data\n   * @param {string} [rollMode] - The roll mode for the message\n   * @returns {Promise<ChatMessage>} The created message\n   */\n  static async postGroupMessage(data, rollMode = null) {\n    LogUtil.log('ChatMessageUtils.postGroupMessage', [data, rollMode]);\n    \n    try {\n      const content = await GeneralUtil.renderTemplate(this.templatePath, data);\n      \n      const messageData = {\n        content,\n        speaker: {\n          alias: \"Group Roll\"\n        },\n        flags: {\n          [MODULE_ID]: {\n            isGroupRoll: true,\n            groupRollId: data.groupRollId,\n            rollData: data\n          }\n        }\n      };\n      \n      // Apply rollMode to set whisper and blind properties correctly\n      if (rollMode) {\n        ChatMessage.applyRollMode(messageData, rollMode);\n      }\n      \n      return await ChatMessage.create(messageData);\n    } catch (error) {\n      LogUtil.error('Failed to post group message', error);\n      return null;\n    }\n  }\n  \n  /**\n   * Update a group roll message with a completed roll result\n   * @param {string} groupRollId - The group roll identifier\n   * @param {string} actorId - The actor who rolled\n   * @param {Roll} roll - The completed roll\n   */\n  static async updateGroupRollMessage(groupRollId, actorId, roll) {\n    LogUtil.log('ChatMessageUtils.updateGroupRollMessage', [groupRollId, actorId, roll.total, game.user.isGM]);\n    \n    if (!game.user.isGM) {\n      return;\n    }\n    \n    let message = this.groupRollMessages.get(groupRollId);\n    let pendingData = this.pendingRolls.get(groupRollId);\n    \n    if (!message) {\n      const messages = game.messages.contents;\n      message = messages.find(m => \n        m.getFlag(MODULE_ID, 'groupRollId') === groupRollId &&\n        m.getFlag(MODULE_ID, 'isGroupRoll')\n      );\n      \n      if (message) {\n        this.groupRollMessages.set(groupRollId, message);\n        LogUtil.log('updateGroupRollMessage - Found and registered group message', [groupRollId]);\n        \n        if (!pendingData) {\n          const flagData = message.getFlag(MODULE_ID, 'rollData');\n          pendingData = {\n            actors: flagData.results.map(r => r.actorId),\n            results: new Map()\n          };\n          this.pendingRolls.set(groupRollId, pendingData);\n        }\n      }\n    }\n    \n    if (!message) {\n      LogUtil.log('No group message found for groupRollId', groupRollId);\n      return;\n    }\n    \n    // Store the result if pendingData exists\n    if (pendingData && pendingData.results) {\n      pendingData.results.set(actorId, {\n        total: roll.total,\n        roll: roll\n      });\n    }\n    \n    const flagData = message.getFlag(MODULE_ID, 'rollData');\n    \n    const resultIndex = flagData.results.findIndex(r => r.actorId === actorId);\n    if (resultIndex !== -1) {\n      flagData.results[resultIndex].rolled = true;\n      flagData.results[resultIndex].showDice = false;\n      flagData.results[resultIndex].total = roll.total;\n      \n      try {\n        flagData.results[resultIndex].rollBreakdown = await roll.render();\n      } catch (error) {\n        LogUtil.error('Error rendering roll breakdown', error);\n        flagData.results[resultIndex].rollBreakdown = null;\n      }\n      \n      if (flagData.showDC && flagData.dc) {\n        flagData.results[resultIndex].success = roll.total >= flagData.dc;\n        flagData.results[resultIndex].failure = roll.total < flagData.dc;\n      }\n    }\n    \n    flagData.allRolled = flagData.results.every(r => r.rolled);\n    flagData.messageId = message.id;\n    \n    flagData.supportsDC = RollHelpers.shouldShowDC(flagData.rollType);\n    \n    const SETTINGS = getSettings();\n    flagData.showDCToPlayers = SettingsUtil.get(SETTINGS.showGroupDCToPlayers.tag);\n    \n    // Calculate group result if DC is set and roll type supports it\n    if (flagData.supportsDC && flagData.showDC && flagData.dc) {\n      const actors = flagData.actors?.map(id => game.actors.get(id)).filter(a => a) || [];\n      \n      const groupResult = RollHelpers.getGroupResult(\n        flagData.results,\n        flagData.dc,\n        actors,\n        flagData.rollType,\n        flagData.rollKey\n      );\n      \n      flagData.groupResult = groupResult;\n      LogUtil.log('updateGroupRollMessage - COMPLETE?', [groupResult.complete]);\n      \n      if (groupResult.complete && groupResult.details) {\n        flagData.groupSummary = groupResult.details.summary;\n      }\n    }\n    \n    const newContent = await GeneralUtil.renderTemplate(this.templatePath, flagData);\n    await message.update({\n      content: newContent,\n      flags: {\n        [MODULE_ID]: {\n          rollData: flagData\n        }\n      }\n    });\n    \n    if (pendingData?.results && pendingData?.actors) {\n      if (pendingData.results.size === pendingData.actors.length) {\n        this.pendingRolls.delete(groupRollId);\n        setTimeout(() => {\n          this.groupRollMessages.delete(groupRollId);\n        }, 60000); // Clean up after 1 minute\n      }\n    }\n  }\n  \n  /**\n   * Update group roll message with new DC value\n   * @param {ChatMessage} message - The chat message to update\n   * @param {number} newDC - The new DC value\n   */\n  static async updateGroupRollDC(message, newDC) {\n    const flagData = message.getFlag(MODULE_ID, 'rollData');\n    if (!flagData) return;\n    \n    flagData.supportsDC = RollHelpers.shouldShowDC(flagData.rollType);\n    if (!flagData.supportsDC) return;\n    \n    flagData.dc = newDC;\n    flagData.showDC = true;\n    flagData.results.forEach(result => {\n      if (result.rolled && result.total !== null) {\n        result.success = result.total >= newDC;\n        result.failure = result.total < newDC;\n      }\n    });\n    \n    const actors = flagData.actors?.map(id => game.actors.get(id)).filter(a => a) || [];\n    \n    const groupResult = RollHelpers.getGroupResult(\n      flagData.results,\n      newDC,\n      actors,\n      flagData.rollType,\n      flagData.rollKey\n    );\n    \n    flagData.groupResult = groupResult;\n    \n    if (groupResult.complete && groupResult.details) {\n      flagData.groupSummary = groupResult.details.summary;\n    }\n    \n    flagData.allRolled = flagData.results.every(r => r.rolled);\n    flagData.messageId = message.id;\n    \n    const SETTINGS = getSettings();\n    flagData.showDCToPlayers = SettingsUtil.get(SETTINGS.showGroupDCToPlayers.tag);\n    \n    const newContent = await GeneralUtil.renderTemplate(this.templatePath, flagData);\n    await message.update({\n      content: newContent,\n      flags: {\n        [MODULE_ID]: {\n          rollData: flagData\n        }\n      }\n    });\n  }\n  \n  /**\n   * Intercept individual roll messages and update group message instead\n   * @param {ChatMessage} message - The chat message document\n   * @param {HTMLElement} html - The rendered HTML element\n   * @param {Object} context - Rendering context\n   * @returns {boolean} Return false to prevent rendering\n   */\n  static interceptRollMessage(message, html, context) {\n    LogUtil.log('ChatMessageUtils.interceptRollMessage', [message, context]);\n    const SETTINGS = getSettings();\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    if (!groupRollsMsgEnabled) return;\n    \n    const actorId = message.speaker?.actor;\n    const actor = game.actors.get(actorId);\n    if (!actorId || !actor) return;\n    \n    const groupRollId = message.getFlag(MODULE_ID, 'groupRollId') || actor.getFlag(MODULE_ID, 'tempInitiativeConfig')?.groupRollId;\n\n    if (!groupRollId) {\n      LogUtil.log('interceptRollMessage - no groupRollId in flag');\n      return;\n    }\n    \n    if (!game.user.isGM && !this.groupRollMessages.has(groupRollId)) {\n      const messages = game.messages.contents;\n      const groupMessage = messages.find(m => \n        m.getFlag(MODULE_ID, 'groupRollId') === groupRollId &&\n        m.getFlag(MODULE_ID, 'isGroupRoll')\n      );\n      \n      if (groupMessage) {\n        this.groupRollMessages.set(groupRollId, groupMessage);\n        LogUtil.log('interceptRollMessage - Registered group roll message', [groupRollId]);\n      }\n    }\n    \n    if (!this.groupRollMessages.has(groupRollId)) {\n      LogUtil.log('interceptRollMessage - groupRollId not in map', [groupRollId, Array.from(this.groupRollMessages.keys())]);\n      return;\n    }\n    \n    const roll = message.rolls?.[0];\n    if (!roll) return;\n    \n    if (html && html instanceof HTMLElement && html.style) {\n      html.style.display = 'none';\n    }\n    \n    if (game.user.isGM) {\n      this.updateGroupRollMessage(groupRollId, actorId, roll);\n      \n      const msgId = message.id;\n      if (this.messagesScheduledForDeletion.has(msgId)) {\n        return;\n      }\n      this.messagesScheduledForDeletion.add(msgId);\n      \n      if (msgId) {\n        setTimeout(async () => {\n          LogUtil.log('interceptRollMessage - deletion', [msgId]);\n          try {\n            const msgExists = game.messages.get(msgId);\n            if (msgExists) {\n              await message.delete();\n              LogUtil.log('interceptRollMessage - Deleted individual message', [msgId]);\n            } else {\n              LogUtil.log('interceptRollMessage - Message already deleted', [msgId]);\n            }\n          } catch (error) {\n            LogUtil.log('interceptRollMessage - Error deleting message', [msgId, error.message]);\n          } finally {\n            this.messagesScheduledForDeletion.delete(msgId);\n          }\n        }, 500);\n      }\n    } else {\n      // Player side - don't try to update the message (no permission)\n      LogUtil.log('interceptRollMessage - Player roll intercepted, GM will handle update', [groupRollId]);\n    }\n    \n    return;\n  }\n  \n  /**\n   * Check if a request should use group messaging\n   * @param {string} requestId - Request identifier\n   * @returns {boolean} True if this is a group roll\n   */\n  static isGroupRoll(requestId) {\n    return this.pendingRolls.has(requestId) || this.groupRollMessages.has(requestId);\n  }\n  \n  /**\n   * Add groupRollId to message flags if it's a group roll\n   * @param {Object} messageConfig - The message configuration object\n   * @param {Object} requestData - The request data containing the groupRollId\n   * @param {Actor} actor - The actor performing the roll (optional, for player flag storage)\n   */\n  static async addGroupRollFlag(messageConfig, requestData, actor = null) {\n    const SETTINGS = getSettings();\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    \n    LogUtil.log('addGroupRollFlag called', [messageConfig, requestData.groupRollId, this.isGroupRoll(requestData.groupRollId)]);\n    \n    if (!game.user.isGM && requestData.groupRollId && actor) {\n      await actor.setFlag(MODULE_ID, 'tempGroupRollId', requestData.groupRollId);\n      LogUtil.log('addGroupRollFlag - Stored tempGroupRollId on actor for player', [requestData.groupRollId, actor.id]);\n      \n      if (!this.groupRollMessages.has(requestData.groupRollId)) {\n        const messages = game.messages.contents;\n        const groupMessage = messages.find(m => \n          m.getFlag(MODULE_ID, 'groupRollId') === requestData.groupRollId &&\n          m.getFlag(MODULE_ID, 'isGroupRoll')\n        );\n        \n        if (groupMessage) {\n          this.groupRollMessages.set(requestData.groupRollId, groupMessage);\n          LogUtil.log('addGroupRollFlag - Registered group roll message on player side', [requestData.groupRollId]);\n        }\n      }\n    }\n    \n    // Add groupRollId for any multi-actor roll when setting is enabled\n    if (groupRollsMsgEnabled && requestData.groupRollId) {\n      const shouldAddFlag = game.user.isGM ? this.isGroupRoll(requestData.groupRollId) : true;\n      \n      if (shouldAddFlag) {\n        messageConfig.data = messageConfig.data || {};\n        messageConfig.data.flags = messageConfig.data.flags || {};\n        messageConfig.data.flags[MODULE_ID] = messageConfig.data.flags[MODULE_ID] || {};\n        messageConfig.data.flags[MODULE_ID].groupRollId = requestData.groupRollId;\n        \n        LogUtil.log('addGroupRollFlag - Added flag to messageConfig', [messageConfig]);\n      }\n    }\n  }\n  \n  /**\n   * Clean up old messages and data\n   */\n  static cleanup() {\n    const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);\n    \n    for (const [requestId, message] of this.groupRollMessages.entries()) {\n      if (message.timestamp < fiveMinutesAgo) {\n        this.groupRollMessages.delete(requestId);\n        this.pendingRolls.delete(requestId);\n      }\n    }\n  }\n}","import { ROLL_TYPES, MODULE_ID } from \"../constants/General.mjs\";\nimport { ActivityUtil } from \"./ActivityUtil.mjs\";\nimport { RollHelpers } from \"./helpers/RollHelpers.mjs\";\nimport { LogUtil } from \"./LogUtil.mjs\";\nimport { CustomRollDialog } from \"./dialogs/CustomRollDialog.mjs\";\nimport { NotificationManager } from \"./helpers/Helpers.mjs\";\nimport { ChatMessageUtils } from \"./ChatMessageUtils.mjs\";\n\nexport const RollHandlers = {\n  ability: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    LogUtil.log('RollHandlers.ability #1', [rollConfig]);\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      ability: requestData.rollKey\n    });\n    LogUtil.log('RollHandlers.ability #2', [config.rolls?.[0]]);\n    LogUtil.log('RollHandlers.ability - messageConfig', messageConfig);\n    \n    // Add groupRollId to message flags if it's a group roll\n    await ChatMessageUtils.addGroupRollFlag(messageConfig, requestData, actor);\n    \n    await actor.rollAbilityCheck(config, dialogConfig, messageConfig);\n  },\n  \n  abilitycheck: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    return RollHandlers.ability(actor, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  save: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      ability: requestData.config?.ability || requestData.rollKey\n    });\n    \n    // Add groupRollId to message flags if it's a group roll\n    await ChatMessageUtils.addGroupRollFlag(messageConfig, requestData, actor);\n    \n    await actor.rollSavingThrow(config, dialogConfig, messageConfig);\n  },\n  \n  savingthrow: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    return RollHandlers.save(actor, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  skill: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    LogUtil.log('RollHandlers.skill #1', [requestData, rollConfig, dialogConfig]);\n\n    // Get the default ability for this skill from the actor\n    const defaultAbility = actor.system.skills?.[requestData.rollKey]?.ability || \n                          CONFIG.DND5E.skills?.[requestData.rollKey]?.ability || \n                          undefined;\n\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      skill: requestData.rollKey, \n      chooseAbility: dialogConfig.configure !== false, \n      ability: requestData.config.ability || defaultAbility \n    });\n    \n    // If we have a custom ability, set the flavor in the message config\n    if (requestData.config.ability && dialogConfig.configure === false) {\n      const skillLabel = CONFIG.DND5E.skills[requestData.rollKey]?.label || requestData.rollKey;\n      const abilityLabel = CONFIG.DND5E.abilities[requestData.config.ability]?.label || requestData.config.ability;\n      const flavor = game.i18n.format(\"DND5E.SkillPromptTitle\", { \n        skill: skillLabel, \n        ability: abilityLabel \n      });\n      messageConfig.data = messageConfig.data || {};\n      messageConfig.data.flavor = flavor;\n    }\n    LogUtil.log('RollHandlers.skill #2', [config, dialogConfig, messageConfig]);\n    \n    // Add groupRollId to message flags if it's a group roll\n    await ChatMessageUtils.addGroupRollFlag(messageConfig, requestData, actor);\n    \n    await actor.rollSkill(config, dialogConfig, messageConfig);\n  },\n\n  tool: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    LogUtil.log('RollHandlers.tool #1', [requestData, rollConfig]);\n\n    // Get the default ability for this tool from the actor\n    // Tools can have custom abilities set per actor, or use the system default\n    const toolConfig = actor.system.tools?.[requestData.rollKey];\n    const defaultAbility = toolConfig?.ability || \n                          CONFIG.DND5E.enrichmentLookup?.tools?.[requestData.rollKey]?.ability ||\n                          'int';\n\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      tool: requestData.rollKey,\n      chooseAbility: dialogConfig.configure !== false, \n      ability: requestData.config.ability || defaultAbility\n    });\n    \n    // If we have a custom ability, set the flavor in the message config\n    if (requestData.config.ability && dialogConfig.configure === false) {\n      const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[requestData.rollKey];\n      let toolLabel = requestData.rollKey;\n      if (toolData?.id) {\n        const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n        toolLabel = toolItem?.name || requestData.rollKey;\n      }\n      const abilityLabel = CONFIG.DND5E.abilities[requestData.config.ability]?.label || requestData.config.ability;\n      const flavor = game.i18n.format(\"DND5E.ToolPromptTitle\", { \n        tool: toolLabel, \n        ability: abilityLabel \n      });\n      messageConfig.data = messageConfig.data || {};\n      messageConfig.data.flavor = flavor;\n    }\n    LogUtil.log('RollHandlers.tool #2', [config, dialogConfig, messageConfig]);\n    \n    await ChatMessageUtils.addGroupRollFlag(messageConfig, requestData, actor);\n    await actor.rollToolCheck(config, dialogConfig, messageConfig);\n  },\n\n  concentration: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig);\n    \n    await ChatMessageUtils.addGroupRollFlag(messageConfig, requestData, actor);\n    await actor.rollConcentration(config, dialogConfig, messageConfig);\n  },\n\n  attack: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleActivityRoll(actor, ROLL_TYPES.ATTACK, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  damage: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleActivityRoll(actor, ROLL_TYPES.DAMAGE, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  itemsave: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleActivityRoll(actor, ROLL_TYPES.ITEM_SAVE, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  initiative: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    if (!game.combat) {\n      ui.notifications.warn(game.i18n.localize(\"COMBAT.NoneActive\"));\n      return;\n    }\n    const situational = requestData.config.situational || rollConfig.data?.situational || '';\n    const groupRollId = requestData.groupRollId;\n\n    let tokenActor = actor;\n    if (!actor.isToken) {\n      // Find a token for this actor in the current scene\n      const token = canvas.tokens.placeables.find(t => t.actor?.id === actor.id);\n      if (token) {\n        tokenActor = token.actor;\n      } else {\n        ui.notifications.error(game.i18n.format(\"COMBAT.NoneActive\"));\n        return;\n      }\n    }\n    await ChatMessageUtils.addGroupRollFlag(messageConfig, requestData, actor);\n\n    LogUtil.log('RollHandlers.initiative - START', [\n      actor, requestData, rollConfig, dialogConfig\n    ]);\n    \n    try {\n      if (dialogConfig.configure) {\n        LogUtil.log('RollHandlers.initiative - Dialog', []);\n        \n        if (requestData.config) {\n          const initiativeConfig = RollHelpers.buildRollConfig(requestData, rollConfig, {\n            ability: actor.system.attributes?.init?.ability || 'dex'\n          });\n          \n          const tempConfig = {\n            advantage: requestData.config.advantage || false,\n            disadvantage: requestData.config.disadvantage || false,\n            rollMode: requestData.config.rollMode || game.settings.get(\"core\", \"rollMode\"),\n            rolls: initiativeConfig.rolls,\n            groupRollId: requestData.groupRollId\n          };\n          await actor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n          await tokenActor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n        }\n        await tokenActor.rollInitiativeDialog();\n        // await tokenActor.unsetFlag(MODULE_ID, 'tempInitiativeConfig');\n\n      } else {\n        LogUtil.log('RollHandlers.initiative - Not dialog');\n        const tempConfig = {\n          rollMode: requestData.config.rollMode || game.settings.get(\"core\", \"rollMode\"),\n          groupRollId: requestData.groupRollId\n        };\n        await actor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n        await tokenActor.setFlag(MODULE_ID, 'tempInitiativeConfig', tempConfig);\n\n        const rollOptions = {\n          createCombatants: true,\n          rerollInitiative: true\n        };\n        await tokenActor.rollInitiative(rollOptions);\n      }\n      \n      LogUtil.log('RollHandlers.initiative - COMPLETE');\n    } catch (error) {\n      LogUtil.error('RollHandlers.initiative - Error', [error]);\n      NotificationManager.notify('error', `Initiative roll failed: ${error.message}`);\n    }\n  },\n  \n  // Alias for INITIATIVE_DIALOG\n  initiativedialog: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    return RollHandlers.initiative(actor, requestData, rollConfig, dialogConfig, messageConfig);\n  },\n\n  deathsave: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    const config = RollHelpers.buildRollConfig(requestData, rollConfig);\n    \n    // Add groupRollId to message flags if it's a group roll\n    await ChatMessageUtils.addGroupRollFlag(messageConfig, requestData, actor);\n    await actor.rollDeathSave(config, dialogConfig, messageConfig);\n  },\n\n  hitdie: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    dialogConfig.configure = game.user.isGM ? dialogConfig.configure : true;\n    \n    const config = RollHelpers.buildRollConfig(requestData, rollConfig, {\n      denomination: requestData.rollKey // The hit die denomination (d6, d8, etc.)\n    });\n    LogUtil.log('RollHandlers.hitdie', [config, dialogConfig, messageConfig]);\n    await actor.rollHitDie(config, dialogConfig, messageConfig);\n  },\n\n  custom: async (actor, requestData, rollConfig, dialogConfig, messageConfig) => {\n    await RollHandlers.handleCustomRoll(actor, requestData, dialogConfig, messageConfig);\n  },\n\n\n  /**\n   * Handle activity-based rolls (attack, damage, item save)\n   * SIMPLIFIED VERSION: No attack-specific options\n   * @param {Actor5e} actor - The actor performing the roll\n   * @param {string} rollType - The type of roll from ROLL_TYPES\n   * @param {Object} requestData - The roll request data\n   * @param {string} requestData.rollKey - The item ID\n   * @param {string} requestData.activityId - The activity ID\n   * @param {Object} requestData.config - Configuration\n   * @param {string} [requestData.config.situational] - Situational bonus formula\n   * @param {BasicRollConfiguration} rollConfig - Individual roll configuration\n   * @param {BasicRollDialogConfiguration} dialogConfig - Dialog configuration\n   * @param {BasicRollMessageConfiguration} messageConfig - Message configuration\n   * @returns {Promise<void>}\n   */\n  async handleActivityRoll(actor, rollType, requestData, rollConfig, dialogConfig, messageConfig) {\n    LogUtil.log('RollHandlers.handleActivityRoll', [rollType, requestData, rollConfig]);\n    if (requestData.rollKey) {\n      const processConfig = RollHelpers.buildRollConfig(requestData, rollConfig);\n      \n      const rollOptions = processConfig.rolls?.[0]?.options || {};\n      const activityConfig = {\n        usage: {\n          ...requestData.config,\n          rolls: processConfig.rolls,\n          ...(rollOptions.attackMode && { attackMode: rollOptions.attackMode }),\n          ...(rollOptions.ammunition && { ammunition: rollOptions.ammunition }),\n          ...(rollOptions.mastery !== undefined && { mastery: rollOptions.mastery })\n        },\n        dialog: dialogConfig,\n        message: messageConfig\n      };\n      \n      LogUtil.log('handleActivityRoll - final activity config', [activityConfig]);\n      \n      await ActivityUtil.executeActivityRoll(\n        actor, \n        rollType, \n        requestData.rollKey, \n        requestData.activityId, \n        activityConfig\n      );\n    }\n  },\n\n  /**\n   * Handle a custom roll, creating a custom dialog\n   * @param {Actor5e} actor - The actor performing the roll\n   * @param {Object} requestData - The roll request data\n   * @param {string} requestData.rollKey - The roll formula\n   * @param {Object} requestData.config - Configuration object\n   * @param {string} [requestData.config.rollMode] - Roll visibility mode\n   * @param {string} [requestData.config.requestedBy] - Name of the requester\n   * @param {BasicRollDialogConfiguration} dialogConfig - Dialog configuration\n   * @param {BasicRollMessageConfiguration} messageConfig - Message configuration\n   * @returns {Promise<void>}\n   */\n  async handleCustomRoll(actor, requestData, dialogConfig, messageConfig) {\n    const formula = requestData.rollKey;\n    \n    if (dialogConfig?.configure === false) {\n      try {\n        const roll = new Roll(formula, actor.getRollData());\n        \n        roll.options = roll.options || {};\n        roll.options.isRollRequest = requestData.config?.isRollRequest !== false;\n        \n        await roll.evaluate({async: true});\n        await roll.toMessage({\n          speaker: ChatMessage.getSpeaker({actor}),\n          flavor: game.i18n.localize(`FLASH_ROLLS.rollTypes.${ROLL_TYPES.CUSTOM}`),\n          rollMode: messageConfig?.rollMode || requestData.config?.rollMode || game.settings.get(\"core\", \"rollMode\"),\n          isRollRequest: requestData.config?.isRollRequest !== false,\n          create: messageConfig?.create !== false\n        });\n      } catch (error) {\n        ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.ui.notifications.invalidFormula\", {formula: formula}));\n      }\n      return;\n    }\n    \n    const dialog = new CustomRollDialog({\n      formula: formula,\n      readonly: true,\n      actor: actor,\n      callback: async (confirmedFormula) => {\n        try {\n          const roll = new Roll(confirmedFormula, actor.getRollData());\n          \n          roll.options = roll.options || {};\n          roll.options.isRollRequest = true;\n          \n          await roll.evaluate({async: true});\n          await roll.toMessage({\n            speaker: ChatMessage.getSpeaker({actor}),\n            flavor: game.i18n.localize(`FLASH_ROLLS.rollTypes.${ROLL_TYPES.CUSTOM}`),\n            rollMode: requestData.config.rollMode,\n            isRollRequest: true,\n            _showRequestedBy: true,\n            _requestedBy: requestData.config.requestedBy || 'GM'\n          });\n        } catch (error) {\n          ui.notifications.error(game.i18n.format(\"FLASH_ROLLS.ui.notifications.invalidFormula\", {formula: confirmedFormula}));\n        }\n      }\n    });\n    \n    dialog.render(true);\n  },\n\n  /**\n   * Handle hit die recovery (used for refilling hit dice)\n   * @param {Actor5e} actor - The actor to recover hit dice for\n   * @returns {Promise<Object>} Result object with recovery details\n   */\n  async handleHitDieRecovery(actor) {\n    const result = foundry.utils.mergeObject({\n      type: \"long\",\n      deltas: {\n        hitDice: 0\n      },\n      newDay: false,\n      rolls: [],\n      updateData: {},\n      updateItems: []\n    }, {});\n    \n    if ( \"dhd\" in result ) result.deltas.hitDice = result.dhd;\n\n    actor._getRestHitDiceRecovery({ maxHitDice: actor.system.attributes.hd.max, type: \"long\" }, result);\n\n    result.dhd = result.deltas.hitDice;\n    result.longRest = true;\n\n    try {\n      if (result.updateData && Object.keys(result.updateData).length > 0) {\n        const updateResult = await actor.update(result.updateData, { isRest: false });\n      } else {\n        LogUtil.log('No actor updates to perform', []);\n      }\n      \n      if (result.updateItems && result.updateItems.length > 0) {\n        const itemUpdateResult = await actor.updateEmbeddedDocuments(\"Item\", result.updateItems, { isRest: false });\n      } else {\n        LogUtil.log('No item updates to perform', []);\n      }\n    } catch (error) {\n      LogUtil.error('Error during updates in handleHitDieRecovery:', [error]);\n      throw error;\n    }\n\n    LogUtil.log('handleHitDieRecovery #3', [result]);\n    // Return data summarizing the rest effects\n    return result;\n  }\n};","/**\n * Helper functions for roll validation and preparation\n */\n\nimport { LogUtil } from '../LogUtil.mjs';\nimport { NotificationManager } from './Helpers.mjs';\n\n/**\n * Ensure combat exists for initiative rolls\n * @returns {Promise<boolean>} True if combat is ready, false if cancelled\n */\nexport async function ensureCombatForInitiative() {\n  if (!game.combat) {\n    // const createCombat = await foundry.applications.api.DialogV2.confirm({\n    //   window: {\n    //     title: game.i18n.localize(\"COMBAT.Create\"),\n    //     classes: [\"flash5e-dialog\"]\n    //   },\n    //   content: \"<p>\" + game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.noCombatActive\") + \"</p>\",\n    //   rejectClose: false,\n    //   modal: true\n    // });\n    \n    // if (createCombat) {\n      // const combat = await game.combats.documentClass.create({scene: game.scenes.active.id});\n      const combat = await Combat.create({scene: game.scenes.active.id});\n      await combat.activate();\n      NotificationManager.notify('info', game.i18n.localize(\"FLASH_ROLLS.notifications.combatCreated\"));\n      // return combat;\n    // } else {\n    //   return false;\n    // }\n  }\n  \n  return game.combat;\n}\n\n/**\n * Filter actors for initiative rolls, handling re-rolls\n * @param {string[]} actorIds - Array of actor IDs to filter\n * @param {Game} game - The game instance\n * @returns {Promise<string[]>} Filtered array of actor IDs\n */\nexport async function filterActorsForInitiative(actorIds, game) {\n  if (!game.combat) return actorIds;\n  \n  const actors = actorIds\n    .map(id => game.actors.get(id))\n    .filter(actor => actor);\n  \n  // Check which actors already have initiative\n  const actorsNamesWithInitiative = [];\n  const actorIdsWithInitiative = new Set();\n  \n  for (const actor of actors) {\n    const combatants = game.combat.getCombatantsByActor(actor.id);\n    // Check if any combatant for this actor has initiative\n    const hasInitiative = combatants.some(c => c.initiative !== null);\n    if (hasInitiative) {\n      actorsNamesWithInitiative.push(actor.name);\n      actorIdsWithInitiative.add(actor.id);\n    }\n  };\n  LogUtil.log('filterActorsForInitiative', [actorsNamesWithInitiative]);\n  \n  // If any actors already have initiative, confirm re-roll\n  if (actorsNamesWithInitiative.length > 0) {\n    const reroll = await foundry.applications.api.DialogV2.confirm({\n      window: {\n        title: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle\"),\n        classes: [\"flash5e-dialog\"]\n      },\n      position: {\n        width: 420,\n        height: \"auto\"\n      },\n      content: \"<p>\" + game.i18n.format(\"FLASH_ROLLS.ui.dialogs.rerollInitiative\", {\n        actors: actorsNamesWithInitiative.join(\", \")\n      }) + \"</p>\",\n      rejectClose: false,\n      modal: true\n    });\n    \n    if (!reroll) { // User chose not to re-roll\n      const filteredIds = actorIds.filter(id => !actorIdsWithInitiative.has(id));\n      \n      if (filteredIds.length === 0) {\n        NotificationManager.notify('info', game.i18n.localize(\"FLASH_ROLLS.notifications.allActorsHaveInitiative\"));\n      }\n      \n      return filteredIds;\n    } else { // User chose to re-roll\n      // Only GM can reset initiative\n      if (game.user.isGM) {\n        for (const actorId of actorIdsWithInitiative) {\n          const combatants = game.combat.getCombatantsByActor(actorId);\n          LogUtil.log('filterActorsForInitiative - resetting initiative for combatants', [combatants]);\n          for (const c of combatants) {\n            await c.update({ initiative: null });\n          }\n        }\n      } else {\n        LogUtil.log('filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll');\n      }\n      \n      return actorIds;\n    }\n  }\n  \n  return actorIds;\n}","import { HOOKS_DND5E } from '../constants/Hooks.mjs';\nimport { getSettings } from '../constants/Settings.mjs';\nimport { SettingsUtil } from './SettingsUtil.mjs';\nimport { LogUtil } from './LogUtil.mjs';\nimport { SocketUtil } from './SocketUtil.mjs';\nimport { MODULE_ID, DEBUG_TAG, ROLL_TYPES } from '../constants/General.mjs';\nimport { GMRollConfigDialog, GMSkillToolConfigDialog, GMHitDieConfigDialog, GMDamageConfigDialog, GMAttackConfigDialog } from './dialogs/gm-dialogs/index.mjs';\nimport { RollHandlers } from './RollHandlers.mjs';\nimport { ensureCombatForInitiative, filterActorsForInitiative } from './helpers/RollValidationHelpers.mjs';\nimport { GeneralUtil } from './helpers/GeneralUtil.mjs';\nimport { ModuleHelpers } from './helpers/ModuleHelpers.mjs';\n/**\n * Handles intercepting D&D5e rolls on the GM side and redirecting them to players\n */\nexport class RollInterceptor {  \n  /**\n   * @type {Set<string>} - Set of registered hook IDs for cleanup\n   */\n  static registeredHooks = new Set();\n  \n  /**\n   * Initialize the roll interceptor\n   */\n  static initialize() {\n    LogUtil.log('RollInterceptor.initialize');\n    if (!game.user.isGM) return;\n    \n    this.registerHooks();\n  }\n  \n  /**\n   * Register all necessary hooks for roll interception\n   */\n  static registerHooks() {\n    LogUtil.log('RollInterceptor.registerHooks');\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_ABILITY_CHECK, this._handlePreRoll.bind(this, ROLL_TYPES.ABILITY));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_SAVING_THROW, this._handlePreRoll.bind(this, ROLL_TYPES.SAVE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_SKILL_V2, this._handlePreRoll.bind(this, ROLL_TYPES.SKILL));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_TOOL_V2, this._handlePreRoll.bind(this, ROLL_TYPES.TOOL));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_ATTACK_V2, this._handlePreRoll.bind(this, ROLL_TYPES.ATTACK));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_DAMAGE_V2, this._handlePreRoll.bind(this, ROLL_TYPES.DAMAGE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_DEATH_SAVE_V2, this._handlePreRoll.bind(this, ROLL_TYPES.DEATH_SAVE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_HIT_DIE_V2, this._handlePreRoll.bind(this, ROLL_TYPES.HIT_DIE));\n\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_INITIATIVE, this._handlePreRollInitiative.bind(this, ROLL_TYPES.INITIATIVE));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_INITIATIVE_DIALOG, this._handlePreRollInitiative.bind(this, ROLL_TYPES.INITIATIVE));\n    this._registerHook(HOOKS_DND5E.ROLL_INITIATIVE, this._handleRollInitiative.bind(this, ROLL_TYPES.INITIATIVE));\n  }\n  \n  /**\n   * Helper to register a hook and track it for cleanup\n   * @param {string} hookName \n   * @param {Function} handler \n   */\n  static _registerHook(hookName, handler) {\n    LogUtil.log('RollInterceptor._registerHook');\n    const hookId = Hooks.on(hookName, handler);\n    this.registeredHooks.add({ hookName, hookId });\n  }\n  \n  /**\n   * Unregister all hooks (for cleanup)\n   */\n  static unregisterHooks() {\n    LogUtil.log('RollInterceptor.unregisterHooks');\n    for (const { hookName, hookId } of this.registeredHooks) {\n      Hooks.off(hookName, hookId);\n    }\n    this.registeredHooks.clear();\n  }\n\n   /**\n   * Handle pre-roll initiative to intercept rolls\n   * @param {string} rollType - Type of roll being intercepted\n   * @param {Actor5e} actor - Actor for initiative\n   * @param {D20Roll} roll - Roll configuration object\n   * @returns {boolean|void} - Return false to prevent the roll\n   */\n  static _handlePreRollInitiative(rollType, actor, roll) {\n    LogUtil.log('_handlePreRollInitiative', [rollType, actor, roll]);\n    return;\n  }\n\n  /**\n   * Handle pre-roll hooks to intercept rolls\n   * @param {string} rollType - Type of roll being intercepted\n   * @param {Object} config - Roll configuration object (or Actor for initiative)\n   * @param {Object} dialog - Dialog options\n   * @param {Object} message - Message options\n   * @returns {boolean|void} - Return false to prevent the roll\n   */\n  static _handlePreRoll(rollType, config, dialog, message) {\n    LogUtil.log('_handlePreRoll #0', [rollType, config, dialog, message]);\n    // Only intercept on GM side\n    if (!game.user.isGM || config.isRollRequest === false) return;\n    const isMidiRequest = GeneralUtil.isModuleOn(MODULE_ID, 'midi-qol');\n\n    const hookNames = config?.hookNames || dialog?.hookNames || message?.hookNames || [];\n    const isInitiativeRoll = hookNames.includes('initiativeDialog') || hookNames.includes('initiative');\n    \n    if(rollType === ROLL_TYPES.ATTACK){\n      const moduleFlags = config.subject?.item?.getFlag(MODULE_ID, 'tempAttackConfig');\n      LogUtil.log('_handlePreRoll - is Attack roll', [config.subject?.item, moduleFlags]);\n      if(moduleFlags){\n        LogUtil.log('_handlePreRoll - found module flags, skipping interception', [moduleFlags]);\n        return;\n      }\n    }\n    \n    if(rollType === ROLL_TYPES.DAMAGE){\n      // Check if this damage roll is from a local execution\n      const moduleFlags = config.subject?.item?.getFlag(MODULE_ID, 'tempDamageConfig');\n      LogUtil.log('RollInterceptor._handlePreRoll - is Damage roll', [config.subject?.item, moduleFlags]);\n      if(moduleFlags){\n        LogUtil.log('RollInterceptor._handlePreRoll - found module flags, skipping interception', [moduleFlags]);\n        return;\n      }\n    }\n    // Override rollType if this is actually an initiative roll\n    if (isInitiativeRoll && rollType === ROLL_TYPES.ABILITY) {\n      LogUtil.log('RollInterceptor._handlePreRoll - Overriding ability to initiative', [hookNames]);\n      rollType = ROLL_TYPES.INITIATIVE;\n    }\n    \n    if ( config?.isRollRequest || config.sendRequest===false || \n         dialog?.isRollRequest || message?.isRollRequest) {\n      LogUtil.log('_handlePreRoll - skipping interception (roll request)', [config, dialog, message]);\n      return;\n    }\n\n    let actor;\n    if (rollType === ROLL_TYPES.INITIATIVE && config instanceof Actor) {\n      actor = config;\n      // For initiative, check if this is from our own dialog execution\n      LogUtil.log('_handlePreRoll - Initiative', [config, dialog, message]);\n      if (dialog?.isRollRequest === false || message?.isRollRequest === false) {\n        return;\n      }\n    } else if (rollType === ROLL_TYPES.HIT_DIE) {\n      actor = dialog?.subject?.actor || dialog?.subject || dialog?.actor;\n    } else if(rollType === ROLL_TYPES.ATTACK || rollType === ROLL_TYPES.DAMAGE){\n      actor = config.subject?.actor;\n    } else {\n      actor = config.subject?.actor || config.subject || config.actor;\n    }\n\n    // Check if roll interception and requests are enabled\n    const SETTINGS = getSettings();\n    const rollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n    // const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n\n    if(!rollInterceptionEnabled || //!rollRequestsEnabled ||\n      !actor || actor.documentName !== 'Actor') {\n      return;\n    }\n\n    const owner = GeneralUtil.getActorOwner(actor);   \n    LogUtil.log('_handlePreRoll - ownership', [owner]);\n    \n    if (!owner || !owner.active || owner.id === game.user.id) {\n      LogUtil.log('_handlePreRoll - skipping interception (owner unavailable)', [owner?.name, owner?.active]);\n      return;\n    }\n\n    // For attack rolls, if a usage message is created, ensure it's public\n    if (rollType === ROLL_TYPES.ATTACK) {\n      message = {\n        ...message,\n        rollMode: CONST.DICE_ROLL_MODES.PUBLIC\n      };\n    }\n\n    const isMidiActive = config.midiOptions !== null && config.midiOptions !== undefined;\n    if(isMidiActive && game.user.isGM){\n      LogUtil.log('_handlePreRoll - isMidiActive', [isMidiActive]);\n      this._showGMConfigDialog(actor, owner, rollType, config, dialog, message); \n      return false;\n    }\n    \n    if (dialog.configure===false || config.isRollRequest===false || config.skipRollDialog===true || config.fastForward===true) {\n      LogUtil.log('_handlePreRoll - skipping interception (config flags)', [dialog.configure, config]);\n      return;\n    }\n    \n    LogUtil.log('_handlePreRoll - intercepting roll #1', [config, message]);\n    this._showGMConfigDialog(actor, owner, rollType, config, dialog, message); \n    \n    return false;\n  }\n\n  static _handleRollInitiative(a,b,c,d,e) {\n    LogUtil.log('_handleRollInitiative', [a,b,c,d,e]);\n    return;\n  }\n  \n  /**\n   * Handle initiative-specific pre-roll checks\n   * @param {Actor} actor\n   * @returns {Promise<boolean>} true if should continue with roll\n   */\n  static async _handleInitiativePreChecks(actor) {\n    if (!game.combat) {\n      const combatReady = await ensureCombatForInitiative();\n      if (!combatReady) return false;\n    }\n    \n    const filteredActorIds = await filterActorsForInitiative([actor.id], game);\n    return filteredActorIds.length > 0;\n  }\n\n  /**\n   * Get the appropriate dialog class for a roll type\n   * @param {string} rollType\n   * @returns {Class} The dialog class to use\n   */\n  static _getDialogClass(rollType) {\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    if ([ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(normalizedRollType)) {\n      return GMSkillToolConfigDialog;\n    } else if (normalizedRollType === ROLL_TYPES.HIT_DIE) {\n      return GMHitDieConfigDialog;\n    } else if (normalizedRollType === ROLL_TYPES.ATTACK) {\n      return GMAttackConfigDialog;\n    } else if (normalizedRollType === ROLL_TYPES.DAMAGE) {\n      return GMDamageConfigDialog;\n    } else {\n      return GMRollConfigDialog;\n    }\n  }\n\n  /**\n   * Extract roll key and build roll config based on roll type\n   * @param {string} rollType\n   * @param {Object} config\n   * @param {Object} dialog\n   * @param {Actor} actor\n   * @returns {Object} {rollKey, rollConfig}\n   */\n  static _extractRollConfiguration(rollType, config, dialog, actor) {\n    const normalizedRollType = rollType?.toLowerCase();\n    let rollKey = null;\n    const rollConfig = {\n      rolls: [{\n        parts: [],\n        data: {},\n        options: {}\n      }]\n    };\n\n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        rollConfig.skill = config.skill;\n        rollConfig.ability = config.ability || config.subject?.ability;\n        rollKey = rollConfig.skill;\n        break;\n        \n      case ROLL_TYPES.TOOL:\n        rollConfig.tool = config.tool;\n        rollConfig.ability = config.ability || config.subject?.ability;\n        rollKey = rollConfig.tool;\n        break;\n        \n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.SAVE:\n        rollConfig.ability = config.ability || config.subject?.ability;\n        rollKey = rollConfig.ability;\n        if (rollConfig.ability === 'con' && config.targetValue !== undefined) {\n          rollType = ROLL_TYPES.CONCENTRATION;\n        }\n        break;\n        \n      case ROLL_TYPES.CONCENTRATION:\n        rollConfig.ability = 'con';\n        rollKey = 'con';\n        break;\n        \n      case ROLL_TYPES.INITIATIVE:\n      case ROLL_TYPES.INITIATIVE_DIALOG:\n        rollKey = actor.system.attributes?.init?.ability || 'dex';\n        break;\n        \n      case ROLL_TYPES.HIT_DIE:\n        rollConfig.denomination = typeof config === 'string' ? \n          config : (config.denomination || config.subject?.denomination);\n        rollKey = rollConfig.denomination;\n        break;\n        \n      case ROLL_TYPES.ATTACK:\n        if (dialog?.options) {\n          rollConfig.ammunition = dialog.options.ammunition;\n          rollConfig.attackMode = dialog.options.attackMode;\n          rollConfig.mastery = dialog.options.mastery;\n        }\n        rollKey = config.subject?.item?.id;\n        break;\n        \n      case ROLL_TYPES.DAMAGE:\n        rollConfig.item = config.subject?.item;\n        rollConfig.subject = config.subject;\n        rollConfig.critical = config.critical || {};\n        rollKey = config.subject?.item?.id;\n        break;\n    }\n\n    return { rollKey, rollConfig };\n  }\n\n  /**\n   * Show dialog and get configuration from user\n   * @param {Class} DialogClass\n   * @param {Actor} actor\n   * @param {string} rollType\n   * @param {string} rollKey\n   * @param {boolean} skipRollDialog\n   * @param {boolean} rollRequestsEnabled\n   * @param {Object} config\n   * @param {Object} dialog\n   * @returns {Promise<Object>} Dialog result or default config\n   */\n  static async _getDialogResult(DialogClass, actor, rollType, rollKey, skipRollDialog, rollRequestsEnabled, config, dialog) {\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    if (skipRollDialog) {\n      return {\n        sendRequest: true,\n        advantage: false,\n        disadvantage: false,\n        situational: \"\",\n        rollMode: game.settings.get(\"core\", \"rollMode\")\n      };\n    }\n\n    if (!DialogClass.initConfiguration) {\n      LogUtil.error('DialogClass.initConfiguration not found', [DialogClass, DialogClass.name]);\n      throw new Error(`DialogClass ${DialogClass.name} does not have initConfiguration method`);\n    }\n    \n    const dialogOptions = {\n      skipRollDialog: false,\n      sendRequest: rollRequestsEnabled\n    };\n\n    if (normalizedRollType === ROLL_TYPES.ATTACK || normalizedRollType === ROLL_TYPES.DAMAGE) {\n      return await DialogClass.initConfiguration([actor], normalizedRollType, rollKey, dialogOptions, config, dialog);\n    } else {\n      return await DialogClass.initConfiguration([actor], normalizedRollType, rollKey, dialogOptions);\n    }\n  }\n\n  /**\n   * Show GM configuration dialog before sending roll request\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} rollType \n   * @param {Object} config \n   * @param {Object} dialog \n   * @param {Object} message \n   */\n  static async _showGMConfigDialog(actor, owner, rollType, config, dialog, message) {\n    LogUtil.log('_showGMConfigDialog - config', [rollType, config]);\n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const skipRollDialog = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n\n    try {\n      const normalizedRollType = rollType?.toLowerCase();\n      \n      // Handle initiative-specific checks\n      if (normalizedRollType === ROLL_TYPES.INITIATIVE) {\n        const shouldContinue = await this._handleInitiativePreChecks(actor);\n        if (!shouldContinue) return;\n      }\n      \n      // Get appropriate dialog class\n      const DialogClass = this._getDialogClass(rollType);\n      \n      // Extract roll configuration\n      const { rollKey, rollConfig } = this._extractRollConfiguration(rollType, config, dialog, actor);\n      \n      LogUtil.log('_showGMConfigDialog - rollConfig', [rollConfig, rollKey]);\n      \n      // Get dialog result or default configuration\n      const result = await this._getDialogResult(\n        DialogClass, \n        actor, \n        rollType, \n        rollKey, \n        skipRollDialog, \n        rollRequestsEnabled, \n        config, \n        dialog\n      );\n      \n      if (!result) {\n        LogUtil.log('_showGMConfigDialog - Dialog cancelled');\n        return;\n      }\n      \n      // If sendRequest is false, execute local roll\n      if (!result.sendRequest || !rollRequestsEnabled) {\n        LogUtil.log('_showGMConfigDialog - triggering _executeInterceptedRoll', [rollType, config, result]);\n        await this._executeInterceptedRoll(actor, rollType, config, result);\n        return;\n      }\n      \n      // Send the roll request to the player with the configured settings\n      // Exclude the event object as it can't be serialized\n      // const { event, ...configWithoutEvent } = config;\n      delete config.event;\n      const finalConfig = {\n        ...config,\n        ...result,\n        rolls: result.rolls,\n        requestedBy: game.user.name,\n        // For attack activity rolls, prevent the usage message from being created\n        ...(rollType === ROLL_TYPES.ATTACK && { chatMessage: false })\n      };\n      \n      LogUtil.log('_showGMConfigDialog - triggering _sendRollRequest', [rollType, finalConfig]);\n      this._sendRollRequest(actor, owner, rollType, finalConfig);\n      \n    } catch (error) {\n      LogUtil.error('RollInterceptor._showGMConfigDialog - Error', [error]);\n      // Fallback: send request without configuration\n      // this._sendRollRequest(actor, owner, rollType, config);\n    }\n  }\n  \n  /**\n   * Called when an intercepted roll should be executed \n   * locally on the GM side instead of sent to player\n   * @param {Actor} actor \n   * @param {string} rollType \n   * @param {Object} originalConfig\n   * @param {Object} dialogResult\n   */\n  static async _executeInterceptedRoll(actor, rollType, originalConfig, dialogResult) {\n    LogUtil.log('RollInterceptor._executeInterceptedRoll', [actor, rollType, originalConfig, dialogResult]);\n    const normalizedRollType = rollType?.toLowerCase();\n    \n    // Ensure we have a proper roll configuration structure\n    const rollConfig = dialogResult.rolls?.[0] || {\n      parts: [],\n      data: {},\n      options: {}\n    };\n    const situational = rollConfig.data?.situational || dialogResult.situational || \"\";\n    \n    // Determine the correct rollKey based on the roll type\n    let rollKey;\n    switch (normalizedRollType) {\n      case ROLL_TYPES.SKILL:\n        rollKey = originalConfig.skill;\n        break;\n      case ROLL_TYPES.TOOL:\n        rollKey = originalConfig.tool;\n        break;\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.SAVE:\n        rollKey = originalConfig.ability || originalConfig.subject?.ability;\n        break;\n      case ROLL_TYPES.HIT_DIE:\n        rollKey = originalConfig.denomination;\n        break;\n      default:\n        rollKey = originalConfig.ability || originalConfig.skill || originalConfig.tool || originalConfig.denomination;\n    }\n    \n    const requestData = {\n      rollKey: rollKey,\n      config: {\n        advantage: dialogResult.advantage || originalConfig.advantage,\n        disadvantage: dialogResult.disadvantage || originalConfig.disadvantage,\n        target: dialogResult.target || dialogResult.dc || originalConfig.target,\n        rollMode: dialogResult.rollMode || originalConfig.rollMode,\n        situational: situational,\n        isRollRequest: false,\n        ability: originalConfig.ability // Pass the ability from original config\n      }\n    };\n    \n    // For skills and tools, ensure we have the ability if not choosing\n    if (normalizedRollType === ROLL_TYPES.SKILL && !requestData.config.ability) {\n      requestData.config.ability = actor.system.skills?.[requestData.rollKey]?.ability || \n                                   CONFIG.DND5E.skills?.[requestData.rollKey]?.ability;\n    } else if (normalizedRollType === ROLL_TYPES.TOOL && !requestData.config.ability) {\n      const toolConfig = actor.system.tools?.[requestData.rollKey];\n      requestData.config.ability = toolConfig?.ability || \n                                   CONFIG.DND5E.enrichmentLookup?.tools?.[requestData.rollKey]?.ability ||\n                                   'int';\n    } else if ((normalizedRollType === ROLL_TYPES.ABILITY || normalizedRollType === ROLL_TYPES.SAVE) && !requestData.config.ability) {\n      // For ability checks and saves, the rollKey IS the ability\n      requestData.config.ability = requestData.rollKey;\n    }\n    \n    LogUtil.log('RollInterceptor._executeInterceptedRoll - requestData', [requestData, originalConfig, dialogResult]);\n    \n    const dialogConfig = {\n      configure: false, // Skip dialog\n      isRollRequest: false\n    };\n    \n    const messageConfig = {\n      rollMode: requestData.config.rollMode,\n      create: true,\n      isRollRequest: false\n    };\n    \n    try {\n      const handlerMap = ROLL_TYPES;\n      \n      const handler = RollHandlers[normalizedRollType];\n      LogUtil.log('RollInterceptor._executeInterceptedRoll - handler 1', [handler, normalizedRollType, RollHandlers[normalizedRollType]]);\n      \n      if (handler) {\n        // Special handling for attack and damage rolls\n        if (normalizedRollType === ROLL_TYPES.ATTACK || normalizedRollType === ROLL_TYPES.DAMAGE || normalizedRollType === ROLL_TYPES.SAVE) {\n          requestData.rollKey = originalConfig.subject?.item?.id;\n          requestData.activityId = originalConfig.subject?.id;\n        }\n        \n        LogUtil.log('RollInterceptor._executeInterceptedRoll - handler 2', [requestData, rollConfig, dialogConfig, messageConfig]);\n        await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n      } else {\n        LogUtil.warn(`No handler found for roll type: ${normalizedRollType}`);\n      }\n    } catch (error) {\n      LogUtil.error(\"RollInterceptor._executeInterceptedRoll\", [error]);\n    }\n  }\n  \n  // /**\n  //  * Show configuration dialog to GM before sending roll request\n  //  * @param {Actor} actor \n  //  * @param {User} owner \n  //  * @param {string} rollType \n  //  * @param {Object} config \n  //  * @param {Object} dialog \n  //  * @param {Object} message \n  //  */\n  // static async _showConfigurationDialog(actor, owner, rollType, config, dialog, message) {\n  //   LogUtil.log('RollInterceptor._showConfigurationDialog', [actor, owner, rollType, config, dialog, message]);\n\n  //   try {\n  //     const rollWrapper = async (finalConfig) => {\n  //       this._sendRollRequest(actor, owner, rollType, finalConfig);\n  //       return new Roll(\"1d20\").evaluate({async: false}); // Return a dummy roll\n  //     };\n      \n  //     // Replace the roll method in config with our wrapper\n  //     const modifiedConfig = {\n  //       ...config,\n  //       _rollMethod: rollWrapper,\n  //       configured: false\n  //     };\n      \n  //     const DialogClass = dialog.cls;\n  //     const rollDialog = new DialogClass(modifiedConfig, dialog.options);\n  //     const result = await rollDialog.render(true);\n  //   } catch (error) {\n  //     LogUtil.error(\"RollInterceptor._showConfigurationDialog - error\", [error]);\n  //     this._sendRollRequest(actor, owner, rollType, config);\n  //   }\n  // }\n  \n  /**\n   * Send a roll request to the player\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} rollType \n   * @param {BasicRollProcessConfiguration} config - The roll process configuration\n   */\n  static async _sendRollRequest(actor, owner, rollType, config) {\n    LogUtil.log('_sendRollRequest', [actor, owner, rollType, config]);\n    LogUtil.log('_sendRollRequest - config.rolls', [config.rolls]);\n    const SETTINGS = getSettings();\n    const skipRollDialog = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    let normalizedRollType = rollType?.toLowerCase();\n    \n    // Convert INITIATIVE to INITIATIVE_DIALOG for player requests\n    if (normalizedRollType === ROLL_TYPES.INITIATIVE) {\n      normalizedRollType = ROLL_TYPES.INITIATIVE_DIALOG;\n    }\n    \n    // Extract the roll key based on roll type\n    let rollKey = null;\n    let activityId = null;\n    switch (normalizedRollType) {\n      case ROLL_TYPES.ABILITY:\n      case ROLL_TYPES.SAVE:\n        rollKey = config.ability;\n        break;\n      case ROLL_TYPES.SKILL:\n        rollKey = config.skill;\n        break;\n      case ROLL_TYPES.TOOL:\n        rollKey = config.tool;\n        break;\n      case ROLL_TYPES.ATTACK:\n      case ROLL_TYPES.DAMAGE:\n        LogUtil.log('_sendRollRequest - Attack/Damage roll config', [rollType, config]);\n        // for activities, config.subject is the activity itself\n        rollKey = config.subject.item?.id;\n        activityId = config.subject.id;\n        break;\n      case ROLL_TYPES.HIT_DIE:\n        rollKey = typeof config === 'string' ? config : config.denomination;\n        break;\n      case ROLL_TYPES.INITIATIVE_DIALOG:\n      case ROLL_TYPES.INITIATIVE:\n        rollKey = null;\n        break;\n      case ROLL_TYPES.DEATH_SAVE:\n        rollKey = null;\n        break;\n      default:\n        LogUtil.warn(`Unknown roll type: ${rollType}`);\n        return;\n    }\n    \n    // Build the request data with proper rollProcessConfig\n    // Filter out circular references that midi-qol adds\n    const cleanConfig = { ...config };\n    delete cleanConfig.subject;\n    delete cleanConfig.workflow;\n    delete cleanConfig.item;\n    delete cleanConfig.activity;\n    \n    const requestData = {\n      type: \"rollRequest\",\n      requestId: foundry.utils.randomID(),\n      actorId: actor.id,\n      rollType: normalizedRollType,\n      rollKey,\n      activityId,\n      rollProcessConfig: {\n        ...cleanConfig,\n        _requestedBy: game.user.name  // Add who requested the roll\n      },\n      skipRollDialog: skipRollDialog,\n      targetTokenIds: Array.from(game.user.targets).map(t => t.id),\n      preserveTargets: SettingsUtil.get(SETTINGS.useGMTargetTokens.tag)\n    };\n\n    LogUtil.log('_sendRollRequest - requestData', [owner, requestData]);\n    \n    // Check if owner exists and is active\n    if(!owner || !requestData){\n      ui.notifications.warn('Flash Rolls: No owner found for actor ' + actor.name);\n      return;\n    }\n    \n    if(!owner.active){\n      const SETTINGS = getSettings();\n      if(SettingsUtil.get(SETTINGS.showOfflineNotifications.tag)) {\n        ui.notifications.info(game.i18n.format(\"FLASH_ROLLS.notifications.playerOffline\", { \n          player: owner.name \n        }));\n      }\n      // Execute the roll locally instead\n      await this._executeInterceptedRoll(actor, rollType, config, { \n        ...config,\n        sendRequest: false \n      });\n      return;\n    }\n    \n    // Owner is active, send the request\n    SocketUtil.execForUser('handleRollRequest', owner.id, requestData);\n\n    // Show notification to GM\n    ui.notifications.info(game.i18n.format('FLASH_ROLLS.notifications.rollRequestSent', { \n      player: owner?.name || 'Unknown',\n      actor: actor.name || 'Unknown' \n    }));\n    \n    \n  }\n}","import { isPlayerOwned, hasTokenInScene } from '../helpers/Helpers.mjs';\n\n/**\n * Utility class for actor-related operations in the Roll Requests Menu\n */\nexport class RollMenuActorUtil {\n  /**\n   * Get formatted stats for an actor\n   * @param {Actor} actor - The actor to get stats for\n   * @returns {Array<{abbrev: string, value: number}>} Array of stat objects\n   */\n  static getActorStats(actor) {\n    const system = actor.system;\n    const stats = [];\n    \n    // HP\n    if (system.attributes?.hp) {\n      stats.push({\n        abbrev: 'HP',\n        value: system.attributes.hp.value\n      });\n    }\n    \n    // AC\n    if (system.attributes?.ac) {\n      stats.push({\n        abbrev: 'AC',\n        value: system.attributes.ac.value\n      });\n    }\n    \n    const spellDC = system.attributes?.spell?.dc;\n    if (spellDC) {\n      stats.push({\n        abbrev: 'DC',\n        value: spellDC\n      });\n    }\n    \n    if (system.skills?.prc?.passive) {\n      stats.push({\n        abbrev: 'PRC',\n        value: system.skills.prc.passive\n      });\n    }\n    \n    return stats;\n  }\n\n  /**\n   * Get valid actor IDs based on current tab\n   * @param {Array<string>} selectedActorIds - Array of selected actor IDs\n   * @param {string} currentTab - Current tab ('pc' or 'npc')\n   * @returns {Array<string>} Filtered array of valid actor IDs\n   */\n  static getValidActorIds(selectedActorIds, currentTab) {\n    return selectedActorIds.filter(actorId => {\n      const actor = game.actors.get(actorId);\n      if (!actor) return false;\n      const isPC = isPlayerOwned(actor);\n      const isNPC = !isPC && hasTokenInScene(actor);\n      \n      return (currentTab === 'pc' && isPC) || (currentTab === 'npc' && isNPC);\n    });\n  }\n}","import { ROLL_TYPES } from '../../constants/General.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from '../SettingsUtil.mjs';\nimport { LogUtil } from '../LogUtil.mjs';\nimport { GMRollConfigDialog, GMSkillToolConfigDialog, GMHitDieConfigDialog } from '../dialogs/gm-dialogs/index.mjs';\nimport { CustomRollDialog } from '../dialogs/CustomRollDialog.mjs';\n\n/**\n * Utility class for roll configuration operations in the Roll Requests Menu\n */\nexport class RollMenuConfigUtil {\n  /**\n   * Get roll configuration from dialog or create default\n   * @param {Actor[]} actors - Actors being rolled for\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {boolean} skipRollDialog - Whether to skip dialogs\n   * @param {Array} pcActors - PC actors with owners\n   * @returns {Promise<BasicRollProcessConfiguration|null>} Process configuration or null if cancelled\n   */\n  static async getRollConfiguration(actors, rollMethodName, rollKey, skipRollDialog, pcActors) {\n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    \n    // Show GM configuration dialog (unless skip dialogs is enabled or it's a custom roll)\n    if (!skipRollDialog && rollMethodName !== ROLL_TYPES.CUSTOM) {\n      // Use appropriate dialog based on roll type\n      let DialogClass;\n      if ([ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(rollMethodName)) {\n        DialogClass = GMSkillToolConfigDialog;\n      } else if (rollMethodName === ROLL_TYPES.HIT_DIE) {\n        DialogClass = GMHitDieConfigDialog;\n      } else {\n        DialogClass = GMRollConfigDialog;\n      }\n      const config = await DialogClass.initConfiguration(actors, rollMethodName, rollKey, { \n        skipRollDialog,\n        sendRequest: rollRequestsEnabled || false \n      });\n      LogUtil.log('getRollConfiguration', [config]);\n      \n      return config; // Will be null if cancelled\n    } else {\n      // Use default BasicRollProcessConfiguration when skipping dialogs\n      const config = {\n        rolls: [{\n          parts: [],\n          data: {},\n          options: {}\n        }],\n        advantage: false,\n        disadvantage: false,\n        rollMode: game.settings.get(\"core\", \"rollMode\"),\n        chatMessage: true,\n        isRollRequest: false,\n        skipRollDialog: true,\n        sendRequest: rollRequestsEnabled && pcActors.length > 0\n      };\n      \n      // Death saves always have DC 10\n      if (rollMethodName === ROLL_TYPES.DEATH_SAVE) {\n        config.target = 10;\n      }\n      \n      return config;\n    }\n  }\n\n  /**\n   * Handle custom roll dialog\n   * @returns {Promise<string|null>} The roll formula or null if cancelled\n   */\n  static async handleCustomRoll() {\n    const formula = await this.showCustomRollDialog();\n    return formula; // Will be null if cancelled\n  }\n\n  /**\n   * Show custom roll dialog\n   * @returns {Promise<string|null>} The roll formula or null if cancelled\n   */\n  static async showCustomRollDialog() {\n    LogUtil.log('showCustomRollDialog');\n    return CustomRollDialog.prompt({\n      formula: \"\",\n      readonly: false\n    });\n  }\n}","import { MODULE, ROLL_TYPES } from '../../constants/General.mjs';\nimport { getSettings } from '../../constants/Settings.mjs';\nimport { SettingsUtil } from '../SettingsUtil.mjs';\nimport { LogUtil } from '../LogUtil.mjs';\nimport { SocketUtil } from '../SocketUtil.mjs';\nimport { delay, NotificationManager } from '../helpers/Helpers.mjs';\nimport { RollHandlers } from '../RollHandlers.mjs';\nimport { ChatMessageUtils } from '../ChatMessageUtils.mjs';\n\n/**\n * Utility class for roll orchestration operations in the Roll Requests Menu\n */\nexport class RollMenuOrchestrationUtil {\n  /**\n   * Defines who rolls for each selected actor (GM or player)\n   * Orchestrates the roll actions accordingly\n   * @param {Object} config - Roll configuration\n   * @param {Array} pcActors - PC actors with owners\n   * @param {Actor[]} npcActors - NPC actors\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   */\n  static async orchestrateRollsForActors(config, pcActors, npcActors, rollMethodName, rollKey) {\n    const SETTINGS = getSettings();\n    \n    // Handle PC actors - send roll requests (if sendRequest is true)\n    const successfulRequests = [];\n    const offlinePlayerActors = [];\n    const onlinePlayerActors = [];\n    \n    LogUtil.log('orchestrateRollsForActors', [config, pcActors, npcActors]);\n    \n    const groupRollId = foundry.utils.randomID();\n    \n    // Collect all actors that will be part of this roll\n    const allActors = [];\n\n    if (config.sendRequest) {\n      for (const { actor, owner } of pcActors) {\n        if (!owner.active) {\n          if(SettingsUtil.get(SETTINGS.showOfflineNotifications.tag)) {\n            NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.playerOffline\", { \n              player: owner.name \n            }));\n          }\n          offlinePlayerActors.push(actor);\n        } else {\n          onlinePlayerActors.push({actor, owner});\n        }\n      }\n      allActors.push(...onlinePlayerActors.map(({actor}) => actor));\n    } else {\n      // if requests are off, add to NPC list to roll locally\n      npcActors.push(...pcActors.map(({ actor }) => actor));\n    }\n    \n    allActors.push(...offlinePlayerActors, ...npcActors);\n\n    // Create group message if there are multiple actors and setting is enabled\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    if (groupRollsMsgEnabled && allActors.length > 1) {\n      await ChatMessageUtils.createGroupRollMessage(\n        allActors,\n        rollMethodName,\n        rollKey,\n        config,\n        groupRollId\n      );\n    }\n\n    // Player Rolls: Actors owned by active players\n    for (const { actor, owner } of onlinePlayerActors) {\n      const useGroupId = groupRollsMsgEnabled && allActors.length > 1 ? groupRollId : null;\n      await this.sendRollRequestToPlayer(actor, owner, rollMethodName, rollKey, config, true, useGroupId);\n      successfulRequests.push({ actor, owner });\n      await delay(100);\n    }\n    if (successfulRequests.length > 0) {\n      this.showConsolidatedNotification(successfulRequests, rollMethodName, rollKey);\n    }\n    \n    // GM Rolls: Actors owned by offline players or NPC actors\n    const gmRolledActors = [...offlinePlayerActors, ...npcActors];\n    if (gmRolledActors.length > 0) {\n      config.skipRollDialog = true;\n      config.groupRollId = groupRollsMsgEnabled && allActors.length > 1 ? groupRollId : null;\n      await this.handleGMRolls(gmRolledActors, rollMethodName, rollKey, config);\n    }\n  }\n\n  /**\n   * Send a roll request to a player\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} config - Roll configuration from dialog\n   * @param {boolean} suppressNotification - If true, don't show individual notification\n   * @param {string} groupRollId - Optional group roll ID for multi-actor rolls\n   */\n  static async sendRollRequestToPlayer(actor, owner, requestType, rollKey, config, suppressNotification = false, groupRollId = null) {\n    LogUtil.log('sendRollRequestToPlayer', [requestType, rollKey]);\n    const SETTINGS = getSettings();\n    \n    let rollType = requestType?.toLowerCase();\n    \n    // Mapping for compound types\n    if (rollType === ROLL_TYPES.ABILITY_CHECK) {\n      rollType = ROLL_TYPES.ABILITY;\n    } else if (rollType === ROLL_TYPES.SAVING_THROW) {\n      rollType = ROLL_TYPES.SAVE;\n    } else if (rollType === ROLL_TYPES.INITIATIVE_DIALOG) {\n      rollType = ROLL_TYPES.INITIATIVE;\n    }\n    \n    if (rollType === ROLL_TYPES.HIT_DIE) {\n      const hdData = actor.system.attributes.hd;\n      \n      if (hdData.value > 0) {\n        rollKey = hdData.largestAvailable;\n      } else {\n        // No hit dice available - show dialog to GM\n        const dialogResult = await foundry.applications.api.DialogV2.confirm({\n          window: {\n            title: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillTitle\") || \"No Hit Dice Available\",\n            classes: [\"flash5e-hit-die-dialog\"]\n          },\n          position: {\n            width: 420\n          },\n          content: `<p>${game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refillMessage\", { \n            actors: actor.name \n          }) || \"\"}</p>`,\n          modal: true,\n          rejectClose: false,\n          yes: {\n            label: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend\") || \"Refill & Send\",\n            icon: \"\"\n          },\n          no: {\n            label: game.i18n.localize(\"Cancel\") || \"Cancel\",\n            icon: \"\"\n          }\n        });\n        \n        if (dialogResult) {\n          try {\n            LogUtil.log('About to call handleHitDieRecovery for', [actor.name]);\n            const hitDieResult = await RollHandlers.handleHitDieRecovery(actor);\n            LogUtil.log('handleHitDieRecovery completed', [hitDieResult]);\n          } catch (error) {\n            LogUtil.error('Error calling handleHitDieRecovery:', [error]);\n          }\n          \n          // Get the largest available hit die after refill\n          rollKey = actor.system.attributes.hd.largestAvailable;\n          \n          NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refilled\", { \n            actor: actor.name \n          }) || `Hit dice refilled for ${actor.name}`);\n        } else {\n          // User cancelled - don't send the request\n          return;\n        }\n      }\n    }\n    \n    // Build the request data with proper rollProcessConfig\n    // Filter out circular references that midi-qol might add\n    const cleanConfig = { ...config };\n    delete cleanConfig.subject;\n    delete cleanConfig.workflow;\n    delete cleanConfig.item;\n    delete cleanConfig.activity;\n    \n    const requestData = {\n      type: \"rollRequest\",\n      groupRollId: groupRollId || foundry.utils.randomID(),\n      actorId: actor.id,\n      rollType,\n      rollKey,\n      activityId: null,  // Menu-initiated rolls don't use activities\n      rollProcessConfig: {\n        ...cleanConfig,\n        _requestedBy: game.user.name  // Add who requested the roll\n      },\n      skipRollDialog: false, // Never skip to player when it's a request\n      targetTokenIds: Array.from(game.user.targets).map(t => t.id),\n      preserveTargets: SettingsUtil.get(SETTINGS.useGMTargetTokens.tag)\n    };\n    \n    LogUtil.log('sendRollRequestToPlayer - sending request', [requestData]);\n    SocketUtil.execForUser('handleRollRequest', owner.id, requestData);\n    \n    if (!suppressNotification) {\n      NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.rollRequestSent\", { \n        player: owner.name,\n        actor: actor.name \n      }));\n    }\n  }\n\n  /**\n   * Send a consolidated notification for multiple roll requests\n   * @param {Array} successfulRequests - Array of {actor, owner} objects\n   * @param {string} rollMethodName - The type of roll being requested\n   * @param {string} rollKey - The specific roll key (if applicable)\n   */\n  static showConsolidatedNotification(successfulRequests, rollMethodName, rollKey) {\n    LogUtil.log('showConsolidatedNotification');\n    // Group requests by player\n    const requestsByPlayer = {};\n    for (const { actor, owner } of successfulRequests) {\n      if (!requestsByPlayer[owner.id]) {\n        requestsByPlayer[owner.id] = {\n          player: owner,\n          actors: []\n        };\n      }\n      requestsByPlayer[owner.id].actors.push(actor);\n    }\n    \n    // Get roll type name for display\n    const rollTypeKey = rollMethodName;\n    let rollTypeName = game.i18n.localize(`FLASH_ROLLS.rollTypes.${rollTypeKey}`) || rollTypeKey;\n    \n    // Add specific roll details if applicable\n    if (rollKey) {\n      const normalizedRollTypeKey = rollTypeKey.toLowerCase();\n      if (normalizedRollTypeKey === ROLL_TYPES.SKILL) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.skills[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.SAVING_THROW) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.ABILITY_CHECK) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.TOOL) {\n        // Try to get tool name from enrichmentLookup\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          rollTypeName = `${rollTypeName} (${toolItem?.name || rollKey})`;\n        } else {\n          rollTypeName = `${rollTypeName} (${rollKey})`;\n        }\n      } else if (normalizedRollTypeKey === ROLL_TYPES.CUSTOM) {\n        rollTypeName = `${rollTypeName}: ${rollKey}`;\n      }\n    }\n    \n    // Use NotificationManager for consolidated roll request notifications\n    NotificationManager.notifyRollRequestsSent(requestsByPlayer, rollTypeName);\n  }\n\n  /**\n   * Handle rolling for NPC actors locally\n   * @param {Actor[]} actors \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {BasicRollProcessConfiguration} rollProcessConfig - Process configuration from GM dialog\n   */\n  static async handleGMRolls(actors, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('handleGMRolls', [actors, requestType, rollKey, rollProcessConfig]);\n    \n    for (const actor of actors) {\n      await this.initiateRoll(actor, requestType, rollKey, rollProcessConfig);\n      await delay(100);\n    }\n  }\n\n  /**\n   * Execute local roll for a GM actor\n   * @param {Actor} actor \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {BasicRollProcessConfiguration} rollProcessConfig - Process configuration from GM dialog\n   */\n  static async initiateRoll(actor, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('initiateRoll', [requestType, rollKey, rollProcessConfig]);\n    try {\n      const normalizedType = requestType.toLowerCase();\n      let actualRollKey = rollKey;\n      if (normalizedType === ROLL_TYPES.HIT_DIE) {\n        const hdData = actor.system.attributes.hd;\n        if (hdData) {\n          // Find the first denomination with available uses\n          const denominations = ['d6', 'd8', 'd10', 'd12', 'd20'];\n          for (const denom of denominations) {\n            const available = hdData[denom]?.value || 0;\n            if (available > 0) {\n              actualRollKey = denom;\n              break;\n            }\n          }\n        }\n        if (!actualRollKey) {\n          // No hit dice available - show refill dialog\n          LogUtil.log('initiateRoll - No hit dice available', [actor.name]);\n          \n          const dialogResult = await foundry.applications.api.DialogV2.confirm({\n            window: {\n              title: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillTitle\") || \"No Hit Dice Available\",\n              classes: [\"flash5e-hit-die-dialog\"]\n            },\n            position: {\n              width: 420\n            },\n            content: `<p>${game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refillMessageLocal\", { \n              actors: actor.name \n            }) || \"\"}</p>`,\n            modal: true,\n            rejectClose: false,\n            yes: {\n              label: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillAndRoll\") || \"Refill & Roll\",\n              icon: \"\"\n            },\n            no: {\n              label: game.i18n.localize(\"Cancel\") || \"Cancel\",\n              icon: \"\"\n            }\n          });\n          \n          if (dialogResult) {\n            // Refill hit dice and continue with the roll\n            const result = await RollHandlers.handleHitDieRecovery(actor);\n            LogUtil.log('Hit die recovery result', [result]);\n            \n            // Notify of refill\n            NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refilled\", { \n              actor: actor.name \n            }));\n            \n            // Get the largest available hit die after refill\n            const hdDataAfterRefill = actor.system.attributes.hd;\n            actualRollKey = hdDataAfterRefill.largestAvailable;\n            \n            if (!actualRollKey) {\n              NotificationManager.notify('warn', game.i18n.format(\"DND5E.HitDiceWarn\", { name: actor.name }));\n              return;\n            }\n          } else {\n            // User cancelled\n            return;\n          }\n        }\n      }\n      \n      // Extract situational bonus from the rolls array if present\n      const situational = rollProcessConfig.rolls?.[0]?.data?.situational || \"\";\n      \n      // Build requestData structure expected by RollHandlers\n      const requestData = {\n        rollKey: actualRollKey,\n        groupRollId: rollProcessConfig.groupRollId, // Pass through the group roll ID\n        config: {\n          ...rollProcessConfig,\n          situational: situational,\n          rollMode: rollProcessConfig.rollMode || game.settings.get(\"core\", \"rollMode\"),\n          advantage: rollProcessConfig.advantage || false,\n          disadvantage: rollProcessConfig.disadvantage || false,\n          target: rollProcessConfig.target\n        }\n      };\n      \n      // Dialog configuration\n      const dialogConfig = {\n        configure: !rollProcessConfig.fastForward && !rollProcessConfig.skipRollDialog,\n        isRollRequest: true  // Mark this as a roll request to prevent re-interception\n      };\n      \n      // Message configuration\n      const messageConfig = {\n        rollMode: rollProcessConfig.rollMode || game.settings.get(\"core\", \"rollMode\"),\n        create: rollProcessConfig.chatMessage !== false,\n        isRollRequest: true  // Mark this as a roll request to prevent re-interception\n      };\n      \n      // Pass the proper roll configuration structure\n      const rollConfig = rollProcessConfig.rolls?.[0] || {};\n      \n      // Use the roll handler for the requested roll type\n      const handler = RollHandlers[normalizedType];\n      if (handler) {\n        await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n      } else {\n        NotificationManager.notify('warn', `Unknown roll type: ${requestType}`);\n      }\n    } catch (error) {\n      LogUtil.error('executeActorRoll', [error]);\n      NotificationManager.notify('error', game.i18n.format(\"FLASH_ROLLS.notifications.rollError\", { \n        actor: actor.name \n      }));\n    }\n  }\n}","import { MODULE } from '../../constants/General.mjs';\nimport { LogUtil } from '../LogUtil.mjs';\nimport { adjustMenuOffset } from '../helpers/Helpers.mjs';\nimport { GeneralUtil } from '../helpers/GeneralUtil.mjs';\n\n/**\n * Utility class for drag and position handling in the Roll Requests Menu\n */\nexport class RollMenuDragUtil {\n  static SNAP_DISTANCE = 50; // pixels\n  static DRAG_HANDLE_SELECTOR = '.drag-handle';\n  static LIGHTNING_BOLT_SELECTOR = '#flash-rolls-icon';\n  \n  /**\n   * Initialize drag functionality for the menu\n   * @param {RollRequestsMenu} menu - The menu instance\n   * @deprecated Use direct event listener attachment in _onRender instead\n   */\n  static initializeDrag(menu) {\n    const dragHandle = menu.element.querySelector(this.DRAG_HANDLE_SELECTOR);\n    \n    if (!dragHandle) {\n      LogUtil.error('RollMenuDragUtil.initializeDrag - No drag handle found!');\n      return;\n    }\n    \n    dragHandle.addEventListener('mousedown', (e) => {\n      this.handleDragStart(e, menu);\n    });\n  }\n  \n  /**\n   * Handle drag start\n   * @param {MouseEvent} event \n   * @param {RollRequestsMenu} menu \n   */\n  static handleDragStart(event, menu) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    menu.isDragging = true;\n    if(!menu.element){return}\n    menu.element.classList.add('dragging');\n    \n    const menuRect = menu.element.getBoundingClientRect();\n    const startX = event.clientX;\n    const startY = event.clientY;\n    const initialLeft = menuRect.left;\n    const initialTop = menuRect.top;\n    \n    const parent = menu.element.parentElement;\n\n    document.body.appendChild(menu.element);\n    menu.element.style.position = 'fixed';\n    menu.element.style.inset = '';  // Clear inset first\n    menu.element.style.top = `${initialTop}px`;\n    menu.element.style.left = `${initialLeft}px`;\n    menu.element.style.right = 'auto';\n    menu.element.style.bottom = 'auto';\n    menu.element.style.zIndex = 'var(--z-index-app)'; // Ensure it's on top while dragging\n    \n    menu.element.offsetHeight;\n    \n    // Store drag data\n    const dragData = {\n      startX,\n      startY,\n      initialLeft,\n      initialTop,\n      currentLeft: initialLeft,\n      currentTop: initialTop\n    };\n    \n    // Create move and up handlers\n    const handleMove = (e) => this.handleDragMove(e, menu, dragData);\n    const handleUp = (e) => this.handleDragEnd(e, menu, dragData, handleMove, handleUp);\n    \n    // Add document-level listeners\n    document.addEventListener('mousemove', handleMove);\n    document.addEventListener('mouseup', handleUp);\n  }\n  \n  /**\n   * Handle drag move\n   * @param {MouseEvent} event \n   * @param {RollRequestsMenu} menu \n   * @param {Object} dragData \n   */\n  static handleDragMove(event, menu, dragData) {\n    if (!menu.isDragging) return;\n    const deltaX = event.clientX - dragData.startX;\n    const deltaY = event.clientY - dragData.startY;\n    \n    dragData.currentLeft = dragData.initialLeft + deltaX;\n    dragData.currentTop = dragData.initialTop + deltaY;\n    \n    menu.element.style.inset = '';\n    menu.element.style.right = 'auto';\n    menu.element.style.bottom = 'auto';\n    \n    menu.element.style.position = 'fixed';\n    menu.element.style.top = `${dragData.currentTop}px`;\n    menu.element.style.left = `${dragData.currentLeft}px`;\n    \n    // Check if close to left edge\n    const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize) * 15;\n    if (dragData.currentLeft < remInPixels) {\n      menu.element.classList.add('left-edge');\n    } else {\n      menu.element.classList.remove('left-edge');\n    }\n    \n    const computed = window.getComputedStyle(menu.element);\n\n    const distance = this.calculateSnapDistance(menu);\n    if (distance < this.SNAP_DISTANCE) {\n      menu.element.classList.add('near-snap');\n    } else {\n      menu.element.classList.remove('near-snap');\n    }\n  }\n  \n  /**\n   * Handle drag end\n   * @param {MouseEvent} event \n   * @param {RollRequestsMenu} menu \n   * @param {Object} dragData \n   * @param {Function} moveHandler \n   * @param {Function} upHandler \n   */\n  static async handleDragEnd(event, menu, dragData, moveHandler, upHandler) {\n    LogUtil.log('RollMenuDragUtil.handleDragEnd');\n    \n    document.removeEventListener('mousemove', moveHandler);\n    document.removeEventListener('mouseup', upHandler);\n    \n    menu.isDragging = false;\n    menu.element.classList.remove('dragging');\n    menu.element.classList.remove('near-snap');\n    \n    menu.element.style.zIndex = '';\n    \n    const distance = this.calculateSnapDistance(menu);\n    \n    if (distance < this.SNAP_DISTANCE) {\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications) {\n        chatNotifications.insertBefore(menu.element, chatNotifications.firstChild);\n      }\n      await this.snapToDefault(menu);\n    } else {\n      menu.isCustomPosition = true;\n      menu.customPosition = {\n        x: dragData.currentLeft,\n        y: dragData.currentTop,\n        isCustom: true\n      };\n      \n      GeneralUtil.addCSSVars('--flash-rolls-menu-offset', '0px');\n      \n      await this.saveCustomPosition(menu.customPosition);\n      menu.element.classList.add('custom-position');\n      \n      // Check if close to left edge after drag end\n      const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize) * 15;\n      if (dragData.currentLeft < remInPixels) {\n        menu.element.classList.add('left-edge');\n      }\n    }\n  }\n  \n  /**\n   * Check if menu should snap to default position\n   * @param {RollRequestsMenu} menu \n   * @returns {boolean} True if within snap zone\n   */\n  static calculateSnapDistance(menu) {\n    const lightningBolt = document.querySelector(this.LIGHTNING_BOLT_SELECTOR);\n    if (!lightningBolt) return Infinity;\n    \n    const menuRect = menu.element.getBoundingClientRect();\n    const boltRect = lightningBolt.getBoundingClientRect();\n    \n    const horizontalDistance = Math.abs(boltRect.left - menuRect.right);\n    const distanceFromBottom = window.innerHeight - menuRect.bottom;\n    \n    return Math.max(\n      horizontalDistance > 50 ? Infinity : horizontalDistance,\n      distanceFromBottom > 50 ? Infinity : distanceFromBottom\n    );\n  }\n  \n  /**\n   * Snap menu back to default position\n   * @param {RollRequestsMenu} menu \n   */\n  static async snapToDefault(menu) {\n    LogUtil.log('RollMenuDragUtil.snapToDefault');\n    \n    menu.isCustomPosition = false;\n    menu.customPosition = null;\n    \n    menu.element.classList.remove('custom-position');\n    menu.element.classList.remove('left-edge');\n    menu.element.classList.add('snapping');\n    \n    menu.element.style.position = '';\n    menu.element.style.inset = '';\n    menu.element.style.left = '';\n    menu.element.style.top = '';\n    menu.element.style.right = '';\n    menu.element.style.bottom = '';\n    menu.element.style.zIndex = '';  \n    \n    adjustMenuOffset();\n    \n    await this.saveCustomPosition(null);\n    \n    setTimeout(() => {\n      menu.element.classList.remove('snapping');\n    }, 300);\n  }\n  \n  /**\n   * Apply custom position to menu\n   * @param {RollRequestsMenu} menu \n   * @param {Object} position \n   */\n  static applyCustomPosition(menu, position) {\n    if (!position || !position.isCustom) return;\n    \n    LogUtil.log('RollMenuDragUtil.applyCustomPosition', [position]);\n    \n    menu.isCustomPosition = true;\n    menu.customPosition = position;\n    \n    document.body.appendChild(menu.element);\n    \n    menu.element.style.position = 'fixed';\n    menu.element.style.inset = '';  // Clear inset first\n    menu.element.style.top = `${position.y}px`;\n    menu.element.style.left = `${position.x}px`;\n    menu.element.style.right = 'auto';\n    menu.element.style.bottom = 'auto';\n    \n    GeneralUtil.addCSSVars('--flash-rolls-menu-offset', '0px');\n    \n    menu.element.classList.add('custom-position');\n    \n    // Check if close to left edge when applying saved position\n    const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize) * 15;\n    if (position.x < remInPixels) {\n      menu.element.classList.add('left-edge');\n    }\n  }\n  \n  /**\n   * Save custom position to user flag\n   * @param {Object|null} position \n   */\n  static async saveCustomPosition(position) {\n    await game.user.setFlag(MODULE.ID, 'menuCustomPosition', position);\n  }\n  \n  /**\n   * Load custom position from user flag\n   * @returns {Object|null} Position object or null\n   */\n  static loadCustomPosition() {\n    return game.user.getFlag(MODULE.ID, 'menuCustomPosition') || null;\n  }\n  \n  /**\n   * Reset menu to default position\n   * @param {RollRequestsMenu} menu \n   */\n  static async resetPosition(menu) {\n    await this.snapToDefault(menu);\n  }\n}","import { MODULE, ROLL_TYPES } from '../constants/General.mjs';\nimport { HOOKS_CORE } from '../constants/Hooks.mjs';\nimport { LogUtil } from './LogUtil.mjs';\nimport { SettingsUtil } from './SettingsUtil.mjs';\nimport { getSettings } from '../constants/Settings.mjs';\nimport { SocketUtil } from './SocketUtil.mjs';\nimport { ActivityUtil } from './ActivityUtil.mjs';\nimport { GMRollConfigDialog, GMSkillToolConfigDialog, GMHitDieConfigDialog } from './dialogs/gm-dialogs/index.mjs';\nimport { SidebarUtil } from './SidebarUtil.mjs';\nimport { getPlayerOwner, isPlayerOwned, hasTokenInScene, updateCanvasTokenSelection, delay, buildRollTypes, NotificationManager, filterActorsForDeathSaves, categorizeActorsByOwnership, adjustMenuOffset } from './helpers/Helpers.mjs';\nimport { RollHandlers } from './RollHandlers.mjs';\nimport { RollHelpers } from './helpers/RollHelpers.mjs';\nimport { CustomRollDialog } from './dialogs/CustomRollDialog.mjs';\nimport { ensureCombatForInitiative, filterActorsForInitiative } from './helpers/RollValidationHelpers.mjs';\nimport { GeneralUtil } from './helpers/GeneralUtil.mjs';\nimport { ModuleHelpers } from './helpers/ModuleHelpers.mjs';\nimport { ChatMessageUtils } from './ChatMessageUtils.mjs';\nimport { RollMenuActorUtil } from './utils/RollMenuActorUtil.mjs';\nimport { RollMenuConfigUtil } from './utils/RollMenuConfigUtil.mjs';\nimport { RollMenuOrchestrationUtil } from './utils/RollMenuOrchestrationUtil.mjs';\nimport { RollMenuDragUtil } from './utils/RollMenuDragUtil.mjs';\n\n/**\n * Roll Requests Menu Application\n * Extends Foundry's ApplicationV2 with Handlebars support to provide a menu interface for GMs to request rolls from players\n */\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\nexport default class RollRequestsMenu extends HandlebarsApplicationMixin(ApplicationV2) {\n  /**\n   * Singleton instance of the menu\n   * @type {RollRequestsMenu|null}\n   */\n  static #instance = null;\n\n  constructor(options = {}) {\n    LogUtil.log('RollRequestsMenu.constructor', [options]);\n    super(options);\n    \n    // Track selected actors and current state\n    this.selectedActors = new Set();\n    this.currentTab = 'pc';\n    this.selectedRequestType = null;\n    this.isLocked = false; \n    this.optionsExpanded = game.user.getFlag(MODULE.ID, 'menuOptionsExpanded') ?? false;\n    this.accordionStates = game.user.getFlag(MODULE.ID, 'menuAccordionStates') ?? {};\n    \n    // Drag state\n    this.isDragging = false;\n    this.isCustomPosition = false;\n    this.customPosition = RollMenuDragUtil.loadCustomPosition();\n    \n    // Initialize with actors from selected tokens\n    this._initializeFromSelectedTokens();\n  }\n\n  static DEFAULT_OPTIONS = {\n    id: 'flash-rolls-menu',\n    classes: ['flash-rolls-menu'],\n    tag: 'div',\n    window: {\n      frame: false,\n      resizable: false,\n      minimizable: false\n    },\n    position: {}\n  };\n\n  static PARTS = {\n    main: {\n      template: `modules/${MODULE.ID}/templates/requests-menus.hbs`\n    }\n  };  \n  \n  async _prepareContext(options) {\n    LogUtil.log('_prepareContext');\n    const context = await super._prepareContext(options);\n    const actors = game.actors.contents;\n    const pcActors = [];\n    const npcActors = [];\n    const currentScene = game.scenes.active;\n    \n    for (const actor of actors) {\n      if (actor.type !== 'character' && actor.type !== 'npc') continue;\n      \n      const actorData = {\n        id: actor.id,\n        uuid: actor.uuid,\n        name: actor.name,\n        img: actor.img,\n        selected: this.selectedActors.has(actor.id),\n        crlngnStats: RollMenuActorUtil.getActorStats(actor)\n      };\n      \n      // Check if owned by a player (not GM)\n      const isPlayerOwned = Object.entries(actor.ownership)\n        .some(([userId, level]) => {\n          const user = game.users.get(userId);\n          return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n        });\n      \n      if (isPlayerOwned) {\n        const SETTINGS = getSettings();\n        const showOnlyPCsWithToken = SettingsUtil.get(SETTINGS.showOnlyPCsWithToken?.tag);\n        \n        if (showOnlyPCsWithToken) {\n          const hasTokenInScene = currentScene?.tokens.some(token => token.actorId === actor.id) || false;\n          if (hasTokenInScene) {\n            pcActors.push(actorData);\n          }\n        } else {\n          pcActors.push(actorData);\n        }\n      } else {\n        const hasTokenInScene = currentScene?.tokens.some(token => token.actorId === actor.id) || false;\n        if (hasTokenInScene) {// Only include NPCs if they have a token in the current scene\n          npcActors.push(actorData);\n        }\n      }\n    }\n    \n    // Get current settings\n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const skipRollDialog = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    const showOnlyPCsWithToken = SettingsUtil.get(SETTINGS.showOnlyPCsWithToken.tag);\n    \n    // Check if all actors in current tab are selected\n    const currentActors = this.currentTab === 'pc' ? pcActors : npcActors;\n    const selectAllOn = currentActors.length > 0 && \n      currentActors.every(actor => this.selectedActors.has(actor.id));\n    \n    const shouldPrepareRequestTypes = this.selectedActors.size > 0;\n    \n    const requestTypes = [];\n    if (shouldPrepareRequestTypes) {\n      for (const [key, option] of Object.entries(MODULE.ROLL_REQUEST_OPTIONS)) {\n        const requestType = {\n          id: key,\n          name: game.i18n.localize(`FLASH_ROLLS.rollTypes.${option.name}`) || option.label,\n          rollable: option.subList == null,\n          hasSubList: !!option.subList,\n          selected: this.selectedRequestType === key, \n          expanded: this.accordionStates[key] ?? false,\n          subItems: []\n        };\n        \n        // Build sub-items for accordion\n        if (option.subList) {\n          requestType.subItems = buildRollTypes(key, this.selectedActors);\n        }\n        \n        requestTypes.push(requestType);\n      }\n    }\n\n    const rollTypes = buildRollTypes(this.selectedRequestType, this.selectedActors);\n    \n    return {\n      ...context,\n      actors: currentActors,\n      currentTab: this.currentTab,\n      isPCTab: this.currentTab === 'pc',\n      isNPCTab: this.currentTab === 'npc',\n      selectedTab: this.currentTab,\n      rollRequestsEnabled,\n      skipRollDialog,\n      groupRollsMsgEnabled,\n      selectAllOn,\n      hasSelectedActors: this.selectedActors.size > 0,\n      requestTypes,\n      rollTypes,\n      showNames: true,\n      actorsLocked: this.isLocked,\n      optionsExpanded: this.optionsExpanded\n    };\n  }\n\n\n  /**\n   * Override _renderFrame to control where the element is inserted in the DOM\n   * @override\n   */\n  async _renderFrame(options) {\n    const frame = await super._renderFrame(options);\n    \n    // Apply custom position BEFORE inserting into DOM to prevent flicker\n    const customPosition = this.customPosition || RollMenuDragUtil.loadCustomPosition();\n    if (customPosition?.isCustom && frame) {\n      frame.style.position = 'fixed';\n      frame.style.top = `${customPosition.y}px`;\n      frame.style.left = `${customPosition.x}px`;\n      frame.style.right = 'auto';\n      frame.style.bottom = 'auto';\n      frame.classList.add('custom-position');\n      \n      // Check if close to left edge\n      const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize) * 15;\n      if (customPosition.x < remInPixels) {\n        frame.classList.add('left-edge');\n      }\n      \n      document.body.appendChild(frame);\n      \n      GeneralUtil.addCSSVars('--flash-rolls-menu-offset', '0px');\n      this.isCustomPosition = true;\n      this.customPosition = customPosition;\n    } else {\n      // Default position - insert into chat notifications\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications && frame) {\n        chatNotifications.insertBefore(frame, chatNotifications.firstChild);\n      }\n    }\n    \n    return frame;\n  }\n\n  /**\n   * Called after the application is rendered\n   * Verifies if roll controls are visible and adjusts the offset of the menu\n   */\n  _onRender(context, options) {\n    LogUtil.log('_onRender');\n    super._onRender(context, options);\n    this._attachListeners();\n\n    adjustMenuOffset();\n    \n    // Expand options if applicable\n    if (this.optionsExpanded) {\n      const optionsToggle = this.element.querySelector('.options-toggle');\n      const optionsElement = this.element.querySelector('li.options');\n      const toggleBtn = this.element.querySelector('.options-toggle-btn');\n      \n      optionsToggle?.classList.add('expanded');\n      optionsElement?.classList.add('expanded');\n    }\n    \n    setTimeout(() => {\n      document.addEventListener('click', this._onClickOutside, true);\n    }, 100);\n    \n    this._tokenControlHook = Hooks.on(HOOKS_CORE.CONTROL_TOKEN, this._onTokenControlChange.bind(this));\n    \n    this._actorUpdateHook = Hooks.on(HOOKS_CORE.UPDATE_ACTOR, this._onActorUpdate.bind(this));\n    \n    this._updateItemHook = Hooks.on(HOOKS_CORE.UPDATE_ITEM, this._onItemUpdate.bind(this));\n    this._createItemHook = Hooks.on(HOOKS_CORE.CREATE_ITEM, this._onItemUpdate.bind(this));\n    this._deleteItemHook = Hooks.on(HOOKS_CORE.DELETE_ITEM, this._onItemUpdate.bind(this));\n    \n    this._updateSettingHook = Hooks.on(HOOKS_CORE.UPDATE_SETTING, this._onSettingUpdate.bind(this));\n    this._updateSceneHook = Hooks.on(HOOKS_CORE.UPDATE_SCENE, this._onSceneUpdate.bind(this));\n    \n    const dragHandle = this.element.querySelector(RollMenuDragUtil.DRAG_HANDLE_SELECTOR);\n    if (dragHandle) {\n      dragHandle.addEventListener('mousedown', (e) => {\n        RollMenuDragUtil.handleDragStart(e, this);\n      });\n    }\n  }\n  \n  /**\n   * Handle token control changes\n   */\n  _onTokenControlChange(token, controlled) {\n    LogUtil.log('_onTokenControlChange');\n    if (!this.rendered) return;\n    \n    if (this._ignoreTokenControl) return;\n    if (this._tokenUpdateTimeout) {\n      clearTimeout(this._tokenUpdateTimeout);\n    }\n    \n    this._tokenUpdateTimeout = setTimeout(() => {\n      this._initializeFromSelectedTokens();\n      this.render();\n      \n      this._tokenUpdateTimeout = null;\n    }, 100); // 100ms debounce\n  }\n  \n  /**\n   * Handle actor updates to refresh stats display\n   */\n  _onActorUpdate(actor, changes, options, userId) {\n    LogUtil.log('_onActorUpdate', [actor.id, changes]);\n    if (!this.rendered) return;\n    \n    // Check if the update affects any stats we display\n    const statsChanged = changes.system?.attributes?.hp || \n                        changes.system?.attributes?.ac || \n                        changes.system?.attributes?.spell?.dc ||\n                        changes.system?.skills?.prc ||\n                        changes.system?.abilities ||\n                        changes.system?.attributes?.prof;\n    \n    if (!statsChanged) return;\n    \n    // Check if this actor is currently displayed in the menu\n    const currentTab = this.currentTab;\n    const isPlayerOwned = Object.entries(actor.ownership)\n      .some(([uid, level]) => {\n        const user = game.users.get(uid);\n        return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n      });\n    \n    const shouldUpdate = (currentTab === 'pc' && isPlayerOwned) || \n                         (currentTab === 'npc' && !isPlayerOwned && hasTokenInScene(actor));\n    \n    if (shouldUpdate) {\n      // Debounce updates to avoid excessive re-renders\n      if (this._actorUpdateTimeout) {\n        clearTimeout(this._actorUpdateTimeout);\n      }\n      \n      this._actorUpdateTimeout = setTimeout(() => {\n        this.render();\n        this._actorUpdateTimeout = null;\n      }, 100);\n    }\n  }\n  \n  /**\n   * Handle item updates on actors (for equipment changes that affect AC)\n   */\n  _onItemUpdate(item, changes, options, userId) {\n    if (!this.rendered) return;\n    \n    // Only care about items that could affect AC (armor, shields, etc.)\n    const affectsAC = item.type === 'equipment' || \n                      changes.system?.equipped !== undefined ||\n                      changes.system?.attunement !== undefined;\n    \n    if (!affectsAC) return;\n    \n    const actor = item.parent;\n    if (!actor || actor.documentName !== 'Actor') return;\n    \n    const currentTab = this.currentTab;\n    const isPlayerOwned = Object.entries(actor.ownership)\n      .some(([uid, level]) => {\n        const user = game.users.get(uid);\n        return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n      });\n    \n    const shouldUpdate = (currentTab === 'pc' && isPlayerOwned) || \n                         (currentTab === 'npc' && !isPlayerOwned && hasTokenInScene(actor));\n    \n    if (shouldUpdate) {\n      // Debounce updates to avoid excessive re-renders\n      if (this._itemUpdateTimeout) {\n        clearTimeout(this._itemUpdateTimeout);\n      }\n      \n      this._itemUpdateTimeout = setTimeout(() => {\n        LogUtil.log('Refreshing menu due to item change affecting AC', [item.name, actor.name]);\n        this.render();\n        this._itemUpdateTimeout = null;\n      }, 500);\n    }\n  }\n  \n  /**\n   * Handle setting updates to refresh menu when relevant settings change\n   */\n  _onSettingUpdate(setting, value, options, userId) {\n    if (!this.rendered) return;\n    \n    const SETTINGS = getSettings();\n    if (setting.key === `${MODULE.ID}.${SETTINGS.showOnlyPCsWithToken.tag}`) {\n      this.render();\n    }\n  }\n  \n  /**\n   * Handle scene updates to refresh menu when active scene changes\n   */\n  _onSceneUpdate(scene, changes, options, userId) {\n    if (!this.rendered) return;\n    \n    if (changes.active === true) {\n      const SETTINGS = getSettings();\n      const showOnlyPCsWithToken = SettingsUtil.get(SETTINGS.showOnlyPCsWithToken?.tag);\n      \n      this.render();\n    }\n  }\n  \n  /**\n   * Handle clicks outside the menu\n   */\n  _onClickOutside = (event) => {\n    LogUtil.log('_onClickOutside');\n    if (this.isLocked) return;\n    const menu = this.element;\n    if (!menu) return;\n    if (event.target.closest('.flash-rolls-menu')) return;\n    if (menu.contains(event.target)) return;\n    if (event.target.closest('#flash-rolls-icon')) return;\n    if (event.target.closest('.dialog, .app, .notification, .application')) return;\n    this.close();\n  }\n\n  /**\n   * Attach event listeners\n   */\n  _attachListeners() {\n    LogUtil.log('_attachListeners');\n    \n    const html = this.element;\n    \n    // Settings toggles\n    html.querySelector('#flash-rolls-toggle')?.addEventListener('change', this._onToggleRollRequests.bind(this));\n    html.querySelector('#flash5e-skip-dialogs')?.addEventListener('change', this._onToggleSkipDialogs.bind(this));\n    html.querySelector('#flash5e-group-rolls-msg')?.addEventListener('change', this._onToggleGroupRollsMsg.bind(this));\n    html.querySelector('#flash5e-actors-all')?.addEventListener('change', this._onToggleSelectAll.bind(this));\n    \n    // Lock toggle\n    html.querySelector('#flash5e-actors-lock')?.addEventListener('click', this._onToggleLock.bind(this));\n    \n    // Options toggle button (not the whole container since it now contains the select all switch)\n    html.querySelector('.options-toggle-btn')?.addEventListener('click', this._onToggleOptions.bind(this));\n    \n    // Tab switching\n    const tabs = html.querySelectorAll('.actor-tab');\n    tabs.forEach(tab => {\n      tab.addEventListener('click', this._onTabClick.bind(this));\n      tab.addEventListener('dblclick', this._onTabDoubleClick.bind(this));\n    });\n    \n    // Actor selection - handle clicks on actor rows or select buttons\n    html.querySelectorAll('.actor').forEach(actor => {\n      actor.addEventListener('click', this._onActorClick.bind(this));\n    });\n    \n    html.querySelectorAll('.actor-select').forEach(selectBtn => {\n      selectBtn.addEventListener('click', this._onActorSelectClick.bind(this));\n    });\n    \n    // Search functionality\n    const searchInput = html.querySelector('.search-input');\n    if (searchInput) {\n      searchInput.addEventListener('input', this._onSearchInput.bind(this));\n    }\n    \n    // Hover to show/hide accordion\n    const accordion = html.querySelector('.request-types-accordion');\n    if (accordion) {\n      // Show accordion on mouse enter\n      html.addEventListener('mouseenter', () => {\n        if (this.selectedActors.size > 0) {\n          accordion.classList.add('hover-visible');\n        }\n      });\n      \n      // Hide accordion on mouse leave\n      html.addEventListener('mouseleave', () => {\n        accordion.classList.remove('hover-visible');\n      });\n    }\n    \n    // Accordion and request type selection - use event delegation for dynamic content\n    const requestTypesContainer = html.querySelector('.request-types');\n    if (requestTypesContainer) {\n      requestTypesContainer.addEventListener('click', (event) => {\n        // Handle request type header click\n        const requestHeader = event.target.closest('.request-type-header');\n        if (requestHeader) {\n          const requestItem = requestHeader.closest('.request-type-item');\n          \n          // If it's an accordion header (has sublist), toggle accordion\n          if (requestHeader.classList.contains('accordion-header')) {\n            this._onAccordionToggle(event);\n            return;\n          }\n          \n          // If it's toggle (rollable without sublist), trigger the roll\n          if (requestHeader.classList.contains('toggle') && requestItem && requestItem.classList.contains('rollable')) {\n            const customEvent = {\n              ...event,\n              currentTarget: requestItem\n            };\n            this._onRequestTypeClick(customEvent);\n            return;\n          }\n        }\n        \n        // Handle sub-item click\n        const subItem = event.target.closest('.sub-item');\n        if (subItem && subItem.dataset.id) {\n          const customEvent = {\n            ...event,\n            currentTarget: subItem\n          };\n          this._onRollTypeClick(customEvent);\n        }\n      });\n    }\n  }\n\n  /**\n   * Handle roll requests toggle\n   */\n  async _onToggleRollRequests(event) {\n    LogUtil.log('_onToggleRollRequests');\n    const SETTINGS = getSettings();\n    const enabled = event.target.checked;\n    await SettingsUtil.set(SETTINGS.rollRequestsEnabled.tag, enabled);\n    \n    // Update the icon in the chat controls\n    SidebarUtil.updateRollRequestsIcon(enabled);\n    \n  }\n\n  /**\n   * Handle skip dialogs toggle\n   */\n  async _onToggleSkipDialogs(event) {\n    LogUtil.log('_onToggleSkipDialogs');\n    const SETTINGS = getSettings();\n    const skip = event.target.checked;\n    await SettingsUtil.set(SETTINGS.skipRollDialog.tag, skip);\n  }\n\n  /**\n   * Handle skip dialogs toggle\n   */\n  async _onToggleGroupRollsMsg(event) {\n    LogUtil.log('_onToggleGroupRollsMsg');\n    const SETTINGS = getSettings();\n    const isEnabled = event.target.checked;\n    await SettingsUtil.set(SETTINGS.groupRollsMsgEnabled.tag, isEnabled);\n  }\n\n  /**\n   * Handle select all toggle\n   */\n  _onToggleSelectAll(event) {\n    LogUtil.log('_onToggleSelectAll');\n    const selectAll = event.target.checked;\n    this._ignoreTokenControl = true; // To avoid loop\n    \n    // Get the setting for filtering PCs\n    const SETTINGS = getSettings();\n    const showOnlyPCsWithToken = SettingsUtil.get(SETTINGS.showOnlyPCsWithToken?.tag);\n    \n    const actors = this.currentTab === 'pc' ? \n      game.actors.contents.filter(a => {\n        if (!isPlayerOwned(a)) return false;\n        if (showOnlyPCsWithToken) {\n          const currentScene = game.scenes.active;\n          return currentScene?.tokens.some(token => token.actorId === a.id) || false;\n        }\n        return true;\n      }) :\n      game.actors.contents.filter(a => !isPlayerOwned(a) && hasTokenInScene(a));\n    \n    actors.forEach(actor => {\n      if (selectAll) {\n        this.selectedActors.add(actor.id);\n        updateCanvasTokenSelection(actor.id, true);\n      } else {\n        this.selectedActors.delete(actor.id);\n        updateCanvasTokenSelection(actor.id, false);\n      }\n    });\n    \n    setTimeout(() => {\n      this._ignoreTokenControl = false;\n    }, 200);\n    \n    this.render();\n    this._updateRequestTypesVisibility();\n  }\n  \n  /**\n   * Handle lock toggle\n   */\n  _onToggleLock(event) {\n    LogUtil.log('_onToggleLock');\n    event.preventDefault();\n    this.isLocked = !this.isLocked;\n    \n    // Update the icon - the currentTarget IS the icon element\n    const lockIcon = event.currentTarget;\n    lockIcon.classList.remove('fa-lock-keyhole', 'fa-lock-keyhole-open');\n    lockIcon.classList.add(this.isLocked ? 'fa-lock-keyhole' : 'fa-lock-keyhole-open');\n  }\n  \n  /**\n   * Handle options toggle\n   */\n  async _onToggleOptions(event) {\n    LogUtil.log('_onToggleOptions');\n    event.preventDefault();\n    event.stopPropagation();\n    \n    // Toggle the state\n    this.optionsExpanded = !this.optionsExpanded;\n    \n    // Save state to user flag\n    await game.user.setFlag(MODULE.ID, 'menuOptionsExpanded', this.optionsExpanded);\n    \n    // Find the options-toggle container (parent li) and toggle expanded class\n    const optionsToggleContainer = this.element.querySelector('.options-toggle');\n    if (optionsToggleContainer) {\n      optionsToggleContainer.classList.toggle('expanded', this.optionsExpanded);\n    }\n    \n    // Find the li.options sibling and toggle expanded class on it\n    const optionsElement = this.element.querySelector('li.options');\n    if (optionsElement) {\n      optionsElement.classList.toggle('expanded', this.optionsExpanded);\n    }\n  }\n  \n  /**\n   * Initialize selected actors from currently selected tokens\n   */\n  _initializeFromSelectedTokens() {\n    LogUtil.log('_initializeFromSelectedTokens');\n    \n    const controlledTokens = canvas.tokens?.controlled || [];\n    this.selectedActors.clear();\n    \n    for (const token of controlledTokens) {\n      if (token.actor) {\n        this.selectedActors.add(token.actor.id);\n        \n        if (this.selectedActors.size === 1) {\n          const isPC = isPlayerOwned(token.actor);\n          this.currentTab = isPC ? 'pc' : 'npc';\n        }\n      }\n    }\n\n    LogUtil.log('_initializeFromSelectedTokens', [this.selectedActors]);\n\n  }\n  \n  /**\n   * Handle tab click\n   */\n  async _onTabClick(event) {\n    LogUtil.log('_onTabClick');\n    const tab = event.currentTarget.dataset.tab;\n    if (tab === this.currentTab) return;\n    \n    // this.selectedActors.clear();\n    // canvas.tokens?.releaseAll();\n    this.selectedRequestType = null;\n    \n    this.currentTab = tab;\n    await this.render();\n  }\n\n  /**\n   * Handle tab double-click to clear all selections\n   */\n  async _onTabDoubleClick(event) {\n    LogUtil.log('_onTabDoubleClick');\n    event.preventDefault();\n    event.stopPropagation();\n    \n    this._ignoreTokenControl = true;\n    this.selectedActors.clear();\n    canvas.tokens?.releaseAll();\n    this.selectedRequestType = null;\n    \n    setTimeout(() => {\n      this._ignoreTokenControl = false;\n    }, 200);\n    \n    await this.render();\n    this._updateRequestTypesVisibility();\n  }\n\n  /**\n   * Handle click on actor row\n   */\n  _onActorClick(event) {\n    LogUtil.log('_onActorClick');\n    if (event.target.closest('.actor-select')) return;\n    \n    const actorElement = event.currentTarget;\n    const actorId = actorElement.dataset.id;\n    this._toggleActorSelection(actorId);\n  }\n  \n  /**\n   * Handle click on actor select button\n   */\n  _onActorSelectClick(event) {\n    LogUtil.log('_onActorSelectClick');\n    event.stopPropagation();\n    const actorId = event.currentTarget.dataset.id;\n    this._toggleActorSelection(actorId);\n  }\n  \n  /**\n   * Toggle actor selection state\n   */\n  _toggleActorSelection(actorId) {\n    LogUtil.log('_toggleActorSelection');\n    \n    // Temporarily disable token control hook to avoid feedback loop\n    this._ignoreTokenControl = true;\n    \n    if (this.selectedActors.has(actorId)) {\n      this.selectedActors.delete(actorId);\n      updateCanvasTokenSelection(actorId, false);\n    } else {\n      this.selectedActors.add(actorId);\n      updateCanvasTokenSelection(actorId, true);\n    }\n    \n    setTimeout(() => {\n      this._ignoreTokenControl = false;\n    }, 100);\n    \n    // Re-render to update the UI\n    this.render();\n    \n    this._updateRequestTypesVisibility();\n    this._updateSelectAllState();\n  }\n  \n\n  /**\n   * Update request types visibility based on actor selection\n   */\n  _updateRequestTypesVisibility() {\n    LogUtil.log('_updateRequestTypesVisibility');\n    // re-render when actor selection changes\n    this.render();\n  }\n\n  /**\n   * Update select all checkbox state\n   */\n  _updateSelectAllState() {\n    LogUtil.log('_updateSelectAllState');\n    const selectAllCheckbox = this.element.querySelector('#flash5e-actors-all');\n    const currentActors = this.currentTab === 'pc' ? 'pc' : 'npc';\n    const checkboxes = this.element.querySelectorAll(`.${currentActors}-actors .actor-item input[type=\"checkbox\"]`);\n    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;\n    \n    selectAllCheckbox.checked = checkedCount > 0 && checkedCount === checkboxes.length;\n    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;\n  }\n\n  /**\n   * Handle search input\n   */\n  _onSearchInput(event) {\n    LogUtil.log('_onSearchInput');\n    const searchTerm = event.target.value.toLowerCase().trim();\n    const requestTypesContainer = this.element.querySelector('.request-types');\n    \n    if (!requestTypesContainer) return;\n    \n    // Get all request type items and sub-items\n    const requestItems = requestTypesContainer.querySelectorAll('.request-type-item');\n    \n    requestItems.forEach(requestItem => {\n      const requestName = requestItem.querySelector('.request-type-name')?.textContent.toLowerCase() || '';\n      const subItems = requestItem.querySelectorAll('.sub-item');\n      let hasVisibleSubItems = false;\n      \n      // Check sub-items if they exist\n      if (subItems.length > 0) {\n        subItems.forEach(subItem => {\n          const subItemName = subItem.querySelector('.sub-item-name')?.textContent.toLowerCase() || '';\n          const isVisible = subItemName.includes(searchTerm);\n          subItem.classList.toggle('hidden', !isVisible);\n          if (isVisible) hasVisibleSubItems = true;\n        });\n        \n        // If search term matches the category name or has visible sub-items, show the category\n        const categoryMatches = requestName.includes(searchTerm);\n        const shouldShowCategory = searchTerm === '' || categoryMatches || hasVisibleSubItems;\n        requestItem.classList.toggle('hidden', !shouldShowCategory);\n        \n        // Auto-expand accordion if there's a search term and we have matches\n        if (searchTerm && hasVisibleSubItems) {\n          const nestedList = requestItem.querySelector('.roll-types-nested');\n          const accordionToggle = requestItem.querySelector('.accordion-toggle');\n          if (nestedList && accordionToggle) {\n            nestedList.style.display = 'block';\n            accordionToggle.classList.add('expanded');\n          }\n        }\n      } else {\n        // For items without sub-items, just check the name\n        const isVisible = searchTerm === '' || requestName.includes(searchTerm);\n        requestItem.classList.toggle('hidden', !isVisible);\n      }\n    });\n  }\n\n  /**\n   * Handle accordion toggle\n   */\n  async _onAccordionToggle(event) {\n    LogUtil.log('_onAccordionToggle');\n    event.stopPropagation();\n    \n    const requestHeader = event.target.closest('.request-type-header');\n    const requestItem = requestHeader.closest('.request-type-item');\n    const requestId = requestItem.dataset.id;\n    const accordionToggle = requestItem.querySelector('.accordion-toggle');\n    const nestedList = requestItem.querySelector('.roll-types-nested');\n    \n    if (!nestedList) return;\n    \n    // Toggle expanded state\n    const isExpanded = accordionToggle.classList.contains('expanded');\n    accordionToggle.classList.toggle('expanded', !isExpanded);\n    \n    // Toggle nested list visibility\n    nestedList.style.display = isExpanded ? 'none' : 'block';\n    \n    // Update saved state\n    this.accordionStates[requestId] = !isExpanded;\n    await game.user.setFlag(MODULE.ID, 'menuAccordionStates', this.accordionStates);\n  }\n\n  /**\n   * Handle request type click\n   */\n  async _onRequestTypeClick(event) {\n    const requestItem = event.currentTarget;\n    const requestType = requestItem.dataset.id;\n    const rollOption = MODULE.ROLL_REQUEST_OPTIONS[requestType];\n    LogUtil.log('_onRequestTypeClick', [requestType, requestItem.dataset, rollOption]);\n    \n    if (!rollOption) {\n      LogUtil.error('Unknown request type:', [requestType]);\n      return;\n    }\n    \n    if (this.selectedRequestType === requestType) {\n      this.selectedRequestType = null;\n    } else {\n      this.selectedRequestType = requestType;\n    }\n    \n    if (rollOption.subList) {\n      await this.render();\n    } else if (this.selectedRequestType) {\n      this._triggerRoll(requestType, null);\n    }\n  }\n\n  /**\n   * Handle roll type click (sub-item in accordion)\n   */\n  _onRollTypeClick(event) {\n    LogUtil.log('_onRollTypeClick');\n    const rollKey = event.currentTarget.dataset.id;\n    const parentType = event.currentTarget.dataset.parent;\n    // Use parent type if available (for accordion sub-items), otherwise use selected request type\n    const requestType = parentType || this.selectedRequestType;\n    // Pass the event through for local rolls\n    this._triggerRoll(requestType, rollKey);\n  }\n\n\n\n  /**\n   * Get roll configuration from dialog or create default\n   * @param {Actor[]} actors - Actors being rolled for\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   * @param {boolean} skipRollDialog - Whether to skip dialogs\n   * @param {Array} pcActors - PC actors with owners\n   * @returns {Promise<BasicRollProcessConfiguration|null>} Process configuration or null if cancelled\n   */\n  async _getRollConfiguration(actors, rollMethodName, rollKey, skipRollDialog, pcActors) {\n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    \n    // Show GM configuration dialog (unless skip dialogs is enabled or it's a custom roll)\n    if (!skipRollDialog && rollMethodName !== ROLL_TYPES.CUSTOM) {\n      // Use appropriate dialog based on roll type\n      let DialogClass;\n      if ([ROLL_TYPES.SKILL, ROLL_TYPES.TOOL].includes(rollMethodName)) {\n        DialogClass = GMSkillToolConfigDialog;\n      } else if (rollMethodName === ROLL_TYPES.HIT_DIE) {\n        DialogClass = GMHitDieConfigDialog;\n      } else {\n        DialogClass = GMRollConfigDialog;\n      }\n      const config = await DialogClass.initConfiguration(actors, rollMethodName, rollKey, { \n        skipRollDialog,\n        sendRequest: rollRequestsEnabled || false \n      });\n      LogUtil.log('_getRollConfiguration', [config]);\n      \n      return config; // Will be null if cancelled\n    } else {\n      // Use default BasicRollProcessConfiguration when skipping dialogs\n      const config = {\n        rolls: [{\n          parts: [],\n          data: {},\n          options: {}\n        }],\n        advantage: false,\n        disadvantage: false,\n        rollMode: game.settings.get(\"core\", \"rollMode\"),\n        chatMessage: true,\n        isRollRequest: false,\n        skipRollDialog: true,\n        sendRequest: rollRequestsEnabled && pcActors.length > 0\n      };\n      \n      // Death saves always have DC 10\n      if (rollMethodName === ROLL_TYPES.DEATH_SAVE) {\n        config.target = 10;\n      }\n      \n      return config;\n    }\n  }\n\n  /**\n   * Defines who rolls for each selected actor (GM or player)\n   * Orchestrates the roll actions accordingly\n   * @param {Object} config - Roll configuration\n   * @param {Array} pcActors - PC actors with owners\n   * @param {Actor[]} npcActors - NPC actors\n   * @param {string} rollMethodName - The roll method name\n   * @param {string} rollKey - The roll key\n   */\n  async _orchestrateRollsForActors(config, pcActors, npcActors, rollMethodName, rollKey) {\n    const SETTINGS = getSettings();\n    \n    // Handle PC actors - send roll requests (if sendRequest is true)\n    const successfulRequests = [];\n    const offlinePlayerActors = [];\n    const onlinePlayerActors = [];\n    \n    LogUtil.log('_orchestrateRollsForActors', [config, pcActors, npcActors]);\n\n    \n    const groupRollId = foundry.utils.randomID();\n    \n    // Collect all actors that will be part of this roll\n    const allActors = [];\n\n    if (config.sendRequest) {\n      for (const { actor, owner } of pcActors) {\n        if (!owner.active) {\n          if(SettingsUtil.get(SETTINGS.showOfflineNotifications.tag)) {\n            NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.playerOffline\", { \n              player: owner.name \n            }));\n          }\n          offlinePlayerActors.push(actor);\n        }else{\n          onlinePlayerActors.push({actor, owner});\n        }\n      }\n      allActors.push(...onlinePlayerActors.map(({actor}) => actor));\n    } else {\n      // if requests are off, add to NPC list to roll locally\n      npcActors.push(...pcActors.map(({ actor }) => actor));\n    }\n    \n    allActors.push(...offlinePlayerActors, ...npcActors);\n\n    // Create group message if there are multiple actors and setting is enabled\n    const groupRollsMsgEnabled = SettingsUtil.get(SETTINGS.groupRollsMsgEnabled.tag);\n    if (groupRollsMsgEnabled && allActors.length > 1) {\n      await ChatMessageUtils.createGroupRollMessage(\n        allActors,\n        rollMethodName,\n        rollKey,\n        config,\n        groupRollId\n      );\n    }\n\n    /////////////////////////////////\n    // Player Rolls: Actors owned by active players\n    for (const { actor, owner } of onlinePlayerActors) {\n      const useGroupId = groupRollsMsgEnabled && allActors.length > 1 ? groupRollId : null;\n      await this._sendRollRequestToPlayer(actor, owner, rollMethodName, rollKey, config, true, useGroupId);\n      successfulRequests.push({ actor, owner });\n      await delay(100);\n    }\n    if (successfulRequests.length > 0) {\n      this._showConsolidatedNotification(successfulRequests, rollMethodName, rollKey);\n    }\n    \n    /////////////////////////////////\n    // GM Rolls: Actors owned by offline players or NPC actors\n    const gmRolledActors = [...offlinePlayerActors, ...npcActors];\n    if (gmRolledActors.length > 0) {\n      config.skipRollDialog = true;\n      config.groupRollId = groupRollsMsgEnabled && allActors.length > 1 ? groupRollId : null;\n      await this._handleGMRolls(gmRolledActors, rollMethodName, rollKey, config);\n    }\n  }\n\n  /**\n   * Method called from menu items to trigger the roll for selected actors\n   * @param {string} requestType - The type of roll request (e.g., 'skill', 'ability')\n   * @param {string} rollKey - The specific roll key (e.g., 'acr' for Acrobatics)\n   */\n  async _triggerRoll(requestType, rollKey) {\n    LogUtil.log('_triggerRoll', [requestType, rollKey]);\n    const SETTINGS = getSettings();\n    const selectedActorIds = Array.from(this.selectedActors);\n    const skipRollDialog = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n    \n    let actors = selectedActorIds\n      .map(id => game.actors.get(id))\n      .filter(actor => actor);\n    \n    const rollOption = MODULE.ROLL_REQUEST_OPTIONS[requestType];\n    const rollMethodName = (rollOption?.name || requestType)?.toLowerCase();\n    \n    switch(rollMethodName) {\n      case ROLL_TYPES.CUSTOM:\n        rollKey = await RollMenuConfigUtil.handleCustomRoll();\n        if (!rollKey) return;\n        break;\n      case ROLL_TYPES.INITIATIVE:\n      case ROLL_TYPES.INITIATIVE_DIALOG:\n        const combatReady = await ensureCombatForInitiative();\n        if (combatReady) {\n          LogUtil.log(\"_triggerRoll - initiative\", [selectedActorIds]);\n          \n          // Ensure all actors are combatants before filtering\n          for (const actorId of selectedActorIds) {\n            const actor = game.actors.get(actorId);\n            if (actor) {\n              const combatants = game.combat.getCombatantsByActor(actorId);\n              if (!combatants || combatants.length === 0) {\n                LogUtil.log(\"_triggerRoll - adding actor to combat\", actor.name);\n                // Add the actor to combat\n                await game.combat.createEmbeddedDocuments(\"Combatant\", [{\n                  actorId: actorId,\n                  tokenId: actor.getActiveTokens()?.[0]?.id\n                }]);\n              }\n            }\n          }\n          \n          const filteredActorIds = await filterActorsForInitiative(selectedActorIds, game);\n\n          LogUtil.log(\"_triggerRoll filteredActorIds\", [filteredActorIds, !filteredActorIds.length]);\n          if (!filteredActorIds.length) return;\n\n          actors = filteredActorIds\n            .map(id => game.actors.get(id))\n            .filter(actor => actor);\n          \n          const initiateCombat = SettingsUtil.get(SETTINGS.initiateCombatOnRequest.tag);\n          if (initiateCombat) {\n            game.combat.startCombat();\n          }\n        }\n        break;\n      case ROLL_TYPES.DEATH_SAVE:\n        actors = await filterActorsForDeathSaves(actors);\n        break;\n      default:\n        break;\n    }\n    \n    if (!actors.length) {\n      NotificationManager.notify('warn', \"No valid actors selected\");\n      return;\n    }\n    \n    const { pcActors, npcActors } = categorizeActorsByOwnership(actors);\n    const config = await RollMenuConfigUtil.getRollConfiguration(actors, rollMethodName, rollKey, skipRollDialog, pcActors);\n    \n    LogUtil.log(\"_triggerRoll config\", [config]);\n    if (!config) return;\n    \n    // Pass event to orchestrate rolls for local GM rolls\n    await RollMenuOrchestrationUtil.orchestrateRollsForActors(config, pcActors, npcActors, rollMethodName, rollKey);\n    \n    // Only close if not locked\n    if (!this.isLocked) {\n      setTimeout(() => this.close(), 500);\n    }\n  }\n  \n  /**\n   * Send a roll request to a player\n   * @param {Actor} actor \n   * @param {User} owner \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {Object} config - Roll configuration from dialog\n   * @param {boolean} suppressNotification - If true, don't show individual notification\n   * @param {string} groupRollId - Optional group roll ID for multi-actor rolls\n   */\n  async _sendRollRequestToPlayer(actor, owner, requestType, rollKey, config, suppressNotification = false, groupRollId = null) {\n    LogUtil.log('_sendRollRequestToPlayer #A', [requestType, rollKey]);\n    const SETTINGS = getSettings();\n    \n    let rollType = requestType?.toLowerCase();\n    \n    // Mapping for compound types\n    if (rollType === ROLL_TYPES.ABILITY_CHECK) {\n      rollType = ROLL_TYPES.ABILITY;\n    } else if (rollType === ROLL_TYPES.SAVING_THROW) {\n      rollType = ROLL_TYPES.SAVE;\n    } else if (rollType === ROLL_TYPES.INITIATIVE_DIALOG) {\n      rollType = ROLL_TYPES.INITIATIVE;\n    }\n    \n    if (rollType === ROLL_TYPES.HIT_DIE) {\n      const hdData = actor.system.attributes.hd; // First available hit die denomination\n      \n      if (hdData.value > 0) {\n        rollKey = hdData.largestAvailable;\n      } else {\n        // No hit dice available - show dialog to GM\n        const dialogResult = await foundry.applications.api.DialogV2.confirm({\n          window: {\n            title: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillTitle\") || \"No Hit Dice Available\",\n            classes: [\"flash5e-hit-die-dialog\"]\n          },\n          position: {\n            width: 420\n          },\n          content: `<p>${game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refillMessage\", { \n            actors: actor.name \n          }) || \"\"}</p>`,\n          modal: true,\n          rejectClose: false,\n          yes: {\n            label: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend\") || \"Refill & Send\",\n            icon: \"\"\n          },\n          no: {\n            label: game.i18n.localize(\"Cancel\") || \"Cancel\",\n            icon: \"\"\n          }\n        });\n        \n        if (dialogResult) {\n          try {\n            LogUtil.log('About to call handleHitDieRecovery for', [actor.name]);\n            const hitDieResult = await RollHandlers.handleHitDieRecovery(actor);\n            LogUtil.log('handleHitDieRecovery completed', [hitDieResult]);\n          } catch (error) {\n            LogUtil.error('Error calling handleHitDieRecovery:', [error]);\n          }\n          \n          // Get the largest available hit die after refill\n          rollKey = actor.system.attributes.hd.largestAvailable;\n          \n          NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refilled\", { \n            actor: actor.name \n          }) || `Hit dice refilled for ${actor.name}`);\n        } else {\n          // User cancelled - don't send the request\n          return;\n        }\n      }\n    }\n    \n    // Build the request data with proper rollProcessConfig\n    // Filter out circular references that midi-qol might add\n    const cleanConfig = { ...config };\n    delete cleanConfig.subject;\n    delete cleanConfig.workflow;\n    delete cleanConfig.item;\n    delete cleanConfig.activity;\n    \n    const requestData = {\n      type: \"rollRequest\",\n      groupRollId: groupRollId || foundry.utils.randomID(),\n      actorId: actor.id,\n      rollType,\n      rollKey,\n      activityId: null,  // Menu-initiated rolls don't use activities\n      rollProcessConfig: {\n        ...cleanConfig,\n        _requestedBy: game.user.name  // Add who requested the roll\n      },\n      skipRollDialog: false, // Never skip to player when it's a request\n      targetTokenIds: Array.from(game.user.targets).map(t => t.id),\n      preserveTargets: SettingsUtil.get(SETTINGS.useGMTargetTokens.tag)\n    };\n    \n    // await ModuleHelpers.prepareMidiQOLSettings();\n    LogUtil.log('_sendRollRequestToPlayer - prepareMidiQOLSettings', []);\n    SocketUtil.execForUser('handleRollRequest', owner.id, requestData);\n    \n    if (!suppressNotification) {\n      NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.notifications.rollRequestSent\", { \n        player: owner.name,\n        actor: actor.name \n      }));\n    }\n  }\n  \n  /**\n   * Send a consolidated notification for multiple roll requests\n   * @param {Array} successfulRequests - Array of {actor, owner} objects\n   * @param {string} rollMethodName - The type of roll being requested\n   * @param {string} rollKey - The specific roll key (if applicable)\n   */\n  _showConsolidatedNotification(successfulRequests, rollMethodName, rollKey) {\n    LogUtil.log('_showConsolidatedNotification');\n    // Group requests by player\n    const requestsByPlayer = {};\n    for (const { actor, owner } of successfulRequests) {\n      if (!requestsByPlayer[owner.id]) {\n        requestsByPlayer[owner.id] = {\n          player: owner,\n          actors: []\n        };\n      }\n      requestsByPlayer[owner.id].actors.push(actor);\n    }\n    \n    // Get roll type name for display\n    // Find the option key that matches this rollMethodName\n    let rollOptionKey = null;\n    for (const [key, option] of Object.entries(MODULE.ROLL_REQUEST_OPTIONS)) {\n      if (option.name === rollMethodName) {\n        rollOptionKey = key;\n        break;\n      }\n    }\n    \n    const rollTypeKey = rollMethodName;\n    let rollTypeName = game.i18n.localize(`FLASH_ROLLS.rollTypes.${rollTypeKey}`) || rollTypeKey;\n    \n    // Add specific roll details if applicable\n    if (rollKey) {\n      const normalizedRollTypeKey = rollTypeKey.toLowerCase();\n      if (normalizedRollTypeKey === ROLL_TYPES.SKILL) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.skills[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.SAVING_THROW) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.ABILITY_CHECK) {\n        rollTypeName = `${rollTypeName} (${CONFIG.DND5E.abilities[rollKey]?.label || rollKey})`;\n      } else if (normalizedRollTypeKey === ROLL_TYPES.TOOL) {\n        // Try to get tool name from enrichmentLookup\n        const toolData = CONFIG.DND5E.enrichmentLookup?.tools?.[rollKey];\n        if (toolData?.id) {\n          const toolItem = dnd5e.documents.Trait.getBaseItem(toolData.id, { indexOnly: true });\n          rollTypeName = `${rollTypeName} (${toolItem?.name || rollKey})`;\n        } else {\n          rollTypeName = `${rollTypeName} (${rollKey})`;\n        }\n      } else if (normalizedRollTypeKey === ROLL_TYPES.CUSTOM) {\n        rollTypeName = `${rollTypeName}: ${rollKey}`;\n      }\n    }\n    \n    // Use NotificationManager for consolidated roll request notifications\n    NotificationManager.notifyRollRequestsSent(requestsByPlayer, rollTypeName);\n  }\n  \n  /**\n   * Handle rolling for NPC actors locally\n   * @param {Actor[]} actors \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {BasicRollProcessConfiguration} rollProcessConfig - Process configuration from GM dialog\n   */\n  async _handleGMRolls(actors, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('_handleGMRolls', [actors, requestType, rollKey, rollProcessConfig]);\n    \n    for (const actor of actors) {\n      await this._initiateRoll(actor, requestType, rollKey, rollProcessConfig);\n      await delay(100);\n    }\n  }\n  \n  /**\n   * Execute local roll for a GM actor\n   * @param {Actor} actor \n   * @param {string} requestType \n   * @param {string} rollKey \n   * @param {BasicRollProcessConfiguration} rollProcessConfig - Process configuration from GM dialog\n   */\n  async _initiateRoll(actor, requestType, rollKey, rollProcessConfig) {\n    LogUtil.log('_initiateRoll', [requestType, rollKey, rollProcessConfig]);\n    try {\n      const normalizedType = requestType.toLowerCase();\n      let actualRollKey = rollKey;\n      if (normalizedType === ROLL_TYPES.HIT_DIE) {\n        const hdData = actor.system.attributes.hd;\n        if (hdData) {\n          // Find the first denomination with available uses\n          const denominations = ['d6', 'd8', 'd10', 'd12', 'd20'];\n          for (const denom of denominations) {\n            const available = hdData[denom]?.value || 0;\n            if (available > 0) {\n              actualRollKey = denom;\n              break;\n            }\n          }\n        }\n        if (!actualRollKey) {\n          // No hit dice available - show refill dialog\n          LogUtil.log('_initiateRoll - No hit dice available', [actor.name]);\n          \n          const dialogResult = await foundry.applications.api.DialogV2.confirm({\n            window: {\n              title: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillTitle\") || \"No Hit Dice Available\",\n              classes: [\"flash5e-hit-die-dialog\"]\n            },\n            position: {\n              width: 420\n            },\n            content: `<p>${game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refillMessageLocal\", { \n              actors: actor.name \n            }) || \"\"}</p>`,\n            modal: true,\n            rejectClose: false,\n            yes: {\n              label: game.i18n.localize(\"FLASH_ROLLS.ui.dialogs.hitDie.refillAndRoll\") || \"Refill & Roll\",\n              icon: \"\"\n            },\n            no: {\n              label: game.i18n.localize(\"Cancel\") || \"Cancel\",\n              icon: \"\"\n            }\n          });\n          \n          if (dialogResult) {\n            // Refill hit dice and continue with the roll\n            const result = await RollHandlers.handleHitDieRecovery(actor);\n            LogUtil.log('Hit die recovery result', [result]);\n            \n            // Notify of refill\n            NotificationManager.notify('info', game.i18n.format(\"FLASH_ROLLS.ui.dialogs.hitDie.refilled\", { \n              actor: actor.name \n            }));\n            \n            // Get the largest available hit die after refill\n            const hdDataAfterRefill = actor.system.attributes.hd;\n            actualRollKey = hdDataAfterRefill.largestAvailable;\n            \n            if (!actualRollKey) {\n              NotificationManager.notify('warn', game.i18n.format(\"DND5E.HitDiceWarn\", { name: actor.name }));\n              return;\n            }\n          } else {\n            // User cancelled\n            return;\n          }\n        }\n      }\n      \n      // Extract situational bonus from the rolls array if present\n      const situational = rollProcessConfig.rolls?.[0]?.data?.situational || \"\";\n      \n      // Build requestData structure expected by RollHandlers\n      const requestData = {\n        rollKey: actualRollKey,\n        groupRollId: rollProcessConfig.groupRollId, // Pass through the group roll ID\n        config: {\n          ...rollProcessConfig,\n          situational: situational,\n          rollMode: rollProcessConfig.rollMode || game.settings.get(\"core\", \"rollMode\"),\n          advantage: rollProcessConfig.advantage || false,\n          disadvantage: rollProcessConfig.disadvantage || false,\n          target: rollProcessConfig.target\n        }\n      };\n      \n      // Dialog configuration\n      const dialogConfig = {\n        configure: !rollProcessConfig.fastForward && !rollProcessConfig.skipRollDialog,\n        isRollRequest: true  // Mark this as a roll request to prevent re-interception\n      };\n      \n      // Message configuration\n      const messageConfig = {\n        rollMode: rollProcessConfig.rollMode || game.settings.get(\"core\", \"rollMode\"),\n        create: rollProcessConfig.chatMessage !== false,\n        isRollRequest: true  // Mark this as a roll request to prevent re-interception\n      };\n      \n      // Pass the proper roll configuration structure\n      const rollConfig = rollProcessConfig.rolls?.[0] || {};\n      \n      // Use the roll handler for the requested roll type\n      const handler = RollHandlers[normalizedType];\n      if (handler) {\n        await handler(actor, requestData, rollConfig, dialogConfig, messageConfig);\n      } else {\n        NotificationManager.notify('warn', `Unknown roll type: ${requestType}`);\n      }\n    } catch (error) {\n      LogUtil.error('executeActorRoll', [error]);\n      NotificationManager.notify('error', game.i18n.format(\"FLASH_ROLLS.notifications.rollError\", { \n        actor: actor.name \n      }));\n    }\n  }\n\n  /**\n   * Clean up when closing\n   */\n  async _onClose(options) {\n    LogUtil.log('_onClose',[options]);\n\n    if(!this.element) { return; }\n    \n    // If menu is in custom position (in body), move it back to chat notifications before closing\n    if (this.isCustomPosition && this.element.parentElement === document.body) {\n      const chatNotifications = document.querySelector('#chat-notifications');\n      if (chatNotifications) {\n        chatNotifications.insertBefore(this.element, chatNotifications.firstChild);\n      }\n      // Clear custom positioning styles\n      this.element.style.position = '';\n      this.element.style.inset = '';\n      this.element.style.top = '';\n      this.element.style.left = '';\n      this.element.style.right = '';\n      this.element.style.bottom = '';\n      this.element.classList.remove('custom-position');\n    }\n    \n    await super._onClose(options);\n    \n    this.selectedActors.clear();\n    this.selectedRequestType = null;\n    document.removeEventListener('click', this._onClickOutside, true);\n    \n    if (this._tokenControlHook) {\n      Hooks.off(HOOKS_CORE.CONTROL_TOKEN, this._tokenControlHook);\n      this._tokenControlHook = null;\n    }\n    \n    if (this._actorUpdateHook) {\n      Hooks.off(HOOKS_CORE.UPDATE_ACTOR, this._actorUpdateHook);\n      this._actorUpdateHook = null;\n    }\n    \n    if (this._updateItemHook) {\n      Hooks.off(HOOKS_CORE.UPDATE_ITEM, this._updateItemHook);\n      this._updateItemHook = null;\n    }\n    \n    if (this._createItemHook) {\n      Hooks.off(HOOKS_CORE.CREATE_ITEM, this._createItemHook);\n      this._createItemHook = null;\n    }\n    \n    if (this._deleteItemHook) {\n      Hooks.off(HOOKS_CORE.DELETE_ITEM, this._deleteItemHook);\n      this._deleteItemHook = null;\n    }\n    \n    if (this._tokenUpdateTimeout) {\n      clearTimeout(this._tokenUpdateTimeout);\n      this._tokenUpdateTimeout = null;\n    }\n    \n    if (this._actorUpdateTimeout) {\n      clearTimeout(this._actorUpdateTimeout);\n      this._actorUpdateTimeout = null;\n    }\n    \n    if (this._itemUpdateTimeout) {\n      clearTimeout(this._itemUpdateTimeout);\n      this._itemUpdateTimeout = null;\n    }\n    \n    if (RollRequestsMenu.#instance === this) {\n      RollRequestsMenu.#instance = null;\n    }\n  }\n\n  /**\n   * Override render positioning to use CSS instead of inline styles\n   */\n  setPosition(position={}) {\n    LogUtil.log('setPosition');\n    // Don't set any inline position styles - let CSS handle it\n    return this;\n  }\n  \n  /**\n   * Show custom roll dialog\n   * @returns {Promise<string|null>} The roll formula or null if cancelled\n   */\n  async _showCustomRollDialog() {\n    LogUtil.log('_showCustomRollDialog');\n    return CustomRollDialog.prompt({\n      formula: \"\",\n      readonly: false\n    });\n  }\n\n  /**\n   * Toggle the roll requests menu open/closed\n   * @static\n   */\n  static toggle() {\n    LogUtil.log('RollRequestsMenu.toggle');\n    \n    // Clean up orphaned menu, if present\n    const existingMenus = document.querySelectorAll('#flash-rolls-menu');\n    existingMenus.forEach(menu => {\n      LogUtil.log('Removing orphaned menu element');\n      menu.remove();\n    });\n    \n    if (!this.#instance) {\n      this.#instance = new RollRequestsMenu();\n      this.#instance.render(true);\n    } else {\n      if (this.#instance.rendered) {\n        this.#instance.close();\n      } else {\n        this.#instance._initializeFromSelectedTokens();\n        this.#instance.render(true);\n      }\n    }\n  }\n}\n","import { getSettings } from \"../constants/Settings.mjs\";\nimport { SettingsUtil } from \"./SettingsUtil.mjs\";\nimport RollRequestsMenu from \"./RollRequestsMenu.mjs\";\nimport { LogUtil } from \"./LogUtil.mjs\";\n\n/**\n * Utility class for managing sidebar controls\n */\nexport class SidebarUtil {\n  /**\n   * Add the roll request bolt icon to sidebar\n   * @param {SidebarTab} app - The sidebar tab application\n   * @param {jQuery} html - The rendered HTML\n   */\n  static addSidebarControls(app, html) {\n    LogUtil.log(\"addSidebarControls\",[app, html]);\n    if (!game.user.isGM || !app || app.id !== \"sidebar\") return;\n    \n    // Find the chat controls container\n    const chatControls = document.querySelector(\"#roll-privacy\");\n    LogUtil.log(\"addSidebarControls\",[chatControls]);\n\n    if (!chatControls || chatControls.querySelector('.flash-rolls-icon')) {\n      return;\n    }\n    \n    // Get current settings to determine initial state\n    const SETTINGS = getSettings();\n    const rollRequestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    \n    // Create the roll request icon\n    const rollRequestIcon = document.createElement('button');\n    rollRequestIcon.id = \"flash-rolls-icon\"; \n    rollRequestIcon.setAttribute(\"data-tooltip-direction\", \"RIGHT\");\n    rollRequestIcon.className = `ui-control icon chat-control-icon flash-rolls-icon${rollRequestsEnabled ? ' active' : ''}`;\n    rollRequestIcon.title = game.i18n.localize('FLASH_ROLLS.ui.menus.rollRequestsTitle');\n    rollRequestIcon.innerHTML = `<i class=\"fas fa-bolt${rollRequestsEnabled ? '' : '-slash'}\"></i>`;\n    \n    // Insert before the d20 dice icon\n    const firstChatControlIcon = chatControls.firstChild;\n    if (firstChatControlIcon) {\n      firstChatControlIcon.parentNode.insertBefore(rollRequestIcon, firstChatControlIcon);\n    } else {\n      chatControls.insertBefore(rollRequestIcon, chatControls.firstChild);\n    }\n\n    LogUtil.log(\"addSidebarControls\",[firstChatControlIcon, rollRequestIcon]);\n    \n    rollRequestIcon.addEventListener(\"click\", (event) => {\n      event.stopPropagation();\n      event.preventDefault();\n      RollRequestsMenu.toggle();\n    });\n  }\n  \n  /**\n   * Update the roll requests icon based on enabled state\n   * @param {boolean} enabled - Whether roll requests are enabled\n   */\n  static updateRollRequestsIcon(enabled) {\n    const icon = document.querySelector('#flash-rolls-icon i');\n    if (icon) {\n      icon.className = `fas fa-bolt${enabled ? '' : '-slash'}`;\n    }\n  }\n}","import { HOOKS_CORE, HOOKS_DND5E, HOOKS_MIDI_QOL } from \"../constants/Hooks.mjs\";\nimport { getSettings } from \"../constants/Settings.mjs\";\nimport { SettingsUtil } from \"./SettingsUtil.mjs\";\nimport { DiceConfigUtil } from \"./DiceConfigUtil.mjs\";\nimport { RollInterceptor } from \"./RollInterceptor.mjs\";\nimport { updateSidebarClass, isSidebarExpanded } from \"./helpers/Helpers.mjs\";\nimport { SidebarUtil } from \"./SidebarUtil.mjs\";\nimport { LogUtil } from \"./LogUtil.mjs\";\nimport { ACTIVITY_TYPES, MODULE_ID } from \"../constants/General.mjs\";\nimport { GeneralUtil } from \"./helpers/GeneralUtil.mjs\";\nimport { ModuleHelpers } from \"./helpers/ModuleHelpers.mjs\";\nimport { ChatMessageUtils } from \"./ChatMessageUtils.mjs\";\n\n/**\n * Utility class for managing all module hooks in one place\n */\nexport class HooksUtil {\n  static registeredHooks = new Map();\n  static midiTimeout = null;\n  static throttleTimers = {};\n  \n  /**\n   * Initialize main module hooks\n   */\n  static initialize() {\n    Hooks.once(HOOKS_CORE.INIT, this._onInit.bind(this));\n    Hooks.once(HOOKS_CORE.READY, this._onReady.bind(this));\n  }\n  \n  /**\n   * Triggered when Foundry initializes\n   */\n  static _onInit() {\n    const SETTINGS = getSettings();\n    document.body.classList.add(\"flash5e\");\n    SettingsUtil.registerSettings();\n    DiceConfigUtil.initialize();\n    \n    this._registerHooks();\n  }\n  \n  /**\n   * Triggered when Foundry is ready (fully loaded)\n   */\n  static _onReady() {\n\n    SettingsUtil.registerSettingsMenu();\n    SidebarUtil.addSidebarControls(ui.sidebar, ui.sidebar?.element);\n    if(ModuleHelpers.isModuleActive(\"midi-qol\")){\n      LogUtil.log(\"HooksUtil.initialize\", [\"midi-qol is active. Awaiting for it to be ready...\"]);\n      Hooks.once(HOOKS_MIDI_QOL.READY, this._initModule.bind(this));\n    }else{\n      LogUtil.log(\"HooksUtil.initialize\", [\"midi-qol is NOT active. Starting...\"]);\n      this._initModule();\n    }\n  }\n\n  static async _initModule() {\n    const SETTINGS = getSettings();\n    const isDebugOn = SettingsUtil.get(SETTINGS.debugMode.tag);\n    if (isDebugOn) {\n      CONFIG.debug.hooks = true;\n    }\n\n    await ChatMessageUtils.initialize();\n\n    if (game.user.isGM) {\n      RollInterceptor.initialize();\n      this._registerGMHooks();\n    }else{\n      DiceConfigUtil.getDiceConfig();\n      this._registerPlayerHooks();\n    }\n    updateSidebarClass(isSidebarExpanded());\n  }\n  \n  /**\n   * Register D&D5e specific hooks\n   */\n  static _registerHooks() {\n    this._registerHook(HOOKS_CORE.RENDER_SIDEBAR, this._onRenderSidebar.bind(this));\n    this._registerHook(HOOKS_CORE.PRE_CREATE_CHAT_MESSAGE, this._onPreCreateChatMessage.bind(this));\n    this._registerHook(HOOKS_CORE.PRE_CREATE_CHAT_MESSAGE, this._onPreCreateChatMessageFlavor.bind(this));\n    this._registerHook(HOOKS_CORE.RENDER_CHAT_MESSAGE, this._onRenderChatMessageHTML.bind(this));\n    this._registerHook(HOOKS_CORE.CHANGE_SIDEBAR_TAB, this._onSidebarUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.COLLAPSE_SIDE_BAR, this._onSidebarUpdate.bind(this));\n    this._registerHook(HOOKS_CORE.REFRESH_MEASURED_TEMPLATE, this.onRefreshTemplate.bind(this)); \n    this._registerHook(HOOKS_DND5E.RENDER_ROLL_CONFIGURATION_DIALOG, this._onRenderRollConfigDialog.bind(this));\n    this._registerHook(HOOKS_DND5E.RENDER_SKILL_TOOL_ROLL_DIALOG, this._onRenderSkillToolDialog.bind(this));\n    this._registerHook(HOOKS_DND5E.PRE_USE_ACTIVITY, this._onPreUseActivity.bind(this));\n    this._registerHook(HOOKS_DND5E.POST_USE_ACTIVITY, this._onPostUseActivity.bind(this));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_HIT_DIE_V2, this._onPreRollHitDieV2.bind(this));\n    this._registerHook(HOOKS_DND5E.POST_ROLL_CONFIG, this._onPostRollConfig.bind(this));\n  }\n  \n  /**\n   * Register GM-specific hooks\n   */\n  static _registerGMHooks() {\n    this._registerHook(HOOKS_CORE.USER_CONNECTED, this._onUserConnected.bind(this));\n    this._registerHook(HOOKS_CORE.PRE_CREATE_CHAT_MESSAGE, this._onPreCreateChatMessageGM.bind(this));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_V2, this._onPreRoll.bind(this));\n\n    game.users.forEach(user => {\n      this._onUserConnected(user);\n    });\n  }\n\n  static _registerPlayerHooks() {\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_INITIATIVE_DIALOG, this._onPreRollInitiativeDialog.bind(this));\n    // this._registerHook(HOOKS_DND5E.PRE_CONFIGURE_INITIATIVE, this._onPreConfigureInitiative.bind(this));\n    \n    this._registerHook(HOOKS_DND5E.PRE_ROLL_ATTACK_V2, this._onPreRollAttackV2.bind(this));\n    this._registerHook(HOOKS_DND5E.PRE_ROLL_DAMAGE_V2, this._onPreRollDamageV2.bind(this));\n    Hooks.on(HOOKS_DND5E.PRE_ROLL_ABILITY_CHECK, (config, dialog, message) => {\n      LogUtil.log(\"_onPreRollAbilityCheckV2\", [config, dialog, message]);\n      if (config.isRollRequest) {\n        dialog.configure = true;\n      }\n    });\n    \n    // this._registerHook(HOOKS_DND5E.RENDER_ROLL_CONFIGURATION_DIALOG, this._onRenderRollConfigDialog.bind(this));\n  }\n\n  static _onSidebarUpdate(tab) {\n    LogUtil.log(\"_onSidebarUpdate\", [tab]);\n    updateSidebarClass(isSidebarExpanded());\n  }\n  \n  /**\n   * Handle data after roll configuration\n   */\n  static _onPostRollConfig(rolls, config, dialog, message) {\n    if (config._showRequestedBy && rolls.length > 0) {\n      message.data = message.data || {};\n      message.data._showRequestedBy = true;\n      message.data._requestedBy = config._requestedBy;\n    }\n  }\n  \n  /**\n   * Handle data before creating chat message for requested rolls\n   */\n  static _onPreCreateChatMessage(chatMessage, data, options, userId) {\n    // Handle requested by text\n    if (data._showRequestedBy && data.rolls?.length > 0) {\n      const requestedBy = data._requestedBy || 'GM';\n      const requestedText = game.i18n.format('FLASH_ROLLS.chat.requestedBy', { gm: requestedBy });\n      \n      const currentFlavor = data.flavor || '';\n      data.flavor = currentFlavor ? `${currentFlavor} ${requestedText}` : requestedText;\n    }\n    \n    // Check if we have groupRollId in the message data flags that needs to be preserved\n    if (data.flags?.[MODULE_ID]?.groupRollId) {\n      LogUtil.log('_onPreCreateChatMessage - Found groupRollId in data flags', [data]);\n    }\n    \n    // Check if this is a roll message that should be part of a group\n    if (data.rolls?.length > 0 || data.flags?.core?.initiativeRoll) {\n      const speaker = data.speaker;\n      const actorId = speaker?.actor;\n      \n      if (actorId) {\n        // Get the actor - could be a token actor\n        let actor = game.actors.get(actorId);\n        \n        // For initiative rolls, the speaker might reference a token\n        if (!actor && speaker?.token) {\n          const token = canvas.tokens.get(speaker.token);\n          if (token?.actor) {\n            actor = token.actor;\n            LogUtil.log('_onPreCreateChatMessage - Using token actor from speaker', [actor.name, actor.id]);\n          }\n        }\n        \n        if (!actor) {\n          LogUtil.log('_onPreCreateChatMessage - No actor found', [actorId, speaker]);\n          return;\n        }\n        \n        if (game.user.isGM) {\n          // GM: Check pending group rolls\n          // Need to check both the token actor ID and base actor ID\n          const baseActorId = actor.isToken ? actor.actor?.id : actor.id;\n          const checkIds = [actorId, baseActorId].filter(id => id);\n          \n          for (const [groupRollId, pendingData] of ChatMessageUtils.pendingRolls.entries()) {\n            if (checkIds.some(id => pendingData.actors.includes(id))) {\n              // This actor is part of a group roll, add the flag\n              data.flags = data.flags || {};\n              data.flags[MODULE_ID] = data.flags[MODULE_ID] || {};\n              data.flags[MODULE_ID].groupRollId = groupRollId;\n              LogUtil.log('_onPreCreateChatMessage - Added groupRollId flag (GM)', [groupRollId, actorId]);\n              break;\n            }\n          }\n        } else {\n          // Player: Check if we have a stored groupRollId for this roll\n          let storedGroupRollId = actor.getFlag(MODULE_ID, 'tempGroupRollId');\n          if (!storedGroupRollId && actor.isToken) {\n            const baseActor = game.actors.get(actor.actor?.id);\n            if (baseActor) {\n              storedGroupRollId = baseActor.getFlag(MODULE_ID, 'tempGroupRollId');\n              LogUtil.log('_onPreCreateChatMessage - Checking base actor for tempGroupRollId', [baseActor.id, storedGroupRollId]);\n            }\n          }\n          \n          if (storedGroupRollId) {\n            actor.unsetFlag(MODULE_ID, 'tempGroupRollId');\n            if (actor.isToken) {\n              const baseActor = game.actors.get(actor.actor?.id);\n              if (baseActor) {\n                baseActor.unsetFlag(MODULE_ID, 'tempGroupRollId');\n              }\n            }\n          }\n          \n          // Also check for initiative-specific stored config\n          let storedInitConfig = actor.getFlag(MODULE_ID, 'tempInitiativeConfig');\n          \n          // For token actors, also check the base actor\n          if (!storedInitConfig && actor.isToken) {\n            const baseActor = game.actors.get(actor.actor?.id);\n            if (baseActor) {\n              storedInitConfig = baseActor.getFlag(MODULE_ID, 'tempInitiativeConfig');\n              LogUtil.log('_onPreCreateChatMessage - Checking base actor for tempInitiativeConfig', [baseActor.id, storedInitConfig]);\n            }\n          }\n          \n          if (storedInitConfig?.groupRollId || storedGroupRollId) {\n            data.flags = data.flags || {};\n            data.flags[MODULE_ID] = data.flags[MODULE_ID] || {};\n            data.flags[MODULE_ID].groupRollId = storedGroupRollId || storedInitConfig.groupRollId;\n            LogUtil.log('_onPreCreateChatMessage - Added groupRollId flag from initiative config', [storedInitConfig.groupRollId, actorId]);\n          }\n        }\n      }\n    }\n  }\n  \n  /**\n   * Handle flavor data before creating chat message\n   */\n  static _onPreCreateChatMessageFlavor(message, data, options, userId) {\n    if (data.rolls?.length > 0 && data.rolls[0]) {\n      try {\n        const rollData = data.rolls[0];\n        if (rollData.options?._customFlavor) {\n          data.flavor = rollData.options._customFlavor;\n        }\n      } catch (error) {\n        LogUtil.error(\"_onPreCreateChatMessageFlavor\", [error]);\n      }\n    }\n  }\n  \n  /**\n   * Triggered whenever roll configuration dialog is rendered. \n   * Used to add custom situational bonus from data, since the default DnD5e dialog does not seem to handle that\n   */\n  static _onRenderRollConfigDialog(app, html, data) {\n    LogUtil.log(\"_onRenderRollConfigDialog #0\", [ app, data ]);\n    if (app._flashRollsApplied) return;\n    \n    // Check if this is an initiative roll\n    const isInitiativeRoll = app.config?.hookNames?.includes('initiativeDialog') || \n                           app.element?.id?.includes('initiative');\n    \n    if (isInitiativeRoll) {\n      const actor = app.config?.subject;\n      if (!actor) return;\n      \n      const storedConfig = actor.getFlag(MODULE_ID, 'tempInitiativeConfig');      \n      if (storedConfig) {\n        app._flashRollsApplied = true;\n\n        // Trigger change event after a short delay\n        const situationalInput = html.querySelector('input[name*=\"situational\"]');\n        setTimeout(() => {\n          situationalInput.dispatchEvent(new Event('change', {\n            bubbles: true,\n            cancelable: false\n          }));\n        }, 50);\n      }\n      \n      return;\n    }else{\n      const situationalInputs = html.querySelectorAll('input[name*=\"situational\"]');\n      \n      situationalInputs.forEach((input, index) => { \n        if (!input.value && app.config?.rolls?.[0]?.data?.situational) {\n          input.value = app.config.rolls[0].data.situational;\n        }\n        LogUtil.log(\"_onRenderRollConfigDialog #1\", [input.value, app.config.rolls[0]]);\n        \n        if (input.value) {\n          app._flashRollsApplied = true;\n          \n          setTimeout(() => {\n            input.dispatchEvent(new Event('change', {\n              bubbles: true,\n              cancelable: false\n            }));\n\n            if (app.config?.rolls?.[0]?.data) {\n              delete app.config.rolls[0].data.situational;\n            }\n          }, 50);\n        }\n      });\n    }\n    \n  }\n  \n  /**\n   * Intercept group roll message creation (GM only) - currently unused\n   */\n  static _onPreCreateChatMessageGM(message, data, options, userId) {\n    LogUtil.log(\"_onPreCreateChatMessageGM\", [message, data, options, userId]);\n  }\n  \n  /**\n   * Intercept rendered chat messages to handle group rolls\n   */\n  static _onRenderChatMessageHTML(message, html, context) {\n    LogUtil.log(\"_onRenderChatMessageHTML\", [message, html, context]);\n    ChatMessageUtils.interceptRollMessage(message, html, context);\n    \n    this._addSelectTargetsButton(message, html);\n  }\n  \n  /**\n   * Add \"Select Targeted\" button to damage roll messages with saves\n   * @param {ChatMessage} message - The chat message\n   * @param {jQuery} html - The rendered HTML\n   */\n  static _addSelectTargetsButton(message, html) {\n    LogUtil.log(\"_addSelectTargetsButton #0\", [message, html, html.querySelector('.message-content')]);\n    // const content = html.querySelector('.message-content');\n    if (message.flags?.dnd5e?.roll?.type !== 'damage' || html.querySelector('.select-targeted')) return;\n    \n    const button = document.createElement('button');\n    button.className = 'select-targeted';\n    button.type = 'button';\n    button.setAttribute(\"data-tooltip-direction\", \"LEFT\");\n    button.setAttribute(\"data-tooltip\", \"Select Targeted\");\n    button.innerHTML = '<i class=\"fas fa-crosshairs\"></i>';\n    \n    button.addEventListener('click', (event) => {\n      event.preventDefault();\n      this._selectTargetedTokens(event);\n    });\n    \n    html.querySelector('.message-content').appendChild(button);\n    message.update({\n      content: html\n    });\n  }\n  \n  /**\n   * Select all currently targeted tokens as damage targets\n   * @param {ChatMessage} message - The chat message\n   */\n  static _selectTargetedTokens(event) {\n    const message = event.currentTarget.closest('.chat-message');\n    const targets = message.querySelectorAll(\"[data-target-uuid]\");\n    \n    if (targets.length === 0) {\n      ui.notifications.warn(game.i18n.localize(\"FLASH_ROLLS.notifications.noTargetedTokens\"));\n      return;\n    }\n\n    LogUtil.log(\"_selectTargetedTokens\", [message, targets, canvas.tokens.placeables, game.scenes.active]);\n    for ( let i=0; i < targets.length; i++ ) {\n      const target = targets[i];\n      const actorId = target.dataset.targetUuid.split('Actor.')[1];\n      const token = canvas.tokens.placeables.find(t => {\n        return t.document.actorId === actorId;\n      });\n      token?.control({ releaseOthers: i===0 });\n    }\n  }\n  \n  /**\n   * Request dice configuration from the connected user\n   */\n  static _onUserConnected(user) {\n    if (user.active && user.id !== game.user.id) {\n      DiceConfigUtil.requestDiceConfigFromUser(user.id);\n    }\n  }\n\n  /**\n   * Handle render ApplicationV2\n   */\n  static _onRenderApplicationV2(app, html, options) {\n    LogUtil.log(\"_onRenderApplicationV2\", [app, html, options]);\n  }\n  \n  /**\n   * Handle render Sidebar\n   */\n  static _onRenderSidebar(app, html, options) {\n    LogUtil.log(\"_onRenderSidebar\", [app, html]);\n    if(game.ready){\n      SidebarUtil.addSidebarControls(app, html);\n    }\n  }\n  \n  /**\n   * Register a hook and track it\n   * @param {string} hookName - The hook name\n   * @param {Function} handler - The handler function\n   * @private\n   */\n  static _registerHook(hookName, handler) {\n    const hookId = Hooks.on(hookName, handler);\n    this.registeredHooks.set(`${hookName}_${hookId}`, hookId);\n    return hookId;\n  }\n  \n  /**\n   * Unregister all hooks (for cleanup)\n   */\n  static unregisterAll() {\n    this.registeredHooks.forEach((hookId, key) => {\n      const hookName = key.split('_')[0];\n      Hooks.off(hookName, hookId);\n    });\n    this.registeredHooks.clear();\n  }\n  \n  /**\n   * Check if a hook is registered\n   * @param {string} hookName - The hook name to check\n   * @returns {boolean}\n   */\n  static isRegistered(hookName) {\n    for (const key of this.registeredHooks.keys()) {\n      if (key.startsWith(`${hookName}_`)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Triggered before a roll is made\n   * @param {*} config \n   * @param {*} dialogOptions \n   * @param {*} messageOptions \n   */\n  static _onPreRoll(config, dialogOptions, messageOptions, d) {\n    LogUtil.log(\"_onPreRoll #0\", [config, dialogOptions, messageOptions, d]);\n    \n  }\n  \n  /**\n   * Actor5e.rollHitDie concatenates our roll data with its own roll data, creating two rolls.\n   * We fix this behavior here so situational bonus is added correctly without duplicating rolls\n   */\n  static _onPreRollHitDieV2(config, dialogOptions, messageOptions) {\n    LogUtil.log(\"_onPreRollHitDieV2 triggered\", [config, dialogOptions, messageOptions]);\n    \n    if (config.rolls && config.rolls.length > 1) {\n      // Collect all situational bonuses from ALL rolls\n      const allSituationalBonuses = [];\n      \n      // Check all rolls for situational bonuses\n      for(let i = 0; i < config.rolls.length; i++){\n        const roll = config.rolls[i];\n        if (roll && roll.data && roll.data.situational) {\n          allSituationalBonuses.push(roll.data.situational);\n        }\n      }\n      \n      // If we have situational bonuses to consolidate\n      if (allSituationalBonuses.length > 0) {\n        if (!config.rolls[0].data) {\n          config.rolls[0].data = {};\n        }\n        \n        // Combine all unique situational bonuses\n        const uniqueBonuses = [...new Set(allSituationalBonuses)];\n        \n        // Format and combine the bonuses\n        config.rolls[0].data.situational = uniqueBonuses.map(bonus => {\n          const trimmedBonus = bonus.toString().trim();\n          if (trimmedBonus.startsWith('-')) {\n            return `(${trimmedBonus})`;\n          } else if (trimmedBonus.startsWith('+')) {\n            return `${trimmedBonus.substring(1)}`;\n          } else {\n            return `${trimmedBonus}`;\n          }\n        }).join(' + ');\n        \n        // Ensure @situational is in parts array only once\n        if(game.user.isGM && !config.rolls[0].parts.find(p => p.includes(\"@situational\"))){\n          config.rolls[0].parts.push(\"@situational\");\n        }\n      }\n      \n      // Keep only the first valid roll\n      config.rolls = config.rolls.slice(0, 1);\n      \n      LogUtil.log(\"Cleaned up hit die rolls\", config.rolls);\n    }\n  }\n  \n  /**\n   * Handle pre-roll initiative dialog hook to add situational bonus\n   */\n  static _onPreRollInitiativeDialog(config, dialogOptions, messageOptions) {\n    \n    // Check if actor has stored situational bonus\n    const actor = config.subject;\n    const storedConfig = actor.getFlag(MODULE_ID, 'tempInitiativeConfig');\n\n\n    LogUtil.log(\"_onPreRollInitiativeDialog triggered\", [config, storedConfig, dialogOptions, messageOptions]);\n    // Apply advantage/disadvantage to the app config\n    config.advantage = storedConfig?.advantage || config.advantage || false;\n    config.disadvantage = storedConfig?.disadvantage || config.disadvantage || false;\n    \n    config.rollMode = storedConfig?.rollMode || config.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n    messageOptions.rollMode = storedConfig?.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n    \n    if (storedConfig.rolls?.[0]?.data?.situational && config.rolls?.[0]?.data) {\n      config.rolls[0].data.situational = storedConfig.rolls[0].data.situational;\n    }\n\n    // // Apply the situational bonus from stored rolls\n    // if (storedConfig.rolls?.[0]?.data?.situational) {\n    //   const situationalInputs = html.querySelectorAll('input[name*=\"situational\"]');\n    //   situationalInputs.forEach(input => {\n    //     if (!input.value) {\n    //       input.value = storedConfig.rolls[0].data.situational;\n    //     }\n    //   });\n    // }\n    \n    // if (actor && actor._initiativeSituationalBonus) {\n    //   if (!config.rolls || config.rolls.length === 0) {\n    //     const initiativeConfig = actor.getInitiativeRollConfig({});\n    //     config.rolls = initiativeConfig.rolls || [];\n    //   }\n      \n    //   // Add situational bonus\n    //   if (config.rolls.length > 0) {\n    //     if (!config.rolls[0].data) {\n    //       config.rolls[0].data = {};\n    //     }\n    //     config.rolls[0].data.situational = actor._initiativeSituationalBonus;\n        \n    //     LogUtil.log(\"Added situational bonus to initiative dialog\", [{\n    //       bonus: actor._initiativeSituationalBonus,\n    //       rolls: config.rolls\n    //     }]);\n        \n    //     // Clean up the temporary storage\n    //     delete actor._initiativeSituationalBonus;\n    //   }\n    // }\n  \n  }\n  \n  /**\n   * Handle pre-roll attack hook to restore GM-configured options\n   */\n  static _onPreRollAttackV2(config, dialogOptions, messageOptions) {\n    LogUtil.log(\"_onPreRollAttackV2 triggered\", [config, dialogOptions, messageOptions]);\n    \n    const stored = config.subject?.item?.getFlag(MODULE_ID, 'tempAttackConfig');\n    if (stored) {\n      LogUtil.log(\"_onPreRollAttackV2 - Found stored request config from flag\", [stored]);\n      \n      if(stored.isRollRequest === false || stored.skipRollDialog === true || stored.sendRequest === false) {\n        LogUtil.log(\"_onPreRollAttackV2 - Not a roll request, skipping\", [stored]);\n        return;\n      }\n\n      // Merge attack options\n      if (stored.attackMode) config.attackMode = stored.attackMode;\n      if (stored.ammunition) config.ammunition = stored.ammunition;\n      if (stored.mastery !== undefined) config.mastery = stored.mastery;\n      config.advantage = stored.advantage || false;\n      config.disadvantage = stored.disadvantage || false;\n      messageOptions.rollMode = stored.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n      \n      // Set situational bonus\n      if (stored.situational) {\n        if (!config.rolls || config.rolls.length === 0) {\n          config.rolls = [{\n            parts: [],\n            data: {},\n            options: {}\n          }];\n        }\n        \n        if (!config.rolls[0].data) {\n          config.rolls[0].data = {};\n        }\n        config.rolls[0].data.situational = stored.situational;\n      }\n      LogUtil.log(\"_onPreRollAttackV2 - Applied stored configuration to attack roll\", [config, messageOptions]);\n    }\n  }\n\n  /**\n   * Handle pre-roll damage hook to restore GM-configured options\n   */\n  static _onPreRollDamageV2(config, dialogOptions, messageOptions) {\n    LogUtil.log(\"_onPreRollDamageV2 triggered\", [config, dialogOptions, messageOptions]);\n    \n    const stored = config.subject?.item?.getFlag(MODULE_ID, 'tempDamageConfig');\n    if (stored) {\n      LogUtil.log(\"_onPreRollDamageV2 - Found stored request config from flag\", [stored, stored.situational]);\n      \n      if(stored.isRollRequest === false || stored.skipRollDialog === true || stored.sendRequest === false) {\n        LogUtil.log(\"_onPreRollDamageV2 - Not a roll request, skipping\", [stored]);\n        return;\n      }\n\n      // Merge damage options\n      if (stored.critical) config.critical = stored.critical;\n      messageOptions.rollMode = stored.rollMode || messageOptions.rollMode || CONST.DICE_ROLL_MODES.PUBLIC;\n      \n      // Set situational bonus\n      if (stored.situational) {\n        if (!config.rolls || config.rolls.length === 0) {\n          config.rolls = [{\n            parts: [],\n            data: {},\n            options: {}\n          }];\n        }\n        \n        if (!config.rolls[0].data) {\n          config.rolls[0].data = {};\n        }\n        config.rolls[0].data.situational = stored.situational;\n      }\n      LogUtil.log(\"_onPreRollDamageV2 - Applied stored configuration to damage roll\", [config, messageOptions]);\n    }\n  }\n  \n  /**\n   * Handle pre-use activity hook to prevent usage messages when GM intercepts rolls\n   */\n  static _onPreUseActivity(activity, config, dialog, message) {\n    LogUtil.log(\"_onPreUseActivity triggered\", [activity, config, dialog, message]);\n    const SETTINGS = getSettings();\n    const requestsEnabled = SettingsUtil.get(SETTINGS.rollRequestsEnabled.tag);\n    const rollInterceptionEnabled = SettingsUtil.get(SETTINGS.rollInterceptionEnabled.tag);\n\n    LogUtil.log(\"_onPreUseActivity - Settings\", [requestsEnabled, rollInterceptionEnabled]);\n    activity.item.unsetFlag(MODULE_ID, 'tempAttackConfig'); \n    activity.item.unsetFlag(MODULE_ID, 'tempDamageConfig'); \n    activity.item.unsetFlag(MODULE_ID, 'tempSaveConfig'); \n\n    if(GeneralUtil.isModuleOn(MODULE_ID, 'midi-qol')){\n      // message.create = false;\n    }\n    if (!game.user.isGM || !requestsEnabled || !rollInterceptionEnabled) return; \n    \n    // Check if the actor has player ownership\n    const actor = activity.actor;\n    if (!actor) return;\n\n    const consumptionConfigMode = SettingsUtil.get(SETTINGS.consumptionConfigMode.tag);\n\n    switch (consumptionConfigMode) {\n      case 1:\n        dialog.configure = false;\n        break;\n      case 2:\n        dialog.configure = game.user.isGM;\n        break;\n      case 3:\n        dialog.configure = !game.user.isGM;\n        break;\n      default:\n        dialog.configure = true;\n        break;\n    }\n    \n    // const hasPlayerOwner = Object.entries(actor.ownership).some(([userId, level]) => {\n    //   const user = game.users.get(userId);\n    //   return user && !user.isGM && level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n    // });\n\n    // if(activity.type === ACTIVITY_TYPES.SAVE){\n    //   config.create = { measuredTemplate: true };\n    //   config.hasConsumption = false;\n    //   config.consume = {\n    //     action: false,\n    //     resources: [],\n    //     spellSlot: false\n    //   };\n    // }\n\n    const actorOwner = GeneralUtil.getActorOwner(actor);\n    \n    if (actorOwner && actorOwner.active && !actorOwner.isGM) {\n      LogUtil.log(\"Preventing usage message for player-owned actor\", [actor.name]);\n      message.create = false;\n    }\n  }\n\n  static _onPostUseActivity(activity, config, dialog, message) {\n    if(game.user.isGM && activity.type === ACTIVITY_TYPES.SAVE){\n      LogUtil.log(\"_onPostUseActivity triggered\", [activity.damage]);\n      const SETTINGS = getSettings();\n      const skipRollDialog = SettingsUtil.get(SETTINGS.skipRollDialog.tag);\n      if(activity.damage && activity.damage.parts?.length > 0){\n        activity.rollDamage(config, {\n          ...dialog,\n          configure: !skipRollDialog\n        }, message)\n      }\n      \n    }\n  }\n  \n  /**\n   * Handle rendering of skill/tool configuration dialog to fix message flavor\n   */\n  static _onRenderSkillToolDialog(app, html, data) {\n    LogUtil.log(\"_onRenderSkillToolDialog triggered\", [app]);\n    if (app._abilityFlavorFixed) return;\n    \n    const abilitySelect = html.querySelector('select[name=\"ability\"]');\n    if (!abilitySelect) return;\n    \n    if (app.config?.isRollRequest && app.config?.ability) {\n      const selectedAbility = abilitySelect.value;\n      const configAbility = app.config.ability;\n\n      if (selectedAbility === configAbility) {\n        app._abilityFlavorFixed = true;\n        \n        // Force flavor to update\n        setTimeout(() => {\n          const changeEvent = new Event('change', {\n            bubbles: true,\n            cancelable: true\n          });\n          abilitySelect.dispatchEvent(changeEvent);\n        }, 50);\n      }\n    }\n  }\n\n  /**\n   * TEMPLATES\n   */\n  static onRefreshTemplate(template, options) {\n    if(!template.isOwner){ return; }\n    const throttleKey = `refresh-template-${template.id}`;\n    const SETTINGS = getSettings();\n    const targettingSetting = SettingsUtil.get(SETTINGS.templateAutoTarget.tag);\n    \n    if (HooksUtil.throttleTimers[throttleKey]) {\n      clearTimeout(HooksUtil.throttleTimers[throttleKey]);\n    }\n\n    HooksUtil.throttleTimers[throttleKey] = setTimeout(() => {\n      let maxDisposition = 3;\n\n      switch(targettingSetting){\n        case 1:\n          maxDisposition = 3; break;\n        case 2: \n          maxDisposition = 0; break;\n        default: \n          return;\n      }\n\n      game.user.targets.forEach(t => t.setTarget(false, { releaseOthers: false }));\n      \n      const tokensToTarget = [];\n      for(let token of canvas.tokens.placeables){\n        if(token.document.disposition <= maxDisposition && template.shape.contains(token.center.x-template.x,token.center.y-template.y)){\n          tokensToTarget.push(token);\n        }\n      }\n      \n      tokensToTarget.forEach((token, i) => {\n        token.setTarget(true, { \n          releaseOthers: i === 0,  // Only release others on first token\n          groupSelection: true \n        });\n      });\n      \n      if (tokensToTarget.length > 0) {\n        game.user.broadcastActivity({ targets: game.user.targets.ids });\n      }\n      \n      delete HooksUtil.throttleTimers[throttleKey];\n    }, 50);\n  }\n  \n}","import { MODULE_ID, ROLL_TYPES } from \"../constants/General.mjs\";\nimport { getRollTypeDisplay, applyTargetTokens, NotificationManager } from \"./helpers/Helpers.mjs\";\nimport { RollHandlers } from \"./RollHandlers.mjs\";\nimport { LogUtil } from \"./LogUtil.mjs\";\nimport { getSettings } from \"../constants/Settings.mjs\";\nimport { SettingsUtil } from \"./SettingsUtil.mjs\";\nimport { GeneralUtil } from \"./helpers/GeneralUtil.mjs\";\n\n/**\n * @typedef {Object} RollRequestData\n * @property {string} type - \"rollRequest\"\n * @property {string} requestId - Unique identifier for this request\n * @property {string} actorId - ID of the actor to roll for\n * @property {string} rollType - Type of roll (ability, save, skill, etc.) from ROLL_TYPES\n * @property {string} rollKey - Specific roll key (e.g., \"str\", \"acr\", \"perception\")\n * @property {string|null} activityId - Activity ID for item-based rolls\n * @property {BasicRollProcessConfiguration} rollProcessConfig - D&D5e roll process configuration\n * @property {boolean} skipRollDialog - Whether to skip the roll configuration dialog\n * @property {string[]} targetTokenIds - Array of targeted token IDs\n * @property {boolean} preserveTargets - Whether to apply GM's targets to the player\n */\n\n/**\n * Utility class for handling roll requests from GM to players\n */\nexport class RollRequestUtil {\n  /**\n   * Handle roll request from GM on player side\n   * @param {RollRequestData} requestData - The roll request data\n   */\n  static async handleRequest(requestData) {\n    const isMidiRequest = GeneralUtil.isModuleOn(MODULE_ID, 'midi-qol');\n    LogUtil.log('handleRequest', [requestData]);\n    if (game.user.isGM) return;\n    \n    const actor = game.actors.get(requestData.actorId);\n    if (!actor || !actor.isOwner) {\n      return;\n    }\n\n    if(isMidiRequest && requestData.rollProcessConfig.midiOptions){\n      requestData.rollProcessConfig.midiOptions = {\n        ...requestData.rollProcessConfig.midiOptions,\n        fastForward: false,\n        fastForwardAttack: false,\n        dialogOptions: {\n          ...requestData.rollProcessConfig.midiOptions.dialogOptions,\n          fastForward: false,\n          fastForwardAttack: false,\n          // fastForwardDamage: false\n        },\n        workflowOptions: {\n          ...requestData.rollProcessConfig.midiOptions.workflowOptions,\n          // autoRollAttack: false,\n          // autoRollDamage: \"none\",\n          fastForward: false,\n          fastForwardAttack: false,\n          // fastForwardDamage: false\n        }\n      };\n    }\n    \n    \n    if (requestData.preserveTargets && \n      requestData.targetTokenIds?.length > 0 && \n      game.user.targets.size === 0) {\n      applyTargetTokens(requestData.targetTokenIds);\n    }\n    \n    NotificationManager.notify('info', '', {\n      batch: true,\n      batchData: {\n        actor: actor.name,\n        rollType: requestData.rollType,\n        rollKey: requestData.rollKey,\n        gm: requestData.rollProcessConfig._requestedBy || 'GM'\n      }\n    });\n    \n    RollRequestUtil.executePlayerRollRequest(actor, requestData);\n  }\n  \n  /**\n   * Execute a roll request received by a player\n   * @param {Actor} actor - The actor performing the roll\n   * @param {RollRequestData} requestData - The roll request data from GM\n   */\n  static async executePlayerRollRequest(actor, requestData) {\n    const SETTINGS = getSettings();\n    const publicPlayerRolls = SettingsUtil.get(SETTINGS.publicPlayerRolls.tag);\n\n    LogUtil.log('executePlayerRollRequest', [actor, requestData]);\n    \n    try {\n      const normalizedRollType = requestData.rollType?.toLowerCase();\n      const rollConfig = requestData.rollProcessConfig.rolls?.[0] || {\n        parts: [],\n        data: {},\n        options: {}\n      };\n      \n      const shouldSkipDialog = game.user.isGM ? requestData.skipRollDialog : false;\n      const dialogConfig = {\n        configure: !shouldSkipDialog\n      };\n      \n      // Determine the roll mode - respect what was sent from GM\n      const rollModeFromGM = requestData.rollProcessConfig.rollMode;\n      const defaultRollMode = game.settings.get(\"core\", \"rollMode\");\n      const finalRollMode = rollModeFromGM || defaultRollMode;\n      \n      const messageConfig = {\n        rollMode: finalRollMode,\n        create: requestData.rollProcessConfig.chatMessage !== false\n      };\n      \n      // Build requestData structure expected by handlers\n      const handlerRequestData = {\n        rollKey: requestData.rollKey,\n        activityId: requestData.activityId, // For attack/damage rolls\n        config: requestData.rollProcessConfig,\n        groupRollId: requestData.groupRollId // Pass through for group rolls\n      };\n\n      // Use the roll handler for the requested roll type\n      const handler = RollHandlers[normalizedRollType];\n      if (handler) {\n        await handler(actor, handlerRequestData, rollConfig, dialogConfig, messageConfig);\n      } else {\n        LogUtil.warn(`No handler found for roll type: ${normalizedRollType}`);\n        NotificationManager.notify('warn', game.i18n.format('FLASH_ROLLS.notifications.rollError', { \n          actor: actor.name || 'Unknown Actor'\n        }));\n      }\n    } catch (error) {\n      LogUtil.error('Error executing roll request:', [error]);\n      NotificationManager.notify('error', game.i18n.format('FLASH_ROLLS.notifications.rollError', { \n        actor: actor.name || 'Unknown Actor'\n      }));\n    }\n  }\n}","import { getSettings } from \"../constants/Settings.mjs\";\nimport { SOCKET_CALLS } from \"../constants/General.mjs\";\nimport { SocketUtil } from \"./SocketUtil.mjs\";\nimport { DiceConfigUtil } from \"./DiceConfigUtil.mjs\";\nimport { HooksUtil } from \"./HooksUtil.mjs\";\nimport { SettingsUtil } from \"./SettingsUtil.mjs\";\nimport { RollRequestUtil } from \"./RollRequestUtil.mjs\";\nimport { LogUtil } from \"./LogUtil.mjs\";\nimport { HOOKS_CORE } from \"../constants/Hooks.mjs\";\n\n/**\n * @typedef {import(\"./RollRequestUtil.mjs\").RollRequestData} RollRequestData\n */\n\n/**\n * Main class handling core module initialization and setup\n * Manages module lifecycle, hooks, and core functionality\n */\nexport class Main {\n  /**\n   * Initialize the module and set up core hooks\n   * @static\n   */\n  static init(){\n    SocketUtil.initialize(Main.registerSocketCalls);\n    HooksUtil.initialize();\n  }\n\n  // Wrapper methods for socket calls to DiceConfigUtil\n  static getDiceConfig() {\n    return DiceConfigUtil.getDiceConfig();\n  }\n  \n  static receiveDiceConfig(userId, diceConfig) {\n    DiceConfigUtil.receiveDiceConfig(userId, diceConfig);\n  }\n\n  /**\n   * Handle roll request from GM on player side\n   * @param {RollRequestData} requestData - The roll request data\n   */\n  static async handleRollRequest(requestData) {\n    LogUtil.log('Main.handleRollRequest', requestData);\n    return RollRequestUtil.handleRequest(requestData);\n  }\n\n  /**\n   * Register methods with socketlib for remote execution\n   */\n  static registerSocketCalls() {\n    SocketUtil.registerCall(SOCKET_CALLS.getDiceConfig, Main.getDiceConfig);\n    SocketUtil.registerCall(SOCKET_CALLS.receiveDiceConfig, Main.receiveDiceConfig);\n    SocketUtil.registerCall(SOCKET_CALLS.handleRollRequest, Main.handleRollRequest);\n  }\n}\n","import \"./styles/vars.css\";\nimport \"./styles/main.css\";\nimport \"./styles/chat-messages.css\";\nimport \"./styles/flash-rolls-menu.css\";\n\nimport { Main } from \"./components/Main.mjs\";\n\n// Initialize the module\nMain.init();\n"],"names":["SETTING_INPUT","SETTING_SCOPE","getSettings","MODULE_ID","DEBUG_TAG","SOCKET_CALLS","ACTIVITY_TYPES","ROLL_TYPES","ROLL_REQUEST_OPTIONS","MODULE","HOOKS_CORE","HOOKS_SOCKET","HOOKS_MIDI_QOL","HOOKS_DND5E","_LogUtil","ref","data","bypassSettings","debugSetting","dataArray","strRef","options","_a","__publicField","LogUtil","_SocketUtil","hasRolls","r","result","rolls","roll","callbackFunc","name","func","value","callback","handler","parameters","userId","executionKey","resp","error","SocketUtil","DiceConfigUtil","clientSettings","diceConfig","_b","user","_GeneralUtil_static","parseCSS_fn","GeneralUtil","moduleName","module","parent","selector","element","delay","varName","varValue","bodyStyle","body","cssText","ruleStart","ruleEnd","declarations","decl","varsMap","parts","newRuleContent","newCss","offsetTop","elementHeight","foundryFonts","customFontsObj","customFonts","fontFamily","cssImportedFonts","f","a","b","content","id","checkForDuplicates","customStyle","importRegex","imports","contentWithoutImports","match","currentContent","existingImports","currentMatch","currentContentWithoutImports","newImports","imp","allImports","to","direction","duration","onComplete","animationId","isHorizontal","start","change","startTime","animateScroll","currentTime","elapsedTime","progress","easeProgress","newAnimationId","title","dialogConfig","templatePath","templatePaths","cssString","trimmedCSS","style","testCSS","isValid","cssRules","targetSelectors","parsedCSS","__privateMethod","mainStyle","processedRules","rulesByContent","rule","pseudoSelector","combinedSelectors","s","selectors","targetList","nestedSelector","targetSelector","actor","ownership","level","css","baseProperties","nestedRules","lines","currentNested","braceCount","i","line","openBraces","closeBraces","contentAfterBrace","__privateAdd","fontName","cleanName","FormDataExtended","ApplicationV2","HandlebarsApplicationMixin","_element","_activeTab","_requireReload","_ModuleSettingsMenu_static","onSubmit_fn","onReset_fn","getTabs_fn","_ModuleSettingsMenu","context","__privateSet","hintToggles","__privateGet","toggle","p","select","currentValue","option","restrictedTabs","tab","partId","_c","partContext","getSettingMenus","partKey","menuContext","menuKey","SETTINGS","fieldNames","fields","fieldValues","fieldDefaults","fieldName","SettingsUtil","entry","index","formData","confirmReload","activeTab","settings","currSetting","group","event","form","activeContent","defaults","inputField","tabList","key","ModuleSettingsMenu","setting","settingObj","tabbedMenu","tabbedMenuData","tabbedMenuObj","settingName","selectedSetting","newValue","e","requestsIcon","GMRollConfigMixin","Base","config","message","abilityFromForm","dcFromForm","situational","idx","dcValue","formConfig","sendRequestCheckbox","dcInput","action","finalizedRolls","getRollTypeDisplay","rollType","rollKey","_d","_e","display","normalizedRollType","toolData","toolItem","showBatchedNotifications","pendingNotifications","getRollTypeDisplayFn","notificationsByType","notif","entries","messages","rollTypeDisplay","actorNames","getPlayerOwner","applyTargetTokens","tokenIds","t","isPlayerOwned","hasTokenInScene","currentScene","token","updateCanvasTokenSelection","actorId","selected","tokens","ms","resolve","isSidebarExpanded","updateSidebarClass","isExpanded","adjustMenuOffset","buildRollTypes","selectedRequestType","selectedActors","rollTypes","selectedOption","firstActorId","allTools","label","str","rollData","configData","_NotificationManager","type","requestsByPlayer","rollTypeName","successfulRequests","playerData","playerSummaries","playerId","NotificationManager","filterActorsForDeathSaves","actors","actorsNeedingDeathSaves","actorsSkippingDeathSaves","hp","deathSaves","successes","failures","categorizeActorsByOwnership","pcActors","npcActors","owner","rollPrivacyVertical","controlsWidth","RollHelpers","requestData","rollConfig","additionalConfig","normalizedType","rollMode","DialogClass","messageConfig","dialogOptions","app","_f","firstRoll","advantage","disadvantage","target","rollProcessConfig","isPublicRollsOn","messageRollMode","playerOwner","rollResults","dc","halfThreshold","sum","acc","average","highestModifier","leaderActorId","leaderModifier","modifier","leaderResult","otherResults","adjustedResult","lowestModifier","weakestActorId","weakestModifierValue","weakestResult","successWord","_g","tool","resultMode","calculationResult","GMRollConfigDialog","dialog","configSection","templateData","template","wrapper","button","_h","_i","showDC","rollClass","defaultAbility","finalTitle","selectedAbilityLabel","skillLabel","toolLabel","_j","_k","_l","_m","skill","abilityLabel","saveAbility","checkAbility","toolDefaultAbility","toolAbilityLabel","GMHitDieConfigDialog","GMSkillToolConfigDialog","skillConfig","GMDamageConfigDialog","buttonGroup","originalConfig","originalDialog","position","finalRollMode","GMAttackConfigDialog","_ModuleHelpers","moduleId","previousSettings","ModuleHelpers","ActivityUtil","item","activities","attackActivities","damageAttackActivities","damageActivities","saveActivities","itemSaveActivities","activityType","itemId","activityId","isMidiActive","activity","damageConfig","rollRequestConfig","MidiQOL","workflow","damageRoll","formulas","part","defaultConfig","defaultOptions","CustomRollDialog","htmlElement","formulaInput","validationMessage","messageElement","die","currentFormula","diceRegex","diceMap","remainingFormula","count","dieType","newDieType","diceParts","formula","ChatMessageUtils","attachGroupRollListeners","html","actorResult","diceBtn","dataset","groupRollId","RollHandlers","rollMethod","dcControl","showToPlayers","groupFooterDetails","debounceTimer","handleDCChange","newDC","messageId","targetMessage","hasPlayerOwnedActor","flavor","results","supportsDC","showDCToPlayers","saveLabel","skillAbility","skillAbilityLabel","messageData","pendingData","m","flagData","resultIndex","groupResult","newContent","groupMessage","msgId","requestId","groupRollsMsgEnabled","fiveMinutesAgo","toolConfig","tokenActor","initiativeConfig","tempConfig","rollOptions","processConfig","activityConfig","confirmedFormula","updateResult","itemUpdateResult","ensureCombatForInitiative","filterActorsForInitiative","actorIds","game","actorsNamesWithInitiative","actorIdsWithInitiative","c","combatants","filteredIds","RollInterceptor","hookName","hookId","hookNames","isInitiativeRoll","moduleFlags","d","skipRollDialog","rollRequestsEnabled","finalConfig","dialogResult","_n","handlerMap","cleanConfig","RollMenuActorUtil","system","stats","spellDC","selectedActorIds","currentTab","isPC","isNPC","RollMenuConfigUtil","rollMethodName","RollMenuOrchestrationUtil","offlinePlayerActors","onlinePlayerActors","allActors","useGroupId","gmRolledActors","requestType","suppressNotification","hdData","hitDieResult","rollTypeKey","normalizedRollTypeKey","actualRollKey","denominations","denom","RollMenuDragUtil","menu","dragHandle","menuRect","startX","startY","initialLeft","initialTop","dragData","handleMove","handleUp","deltaX","deltaY","remInPixels","moveHandler","upHandler","chatNotifications","lightningBolt","boltRect","horizontalDistance","distanceFromBottom","_instance","_RollRequestsMenu","actorData","currentActors","selectAllOn","shouldPrepareRequestTypes","requestTypes","frame","customPosition","optionsToggle","optionsElement","controlled","changes","uid","scene","selectBtn","searchInput","accordion","requestTypesContainer","requestHeader","requestItem","customEvent","subItem","enabled","SidebarUtil","skip","isEnabled","selectAll","showOnlyPCsWithToken","lockIcon","optionsToggleContainer","controlledTokens","selectAllCheckbox","checkboxes","checkedCount","cb","searchTerm","requestName","subItems","hasVisibleSubItems","isVisible","categoryMatches","shouldShowCategory","nestedList","accordionToggle","rollOption","filteredActorIds","RollRequestsMenu","chatControls","rollRequestIcon","firstChatControlIcon","icon","_HooksUtil","chatMessage","requestedBy","requestedText","currentFlavor","speaker","baseActorId","checkIds","storedGroupRollId","baseActor","storedInitConfig","situationalInput","input","targets","messageOptions","allSituationalBonuses","uniqueBonuses","bonus","trimmedBonus","storedConfig","stored","requestsEnabled","rollInterceptionEnabled","actorOwner","abilitySelect","selectedAbility","configAbility","changeEvent","throttleKey","targettingSetting","maxDisposition","tokensToTarget","HooksUtil","RollRequestUtil","isMidiRequest","rollModeFromGM","defaultRollMode","handlerRequestData","Main"],"mappings":"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"}