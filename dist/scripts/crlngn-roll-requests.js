var Oe=Object.defineProperty;var me=c=>{throw TypeError(c)};var Ae=(c,e,t)=>e in c?Oe(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var C=(c,e,t)=>Ae(c,typeof e!="symbol"?e+"":e,t),pe=(c,e,t)=>e.has(c)||me("Cannot "+t);var U=(c,e,t)=>(pe(c,e,"read from private field"),t?t.call(c):e.get(c)),be=(c,e,t)=>e.has(c)?me("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(c):e.set(c,t),_e=(c,e,t,s)=>(pe(c,e,"write to private field"),s?s.call(c,t):e.set(c,t),t);const W={checkbox:"checkbox"},Q={client:"client",world:"world"},w=()=>({debugMode:{tag:"debug-mode",label:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:Q.client,config:!0},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:Q.world,config:!0},skipDialogs:{tag:"skip-dialogs",label:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.hint"),propType:Boolean,inputType:W.checkbox,default:!1,scope:Q.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:W.checkbox,default:!1,scope:Q.world,config:!0},rollInterceptionEnabled:{tag:"roll-interception-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:Q.world,config:!0},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("CRLNGN_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:Q.world,config:!0}}),F="crlngn-roll-requests",te=["%cFlash Rolls 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],ne={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest"},r={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool",CONCENTRATION:"concentration",ATTACK:"attack",DAMAGE:"damage",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",DEATH_SAVE:"deathsave",HIT_DIE:"hitdie",ITEM_SAVE:"itemsave",CUSTOM:"custom",HEALING:"healing",FORMULA:"formula"},Ne={ABILITY_CHECK:{name:r.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:r.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:r.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:r.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:r.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:r.INITIATIVE_DIALOG,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:r.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:r.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:r.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},V={ID:F,ROLL_REQUEST_OPTIONS:Ne},K={INIT:"init",READY:"ready",RENDER_SIDEBAR_TAB:"renderSidebarTab",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage"},we={READY:"socketlib.ready"},N={PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG_V2:"dnd5e.preRollInitiativeDialogV2",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog"},se=class se{static log(e="",t=[],s=!1){try{const i=game.settings.get(F,"debug-mode")||se.debugOn;if(!(s||i))return;console.log(...te,e,...t)}catch{(s||se.debugOn)&&console.log(...te,e,...t)}}static warn(e="",t=[]){console.warn(...te,e,...t)}static error(e,t={ui:!1,console:!0,permanent:!1}){var s;t.ui&&((s=ui.notifications)==null||s.error(e,{localize:!0,permanent:t.permanent})),t.console&&console.error(...te,e)}};C(se,"debugOn",!1);let u=se;const y=class y{static serializeForTransport(e,t=!1){return u.log("serializeForTransport",[e,t]),e==null||t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(s=>s instanceof Roll?s.toJSON():s)),e}static deserializeFromTransport(e,t=!1){u.log("deserializeFromTransport",[e,t]);let s={...e};if(!e)return s;if(t&&e.rolls&&e.rolls.length>0){const i=s.rolls.map(o=>{let a=o;return typeof o=="string"?a=Roll.fromJSON(o):a=Roll.fromJSON(JSON.stringify(o)),a});return s.rolls=[...i],s}return s}};C(y,"socket"),C(y,"_activeExecutions",new Map),C(y,"initialize",e=>{u.log("initialize",[e]),Hooks.once(we.READY,()=>{if(typeof socketlib>"u"){u.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("CRLNGN_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{y.socket=socketlib.registerModule(F),e&&e()}catch{}})}),C(y,"registerCall",(e,t)=>{u.log("registerCall",[e]),y.socket&&y.socket.register(e,t)}),C(y,"sendMessage",(e,t)=>{u.log("sendMessage",[e]),t&&t()}),C(y,"execForGMs",async(e,...t)=>{if(u.log("execForGMs",[e,...t]),!!y.socket)return await y.socket.executeForAllGMs(e,...t)}),C(y,"execForAll",async(e,...t)=>{if(y.socket)return await y.socket.executeForEveryone(e,...t)}),C(y,"execForUser",async(e,t,...s)=>{if(u.log("execForUser",[e,t,...s]),!y.socket)return;if(t===game.user.id)return null;const i=`${e}-${t}`;if(y._activeExecutions.has(i))return null;y._activeExecutions.set(i,!0);try{return await y.socket.executeAsUser(e,t,...s)}catch{return null}finally{y._activeExecutions.delete(i)}});let B=y;class j{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const e=game.settings.storage.get("client");return this.diceConfig=e["core.diceConfiguration"]||"",this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){B.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(e,t){var s,i;((s=game.user)!=null&&s.isGM||e===((i=game.user)==null?void 0:i.id))&&(this.playerDiceConfigs[e]=t?JSON.parse(t):{})}static getUserDiceConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?this.diceConfig:this.playerDiceConfigs[e]||{}}static requestDiceConfigFromUser(e){B.execForUser("getDiceConfig",e)}static requestDiceConfigFromAllPlayers(){var e;(e=game.user)!=null&&e.isGM&&game.users.forEach(t=>{t.active&&!t.isGM&&t.id!==game.user.id&&this.requestDiceConfigFromUser(t.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?!!this.diceConfig:!!this.playerDiceConfigs[e]}}C(j,"diceConfig",{}),C(j,"playerDiceConfigs",{});class L{static registerSettings(){const e=w();Object.entries(e).forEach(async s=>{const i=s[1],o={name:i.label,hint:i.hint,default:i.default,type:i.propType,scope:i.scope,config:i.config,requiresReload:i.requiresReload||!1,onChange:a=>L.apply(i.tag,a)};i.choices&&(o.choices=i.choices),await game.settings.register(F,i.tag,o),(L.get(i.tag)===void 0||L.get(i.tag)===null)&&L.set(i.tag,i.default)})}static get(e,t=F){if(!e)return null;let s=!1;if(t===F)s=game.settings.get(t,e);else{let o=game.settings.storage.get("client")[`${t}.${e}`];o===void 0&&(o=game.settings.storage.get("world").getSetting(`${t}.${e}`),s=o==null?void 0:o.value)}return s}static set(e,t,s=F){if(!e)return!1;let i=game.settings.storage.get("client")[`${s}.${e}`];i||(i=game.settings.storage.get("world").getSetting(`${s}.${e}`));try{game.settings.set(s,e,t)}catch{}return!0}static apply(e,t){const s=w();switch(e){case s.rollRequestsEnabled.tag:L.applyRollRequestsEnabled(t);break}}static applyRollRequestsEnabled(e){const t=document.querySelector("#chat-controls .chat-control-icon.roll-requests-icon");t&&(e?t.classList.add("active"):t.classList.remove("active"))}}class le{static findActivityForRoll(e,t){var o;if(!((o=e==null?void 0:e.system)!=null&&o.activities))return null;const s=e.system.activities;switch(t==null?void 0:t.toLowerCase()){case r.ATTACK:const a=s.getByType("attack");return(a==null?void 0:a[0])||null;case r.DAMAGE:const l=s.getByType("attack");if((l==null?void 0:l.length)>0)return l[0];const n=s.getByType("damage");if((n==null?void 0:n.length)>0)return n[0];const d=s.getByType("save");return(d==null?void 0:d.length)>0?d[0]:null;case r.ITEM_SAVE:const g=s.getByType("save");return(g==null?void 0:g[0])||null;default:return null}}static getActivitiesByType(e,t){var s;return(s=e==null?void 0:e.system)!=null&&s.activities?e.system.activities.getByType(t):[]}static hasActivityForRoll(e,t){return u.log("hasActivityForRoll",[e,t]),!!this.findActivityForRoll(e,t)}static async executeActivityRoll(e,t,s,i,o){var d,g;u.log("executeActivityRoll",[e,t,s,i,o]);const a=e.items.get(s);if(!a)throw new Error(`Item ${s} not found on actor ${e.name}`);let l=null;i&&(l=(d=a.system.activities)==null?void 0:d.get(i)),l||(l=this.findActivityForRoll(a,t));const n=t==null?void 0:t.toLowerCase();if(l)switch(n){case r.ATTACK:const h={configure:!0};if(MidiQOL){await le.syntheticItemRoll(a,{...o});return}else return await l.use(usageConfig,h);case r.DAMAGE:if(MidiQOL){const p=(g=MidiQOL==null?void 0:MidiQOL.Workflow)==null?void 0:g.getWorkflow(l.uuid);await p.activity.rollDamage({...o,workflow:p});return}else return await l.rollDamage(o);case r.ITEM_SAVE:return await a.use({activity:l.id},{skipDialog:o.fastForward});default:throw new Error(`Unknown roll type: ${n}`)}else{switch(n){case r.ATTACK:if(a.rollAttack)return await a.rollAttack(o);break;case r.DAMAGE:if(a.rollDamage)return await a.rollDamage(o);break;case r.ITEM_SAVE:return await a.use({},{skipDialog:o.fastForward})}throw new Error(`No suitable method found for ${n} on item ${a.name}`)}}static getActivityDisplayInfo(e){return u.log("getActivityDisplayInfo",[e]),e?{name:e.name||e.constructor.metadata.label,type:e.type,icon:e.constructor.metadata.icon,canAttack:e.type==="attack",canDamage:["attack","damage","save"].includes(e.type),canSave:e.type==="save"}:null}static getDamageFormula(e){var s,i;if(u.log("getDamageFormula",[e]),!((i=(s=e==null?void 0:e.damage)==null?void 0:s.parts)!=null&&i.length))return null;const t=e.damage.parts.map(o=>o.formula).filter(o=>o);return t.length>0?t.join(" + "):null}static async syntheticItemRoll(e,t={}){u.log("syntheticItemRoll",[e,t]);let s={consumeUsage:!1,consumeSpellSlot:!1},i={configureDialog:!0,workflowOptions:{autoRollAttack:!1,autoFastAttack:!1,autoRollDamage:"none",autoFastDamage:!1}};return t={...s,...t},await MidiQOL.completeItemUse(e,t,i)}static async replaceDamage(e,t,{ignoreCrit:s=!1,damageType:i}={}){t=String(t),e.isCritical&&!s&&(t=await rollUtils.getCriticalFormula(t,e.item.getRollData()));let o=await new CONFIG.Dice.DamageRoll(t).evaluate();return await e.setDamageRolls([o]),o}}class z extends dnd5e.applications.dice.D20RollConfigurationDialog{constructor(e={},t={},s={}){var i,o;s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(e,t,s),u.log("constructor - initializing GM Dialog",[e,t,s]),this.actors=s.actors||[],this.sendRequest=s.defaultSendRequest??s.sendRequest??!0,this.showDC=s.showDC||!1,this.dcValue=s.dcValue||null,this.rollKey=s.rollKey||e.skill||e.ability||null,this.rollTypeString=s.rollTypeString||null,this.windowTitle=((i=s.window)==null?void 0:i.title)||"",this.windowSubtitle=((o=s.window)==null?void 0:o.subtitle)||""}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(e,t,s,i){u.log("_prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.showDC=this.showDC,o.dcValue=this.dcValue,o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return u.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){var i,o,a;if(u.log("_onRender",[e,t]),super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const l={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},n=await renderTemplate(`modules/${F}/templates/gm-roll-config-fields.hbs`,l),d=document.createElement("div");d.className="gm-roll-config-fields",d.innerHTML=n,s.parentNode.insertBefore(d,s)}this._attachButtonListeners(),((a=(o=(i=this.config.rolls)==null?void 0:i[0])==null?void 0:o.data)!=null&&a.situational||this.config.situational)&&(u.log("GMRollConfigDialog._onRender",["Triggering rebuild for initial situational bonus"]),setTimeout(()=>{this.rebuild()},100))}_attachButtonListeners(){u.log("_attachButtonListeners",[this.element]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(t=>{t.addEventListener("click",s=>{s.currentTarget.dataset.action})})}_onChangeForm(e,t){u.log("_onChangeForm",[e,t]),super._onChangeForm(e,t);const s=this.element.querySelector('input[name="crlngn-send-request"]');s&&(this.sendRequest=s.checked);const i=this.element.querySelector('input[name="dc"]');i&&i.value&&(this.dcValue=parseInt(i.value)||null)}_buildConfig(e,t,s){u.log("_buildConfig",[e,t,s]);const i=t==null?void 0:t.get("ability"),o=t==null?void 0:t.get("dc"),a=t==null?void 0:t.get(`rolls.${s}.situational`);if(a&&e.situational!==!1)e.parts||(e.parts=[]),e.parts.push("@situational"),e.data||(e.data={}),e.data.situational=a;else if(e.parts){const n=e.parts.indexOf("@situational");n!==-1&&e.parts.splice(n,1)}i&&(e.ability=i,this.config.ability=i);const l=super._buildConfig(e,t,s);if(o){const n=parseInt(o);isNaN(n)||(l.options=l.options||{},l.options.target=n)}else this.dcValue!==void 0&&this.dcValue!==null&&(l.options=l.options||{},l.options.target=this.dcValue);return l}async _processSubmitData(e,t,s){if(u.log("_processSubmitData",[e,t,s]),await super._processSubmitData(e,t,s),s.has("dc")&&s.get("dc")!==""){const i=parseInt(s.get("dc"));if(!isNaN(i)&&(this.dcValue=i,this.config.rolls&&this.config.rolls.length>0))for(const o of this.config.rolls)o.options.target=i}this.sendRequest=s.get("crlngn-send-request")!=="false"}_finalizeRolls(e){u.log("_finalizeRolls",[e,this.config]);const t=super._finalizeRolls(e);if(u.log("_finalizeRolls #2",[t]),this.dcValue!==void 0&&this.dcValue!==null)for(const s of t)s.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,t}static async getConfiguration(e,t,s,i={}){var D,E,G,S,H,q,$,x,X,ee,v,ue,de,ge,fe,he,Re;e.length>0&&typeof e[0]=="string"&&(e=e.map(M=>game.actors.get(M)).filter(M=>M)),u.log("GMRollConfigDialog.getConfiguration",[{actors:e,actorNames:e.map(M=>M.name),rollType:t,rollKey:s,options:i,firstActorData:e[0]?{name:e[0].name,abilities:(D=e[0].system)!=null&&D.abilities?Object.keys(e[0].system.abilities):[],skills:(E=e[0].system)!=null&&E.skills?Object.keys(e[0].system.skills):[],initAbility:(H=(S=(G=e[0].system)==null?void 0:G.attributes)==null?void 0:S.init)==null?void 0:H.ability}:null}]);const o=t==null?void 0:t.toLowerCase(),a=[r.SAVE,r.SAVING_THROW,r.ABILITY,r.ABILITY_CHECK,r.CONCENTRATION].includes(o),l=e[0];if(!l)return null;let n=CONFIG.Dice.D20Roll;[r.DAMAGE,r.HEALING].includes(o)?n=CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[r.FORMULA,r.CUSTOM,r.HIT_DIE].includes(o)&&(n=CONFIG.Dice.BasicRoll),n||(n=CONFIG.Dice.D20Roll);const d={data:l.getRollData(),subject:l,rolls:[{parts:[],data:l.getRollData(),options:{}}]};switch(o){case r.SKILL:d.skill=s;break;case r.SAVE:case r.SAVING_THROW:d.ability=s;break;case r.ABILITY:case r.ABILITY_CHECK:d.ability=s;break;case r.HIT_DIE:d.rolls[0].parts=[],d.rolls[0].options.flavor="Hit Die";break}const g={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:l})}},h={options:{actors:e,sendRequest:e.some(M=>this._isPlayerOwned(M)),showDC:a,rollKey:s,rollType:n,rollTypeString:o,window:{title:z._getRollTitle(o,s,l),subtitle:z._getSubtitle(e)},...i}},p=new this(d,g,h.options),f=await new Promise(M=>{p.addEventListener("close",()=>{M({rolls:p.rolls,config:p.config,message:p.message,sendRequest:p.sendRequest})},{once:!0}),p.render({force:!0})});if(!f.rolls||f.rolls.length===0)return null;const m=f.rolls[0];let R=!1,_=!1;((q=m==null?void 0:m.options)==null?void 0:q.advantageMode)!==void 0&&(R=m.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,_=m.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const b={chatMessage:!0,isRollRequest:f.sendRequest,skipDialog:i.skipDialogs||!1,sendRequest:f.sendRequest};R&&(b.advantage=!0),_&&(b.disadvantage=!0);const T=game.settings.get("core","rollMode");f.message.rollMode&&f.message.rollMode!==T&&(b.rollMode=f.message.rollMode);let I=(($=m==null?void 0:m.options)==null?void 0:$.situational)||((x=m==null?void 0:m.data)==null?void 0:x.situational)||((ee=(X=f.config)==null?void 0:X.data)==null?void 0:ee.situational)||"";if(!I&&((v=m==null?void 0:m.parts)==null?void 0:v.length)>0&&m.parts.find(De=>De.includes("@situational"))&&(ue=m.data)!=null&&ue.situational&&(I=m.data.situational),I&&(b.situational=I,b.parts=["@situational"]),(de=m==null?void 0:m.options)!=null&&de.target&&(b.target=m.options.target),f.config.ability&&[r.SKILL,r.TOOL].includes(o)){const M=((fe=(ge=l.system.skills)==null?void 0:ge[s])==null?void 0:fe.ability)||((Re=(he=CONFIG.DND5E.skills)==null?void 0:he[s])==null?void 0:Re.ability);f.config.ability!==M&&(b.ability=f.config.ability)}return b.rollTitle=h.options.window.title,b}static _isPlayerOwned(e){return u.log("GMRollConfigDialog._isPlayerOwned",[e]),Object.entries(e.ownership).some(([t,s])=>{const i=game.users.get(t);return i&&!i.isGM&&s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}static _getRollTitle(e,t,s){var a,l,n,d,g,h,p,f,m,R,_,b,T;u.log("GMRollConfigDialog._getRollTitle",[e,t,s]),u.log("GMRollConfigDialog._getRollTitle - Detailed",{rollType:e,rollKey:t,actorName:s==null?void 0:s.name,actorAbilities:(a=s==null?void 0:s.system)!=null&&a.abilities?Object.keys(s.system.abilities):[],actorSkills:(l=s==null?void 0:s.system)!=null&&l.skills?Object.keys(s.system.skills):[],actorInitAbility:(g=(d=(n=s==null?void 0:s.system)==null?void 0:n.attributes)==null?void 0:d.init)==null?void 0:g.ability});let i="";const o=e==null?void 0:e.toLowerCase();switch([r.SAVE,r.ABILITY,r.ABILITY_CHECK].includes(o)&&!t&&u.warn("Missing rollKey for roll type",[o,t]),o){case r.SKILL:const I=((h=CONFIG.DND5E.skills[t])==null?void 0:h.label)||t,D=(p=s==null?void 0:s.system.skills)==null?void 0:p[t],E=(D==null?void 0:D.ability)||((f=CONFIG.DND5E.skills[t])==null?void 0:f.ability)||"int",G=((m=CONFIG.DND5E.abilities[E])==null?void 0:m.label)||E;i=game.i18n.format("DND5E.SkillPromptTitle",{skill:I,ability:G});break;case r.SAVE:case r.SAVING_THROW:const S=((R=CONFIG.DND5E.abilities[t])==null?void 0:R.label)||t;i=game.i18n.format("DND5E.SavePromptTitle",{ability:S});break;case r.ABILITY:case r.ABILITY_CHECK:const H=((_=CONFIG.DND5E.abilities[t])==null?void 0:_.label)||t;i=game.i18n.format("DND5E.AbilityPromptTitle",{ability:H});break;case r.CONCENTRATION:i=game.i18n.localize("DND5E.Concentration");break;case r.TOOL:const q=(T=(b=CONFIG.DND5E.enrichmentLookup)==null?void 0:b.tools)==null?void 0:T[t];let $=t;if(q!=null&&q.id){const x=dnd5e.documents.Trait.getBaseItem(q.id,{indexOnly:!0});$=(x==null?void 0:x.name)||t}i=game.i18n.format("DND5E.ToolPromptTitle",{tool:$});break;case r.DEATH_SAVE:i=game.i18n.localize("DND5E.DeathSave");break;case r.INITIATIVE:case r.INITIATIVE_DIALOG:i=game.i18n.localize("DND5E.Initiative");break;default:i=game.i18n.localize("DND5E.Roll")}return u.log("_getRollTitle",[o,i]),i}static _getSubtitle(e=[]){return e.length===1?e[0].name:e.length>1?game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.multipleActors"):""}}class ye extends dnd5e.applications.dice.RollConfigurationDialog{constructor(e={},t={},s={}){s.rollType=CONFIG.Dice.BasicRoll||Roll,super(e,t,s),u.log("constructor",[e,t,s]),this.actors=s.actors||[],this.sendRequest=s.defaultSendRequest??s.sendRequest??!0,this.showDC=!1}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(e,t,s,i){u.log("_prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.formula="Hit Die (varies by actor)",o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length,t.formula="Hit Die (varies by actor)"),t}async _onRender(e,t){if(super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const i={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await renderTemplate(`modules/${F}/templates/gm-roll-config-fields.hbs`,i),a=document.createElement("div");a.className="gm-roll-config-fields",a.innerHTML=o,s.parentNode.insertBefore(a,s)}}_onChangeForm(e,t){super._onChangeForm(e,t);const s=this.element.querySelector('input[name="crlngn-send-request"]');s&&(this.sendRequest=s.checked)}async _processSubmitData(e,t,s){await super._processSubmitData(e,t,s),u.log("_processSubmitData",[s.get("crlngn-send-request")]),this.sendRequest=s.get("crlngn-send-request")!=="false"}_finalizeRolls(e){const t=super._finalizeRolls(e);return u.log("_finalizeRolls",[this.sendRequest]),this.config.sendRequest=this.sendRequest,t}static async getConfiguration(e,t,s,i={}){var R,_;u.log("GMRollConfigDialog.getConfiguration",[e,t,s,i]);const o=e[0];if(!o)return null;const a={data:o.getRollData(),subject:o,rolls:[{parts:[],data:o.getRollData(),options:{flavor:"Hit Die Roll"}}]},l={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:o})}},n={options:{actors:e,sendRequest:e.some(b=>z._isPlayerOwned(b)),rollKey:s,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:z._getSubtitle(e)},...i}},d=new this(a,l,n.options),g=await new Promise(b=>{d.addEventListener("close",()=>{b({rolls:d.rolls,config:d.config,message:d.message,sendRequest:d.sendRequest})},{once:!0}),d.render({force:!0})});if(!g.rolls||g.rolls.length===0)return null;const h={chatMessage:!0,isRollRequest:g.sendRequest,skipDialog:i.skipDialogs||!1,sendRequest:g.sendRequest},p=game.settings.get("core","rollMode");g.message.rollMode&&g.message.rollMode!==p&&(h.rollMode=g.message.rollMode);const f=g.rolls[0],m=((R=f==null?void 0:f.options)==null?void 0:R.situational)||((_=f==null?void 0:f.data)==null?void 0:_.situational)||"";return m&&(h.situational=m,h.parts=["@situational"]),h}}class Le extends dnd5e.applications.dice.SkillToolRollConfigurationDialog{constructor(e={},t={},s={}){const i=foundry.utils.mergeObject(e,{chooseAbility:!0});s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(i,t,s),u.log("constructor",[e,t,s]),this.actors=s.actors||[],this.sendRequest=s.defaultSendRequest??s.sendRequest??!0,this.showDC=s.showDC||!1,this.dcValue=s.dcValue||null}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,i){u.log("_prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.showDC=this.showDC,o.dcValue=this.dcValue,o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return u.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){var i,o,a;if(u.log("_onRender",[e,t]),super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const l={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},n=await renderTemplate(`modules/${F}/templates/gm-roll-config-fields.hbs`,l),d=document.createElement("div");d.className="gm-roll-config-fields",d.innerHTML=n,s.parentNode.insertBefore(d,s)}this._attachButtonListeners(),((a=(o=(i=this.config.rolls)==null?void 0:i[0])==null?void 0:o.data)!=null&&a.situational||this.config.situational)&&setTimeout(()=>{this.rebuild()},100)}_attachButtonListeners(){u.log("_attachButtonListeners",[]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(t=>{t.addEventListener("click",s=>{s.currentTarget.dataset.action})})}_onChangeForm(e,t){var o,a;u.log("_onChangeForm",[e,t]),super._onChangeForm(e,t);const s=this.element.querySelector('input[name="crlngn-send-request"]');s&&(this.sendRequest=s.checked);const i=this.element.querySelector('input[name="dc"]');i&&i.value&&(this.dcValue=parseInt(i.value)||null),((o=t.target)==null?void 0:o.name)==="ability"&&((a=t.target)!=null&&a.value)&&(this.config.ability=t.target.value)}_buildConfig(e,t,s){u.log("_buildConfig",[e,t,s]);const i=t==null?void 0:t.get("ability"),o=t==null?void 0:t.get("dc");i&&(e.ability=i,this.config.ability=i);const a=super._buildConfig(e,t,s);if(o){const l=parseInt(o);isNaN(l)||(a.options=a.options||{},a.options.target=l)}else this.dcValue!==void 0&&this.dcValue!==null&&(a.options=a.options||{},a.options.target=this.dcValue);return a}async _processSubmitData(e,t,s){if(u.log("_processSubmitData",[e,t,s]),await super._processSubmitData(e,t,s),s.has("dc")&&s.get("dc")!==""){const i=parseInt(s.get("dc"));if(!isNaN(i)&&(this.dcValue=i,this.config.rolls&&this.config.rolls.length>0))for(const o of this.config.rolls)o.options.target=i}this.sendRequest=s.get("crlngn-send-request")!=="false"}_finalizeRolls(e){u.log("_finalizeRolls",[e]);const t=super._finalizeRolls(e);if(this.dcValue!==void 0&&this.dcValue!==null)for(const s of t)s.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,t}static async getConfiguration(e,t,s,i={}){var E,G,S,H,q,$,x,X,ee;u.log("getConfiguration",[e,t,s,i]);const o=t==null?void 0:t.toLowerCase(),a=[r.SKILL,r.TOOL].includes(o),l=e[0];if(!l)return null;const n=CONFIG.Dice.D20Roll;let d=null;if(o===r.SKILL){const v=l.system.skills[s];d=(v==null?void 0:v.ability)||((E=CONFIG.DND5E.skills[s])==null?void 0:E.ability)||"int"}else if(o===r.TOOL){const v=(G=l.system.tools)==null?void 0:G[s];d=(v==null?void 0:v.ability)||((q=(H=(S=CONFIG.DND5E.enrichmentLookup)==null?void 0:S.tools)==null?void 0:H[s])==null?void 0:q.ability)||"int"}const g={data:l.getRollData(),subject:l,ability:d,chooseAbility:!0,rolls:[{parts:[],data:l.getRollData(),options:{}}]};o===r.SKILL?g.skill=s:o===r.TOOL&&(g.tool=s);const h={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:l})}},p={options:{actors:e,sendRequest:e.some(v=>z._isPlayerOwned(v)),showDC:a,rollKey:s,rollType:n,window:{title:z._getRollTitle(o,s,l),subtitle:z._getSubtitle(e)},...i}},f=new this(g,h,p.options),m=await new Promise(v=>{f.addEventListener("close",()=>{v({rolls:f.rolls,config:f.config,message:f.message,sendRequest:f.sendRequest})},{once:!0}),f.render({force:!0})});if(!m.rolls||m.rolls.length===0)return null;const R=m.rolls[0];let _=!1,b=!1;(($=R==null?void 0:R.options)==null?void 0:$.advantageMode)!==void 0&&(_=R.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,b=R.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const T={chatMessage:!0,isRollRequest:m.sendRequest,skipDialog:i.skipDialogs||!1,sendRequest:m.sendRequest};_&&(T.advantage=!0),b&&(T.disadvantage=!0);const I=game.settings.get("core","rollMode");m.message.rollMode&&m.message.rollMode!==I&&(T.rollMode=m.message.rollMode);const D=((x=R==null?void 0:R.options)==null?void 0:x.situational)||((X=R==null?void 0:R.data)==null?void 0:X.situational)||"";return D&&(T.situational=D,T.parts=[D]),(ee=R==null?void 0:R.options)!=null&&ee.target&&(T.target=R.options.target),m.config.ability&&[r.SKILL,r.TOOL].includes(o)&&(T.ability=m.config.ability),T.rollTitle=p.options.window.title,T}}class Ie{static initialize(){u.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){u.log("RollInterceptor.registerHooks"),this._registerHook(N.PRE_ROLL_ABILITY_CHECK,this._handlePreRoll.bind(this,r.ABILITY)),this._registerHook(N.PRE_ROLL_SAVING_THROW,this._handlePreRoll.bind(this,r.SAVE)),this._registerHook(N.PRE_ROLL_SKILL_V2,this._handlePreRoll.bind(this,r.SKILL)),this._registerHook(N.PRE_ROLL_TOOL_V2,this._handlePreRoll.bind(this,r.TOOL)),this._registerHook(N.PRE_ROLL_ATTACK_V2,this._handlePreRoll.bind(this,r.ATTACK)),this._registerHook(N.PRE_ROLL_DAMAGE_V2,this._handlePreRoll.bind(this,r.DAMAGE)),this._registerHook(N.PRE_ROLL_INITIATIVE,this._handlePreRoll.bind(this,r.INITIATIVE)),this._registerHook(N.PRE_ROLL_INITIATIVE_DIALOG_V2,this._handlePreRoll.bind(this,r.INITIATIVE)),this._registerHook(N.PRE_ROLL_DEATH_SAVE_V2,this._handlePreRoll.bind(this,r.DEATH_SAVE)),this._registerHook(N.PRE_ROLL_HIT_DIE_V2,this._handlePreRoll.bind(this,r.HIT_DIE))}static _registerHook(e,t){u.log("RollInterceptor._registerHook");const s=Hooks.on(e,t);this.registeredHooks.add({hookName:e,hookId:s})}static unregisterHooks(){u.log("RollInterceptor.unregisterHooks");for(const{hookName:e,hookId:t}of this.registeredHooks)Hooks.off(e,t);this.registeredHooks.clear()}static _handlePreRoll(e,t,s,i){var p,f;if(u.log("_handlePreRoll - Initiative/Ability Debug",[{rollType:e,config:t}]),!game.user.isGM)return;u.log("_handlePreRoll #2");const o=(t==null?void 0:t.hookNames)||(s==null?void 0:s.hookNames)||(i==null?void 0:i.hookNames)||[];(o.includes("initiativeDialog")||o.includes("initiative"))&&e===r.ABILITY&&(u.log("RollInterceptor._handlePreRoll - Overriding ability to initiative",[{hookNames:o}]),e=r.INITIATIVE);let l;if(e===r.INITIATIVE&&t instanceof Actor)l=t;else if(e===r.HIT_DIE){if(s!=null&&s.isRollRequest||i!=null&&i.isRollRequest)return;l=((p=s==null?void 0:s.subject)==null?void 0:p.actor)||(s==null?void 0:s.subject)||(s==null?void 0:s.actor)}else{if(t!=null&&t.isRollRequest||s!=null&&s.isRollRequest||i!=null&&i.isRollRequest)return;l=((f=t.subject)==null?void 0:f.actor)||t.subject||t.actor}u.log("_handlePreRoll #3");const n=w(),d=L.get(n.rollInterceptionEnabled.tag),g=L.get(n.rollRequestsEnabled.tag);if(!d||!g||!l||l.documentName!=="Actor")return;u.log("_handlePreRoll #4");const h=this._getActorOwner(l);if(!(!h||h.id===game.user.id||!h.active||s.configure===!1||t.skipDialog===!0||t.fastForward===!0))return u.log("_handlePreRoll #5"),this._showGMConfigDialog(l,h,e,t,s,i),!1}static async _showGMConfigDialog(e,t,s,i,o,a){var l,n,d,g,h,p,f,m;console.trace(te+" _showGMConfigDialog",[e,t,s,i,o,a]),u.log("_showGMConfigDialog - Detailed config",[{rollType:s,configAbility:i==null?void 0:i.ability,configSubject:i==null?void 0:i.subject,configSubjectAbility:(l=i==null?void 0:i.subject)==null?void 0:l.ability,configSkill:i==null?void 0:i.skill,configTool:i==null?void 0:i.tool,fullConfig:i}]);try{const R=s==null?void 0:s.toLowerCase();let _;[r.SKILL,r.TOOL].includes(R)?_=Le:R===r.HIT_DIE?_=ye:_=z;let b={rolls:[{parts:[],data:{},options:{}}]};switch(R){case r.ABILITY:b.ability=i.ability||((n=i.subject)==null?void 0:n.ability);break;case r.SAVE:b.ability=i.ability||((d=i.subject)==null?void 0:d.ability),i.ability==="con"&&i.targetValue!==void 0&&(s=r.CONCENTRATION);break;case r.SKILL:b.skill=i.skill,b.ability=i.ability;break;case r.TOOL:b.tool=i.tool,b.ability=i.ability;break;case r.CONCENTRATION:b.ability="con";break;case r.INITIATIVE:break;case r.HIT_DIE:b.denomination=typeof i=="string"?i:i.denomination||((g=i.subject)==null?void 0:g.denomination);break}const T=w(),I=L.get(T.skipDialogs.tag),D={actors:[e],rollType:R,showDC:!0,defaultSendRequest:!0,skipDialogs:I};let E;if(I)E={sendRequest:!0,advantage:!1,disadvantage:!1,situational:"",rollMode:game.settings.get("core","rollMode")};else{let S=null;switch(R){case r.SKILL:S=i.skill;break;case r.TOOL:S=i.tool;break;case r.ABILITY:case r.SAVE:S=i.ability||((h=i.subject)==null?void 0:h.ability);break;case r.CONCENTRATION:S="con";break;case r.INITIATIVE:S=((f=(p=e.system.attributes)==null?void 0:p.init)==null?void 0:f.ability)||"dex";break;case r.HIT_DIE:S=typeof i=="string"?i:i.denomination||((m=i.subject)==null?void 0:m.denomination);break}u.log("RollInterceptor._showGMConfigDialog - Calling getConfiguration",{actor:e.name,normalizedRollType:R,rollKey:S,config:i,DialogClass:_.name}),E=await _.getConfiguration([e],R,S,{skipDialogs:!1,defaultSendRequest:!0})}if(!E){u.log("RollInterceptor._showGMConfigDialog - Dialog cancelled");return}if(u.log("RollInterceptor._showGMConfigDialog - Dialog result",[{sendRequest:E.sendRequest,rollType:R,result:E}]),!E.sendRequest){await this._executeLocalRoll(e,s,i,E);return}const G={...i,...E,requestedBy:game.user.name};this._sendRollRequest(e,t,s,G)}catch{this._sendRollRequest(e,t,s,i)}}static async _executeLocalRoll(e,t,s,i){u.log("RollInterceptor._executeLocalRoll",[e,t,s,i]);const o=t==null?void 0:t.toLowerCase(),a={...s,advantage:i.advantage||s.advantage,disadvantage:i.disadvantage||s.disadvantage,target:i.dc||s.target,rollMode:i.rollMode||s.rollMode,isRollRequest:!1},l={configure:!1,isRollRequest:!1},n={rollMode:a.rollMode,create:!0,isRollRequest:!1};try{switch(o){case r.SAVE:await e.rollSavingThrow(s.ability,a,l,n);break;case r.ABILITY:await e.rollAbilityCheck(s.ability,a,l,n);break;case r.SKILL:await e.rollSkill(s.skill,a,l,n);break;case r.TOOL:await e.rollToolCheck(s.tool,a,l,n);break;case r.CONCENTRATION:await e.rollConcentration(a,l,n);break;case r.INITIATIVE:await e.rollInitiativeD(a,l,n);break;case r.DEATH_SAVE:await e.rollDeathSave(a,l,n);break;case r.HIT_DIE:const d=typeof s=="string"?s:s.denomination;await e.rollHitDie(d,a,l,n);break}}catch{}}static async _showConfigurationDialog(e,t,s,i,o,a){u.log("RollInterceptor._showConfigurationDialog",[e,t,s,i,o,a]);try{const n={...i,_rollMethod:async p=>(this._sendRollRequest(e,t,s,p),new Roll("1d20").evaluate({async:!1})),configured:!1},d=o.cls,h=await new d(n,o.options).render(!0)}catch{this._sendRollRequest(e,t,s,i)}}static _getActorOwner(e){u.log("_getActorOwner",[e]);const t=e.ownership||{};for(const[s,i]of Object.entries(t))if(i>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.get(s);if(o&&!o.isGM)return o}return null}static _sendRollRequest(e,t,s,i){var p;u.log("_sendRollRequest",[e,t,s,i]);const o=w(),a=L.get(o.skipDialogs.tag);let l=s==null?void 0:s.toLowerCase();l===r.INITIATIVE&&(l=r.INITIATIVE_DIALOG);let n=null,d=null;switch(l){case r.ABILITY:case r.SAVE:n=i.ability;break;case r.SKILL:n=i.skill;break;case r.TOOL:n=i.tool;break;case r.ATTACK:case r.DAMAGE:if((p=i.subject)!=null&&p.item){n=i.subject.item.id;const f=le.findActivityForRoll(i.subject.item,s);f&&(d=f.id)}break;case r.HIT_DIE:n=typeof i=="string"?i:i.denomination;break;case r.INITIATIVE_DIALOG:case r.INITIATIVE:n=null;break;case r.DEATH_SAVE:n=null;break;default:u.warn(`Unknown roll type: ${s}`);return}const g={advantage:i.advantage||!1,disadvantage:i.disadvantage||!1,situational:i.situational||0,parts:i.parts||[],rollMode:i.rollMode||game.settings.get("core","rollMode"),elvenAccuracy:i.elvenAccuracy||!1,halflingLucky:i.halflingLucky||!1,reliableTalent:i.reliableTalent||!1,minimum:i.minimum,maximize:i.maximize,critical:i.critical,fumble:i.fumble,targetValue:i.targetValue,fastForward:i.fastForward||!1,chatMessage:i.chatMessage!==!1,flavor:i.flavor,title:i.title,dialogOptions:i.dialogOptions,messageData:i.messageData,ability:i.ability,denomination:typeof i=="string"?i:i.denomination,requestedBy:i.requestedBy||game.user.name};Object.keys(g).forEach(f=>{g[f]===void 0&&delete g[f]});const h={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:e.id,rollType:l,rollKey:n,activityId:d,config:g,skipDialog:a,targetTokenIds:Array.from(game.user.targets).map(f=>f.id),preserveTargets:L.get(o.useGMTargetTokens.tag)};l===r.HIT_DIE&&u.log("RollInterceptor._sendRollRequest - Hit Die Debug",[{actor:e.name,owner:t.name,rollType:l,rollKey:n,requestData:h}]),B.execForUser("handleRollRequest",t.id,h),ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestSent",{player:t.name,actor:e.name}))}}C(Ie,"registeredHooks",new Set);function Ee(c,e){var i,o,a,l,n;let t=game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${c}`)||c;const s=c==null?void 0:c.toLowerCase();if(e)switch(s){case r.SKILL:t+=` (${((i=CONFIG.DND5E.skills[e])==null?void 0:i.label)||e})`;break;case r.SAVE:t+=` (${((o=CONFIG.DND5E.abilities[e])==null?void 0:o.label)||e})`;break;case r.ABILITY:t+=` (${((a=CONFIG.DND5E.abilities[e])==null?void 0:a.label)||e})`;break;case r.TOOL:const d=(n=(l=CONFIG.DND5E.enrichmentLookup)==null?void 0:l.tools)==null?void 0:n[e];if(d!=null&&d.id){const g=dnd5e.documents.Trait.getBaseItem(d.id,{indexOnly:!0});t+=` (${(g==null?void 0:g.name)||e})`}else t+=` (${e})`;break;case r.CUSTOM:t=`${t}: ${e}`;break}return t}function ve(c,e=Ee){if(c.length===0)return;const t={};for(const i of c){const o=`${i.rollType}_${i.rollKey||""}`;t[o]||(t[o]={rollType:i.rollType,rollKey:i.rollKey,actors:[],gm:i.gm}),t[o].actors.push(i.actor)}const s=Object.values(t);if(s.length===1&&s[0].actors.length===1){const i=s[0];ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestReceived",{gm:i.gm,rollType:e(i.rollType,i.rollKey)}))}else{const i=[];for(const o of s){const a=e(o.rollType,o.rollKey),l=o.actors.join(", ");i.push(`${a} (${l})`)}ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsReceivedMultiple",{gm:s[0].gm,requests:i.join("; ")}))}}function qe(c){const e=c.ownership||{};for(const[t,s]of Object.entries(e))if(s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const i=game.users.get(t);if(i&&!i.isGM)return i}return null}function Ge(c,e=game.user){if(!(c!=null&&c.length))return;c.map(s=>canvas.tokens.get(s)).filter(s=>s).forEach(s=>s.setTarget(!0,{user:e}))}function ie(c){return c.type!=="character"&&c.type!=="npc"?!1:Object.entries(c.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function Te(c){if(c.type!=="character"&&c.type!=="npc")return!1;const e=game.scenes.active;return e&&e.tokens.some(t=>t.actorId===c.id)}function oe(c,e){if(!game.scenes.active)return;const s=canvas.tokens.placeables.filter(i=>{var o;return((o=i.actor)==null?void 0:o.id)===c});for(const i of s)e?i.control({releaseOthers:!1}):i.release()}function Ce(c){return new Promise(e=>setTimeout(e,c))}function Me(){var c;return!((c=ui==null?void 0:ui.sidebar)!=null&&c._collapsed)}function He(c){const e=document.querySelector("body");c?e.classList.add("sidebar-expanded"):e.classList.remove("sidebar-expanded")}function Ve(c,e){var a;const t=[];if(!c||e.size===0)return t;const s=V.ROLL_REQUEST_OPTIONS[c];if(!s||!s.subList)return t;const i=Array.from(e)[0],o=game.actors.get(i);if(s.subList==="tools"){const l=((a=CONFIG.DND5E.enrichmentLookup)==null?void 0:a.tools)||CONFIG.DND5E.tools||{};for(const[n,d]of Object.entries(l)){let g=n;if(d!=null&&d.id){const h=dnd5e.documents.Trait.getBaseItem(d.id,{indexOnly:!0});g=(h==null?void 0:h.name)||n}else g=n.replace(/([A-Z])/g," $1").replace(/^./,h=>h.toUpperCase()).trim();t.push({id:n,name:g,rollable:!0})}t.sort((n,d)=>n.name.localeCompare(d.name))}else if(o&&s.actorPath){const l=foundry.utils.getProperty(o,s.actorPath)||{},n=CONFIG.DND5E[s.subList];for(const[d,g]of Object.entries(l)){let h="";s.subList==="skills"&&(n!=null&&n[d])||s.subList==="abilities"&&(n!=null&&n[d])?h=n[d].label:h=g.label||game.i18n.localize(g.name||d)||d,t.push({id:d,name:h,rollable:!0})}s.subList==="skills"&&t.sort((d,g)=>d.name.localeCompare(g.name))}return t}const O=class O{static notify(e,t,s={}){if(!s.batch){ui.notifications[e](t);return}s.batchData&&(O.pendingNotifications.push(s.batchData),O.notificationTimer&&clearTimeout(O.notificationTimer),O.notificationTimer=setTimeout(()=>{ve(O.pendingNotifications),O.pendingNotifications=[],O.notificationTimer=null},O.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(e,t){const s=Object.entries(e);if(s.length!==0)if(s.length===1){const i=Object.values(e)[0],o=i.actors.map(a=>a.name).join(", ");ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsSentSingle",{rollType:t,actors:o,player:i.player.name}))}else{const i=s.map(([o,a])=>{const l=a.actors.map(n=>n.name).join(", ");return`${a.player.name} (${l})`});ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsSentMultiple",{rollType:t,count:s.length,players:i.join("; ")}))}}static clearPending(){O.notificationTimer&&(clearTimeout(O.notificationTimer),O.notificationTimer=null),O.pendingNotifications=[]}};C(O,"pendingNotifications",[]),C(O,"notificationTimer",null),C(O,"NOTIFICATION_BATCH_DELAY",500);let A=O;function Pe(c){var s;const e=[],t=[];for(const i of c){const o=((s=i.system.attributes.hp)==null?void 0:s.value)||0,a=i.system.attributes.death||{},l=a.success||0,n=a.failure||0;o<=0&&l<3&&n<3?e.push(i):t.push(i.name)}return t.length>0&&A.notify("info",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.actorsSkippingDeathSave",{actors:t.join(", ")})),e}function Fe(c){const e=[],t=[];for(const s of c){const i=qe(s);i?e.push({actor:s,owner:i}):t.push(s)}return{pcActors:e,npcActors:t}}class ae extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){constructor(e={}){super(e),this.formula=e.formula||"",this.readonly=e.readonly||!1,this.actor=e.actor,this.callback=e.callback,this.diceCounts={}}_onClickAction(e,t){switch(t.dataset.action){case"rollDice":return this.rollDice(e,t);case"addDie":return this.addDie(e,t);case"cancel":return this.cancel(e,t)}}async _prepareContext(e={}){return{...await super._prepareContext(e),formula:this.formula,readonly:this.readonly}}_attachPartListeners(e,t,s){super._attachPartListeners(e,t,s);const i=t.querySelector("#custom-roll-formula"),o=t.querySelector("#formula-validation-message");i&&!this.readonly&&(i.addEventListener("input",a=>{this.formula=a.target.value.trim(),this.updateValidationMessage(o)}),this.formula&&this.updateValidationMessage(o))}updateValidationMessage(e){if(!e)return;if(!this.formula){e.textContent="&nbsp;",e.classList.remove("error","success");return}this.validateFormula(this.formula)?(e.textContent=game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.formulaValid"),e.classList.remove("error"),e.classList.add("success")):(e.textContent=game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.formulaInvalid"),e.classList.remove("success"),e.classList.add("error"))}addDie(e,t){const s=t.dataset.die,i=this.element.querySelector("#custom-roll-formula");if(!i)return;const o=i.value.trim();if(o){const a=/(\d*)d(\d+)/g,l=new Map;let n=o,d;for(;(d=a.exec(o))!==null;){const p=parseInt(d[1]||"1"),f=d[2];l.set(f,(l.get(f)||0)+p),n=n.replace(d[0],"").trim()}const g=s.substring(1);l.set(g,(l.get(g)||0)+1);const h=[];for(const[p,f]of l)h.push(`${f}d${p}`);n=n.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),n&&n!=="+"?this.formula=`${h.join(" + ")} + ${n}`:this.formula=h.join(" + ")}else this.formula=`1${s}`;i.value=this.formula,i.dispatchEvent(new Event("input"))}validateFormula(e){var t;if(!e||e.trim()==="")return!1;try{return Roll.validate(e)}catch{try{return new Roll(e,((t=this.actor)==null?void 0:t.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(u.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("CRLNGN_ROLLS.ui.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback(this.formula),this.close()}cancel(){this.close()}static async prompt(e={}){return new Promise(t=>{const s=new this({...e,callback:i=>t(i)});s.addEventListener("close",()=>{s._resolved||t(null)}),s.render(!0)})}async close(e={}){return this._resolved=!0,super.close(e)}}C(ae,"DEFAULT_OPTIONS",{id:"crlngn-custom-roll-dialog",classes:["crlngn-rolls-dialog","crlngn-custom-roll-dialog"],tag:"div",window:{title:"CRLNGN_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:400,height:"auto"}}),C(ae,"PARTS",{main:{template:`modules/${V.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${V.ID}/templates/custom-roll-dialog-footer.hbs`}});const k={addSituationalBonus(c,e){if(u.log("Flash Rolls 5e | Config before adding bonus:",[e,!c.rolls,c]),e){c.situational=e;const t={rolls:[{parts:[],data:{situational:e},options:{}}]};foundry.utils.mergeObject(c,t,{inplace:!0}),u.log("Flash Rolls 5e | Config after adding bonus:",[c])}return c},buildAbilityConfig(c,e){const t={rolls:[{...e}],ability:c.rollKey,advantage:c.config.advantage||!1,disadvantage:c.config.disadvantage||!1,target:c.config.target};return this.ensureRollFlags(t,c)},ensureRollFlags(c,e){return{...c,isRollRequest:!game.user.isGM,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM"}},async executeActivityRoll(c,e,t,s,i,o){t.rollKey&&await le.executeActivityRoll(c,e,t.rollKey,t.activityId,{...s,dialog:i,message:o})},async handleCustomRoll(c,e){const t=e.rollKey;new ae({formula:t,readonly:!0,actor:c,callback:async i=>{try{const o=new Roll(i,c.getRollData());o.options=o.options||{},o.options.isRollRequest=!0,await o.evaluate({async:!0}),await o.toMessage({speaker:ChatMessage.getSpeaker({actor:c}),flavor:game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${r.CUSTOM}`),rollMode:e.config.rollMode,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM"})}catch{ui.notifications.error(game.i18n.format("CRLNGN_ROLLS.ui.notifications.invalidFormula",{formula:i}))}}}).render(!0)},async regainHitDice(c){const e=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in e&&(e.deltas.hitDice=e.dhd),c._getRestHitDiceRecovery({maxHitDice:c.system.attributes.hd.max,type:"long"},e),u.log("RollHelpers.regainHitDice #1",[e]),e.dhd=e.deltas.hitDice,e.longRest=!0,u.log("RollHelpers.regainHitDice #2",[e]);try{if(e.updateData&&Object.keys(e.updateData).length>0){const t=await c.update(e.updateData,{isRest:!1})}else u.log("No actor updates to perform",[]);if(e.updateItems&&e.updateItems.length>0){const t=await c.updateEmbeddedDocuments("Item",e.updateItems,{isRest:!1})}else u.log("No item updates to perform",[])}catch(t){throw u.error("Error during updates in regainHitDice:",[t]),t}return u.log("RollHelpers.regainHitDice #3",[e]),e}},Y={ability:async(c,e,t,s,i)=>{const o=k.buildAbilityConfig(e,t),a=e.config.situational||t.situational||o.situational||"";k.addSituationalBonus(o,a),o.situational=a,u.log("RollHelpers.rollAbilityCheck",[a,o,e,s]),await c.rollAbilityCheck(o,s,i)},abilitycheck:async(c,e,t,s,i)=>Y.ability(c,e,t,s,i),save:async(c,e,t,s,i)=>{const o=k.buildAbilityConfig(e,t),a=e.config.situational||t.situational||o.situational;a&&k.addSituationalBonus(o,a),await c.rollSavingThrow(o,s,i)},savingthrow:async(c,e,t,s,i)=>Y.save(c,e,t,s,i),skill:async(c,e,t,s,i)=>{const o=k.ensureRollFlags({legacy:!1,skill:e.rollKey,chooseAbility:!0,ability:e.config.ability||void 0},e),a=e.config.situational||t.situational||o.situational;a&&k.addSituationalBonus(o,a),await c.rollSkill(o,s,i)},tool:async(c,e,t,s,i)=>{const o=k.ensureRollFlags({legacy:!1,tool:e.rollKey,chooseAbility:!0,ability:e.config.ability||void 0},e),a=e.config.situational||t.situational||o.situational;a&&k.addSituationalBonus(o,a),await c.rollToolCheck(o,s,i)},concentration:async(c,e,t,s,i)=>{const o=k.ensureRollFlags({legacy:!1},e),a=e.config.situational||t.situational||o.situational;a&&k.addSituationalBonus(o,a),await c.rollConcentration(o,s,i)},attack:async(c,e,t,s,i)=>{await k.executeActivityRoll(c,r.ATTACK,e,t,s,i)},damage:async(c,e,t,s,i)=>{await k.executeActivityRoll(c,r.DAMAGE,e,t,s,i)},itemsave:async(c,e,t,s,i)=>{await k.executeActivityRoll(c,r.ITEM_SAVE,e,t,s,i)},initiative:async(c,e,t,s,i)=>{if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));return}if(e.config.situational&&s.configure&&!game.user.isGM&&(c._initiativeSituationalBonus=e.config.situational),s.configure&&!game.user.isGM)await c.rollInitiativeDialog(t);else{const o=c.getInitiativeRollConfig(t);k.addSituationalBonus(o,e.config.situational),await c.rollInitiative({},o)}},initiativedialog:async(c,e,t,s,i)=>Y.initiative(c,e,t,s,i),deathsave:async(c,e,t,s,i)=>{const o=k.ensureRollFlags({...t,legacy:!1},e),a=e.config.situational||t.situational||o.situational;a&&k.addSituationalBonus(o,a),await c.rollDeathSave(o,s,i)},hitdie:async(c,e,t,s,i)=>{s.configure=game.user.isGM?s.configure:!0;const o=k.ensureRollFlags(t,e),a=e.config.situational||t.situational||o.situational;a&&k.addSituationalBonus(o,a),await c.rollHitDie(o,s,i)},custom:async(c,e,t,s,i)=>{await k.handleCustomRoll(c,e)}};async function Be(){return game.combat?!0:await Dialog.confirm({title:game.i18n.localize("COMBAT.Create"),content:"<p>"+game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.noCombatActive")+"</p>",yes:()=>!0,no:()=>!1,defaultYes:!0,options:{classes:["crlngn-rolls-dialog"]}})?(await(await game.combats.documentClass.create({scene:game.scenes.active.id})).activate(),A.notify("info",game.i18n.localize("CRLNGN_ROLL_REQUESTS.notifications.combatCreated")),!0):!1}async function ze(c,e){if(!e.combat)return c;const t=c.map(o=>e.actors.get(o)).filter(o=>o),s=[],i=new Set;for(const o of t){const a=e.combat.getCombatantByActor(o.id);a&&a.initiative!==null&&(s.push(o.name),i.add(o.id))}if(s.length>0)if(await Dialog.confirm({title:e.i18n.localize("CRLNGN_ROLLS.ui.dialogs.rerollInitiativeTitle"),content:"<p>"+e.i18n.format("CRLNGN_ROLLS.ui.dialogs.rerollInitiative",{actors:s.join(", ")})+"</p>",yes:()=>!0,no:()=>!1,defaultYes:!1,options:{classes:["crlngn-rolls-dialog"]}})){for(const a of i){const l=e.combat.getCombatantByActor(a);l&&await l.update({initiative:null})}return c}else{const a=c.filter(l=>!i.has(l));return a.length===0&&A.notify("info",e.i18n.localize("CRLNGN_ROLL_REQUESTS.notifications.allActorsHaveInitiative")),a}return c}var P;const Z=class Z extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){constructor(t={}){u.log("RollRequestsMenu.constructor");super(t);C(this,"_onClickOutside",t=>{if(u.log("_onClickOutside"),this.isLocked)return;const s=this.element;s&&(t.target.closest(".roll-requests-menu")||s.contains(t.target)||t.target.closest("#crlngn-requests-icon")||t.target.closest(".dialog, .app, .notification")||this.close())});this.selectedActors=new Set,this.currentTab="pc",this.selectedRequestType=null,this.isLocked=!1,this.optionsExpanded=game.user.getFlag(V.ID,"menuOptionsExpanded")??!1,this._initializeFromSelectedTokens()}async _prepareContext(t){u.log("_prepareContext");const s=await super._prepareContext(t),i=game.actors.contents,o=[],a=[],l=game.scenes.active;for(const R of i){if(R.type!=="character"&&R.type!=="npc")continue;const _={id:R.id,uuid:R.uuid,name:R.name,img:R.img,selected:this.selectedActors.has(R.id),crlngnStats:this._getActorStats(R)};Object.entries(R.ownership).some(([T,I])=>{const D=game.users.get(T);return D&&!D.isGM&&I>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})?o.push(_):l&&l.tokens.some(I=>I.actorId===R.id)&&a.push(_)}const n=w(),d=L.get(n.rollRequestsEnabled.tag),g=L.get(n.skipDialogs.tag),h=this.currentTab==="pc"?o:a,p=h.length>0&&h.every(R=>this.selectedActors.has(R.id)),f=[];if(this.selectedActors.size>0)for(const[R,_]of Object.entries(V.ROLL_REQUEST_OPTIONS))f.push({id:R,name:game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${_.name}`)||_.label,rollable:_.subList==null,hasSubList:!!_.subList,selected:this.selectedRequestType===R});const m=Ve(this.selectedRequestType,this.selectedActors);return{...s,actors:h,currentTab:this.currentTab,isPCTab:this.currentTab==="pc",isNPCTab:this.currentTab==="npc",selectedTab:this.currentTab,rollRequestsEnabled:d,skipDialogs:g,selectAllOn:p,hasSelectedActors:this.selectedActors.size>0,requestTypes:f,rollTypes:m,showNames:!0,actorsLocked:this.isLocked,optionsExpanded:this.optionsExpanded}}_getActorStats(t){var a,l,n,d,g,h;u.log("_getActorStats");const s=t.system,i=[];(a=s.attributes)!=null&&a.hp&&i.push({abbrev:"HP",value:s.attributes.hp.value}),(l=s.attributes)!=null&&l.ac&&i.push({abbrev:"AC",value:s.attributes.ac.value});const o=(d=(n=s.attributes)==null?void 0:n.spell)==null?void 0:d.dc;return o&&i.push({abbrev:"DC",value:o}),(h=(g=s.skills)==null?void 0:g.prc)!=null&&h.passive&&i.push({abbrev:"PP",value:s.skills.prc.passive}),i}_onRender(t,s){if(u.log("_onRender"),super._onRender(t,s),this._attachListeners(),this.optionsExpanded){const i=this.element.querySelector(".options-toggle"),o=this.element.querySelector("li.options");i&&i.classList.add("expanded"),o&&o.classList.add("expanded")}setTimeout(()=>{document.addEventListener("click",this._onClickOutside,!0)},100),this._tokenControlHook=Hooks.on("controlToken",this._onTokenControlChange.bind(this))}_onTokenControlChange(t,s){u.log("_onTokenControlChange"),this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{this._initializeFromSelectedTokens(),this.render(),this._tokenUpdateTimeout=null},100)))}_attachListeners(){var a,l,n,d,g;u.log("_attachListeners");const t=this.element;(a=t.querySelector("#crlngn-requests-toggle"))==null||a.addEventListener("change",this._onToggleRollRequests.bind(this)),(l=t.querySelector("#crlngn-skip-dialogs"))==null||l.addEventListener("change",this._onToggleSkipDialogs.bind(this)),(n=t.querySelector("#crlngn-actors-all"))==null||n.addEventListener("change",this._onToggleSelectAll.bind(this)),(d=t.querySelector("#crlngn-actors-lock"))==null||d.addEventListener("click",this._onToggleLock.bind(this)),(g=t.querySelector(".options-toggle"))==null||g.addEventListener("click",this._onToggleOptions.bind(this)),t.querySelectorAll(".actor-tab").forEach(h=>{h.addEventListener("click",this._onTabClick.bind(this))}),t.querySelectorAll(".actor").forEach(h=>{h.addEventListener("click",this._onActorClick.bind(this))}),t.querySelectorAll(".actor-select").forEach(h=>{h.addEventListener("click",this._onActorSelectClick.bind(this))});const i=t.querySelector(".request-types");i&&i.addEventListener("click",h=>{const p=h.target.closest("li");if(p&&p.dataset.id){const f={...h,currentTarget:p};this._onRequestTypeClick(f)}});const o=t.querySelector(".roll-types");o&&o.addEventListener("click",h=>{const p=h.target.closest("li");if(p&&p.dataset.id){const f={...h,currentTarget:p};this._onRollTypeClick(f)}})}async _onToggleRollRequests(t){u.log("_onToggleRollRequests");const s=w(),i=t.target.checked;await L.set(s.rollRequestsEnabled.tag,i),ke.updateRollRequestsIcon(i)}async _onToggleSkipDialogs(t){u.log("_onToggleSkipDialogs");const s=w(),i=t.target.checked;await L.set(s.skipDialogs.tag,i)}_onToggleSelectAll(t){u.log("_onToggleSelectAll");const s=t.target.checked;this._ignoreTokenControl=!0,(this.currentTab==="pc"?game.actors.contents.filter(o=>ie(o)):game.actors.contents.filter(o=>!ie(o)&&Te(o))).forEach(o=>{s?(this.selectedActors.add(o.id),oe(o.id,!0)):(this.selectedActors.delete(o.id),oe(o.id,!1))}),setTimeout(()=>{this._ignoreTokenControl=!1},200),this.render(),this._updateRequestTypesVisibility()}_onToggleLock(t){u.log("_onToggleLock"),t.preventDefault(),this.isLocked=!this.isLocked;const s=t.currentTarget;s.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),s.classList.add(this.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open")}async _onToggleOptions(t){u.log("_onToggleOptions"),t.preventDefault(),this.optionsExpanded=!this.optionsExpanded,await game.user.setFlag(V.ID,"menuOptionsExpanded",this.optionsExpanded);const s=t.currentTarget||t.target.closest(".options-toggle");s&&s.classList.toggle("expanded",this.optionsExpanded);const i=this.element.querySelector("li.options");i&&i.classList.toggle("expanded",this.optionsExpanded)}_initializeFromSelectedTokens(){var s;u.log("_initializeFromSelectedTokens");const t=((s=canvas.tokens)==null?void 0:s.controlled)||[];this.selectedActors.clear();for(const i of t)if(i.actor&&(this.selectedActors.add(i.actor.id),this.selectedActors.size===1)){const o=ie(i.actor);this.currentTab=o?"pc":"npc"}}async _onTabClick(t){var i;u.log("_onTabClick");const s=t.currentTarget.dataset.tab;s!==this.currentTab&&(this.selectedActors.clear(),(i=canvas.tokens)==null||i.releaseAll(),this.selectedRequestType=null,this.currentTab=s,await this.render())}_onActorClick(t){if(u.log("_onActorClick"),t.target.closest(".actor-select"))return;const i=t.currentTarget.dataset.id;this._toggleActorSelection(i)}_onActorSelectClick(t){u.log("_onActorSelectClick"),t.stopPropagation();const s=t.currentTarget.dataset.id;this._toggleActorSelection(s)}_toggleActorSelection(t){u.log("_toggleActorSelection"),this._ignoreTokenControl=!0,this.selectedActors.has(t)?(this.selectedActors.delete(t),oe(t,!1)):(this.selectedActors.add(t),oe(t,!0)),setTimeout(()=>{this._ignoreTokenControl=!1},100),this.render(),this._updateRequestTypesVisibility(),this._updateSelectAllState()}_updateRequestTypesVisibility(){u.log("_updateRequestTypesVisibility"),this.render()}_updateSelectAllState(){u.log("_updateSelectAllState");const t=this.element.querySelector("#crlngn-actors-all"),s=this.currentTab==="pc"?"pc":"npc",i=this.element.querySelectorAll(`.${s}-actors .actor-item input[type="checkbox"]`),o=Array.from(i).filter(a=>a.checked).length;t.checked=o>0&&o===i.length,t.indeterminate=o>0&&o<i.length}async _onRequestTypeClick(t){const s=t.currentTarget,i=s.dataset.id,o=V.ROLL_REQUEST_OPTIONS[i];if(u.log("_onRequestTypeClick",[i,s.dataset,o]),!o){u.error("Unknown request type:",i);return}this.selectedRequestType===i?this.selectedRequestType=null:this.selectedRequestType=i,o.subList?await this.render():this.selectedRequestType&&this._triggerRoll(i,null)}_onRollTypeClick(t){u.log("_onRollTypeClick");const s=t.currentTarget.dataset.id;this._triggerRoll(this.selectedRequestType,s)}_getValidActorIds(t){return t.filter(s=>{const i=game.actors.get(s);if(!i)return!1;const o=ie(i),a=!o&&Te(i);return this.currentTab==="pc"&&o||this.currentTab==="npc"&&a})}async _handleCustomRoll(){return await this._showCustomRollDialog()}async _getRollConfiguration(t,s,i,o,a){const l=w(),n=L.get(l.rollRequestsEnabled.tag);if(!o&&s!==r.CUSTOM){let d;return[r.SKILL,r.TOOL].includes(s)?d=Le:s===r.HIT_DIE?d=ye:d=z,await d.getConfiguration(t,s,i,{skipDialogs:o,defaultSendRequest:n})}else{const d={advantage:!1,disadvantage:!1,situational:"",parts:[],rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipDialog:!0,sendRequest:n&&a.length>0};return s===r.DEATH_SAVE&&(d.target=10),d}}async _executeRollRequests(t,s,i,o,a){const l=w(),n=[],d=[];if(u.log("_executeRollRequests",{config:t,rollMethodName:o,rollKey:a}),t.sendRequest){for(const{actor:g,owner:h}of s){if(!h.active){L.get(l.showOfflineNotifications.tag)&&A.notify("info",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.playerOffline",{player:h.name})),d.push(g);continue}await this._sendRollRequestToPlayer(g,h,o,a,t,!0),n.push({actor:g,owner:h}),await Ce(100)}n.length>0&&this._showConsolidatedNotification(n,o,a)}else i.push(...s.map(({actor:g})=>g));if(d.length>0){const g={...t,skipDialog:!0};await this._handleNPCRolls(d,o,a,g)}if(i.length>0){const g={...t};g.fastForward=!0,g.skipDialog=!0,await this._handleNPCRolls(i,o,a,g)}}async _triggerRoll(t,s){var m;u.log("_triggerRoll",[t,s]);const i=w(),o=Array.from(this.selectedActors),a=L.get(i.skipDialogs.tag),l=this._getValidActorIds(o);let n=l.map(R=>game.actors.get(R)).filter(R=>R);const d=V.ROLL_REQUEST_OPTIONS[t],g=(m=(d==null?void 0:d.name)||t)==null?void 0:m.toLowerCase();switch(g){case r.CUSTOM:if(s=await this._handleCustomRoll(),!s)return;break;case r.INITIATIVE:case r.INITIATIVE_DIALOG:if(!await Be())return;if(game.combat){const _=await ze(l,game);if(!_.length)return;n=_.map(b=>game.actors.get(b)).filter(b=>b)}break;case r.DEATH_SAVE:n=await Pe(n);break}if(!n.length){A.notify("warn","No valid actors selected");return}const{pcActors:h,npcActors:p}=Fe(n),f=await this._getRollConfiguration(n,g,s,a,h);f&&(await this._executeRollRequests(f,h,p,g,s),setTimeout(()=>this.close(),500))}async _sendRollRequestToPlayer(t,s,i,o,a,l=!1){u.log("_sendRollRequestToPlayer #A",[i,o]);const n=w();let d=i==null?void 0:i.toLowerCase();if(d===r.ABILITY_CHECK?d=r.ABILITY:d===r.SAVING_THROW?d=r.SAVE:d===r.INITIATIVE_DIALOG&&(d=r.INITIATIVE),d===r.HIT_DIE){const h=t.system.attributes.hd;if(h.value>0)o=h.largestAvailable;else if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["crlngn-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("CRLNGN_ROLLS.ui.dialogs.hitDie.refillMessage",{actor:t.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){try{u.log("About to call regainHitDice for",[t.name]);const f=await k.regainHitDice(t);u.log("regainHitDice completed",[f])}catch(f){u.error("Error calling regainHitDice:",[f])}o=t.system.attributes.hd.largestAvailable,u.log("_sendRollRequestToPlayer - Hit Die REFILL",[{hdData:t.system.attributes.hd}]),A.notify("info",game.i18n.format("CRLNGN_ROLLS.ui.dialogs.hitDie.refilled",{actor:t.name})||`Hit dice refilled for ${t.name}`)}else return}u.log("_sendRollRequestToPlayer - Hit Die Debug",[{rollType:d,rollKey:o,actor:t.name}]);const g={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:t.id,rollType:d,rollKey:o,activityId:null,config:{rollMode:a.rollMode||game.settings.get("core","rollMode"),advantage:a.advantage||!1,disadvantage:a.disadvantage||!1,situational:a.situational||"",parts:a.parts||[],chatMessage:a.chatMessage!==!1,target:a.target,ability:a.ability,attackMode:a.attackMode,rollTitle:a.rollTitle,requestedBy:game.user.name},skipDialog:!1,targetTokenIds:Array.from(game.user.targets).map(h=>h.id),preserveTargets:L.get(n.useGMTargetTokens.tag)};B.execForUser("handleRollRequest",s.id,g),l||A.notify("info",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestSent",{player:s.name,actor:t.name}))}_showConsolidatedNotification(t,s,i){var n,d,g,h,p;u.log("_showConsolidatedNotification");const o={};for(const{actor:f,owner:m}of t)o[m.id]||(o[m.id]={player:m,actors:[]}),o[m.id].actors.push(f);for(const[f,m]of Object.entries(V.ROLL_REQUEST_OPTIONS))if(m.name===s)break;const a=s;let l=game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${a}`)||a;if(i){const f=a.toLowerCase();if(f===r.SKILL)l=`${l} (${((n=CONFIG.DND5E.skills[i])==null?void 0:n.label)||i})`;else if(f===r.SAVING_THROW)l=`${l} (${((d=CONFIG.DND5E.abilities[i])==null?void 0:d.label)||i})`;else if(f===r.ABILITY_CHECK)l=`${l} (${((g=CONFIG.DND5E.abilities[i])==null?void 0:g.label)||i})`;else if(f===r.TOOL){const m=(p=(h=CONFIG.DND5E.enrichmentLookup)==null?void 0:h.tools)==null?void 0:p[i];if(m!=null&&m.id){const R=dnd5e.documents.Trait.getBaseItem(m.id,{indexOnly:!0});l=`${l} (${(R==null?void 0:R.name)||i})`}else l=`${l} (${i})`}else f===r.CUSTOM&&(l=`${l}: ${i}`)}A.notifyRollRequestsSent(o,l)}async _handleNPCRolls(t,s,i,o){u.log("_handleNPCRolls",[t,s,i,o]);const a={advantage:o.advantage||!1,disadvantage:o.disadvantage||!1,situational:o.situational||"",parts:o.parts||[],rollMode:o.rollMode||game.settings.get("core","rollMode"),fastForward:o.skipDialog||!1,skipDialog:o.skipDialog||!1,chatMessage:o.chatMessage!==!1,isRollRequest:!1,target:o.target,ability:o.ability,attackMode:o.attackMode};for(const l of t)await this._executeActorRoll(l,s,i,a),await Ce(100)}async _executeActorRoll(t,s,i,o){var a;u.log("_executeActorRoll",[s,i,o]);try{const l=s.toLowerCase();let n=i;if(l===r.HIT_DIE){const f=t.system.attributes.hd;if(f){const m=["d6","d8","d10","d12","d20"];for(const R of m)if((((a=f[R])==null?void 0:a.value)||0)>0){n=R;break}}if(!n){A.notify("warn",game.i18n.format("DND5E.HitDiceWarn",{name:t.name}));return}}const d={rollKey:n,config:o},g={configure:!o.fastForward&&!o.skipDialog},h={rollMode:o.rollMode||game.settings.get("core","rollMode"),create:o.chatMessage!==!1},p=Y[l];p?await p(t,d,o,g,h):A.notify("warn",`Unknown roll type: ${s}`)}catch(l){u.error("executeActorRoll",[l]),A.notify("error",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollError",{actor:t.name}))}}async _onClose(t){u.log("_onClose"),await super._onClose(t),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),this._tokenControlHook&&(Hooks.off("controlToken",this._tokenControlHook),this._tokenControlHook=null),this._tokenUpdateTimeout&&(clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=null)}setPosition(t={}){return u.log("setPosition"),this}async _showCustomRollDialog(){return u.log("_showCustomRollDialog"),ae.prompt({formula:"",readonly:!1})}static toggle(){u.log("RollRequestsMenu.toggle"),U(this,P)?U(this,P).rendered?U(this,P).close():(U(this,P)._initializeFromSelectedTokens(),U(this,P).render(!0)):(_e(this,P,new Z),U(this,P).render(!0))}};P=new WeakMap,be(Z,P,null),C(Z,"DEFAULT_OPTIONS",{id:"crlngn-requests-menu",classes:["roll-requests-menu"],tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:null}),C(Z,"PARTS",{main:{template:`modules/${V.ID}/templates/requests-menus.hbs`}});let re=Z;class ke{static addSidebarControls(e,t,s){if(!game.user.isGM||e.id!=="chat")return;const o=(t[0]||t).querySelector("#chat-controls");if(!o||o.querySelector(".roll-requests-icon"))return;const a=w(),l=L.get(a.rollRequestsEnabled.tag),n=document.createElement("a");n.id="crlngn-requests-icon",n.setAttribute("data-tooltip-direction","RIGHT"),n.className=`chat-control-icon roll-requests-icon${l?" active":""}`,n.title=game.i18n.localize("CRLNGN_ROLLS.ui.menus.rollRequestsTitle"),n.innerHTML=`<i class="fas fa-bolt${l?"":"-slash"}"></i>`;const d=o.querySelector(".chat-control-icon");d?d.parentNode.insertBefore(n,d):o.insertBefore(n,o.firstChild),n.addEventListener("click",()=>{re.toggle()})}static updateRollRequestsIcon(e){const t=document.querySelector("#crlngn-requests-icon i");t&&(t.className=`fas fa-bolt${e?"":"-slash"}`)}}class Se{static initialize(){Hooks.once(K.INIT,this._onInit.bind(this)),Hooks.once(K.READY,this._onReady.bind(this))}static _onInit(){w(),document.body.classList.add("crlngn-rolls"),L.registerSettings(),j.initialize(),this._registerHook(K.RENDER_SIDEBAR_TAB,this._onRenderSidebarTab.bind(this))}static _onReady(){const e=w();L.get(e.debugMode.tag)&&(CONFIG.debug.hooks=!0),Ie.initialize(),this._registerDnd5eHooks(),game.user.isGM?this._registerGMHooks():(j.getDiceConfig(),this._registerPlayerHooks()),He(Me())}static _registerDnd5eHooks(){this._registerHook(N.POST_ROLL_CONFIG,this._onPostRollConfig.bind(this)),this._registerHook(K.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessage.bind(this)),this._registerHook(K.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageFlavor.bind(this)),this._registerHook(N.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this))}static _registerGMHooks(){this._registerHook(K.USER_CONNECTED,this._onUserConnected.bind(this)),game.users.forEach(e=>{this._onUserConnected(e)})}static _registerPlayerHooks(){this._registerHook(N.PRE_ROLL_HIT_DIE_V2,this._onPreRollHitDieV2.bind(this)),this._registerHook(N.PRE_ROLL_INITIATIVE_DIALOG_V2,this._onPreRollInitiativeDialogV2.bind(this)),this._registerHook(N.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderHitDieDialog.bind(this))}static _onPostRollConfig(e,t,s,i){t._showRequestedBy&&e.length>0&&(i.data=i.data||{},i.data._showRequestedBy=!0,i.data._requestedBy=t._requestedBy)}static _onPreCreateChatMessage(e,t,s,i){var o;if(t._showRequestedBy&&((o=t.rolls)==null?void 0:o.length)>0){const a=t._requestedBy||"GM",l=game.i18n.format("CRLNGN_ROLL_REQUESTS.chat.requestedBy",{gm:a}),n=t.flavor||"";t.flavor=n?`${n} ${l}`:l}}static _onPreCreateChatMessageFlavor(e,t,s,i){var o,a;if(((o=t.rolls)==null?void 0:o.length)>0&&t.rolls[0])try{const l=t.rolls[0];(a=l.options)!=null&&a._customFlavor&&(t.flavor=l.options._customFlavor)}catch{}}static _onRenderRollConfigDialog(e,t,s){var a,l;if(u.log("_onRenderRollConfigDialog triggered",[{app:e,config:e.config,rolls:(a=e.config)==null?void 0:a.rolls,situational:(l=e.config)==null?void 0:l.situational,data:s}]),e._situationalTriggered)return;const i=t.querySelectorAll('input[name*="situational"]');u.log("Found situational inputs:",[i.length]);let o=!1;i.forEach((n,d)=>{var g,h,p,f,m;u.log(`Situational input ${d}:`,[{name:n.name,value:n.value,type:n.type}]),!n.value&&((f=(p=(h=(g=e.config)==null?void 0:g.rolls)==null?void 0:h[0])==null?void 0:p.data)!=null&&f.situational)&&((m=e.config)!=null&&m.isConcentration)&&(u.log("Populating concentration situational bonus:",[e.config.bonus]),n.value=e.config.rolls[0].data.situational,o=!0),n.value&&!o&&(e._situationalTriggered=!0,o=!0,setTimeout(()=>{var R,_,b;n.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1})),(b=(_=(R=e.config)==null?void 0:R.rolls)==null?void 0:_[0])!=null&&b.data&&delete e.config.rolls[0].data.situational},50))})}static _onUserConnected(e){e.active&&e.id!==game.user.id&&j.requestDiceConfigFromUser(e.id)}static _onRenderSidebarTab(e,t,s){ke.addSidebarControls(e,t,s)}static _onPreConfigureInitiative(e,t){e._initiativeSituationalBonus&&(u.log("Adding situational bonus to initiative:",["actor:",e.name,"situational:",e._initiativeSituationalBonus,"config before:",t]),(!t.rolls||t.rolls.length===0)&&(t.rolls=[{parts:[],data:{},options:{}}]),t.rolls[0].data.situational=e._initiativeSituationalBonus,u.log("Flash Rolls 5e | Initiative config after adding situational:",[t]))}static _registerHook(e,t){const s=Hooks.on(e,t);return this.registeredHooks.set(`${e}_${s}`,s),s}static unregisterAll(){this.registeredHooks.forEach((e,t)=>{const s=t.split("_")[0];Hooks.off(s,e)}),this.registeredHooks.clear()}static isRegistered(e){for(const t of this.registeredHooks.keys())if(t.startsWith(`${e}_`))return!0;return!1}static _onPreRollHitDieV2(e,t,s){if(u.log("_onPreRollHitDieV2 triggered",[e,t,s]),e.rolls&&e.rolls.length>1){const i=e.rolls[1];i&&i.data&&i.data.situational&&(e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=i.data.situational,e.rolls.splice(1,1),u.log("Consolidated hit die rolls with situational bonus",e.rolls))}}static _onPreRollInitiativeDialogV2(e,t,s){u.log("_onPreRollInitiativeDialogV2 triggered",[e,t,s]);const i=e.subject;if(i&&i._initiativeSituationalBonus){if(!e.rolls||e.rolls.length===0){const o=i.getInitiativeRollConfig({});e.rolls=o.rolls||[]}e.rolls.length>0&&(e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=i._initiativeSituationalBonus,u.log("Added situational bonus to initiative dialog",[{bonus:i._initiativeSituationalBonus,rolls:e.rolls}]),delete i._initiativeSituationalBonus)}}static _onRenderHitDieDialog(e,t,s){var n,d,g,h,p;const i=(n=t.querySelector(".window-title"))==null?void 0:n.textContent;if(!i||!i.includes("Hit Die"))return;const o=(d=e.config)==null?void 0:d.subject;if(!o)return;u.log("_onRenderHitDieDialog triggered",[{app:e,actor:o.name,hd:o.system.attributes.hd}]);const a=o.system.attributes.hd,l=[];for(const f of Object.values(o.classes||{})){const m=f.system.hitDice,R=f.system.levels,_=f.system.hitDiceUsed||0,b=R-_;if(b>0){const T=l.find(I=>I.denomination===m);T?(T.available+=b,T.classes.push(f.name)):l.push({denomination:m,available:b,max:R,classes:[f.name]})}}if(l.length>1){const f=t.querySelector(".formulas");if(!f)return;const m=((p=(h=(g=e.config.rolls)==null?void 0:g[0])==null?void 0:h.options)==null?void 0:p.denomination)||a.largestAvailable,R=`
        <div class="form-group">
          <label>${game.i18n.localize("DND5E.HitDice")}</label>
          <select name="hitDieSelector" class="hit-die-selector">
            ${l.map(b=>`
              <option value="${b.denomination}" ${b.denomination===m?"selected":""}>
                ${b.denomination} (${b.available} ${game.i18n.localize("DND5E.available")}) - ${b.classes.join(", ")}
              </option>
            `).join("")}
          </select>
        </div>
      `,_=f.querySelector(".form-group");if(_){_.insertAdjacentHTML("beforebegin",R);const b=t.querySelector(".hit-die-selector");b==null||b.addEventListener("change",async T=>{var G,S,H;const I=T.target.value;(S=(G=e.config.rolls)==null?void 0:G[0])!=null&&S.options&&(e.config.rolls[0].options.denomination=I);const D=o.system.abilities.con.mod,E=`max(0, 1${I} + ${D})`;if((H=e.config.rolls)!=null&&H[0]){e.config.rolls[0].formula=E;const q=new CONFIG.Dice.D20Roll(E,o.getRollData());await q.evaluate({async:!1}),e.config.rolls[0]=q}e.render(!0),u.log("Updated hit die denomination",[{newDenom:I,newFormula:E,conMod:D}])})}}}}C(Se,"registeredHooks",new Map);class ce{static async handleRequest(e){var s;if(u.log("handleRequest",[e]),game.user.isGM)return;const t=game.actors.get(e.actorId);!t||!t.isOwner||(e.preserveTargets&&((s=e.targetTokenIds)==null?void 0:s.length)>0&&game.user.targets.size===0&&Ge(e.targetTokenIds),A.notify("info","",{batch:!0,batchData:{actor:t.name,rollType:e.rollType,rollKey:e.rollKey,gm:e.config.requestedBy||"GM"}}),ce.executeRequest(t,e))}static async executeRequest(e,t){var s;u.log("executeRequest",[e,t]),u.log("executeRequest - Debug",[{rollType:t.rollType,rollKey:t.rollKey,actorName:e.name,handlers:Object.keys(Y)}]);try{const i=(s=t.rollType)==null?void 0:s.toLowerCase(),o={advantage:t.config.advantage||!1,disadvantage:t.config.disadvantage||!1,isRollRequest:!0,target:t.config.target,_showRequestedBy:!0,_requestedBy:t.config.requestedBy||"GM"};t.config.ability&&[r.SKILL,r.TOOL].includes(i)&&(o.ability=t.config.ability);const l={configure:!(game.user.isGM?t.skipDialog:!1),options:{defaultButton:t.config.advantage?"advantage":t.config.disadvantage?"disadvantage":"normal",window:{title:t.config.rollTitle||Ee(i,t.rollKey),subtitle:e.name}}},n={rollMode:t.config.rollMode||game.settings.get("core","rollMode"),create:t.config.chatMessage!==!1};i==="hitdie"&&u.log("RollRequestUtil - Hit Die Debug",[{normalizedRollType:i,requestData:t,rollConfig:o,handlers:Object.keys(Y)}]);const d=Y[i];d?await d(e,t,o,l,n):(u.warn(`No handler found for roll type: ${i}`),A.notify("warn",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollError",{actor:e.name||"Unknown Actor"})))}catch(i){u.error("Error executing roll request:",[i]),A.notify("error",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollError",{actor:e.name||"Unknown Actor"}))}}}class J{static init(){B.initialize(J.registerSocketCalls),Se.initialize()}static getDiceConfig(){return j.getDiceConfig()}static receiveDiceConfig(e,t){j.receiveDiceConfig(e,t)}static async handleRollRequest(e){return ce.handleRequest(e)}static registerSocketCalls(){B.registerCall(ne.getDiceConfig,J.getDiceConfig),B.registerCall(ne.receiveDiceConfig,J.receiveDiceConfig),B.registerCall(ne.handleRollRequest,J.handleRollRequest)}}J.init();
//# sourceMappingURL=crlngn-roll-requests.js.map
