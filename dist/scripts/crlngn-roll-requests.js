var Ke=Object.defineProperty;var Ee=k=>{throw TypeError(k)};var Be=(k,e,t)=>e in k?Ke(k,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):k[e]=t;var b=(k,e,t)=>Be(k,typeof e!="symbol"?e+"":e,t),De=(k,e,t)=>e.has(k)||Ee("Cannot "+t);var pe=(k,e,t)=>(De(k,e,"read from private field"),t?t.call(k):e.get(k)),de=(k,e,t)=>e.has(k)?Ee("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(k):e.set(k,t);var Y=(k,e,t)=>(De(k,e,"access private method"),t);const W={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessage",RENDER_ROLL_RESOLVER:"renderRollResolver",USER_CONNECTED:"userConnected",COLLAPSE_SIDE_BAR:"collapseSidebar"},Ue={READY:"socketlib.ready"},me={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog"},y="crlngn-roll-requests",ye=["%cRoll That For Me","color:rgb(47, 151, 161); font-weight: bold;","|"],G={ATTACK:{name:"attack",requestType:"attack"},DAMAGE:{name:"damage",requestType:"damage"},SAVE:{name:"save",requestType:"damage"},SAVING_THROW:{name:"savingthrow",requestType:"check"},ABILITY_CHECK:{name:"abilitycheck",requestType:"check"},CONCENTRATION:{name:"concentration",requestType:"check"},DEATH_SAVE:{name:"deathsave",requestType:"save"},SKILL:{name:"skill",requestType:"check"},TOOL:{name:"tool",requestType:"check"},HIT_DIE:{name:"hitdie",requestType:"formula"},INITIATIVE:{name:"initiative",requestType:"check"},FORMULA:{name:"formula",requestType:"formula"},RECHARGE:{name:"recharge",requestType:"formula"},D20_TEST:{name:"d20Test",requestType:"formula"},SHORT_REST:{name:"shortRest",requestType:"formula"},LONG_REST:{name:"longRest",requestType:"formula"}},je={SAVE:"save"},Oe={ACTIVITY:"activity",CHECK:"check"},L={ABILITY_CHECK:{name:"abilityCheck",label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:"savingThrow",label:"Saving Throw",subList:"abilities",actorPath:"system.savingThrows"},SKILL:{name:"skill",label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:"tool",label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:"concentration",label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:"initiativeDialog",label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:"deathSave",label:"Death Save",subList:null,actorPath:""},CUSTOM:{name:"custom",label:"Custom Roll",subList:null,actorPath:""}},ve=class ve{static log(e="",t=[],s=!1){try{const a=game.settings.get(y,"debugMode")||ve.debugOn;if(!(s||a))return;console.log(...ye,e,...t)}catch{console.log(...ye,e,...t)}}static warn(e="",t=[]){console.warn(...ye,e,...t)}static error(e,t={ui:!1,console:!0,permanent:!1}){var s;t.ui&&((s=ui.notifications)==null||s.error(e,{localize:!0,permanent:t.permanent})),t.console&&console.error(...ye,e)}};b(ve,"debugOn",!1);let c=ve;const be={checkbox:"checkbox"},Te={client:"client",world:"world"},K=()=>({debugMode:{tag:"debug-mode",label:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:be.checkbox,default:!0,scope:Te.client,config:!0},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:be.checkbox,default:!0,scope:Te.world,config:!0},skipDialogs:{tag:"skip-dialogs",label:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.hint"),propType:Boolean,inputType:be.checkbox,default:!1,scope:Te.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:be.checkbox,default:!1,scope:Te.world,config:!0}});class P{static getTargets(e){let t=game.users.find(a=>a.isGM===!0),s=e.targets||t.targets;return new Set([...s])}static getActorFromItem(e){const t=e.split(".")[1];return game.actors.get(t)}static isModuleOn(e){var s;const t=(s=game.modules)==null?void 0:s.get(e);return!!(t!=null&&t.active)}static isPrivateRoll(e){return e===CONST.DICE_ROLL_MODES.BLIND||e===CONST.DICE_ROLL_MODES.PRIVATE}static removeTemplateForItem(e){c.log("removeTemplateForItem - A",[e]);const t=I.get("remove-template");if(c.log("removeTemplateForItem - B",[t]),!t)return;const s=canvas.templates.objects.children.filter(a=>a.document.flags.dnd5e.item===(e==null?void 0:e.uuid));canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",s.map(a=>a.id))}static getPlayerOwner(e){let t;if(!e)return null;const s=e?game.actors.get(e):null;return t=game.users.players.find(o=>o.active===!0&&o.character.id===e),t||game.users.players.forEach(o=>{o.active&&s.testUserPermission(o,foundry.CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER,{exact:!0})&&(t=o)}),t}static html(e,t){return e.querySelector(t)}static getActivityType(e){var t;return((t=Object.values(G).find(s=>s.name.toLowerCase()===e.toLowerCase()))==null?void 0:t.activityType)||""}static getPartsFromActivityUuid(e){const t=e.split(".");return{actorId:t[1],itemId:t[3],activityId:t[5]}}static getElement(e){return(e==null?void 0:e[0])||e}static getSceneTargets(){var t;let e=((t=canvas.tokens)==null?void 0:t.controlled.filter(s=>s.actor))??[];return!e.length&&game.user.character&&(e=game.user.character.getActiveTokens()),e}static getAdvantageMode(e){return e.advantage?CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE:e.disadvantage?CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE:CONFIG.Dice.D20Roll.ADV_MODE.NORMAL}}b(P,"getClientTargets",()=>{if(!game.user)return[];const e=Array.from(game.user.targets);return c.log("Selected Targets",[game.user.id,e,e.filter(t=>t.actor)]),e}),b(P,"getTargetDescriptors",()=>{var t,s;const e=new Map;for(const a of game.user.targets){const{name:o}=a,{img:l,system:n,uuid:r,statuses:u}=a.actor??{};if(r){const d=u.has("coverTotal")?null:(s=(t=n.attributes)==null?void 0:t.ac)==null?void 0:s.value;e.set(r,{name:o,img:l,uuid:r,ac:d??null})}}return Array.from(e.values())}),b(P,"findItemFromActor",(e,t,s)=>{const a=game.actors.get(e);if(c.log("findItemFromActor",[t,s]),!a)return null;let o=t?a.items.find(l=>l.id===t):null;return o||(o=s?a.items.find(l=>l.name.toLowerCase()===s.toLowerCase()):null,o||(o=a.items.find(l=>l.name.toLowerCase()===(s+" (Legacy)").toLowerCase()))),o}),b(P,"addCSSVars",(e,t)=>{let s=document.querySelector("#crlngn-chat-vars");if(!s){const g=document.querySelector("body");s=document.createElement("style"),s.id="crlngn-chat-vars",s.textContent=`body.crlngn-chat {
}
`,g.prepend(s)}let a=s.textContent,o=a.indexOf("body.crlngn-chat {"),l=a.indexOf("}",o);o===-1&&(a=`body.crlngn-chat {
}
`,o=0,l=a.indexOf("}"));const r=a.substring(o+18,l).split(";").map(g=>g.trim()).filter(g=>g!==""),u={};r.forEach(g=>{const f=g.split(":");if(f.length>=2){const T=f[0].trim(),C=f.slice(1).join(":").trim();T&&(u[T]=C)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),u[e]=t;const d=Object.entries(u).map(([g,f])=>`  ${g}: ${f};`).join(`
`),p=a.substring(0,o)+`body.crlngn-chat {
`+d+`
}`+a.substring(l+1);s.textContent=p});const h=class h{static serializeForTransport(e,t=!1){return e==null||(t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(s=>s instanceof Roll?s.toJSON():s)),c.log("ROLLS DATA",[e,e.subject])),e}static deserializeFromTransport(e,t=!1){let s={...e};if(!e)return s;if(t&&e.rolls&&e.rolls.length>0){const a=s.rolls.map(o=>{let l=o;return typeof o=="string"?l=Roll.fromJSON(o):l=Roll.fromJSON(JSON.stringify(o)),c.log("ROLL",[l,o]),l});return s.rolls=[...a],s}return s}};b(h,"socket"),b(h,"_activeExecutions",new Map),b(h,"initialize",e=>{Hooks.once(Ue.READY,()=>{if(c.log("Attempting to register module..."),typeof socketlib>"u"){c.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("CRLNGN_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{h.socket=socketlib.registerModule(y),e&&e(),c.log("SocketUtil | Module registered",[h.socket])}catch(t){c.log("Problem registering module",[t])}})}),b(h,"registerCall",(e,t)=>{h.socket?(h.socket.register(e,t),c.log("SocketUtil - Registered callback",[h.socket,e])):c.log("SocketUtil - Failed to register callback (socket not initialized)",[h.socket,e])}),b(h,"sendMessage",(e,t)=>{c.log("SocketUtil - sendMessage",[e]),t&&t()}),b(h,"execForGMs",async(e,...t)=>{if(!h.socket){c.log("SocketUtil - Socket not initialized. Cannot execute as GM.");return}return await h.socket.executeForAllGMs(e,...t)}),b(h,"execForAll",async(e,...t)=>{if(!h.socket){c.log("SocketUtil - Socket not initialized. Cannot execute for all clients.");return}return await h.socket.executeForEveryone(e,...t)}),b(h,"execForUser",async(e,t,...s)=>{if(!h.socket){c.log("SocketUtil - Socket not initialized. Cannot execute as user.");return}if(t===game.user.id)return c.log("SocketUtil - Preventing recursive call",[t]),null;const a=`${e}-${t}`;if(h._activeExecutions.has(a))return c.log("SocketUtil - Preventing recursive call",[a]),null;h._activeExecutions.set(a,!0);try{const o=await h.socket.executeAsUser(e,t,...s);return c.log("SocketUtil - Executed as user.",[o]),o}catch(o){return c.log("SocketUtil - Error executing as user",[o]),null}finally{h._activeExecutions.delete(a)}});let F=h;var he,Me;const N=class N{static init(){Hooks.on(W.RENDER_CHAT_MESSAGE,Y(N,he,Me))}static testDamage(e){const{activity:t,config:s,message:a,dialog:o}=e;t.rollDamage()}static rollModifiedAttack(e,t,s){c.log("rollModifiedAttack",[e,t,s,this]);const{activity:a}=N.getDataFromUuid(t.dataset.activityUuid);a.rollAttack({event:e,advantage:t.dataset.advantage==="true",disadvantage:t.dataset.disadvantage==="true",attackMode:t.dataset.attackMode,ammunition:t.dataset.ammunition,situational:t.dataset.situational},{},s)}static getDataFromUuid(e){var l,n,r;const t=e.split("."),s=game.actors.get(t[1]),a=s==null?void 0:s.items.get(t[3]),o=((n=(l=a==null?void 0:a.system)==null?void 0:l.activities)==null?void 0:n.get(t[5]))||((r=a==null?void 0:a.activities)==null?void 0:r.get(t[5]));return{actor:s,item:a,activity:o}}};he=new WeakSet,Me=function(e,t,s){var n,r,u;const a=((n=e.flags)==null?void 0:n[y])||((u=(r=s.message)==null?void 0:r.flags)==null?void 0:u[y]);if(c.log("#onRenderChatMessage",[e,t,s,a]),!(a!=null&&a.modifiedActions))return;const o=a.activityUuid;if(!o)return;const{activity:l}=N.getDataFromUuid(o);l&&(c.log("#onRenderChatMessage Activating button listeners",[l,e,t]),l.activateChatListeners(e,t[0]))},de(N,he),b(N,"triggerActivity",async e=>{var S,E,O,M;const{activityUuid:t,diceTypes:s,config:a,dialog:o,message:l}=e;c.log("triggerActivity #1",[s,a,o,l,e]),R.playerDiceConfigs[game.user.id];const n=a.situational?Number(a.situational):0,r=t.split("."),u=game.actors.get(r[1]),d=u==null?void 0:u.items.get(r[3]),p=((E=(S=d==null?void 0:d.system)==null?void 0:S.activities)==null?void 0:E.get(r[5]))||((O=d==null?void 0:d.activities)==null?void 0:O.get(r[5])),g=((M=a.hookNames)==null?void 0:M[0])||p.type,f=F.deserializeFromTransport(a,!0);if(c.log("triggerActivity #2",[g,f,e]),!u||!d||!p)return;const T={...f,subject:p,parts:f.parts||[]},C={...o},A={...l,flavor:f.flavor};switch(n&&!T.parts.includes("@situational")&&T.parts.push("@situational"),g){case G.ATTACK.name:{N.useAttack({activity:p,config:T,message:A,dialog:C}),c.log("triggerActivity attack",[T,C,A]);break}case G.DAMAGE.name:{c.log("triggerActivity damage",[p,T,C,A]),N.useDamage({activity:p,config:T,message:A,dialog:C});break}case G.SAVE.name:{c.log("triggerActivity save",[T]),A.create=!0,p.use(T,C,A);break}}c.log("triggerActivity #3",[t,a,e])}),b(N,"useAttack",async e=>{const{activity:t,config:s,message:a,dialog:o}=e,l=await t._usageChatContext(a);t.metadata.usage.actions;const n=l.buttons.find(g=>g.dataset.action==="rollAttack");c.log("useAttack #1",[e]);const r={situational:s.situational,attackMode:s.attackMode,advantage:s.advantage,disadvantage:s.disadvantage,ammunition:s.ammunition};n.dataset={...n==null?void 0:n.dataset,...r,action:"rollAttack",activityUuid:t.uuid||""},t.metadata.usage.actions={...t.metadata.usage.actions,rollAttack:N.rollModifiedAttack};const u=foundry.utils.mergeObject({rollMode:a.rollMode||game.settings.get("core","rollMode"),data:{content:await renderTemplate(t.metadata.usage.chatCard,l),speaker:ChatMessage.getSpeaker({actor:t.actor}),flags:{core:{canPopout:!0},[y]:{modifiedActions:!0,activityType:t.type,activityUuid:t.uuid}}}},a),d=["d20"],p=R.areDiceConfigured(d,game.user.id);o.configure=!p,c.log("useAttack",[t,l,u,e]),await ChatMessage.create(u.data),t.rollAttack(r,o,{create:!0})}),b(N,"useDamage",async e=>{var l,n,r;const{activity:t,config:s,message:a,dialog:o}=e;if(c.log("useDamage #1",[e,s.attackMode]),s.rolls&&s.rolls.length>0){s.rolls[0];const u={event:s.event,situational:s.situational||"",attackMode:s.attackMode,subject:t};c.log("useDamage - Using roll from config",[u]);const p=(((l=t==null?void 0:t.damage)==null?void 0:l.parts)||((r=(n=t==null?void 0:t.rolls)==null?void 0:n[0])==null?void 0:r.parts)||[]).map(f=>"d"+f.denomination),g=R.areDiceConfigured(p,game.user.id);o.configure=!g,c.log("useDamage #2",[u,o]),N.rollDamage({config:u,attackMode:u.attackMode});return}c.log("useDamage - No rolls in config, using direct roll"),t.rollDamage()}),b(N,"rollDamage",async e=>{let{activity:t,attackMode:s,config:a,formulas:o,damageTypes:l,rollType:n,scaling:r}=e;o=(o==null?void 0:o.split("&"))??[],l=(l==null?void 0:l.split("&"))??[];const u={...a,attackMode:s,hookNames:["damage"],rolls:o.map((g,f)=>{var C;const T=((C=l[f])==null?void 0:C.split("|"))??[];return{parts:[g],options:{type:T[0],types:T}}})},d={create:!0,data:{flags:{dnd5e:{messageType:"roll",roll:{type:n},targets:P.getTargetDescriptors()}},flavor:game.i18n.localize(`DND5E.${n==="healing"?"Healing":"Damage"}Roll`),speaker:ChatMessage.implementation.getSpeaker()}},p=await CONFIG.Dice.DamageRoll.build(u,{},d);p!=null&&p.length&&Hooks.callAll("dnd5e.rollDamageV2",p)});let Le=N;var qe,Ne;const{MODIFIER_CODES:Ce,MODIFIER_KEYS:We}=((Ne=(qe=foundry.helpers)==null?void 0:qe.interaction)==null?void 0:Ne.KeyboardManager)??KeyboardManager;Ce.Alt,Ce.Control.filter(k=>k.startsWith("Control")),Ce.Control.filter(k=>!k.startsWith("Control")),Ce.Shift;const ke={};function Ie(k,{indexOnly:e=!1,fullItem:t=!1}={}){const s=Ve(k),{collection:a,documentId:o}=foundry.utils.parseUuid(s),l=a==null?void 0:a.metadata.id;if(t&&!e)return a==null?void 0:a.getDocument(o);const n=ke[l],r=n instanceof Promise;if(e){const p=a==null?void 0:a.index.get(o);return r?p:(n==null?void 0:n[o])??p}if(r)return n.then(()=>ke[l][o]);if(n)return n[o];if(!a)return;const u=$e(),d=a.getIndex({fields:u}).then(p=>{const g=p.reduce((f,T)=>(f[T._id]=T,f),{});return ke[l]=g,g[o]});return ke[l]=d,d}function Ve(k){if(k.startsWith("Compendium."))return k;let e=CONFIG.DND5E.sourcePacks.ITEMS,[t,s,a]=k.split(".");return t&&s&&(e=`${t}.${s}`),a||(a=k),`Compendium.${e}.Item.${a}`}function $e(){const k=["system.type.value"];for(const e of Object.values(CONFIG.DND5E.traits))e.subtypes&&k.push(`system.${e.subtypes.keyPath}`);return k}var Ae,ge;const i=class i{static init(){i.preloadHandlebarsTemplates()}static getPlayerActors(){const e=game.actors.filter((t,s)=>t.type==="character");return e.sort((t,s)=>t.name.localeCompare(s.name)),i.actors.pc=e,e}static getNPCActors(){var s;const e=(s=game.scenes.viewed)==null?void 0:s.tokens.map(a=>a.actor);c.log("getNPCActors",[e]);const t=e.filter((a,o)=>a.type==="npc");return t.sort((a,o)=>a.name.localeCompare(o.name)),i.actors.npc=t,t}static preloadHandlebarsTemplates(){const e=["modules/crlngn-roll-requests/templates/requests-menus.hbs"];return loadTemplates(e)}static injectRollRequestsMenu(){document.querySelector("#chat-controls").insertAdjacentHTML("afterbegin",'<label class="chat-control-icon active" id="crlngn-requests-icon" data-tooltip-direction="RIGHT"><i class="fas fa-bolt"></i></label>');const t=document.querySelector("#crlngn-requests-icon");return R.requestsEnabled,t.addEventListener("click",i.onRequestsToggleClick),t.addEventListener("mouseenter",i.showActorsMenu),t.addEventListener("mouseleave",i.hideActorsMenu),c.log("TEST",[game,CONFIG.DND5E]),t}static async showActorsMenu(e){K();const t=i.getPlayerActors(),s=i.getNPCActors(),a=document.querySelector("#crlngn-actors-menu"),o=document.querySelector("#crlngn-requests-icon"),l=i.selectedTab;a&&a.remove();const n=l==="pc"?t:s;c.log("showActorsMenu",[l,i.selectedActors[l],i.selectedTab]),c.log("NPCs",[i.getNPCActors()]);const r=Object.values(L).map(f=>({id:f.name,name:f.label,selected:!1,rollable:f.subList===null}));i.selectedActors[l].map(f=>f.id);const u=await renderTemplate("modules/crlngn-roll-requests/templates/requests-menus.hbs",{actors:n.map(f=>{var A,S;const T=i.selectedActors[l].some(E=>E.id===f.id);let C=[];return f.type==="character"?C=[{abbrev:"AC",value:f.system.attributes.ac.value},{abbrev:"HP",value:f.system.attributes.hp.value},{abbrev:"DC",value:f.system.attributes.spelldc},{abbrev:"PRC",value:f.system.skills.prc.passive}]:f.type==="npc"&&(C=[{abbrev:"AC",value:f.system.attributes.ac.value||""},{abbrev:"HP",value:f.system.attributes.hp.value||""},{abbrev:"DC",value:f.system.attributes.spelldc||""},{abbrev:"PRC",value:((S=(A=f.system.skills)==null?void 0:A.prc)==null?void 0:S.passive)||""}]),{id:f.id,name:f.name,img:f.img,selected:T,crlngnStats:C}}),selectedTab:i.selectedTab,showNames:!1,requestTypes:r,actorsLocked:i.actorsLocked,requestsEnabled:R.requestsEnabled,selectAllOn:i.selectAllOn,skipDialogs:R.skipDialogs});document.body.insertAdjacentHTML("beforeend",`<div id="crlngn-actors-menu">${u}</div>`),i.actorsMenu=document.querySelector("#crlngn-actors-menu");const d=o.getBoundingClientRect(),p=d.top;d.height;const g=i.actorsMenu;g.addEventListener("mouseleave",i.hideActorsMenu),g.style.zIndex=100,g.style.right="var(--current-sidebar-width, 0px)",g.style.top=`${p}px`,setTimeout(()=>{const f=g.getBoundingClientRect(),T=window.innerHeight;f.bottom>T?(g.style.top="auto",g.classList.add("grow-up")):g.classList.remove("grow-up"),i.addMenuListeners(i.actorsMenu)},0),i.markSelectedActors()}static addMenuListeners(e){const t=e.querySelectorAll(".actor"),s=e.querySelectorAll(".actor .actor-img"),a=e.querySelector("#crlngn-actors-all"),o=e.querySelector("#crlngn-actors-lock"),l=e.querySelector("#crlngn-requests-toggle"),n=e.querySelector("#crlngn-skip-dialogs"),r=e.querySelectorAll(".actors-tabs button");i.selectAllCheckbox=a,t.forEach(u=>{u.addEventListener("click",i.onActorToggle),u.addEventListener("contextmenu",i.onActorContext)}),s.forEach(u=>{u.addEventListener("click",i.onActorOpenSheet)}),a.addEventListener("change",i.onAllActorsToggle),o.addEventListener("click",i.onActorLockClick),l.addEventListener("change",i.onRequestsToggleClick),n.addEventListener("change",i.onDialogsToggleClick),r.forEach(u=>{u.addEventListener("click",i.onTabClick)})}static onRequestsToggleClick(e){var n;const t=K(),s=document.querySelector("#crlngn-requests-toggle"),a=(n=i.actorsMenu)==null?void 0:n.querySelector("#crlngn-rolls-toggle-requests input[type='checkbox']"),o=e.target.id==="crlngn-requests-toggle",l=o?!e.target.classList.contains("active"):a==null?void 0:a.checked;c.log("onRequestsToggleClick",[l,o]),l?(s.classList.add("active"),a&&(a.checked=!0)):(s.classList.remove("active"),a&&(a.checked=!1)),R.requestsEnabled=l,I.set(t.rollRequestsEnabled.tag,l)}static onDialogsToggleClick(e){const t=K(),a=e.target.checked;c.log("onDialogsToggleClick",[a]),R.skipDialogs=a,I.set(t.skipDialogs.tag,a)}static hideActorsMenu(){const e=i.actorsMenu;i.actorsLocked||e&&setTimeout(()=>{e.matches(":hover")||(e.remove(),i.selectedRequestType=null)},750)}static showRequestTypes(){const e=i.actorsMenu.querySelector("ul.request-types");e?(e.classList.add("visible"),e.querySelectorAll("li").forEach(s=>{s._hasClickListener||(s.addEventListener("click",pe(i,Ae)),s._hasClickListener=!0)})):c.log("Request types menu not found",[])}static hideRequestTypes(){const e=i.actorsMenu.querySelector("ul.request-types");e&&e.classList.remove("visible"),i.hideRollTypes()}static showOptionsForRequestType(e){var n;const t=i.selectedTab,s=i.selectedActors[t],a=Object.values(L).find(r=>r.name===e);if(c.log("showOptionsForRequestType",[s,a,e]),!a)return;if(a.subList===null&&s.length>0){R.initRollRequest({config:{hookNames:[e]},actors:s.map(r=>r.id)}),c.log("showOptionsForRequestType - Sending roll request",[s,e]);return}const o=i.actorsMenu.querySelector("ul.roll-types");if(!o)return;o.innerHTML="";const l=CONFIG.DND5E[a.subList];if(c.log("System list for request type",[e,l,CONFIG.DND5E]),!!l){for(const[r,u]of Object.entries(l)){const d=document.createElement("li");if(d.dataset.abbreviation=r,d.dataset.fullKey=u.fullKey||r,d.dataset.label=u.label||"",d.dataset.type=e,a.subList===L.TOOL.subList){const p=CONFIG.DND5E.enrichmentLookup.tools[r],g=p?(n=Ie(p.id,{indexOnly:!0}))==null?void 0:n.name:null;d.dataset.label=g}d.innerHTML=`<i class="icon fas fa-dice-d20"></i>${d.dataset.label}`,d.addEventListener("click",pe(i,ge)),o.appendChild(d)}o.classList.add("visible")}}static hideRollTypes(){const e=i.actorsMenu.querySelector("ul.roll-types");e&&(e.classList.remove("visible"),e.querySelectorAll(".selected").forEach(t=>t.classList.remove("selected")),i.selectedOptionType=null)}static onActorLockClick(e){const t=e.target;i.actorsLocked=!i.actorsLocked,i.actorsLocked?(t.classList.add("fa-lock-keyhole"),t.classList.remove("fa-lock-keyhole-open")):(t.classList.add("fa-lock-keyhole-open"),t.classList.remove("fa-lock-keyhole"))}static setItemSelection(e,t){e.dataset.selected=t?"true":"false";const s=e.querySelector(".actor-select i");c.log("setItemSelection",[e,t]),t?(e.classList.add("selected"),s.classList.add("fa-circle-dot"),s.classList.remove("fa-circle")):(e.classList.remove("selected"),s.classList.remove("fa-circle-dot")),i.hideRollTypes()}static showOptionsForRequestType(e){var n;const t=i.selectedTab,s=i.selectedActors[t],a=Object.values(L).find(r=>r.name===e);if(c.log("showOptionsForRequestType",[s,a,e]),!a)return;if(a.subList===null&&s.length>0){R.initRollRequest({config:{hookNames:[e]},actors:s.map(r=>r.id)}),c.log("showOptionsForRequestType - Sending roll request",[s,e]);return}const o=i.actorsMenu.querySelector("ul.roll-types");if(!o)return;o.innerHTML="";const l=CONFIG.DND5E[a.subList];if(c.log("System list for request type",[e,l,CONFIG.DND5E]),!!l){for(const[r,u]of Object.entries(l)){const d=document.createElement("li");if(d.dataset.abbreviation=r,d.dataset.fullKey=u.fullKey||r,d.dataset.label=u.label||"",d.dataset.type=e,a.subList===L.TOOL.subList){const p=CONFIG.DND5E.enrichmentLookup.tools[r],g=p?(n=Ie(p.id,{indexOnly:!0}))==null?void 0:n.name:null;d.dataset.label=g}d.innerHTML=`<i class="icon fas fa-dice-d20"></i>${d.dataset.label}`,d.addEventListener("click",pe(i,ge)),o.appendChild(d)}o.classList.add("visible")}}static hideRollTypes(){const e=i.actorsMenu.querySelector("ul.roll-types");e&&(e.classList.remove("visible"),e.querySelectorAll(".selected").forEach(t=>t.classList.remove("selected")),i.selectedOptionType=null)}static onActorLockClick(e){const t=e.target;i.actorsLocked=!i.actorsLocked,i.actorsLocked?(t.classList.add("fa-lock-keyhole"),t.classList.remove("fa-lock-keyhole-open")):(t.classList.add("fa-lock-keyhole-open"),t.classList.remove("fa-lock-keyhole"))}static setItemSelection(e,t){e.dataset.selected=t?"true":"false";const s=e.querySelector(".actor-select i");c.log("setItemSelection",[e,t]),t?(e.classList.add("selected"),s.classList.add("fa-circle-dot"),s.classList.remove("fa-circle")):(e.classList.remove("selected"),s.classList.remove("fa-circle-dot"),s.classList.add("fa-circle"))}static onActorToggle(e){c.log("onActorToggle",[e]);const t=e.target.closest(".actor");if(!t)return;i.setItemSelection(t,t.dataset.selected!="true");const s=i.actorsMenu.querySelectorAll(".actor"),a=Array.from(s).every(u=>u.dataset.selected==="true"),o=Array.from(s).some(u=>u.dataset.selected==="true");i.selectAllCheckbox.checked=a,i.selectAllCheckbox.indeterminate=o&&!a,c.log("onActorToggle - checked states",[a,o]);const n=Array.from(s).filter(u=>u.dataset.selected==="true").map(u=>u.dataset.id),r=i.selectedTab;i.selectedActors[r]=i.actors[r].filter(u=>n.includes(u.id)),i.selectAllOn=a,o?i.showRequestTypes():i.hideRequestTypes(),c.log("onActorToggle - selected actors",[n,i.selectedActors])}static onActorContext(e){const t=e.target.closest(".actor");if(!t)return;const s=i.selectedTab,a=t.dataset.id,l=i.actors[s].find(n=>n.id===a).token;l&&canvas.animatePan({x:l.x,y:l.y,scale:1})}static onActorOpenSheet(e){e.stopPropagation();const t=e.target.closest(".actor");if(!t)return;const s=i.selectedTab,a=t.dataset.id,o=i.actors[s].find(l=>l.id===a);o&&o.sheet.render(!0)}static onAllActorsToggle(e){const t=i.selectedTab,s=e.target.checked,a=i.actorsMenu.querySelectorAll(".actor");i.selectedActors[t]=[],i.selectAllOn=s,a.forEach(o=>{i.setItemSelection(o,s),i.selectedActors[t].push(i.actors[t].find(l=>l.id===o.dataset.id))}),s?i.showRequestTypes():i.hideRequestTypes()}static markSelectedActors(){const e=i.selectedTab,t=i.actorsMenu.querySelectorAll(".actor"),s=i.selectedActors[e].map(a=>a.id);t.forEach(a=>{s.includes(a.dataset.id)?i.setItemSelection(a,!0):i.setItemSelection(a,!1)}),i.selectedActors[e].length>0?i.showRequestTypes():i.hideRequestTypes()}static onTabClick(e){const t=e.target.dataset.tab;if(t===i.selectedTab)return;i.selectedTab=t,e.target.closest(".actors-tabs").querySelectorAll("button").forEach(a=>{a.classList.remove("active")}),e.target.classList.add("active"),i.showActorsMenu(),c.log("Tab changed",[t,i.selectedTab])}};Ae=new WeakMap,ge=new WeakMap,b(i,"actorsMenu",null),b(i,"actors",{pc:[],npc:[]}),b(i,"selectedActors",{pc:[],npc:[]}),b(i,"selectedRequestType",null),b(i,"selectedOptionType",null),b(i,"selectAllCheckbox",null),b(i,"actorsLocked",!1),b(i,"selectAllOn",!1),b(i,"selectedTab","pc"),de(i,Ae,e=>{const t=i.actorsMenu.querySelector("ul.request-types");t&&(i.hideRollTypes(),t.querySelectorAll(".selected").forEach(s=>{s!==e.target&&s.classList.remove("selected")}),e.target.classList.toggle("selected"),e.target.classList.contains("selected")?(i.selectedRequestType=e.target.dataset.id,i.showOptionsForRequestType(i.selectedRequestType)):(i.selectedRequestType=null,i.hideRollTypes()),c.log("showRequestTypes - item clicked",[e.target.dataset,i.selectedRequestType]))}),de(i,ge,e=>{const t=i.selectedTab,s=i.actorsMenu.querySelector("ul.roll-types");if(!s)return;s.querySelectorAll(".selected").forEach(o=>o.classList.remove("selected")),e.target.classList.add("selected");const a=e.target.dataset.type;i.selectedOptionType={key:e.target.dataset.abbreviation,fullKey:e.target.dataset.fullKey,label:e.target.dataset.label},c.log("Selected option",[i.selectedOptionType]),R.initRollRequest({config:{hookNames:[a]},dataset:e.target.dataset,actors:i.selectedActors[t].map(o=>o.id)})});let J=i;var q,we,Ge,Pe,Fe,xe,ze,He;const m=class m{static init(){c.log("RequestsUtil.init() - Registering hooks",[],!0),Hooks.on(me.PRE_ROLL_V2,Y(m,q,He)),Hooks.on(me.PRE_USE_ACTIVITY,Y(m,q,xe)),Hooks.on(me.RENDER_ROLL_CONFIGURATION_DIALOG,Y(m,q,Ge)),Hooks.on(me.POST_ROLL_CONFIG,Y(m,q,Pe)),Hooks.on(W.RENDER_ROLL_RESOLVER,Y(m,q,Fe)),Hooks.on(W.RENDER_CHAT_MESSAGE,Y(m,q,we))}static registerSocketCalls(){Object.values(m.SOCKET_CALLS).forEach(e=>{e.type===Oe.ACTIVITY?F.registerCall(e.action,Le[e.action]):F.registerCall(e.action,m[e.action])})}static initRollRequest(e={config:{},dialog:{configure:!0},message:{},actors:[],activityUuid:null}){var n,r,u,d,p,g,f,T,C,A,S,E,O,M,B,U,j,V,x,$;const t=e.actors;if(c.log("initRollRequest #A",[e,t]),!t[0]){game.users.isGM&&ui.notifications.error("No actor selected for this roll request");return}const s=game.actors.get(t[0]);m.SOCKET_CALLS.triggerRollRequest.action,e.config={...e.config,flags:{...e.config.flags,[y]:{rollRequest:!0,type:(n=e.dataset)==null?void 0:n.type}}};const a={...e,message:{...e.message},actors:t};m.forcePublicRoll&&J.selectedTab==="pc"&&(a.message.rollMode=CONST.DICE_ROLL_MODES.PUBLIC),a.config.tool=((r=e.dataset)==null?void 0:r.type)===L.TOOL.name?(u=e.dataset)==null?void 0:u.abbreviation:"",a.config.skill=((d=e.dataset)==null?void 0:d.type)===L.SKILL.name?(p=e.dataset)==null?void 0:p.abbreviation:"";const o=(g=e.dataset)==null?void 0:g.abbreviation;let l="";((f=e.dataset)==null?void 0:f.type)===L.TOOL.name?l=((A=(C=(T=s.system)==null?void 0:T.tools)==null?void 0:C[o])==null?void 0:A.ability)||((S=CONFIG.DND5E.tools[o])==null?void 0:S.ability):((E=e.dataset)==null?void 0:E.type)===L.SKILL.name?l=((B=(M=(O=s.system)==null?void 0:O.skills)==null?void 0:M[o])==null?void 0:B.ability)||((U=CONFIG.DND5E.skills[o])==null?void 0:U.ability):((j=e.dataset)==null?void 0:j.type)===L.SAVING_THROW.name||((V=a.dataset)==null?void 0:V.type)===L.ABILITY_CHECK.name?l=o:((x=e.dataset)==null?void 0:x.type)===G.ATTACK.name&&(a.rollOptions={actorId:s.id,activityUuid:e.activityUuid,attackMode:"",hookNames:(($=e.config)==null?void 0:$.hookNames)||[]}),a.config.ability=l,a.config.abilityId=l,c.log("initRollRequest #B",[o,a]),m.triggerRollRequest(a,!0)}static triggerRollRequest(e,t=!1){var S,E,O,M,B,U,j,V,x,$,Z,_,ee,te,se,ae,oe,le,ie,ce,ne,w,Q,z,D,re,ue,Re,fe;let{config:s={},dialog:a={},message:o={},rollOptions:l=null,actors:n=[]}=e,r=null,u=null;const d=game.actors.get(n[0]);if(c.log("triggerRollRequest #A",[n,d,e]),!d){c.log("triggerRollRequest - no actor found",[]);return}const p=K(),g=I.get(p.useGMTargetTokens.tag),f=P.getTargets(game.user);if((g||f.length===0)&&(l!=null&&l.targetTokens)){(S=canvas.tokens.placeables[0])==null||S.setTarget(!1,{releaseOthers:!0});for(let H of canvas.tokens.placeables)l.targetTokens.includes(H.id)&&H.setTarget(!0,{releaseOthers:!1})}let T={};if(l){T={isTemplateRoll:t,actors:[],ability:l.ability,abilityId:l.ability,tool:l.tool,skill:l.skill,advantage:l.advantage||!1,disadvantage:l.disadvantage||!1,situational:l.situational||"",attackMode:l.attackMode||"",target:l.target||null,dc:l.dc||null,type:l.rollType||"",flavor:((E=o==null?void 0:o.data)==null?void 0:E.flavor)||"",hookNames:s.hookNames||[]},s={...T,event:null,flags:{...s.flags,[y]:{...(O=s.flags)==null?void 0:O[y],isTemplateRoll:t}},rolls:[{parts:[],options:{dc:options.dc||null,rollType:options.rollType||""}}]};const{itemId:H,activityId:X}=l.activityUuid?P.getPartsFromActivityUuid(l.activityUuid):{};r=H?d.items.get(H):null,u=X?(B=(M=r==null?void 0:r.system)==null?void 0:M.activities)==null?void 0:B.get(X):null}else s.flags={...s.flags,[y]:{...(U=s.flags)==null?void 0:U[y],isTemplateRoll:t}};a={...a,configure:t?!m.skipDialogs:a.configure,options:{...a.options,window:{...(j=a.options)==null?void 0:j.window,subtitle:t&&n.length>1?game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.multipleActors"):d.name}}},((V=o==null?void 0:o.data)!=null&&V.flavor||s!=null&&s.flavor)&&(a.options.window.title=((x=o==null?void 0:o.data)==null?void 0:x.flavor)||(s==null?void 0:s.flavor));let C=m.getTypeFromHookNames(s.hookNames||[]);o={flags:{[y]:{rollRequest:!0,rollOptions:T,type:C,actors:t?n:[],isTemplateRoll:t}}};const A=Object.values(L).find(H=>H.name===C);switch(o.flavor=A==null?void 0:A.label,c.log("triggerRollRequest #C",[s,a,o]),!0){case((Z=($=s.hookNames)==null?void 0:$[0])==null?void 0:Z.toLowerCase())===L.SKILL.name.toLowerCase():d.rollSkill(s,a,o),C=L.SKILL.name;break;case((ee=(_=s.hookNames)==null?void 0:_[0])==null?void 0:ee.toLowerCase())===L.TOOL.name.toLowerCase():d.rollToolCheck(s,a,o),C=L.TOOL.name;break;case((se=(te=s.hookNames)==null?void 0:te[0])==null?void 0:se.toLowerCase())===L.ABILITY_CHECK.name.toLowerCase():d.rollAbilityCheck(s,a,o),C=L.ABILITY_CHECK.name;break;case((oe=(ae=s.hookNames)==null?void 0:ae[0])==null?void 0:oe.toLowerCase())===L.SAVING_THROW.name.toLowerCase():d.rollSavingThrow(s,a,o),C=L.SAVING_THROW.name;break;case((ie=(le=s.hookNames)==null?void 0:le[0])==null?void 0:ie.toLowerCase())===L.INITIATIVE.name.toLowerCase():d.rollInitiativeDialog({situational:s.situational||"",advantage:s.advantage,disadvantage:s.disadvantage}),C=L.INITIATIVE.name;break;case((ne=(ce=s.hookNames)==null?void 0:ce[0])==null?void 0:ne.toLowerCase())===L.DEATH_SAVE.name.toLowerCase():d.rollDeathSave(s,a,o),C=L.DEATH_SAVE.name;break;case((Q=(w=s.hookNames)==null?void 0:w[0])==null?void 0:Q.toLowerCase())===L.CONCENTRATION.name.toLowerCase():d.rollConcentration(s,a,o),C=L.CONCENTRATION.name;break;case((D=(z=s.hookNames)==null?void 0:z[0])==null?void 0:D.toLowerCase())===G.DAMAGE.name.toLowerCase():c.log("triggerRollRequest - damage #1",[u,s,a,o]),u&&(s.rolls=[],u.rollDamage(s,a,o));break;case((ue=(re=s.hookNames)==null?void 0:re[0])==null?void 0:ue.toLowerCase())===G.ATTACK.name.toLowerCase():c.log("triggerRollRequest - attack #1",[u,s,a,o]),u&&(o.flavor="",o.content="",c.log("triggerRollRequest - use",[o]),u.use({},a,o));break;case((fe=(Re=s.hookNames)==null?void 0:Re[0])==null?void 0:fe.toLowerCase())===G.FORMULA.name.toLowerCase():c.log("triggerRollRequest - formula",[s,a,o]);break;default:c.log("triggerRollRequest - default",[s,a,o]);break}}static areDiceConfigured(e,t){const s=m.playerDiceConfigs[t];if(!s)return!1;const a=(e==null?void 0:e.map(l=>(s==null?void 0:s[l])!==""&&(s==null?void 0:s[l])!==void 0&&(s==null?void 0:s[l])!==null))||[],o=a.includes(!0)||!1;return c.log("areDiceConfigured",[a,e,s,o]),o}static allowsDC(e){return e[0].toLowerCase()===G.SKILL.name.toLowerCase()||e[0].toLowerCase()===G.TOOL.name.toLowerCase()||e[0].toLowerCase()===G.SAVING_THROW.name.toLowerCase()||e[0].toLowerCase()===G.ABILITY_CHECK.name.toLowerCase()}static getTypeFromHookNames(e){let t="";return Object.values(L).forEach(s=>{e.includes(s.name)&&(t=s.name)}),t}static addModuleFlags(e,t,s){var o,l,n,r,u,d,p,g;const a={...(l=(o=e.data)==null?void 0:o.flags)==null?void 0:l[y],...(n=e.flags)==null?void 0:n[y]};return(!((r=e.data)!=null&&r.flags)||!((d=(u=e.data)==null?void 0:u.flags)!=null&&d[y]))&&(e.data={...e.data,flags:{...(p=e.data)==null?void 0:p.flags,[y]:a}}),(g=e.data.flags[y].actors)!=null&&g.length||(e.data.flags[y].actors=[s.id]),t.subject instanceof dnd5e.dataModels.activity.BaseActivityData&&(e.data.flags[y].activityUuid=t.subject.uuid,e.data.flags[y].requestType="activity"),c.log("addModuleFlags",[e]),e}};q=new WeakSet,we=function(e,t){const s=e.getFlag(y,"rollRequest"),a=e.getFlag(y,"type"),o=t[0]||t;c.log("#onRenderChatMessage",[e,t,a]),s&&o.querySelector(`button[data-type=${a}]`).addEventListener("click",n=>{const u=n.currentTarget.dataset,d=game.actors.get(u.actorId);d&&(c.log("onButtonClick",[n,d]),d.rollInitiativeDialog({event:n}))})},Ge=function(e,t){var u,d,p,g,f,T,C;const s=e.config,a=e.message,o=((u=s==null?void 0:s.subject)==null?void 0:u.actor)||(s==null?void 0:s.subject),l=o?P.getPlayerOwner(o.id):null;if(c.log("#onRenderRollConfigurationDialog #1",[l,e,a,m.requestsEnabled]),!(l!=null&&l.active)||!m.requestsEnabled)return;game.user.isGM&&m.addModuleFlags(a,s,o);let n=P.getElement((d=s==null?void 0:s.event)==null?void 0:d.target);const r=n?(p=n.closest(".card-buttons"))==null?void 0:p.querySelector("button[data-action]"):null;if(c.log("#onRenderRollConfigurationDialog #2",[]),m.handleRollDialogInputs(r,e,t),!game.user.isGM||J.selectedTab!=="pc"){const A=t.querySelector("button[autofocus]"),S=s.subject;S&&((g=S.damage)==null||g.parts);const E=((C=(T=(f=s.rolls)==null?void 0:f[0])==null?void 0:T.dice)==null?void 0:C.map(M=>M.denomination))||["d20"],O=m.areDiceConfigured(E,l.id);c.log("#onRenderRollConfigurationDialog #3",[e,s,O,E]),O&&setTimeout(()=>A.click(),500)}c.log("#onRenderRollConfigurationDialog #4",[])},Pe=function(e,t,s,a){var g,f,T,C,A,S,E,O,M,B,U,j,V;const o={...(f=(g=a.data)==null?void 0:g.flags)==null?void 0:f[y],...(T=a.flags)==null?void 0:T[y]},l=(o==null?void 0:o.actors)||[],r=!!((o==null?void 0:o["ddb-game-log"])||((A=(C=a.data)==null?void 0:C.flags)==null?void 0:A["ddb-game-log"])),u=((S=t.subject)==null?void 0:S.actor)||t.subject;c.log("#onPostRollConfiguration #A",[l==null?void 0:l.length,e==null?void 0:e[0],u]),game.actors.get(l[0]),(O=(E=e==null?void 0:e[0])==null?void 0:E.data)!=null&&O.flags&&(e[0].data.flags={...e[0].data.flags,[y]:{isDdbGl:r}});const d=((B=(M=e==null?void 0:e[0])==null?void 0:M.dice)==null?void 0:B.map(x=>x.denomination))||[];let p=((V=(j=(U=a.data)==null?void 0:U.flags)==null?void 0:j[y])==null?void 0:V.requestType)==="activity"||!1;return(async()=>{var x,$,Z,_,ee,te,se,ae,oe,le,ie,ce,ne;for(let w=0;w<l.length;w++){c.log("#onPostRollConfiguration #Ai",[w,l[w]]),s.configure=w===0?!m.skipDialogs:!1;const Q=l[w].id||l[w],z=game.actors.get(Q),D=Q?P.getPlayerOwner(Q):null;if(c.log("#onPostRollConfiguration #B",[r,z.name,D,e,t,s,a]),game.user.isGM&&(D!=null&&D.active)&&m.requestsEnabled){const re=m.SOCKET_CALLS.triggerRollRequest.action;m.areDiceConfigured(["d20"],D.id);const ue=t.subject instanceof dnd5e.dataModels.activity.BaseActivityData,fe=(P.getClientTargets()||[]).map(X=>X.id),H={config:t,dialog:s,message:a,rollOptions:{ability:(($=(x=e[0])==null?void 0:x.data)==null?void 0:$.abilityId)||t.ability,abilityId:((_=(Z=e[0])==null?void 0:Z.data)==null?void 0:_.abilityId)||t.ability,activityUuid:ue?t.subject.uuid:null,actors:l[w]?[l[w]]:[],advantage:((ee=e[0])==null?void 0:ee.hasAdvantage)||!1,attackMode:((se=(te=e[0])==null?void 0:te.options)==null?void 0:se.attackMode)||t.attackMode||"",dc:t.dc||t.target||null,diceTypes:d,disadvantage:((ae=e[0])==null?void 0:ae.hasDisadvantage)||!1,flavor:((oe=a==null?void 0:a.data)==null?void 0:oe.flavor)||"",hookNames:t.hookNames||[],isTemplateRoll:!1,playerOwner:(D==null?void 0:D.id)||"",rollType:((ie=(le=e[0])==null?void 0:le.options)==null?void 0:ie.rollType)||"",situational:((ne=(ce=e[0])==null?void 0:ce.data)==null?void 0:ne.situational)||"",skill:t==null?void 0:t.skill,target:t.target||t.dc||null,targetTokens:ue?fe:null,tool:t==null?void 0:t.tool}};ui.notifications.info(`Roll Request sent for ${z.name} (${D.name})`),p=!0,await F.execForUser(re,D.id,H),c.log("#onPostRollConfiguration - sending to...",[p,re,D==null?void 0:D.id,H]),await new Promise(X=>setTimeout(X,500))}else p=!1,t.event=null,s={...s,window:{...s.window,subtitle:z.name}},m.triggerRollRequest({config:t,dialog:s,actors:[z.id],message:a},!1),c.log("#onPostRollConfiguration - rolling for...",[z,D==null?void 0:D.name,t,s,a])}})(),p?!1:void 0},Fe=function(e,t){var a,o,l;const s=e.roll;if(c.log("#onRenderRollResolver AAA",[s==null?void 0:s.data,e,t]),(l=(o=(a=s==null?void 0:s.data)==null?void 0:a.flags)==null?void 0:o[y])!=null&&l.isDdbGl)return e.close(),!1},xe=function(e,t,s,a){var r,u,d,p,g;c.log("#onPreUseActivity #A",[e,t,s,a]);const o=e==null?void 0:e.actor,l=o?P.getPlayerOwner(o.id):null,n=((u=(r=a==null?void 0:a.flags)==null?void 0:r[y])==null?void 0:u.rollRequest)||!1;c.log("#onPreUseActivity #B",[l==null?void 0:l.active,m.requestsEnabled,n]),l!=null&&l.active&&m.requestsEnabled&&!n?(a.create=!1,a.data={...a.data,flags:{...(d=a.data)==null?void 0:d.flags,[y]:{...(g=(p=a.data)==null?void 0:p.flags)==null?void 0:g[y],playerOwner:(l==null?void 0:l.id)||""}}},c.log("#onPreUseActivity #C",[l])):c.log("#onPreUseActivity #D",[l,n])},ze=function(e,t,s,a){var l,n,r;c.log("#onPostUseActivity",[e.type,je.SAVE,e,t,s,a]);const o=m.getPlayerOwner(e.actor.id);if(c.log("#onPostUseActivity #2",[o,m.requestsEnabled]),o!=null&&o.active&&m.requestsEnabled){a.create=!1,a.data={...a.data,flags:{...(l=a.data)==null?void 0:l.flags,[y]:{...(r=(n=a.data)==null?void 0:n.flags)==null?void 0:r[y],playerOwner:(o==null?void 0:o.id)||""}}},c.log("#onPostUseActivity #3",[o]);return}},He=function(e,t,s){var o,l,n;const a=((o=s==null?void 0:s.flags)==null?void 0:o[y])||((n=(l=s==null?void 0:s.data)==null?void 0:l.flags)==null?void 0:n[y])||{};c.log("#onPreRollV2",[e,t,s,a])},de(m,q),b(m,"forcePublicRoll",!1),b(m,"requestsEnabled",!1),b(m,"skipDialogs",!1),b(m,"SOCKET_CALLS",{triggerRollRequest:{action:"triggerRollRequest",type:Oe.CHECK}}),b(m,"diceConfig",{}),b(m,"playerDiceConfigs",{}),b(m,"createRequestMessage",async(e,t)=>{var l;c.log("createRequestMessage",[e,t]);const s=Object.values(L).find(n=>n.name===t.type);if(!s)return;const a={type:t.type,ability:t.config.ability,abilityId:t.config.ability,skill:t.config.skill,tool:t.config.tool,dc:t.config.target||"",actorId:e.id,action:t.action||"roll",visibility:(l=game.users.find(n=>e===n.character))==null?void 0:l.id,target:e.uuid},o=[];game.user.id,await renderTemplate("systems/dnd5e/templates/chat/request-card.hbs",{buttons:o}),ChatMessage.implementation.getSpeaker({alias:"Roll That For Me"}),`${a.actorId}${a.type}${s==null?void 0:s.label}`,c.log("createRequestMessage",[chatMessage])}),b(m,"handleRollDialogInputs",async(e,t,s)=>{var d,p,g,f,T,C,A,S;const a=((g=(p=(d=t.message)==null?void 0:d.flags)==null?void 0:p[y])==null?void 0:g.rollOptions)||{};s.querySelector(".formulas.dc");let o=s.querySelector('input[name="dc"]');const l=e?Number((f=e==null?void 0:e.dataset)==null?void 0:f.dc):(a==null?void 0:a.dc)||t.config.dc||void 0;if(o&&(o.value=l),(T=t==null?void 0:t.config)!=null&&T.flavor){const E=s.querySelector(".window-title");E.textContent=t.config.flavor}if(!o){const E=await renderTemplate(`modules/${y}/templates/roll-dc-field.hbs`,{label:game.i18n.localize("CRLNGN_ROLLS.ui.forms.dcFieldLabel"),dc:l});if(m.allowsDC(t.config.hookNames)){const O=s.querySelector(".window-content .rolls .formulas");O==null||O.insertAdjacentHTML("beforebegin",E)}}o=s.querySelector('input[name="dc"]'),game.user.isGM||((C=s.querySelector(".formulas.dc"))==null||C.classList.add("hidden"),o==null||o.setAttribute("hidden",!0)),e&&o&&(o.value=(A=e==null?void 0:e.dataset)==null?void 0:A.dc),o&&(a.dc=Number(o.value),t.config.dc=Number(o.value)),o==null||o.addEventListener("change",()=>{a.dc=Number(o.value),t.config.dc=Number(o.value)||""}),c.log("handleRollDialogInputs",[t.config,a]);const n=`data-${y}-${game.user.id}-custom-event`,r=s.querySelector('input[name="roll.0.situational"]'),u=Number((S=e==null?void 0:e.dataset)==null?void 0:S.situational)||(a==null?void 0:a.situational)||"";!s.hasAttribute(n)&&r&&(s.setAttribute(n,"true"),r.value=u||"",r.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))),s.setAttribute(n,"true")});let R=m;class I{static registerSettings(){const e=K();Object.entries(e).forEach(async s=>{const a=s[1];c.log("Registering... ",[s]);const o={name:a.label,hint:a.hint,default:a.default,type:a.propType,scope:a.scope,config:a.config,requiresReload:a.requiresReload||!1,onChange:l=>I.apply(a.tag,l)};a.choices&&(o.choices=a.choices),await game.settings.register(y,a.tag,o),I.get(a.tag)===void 0&&I.set(a.tag,a.default),c.log("registerSettings",[a.tag,I.get(a.tag)])}),I.applySkipDialogsSetting()}static get(e,t=y){if(!e)return null;let s=!1;if(t===y)s=game.settings.get(t,e);else{let o=game.settings.storage.get("client")[`${t}.${e}`];o===void 0&&(o=game.settings.storage.get("world").getSetting(`${t}.${e}`),s=o==null?void 0:o.value),c.log("GET Setting",[o,s])}return s}static set(e,t,s=y){if(!e)return!1;let a=game.settings.storage.get("client")[`${s}.${e}`];a||(a=game.settings.storage.get("world").getSetting(`${s}.${e}`)),c.log("Setting",[e,a]);try{game.settings.set(s,e,t)}catch{c.log("Unable to change setting",[e,a])}return!0}static apply(e,t){const s=K();switch(e){case s.rollRequestsEnabled.tag:I.applyRollRequestsSetting(t);break;case s.skipDialogs.tag:I.applySkipDialogsSetting(t);break}}static applyRollRequestsSetting(e){const t=K();c.log("applyRollRequestsSetting",[e]);const s=e||I.get(t.rollRequestsEnabled.tag);R.requestsEnabled=s;const a=document.querySelector("#crlngn-requests-toggle");if(!a)return;s===!1?a.classList.remove("active"):a.classList.add("active");const o=game.i18n.localize(a.classList.contains("active")?"CRLNGN_ROLLS.ui.buttons.rollRequestsToggleOn":"CRLNGN_ROLLS.ui.buttons.rollRequestsToggleOff");a.dataset.tooltip=o,game.user.isGM&&game.tooltip&&game.tooltip.activate(a,{text:o}),J.hideActorsMenu(),J.showActorsMenu(),c.log("Roll Requests Toggle",[s,a])}static applySkipDialogsSetting(e){const t=K();R.skipDialogs=e||I.get(t.skipDialogs.tag),c.log("applySkipDialogsSetting",[e])}}const v=class v{static init(){F.initialize(v.registerSocketCalls),Hooks.once(W.INIT,()=>{K(),c.log("Initiating module...",[],!0),I.registerSettings(),R.init(),Le.init(),J.init(),v.setDiceConfig()}),Hooks.once(W.READY,()=>{var s,a;c.log("Core Ready",[ui==null?void 0:ui.sidebar,(s=ui==null?void 0:ui.sidebar)==null?void 0:s._collapsed]);const e=K();var t=I.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),game.user.isGM?(Hooks.on(W.USER_CONNECTED,v.onUserConnected),game.users.forEach(o=>{v.onUserConnected(o)}),I.applyRollRequestsSetting(),J.injectRollRequestsMenu(),Hooks.on(W.COLLAPSE_SIDE_BAR,o=>{c.log(W.COLLAPSE_SIDE_BAR,[o._collapsed]),o&&v.checkSideBar(!o._collapsed)}),v.checkSideBar(!((a=ui==null?void 0:ui.sidebar)!=null&&a._collapsed))):v.getDiceConfig()})}static onUserConnected(e){e.active&&e.id!==game.user.id&&(c.log("onUserConnected",[e]),F.execForUser(v.SOCKET_CALLS.getDiceConfig,e.id))}static setDiceConfig(){if(!game.user)return;const e=game.settings.storage.get("client");return v.diceConfig=e["core.diceConfiguration"]||"",c.log("getDiceConfig",[v.diceConfig]),v.diceConfig}static getDiceConfig(){if(game.user)if(v.setDiceConfig(),game.user.isGM){R.playerDiceConfigs[game.user.id]=v.diceConfig,F.execForGMs(v.SOCKET_CALLS.receiveDiceConfig,game.user.id,v.diceConfig);return}else R.playerDiceConfigs[game.user.id]=v.diceConfig?JSON.parse(v.diceConfig):{}}static receiveDiceConfig(e,t){var s;((s=game.user)!=null&&s.isGM||e===game.user.id)&&(R.playerDiceConfigs||(R.playerDiceConfigs={}),R.playerDiceConfigs[e]=t?JSON.parse(t):{},c.log(`Received dice configuration from user ${e}`,[R.playerDiceConfigs]))}static registerSocketCalls(){F.registerCall(v.SOCKET_CALLS.getDiceConfig,v.getDiceConfig),F.registerCall(v.SOCKET_CALLS.receiveDiceConfig,v.receiveDiceConfig),R.registerSocketCalls()}};b(v,"diceConfig",{}),b(v,"SOCKET_CALLS",{receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig"}),b(v,"checkSideBar",e=>{const t=document.querySelector("body");e?t.classList.add("sidebar-expanded"):t.classList.remove("sidebar-expanded")});let Se=v;Se.init();
//# sourceMappingURL=crlngn-roll-requests.js.map
