var ie=Object.defineProperty;var H=E=>{throw TypeError(E)};var ae=(E,e,t)=>e in E?ie(E,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):E[e]=t;var L=(E,e,t)=>ae(E,typeof e!="symbol"?e+"":e,t),ne=(E,e,t)=>e.has(E)||H("Cannot "+t);var w=(E,e,t)=>e.has(E)?H("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(E):e.set(E,t);var d=(E,e,t)=>(ne(E,e,"access private method"),t);const D={INIT:"init",READY:"ready",RENDER_ROLL_RESOLVER:"renderRollResolver",USER_CONNECTED:"userConnected"},re={READY:"socketlib.ready"},C={PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheck",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrow",PRE_BEGIN_CONCENTRATING:"dnd5e.preBeginConcentrating",PRE_END_CONCENTRATION:"dnd5e.preEndConcentration",PRE_ROLL_CONCENTRATION_V2:"dnd5e.preRollConcentrationV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_CHECK_V2:"dnd5e.preRollToolCheckV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_CLASS_HIT_POINTS:"dnd5e.preRollClassHitPoints",PRE_ROLL_NPC_HIT_POINTS:"dnd5e.preRollNPCHitPoints",PRE_ROLL_INITIATIVE_DIALOG:"dnd5e.preRollInitiativeDialog",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",PRE_ROLL_FORMULA_V2:"dnd5e.preRollFormulaV2",PRE_ROLL_RECHARGE_V2:"dnd5e.preRollRechargeV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_SKILL_TOOL_ROLL_CONFIGURATION_DIALOG:"renderSkillToolRollConfigurationDialog"},m="crlngn-roll-requests",A=["%cRoll That For Me","color:rgb(47, 151, 161); font-weight: bold;","|"],ce={SKILL:{name:"skill"}},v=class v{static log(e="",t=[],o=!1){try{const s=game.settings.get(m,"debugMode")||v.debugOn;if(!(o||s))return;console.log(...A,e,...t)}catch{console.log(...A,e,...t)}}static warn(e="",t=[]){console.warn(...A,e,...t)}static error(e,t={ui:!1,console:!0,permanent:!1}){var o;t.ui&&((o=ui.notifications)==null||o.error(e,{localize:!0,permanent:t.permanent})),t.console&&console.error(...A,e)}};L(v,"debugOn",!1);let i=v;const M={checkbox:"checkbox"},q={client:"client",world:"world"},_=()=>({debugMode:{tag:"debug-mode",label:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:M.checkbox,default:!0,scope:q.client,config:!0},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:M.checkbox,default:!0,scope:q.world,config:!0}});class I{static getTargets(e){let t=game.users.find(s=>s.isGM===!0),o=e.targets||t.targets;return new Set([...o])}static getActorFromItem(e){const t=e.split(".")[1];return game.actors.get(t)}static isModuleOn(e){var o;const t=(o=game.modules)==null?void 0:o.get(e);return!!(t!=null&&t.active)}static isPrivateRoll(e){return e===CONST.DICE_ROLL_MODES.BLIND||e===CONST.DICE_ROLL_MODES.PRIVATE}static removeTemplateForItem(e){i.log("removeTemplateForItem - A",[e]);const t=p.get("remove-template");if(i.log("removeTemplateForItem - B",[t]),!t)return;const o=canvas.templates.objects.children.filter(s=>s.document.flags.dnd5e.item===(e==null?void 0:e.uuid));canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",o.map(s=>s.id))}static getUserFromActor(e){let t;if(!e)return null;const o=e?game.actors.get(e):null;return t=game.users.players.find(l=>l.active===!0&&l.character.id===e),t||game.users.players.forEach(l=>{l.active&&o.testUserPermission(l,foundry.CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER,{exact:!0})&&(t=l)}),i.log("getUserFromActor",[e,t]),t}static html(e,t){return e.querySelector(t)}}L(I,"getClientTargets",()=>{if(!game.user)return[];const e=Array.from(game.user.targets);return i.log("Selected Targets",[game.user.id,e,e.filter(t=>t.actor)]),e}),L(I,"getTargetDescriptors",()=>{var t,o;const e=new Map;for(const s of game.user.targets){const{name:l}=s,{img:c,system:r,uuid:u,statuses:g}=s.actor??{};if(u){const S=g.has("coverTotal")?null:(o=(t=r.attributes)==null?void 0:t.ac)==null?void 0:o.value;e.set(u,{name:l,img:c,uuid:u,ac:S??null})}}return Array.from(e.values())}),L(I,"findItemFromActor",(e,t,o)=>{const s=game.actors.get(e);if(i.log("findItemFromActor",[t,o]),!s)return null;let l=t?s.items.find(c=>c.id===t):null;return l||(l=o?s.items.find(c=>c.name.toLowerCase()===o.toLowerCase()):null,l||(l=s.items.find(c=>c.name.toLowerCase()===(o+" (Legacy)").toLowerCase()))),l}),L(I,"addCSSVars",(e,t)=>{let o=document.querySelector("#crlngn-chat-vars");if(!o){const T=document.querySelector("body");o=document.createElement("style"),o.id="crlngn-chat-vars",o.textContent=`body.crlngn-chat {
}
`,T.prepend(o)}let s=o.textContent,l=s.indexOf("body.crlngn-chat {"),c=s.indexOf("}",l);l===-1&&(s=`body.crlngn-chat {
}
`,l=0,c=s.indexOf("}"));const u=s.substring(l+18,c).split(";").map(T=>T.trim()).filter(T=>T!==""),g={};u.forEach(T=>{const P=T.split(":");if(P.length>=2){const y=P[0].trim(),N=P.slice(1).join(":").trim();y&&(g[y]=N)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),g[e]=t;const S=Object.entries(g).map(([T,P])=>`  ${T}: ${P};`).join(`
`),f=s.substring(0,l)+`body.crlngn-chat {
`+S+`
}`+s.substring(c+1);o.textContent=f});const R=class R{static serializeForTransport(e,t=!1){return e==null||(t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(o=>o instanceof Roll?o.toJSON():o)),i.log("ROLLS DATA",[e])),e}static deserializeFromTransport(e,t=!1){let o={};return e==null?e:(t&&e.rolls&&e.rolls.length>0&&(o={...e,rolls:e.rolls.map(s=>typeof s=="string"?Roll.fromJSON(s):Roll.fromJSON(JSON.stringify(s)))}),i.log("ROLLS RESULT",[o]),o)}};L(R,"socket"),L(R,"initialize",e=>{Hooks.once(re.READY,()=>{if(i.log("Attempting to register module..."),typeof socketlib>"u"){i.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("CRLNGN_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{R.socket=socketlib.registerModule(m),e&&e(),i.log("SocketUtil | Module registered",[R.socket])}catch(t){i.log("Problem registering module",[t])}})}),L(R,"registerCall",(e,t)=>{R.socket?(R.socket.register(e,t),i.log("SocketUtil - Registered callback",[R.socket,e])):i.log("SocketUtil - Failed to register callback (socket not initialized)",[R.socket,e])}),L(R,"sendMessage",(e,t)=>{i.log("SocketUtil - sendMessage",[e]),t&&t()}),L(R,"execForGMs",async(e,...t)=>{if(!R.socket){i.log("SocketUtil - Socket not initialized. Cannot execute as GM.");return}return await R.socket.executeForAllGMs(e,...t)}),L(R,"execForAll",async(e,...t)=>{if(!R.socket){i.log("SocketUtil - Socket not initialized. Cannot execute for all clients.");return}return await R.socket.executeForEveryone(e,...t)}),L(R,"execForUser",async(e,t,...o)=>{if(!R.socket){i.log("SocketUtil - Socket not initialized. Cannot execute as user.");return}const s=await R.socket.executeAsUser(e,t,...o);return i.log("SocketUtil - Executed as user.",[s]),s});let b=R;var a,G,F,x,K,z,B,j,$,U,W,J,Y,Q,X,Z,ee,te,oe,se,le;const n=class n{static init(){Hooks.on(D.RENDER_ROLL_RESOLVER,d(n,a,le)),Hooks.on(C.PRE_ROLL_ABILITY_CHECK,d(n,a,x)),Hooks.on(C.PRE_ROLL_SAVING_THROW,d(n,a,K)),Hooks.on(C.PRE_BEGIN_CONCENTRATING,d(n,a,z)),Hooks.on(C.PRE_END_CONCENTRATION,d(n,a,B)),Hooks.on(C.PRE_ROLL_CONCENTRATION_V2,d(n,a,j)),Hooks.on(C.PRE_ROLL_DEATH_SAVE_V2,d(n,a,$)),Hooks.on(C.PRE_ROLL_SKILL_V2,d(n,a,F)),Hooks.on(C.PRE_ROLL_TOOL_CHECK_V2,d(n,a,U)),Hooks.on(C.PRE_ROLL_HIT_DIE_V2,d(n,a,W)),Hooks.on(C.PRE_ROLL_CLASS_HIT_POINTS,d(n,a,J)),Hooks.on(C.PRE_ROLL_NPC_HIT_POINTS,d(n,a,Y)),Hooks.on(C.PRE_ROLL_INITIATIVE_DIALOG,d(n,a,Q)),Hooks.on(C.PRE_ROLL_INITIATIVE,d(n,a,X)),Hooks.on(C.PRE_ROLL_ATTACK_V2,d(n,a,Z)),Hooks.on(C.PRE_ROLL_DAMAGE_V2,d(n,a,ee)),Hooks.on(C.PRE_ROLL_FORMULA_V2,d(n,a,te)),Hooks.on(C.PRE_ROLL_RECHARGE_V2,d(n,a,oe)),Hooks.on(C.RENDER_SKILL_TOOL_ROLL_CONFIGURATION_DIALOG,d(n,a,G)),Hooks.on(C.POST_ROLL_CONFIG,d(n,a,se))}static registerSocketCalls(){b.registerCall(n.SOCKET_CALLS.triggerRollSkillV2,n.triggerRollSkillV2)}static getPlayerOwner(e){return game.users.find(t=>{var o;return((o=t.character)==null?void 0:o.id)===e})}};a=new WeakSet,G=function(e,t){var c,r,u,g,S;i.log("#onRenderRollConfigurationDialog",[e,t]);const o=(u=(r=(c=e.config)==null?void 0:c.event)==null?void 0:r.target)==null?void 0:u.closest("button[data-action=rollRequest]"),s=`data-${m}-event-triggered`;if(t.hasAttribute(s))return;const l=o?Number(((g=o==null?void 0:o.dataset)==null?void 0:g.situational)||"0"):((S=e.config)==null?void 0:S.situational)||void 0;if(l!=null&&l!==0){const f=t.querySelector('input[name="roll.0.situational"]');f?(f.value!=l&&(f.value=l),t.setAttribute(s,"true"),f.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))):(i.warn("onRenderRollConfigurationDialog | Could not find situational bonus input field."),t.setAttribute(s,"true"))}else i.log("onRenderRollConfigurationDialog | No situational bonus found or bonus is zero."),t.setAttribute(s,"true")},F=function(e,t,o){var c,r,u,g,S;i.log("#onPreRollSkillV2",[e,t,o]);const s=(r=(c=e.event)==null?void 0:c.target)==null?void 0:r.closest("button[data-action=rollRequest]"),l=s?Number(s.dataset.situational):e.situational;s&&(e.advantage=s.dataset.advantage==="true",e.disadvantage=s.dataset.disadvantage==="true",e.ability=s.dataset.ability,e.abilityId=s.dataset.ability,e.situational=l,s.dataset.flavor&&(o.data.flavor=s.dataset.flavor,(u=t.options)!=null&&u.window&&(t.options.window.title=s.dataset.flavor))),l!==void 0&&(e.parts||(e.parts=[]),e.parts.includes("@situational")||e.parts.push("@situational")),e.rolls||(e.rolls=[]);for(const f of e.rolls)f.data||(f.data={}),f.data.flags||(f.data.flags={}),f.data.flags[m]={flavor:((S=(g=t.options)==null?void 0:g.window)==null?void 0:S.title)||o.data.flavor},f.data={flags:f.data.flags,situational:l,target:s!=null&&s.dataset.dc?Number(s.dataset.dc):e.target,ability:(s==null?void 0:s.dataset.ability)||e.ability},f.resetFormula&&f.resetFormula(),i.log("#onPreRollSkillV2 - roll",[f]);return!0},x=function(e){i.log("#onPreRollAbilityCheck",[e])},K=function(e){i.log("#onPreRollSavingThrow",[e])},z=function(e,t){i.log("#onPreBeginConcentrating",[e,t])},B=function(e,t){i.log("#onPreEndConcentration",[e,t])},j=function(e,t,o){i.log("#onPreRollConcentrationV2",[e,t,o])},$=function(e,t,o){i.log("#onPreRollDeathSaveV2",[e,t,o])},U=function(e,t,o){i.log("#onPreRollToolCheckV2",[e,t,o])},W=function(e,t,o){i.log("#onPreRollHitDieV2",[e,t,o])},J=function(e,t,o){i.log("#onPreRollClassHitPoints",[e,t,o])},Y=function(e,t){i.log("#onPreRollNPCHitPoints",[e,t])},Q=function(e){i.log("#onPreRollInitiativeDialog",[e])},X=function(e,t){i.log("#onPreRollInitiative",[e,t])},Z=function(e,t,o){i.log("#onPreRollAttackV2",[e,t,o])},ee=function(e,t,o){i.log("#onPreRollDamageV2",[e,t,o])},te=function(e,t,o){i.log("#onPreRollFormulaV2",[e,t,o])},oe=function(e){i.log("#onPreRollRechargeV2",[e])},se=function(e,t,o,s){var f,T,P,y,N;if(!game.user.isGM)return;i.log("#onPostRollConfiguration",[e,t,o,s]);const l=t.subject instanceof dnd5e.dataModels.activity.BaseActivityData,c=t.hookNames[0].toLowerCase(),r=l?(f=t.subject)==null?void 0:f.actor:t.subject;if(!r)return;const u=r.hasPlayerOwner?I.getUserFromActor(r.id):null,g=e[0],S=g!=null&&g.data.situational?Number(g.data.situational):Number(t.situational||"");if(g&&(g.data.flags={...g.data.flags,[m]:{flavor:s.data.flavor}},u&&u!==game.user&&n.requestsEnabled))switch(c){case ce.SKILL.name:{i.log("SocketUtil.execForUser",[u,t,o,s]);const h={skill:t.skill,subject:t.subject,ability:g.data.abilityId||t.ability,abilityId:g.data.abilityId||t.ability,advantage:g.hasAdvantage||!1,disadvantage:g.hasDisadvantage||!1,situational:S,flavor:s.data.flavor,target:17,parts:t.parts||[]};(P=(T=o.options)==null?void 0:T.window)!=null&&P.title&&(o.options.window.title=s.data.flavor);const V={data:{flavor:((N=(y=o.options)==null?void 0:y.window)==null?void 0:N.title)||s.data.flavor},speaker:{...s.speaker,alias:r.name},rollMode:s.rollMode};return S&&!h.parts.includes("@situational")&&h.parts.push("@situational"),n.postRequestChatMessage(u,r,h,o,V),b.execForUser(n.SOCKET_CALLS.triggerRollSkillV2,u.id,h,o,V),i.log("#onPostRollConfiguration - msg",[h,o,V]),!1}default:return}},le=function(e,t){var l,c;i.log("#onRenderRollResolver",[e,t]);const o=r=>(r==null?void 0:r.method)==="pixels";if(e.fulfillable instanceof Map&&[...e.fulfillable.values()].some(o)){const r=e.roll,u=(c=(l=r==null?void 0:r.data)==null?void 0:l.flags)==null?void 0:c[m];u||(u={flavor:""}),t.classList.add("crlngn-rolls"),t.querySelector(".window-header .window-title").innerHTML=game.i18n.localize("CRLNGN_ROLLS.ui.forms.pixelsRollTitle");const g=document.createElement("div");g.classList.add("crlngn-resolver-title"),g.innerHTML=`<h1>${game.i18n.localize("CRLNGN_ROLLS.ui.forms.pixelsWaitingTitle")}</h1><br/>${u.flavor}`,t.querySelector(".standard-form").prepend(g)}},w(n,a),L(n,"requestsEnabled",!1),L(n,"SOCKET_CALLS",{receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",triggerRollSkillV2:"triggerRollSkillV2"}),L(n,"diceConfig",{}),L(n,"playerDiceConfigs",{}),L(n,"postRequestChatMessage",async(e,t,o,s,l)=>{const c=o.situational!==void 0?Number(o.situational):0,r={...o,type:"skill",action:"rollRequest",visibility:e.id,target:t.uuid,dc:o.target,hideDC:!0,flavor:o.flavor,situational:c,parts:o.parts||[]};c&&!r.parts.includes("@situational")&&r.parts.push("@situational");const u=[{buttonLabel:dnd5e.enrichers.createRollLabel({...r,format:"short",icon:!0}),hiddenLabel:dnd5e.enrichers.createRollLabel({...r,format:"short",icon:!0,hideDC:!0}),dataset:r}];l.data.flavor=o.flavor,i.log("postRequestChatMessage",[l,r]);const g={user:e.id,content:await renderTemplate("systems/dnd5e/templates/chat/request-card.hbs",{buttons:u}),flavor:"GM has requested a roll",speaker:l.speaker};await ChatMessage.implementation.create(g)}),L(n,"triggerRollSkillV2",async(e,t,o)=>{const s=n.playerDiceConfigs[game.user.id];e.situational!==void 0&&Number(e.situational);const l=game.actors.get(e.subject._id);if(i.log("triggerRollSkillV2",[game.user,s,l]),!l)return;const c={...t,configure:!(s!=null&&s.d20)},r={...e,parts:e.parts||[]},u={...o,flavor:e.flavor};e.situational&&!r.parts.includes("@situational")&&r.parts.push("@situational"),l.rollSkill(r,c,u)});let O=n;class p{static registerSettings(){const e=_();Object.entries(e).forEach(async o=>{const s=o[1];i.log("Registering... ",[o]);const l={name:s.label,hint:s.hint,default:s.default,type:s.propType,scope:s.scope,config:s.config,requiresReload:s.requiresReload||!1,onChange:c=>p.apply(s.tag,c)};s.choices&&(l.choices=s.choices),await game.settings.register(m,s.tag,l),p.get(s.tag)===void 0&&p.set(s.tag,s.default),i.log("registerSettings",[s.tag,p.get(s.tag)])})}static get(e,t=m){if(!e)return null;let o=!1;if(t===m)o=game.settings.get(t,e);else{let l=game.settings.storage.get("client")[`${t}.${e}`];l===void 0&&(l=game.settings.storage.get("world").getSetting(`${t}.${e}`),o=l==null?void 0:l.value),i.log("GET Setting",[l,o])}return o}static set(e,t,o=m){if(!e)return!1;let s=game.settings.storage.get("client")[`${o}.${e}`];s||(s=game.settings.storage.get("world").getSetting(`${o}.${e}`)),i.log("Setting",[e,s]);try{game.settings.set(o,e,t)}catch{i.log("Unable to change setting",[e,s])}return!0}static apply(e,t){const o=_();switch(e){case o.rollRequestsEnabled.tag:p.applyRollRequestsSetting(t);break}}static applyRollRequestsSetting(e){const t=_(),o=e!==void 0?e:p.get(t.rollRequestsEnabled.tag);O.requestsEnabled=o;const s=document.querySelector("#crlngn-request-toggle");if(!s)return;o===!1?s.classList.remove("active"):s.classList.add("active");const l=game.i18n.localize(s.classList.contains("active")?"CRLNGN_ROLLS.ui.buttons.rollRequestsToggleOn":"CRLNGN_ROLLS.ui.buttons.rollRequestsToggleOff");s.dataset.tooltip=l,game.tooltip&&game.tooltip.activate(s,{text:l}),i.log("Roll Requests Toggle",[o,s])}}class k{static init(){b.initialize(k.registerSocketCalls),Hooks.once(D.INIT,()=>{_(),i.log("Initiating module...",[],!0),p.registerSettings(),O.init()}),Hooks.once(D.READY,()=>{i.log("Core Ready",[]);const e=_();var t=p.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),game.user.isGM&&k.injectRollRequestsToggle(),game.user.isGM&&(Hooks.on(D.USER_CONNECTED,k.onUserConnected),game.users.forEach(o=>{k.onUserConnected(o)}))})}static onUserConnected(e){e.active&&e.id!==game.user.id&&(i.log("onUserConnected",[e]),b.execForUser(O.SOCKET_CALLS.getDiceConfig,e.id))}static getDiceConfig(){if(!game.user)return;let t=game.settings.storage.get("client")["core.diceConfiguration"]||"";if(t=t||"",i.log("getDiceConfig",[t]),game.user.isGM){O.playerDiceConfigs[game.user.id]=t,b.execForGMs(O.SOCKET_CALLS.receiveDiceConfig,game.user.id,t);return}else O.playerDiceConfigs[game.user.id]=JSON.parse(t)}static receiveDiceConfig(e,t){var o;((o=game.user)!=null&&o.isGM||e===game.user.id)&&(O.playerDiceConfigs||(O.playerDiceConfigs={}),O.playerDiceConfigs[e]=t?JSON.parse(t):{},i.log(`Received dice configuration from user ${e}`,[O.playerDiceConfigs]))}static registerSocketCalls(){b.registerCall(O.SOCKET_CALLS.triggerRollSkillV2,O.triggerRollSkillV2),b.registerCall(O.SOCKET_CALLS.getDiceConfig,k.getDiceConfig),b.registerCall(O.SOCKET_CALLS.receiveDiceConfig,k.receiveDiceConfig)}static injectRollRequestsToggle(){const e=_();document.querySelector("#chat-controls").insertAdjacentHTML("afterbegin",'<label class="chat-control-icon active" id="crlngn-request-toggle" data-tooltip-direction="LEFT"><i class="fas fa-bolt"></i></label>');const o=document.querySelector("#crlngn-request-toggle"),s=p.get(e.rollRequestsEnabled.tag);return p.applyRollRequestsSetting(s),o.addEventListener("click",l=>{l.target.classList.toggle("active");const c=l.target.classList.contains("active");p.set(e.rollRequestsEnabled.tag,c)}),o}}k.init();
//# sourceMappingURL=crlngn-roll-requests.js.map
