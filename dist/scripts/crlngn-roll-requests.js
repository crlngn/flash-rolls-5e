var de=Object.defineProperty;var Q=L=>{throw TypeError(L)};var ue=(L,e,t)=>e in L?de(L,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):L[e]=t;var R=(L,e,t)=>ue(L,typeof e!="symbol"?e+"":e,t),ge=(L,e,t)=>e.has(L)||Q("Cannot "+t);var _=(L,e,t)=>e.has(L)?Q("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(L):e.set(L,t);var S=(L,e,t)=>(ge(L,e,"access private method"),t);const G={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessage",RENDER_ROLL_RESOLVER:"renderRollResolver",USER_CONNECTED:"userConnected",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog"},fe={READY:"socketlib.ready"},N={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheck",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrow",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration"},b="crlngn-roll-requests",H=["%cRoll That For Me","color:rgb(47, 151, 161); font-weight: bold;","|"],v={ATTACK:{name:"attack",activityType:"attack"},DAMAGE:{name:"damage",activityType:"damage"},SAVE:{name:"save",activityType:"damage"},SAVING_THROW:{name:"savingthrow",activityType:"check"},ABILITY_CHECK:{name:"abilitycheck",activityType:"check"},CONCENTRATION:{name:"concentration",activityType:"check"},DEATH_SAVE:{name:"deathsave",activityType:"save"},SKILL:{name:"skill",activityType:"check"},TOOL:{name:"tool",activityType:"check"},HIT_DIE:{name:"hitdie",activityType:"formula"},INITIATIVE:{name:"initiative",activityType:"check"},FORMULA:{name:"formula",activityType:"formula"},RECHARGE:{name:"recharge",activityType:"formula"}},X={SAVE:"save"},j={ACTIVITY:"activity",CHECK:"check"},V={ROLL_REQUEST:"rollRequest",ROLL_ATTACK:"rollAttack"},x=class x{static log(e="",t=[],i=!1){try{const a=game.settings.get(b,"debugMode")||x.debugOn;if(!(i||a))return;console.log(...H,e,...t)}catch{console.log(...H,e,...t)}}static warn(e="",t=[]){console.warn(...H,e,...t)}static error(e,t={ui:!1,console:!0,permanent:!1}){var i;t.ui&&((i=ui.notifications)==null||i.error(e,{localize:!0,permanent:t.permanent})),t.console&&console.error(...H,e)}};R(x,"debugOn",!1);let n=x;const Z={checkbox:"checkbox"},ee={client:"client",world:"world"},q=()=>({debugMode:{tag:"debug-mode",label:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:Z.checkbox,default:!0,scope:ee.client,config:!0},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:Z.checkbox,default:!0,scope:ee.world,config:!0}});class M{static getTargets(e){let t=game.users.find(a=>a.isGM===!0),i=e.targets||t.targets;return new Set([...i])}static getActorFromItem(e){const t=e.split(".")[1];return game.actors.get(t)}static isModuleOn(e){var i;const t=(i=game.modules)==null?void 0:i.get(e);return!!(t!=null&&t.active)}static isPrivateRoll(e){return e===CONST.DICE_ROLL_MODES.BLIND||e===CONST.DICE_ROLL_MODES.PRIVATE}static removeTemplateForItem(e){n.log("removeTemplateForItem - A",[e]);const t=w.get("remove-template");if(n.log("removeTemplateForItem - B",[t]),!t)return;const i=canvas.templates.objects.children.filter(a=>a.document.flags.dnd5e.item===(e==null?void 0:e.uuid));canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",i.map(a=>a.id))}static getUserFromActor(e){let t;if(!e)return null;const i=e?game.actors.get(e):null;return t=game.users.players.find(s=>s.active===!0&&s.character.id===e),t||game.users.players.forEach(s=>{s.active&&i.testUserPermission(s,foundry.CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER,{exact:!0})&&(t=s)}),n.log("getUserFromActor",[e,t]),t}static html(e,t){return e.querySelector(t)}static getActivityType(e){var t;return((t=Object.values(v).find(i=>i.name.toLowerCase()===e.toLowerCase()))==null?void 0:t.activityType)||""}static getElement(e){return e&&typeof e.jquery<"u"?e[0]:e}}R(M,"getClientTargets",()=>{if(!game.user)return[];const e=Array.from(game.user.targets);return n.log("Selected Targets",[game.user.id,e,e.filter(t=>t.actor)]),e}),R(M,"getTargetDescriptors",()=>{var t,i;const e=new Map;for(const a of game.user.targets){const{name:s}=a,{img:o,system:l,uuid:r,statuses:d}=a.actor??{};if(r){const u=d.has("coverTotal")?null:(i=(t=l.attributes)==null?void 0:t.ac)==null?void 0:i.value;e.set(r,{name:s,img:o,uuid:r,ac:u??null})}}return Array.from(e.values())}),R(M,"findItemFromActor",(e,t,i)=>{const a=game.actors.get(e);if(n.log("findItemFromActor",[t,i]),!a)return null;let s=t?a.items.find(o=>o.id===t):null;return s||(s=i?a.items.find(o=>o.name.toLowerCase()===i.toLowerCase()):null,s||(s=a.items.find(o=>o.name.toLowerCase()===(i+" (Legacy)").toLowerCase()))),s}),R(M,"addCSSVars",(e,t)=>{let i=document.querySelector("#crlngn-chat-vars");if(!i){const p=document.querySelector("body");i=document.createElement("style"),i.id="crlngn-chat-vars",i.textContent=`body.crlngn-chat {
}
`,p.prepend(i)}let a=i.textContent,s=a.indexOf("body.crlngn-chat {"),o=a.indexOf("}",s);s===-1&&(a=`body.crlngn-chat {
}
`,s=0,o=a.indexOf("}"));const r=a.substring(s+18,o).split(";").map(p=>p.trim()).filter(p=>p!==""),d={};r.forEach(p=>{const m=p.split(":");if(m.length>=2){const A=m[0].trim(),C=m.slice(1).join(":").trim();A&&(d[A]=C)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),d[e]=t;const u=Object.entries(d).map(([p,m])=>`  ${p}: ${m};`).join(`
`),f=a.substring(0,s)+`body.crlngn-chat {
`+u+`
}`+a.substring(o+1);i.textContent=f});const T=class T{static serializeForTransport(e,t=!1){return e==null||(t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(i=>i instanceof Roll?i.toJSON():i)),n.log("ROLLS DATA",[e])),e}static deserializeFromTransport(e,t=!1){let i={};return e==null?e:(t&&e.rolls&&e.rolls.length>0&&(i={...e,rolls:e.rolls.map(a=>typeof a=="string"?Roll.fromJSON(a):Roll.fromJSON(JSON.stringify(a)))}),n.log("ROLLS RESULT",[i]),i)}};R(T,"socket"),R(T,"initialize",e=>{Hooks.once(fe.READY,()=>{if(n.log("Attempting to register module..."),typeof socketlib>"u"){n.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("CRLNGN_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{T.socket=socketlib.registerModule(b),e&&e(),n.log("SocketUtil | Module registered",[T.socket])}catch(t){n.log("Problem registering module",[t])}})}),R(T,"registerCall",(e,t)=>{T.socket?(T.socket.register(e,t),n.log("SocketUtil - Registered callback",[T.socket,e])):n.log("SocketUtil - Failed to register callback (socket not initialized)",[T.socket,e])}),R(T,"sendMessage",(e,t)=>{n.log("SocketUtil - sendMessage",[e]),t&&t()}),R(T,"execForGMs",async(e,...t)=>{if(!T.socket){n.log("SocketUtil - Socket not initialized. Cannot execute as GM.");return}return await T.socket.executeForAllGMs(e,...t)}),R(T,"execForAll",async(e,...t)=>{if(!T.socket){n.log("SocketUtil - Socket not initialized. Cannot execute for all clients.");return}return await T.socket.executeForEveryone(e,...t)}),R(T,"execForUser",async(e,t,...i)=>{if(!T.socket){n.log("SocketUtil - Socket not initialized. Cannot execute as user.");return}const a=await T.socket.executeAsUser(e,t,...i);return n.log("SocketUtil - Executed as user.",[a]),a});let E=T;var K,te;const D=class D{static init(){Hooks.on(G.RENDER_CHAT_MESSAGE,S(D,K,te))}static rollModifiedAttack(e,t,i){n.log("rollModifiedAttack",[e,t,i,this]);const{activity:a}=D.getDataFromUuid(t.dataset.activityUuid);a.rollAttack({event:e,advantage:t.dataset.advantage==="true",disadvantage:t.dataset.disadvantage==="true",attackMode:t.dataset.attackMode,ammunition:t.dataset.ammunition,situational:t.dataset.situational},{},i)}static rollModifiedDamage(e,t,i){n.log("rollModifiedDamage",[e,t,i]);const{activity:a}=D.getDataFromUuid(t.dataset.activityUuid);a.rollDamage({event:e,situational:t.dataset.situational,critical:t.dataset.critical==="true",isCritical:t.dataset.isCritical==="true"},{},i)}static getDataFromUuid(e){var o,l,r;const t=e.split("."),i=game.actors.get(t[1]),a=i==null?void 0:i.items.get(t[3]),s=((l=(o=a==null?void 0:a.system)==null?void 0:o.activities)==null?void 0:l.get(t[5]))||((r=a==null?void 0:a.activities)==null?void 0:r.get(t[5]));return{actor:i,item:a,activity:s}}};K=new WeakSet,te=function(e,t,i){var l,r,d;const a=((l=e.flags)==null?void 0:l[b])||((d=(r=i.message)==null?void 0:r.flags)==null?void 0:d[b]);if(n.log("#onRenderChatMessage",[e,t,i,a]),!(a!=null&&a.modifiedActions))return;const s=a.activityUuid;if(!s)return;const{activity:o}=D.getDataFromUuid(s);o&&(n.log("#onRenderChatMessage Activating button listeners",[o,e,t]),o.activateChatListeners(e,t[0]))},_(D,K),R(D,"triggerActivity",async e=>{var y,O,P,I;const{activityUuid:t,diceTypes:i,config:a,dialog:s,message:o}=e;n.log("triggerActivity #1",[i,a,s,o,e]),k.playerDiceConfigs[game.user.id];const l=a.situational?Number(a.situational):0,r=t.split("."),d=game.actors.get(r[1]),u=d==null?void 0:d.items.get(r[3]),f=((O=(y=u==null?void 0:u.system)==null?void 0:y.activities)==null?void 0:O.get(r[5]))||((P=u==null?void 0:u.activities)==null?void 0:P.get(r[5])),p=((I=a.hookNames)==null?void 0:I[0])||f.type;if(n.log("triggerActivity #2",[p,f,e]),!d||!u||!f)return;const m={...a,parts:a.parts||[]},A={...s},C={...o,flavor:a.flavor};switch(l&&!m.parts.includes("@situational")&&m.parts.push("@situational"),p){case v.ATTACK.name:{D.useAttack({activity:f,config:m,message:C,dialog:A}),n.log("triggerActivity attack",[m,A,C]);break}case v.DAMAGE.name:{n.log("triggerActivity damage",[m,A,C]),D.useDamage({activity:f,config:m,message:C,dialog:A});break}case v.SAVE.name:{n.log("triggerActivity save",[m]),C.create=!0,f.use(m,A,C);break}}n.log("triggerActivity #3",[t,a,e])}),R(D,"useAttack",async e=>{const{activity:t,config:i,message:a,dialog:s}=e,o=await t._usageChatContext(a);t.metadata.usage.actions;const l=o.buttons.find(p=>p.dataset.action==="rollAttack"),r={situational:i.situational,attackMode:i.attackMode,advantage:i.advantage,disadvantage:i.disadvantage,ammunition:i.ammunition};l.dataset={...l==null?void 0:l.dataset,...r,action:"rollAttack",activityUuid:t.uuid},t.metadata.usage.actions={...t.metadata.usage.actions,rollAttack:D.rollModifiedAttack};const d=foundry.utils.mergeObject({rollMode:a.rollMode||game.settings.get("core","rollMode"),data:{content:await renderTemplate(t.metadata.usage.chatCard,o),speaker:ChatMessage.getSpeaker({actor:t.actor}),flags:{core:{canPopout:!0},[b]:{modifiedActions:!0,activityType:t.type,activityUuid:t.uuid}}}},a),u=["d20"],f=k.areDiceConfigured(u,game.user.id);s.configure=!f,n.log("useAttack",[t,o,d,e]),await ChatMessage.create(d.data),t.rollAttack(r,s,{create:!0})}),R(D,"useDamage",async e=>{var u,f,p;const{activity:t,config:i,message:a,dialog:s}=e,o={situational:i.situational,critical:i.critical,isCritical:i.isCritical},l=((u=t==null?void 0:t.damage)==null?void 0:u.parts)||((p=(f=t==null?void 0:t.rolls)==null?void 0:f[0])==null?void 0:p.parts)||[],r=l.map(m=>"d"+m.denomination),d=k.areDiceConfigured(r,game.user.id);s.configure=!d,n.log("useDamage",[t,l,r,d,e]),t.rollDamage(o,s,{create:!0})});let U=D;var g,ae,ie,oe,F,B,se,ne,pe,Re,me,ye,Te,ve,Ae,Ce,Le,Se,re,Ee,be,Oe,le,ce;const c=class c{static init(){n.log("RollUtil.init() - Registering hooks",[],!0),c.preloadTemplates(),Hooks.on(N.PRE_ROLL_V2,S(c,g,F)),Hooks.on(N.PRE_ROLL_SKILL_V2,S(c,g,B)),Hooks.on(N.PRE_ROLL_TOOL_V2,S(c,g,B)),Hooks.on(N.PRE_ROLL_ATTACK_V2,S(c,g,re)),Hooks.on(N.PRE_ROLL_ABILITY_CHECK,S(c,g,se)),Hooks.on(N.PRE_ROLL_SAVING_THROW,S(c,g,ne)),Hooks.on(G.RENDER_ROLL_RESOLVER,S(c,g,ce)),Hooks.on(N.PRE_USE_ACTIVITY,S(c,g,ae)),Hooks.on(N.POST_USE_ACTIVITY,S(c,g,ie)),Hooks.on(G.RENDER_ROLL_CONFIGURATION_DIALOG,S(c,g,oe)),Hooks.on(N.POST_ROLL_CONFIG,S(c,g,le)),CONFIG.debug.hooks=!0,n.log("Hook debugging enabled",[],!0)}static registerSocketCalls(){Object.values(c.SOCKET_CALLS).forEach(e=>{e.type===j.ACTIVITY?E.registerCall(e.action,U[e.action]):E.registerCall(e.action,c[e.action])})}static allowsDC(e){return e[0].toLowerCase()===v.SKILL.name.toLowerCase()||e[0].toLowerCase()===v.TOOL.name.toLowerCase()||e[0].toLowerCase()===v.SAVING_THROW.name.toLowerCase()||e[0].toLowerCase()===v.ABILITY_CHECK.name.toLowerCase()}static getPlayerOwner(e){return game.users.find(t=>{var i;return((i=t.character)==null?void 0:i.id)===e})}static createCheckRequestButtons(e){var s,o;const t=((s=e.skill)==null?void 0:s.split("|"))??[],i=((o=e.tool)==null?void 0:o.split("|"))??[];if(t.length+i.length<=1)return[c.createRequestButton(e)];const a={...e};return delete a.skill,delete a.tool,[...t.map(l=>c.createRequestButton({ability:CONFIG.DND5E.skills[l].ability,...a,format:"short",skill:l,type:"skill"})),...i.map(l=>{var r;return dnd5e.enrichers.createRequestButton({ability:(r=CONFIG.DND5E.tools[l])==null?void 0:r.ability,...a,format:"short",tool:l,type:"tool"})})]}static createRequestButton(e){return{buttonLabel:dnd5e.enrichers.createRollLabel({...e,icon:!0}),hiddenLabel:dnd5e.enrichers.createRollLabel({...e,icon:!0,hideDC:!0}),dataset:{...e,action:"rollRequest",visibility:"all"}}}static getTrigger(e){var A,C,y;const{config:t,dialog:i,message:a,rolls:s}=e,o=t.subject instanceof dnd5e.dataModels.activity.BaseActivityData,l=o?(A=t.subject)==null?void 0:A.actor:t.subject;if(!l)return;const r=o?t.subject:null,d=((y=(C=t.hookNames)==null?void 0:C[0])==null?void 0:y.toLowerCase())||"",u=(r==null?void 0:r.type)||M.getActivityType(d)||"",f=l.hasPlayerOwner?M.getUserFromActor(l.id):null,p=s[0],m=p!=null&&p.data.situational?Number(p.data.situational):Number(t.situational)||"";if(f&&f!==game.user&&c.requestsEnabled){let O={...t,situational:m};o&&(O.activity=t.subject),O.skill=t.skill||"",O.tool=t.tool||"";const P={...a.data,speaker:{...a.speaker,alias:l.name},rollMode:a.rollMode},I={config:O,dialog:i,message:P,isActivity:o,activity:r,hookName:d,playerOwner:f,roll:p};switch(n.log("getTrigger",[u,I]),u){case v.ATTACK.activityType:{c.forwardAttackActivity(I);break}case v.DAMAGE.activityType:{c.forwardDamageActivity(I);break}case v.SAVE.activityType:{c.forwardDamageActivity(I);break}case v.SKILL.activityType:case v.TOOL.activityType:{c.forwardSkillToolCheck(I);break}case v.SAVING_THROW.name:{c.forwardSavingThrow(I);break}default:return null}return null}}static forwardAttackActivity(e){var d,u;const{config:t,dialog:i,message:a,playerOwner:s,roll:o}=e,l={...t,options:o==null?void 0:o.options,type:v.ATTACK.name,attackMode:(d=o==null?void 0:o.options)==null?void 0:d.attackMode,advantage:(o==null?void 0:o.hasAdvantage)||!1,disadvantage:(o==null?void 0:o.hasDisadvantage)||!1,ammunition:(u=o==null?void 0:o.options)==null?void 0:u.ammunition,target:t.target},r={activityUuid:t.subject.uuid,config:l,dialog:i,message:{...a,create:!1}};n.log("SocketUtil.execForUser",[s.id,r]),E.execForUser(c.SOCKET_CALLS.triggerActivity.action,s.id,r)}static forwardDamageActivity(e){const{config:t,dialog:i,message:a,playerOwner:s,roll:o}=e,l={...t,options:o.options,type:v.DAMAGE.name,critical:o.options.critical,isCritical:o.options.isCritical,target:o.options.target},r={activityUuid:t.subject.uuid,config:l,dialog:i,message:a};n.log("SocketUtil.execForUser",[s.id,r]),E.execForUser(c.SOCKET_CALLS.triggerActivity.action,s.id,r)}static forwardSaveActivity(e){const{config:t,dialog:i,message:a,playerOwner:s,roll:o}=e,l={...t,options:o.options,type:v.SAVE.name,critical:o.options.critical,isCritical:o.options.isCritical,target:o.options.target},r={activityUuid:t.subject.uuid,config:l,dialog:i,message:a};n.log("SocketUtil.execForUser",[s.id,r]),E.execForUser(c.SOCKET_CALLS.triggerActivity.action,s.id,r)}static forwardSavingThrow(e){n.log("forwardSavingThrow",[e,v.SAVING_THROW.activityType]);const{config:t,dialog:i,message:a,hookName:s,playerOwner:o,roll:l}=e,r=game.actors.get(t.subject._id),d={...t,type:v.SAVING_THROW.name,parts:t.parts||[]};delete d.event,delete d.options;const u={config:d,dialog:i,message:a,playerId:(o==null?void 0:o.id)||""};n.log("SocketUtil.execForUser",[o.id,u]),c.postRequestChatMessage({...u,actor:r}),E.execForUser(c.SOCKET_CALLS.triggerRollRequest.action,o.id,u)}static forwardSkillToolCheck(e){n.log("forwardSkillToolCheck",[e]);const{config:t,dialog:i,message:a,hookName:s,playerOwner:o,roll:l}=e,r=game.actors.get(t.subject._id),d={...t,type:s,parts:t.parts||[]};delete d.event,delete d.options;const u={config:d,dialog:i,message:a,playerId:(o==null?void 0:o.id)||""};n.log("SocketUtil.execForUser",[o.id,u]),c.postRequestChatMessage({...u,actor:r}),E.execForUser(c.SOCKET_CALLS.triggerRollRequest.action,o.id,u)}static getAdvantageMode(e){return e.advantage?CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE:e.disadvantage?CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE:CONFIG.Dice.D20Roll.ADV_MODE.NORMAL}static areDiceConfigured(e,t){const i=c.playerDiceConfigs[t];return(e==null?void 0:e.map(a=>(i==null?void 0:i[a])!=="").includes(!0))||!1}};g=new WeakSet,ae=function(e,t,i,a){var o;n.log("#onPreUseActivity #1",[]);const s=c.getPlayerOwner(e.actor.id);if(n.log("#onPreUseActivity #2",[s,e,t,i,a]),!c.requestsEnabled||!t.create)return!0;s.id!==game.user.id&&game.user.isGM?(t.create.measuredTemplate=!1,t.consume.spellSlot=!1,a.create=!1,a.data={...a.data||{},flags:{...((o=a.data)==null?void 0:o.flags)||{},[b]:{modifiedActions:!0,activityType:e.type,activityUuid:e.uuid}}}):(t.create.measuredTemplate=!0,t.consume.spellSlot=!0)},ie=function(e,t,i,a){n.log("#onPostUseActivity",[e.type,X.SAVE,e,t,i,a]);const s=c.getPlayerOwner(e.actor.id);if(!(!t.create||e.type!==X.SAVE)&&s.id!==game.user.id&&game.user.isGM){t.create.measuredTemplate=!0,t.consume.spellSlot=!0;const o={...t,type:v.SAVING_THROW.name,target:e.target},l={activityUuid:e.uuid,config:o,dialog:i,message:a};a={...a,create:!0},n.log("SocketUtil.execForUser",[s.id,l]),E.execForUser(c.SOCKET_CALLS.triggerActivity.action,s.id,l)}},oe=function(e,t){var p,m,A,C,y,O,P,I,z,Y,W,J;n.log("#onRenderRollConfigurationDialog #1",[e]);const i=M.getElement((m=(p=e.config)==null?void 0:p.event)==null?void 0:m.target),a=(A=i==null?void 0:i.closest(".card-buttons"))==null?void 0:A.querySelector("button[data-action]"),s=a?(C=a==null?void 0:a.dataset)==null?void 0:C.title:((y=e.config)==null?void 0:y.title)||((P=(O=e.options)==null?void 0:O.window)==null?void 0:P.title);if(s&&(e.options.window.title=s),a&&(a==null?void 0:a.dataset.action)!==V.ROLL_REQUEST)return;c.handleRollDialogInputs(a,e,t),n.log("#onRenderRollConfigurationDialog",[a!=null&&a.dataset.advantage?CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE:CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE]);let o=t.querySelector('input[name="dc"]');const l=a?Number((I=a==null?void 0:a.dataset)==null?void 0:I.dc):((z=e.config)==null?void 0:z.dc)||void 0;o&&(o.value=l);const r=`data-${b}-${game.user.id}-custom-event`,d=a?game.actors.get(a.dataset.actorId):(Y=e.config)==null?void 0:Y.subject;e.config&&(e.config.subject=d,e.config.dc=l||"",e.config.advantage=a?(a==null?void 0:a.dataset.advantage)=="true":e.config.advantage,e.config.disadvantage=a?(a==null?void 0:a.dataset.disadvantage)=="true":e.config.disadvantage,e.config.rolls.length>0&&(e.config.rolls[0].advantage=a?(a==null?void 0:a.dataset.advantage)=="true":e.config.rolls[0].advantage,e.config.rolls[0].disadvantage=a?(a==null?void 0:a.dataset.disadvantage)=="true":e.config.rolls[0].disadvantage,e.config.rolls[0].situational=a?Number(a==null?void 0:a.dataset.situational):e.config.rolls[0].situational,e.config.rolls[0].options.advantage=e.config.rolls[0].advantage,e.config.rolls[0].options.disadvantage=e.config.rolls[0].disadvantage,e.config.rolls[0].options.advantageMode=c.getAdvantageMode(e.config.rolls[0])));const u=Number((W=a==null?void 0:a.dataset)==null?void 0:W.situational)||((J=e.config)==null?void 0:J.situational)||"",f=t.querySelector('input[name="roll.0.situational"]');n.log("#onRenderRollConfigurationDialog ##",[e,s]),!t.hasAttribute(r)&&(f&&(t.setAttribute(r,"true"),f.value=u||"",f.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))),t.setAttribute(r,"true"))},F=function(e,t,i,a=""){var r,d,u,f,p,m,A,C;if(n.log(`#onPreRollV2 for ${a}`,[e,t,i,CONFIG.Dice.D20Roll.ADV_MODE]),!a)return;const s=M.getElement((r=e.event)==null?void 0:r.target)||null,o=((d=s==null?void 0:s.closest(".card-buttons"))==null?void 0:d.querySelector(`button[data-action=${a}]`))||null;e.event=null;const l=o?Number(o.dataset.situational):e.situational||void 0;n.log("Situational bonus:",[l,o,s]),e.advantage=((u=o==null?void 0:o.dataset)==null?void 0:u.advantage)||e.advantage,e.disadvantage=((f=o==null?void 0:o.dataset)==null?void 0:f.disadvantage)||e.disadvantage,e.situational=l||"",a===V.ROLL_REQUEST?(e.ability=(o==null?void 0:o.dataset.ability)||e.ability,e.abilityId=(o==null?void 0:o.dataset.ability)||e.ability):a===V.ROLL_ATTACK&&(e.attackMode=(o==null?void 0:o.dataset.attackMode)||e.attackMode),n.log("Config:",[(p=t.options)==null?void 0:p.window,i.data.flavor],!0),n.log("Applied target data to config",[e,t],!0),l!==void 0&&!((m=e.parts)!=null&&m.includes("@situational"))&&(e.parts||(e.parts=[]),e.parts.push("@situational")),e.rolls||(e.rolls=[]),n.log("Number of rolls:",[e.rolls.length],!0);for(const y of e.rolls){y.data||(y.data={}),y.data.flags||(y.data.flags={}),y.data.flags[b]={flavor:((C=(A=t.options)==null?void 0:A.window)==null?void 0:C.title)||i.data.flavor};const O={flags:y.data.flags,situational:l};a===V.ROLL_REQUEST&&(O.target=o!=null&&o.dataset.dc?Number(o.dataset.dc):e.target,O.ability=(o==null?void 0:o.dataset.ability)||e.ability),y.data=O,(e.advantage||e.disadvantage)&&(y.options={...y.options,advantageMode:e.advantage?CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE:CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE}),y.resetFormula&&y.resetFormula(),n.log("Modified roll data",[y],!0)}return n.log(`#onPreRollV2 for ${a} completed`,[],!0),!0},B=function(e,t,i){n.log("#onPreRollSkillToolV2",[e,t,i])},se=function(e,t,i){var a;return n.log("#onPreRollAbilityCheck",[e,t,i]),S(a=c,g,F).call(a,e,t,i,V.ROLL_REQUEST)},ne=function(e,t,i){var a;return n.log("#onPreRollSavingThrow",[e,t,i]),S(a=c,g,F).call(a,e,t,i,V.ROLL_REQUEST)},pe=function(e,t){n.log("#onPreBeginConcentrating",[e,t])},Re=function(e,t){n.log("#onPreEndConcentration",[e,t])},me=function(e,t,i){n.log("#onPreRollConcentrationV2",[e,t,i])},ye=function(e,t,i){n.log("#onPreRollDeathSaveV2",[e,t,i])},Te=function(e,t,i){n.log("#onPreRollToolCheckV2",[e,t,i])},ve=function(e,t,i){n.log("#onPreRollHitDieV2",[e,t,i])},Ae=function(e,t,i){n.log("#onPreRollClassHitPoints",[e,t,i])},Ce=function(e,t){n.log("#onPreRollNPCHitPoints",[e,t])},Le=function(e){n.log("#onPreRollInitiativeDialog",[e])},Se=function(e,t){n.log("#onPreRollInitiative",[e,t])},re=function(e,t,i){var a;return n.log("#onPreRollAttackV2",[e,t,i]),S(a=c,g,F).call(a,e,t,i,V.ROLL_ATTACK)},Ee=function(e,t,i){n.log("#onPreRollDamageV2",[e,t,i])},be=function(e,t,i){n.log("#onPreRollFormulaV2",[e,t,i])},Oe=function(e){n.log("#onPreRollRechargeV2",[e])},le=function(e,t,i,a){var l,r;if(n.log("#onPostRollConfiguration #A",[e,t,i,a]),!game.user.isGM||!c.requestsEnabled)return!0;const s=e==null?void 0:e[0];s&&(t.ability=s.data.abilityId,t.abilityId=s.data.abilityId,t.advantage=s.hasAdvantage,t.disadvantage=s.hasDisadvantage,t.situational=s.data.situational),t.target=t.dc,(r=(l=t.options)==null?void 0:l.window)!=null&&r.title&&(a.flavor=t.options.window.title,a.data.flavor=t.options.window.title,t.title=t.options.window.title);const o={rolls:e,config:t,dialog:i,message:a};return n.log("#onPostRollConfiguration #B",[t,i,a]),c.getTrigger(o),!1},ce=function(e,t){var s,o;n.log("#onRenderRollResolver",[e,t]);const i=l=>(l==null?void 0:l.method)==="pixels";if(e.fulfillable instanceof Map&&[...e.fulfillable.values()].some(i)){const l=e.roll;let r=(o=(s=l==null?void 0:l.data)==null?void 0:s.flags)==null?void 0:o[b];r||(r={flavor:""}),l.data.situational=7,t.classList.add("crlngn-rolls"),t.querySelector(".window-header .window-title").innerHTML=game.i18n.localize("CRLNGN_ROLLS.ui.forms.pixelsRollTitle");const d=document.createElement("div");d.classList.add("crlngn-resolver-title"),d.innerHTML=`<h1>${game.i18n.localize("CRLNGN_ROLLS.ui.forms.pixelsWaitingTitle")}</h1><br/>${r.flavor}`,t.querySelector(".standard-form").prepend(d)}},_(c,g),R(c,"requestsEnabled",!1),R(c,"SOCKET_CALLS",{triggerRollRequest:{action:"triggerRollRequest",type:j.CHECK},triggerActivity:{action:"triggerActivity",type:j.ACTIVITY}}),R(c,"diceConfig",{}),R(c,"playerDiceConfigs",{}),R(c,"preloadTemplates",async()=>{const e=[`modules/${b}/templates/roll-dc-field.hbs`];return await loadTemplates(e),!0}),R(c,"handleRollDialogInputs",async(e,t,i)=>{var o,l;n.log("handleRollDialogInputs",[t,i]);const a=await renderTemplate(`modules/${b}/templates/roll-dc-field.hbs`,{label:game.i18n.localize("CRLNGN_ROLLS.ui.forms.dcFieldLabel"),dc:t.config.dc||""});if(c.allowsDC(t.config.hookNames)){const r=i.querySelector(".window-content .rolls .formulas");r==null||r.insertAdjacentHTML("beforebegin",a)}const s=i.querySelector('input[name="dc"]');game.user.isGM||((o=i.querySelector(".formulas.dc"))==null||o.classList.add("hidden"),s==null||s.setAttribute("hidden",!0)),n.log("handleRollDialogInputs",[i,e,t]),e&&s&&(s.value=(l=e==null?void 0:e.dataset)==null?void 0:l.dc),s&&(t.config.dc=Number(s.value)),s==null||s.addEventListener("change",()=>{t.config.dc=Number(s.value)||""})}),R(c,"postRequestChatMessage",async e=>{const{playerId:t,actor:i,config:a,dialog:s,message:o}=e,l=a.situational!==void 0?Number(a.situational):"",r={...a,type:a.type,action:"rollRequest",visibility:"",target:i.uuid,dc:a.target||a.dc,actorId:i.id,hideDC:!game.user.isGM,title:o.flavor,flavor:o.flavor,situational:l,parts:a.parts||[]};delete r.subject,delete r.event,a.type==="skill"?r.skill=a.skill:a.type==="tool"&&(r.tool=a.tool),l&&!r.parts.includes("@situational")&&r.parts.push("@situational");const d=[{buttonLabel:dnd5e.enrichers.createRollLabel({...r,format:"short",icon:!0}),hiddenLabel:dnd5e.enrichers.createRollLabel({...r,format:"short",icon:!0,hideDC:!0}),dataset:r}];n.log("postRequestChatMessage",[d,o,r]);const u={user:t,content:await renderTemplate("systems/dnd5e/templates/chat/request-card.hbs",{buttons:d}),flavor:game.i18n.localize("CRLNGN_ROLLS.ui.cards.rollRequestFlavor"),speaker:o.speaker};await ChatMessage.implementation.create(u)}),R(c,"triggerRollRequest",async e=>{const{diceTypes:t,config:i,dialog:a,message:s,playerId:o}=e,l=c.playerDiceConfigs[game.user.id];i.situational!==void 0&&Number(i.situational);const r=c.areDiceConfigured(t,o),d=game.actors.get(i.subject._id);if(n.log("triggerRollRequest",[game.user,i,a,s]),!d)return;const u={...a,configure:!r,options:{...a.options,window:{...a.options.window,title:s.flavor||i.flavor||a.options.window.title}},configure:!(l!=null&&l.d20)},f={...i,parts:i.parts||[]},p={...s,flavor:s.flavor||i.flavor||a.options.window.title};f.situational&&!f.parts.includes("@situational")&&f.parts.push("@situational"),f.skill?d.rollSkill(f,u,p):f.tool?d.rollToolCheck(f,u,p):d.rollSavingThrow(f,u,p)});let k=c;class w{static registerSettings(){const e=q();Object.entries(e).forEach(async i=>{const a=i[1];n.log("Registering... ",[i]);const s={name:a.label,hint:a.hint,default:a.default,type:a.propType,scope:a.scope,config:a.config,requiresReload:a.requiresReload||!1,onChange:o=>w.apply(a.tag,o)};a.choices&&(s.choices=a.choices),await game.settings.register(b,a.tag,s),w.get(a.tag)===void 0&&w.set(a.tag,a.default),n.log("registerSettings",[a.tag,w.get(a.tag)])})}static get(e,t=b){if(!e)return null;let i=!1;if(t===b)i=game.settings.get(t,e);else{let s=game.settings.storage.get("client")[`${t}.${e}`];s===void 0&&(s=game.settings.storage.get("world").getSetting(`${t}.${e}`),i=s==null?void 0:s.value),n.log("GET Setting",[s,i])}return i}static set(e,t,i=b){if(!e)return!1;let a=game.settings.storage.get("client")[`${i}.${e}`];a||(a=game.settings.storage.get("world").getSetting(`${i}.${e}`)),n.log("Setting",[e,a]);try{game.settings.set(i,e,t)}catch{n.log("Unable to change setting",[e,a])}return!0}static apply(e,t){const i=q();switch(e){case i.rollRequestsEnabled.tag:w.applyRollRequestsSetting(t);break}}static applyRollRequestsSetting(e){const t=q(),i=e!==void 0?e:w.get(t.rollRequestsEnabled.tag);k.requestsEnabled=i;const a=document.querySelector("#crlngn-request-toggle");if(!a)return;i===!1?a.classList.remove("active"):a.classList.add("active");const s=game.i18n.localize(a.classList.contains("active")?"CRLNGN_ROLLS.ui.buttons.rollRequestsToggleOn":"CRLNGN_ROLLS.ui.buttons.rollRequestsToggleOff");a.dataset.tooltip=s,game.tooltip&&game.tooltip.activate(a,{text:s}),n.log("Roll Requests Toggle",[i,a])}}const h=class h{static init(){E.initialize(h.registerSocketCalls),Hooks.once(G.INIT,()=>{q(),n.log("Initiating module...",[],!0),w.registerSettings(),k.init()}),Hooks.once(G.READY,()=>{n.log("Core Ready",[]);const e=q();var t=w.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),game.user.isGM&&h.injectRollRequestsToggle(),game.user.isGM&&(Hooks.on(G.USER_CONNECTED,h.onUserConnected),game.users.forEach(i=>{h.onUserConnected(i)}))}),U.init()}static onUserConnected(e){e.active&&e.id!==game.user.id&&(n.log("onUserConnected",[e]),E.execForUser(h.SOCKET_CALLS.getDiceConfig,e.id))}static getDiceConfig(){if(!game.user)return;let t=game.settings.storage.get("client")["core.diceConfiguration"]||"";if(t=t||"",n.log("getDiceConfig",[t]),game.user.isGM){k.playerDiceConfigs[game.user.id]=t,E.execForGMs(h.SOCKET_CALLS.receiveDiceConfig,game.user.id,t);return}else k.playerDiceConfigs[game.user.id]=t?JSON.parse(t):{}}static receiveDiceConfig(e,t){var i;((i=game.user)!=null&&i.isGM||e===game.user.id)&&(k.playerDiceConfigs||(k.playerDiceConfigs={}),k.playerDiceConfigs[e]=t?JSON.parse(t):{},n.log(`Received dice configuration from user ${e}`,[k.playerDiceConfigs]))}static registerSocketCalls(){E.registerCall(h.SOCKET_CALLS.getDiceConfig,h.getDiceConfig),E.registerCall(h.SOCKET_CALLS.receiveDiceConfig,h.receiveDiceConfig),k.registerSocketCalls()}static injectRollRequestsToggle(){const e=q();document.querySelector("#chat-controls").insertAdjacentHTML("afterbegin",'<label class="chat-control-icon active" id="crlngn-request-toggle" data-tooltip-direction="LEFT"><i class="fas fa-bolt"></i></label>');const i=document.querySelector("#crlngn-request-toggle"),a=w.get(e.rollRequestsEnabled.tag);return w.applyRollRequestsSetting(a),i.addEventListener("click",s=>{s.target.classList.toggle("active");const o=s.target.classList.contains("active");w.set(e.rollRequestsEnabled.tag,o)}),i}};R(h,"SOCKET_CALLS",{receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig"});let $=h;$.init();
//# sourceMappingURL=crlngn-roll-requests.js.map
