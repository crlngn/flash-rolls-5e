var z=Object.defineProperty;var U=(m,e,t)=>e in m?z(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var d=(m,e,t)=>U(m,typeof e!="symbol"?e+"":e,t);const A={INIT:"init",READY:"ready",RENDER_SIDEBAR_TAB:"renderSidebarTab",USER_CONNECTED:"userConnected"},$={READY:"socketlib.ready"},y="crlngn-roll-requests",q=["%cRoll That For Me","color:rgb(47, 151, 161); font-weight: bold;","|"],F={ABILITY_CHECK:{name:"abilityCheck",label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:"savingThrow",label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:"skill",label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:"tool",label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:"concentration",label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:"initiativeDialog",label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:"deathSave",label:"Death Save",subList:null,actorPath:""},CUSTOM:{name:"custom",label:"Custom Roll",subList:null,actorPath:""}},N={ID:y,ROLL_REQUEST_OPTIONS:F},O=class O{static log(e="",t=[],s=!1){try{const i=game.settings.get(y,"debugMode")||O.debugOn;if(!(s||i))return;console.log(...q,e,...t)}catch{(s||O.debugOn)&&console.log(...q,e,...t)}}static warn(e="",t=[]){console.warn(...q,e,...t)}static error(e,t={ui:!1,console:!0,permanent:!1}){var s;t.ui&&((s=ui.notifications)==null||s.error(e,{localize:!0,permanent:t.permanent})),t.console&&console.error(...q,e)}};d(O,"debugOn",!1);let o=O;const D={checkbox:"checkbox"},v={client:"client",world:"world"},b=()=>({debugMode:{tag:"debug-mode",label:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:D.checkbox,default:!0,scope:v.client,config:!0},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:D.checkbox,default:!0,scope:v.world,config:!0},skipDialogs:{tag:"skip-dialogs",label:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.hint"),propType:Boolean,inputType:D.checkbox,default:!1,scope:v.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:D.checkbox,default:!1,scope:v.world,config:!0}});class h{static registerSettings(){const e=b();Object.entries(e).forEach(async s=>{const i=s[1];o.log("Registering... ",[s]);const l={name:i.label,hint:i.hint,default:i.default,type:i.propType,scope:i.scope,config:i.config,requiresReload:i.requiresReload||!1,onChange:c=>h.apply(i.tag,c)};i.choices&&(l.choices=i.choices),await game.settings.register(y,i.tag,l),h.get(i.tag)===void 0&&h.set(i.tag,i.default),o.log("registerSettings",[i.tag,h.get(i.tag)])})}static get(e,t=y){if(!e)return null;let s=!1;if(t===y)s=game.settings.get(t,e);else{let l=game.settings.storage.get("client")[`${t}.${e}`];l===void 0&&(l=game.settings.storage.get("world").getSetting(`${t}.${e}`),s=l==null?void 0:l.value),o.log("GET Setting",[l,s])}return s}static set(e,t,s=y){if(!e)return!1;let i=game.settings.storage.get("client")[`${s}.${e}`];i||(i=game.settings.storage.get("world").getSetting(`${s}.${e}`)),o.log("Setting",[e,i]);try{game.settings.set(s,e,t)}catch{o.log("Unable to change setting",[e,i])}return!0}static apply(e,t){const s=b();switch(e){case s.rollRequestsEnabled.tag:h.applyRollRequestsEnabled(t);break}}static applyRollRequestsEnabled(e){const t=document.querySelector("#chat-controls .chat-control-icon.roll-requests-icon");t&&(e?t.classList.add("active"):t.classList.remove("active"))}}const n=class n{static serializeForTransport(e,t=!1){return e==null||(t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(s=>s instanceof Roll?s.toJSON():s)),o.log("ROLLS DATA",[e,e.subject])),e}static deserializeFromTransport(e,t=!1){let s={...e};if(!e)return s;if(t&&e.rolls&&e.rolls.length>0){const i=s.rolls.map(l=>{let c=l;return typeof l=="string"?c=Roll.fromJSON(l):c=Roll.fromJSON(JSON.stringify(l)),c});return s.rolls=[...i],s}return s}};d(n,"socket"),d(n,"_activeExecutions",new Map),d(n,"initialize",e=>{Hooks.once($.READY,()=>{if(o.log("Attempting to register module..."),typeof socketlib>"u"){o.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("CRLNGN_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{n.socket=socketlib.registerModule(y),e&&e(),o.log("SocketUtil | Module registered",[n.socket])}catch(t){o.log("Problem registering module",[t])}})}),d(n,"registerCall",(e,t)=>{n.socket?(n.socket.register(e,t),o.log("SocketUtil - Registered callback",[n.socket,e])):o.log("SocketUtil - Failed to register callback (socket not initialized)",[n.socket,e])}),d(n,"sendMessage",(e,t)=>{o.log("SocketUtil - sendMessage",[e]),t&&t()}),d(n,"execForGMs",async(e,...t)=>{if(!n.socket){o.log("SocketUtil - Socket not initialized. Cannot execute as GM.");return}return await n.socket.executeForAllGMs(e,...t)}),d(n,"execForAll",async(e,...t)=>{if(!n.socket){o.log("SocketUtil - Socket not initialized. Cannot execute for all clients.");return}return await n.socket.executeForEveryone(e,...t)}),d(n,"execForUser",async(e,t,...s)=>{if(!n.socket){o.log("SocketUtil - Socket not initialized. Cannot execute as user.");return}if(t===game.user.id)return o.log("SocketUtil - Preventing recursive call",[t]),null;const i=`${e}-${t}`;if(n._activeExecutions.has(i))return o.log("SocketUtil - Preventing recursive call",[i]),null;n._activeExecutions.set(i,!0);try{const l=await n.socket.executeAsUser(e,t,...s);return o.log("SocketUtil - Executed as user.",[l]),l}catch(l){return o.log("SocketUtil - Error executing as user",[l]),null}finally{n._activeExecutions.delete(i)}});let R=n;class P extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){constructor(e={}){super(e),this.selectedActors=new Set,this.currentTab="pc",this.selectedRequestType=null}async _prepareContext(e){var x;const t=await super._prepareContext(e),s=game.actors.contents,i=[],l=[],c=game.scenes.active;for(const a of s){if(a.type!=="character"&&a.type!=="npc")continue;const S={id:a.id,uuid:a.uuid,name:a.name,img:a.img,selected:this.selectedActors.has(a.id),crlngnStats:this._getActorStats(a)};Object.entries(a.ownership).some(([k,u])=>{const g=game.users.get(k);return g&&!g.isGM&&u>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})?i.push(S):c&&c.tokens.some(u=>u.actorId===a.id)&&l.push(S)}const T=b(),p=h.get(T.rollRequestsEnabled.tag),E=h.get(T.skipDialogs.tag),G=this.currentTab==="pc"?i:l,_=G.length>0&&G.every(a=>this.selectedActors.has(a.id)),M=[];if(this.selectedActors.size>0)for(const[a,S]of Object.entries(N.ROLL_REQUEST_OPTIONS))M.push({id:a,name:game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${S.name}`)||S.label,rollable:!0,hasSubList:!!S.subList});const L=[];if(this.selectedRequestType&&this.selectedActors.size>0){const a=N.ROLL_REQUEST_OPTIONS[this.selectedRequestType];if(a&&a.subList){const S=Array.from(this.selectedActors)[0],w=game.actors.get(S);if(a.subList==="tools"){const k=((x=CONFIG.DND5E.enrichmentLookup)==null?void 0:x.tools)||CONFIG.DND5E.tools||{};for(const[u,g]of Object.entries(k)){let C=u;if(g!=null&&g.id){const f=dnd5e.documents.Trait.getBaseItem(g.id,{indexOnly:!0});C=(f==null?void 0:f.name)||u}else C=u.replace(/([A-Z])/g," $1").replace(/^./,f=>f.toUpperCase()).trim();L.push({id:u,name:C,rollable:!0})}L.sort((u,g)=>u.name.localeCompare(g.name))}else if(w&&a.actorPath){const k=foundry.utils.getProperty(w,a.actorPath)||{},u=CONFIG.DND5E[a.subList];for(const[g,C]of Object.entries(k)){let f="";a.subList==="skills"&&(u!=null&&u[g])||a.subList==="abilities"&&(u!=null&&u[g])?f=u[g].label:f=C.label||game.i18n.localize(C.name||g)||g,L.push({id:g,name:f,rollable:!0})}a.subList==="skills"&&L.sort((g,C)=>g.name.localeCompare(C.name))}}}return{...t,actors:G,currentTab:this.currentTab,isPCTab:this.currentTab==="pc",isNPCTab:this.currentTab==="npc",selectedTab:this.currentTab,rollRequestsEnabled:p,skipDialogs:E,selectAllOn:_,hasSelectedActors:this.selectedActors.size>0,requestTypes:M,rollTypes:L,showNames:!0}}_getActorStats(e){var i,l,c,T,p;const t=e.system,s=[];return(i=t.attributes)!=null&&i.hp&&s.push({abbrev:"HP",value:t.attributes.hp.value}),(l=t.attributes)!=null&&l.ac&&s.push({abbrev:"AC",value:t.attributes.ac.value}),(c=t.attributes)!=null&&c.spelldc&&s.push({abbrev:"DC",value:t.attributes.spelldc}),(p=(T=t.skills)==null?void 0:T.prc)!=null&&p.passive&&s.push({abbrev:"PP",value:t.skills.prc.passive}),s}_onRender(e,t){super._onRender(e,t),this._attachListeners()}_attachListeners(){var s,i,l;o.log("Attaching listeners");const e=this.element;(s=e.querySelector("#crlngn-requests-toggle"))==null||s.addEventListener("change",this._onToggleRollRequests.bind(this)),(i=e.querySelector("#crlngn-skip-dialogs"))==null||i.addEventListener("change",this._onToggleSkipDialogs.bind(this)),(l=e.querySelector("#crlngn-actors-all"))==null||l.addEventListener("change",this._onToggleSelectAll.bind(this));const t=e.querySelectorAll(".actor-tab");o.log("Found tabs:",[t.length]),t.forEach(c=>{c.addEventListener("click",this._onTabClick.bind(this))}),e.querySelectorAll(".actor").forEach(c=>{c.addEventListener("click",this._onActorClick.bind(this))}),e.querySelectorAll(".actor-select").forEach(c=>{c.addEventListener("click",this._onActorSelectClick.bind(this))}),e.querySelectorAll(".request-types li").forEach(c=>{c.addEventListener("click",this._onRequestTypeClick.bind(this))}),e.querySelectorAll(".roll-types li").forEach(c=>{c.addEventListener("click",this._onRollTypeClick.bind(this))})}async _onToggleRollRequests(e){const t=b(),s=e.target.checked;await h.set(t.rollRequestsEnabled.tag,s),I.updateRollRequestsIcon(s),o.log("Roll requests enabled:",[s])}async _onToggleSkipDialogs(e){const t=b(),s=e.target.checked;await h.set(t.skipDialogs.tag,s),o.log("Skip dialogs:",[s])}_onToggleSelectAll(e){const t=e.target.checked;(this.currentTab==="pc"?game.actors.contents.filter(i=>this._isPlayerOwned(i)):game.actors.contents.filter(i=>!this._isPlayerOwned(i)&&this._hasTokenInScene(i))).forEach(i=>{t?this.selectedActors.add(i.id):this.selectedActors.delete(i.id)}),this.render(),this._updateRequestTypesVisibility(),o.log("Select all:",[t,"for",this.currentTab])}_isPlayerOwned(e){return e.type!=="character"&&e.type!=="npc"?!1:Object.entries(e.ownership).some(([t,s])=>{const i=game.users.get(t);return i&&!i.isGM&&s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}_hasTokenInScene(e){if(e.type!=="character"&&e.type!=="npc")return!1;const t=game.scenes.active;return t&&t.tokens.some(s=>s.actorId===e.id)}async _onTabClick(e){const t=e.currentTarget.dataset.tab;o.log("Tab clicked:",[t,this.currentTab]),t!==this.currentTab&&(this.currentTab=t,await this.render(),o.log("Switched to tab:",[t]))}_onActorClick(e){if(e.target.closest(".actor-select"))return;const s=e.currentTarget.dataset.id;this._toggleActorSelection(s)}_onActorSelectClick(e){e.stopPropagation();const t=e.currentTarget.dataset.id;this._toggleActorSelection(t)}_toggleActorSelection(e){this.selectedActors.has(e)?this.selectedActors.delete(e):this.selectedActors.add(e),this.render(),this._updateRequestTypesVisibility(),this._updateSelectAllState(),o.log("Actor selected:",[e,this.selectedActors.has(e)])}_updateRequestTypesVisibility(){this.render()}_updateSelectAllState(){const e=this.element.querySelector("#crlngn-actors-all"),t=this.currentTab==="pc"?"pc":"npc",s=this.element.querySelectorAll(`.${t}-actors .actor-item input[type="checkbox"]`),i=Array.from(s).filter(l=>l.checked).length;e.checked=i>0&&i===s.length,e.indeterminate=i>0&&i<s.length}async _onRequestTypeClick(e){const s=e.currentTarget.dataset.id,i=N.ROLL_REQUEST_OPTIONS[s];if(!i){o.error("Unknown request type:",s);return}this.selectedRequestType=s,i.subList?await this.render():this._triggerRoll(s,null),o.log("Request type selected:",s)}_onRollTypeClick(e){const t=e.currentTarget.dataset.id;this._triggerRoll(this.selectedRequestType,t),o.log("Roll type selected:",t)}_triggerRoll(e,t){const s=b(),i=Array.from(this.selectedActors);o.log("Roll triggered!",{actors:i,requestType:e,rollKey:t,skipDialogs:h.get(s.skipDialogs.tag)}),this.close()}async _onClose(e){await super._onClose(e),this.selectedActors.clear(),this.selectedRequestType=null}setPosition(e={}){return this}}d(P,"DEFAULT_OPTIONS",{id:"crlngn-requests-menu",classes:["roll-requests-menu"],tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:null}),d(P,"PARTS",{main:{template:`modules/${N.ID}/templates/requests-menus.hbs`}});const r=class r{static init(){R.initialize(r.registerSocketCalls),Hooks.once(A.INIT,()=>{b(),o.log("Initiating module...",[],!0),h.registerSettings(),r.setDiceConfig(),Hooks.on(A.RENDER_SIDEBAR_TAB,r.addChatControl)}),Hooks.once(A.READY,()=>{var s,i;o.log("Core Ready",[ui==null?void 0:ui.sidebar,(s=ui==null?void 0:ui.sidebar)==null?void 0:s._collapsed]);const e=b();var t=h.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),game.user.isGM?(Hooks.on(A.USER_CONNECTED,r.onUserConnected),game.users.forEach(l=>{r.onUserConnected(l)}),r.checkSideBar(!((i=ui==null?void 0:ui.sidebar)!=null&&i._collapsed))):r.getDiceConfig()})}static onUserConnected(e){e.active&&e.id!==game.user.id&&(o.log("onUserConnected",[e]),R.execForUser(r.SOCKET_CALLS.getDiceConfig,e.id))}static setDiceConfig(){if(!game.user)return;const e=game.settings.storage.get("client");return r.diceConfig=e["core.diceConfiguration"]||"",o.log("getDiceConfig",[r.diceConfig]),r.diceConfig}static getDiceConfig(){if(game.user&&(r.setDiceConfig(),game.user.isGM)){R.execForGMs(r.SOCKET_CALLS.receiveDiceConfig,game.user.id,r.diceConfig);return}}static receiveDiceConfig(e,t){var s;((s=game.user)!=null&&s.isGM||e===game.user.id)&&(r.playerDiceConfigs||(r.playerDiceConfigs={}),r.playerDiceConfigs[e]=t?JSON.parse(t):{},o.log(`Received dice configuration from user ${e}`,[r.playerDiceConfigs]))}static registerSocketCalls(){R.registerCall(r.SOCKET_CALLS.getDiceConfig,r.getDiceConfig),R.registerCall(r.SOCKET_CALLS.receiveDiceConfig,r.receiveDiceConfig)}static addChatControl(e,t,s){if(!game.user.isGM||e.id!=="chat")return;o.log("Adding chat control for chat tab");const l=(t[0]||t).querySelector("#chat-controls");if(!l){o.log("Could not find #chat-controls");return}if(l.querySelector(".roll-requests-icon"))return;const c=b(),T=h.get(c.rollRequestsEnabled.tag),p=document.createElement("a");p.id="crlngn-requests-icon",p.setAttribute("data-tooltip-direction","RIGHT"),p.className=`chat-control-icon roll-requests-icon${T?" active":""}`,p.title=game.i18n.localize("CRLNGN_ROLLS.ui.menus.rollRequestsTitle"),p.innerHTML=`<i class="fas fa-bolt${T?"":"-slash"}"></i>`;const E=l.querySelector(".chat-control-icon");E?E.parentNode.insertBefore(p,E):l.appendChild(p),p.addEventListener("click",r.toggleRollRequestsMenu),o.log("Added roll requests icon to chat controls")}static toggleRollRequestsMenu(){r.rollRequestsMenu?r.rollRequestsMenu.rendered?(r.rollRequestsMenu.close(),o.log("Closed roll requests menu")):(r.rollRequestsMenu.render(!0),o.log("Opened roll requests menu")):(r.rollRequestsMenu=new P,r.rollRequestsMenu.render(!0))}static updateRollRequestsIcon(e){const t=document.querySelector("#crlngn-requests-icon i");t&&(t.className=`fas fa-bolt${e?"":"-slash"}`)}};d(r,"diceConfig",{}),d(r,"playerDiceConfigs",{}),d(r,"rollRequestsMenu",null),d(r,"SOCKET_CALLS",{receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig"}),d(r,"checkSideBar",e=>{const t=document.querySelector("body");e?t.classList.add("sidebar-expanded"):t.classList.remove("sidebar-expanded")});let I=r;I.init();
//# sourceMappingURL=crlngn-roll-requests.js.map
