var me=Object.defineProperty;var le=b=>{throw TypeError(b)};var be=(b,s,e)=>s in b?me(b,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):b[s]=e;var S=(b,s,e)=>be(b,typeof s!="symbol"?s+"":s,e),ne=(b,s,e)=>s.has(b)||le("Cannot "+e);var $=(b,s,e)=>(ne(b,s,"read from private field"),e?e.call(b):s.get(b)),re=(b,s,e)=>s.has(b)?le("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(b):s.set(b,e),ce=(b,s,e,t)=>(ne(b,s,"write to private field"),t?t.call(b,e):s.set(b,e),e);const j={checkbox:"checkbox"},Q={client:"client",world:"world"},A=()=>({debugMode:{tag:"debug-mode",label:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:Q.client,config:!0},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:Q.world,config:!0},skipDialogs:{tag:"skip-dialogs",label:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.hint"),propType:Boolean,inputType:j.checkbox,default:!1,scope:Q.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:j.checkbox,default:!1,scope:Q.world,config:!0},rollInterceptionEnabled:{tag:"roll-interception-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:Q.world,config:!0},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("CRLNGN_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:Q.world,config:!0}}),q="crlngn-roll-requests",te=["%cFlash Rolls 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],ie={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest"},_={ABILITY:"ability",SAVE:"save",SKILL:"skill",TOOL:"tool",CONCENTRATION:"concentration",ATTACK:"attack",DAMAGE:"damage",INITIATIVE:"initiative",DEATH_SAVE:"deathsave",HIT_DIE:"hitDie",ITEM_SAVE:"itemSave",CUSTOM:"custom"},Re={ABILITY_CHECK:{name:"abilityCheck",label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:"savingThrow",label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:"skill",label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:"tool",label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:"concentration",label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:"initiativeDialog",label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:"deathSave",label:"Death Save",subList:null,actorPath:""},CUSTOM:{name:"custom",label:"Custom Roll",subList:null,actorPath:""}},H={ID:q,ROLL_REQUEST_OPTIONS:Re},W={INIT:"init",READY:"ready",RENDER_SIDEBAR_TAB:"renderSidebarTab",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage"},ke={READY:"socketlib.ready"},M={PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog"},X=class X{static log(s="",e=[],t=!1){try{const i=game.settings.get(q,"debug-mode")||X.debugOn;if(!(t||i))return;console.log(...te,s,...e)}catch{(t||X.debugOn)&&console.log(...te,s,...e)}}static warn(s="",e=[]){console.warn(...te,s,...e)}static error(s,e={ui:!1,console:!0,permanent:!1}){var t;e.ui&&((t=ui.notifications)==null||t.error(s,{localize:!0,permanent:e.permanent})),e.console&&console.error(...te,s)}};S(X,"debugOn",!1);let K=X;const E=class E{static serializeForTransport(s,e=!1){return s==null||e&&s.rolls&&Array.isArray(s.rolls)&&(s.rolls=s.rolls.map(t=>t instanceof Roll?t.toJSON():t)),s}static deserializeFromTransport(s,e=!1){let t={...s};if(!s)return t;if(e&&s.rolls&&s.rolls.length>0){const i=t.rolls.map(a=>{let o=a;return typeof a=="string"?o=Roll.fromJSON(a):o=Roll.fromJSON(JSON.stringify(a)),o});return t.rolls=[...i],t}return t}};S(E,"socket"),S(E,"_activeExecutions",new Map),S(E,"initialize",s=>{Hooks.once(ke.READY,()=>{if(typeof socketlib>"u"){K.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("CRLNGN_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{E.socket=socketlib.registerModule(q),s&&s()}catch{}})}),S(E,"registerCall",(s,e)=>{E.socket&&E.socket.register(s,e)}),S(E,"sendMessage",(s,e)=>{e&&e()}),S(E,"execForGMs",async(s,...e)=>{if(E.socket)return await E.socket.executeForAllGMs(s,...e)}),S(E,"execForAll",async(s,...e)=>{if(E.socket)return await E.socket.executeForEveryone(s,...e)}),S(E,"execForUser",async(s,e,...t)=>{if(!E.socket)return;if(e===game.user.id)return null;const i=`${s}-${e}`;if(E._activeExecutions.has(i))return null;E._activeExecutions.set(i,!0);try{return await E.socket.executeAsUser(s,e,...t)}catch{return null}finally{E._activeExecutions.delete(i)}});let P=E;class J{static findActivityForRoll(s,e){var i;if(!((i=s==null?void 0:s.system)!=null&&i.activities))return null;const t=s.system.activities;switch(e){case"attack":const a=t.getByType("attack");return(a==null?void 0:a[0])||null;case"damage":const o=t.getByType("attack");if((o==null?void 0:o.length)>0)return o[0];const l=t.getByType("damage");if((l==null?void 0:l.length)>0)return l[0];const n=t.getByType("save");return(n==null?void 0:n.length)>0?n[0]:null;case"itemSave":const r=t.getByType("save");return(r==null?void 0:r[0])||null;default:return null}}static getActivitiesByType(s,e){var t;return(t=s==null?void 0:s.system)!=null&&t.activities?s.system.activities.getByType(e):[]}static hasActivityForRoll(s,e){return!!this.findActivityForRoll(s,e)}static async executeActivityRoll(s,e,t,i,a){var n,r;const o=s.items.get(t);if(!o)throw new Error(`Item ${t} not found on actor ${s.name}`);let l=null;if(i&&(l=(n=o.system.activities)==null?void 0:n.get(i)),l||(l=this.findActivityForRoll(o,e)),l)switch(e){case"attack":const R={configure:!0};if(MidiQOL){await J.syntheticItemRoll(o,{...a});return}else return await l.use(usageConfig,R);case"damage":if(MidiQOL){const g=(r=MidiQOL==null?void 0:MidiQOL.Workflow)==null?void 0:r.getWorkflow(l.uuid);await g.activity.rollDamage({...a,workflow:g});return}else return await l.rollDamage(a);case"itemSave":return await o.use({activity:l.id},{skipDialog:a.fastForward});default:throw new Error(`Unknown roll type: ${e}`)}else{switch(e){case"attack":if(o.rollAttack)return await o.rollAttack(a);break;case"damage":if(o.rollDamage)return await o.rollDamage(a);break;case"itemSave":return await o.use({},{skipDialog:a.fastForward})}throw new Error(`No suitable method found for ${e} on item ${o.name}`)}}static getActivityDisplayInfo(s){return s?{name:s.name||s.constructor.metadata.label,type:s.type,icon:s.constructor.metadata.icon,canAttack:s.type==="attack",canDamage:["attack","damage","save"].includes(s.type),canSave:s.type==="save"}:null}static getDamageFormula(s){var t,i;if(!((i=(t=s==null?void 0:s.damage)==null?void 0:t.parts)!=null&&i.length))return null;const e=s.damage.parts.map(a=>a.formula).filter(a=>a);return e.length>0?e.join(" + "):null}static async syntheticItemRoll(s,e={}){let t={consumeUsage:!1,consumeSpellSlot:!1},i={configureDialog:!0,workflowOptions:{autoRollAttack:!1,autoFastAttack:!1,autoRollDamage:"none",autoFastDamage:!1}};return e={...t,...e},await MidiQOL.completeItemUse(s,e,i)}static async replaceDamage(s,e,{ignoreCrit:t=!1,damageType:i}={}){e=String(e),s.isCritical&&!t&&(e=await rollUtils.getCriticalFormula(e,s.item.getRollData()));let a=await new CONFIG.Dice.DamageRoll(e).evaluate();return await s.setDamageRolls([a]),a}}class x{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const s=game.settings.storage.get("client");return this.diceConfig=s["core.diceConfiguration"]||"",this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){P.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(s,e){var t,i;((t=game.user)!=null&&t.isGM||s===((i=game.user)==null?void 0:i.id))&&(this.playerDiceConfigs[s]=e?JSON.parse(e):{})}static getUserDiceConfig(s){var e;return s===((e=game.user)==null?void 0:e.id)?this.diceConfig:this.playerDiceConfigs[s]||{}}static requestDiceConfigFromUser(s){P.execForUser("getDiceConfig",s)}static requestDiceConfigFromAllPlayers(){var s;(s=game.user)!=null&&s.isGM&&game.users.forEach(e=>{e.active&&!e.isGM&&e.id!==game.user.id&&this.requestDiceConfigFromUser(e.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(s){var e;return s===((e=game.user)==null?void 0:e.id)?!!this.diceConfig:!!this.playerDiceConfigs[s]}}S(x,"diceConfig",{}),S(x,"playerDiceConfigs",{});function ue(b,s){var t,i,a,o,l;let e=game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${b}`)||b;if(s)switch(b){case _.SKILL:e+=` (${((t=CONFIG.DND5E.skills[s])==null?void 0:t.label)||s})`;break;case _.SAVE:e+=` (${((i=CONFIG.DND5E.abilities[s])==null?void 0:i.label)||s})`;break;case _.ABILITY:e+=` (${((a=CONFIG.DND5E.abilities[s])==null?void 0:a.label)||s})`;break;case _.TOOL:const n=(l=(o=CONFIG.DND5E.enrichmentLookup)==null?void 0:o.tools)==null?void 0:l[s];if(n!=null&&n.id){const r=dnd5e.documents.Trait.getBaseItem(n.id,{indexOnly:!0});e+=` (${(r==null?void 0:r.name)||s})`}else e+=` (${s})`;break;case _.CUSTOM:e=`${e}: ${s}`;break}return e}function Ce(b,s=ue){if(b.length===0)return;const e={};for(const i of b){const a=`${i.rollType}_${i.rollKey||""}`;e[a]||(e[a]={rollType:i.rollType,rollKey:i.rollKey,actors:[],gm:i.gm}),e[a].actors.push(i.actor)}const t=Object.values(e);if(t.length===1&&t[0].actors.length===1){const i=t[0];ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestReceived",{gm:i.gm,rollType:s(i.rollType,i.rollKey)}))}else{const i=[];for(const a of t){const o=s(a.rollType,a.rollKey),l=a.actors.join(", ");i.push(`${o} (${l})`)}ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsReceivedMultiple",{gm:t[0].gm,requests:i.join("; ")}))}}function Te(b,s=game.user){if(!(b!=null&&b.length))return;b.map(t=>canvas.tokens.get(t)).filter(t=>t).forEach(t=>t.setTarget(!0,{user:s}))}function ye(){var b;return!((b=ui==null?void 0:ui.sidebar)!=null&&b._collapsed)}function _e(b){const s=document.querySelector("body");b?s.classList.add("sidebar-expanded"):s.classList.remove("sidebar-expanded")}class L{static registerSettings(){const s=A();Object.entries(s).forEach(async t=>{const i=t[1],a={name:i.label,hint:i.hint,default:i.default,type:i.propType,scope:i.scope,config:i.config,requiresReload:i.requiresReload||!1,onChange:o=>L.apply(i.tag,o)};i.choices&&(a.choices=i.choices),await game.settings.register(q,i.tag,a),(L.get(i.tag)===void 0||L.get(i.tag)===null)&&L.set(i.tag,i.default)})}static get(s,e=q){if(!s)return null;let t=!1;if(e===q)t=game.settings.get(e,s);else{let a=game.settings.storage.get("client")[`${e}.${s}`];a===void 0&&(a=game.settings.storage.get("world").getSetting(`${e}.${s}`),t=a==null?void 0:a.value)}return t}static set(s,e,t=q){if(!s)return!1;let i=game.settings.storage.get("client")[`${t}.${s}`];i||(i=game.settings.storage.get("world").getSetting(`${t}.${s}`));try{game.settings.set(t,s,e)}catch{}return!0}static apply(s,e){const t=A();switch(s){case t.rollRequestsEnabled.tag:L.applyRollRequestsEnabled(e);break}}static applyRollRequestsEnabled(s){const e=document.querySelector("#chat-controls .chat-control-icon.roll-requests-icon");e&&(s?e.classList.add("active"):e.classList.remove("active"))}}class Z extends dnd5e.applications.dice.D20RollConfigurationDialog{constructor(s={},e={},t={}){t.rollType=t.rollType||CONFIG.Dice.D20Roll,super(s,e,t),this.actors=t.actors||[],this.sendRequest=t.defaultSendRequest??t.sendRequest??!0,this.showDC=t.showDC||!1,this.dcValue=t.dcValue||null}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(s,e,t,i){const a=super._prepareConfigurationData(s,e,t,i);return a.showDC=this.showDC,a.dcValue=this.dcValue,a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(s,e,t){return e=await super._preparePartContext(s,e,t),s==="configuration"&&(e.showDC=this.showDC,e.dcValue=this.dcValue,e.sendRequest=this.sendRequest,e.actorCount=this.actors.length),e}async _onRender(s,e){var i,a,o;if(super._onRender(s,e),this.element.querySelector(".gm-roll-config-fields"))return;let t=this.element.querySelector(".rolls .formulas");if(t&&(this.showDC||this.actors.length>0)){const l={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},n=await renderTemplate(`modules/${q}/templates/gm-roll-config-fields.hbs`,l),r=document.createElement("div");r.className="gm-roll-config-fields",r.innerHTML=n,t.parentNode.insertBefore(r,t)}this._attachButtonListeners(),((o=(a=(i=this.config.rolls)==null?void 0:i[0])==null?void 0:a.data)!=null&&o.situational||this.config.situational)&&(K.log("GMRollConfigDialog._onRender",["Triggering rebuild for initial situational bonus"]),setTimeout(()=>{this.rebuild()},100))}_attachButtonListeners(){this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(e=>{e.addEventListener("click",t=>{t.currentTarget.dataset.action})})}_onChangeForm(s,e){super._onChangeForm(s,e);const t=this.element.querySelector('input[name="crlngn-send-request"]');t&&(this.sendRequest=t.checked);const i=this.element.querySelector('input[name="dc"]');i&&i.value&&(this.dcValue=parseInt(i.value)||null)}_buildConfig(s,e,t){const i=e==null?void 0:e.get("ability"),a=e==null?void 0:e.get("dc");i&&(s.ability=i,this.config.ability=i);const o=super._buildConfig(s,e,t);if(a){const l=parseInt(a);isNaN(l)||(o.options=o.options||{},o.options.target=l)}else this.dcValue!==void 0&&this.dcValue!==null&&(o.options=o.options||{},o.options.target=this.dcValue);return o}async _processSubmitData(s,e,t){if(await super._processSubmitData(s,e,t),t.has("dc")&&t.get("dc")!==""){const i=parseInt(t.get("dc"));if(!isNaN(i)&&(this.dcValue=i,this.config.rolls&&this.config.rolls.length>0))for(const a of this.config.rolls)a.options.target=i}this.sendRequest=t.get("crlngn-send-request")!=="false"}_finalizeRolls(s){const e=super._finalizeRolls(s);if(this.dcValue!==void 0&&this.dcValue!==null)for(const t of e)t.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,e}static async getConfiguration(s,e,t,i={}){var f,h,m,T,k,I,F,z,B,U,N,ee;const a=["skill","save","savingThrow","ability","abilityCheck","concentration"].includes(e),o=s[0];if(!o)return null;let l=CONFIG.Dice.D20Roll;["damage","healing"].includes(e)?l=CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:["formula","custom"].includes(e)&&(l=CONFIG.Dice.BasicRoll),l||(l=CONFIG.Dice.D20Roll);const n={data:o.getRollData(),subject:o,rolls:[{parts:[],data:o.getRollData(),options:{}}]};switch(e){case"skill":n.skill=t;break;case"save":case"savingThrow":n.ability=t;break;case"ability":case"abilityCheck":n.ability=t;break}const r={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:o})}},R={options:{actors:s,sendRequest:s.some(V=>this._isPlayerOwned(V)),showDC:a,rollKey:t,rollType:l,window:{title:Z._getRollTitle(e,t,o),subtitle:s.map(V=>V.name).join(", ")},...i}},g=new this(n,r,R.options),u=await new Promise(V=>{g.addEventListener("close",()=>{V({rolls:g.rolls,config:g.config,message:g.message,sendRequest:g.sendRequest})},{once:!0}),g.render({force:!0})});if(!u.rolls||u.rolls.length===0)return null;const c=u.rolls[0];let d=!1,y=!1;((f=c==null?void 0:c.options)==null?void 0:f.advantageMode)!==void 0&&(d=c.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,y=c.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const p={chatMessage:!0,isRollRequest:u.sendRequest,skipDialog:i.skipDialogs||!1,sendRequest:u.sendRequest};d&&(p.advantage=!0),y&&(p.disadvantage=!0);const C=game.settings.get("core","rollMode");u.message.rollMode&&u.message.rollMode!==C&&(p.rollMode=u.message.rollMode);let O=((h=c==null?void 0:c.options)==null?void 0:h.situational)||((m=c==null?void 0:c.data)==null?void 0:m.situational)||((k=(T=u.config)==null?void 0:T.data)==null?void 0:k.situational)||"";if(!O&&((I=c==null?void 0:c.parts)==null?void 0:I.length)>0&&c.parts.find(w=>w.includes("@situational"))&&(F=c.data)!=null&&F.situational&&(O=c.data.situational),O&&(p.situational=O,p.parts=["@situational"]),(z=c==null?void 0:c.options)!=null&&z.target&&(p.target=c.options.target),u.config.ability&&["skill","tool"].includes(e)){const V=((U=(B=o.system.skills)==null?void 0:B[t])==null?void 0:U.ability)||((ee=(N=CONFIG.DND5E.skills)==null?void 0:N[t])==null?void 0:ee.ability);u.config.ability!==V&&(p.ability=u.config.ability)}return p.rollTitle=R.options.window.title,p}static _isPlayerOwned(s){return Object.entries(s.ownership).some(([e,t])=>{const i=game.users.get(e);return i&&!i.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}static _getRollTitle(s,e,t){var a,o,l,n,r,R,g,u;let i="";switch(s){case"skill":const c=((a=CONFIG.DND5E.skills[e])==null?void 0:a.label)||e,d=(o=t==null?void 0:t.system.skills)==null?void 0:o[e],y=(d==null?void 0:d.ability)||((l=CONFIG.DND5E.skills[e])==null?void 0:l.ability)||"int",p=((n=CONFIG.DND5E.abilities[y])==null?void 0:n.label)||y;i=game.i18n.format("DND5E.SkillPromptTitle",{skill:c,ability:p});break;case"save":case"savingThrow":const C=((r=CONFIG.DND5E.abilities[e])==null?void 0:r.label)||e;i=game.i18n.format("DND5E.SavePromptTitle",{ability:C});break;case"ability":case"abilityCheck":const O=((R=CONFIG.DND5E.abilities[e])==null?void 0:R.label)||e;i=game.i18n.format("DND5E.AbilityPromptTitle",{ability:O});break;case"concentration":i=game.i18n.localize("DND5E.Concentration");break;case"tool":const f=(u=(g=CONFIG.DND5E.enrichmentLookup)==null?void 0:g.tools)==null?void 0:u[e];let h=e;if(f!=null&&f.id){const m=dnd5e.documents.Trait.getBaseItem(f.id,{indexOnly:!0});h=(m==null?void 0:m.name)||e}i=game.i18n.format("DND5E.ToolPromptTitle",{tool:h});break;case"deathsave":case"deathSave":i=game.i18n.localize("DND5E.DeathSave");break;case"initiative":case"initiativeDialog":i=game.i18n.localize("DND5E.Initiative");break;default:i=game.i18n.localize("DND5E.Roll")}return i}}class de extends dnd5e.applications.dice.SkillToolRollConfigurationDialog{constructor(s={},e={},t={}){const i=foundry.utils.mergeObject(s,{chooseAbility:!0});t.rollType=t.rollType||CONFIG.Dice.D20Roll,super(i,e,t),this.actors=t.actors||[],this.sendRequest=t.defaultSendRequest??t.sendRequest??!0,this.showDC=t.showDC||!1,this.dcValue=t.dcValue||null}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(s,e,t,i){const a=super._prepareConfigurationData(s,e,t,i);return a.showDC=this.showDC,a.dcValue=this.dcValue,a.sendRequest=this.sendRequest,a.actorCount=this.actors.length,a}async _preparePartContext(s,e,t){return e=await super._preparePartContext(s,e,t),s==="configuration"&&(e.showDC=this.showDC,e.dcValue=this.dcValue,e.sendRequest=this.sendRequest,e.actorCount=this.actors.length),e}async _onRender(s,e){var i,a,o;if(super._onRender(s,e),this.element.querySelector(".gm-roll-config-fields"))return;let t=this.element.querySelector(".rolls .formulas");if(t&&(this.showDC||this.actors.length>0)){const l={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},n=await renderTemplate(`modules/${q}/templates/gm-roll-config-fields.hbs`,l),r=document.createElement("div");r.className="gm-roll-config-fields",r.innerHTML=n,t.parentNode.insertBefore(r,t)}this._attachButtonListeners(),((o=(a=(i=this.config.rolls)==null?void 0:i[0])==null?void 0:a.data)!=null&&o.situational||this.config.situational)&&setTimeout(()=>{this.rebuild()},100)}_attachButtonListeners(){this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(e=>{e.addEventListener("click",t=>{t.currentTarget.dataset.action})})}_onChangeForm(s,e){var a,o;super._onChangeForm(s,e);const t=this.element.querySelector('input[name="crlngn-send-request"]');t&&(this.sendRequest=t.checked);const i=this.element.querySelector('input[name="dc"]');i&&i.value&&(this.dcValue=parseInt(i.value)||null),((a=e.target)==null?void 0:a.name)==="ability"&&((o=e.target)!=null&&o.value)&&(this.config.ability=e.target.value)}_buildConfig(s,e,t){const i=e==null?void 0:e.get("ability"),a=e==null?void 0:e.get("dc");i&&(s.ability=i,this.config.ability=i);const o=super._buildConfig(s,e,t);if(a){const l=parseInt(a);isNaN(l)||(o.options=o.options||{},o.options.target=l)}else this.dcValue!==void 0&&this.dcValue!==null&&(o.options=o.options||{},o.options.target=this.dcValue);return o}async _processSubmitData(s,e,t){if(await super._processSubmitData(s,e,t),t.has("dc")&&t.get("dc")!==""){const i=parseInt(t.get("dc"));if(!isNaN(i)&&(this.dcValue=i,this.config.rolls&&this.config.rolls.length>0))for(const a of this.config.rolls)a.options.target=i}this.sendRequest=t.get("crlngn-send-request")!=="false"}_finalizeRolls(s){const e=super._finalizeRolls(s);if(this.dcValue!==void 0&&this.dcValue!==null)for(const t of e)t.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,e}static async getConfiguration(s,e,t,i={}){var h,m,T,k,I,F,z,B,U;const a=["skill","tool"].includes(e),o=s[0];if(!o)return null;const l=CONFIG.Dice.D20Roll;let n=null;if(e==="skill"){const N=o.system.skills[t];n=(N==null?void 0:N.ability)||((h=CONFIG.DND5E.skills[t])==null?void 0:h.ability)||"int"}else if(e==="tool"){const N=(m=o.system.tools)==null?void 0:m[t];n=(N==null?void 0:N.ability)||((I=(k=(T=CONFIG.DND5E.enrichmentLookup)==null?void 0:T.tools)==null?void 0:k[t])==null?void 0:I.ability)||"int"}const r={data:o.getRollData(),subject:o,ability:n,chooseAbility:!0,rolls:[{parts:[],data:o.getRollData(),options:{}}]};e==="skill"?r.skill=t:e==="tool"&&(r.tool=t);const R={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:o})}},g={options:{actors:s,sendRequest:s.some(N=>Z._isPlayerOwned(N)),showDC:a,rollKey:t,rollType:l,window:{title:Z._getRollTitle(e,t,o),subtitle:s.map(N=>N.name).join(", ")},...i}},u=new this(r,R,g.options),c=await new Promise(N=>{u.addEventListener("close",()=>{N({rolls:u.rolls,config:u.config,message:u.message,sendRequest:u.sendRequest})},{once:!0}),u.render({force:!0})});if(!c.rolls||c.rolls.length===0)return null;const d=c.rolls[0];let y=!1,p=!1;((F=d==null?void 0:d.options)==null?void 0:F.advantageMode)!==void 0&&(y=d.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,p=d.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const C={chatMessage:!0,isRollRequest:c.sendRequest,skipDialog:i.skipDialogs||!1,sendRequest:c.sendRequest};y&&(C.advantage=!0),p&&(C.disadvantage=!0);const O=game.settings.get("core","rollMode");c.message.rollMode&&c.message.rollMode!==O&&(C.rollMode=c.message.rollMode);const f=((z=d==null?void 0:d.options)==null?void 0:z.situational)||((B=d==null?void 0:d.data)==null?void 0:B.situational)||"";return f&&(C.situational=f,C.parts=[f]),(U=d==null?void 0:d.options)!=null&&U.target&&(C.target=d.options.target),c.config.ability&&["skill","tool"].includes(e)&&(C.ability=c.config.ability),C.rollTitle=g.options.window.title,C}}class ge{static initialize(){game.user.isGM&&this.registerHooks()}static registerHooks(){this._registerHook(M.PRE_ROLL_ABILITY_CHECK,this._handlePreRoll.bind(this,"ability")),this._registerHook(M.PRE_ROLL_SAVING_THROW,this._handlePreRoll.bind(this,"save")),this._registerHook(M.PRE_ROLL_SKILL_V2,this._handlePreRoll.bind(this,"skill")),this._registerHook(M.PRE_ROLL_TOOL_V2,this._handlePreRoll.bind(this,"tool")),this._registerHook(M.PRE_ROLL_ATTACK_V2,this._handlePreRoll.bind(this,"attack")),this._registerHook(M.PRE_ROLL_DAMAGE_V2,this._handlePreRoll.bind(this,"damage")),this._registerHook(M.PRE_ROLL_INITIATIVE,this._handlePreRoll.bind(this,"initiative")),this._registerHook(M.PRE_ROLL_DEATH_SAVE_V2,this._handlePreRoll.bind(this,"deathsave")),this._registerHook(M.PRE_ROLL_HIT_DIE_V2,this._handlePreRoll.bind(this,"hitDie"))}static _registerHook(s,e){const t=Hooks.on(s,e);this.registeredHooks.add({hookName:s,hookId:t})}static unregisterHooks(){for(const{hookName:s,hookId:e}of this.registeredHooks)Hooks.off(s,e);this.registeredHooks.clear()}static _handleGenericPreRoll(s,e){if(!game.user.isGM||s!=null&&s.isRollRequest)return;const t=s==null?void 0:s.subject,i=A();if(!L.get(i.rollInterceptionEnabled.tag)||!t||t.documentName!=="Actor")return;const o=this._getActorOwner(t);if(!o||o.id===game.user.id||!o.active)return;let l="unknown",n=null;return s!=null&&s.ability?(l=s.save?"save":"ability",n=s.ability):s!=null&&s.skill?(l="skill",n=s.skill):s!=null&&s.tool&&(l="tool",n=s.tool),n&&s&&(s={...s,ability:n}),this._sendRollRequest(t,o,l,s),!1}static _handlePreRoll(s,e,t,i){var r;if(!game.user.isGM)return;let a;if(s==="initiative"&&e instanceof Actor){if(a=e,t!=null&&t.isRollRequest||i!=null&&i.isRollRequest)return}else{if(e!=null&&e.isRollRequest||t!=null&&t.isRollRequest||i!=null&&i.isRollRequest)return;a=((r=e.subject)==null?void 0:r.actor)||e.subject||e.actor}const o=A();if(!L.get(o.rollInterceptionEnabled.tag)||!a||a.documentName!=="Actor")return;const n=this._getActorOwner(a);if(!(!n||n.id===game.user.id)&&n.active)return this._showGMConfigDialog(a,n,s,e,t,i),!1}static async _showGMConfigDialog(s,e,t,i,a,o){var l,n;try{const r=["skill","tool"].includes(t)?de:Z;let R={rolls:[{parts:[],data:{},options:{}}]};switch(t){case"ability":R.ability=i.ability||((l=i.subject)==null?void 0:l.ability);break;case"save":R.ability=i.ability||((n=i.subject)==null?void 0:n.ability),i.ability==="con"&&i.targetValue!==void 0&&(t="concentration");break;case"skill":R.skill=i.skill,R.ability=i.ability;break;case"tool":R.tool=i.tool,R.ability=i.ability;break;case"concentration":R.ability="con";break}const g={actors:[s],rollType:t,showDC:!0,defaultSendRequest:!0,skipDialogs:!1},c=await new r(R,{},g).render(!0);if(!c||!c.sendRequest){await this._executeLocalRoll(s,t,i,c||{});return}const d={...i,...c,requestedBy:game.user.name};this._sendRollRequest(s,e,t,d)}catch{this._sendRollRequest(s,e,t,i)}}static async _executeLocalRoll(s,e,t,i){const a={...t,advantage:i.advantage||t.advantage,disadvantage:i.disadvantage||t.disadvantage,bonus:i.situational||t.bonus,target:i.dc||t.target,rollMode:i.rollMode||t.rollMode,isRollRequest:!1},o={configure:!1,isRollRequest:!1},l={rollMode:a.rollMode,create:!0,isRollRequest:!1};try{switch(e){case"save":await s.rollSavingThrow(t.ability,a,o,l);break;case"ability":await s.rollAbilityCheck(t.ability,a,o,l);break;case"skill":await s.rollSkill(t.skill,a,o,l);break;case"tool":await s.rollToolCheck(t.tool,a,o,l);break;case"concentration":await s.rollConcentration(a,o,l);break}}catch{}}static async _showConfigurationDialog(s,e,t,i,a,o){try{const n={...i,_rollMethod:async u=>(this._sendRollRequest(s,e,t,u),new Roll("1d20").evaluate({async:!1})),configured:!1},r=a.cls,g=await new r(n,a.options).render(!0)}catch{this._sendRollRequest(s,e,t,i)}}static _getActorOwner(s){const e=s.ownership||{};for(const[t,i]of Object.entries(e))if(i>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const a=game.users.get(t);if(a&&!a.isGM)return a}return null}static _sendRollRequest(s,e,t,i){var g;const a=A(),o=L.get(a.skipDialogs.tag);let l=null,n=null;switch(t){case"ability":case"save":l=i.ability;break;case"skill":l=i.skill;break;case"tool":l=i.tool;break;case"attack":case"damage":if((g=i.subject)!=null&&g.item){l=i.subject.item.id;const u=J.findActivityForRoll(i.subject.item,t);u&&(n=u.id)}break;case"hitDie":l=i.denomination;break}const r={advantage:i.advantage||!1,disadvantage:i.disadvantage||!1,situational:i.situational||0,parts:i.parts||[],rollMode:i.rollMode||game.settings.get("core","rollMode"),elvenAccuracy:i.elvenAccuracy||!1,halflingLucky:i.halflingLucky||!1,reliableTalent:i.reliableTalent||!1,minimum:i.minimum,maximize:i.maximize,critical:i.critical,fumble:i.fumble,targetValue:i.targetValue,fastForward:i.fastForward||!1,chatMessage:i.chatMessage!==!1,flavor:i.flavor,title:i.title,dialogOptions:i.dialogOptions,messageData:i.messageData};Object.keys(r).forEach(u=>{r[u]===void 0&&delete r[u]});const R={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:s.id,rollType:t,rollKey:l,activityId:n,config:r,skipDialog:o,targetTokenIds:Array.from(game.user.targets).map(u=>u.id),preserveTargets:L.get(a.useGMTargetTokens.tag)};P.execForUser("handleRollRequest",e.id,R),ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestSent",{player:e.name,actor:s.name}))}}S(ge,"registeredHooks",new Set);var G;const Y=class Y extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){constructor(e={}){super(e);S(this,"_onClickOutside",e=>{if(this.isLocked)return;const t=this.element;t&&(e.target.closest(".roll-requests-menu")||t.contains(e.target)||e.target.closest("#crlngn-requests-icon")||e.target.closest(".dialog, .app, .notification")||this.close())});this.selectedActors=new Set,this.currentTab="pc",this.selectedRequestType=null,this.isLocked=!1,this.optionsExpanded=game.user.getFlag(H.ID,"menuOptionsExpanded")??!1,this._initializeFromSelectedTokens()}async _prepareContext(e){var y;const t=await super._prepareContext(e),i=game.actors.contents,a=[],o=[],l=game.scenes.active;for(const p of i){if(p.type!=="character"&&p.type!=="npc")continue;const C={id:p.id,uuid:p.uuid,name:p.name,img:p.img,selected:this.selectedActors.has(p.id),crlngnStats:this._getActorStats(p)};Object.entries(p.ownership).some(([f,h])=>{const m=game.users.get(f);return m&&!m.isGM&&h>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})?a.push(C):l&&l.tokens.some(h=>h.actorId===p.id)&&o.push(C)}const n=A(),r=L.get(n.rollRequestsEnabled.tag),R=L.get(n.skipDialogs.tag),g=this.currentTab==="pc"?a:o,u=g.length>0&&g.every(p=>this.selectedActors.has(p.id)),c=[];if(this.selectedActors.size>0)for(const[p,C]of Object.entries(H.ROLL_REQUEST_OPTIONS))c.push({id:p,name:game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${C.name}`)||C.label,rollable:C.subList==null,hasSubList:!!C.subList,selected:this.selectedRequestType===p});const d=[];if(this.selectedRequestType&&this.selectedActors.size>0){const p=H.ROLL_REQUEST_OPTIONS[this.selectedRequestType];if(p&&p.subList){const C=Array.from(this.selectedActors)[0],O=game.actors.get(C);if(p.subList==="tools"){const f=((y=CONFIG.DND5E.enrichmentLookup)==null?void 0:y.tools)||CONFIG.DND5E.tools||{};for(const[h,m]of Object.entries(f)){let T=h;if(m!=null&&m.id){const k=dnd5e.documents.Trait.getBaseItem(m.id,{indexOnly:!0});T=(k==null?void 0:k.name)||h}else T=h.replace(/([A-Z])/g," $1").replace(/^./,k=>k.toUpperCase()).trim();d.push({id:h,name:T,rollable:!0})}d.sort((h,m)=>h.name.localeCompare(m.name))}else if(O&&p.actorPath){const f=foundry.utils.getProperty(O,p.actorPath)||{},h=CONFIG.DND5E[p.subList];for(const[m,T]of Object.entries(f)){let k="";p.subList==="skills"&&(h!=null&&h[m])||p.subList==="abilities"&&(h!=null&&h[m])?k=h[m].label:k=T.label||game.i18n.localize(T.name||m)||m,d.push({id:m,name:k,rollable:!0})}p.subList==="skills"&&d.sort((m,T)=>m.name.localeCompare(T.name))}}}return{...t,actors:g,currentTab:this.currentTab,isPCTab:this.currentTab==="pc",isNPCTab:this.currentTab==="npc",selectedTab:this.currentTab,rollRequestsEnabled:r,skipDialogs:R,selectAllOn:u,hasSelectedActors:this.selectedActors.size>0,requestTypes:c,rollTypes:d,showNames:!0,actorsLocked:this.isLocked,optionsExpanded:this.optionsExpanded}}_getActorStats(e){var a,o,l,n,r;const t=e.system,i=[];return(a=t.attributes)!=null&&a.hp&&i.push({abbrev:"HP",value:t.attributes.hp.value}),(o=t.attributes)!=null&&o.ac&&i.push({abbrev:"AC",value:t.attributes.ac.value}),(l=t.attributes)!=null&&l.spelldc&&i.push({abbrev:"DC",value:t.attributes.spelldc}),(r=(n=t.skills)==null?void 0:n.prc)!=null&&r.passive&&i.push({abbrev:"PP",value:t.skills.prc.passive}),i}_onRender(e,t){if(super._onRender(e,t),this._attachListeners(),this.optionsExpanded){const i=this.element.querySelector(".options-toggle"),a=this.element.querySelector("li.options");i&&i.classList.add("expanded"),a&&a.classList.add("expanded")}setTimeout(()=>{document.addEventListener("click",this._onClickOutside,!0)},100),this._tokenControlHook=Hooks.on("controlToken",this._onTokenControlChange.bind(this))}_onTokenControlChange(e,t){this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{this._initializeFromSelectedTokens(),this.render(),this._tokenUpdateTimeout=null},100)))}_attachListeners(){var o,l,n,r,R;const e=this.element;(o=e.querySelector("#crlngn-requests-toggle"))==null||o.addEventListener("change",this._onToggleRollRequests.bind(this)),(l=e.querySelector("#crlngn-skip-dialogs"))==null||l.addEventListener("change",this._onToggleSkipDialogs.bind(this)),(n=e.querySelector("#crlngn-actors-all"))==null||n.addEventListener("change",this._onToggleSelectAll.bind(this)),(r=e.querySelector("#crlngn-actors-lock"))==null||r.addEventListener("click",this._onToggleLock.bind(this)),(R=e.querySelector(".options-toggle"))==null||R.addEventListener("click",this._onToggleOptions.bind(this)),e.querySelectorAll(".actor-tab").forEach(g=>{g.addEventListener("click",this._onTabClick.bind(this))}),e.querySelectorAll(".actor").forEach(g=>{g.addEventListener("click",this._onActorClick.bind(this))}),e.querySelectorAll(".actor-select").forEach(g=>{g.addEventListener("click",this._onActorSelectClick.bind(this))});const i=e.querySelector(".request-types");i&&i.addEventListener("click",g=>{const u=g.target.closest("li");if(u&&u.dataset.id){const c={...g,currentTarget:u};this._onRequestTypeClick(c)}});const a=e.querySelector(".roll-types");a&&a.addEventListener("click",g=>{const u=g.target.closest("li");if(u&&u.dataset.id){const c={...g,currentTarget:u};this._onRollTypeClick(c)}})}async _onToggleRollRequests(e){const t=A(),i=e.target.checked;await L.set(t.rollRequestsEnabled.tag,i),he.updateRollRequestsIcon(i)}async _onToggleSkipDialogs(e){const t=A(),i=e.target.checked;await L.set(t.skipDialogs.tag,i)}_onToggleSelectAll(e){const t=e.target.checked;this._ignoreTokenControl=!0,(this.currentTab==="pc"?game.actors.contents.filter(a=>this._isPlayerOwned(a)):game.actors.contents.filter(a=>!this._isPlayerOwned(a)&&this._hasTokenInScene(a))).forEach(a=>{t?(this.selectedActors.add(a.id),this._updateCanvasTokenSelection(a.id,!0)):(this.selectedActors.delete(a.id),this._updateCanvasTokenSelection(a.id,!1))}),setTimeout(()=>{this._ignoreTokenControl=!1},200),this.render(),this._updateRequestTypesVisibility()}_onToggleLock(e){e.preventDefault(),this.isLocked=!this.isLocked;const t=e.currentTarget;t.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),t.classList.add(this.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open")}async _onToggleOptions(e){e.preventDefault(),this.optionsExpanded=!this.optionsExpanded,await game.user.setFlag(H.ID,"menuOptionsExpanded",this.optionsExpanded);const t=e.currentTarget||e.target.closest(".options-toggle");t&&t.classList.toggle("expanded",this.optionsExpanded);const i=this.element.querySelector("li.options");i&&i.classList.toggle("expanded",this.optionsExpanded)}_initializeFromSelectedTokens(){var t;const e=((t=canvas.tokens)==null?void 0:t.controlled)||[];this.selectedActors.clear();for(const i of e)if(i.actor&&(this.selectedActors.add(i.actor.id),this.selectedActors.size===1)){const a=this._isPlayerOwned(i.actor);this.currentTab=a?"pc":"npc"}}_isPlayerOwned(e){return e.type!=="character"&&e.type!=="npc"?!1:Object.entries(e.ownership).some(([t,i])=>{const a=game.users.get(t);return a&&!a.isGM&&i>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}_hasTokenInScene(e){if(e.type!=="character"&&e.type!=="npc")return!1;const t=game.scenes.active;return t&&t.tokens.some(i=>i.actorId===e.id)}async _onTabClick(e){var i;const t=e.currentTarget.dataset.tab;t!==this.currentTab&&(this.selectedActors.clear(),(i=canvas.tokens)==null||i.releaseAll(),this.selectedRequestType=null,this.currentTab=t,await this.render())}_onActorClick(e){if(e.target.closest(".actor-select"))return;const i=e.currentTarget.dataset.id;this._toggleActorSelection(i)}_onActorSelectClick(e){e.stopPropagation();const t=e.currentTarget.dataset.id;this._toggleActorSelection(t)}_toggleActorSelection(e){this._ignoreTokenControl=!0,this.selectedActors.has(e)?(this.selectedActors.delete(e),this._updateCanvasTokenSelection(e,!1)):(this.selectedActors.add(e),this._updateCanvasTokenSelection(e,!0)),setTimeout(()=>{this._ignoreTokenControl=!1},100),this.render(),this._updateRequestTypesVisibility(),this._updateSelectAllState()}_updateCanvasTokenSelection(e,t){if(!game.scenes.active)return;const a=canvas.tokens.placeables.filter(o=>{var l;return((l=o.actor)==null?void 0:l.id)===e});for(const o of a)t?o.control({releaseOthers:!1}):o.release()}_updateRequestTypesVisibility(){this.render()}_updateSelectAllState(){const e=this.element.querySelector("#crlngn-actors-all"),t=this.currentTab==="pc"?"pc":"npc",i=this.element.querySelectorAll(`.${t}-actors .actor-item input[type="checkbox"]`),a=Array.from(i).filter(o=>o.checked).length;e.checked=a>0&&a===i.length,e.indeterminate=a>0&&a<i.length}async _onRequestTypeClick(e){const i=e.currentTarget.dataset.id,a=H.ROLL_REQUEST_OPTIONS[i];if(!a){K.error("Unknown request type:",i);return}this.selectedRequestType===i?this.selectedRequestType=null:this.selectedRequestType=i,a.subList?await this.render():this.selectedRequestType&&this._triggerRoll(i,null)}_onRollTypeClick(e){const t=e.currentTarget.dataset.id;this._triggerRoll(this.selectedRequestType,t)}async _triggerRoll(e,t){var O;const i=A(),a=Array.from(this.selectedActors),o=L.get(i.skipDialogs.tag),l=a.filter(f=>{const h=game.actors.get(f);if(!h)return!1;const m=this._isPlayerOwned(h),T=!m&&this._hasTokenInScene(h);return this.currentTab==="pc"&&m||this.currentTab==="npc"&&T}),n=H.ROLL_REQUEST_OPTIONS[e],r=(n==null?void 0:n.name)||e;if(r==="custom"){const f=await this._showCustomRollDialog();if(!f)return;t=f}if(r==="initiativeDialog"&&!game.combat)if(await Dialog.confirm({title:game.i18n.localize("COMBAT.Create"),content:"<p>"+game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.noCombatActive")+"</p>",yes:()=>!0,no:()=>!1,defaultYes:!0,options:{classes:["crlngn-rolls-dialog"]}}))await(await game.combats.documentClass.create({scene:game.scenes.active.id})).activate(),ui.notifications.info(game.i18n.localize("CRLNGN_ROLL_REQUESTS.notifications.combatCreated"));else return;let R=l;if(r==="initiativeDialog"&&game.combat){const f=l.map(T=>game.actors.get(T)).filter(T=>T),h=[],m=new Set;for(const T of f){const k=game.combat.getCombatantByActor(T.id);k&&k.initiative!==null&&(h.push(T.name),m.add(T.id))}if(h.length>0){if(await Dialog.confirm({title:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.rerollInitiativeTitle"),content:"<p>"+game.i18n.format("CRLNGN_ROLLS.ui.dialogs.rerollInitiative",{actors:h.join(", ")})+"</p>",yes:()=>!0,no:()=>!1,defaultYes:!1,options:{classes:["crlngn-rolls-dialog"]}}))for(const k of m){const I=game.combat.getCombatantByActor(k);I&&await I.update({initiative:null})}else if(R=l.filter(k=>!m.has(k)),R.length===0){ui.notifications.info(game.i18n.localize("CRLNGN_ROLL_REQUESTS.notifications.allActorsHaveInitiative"));return}}}let g=R.map(f=>game.actors.get(f)).filter(f=>f);if(r==="deathSave"){const f=[],h=[];for(const m of g){const T=((O=m.system.attributes.hp)==null?void 0:O.value)||0,k=m.system.attributes.death||{},I=k.success||0,F=k.failure||0;T<=0&&I<3&&F<3?f.push(m):h.push(m.name)}h.length>0&&ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.actorsSkippingDeathSave",{actors:h.join(", ")})),g=f}if(!g.length){ui.notifications.warn("No valid actors selected");return}const u=[],c=[];for(const f of g){const h=this._getActorOwner(f);h?u.push({actor:f,owner:h}):c.push(f)}const d=L.get(i.rollRequestsEnabled.tag);let y=null;if(o)y={advantage:!1,disadvantage:!1,situational:"",parts:[],rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipDialog:!0,sendRequest:d&&u.length>0},r==="deathSave"&&(y.target=10);else if(y=await(["skill","tool"].includes(r)?de:Z).getConfiguration(g,r,t,{skipDialogs:o,defaultSendRequest:d}),!y)return;const p=[],C=[];if(y.sendRequest){for(const{actor:f,owner:h}of u){if(!h.active){L.get(i.showOfflineNotifications.tag)&&ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.playerOffline",{player:h.name})),C.push(f);continue}this._sendRollRequestToPlayer(f,h,r,t,y,!0),p.push({actor:f,owner:h}),await new Promise(m=>setTimeout(m,100))}p.length>0&&this._sendConsolidatedNotification(p,r,t)}else c.push(...u.map(({actor:f})=>f));if(C.length>0){const f={...y,skipDialog:!0};await this._handleNPCRolls(C,r,t,f)}if(c.length>0){const f={...y};f.fastForward=!0,f.skipDialog=!0,await this._handleNPCRolls(c,r,t,f)}setTimeout(()=>this.close(),500)}_getActorOwner(e){const t=e.ownership||{};for(const[i,a]of Object.entries(t))if(a>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.get(i);if(o&&!o.isGM)return o}return null}_sendRollRequestToPlayer(e,t,i,a,o,l=!1){const n=A(),R={abilityCheck:"ability",savingThrow:"save",skill:"skill",tool:"tool",concentration:"concentration",initiativeDialog:"initiative",deathSave:"deathsave",custom:"custom"}[i]||i,g={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:e.id,rollType:R,rollKey:a,activityId:null,config:{rollMode:o.rollMode||game.settings.get("core","rollMode"),advantage:o.advantage||!1,disadvantage:o.disadvantage||!1,situational:o.situational||"",parts:o.parts||[],chatMessage:o.chatMessage!==!1,target:o.target,ability:o.ability,attackMode:o.attackMode,rollTitle:o.rollTitle},skipDialog:o.skipDialog||!1,targetTokenIds:Array.from(game.user.targets).map(u=>u.id),preserveTargets:L.get(n.useGMTargetTokens.tag)};P.execForUser("handleRollRequest",t.id,g),l||ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestSent",{player:t.name,actor:e.name}))}_sendConsolidatedNotification(e,t,i){var n,r,R,g,u;const a={};for(const{actor:c,owner:d}of e)a[d.id]||(a[d.id]={player:d,actors:[]}),a[d.id].actors.push(c);for(const[c,d]of Object.entries(H.ROLL_REQUEST_OPTIONS))if(d.name===t)break;const o=t;let l=game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${o}`)||o;if(i)if(o==="skill")l=`${l} (${((n=CONFIG.DND5E.skills[i])==null?void 0:n.label)||i})`;else if(o==="savingThrow")l=`${l} (${((r=CONFIG.DND5E.abilities[i])==null?void 0:r.label)||i})`;else if(o==="abilityCheck")l=`${l} (${((R=CONFIG.DND5E.abilities[i])==null?void 0:R.label)||i})`;else if(o==="tool"){const c=(u=(g=CONFIG.DND5E.enrichmentLookup)==null?void 0:g.tools)==null?void 0:u[i];if(c!=null&&c.id){const d=dnd5e.documents.Trait.getBaseItem(c.id,{indexOnly:!0});l=`${l} (${(d==null?void 0:d.name)||i})`}else l=`${l} (${i})`}else o==="custom"&&(l=`${l}: ${i}`);if(Object.keys(a).length===1){const c=Object.values(a)[0],d=c.actors.map(y=>y.name).join(", ");ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsSentSingle",{rollType:l,actors:d,player:c.player.name}))}else{const c=Object.values(a).map(d=>{const y=d.actors.map(p=>p.name).join(", ");return`${d.player.name} (${y})`});ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsSentMultiple",{rollType:l,count:e.length,players:c.join("; ")}))}}async _handleNPCRolls(e,t,i,a){const o={advantage:a.advantage||!1,disadvantage:a.disadvantage||!1,situational:a.situational||"",parts:a.parts||[],rollMode:a.rollMode||game.settings.get("core","rollMode"),fastForward:a.skipDialog||!1,chatMessage:a.chatMessage!==!1,isRollRequest:a.isRollRequest||!1,target:a.target,ability:a.ability,attackMode:a.attackMode};for(const l of e)await this._executeActorRoll(l,t,i,o),await new Promise(n=>setTimeout(n,100))}async _executeActorRoll(e,t,i,a){var o,l,n,r,R;try{switch(t.toLowerCase()){case"abilitycheck":const u={ability:i,advantage:a.advantage,disadvantage:a.disadvantage,target:a.target,isRollRequest:a.isRollRequest},c={configure:!a.fastForward},d={rollMode:a.rollMode,create:a.chatMessage!==!1};a.situational&&(u.rolls=[{parts:[],data:{situational:a.situational},options:{},situational:a.situational}]),await e.rollAbilityCheck(u,c,d);break;case"savingthrow":const y={ability:i,advantage:a.advantage,disadvantage:a.disadvantage,target:a.target,isRollRequest:a.isRollRequest},p={configure:!a.fastForward},C={rollMode:a.rollMode,create:a.chatMessage!==!1};a.situational&&(y.rolls=[{parts:[],data:{situational:a.situational},options:{},situational:a.situational}]),await e.rollSavingThrow(y,p,C);break;case"skill":const O={skill:i,advantage:a.advantage,disadvantage:a.disadvantage,ability:a.ability,chooseAbility:!a.ability},f={configure:!a.fastForward},h={rollMode:a.rollMode,create:a.chatMessage!==!1,data:{}};if(a.rollTitle)h.data.flavor=a.rollTitle;else if(a.ability){const w=((o=CONFIG.DND5E.skills[i])==null?void 0:o.label)||i,D=((l=CONFIG.DND5E.abilities[a.ability])==null?void 0:l.label)||a.ability;h.data.flavor=game.i18n.format("DND5E.SkillPromptTitle",{skill:w,ability:D})}a.situational&&(O.bonus=a.situational),a.target&&(O.target=a.target),await e.rollSkill(O,f,h);break;case"tool":const m={tool:i,advantage:a.advantage,disadvantage:a.disadvantage,ability:a.ability,chooseAbility:!a.ability},T={configure:!a.fastForward},k={rollMode:a.rollMode,create:a.chatMessage!==!1,data:{}};if(a.rollTitle)k.data.flavor=a.rollTitle;else if(a.ability){let w=i;const D=(r=(n=CONFIG.DND5E.enrichmentLookup)==null?void 0:n.tools)==null?void 0:r[i];if(D!=null&&D.id){const se=dnd5e.documents.Trait.getBaseItem(D.id,{indexOnly:!0});w=(se==null?void 0:se.name)||i}const pe=((R=CONFIG.DND5E.abilities[a.ability])==null?void 0:R.label)||a.ability;k.data.flavor=`${pe} (${w}) ${game.i18n.localize("DND5E.Check")}`}a.situational&&(m.bonus=a.situational),a.target&&(m.target=a.target),await e.rollToolCheck(m,T,k);break;case"concentration":const I={configure:!a.fastForward&&!a.skipDialog},F={rollMode:a.rollMode,create:a.chatMessage!==!1};await e.rollConcentration(a,I,F);break;case"initiativedialog":if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));break}const z={configure:!a.fastForward&&!a.skipDialog},B={rollMode:a.rollMode,create:a.chatMessage!==!1};if(!await e.rollInitiativeDialog(a,z,B)){let w=game.combat.getCombatantByActor(e.id);if(!w){const D=e.getActiveTokens();D.length&&(await game.combat.createEmbeddedDocuments("Combatant",[{tokenId:D[0].id,actorId:e.id}]),w=game.combat.getCombatantByActor(e.id))}if(w){const D=w.getInitiativeRoll();await D.evaluate({async:!0}),await w.update({initiative:D.total}),await D.toMessage({speaker:ChatMessage.getSpeaker({actor:e}),flavor:game.i18n.localize("DND5E.Initiative")})}}break;case"deathsave":const N={configure:!a.fastForward&&!a.skipDialog},ee={rollMode:a.rollMode,create:a.chatMessage!==!1},V=await e.rollDeathSave(a,N,ee);break;case"custom":try{const w=new Roll(i,e.getRollData());await w.evaluate({async:!0}),await w.toMessage({speaker:ChatMessage.getSpeaker({actor:e}),flavor:game.i18n.localize("CRLNGN_ROLLS.rollTypes.custom")})}catch{ui.notifications.error(game.i18n.format("CRLNGN_ROLLS.ui.notifications.invalidFormula",{formula:i}))}break;default:ui.notifications.warn(`Unknown roll type: ${t}`);break}}catch{ui.notifications.error(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollError",{actor:e.name}))}}async _onClose(e){await super._onClose(e),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),this._tokenControlHook&&(Hooks.off("controlToken",this._tokenControlHook),this._tokenControlHook=null),this._tokenUpdateTimeout&&(clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=null)}setPosition(e={}){return this}async _showCustomRollDialog(){return new Promise(async e=>{const t=await renderTemplate(`modules/${H.ID}/templates/custom-roll-dialog.hbs`,{formula:"",readonly:!1});new Dialog({title:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.customRollTitle"),content:t,buttons:{roll:{icon:'<i class="fas fa-dice-d20"></i>',label:game.i18n.localize("Roll"),callback:a=>{const l=(a[0]||a).querySelector("#custom-roll-formula").value.trim();e(l||null)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("Cancel"),callback:()=>e(null)}},default:"roll",render:a=>{const o=a[0]||a,l=o.querySelector("#custom-roll-formula"),n={};o.querySelectorAll(".dice-button").forEach(r=>{r.addEventListener("click",R=>{const g=R.currentTarget.dataset.die;n[g]=(n[g]||0)+1;const u=[];for(const[c,d]of Object.entries(n))d>0&&u.push(`${d}${c}`);l.value=u.join(" + ")})})}},{classes:["crlngn-rolls-dialog","crlngn-custom-roll-dialog"]}).render(!0)})}static toggle(){$(this,G)?$(this,G).rendered?$(this,G).close():($(this,G)._initializeFromSelectedTokens(),$(this,G).render(!0)):(ce(this,G,new Y),$(this,G).render(!0))}};G=new WeakMap,re(Y,G,null),S(Y,"DEFAULT_OPTIONS",{id:"crlngn-requests-menu",classes:["roll-requests-menu"],tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:null}),S(Y,"PARTS",{main:{template:`modules/${H.ID}/templates/requests-menus.hbs`}});let ae=Y;class he{static addSidebarControls(s,e,t){if(!game.user.isGM||s.id!=="chat")return;const a=(e[0]||e).querySelector("#chat-controls");if(!a||a.querySelector(".roll-requests-icon"))return;const o=A(),l=L.get(o.rollRequestsEnabled.tag),n=document.createElement("a");n.id="crlngn-requests-icon",n.setAttribute("data-tooltip-direction","RIGHT"),n.className=`chat-control-icon roll-requests-icon${l?" active":""}`,n.title=game.i18n.localize("CRLNGN_ROLLS.ui.menus.rollRequestsTitle"),n.innerHTML=`<i class="fas fa-bolt${l?"":"-slash"}"></i>`;const r=a.querySelector(".chat-control-icon");r?r.parentNode.insertBefore(n,r):a.insertBefore(n,a.firstChild),n.addEventListener("click",()=>{ae.toggle()})}static updateRollRequestsIcon(s){const e=document.querySelector("#crlngn-requests-icon i");e&&(e.className=`fas fa-bolt${s?"":"-slash"}`)}}class fe{static initialize(){Hooks.once(W.INIT,this._onInit.bind(this)),Hooks.once(W.READY,this._onReady.bind(this))}static _onInit(){A(),document.body.classList.add("crlngn-rolls"),L.registerSettings(),x.initialize(),this._registerHook(W.RENDER_SIDEBAR_TAB,this._onRenderSidebarTab.bind(this))}static _onReady(){const s=A();L.get(s.debugMode.tag)&&(CONFIG.debug.hooks=!0),ge.initialize(),this._registerDnd5eHooks(),game.user.isGM?this._registerGMHooks():x.getDiceConfig(),_e(ye())}static _registerDnd5eHooks(){this._registerHook(M.POST_ROLL_CONFIG,this._onPostRollConfig.bind(this)),this._registerHook(W.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessage.bind(this)),this._registerHook(W.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageFlavor.bind(this)),this._registerHook(M.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this))}static _registerGMHooks(){this._registerHook(W.USER_CONNECTED,this._onUserConnected.bind(this)),game.users.forEach(s=>{this._onUserConnected(s)})}static _onPostRollConfig(s,e,t,i){e._isRequestedRoll&&s.length>0&&(i.data=i.data||{},i.data._isRequestedRoll=!0,i.data._requestedBy=e._requestedBy)}static _onPreCreateChatMessage(s,e,t,i){var a;if(e._isRequestedRoll&&((a=e.rolls)==null?void 0:a.length)>0){const o=e._requestedBy||"GM",l=game.i18n.format("CRLNGN_ROLL_REQUESTS.chat.requestedBy",{gm:o}),n=e.flavor||"";e.flavor=n?`${n} ${l}`:l}}static _onPreCreateChatMessageFlavor(s,e,t,i){var a,o;if(((a=e.rolls)==null?void 0:a.length)>0&&e.rolls[0])try{const l=e.rolls[0];(o=l.options)!=null&&o._customFlavor&&(e.flavor=l.options._customFlavor)}catch{}}static _onRenderRollConfigDialog(s,e,t){if(s._situationalTriggered)return;const i=e.querySelectorAll('input[name*="situational"]');let a=!1;i.forEach(o=>{o.value&&!a&&(s._situationalTriggered=!0,a=!0,setTimeout(()=>{var l,n,r;o.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1})),(r=(n=(l=s.config)==null?void 0:l.rolls)==null?void 0:n[0])!=null&&r.data&&delete s.config.rolls[0].data.situational},50))})}static _onUserConnected(s){s.active&&s.id!==game.user.id&&x.requestDiceConfigFromUser(s.id)}static _onRenderSidebarTab(s,e,t){he.addSidebarControls(s,e,t)}static _registerHook(s,e){const t=Hooks.on(s,e);return this.registeredHooks.set(`${s}_${t}`,t),t}static unregisterAll(){this.registeredHooks.forEach((s,e)=>{const t=e.split("_")[0];Hooks.off(t,s)}),this.registeredHooks.clear()}static isRegistered(s){for(const e of this.registeredHooks.keys())if(e.startsWith(`${s}_`))return!0;return!1}}S(fe,"registeredHooks",new Map);const v=class v{static init(){P.initialize(v.registerSocketCalls),fe.initialize()}static getDiceConfig(){return x.getDiceConfig()}static receiveDiceConfig(s,e){x.receiveDiceConfig(s,e)}static async handleRollRequest(s){var t;if(game.user.isGM)return;const e=game.actors.get(s.actorId);e&&e.isOwner&&(s.preserveTargets&&((t=s.targetTokenIds)==null?void 0:t.length)>0&&game.user.targets.size===0&&Te(s.targetTokenIds),v.pendingNotifications.push({actor:e.name,rollType:s.rollType,rollKey:s.rollKey,gm:s.config.requestedBy||"GM"}),v.notificationTimer&&clearTimeout(v.notificationTimer),v.notificationTimer=setTimeout(()=>{Ce(v.pendingNotifications),v.pendingNotifications=[],v.notificationTimer=null},v.NOTIFICATION_BATCH_DELAY),v._executeRequestedRoll(e,s))}static async _executeRequestedRoll(s,e){try{const t={advantage:e.config.advantage||!1,disadvantage:e.config.disadvantage||!1,isRollRequest:!0,target:e.config.target,_isRequestedRoll:!0,_requestedBy:e.config.requestedBy||"GM"};e.config.situational&&(t.bonus=e.config.situational),e.config.ability&&[_.SKILL,_.TOOL].includes(e.rollType)&&(t.ability=e.config.ability);const i={configure:!e.skipDialog,options:{defaultButton:e.config.advantage?"advantage":e.config.disadvantage?"disadvantage":"normal",window:{title:e.config.rollTitle||ue(e.rollType,e.rollKey),subtitle:s.name}}},a={rollMode:e.config.rollMode||game.settings.get("core","rollMode"),create:e.config.chatMessage!==!1};switch(e.rollType){case _.ABILITY:const o={ability:e.rollKey,advantage:e.config.advantage||!1,disadvantage:e.config.disadvantage||!1,target:e.config.target,isRollRequest:!0,_isRequestedRoll:!0,_requestedBy:e.config.requestedBy||"GM"};e.config.situational&&(o.rolls=[{parts:[],data:{situational:e.config.situational},options:{},situational:e.config.situational}]),await s.rollAbilityCheck(o,i,a);break;case _.SAVE:const l={ability:e.rollKey,advantage:e.config.advantage||!1,disadvantage:e.config.disadvantage||!1,target:e.config.target,isRollRequest:!0,_isRequestedRoll:!0,_requestedBy:e.config.requestedBy||"GM"};e.config.situational&&(l.rolls=[{parts:[],data:{situational:e.config.situational},options:{},situational:e.config.situational}]),await s.rollSavingThrow(l,i,a);break;case _.SKILL:const n={...t,skill:e.rollKey,chooseAbility:!0};e.config.ability&&(n.ability=e.config.ability),await s.rollSkill(n,i,a);break;case _.TOOL:const r={...t,tool:e.rollKey,chooseAbility:!0};e.config.ability&&(r.ability=e.config.ability),await s.rollToolCheck(r,i,a);break;case _.CONCENTRATION:e.config.situational&&(t.rolls=[{parts:[],data:{situational:e.config.situational},options:{},situational:e.config.situational}]),await s.rollConcentration(t,i,a);break;case _.ATTACK:e.rollKey&&await J.executeActivityRoll(s,_.ATTACK,e.rollKey,e.activityId,{...t,dialog:i,message:a});break;case _.DAMAGE:e.rollKey&&await J.executeActivityRoll(s,_.DAMAGE,e.rollKey,e.activityId,{...t,dialog:i,message:a});break;case _.ITEM_SAVE:e.rollKey&&await J.executeActivityRoll(s,_.ITEM_SAVE,e.rollKey,e.activityId,{...t,dialog:i,message:a});break;case _.INITIATIVE:if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));break}e.config.situational&&(t.rolls=[{parts:[],data:{situational:e.config.situational},options:{},situational:e.config.situational}]),await s.rollInitiativeDialog(t,i,a);break;case _.DEATH_SAVE:await s.rollDeathSave(t,i,a);break;case _.HIT_DIE:t.denomination=e.rollKey,await s.rollHitDie(t,i,a);break;case _.CUSTOM:await v._handleCustomRoll(s,e);break}}catch{ui.notifications.error(game.i18n.localize("CRLNGN_ROLL_REQUESTS.notifications.rollError"))}}static async _handleCustomRoll(s,e){const t=e.rollKey,i=await renderTemplate(`modules/${q}/templates/custom-roll-dialog.hbs`,{formula:t,readonly:!0});new Dialog({title:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.customRollTitle"),content:i,buttons:{roll:{icon:'<i class="fas fa-dice-d20"></i>',label:game.i18n.localize("Roll"),callback:async()=>{try{const o=new Roll(t,s.getRollData());await o.evaluate({async:!0}),await o.toMessage({speaker:ChatMessage.getSpeaker({actor:s}),flavor:game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${_.CUSTOM}`)})}catch{ui.notifications.error(game.i18n.format("CRLNGN_ROLLS.ui.notifications.invalidFormula",{formula:t}))}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("Cancel")}},default:"roll"},{classes:["crlngn-rolls-dialog","crlngn-custom-roll-dialog"]}).render(!0)}static registerSocketCalls(){P.registerCall(ie.getDiceConfig,v.getDiceConfig),P.registerCall(ie.receiveDiceConfig,v.receiveDiceConfig),P.registerCall(ie.handleRollRequest,v.handleRollRequest)}};S(v,"pendingNotifications",[]),S(v,"notificationTimer",null),S(v,"NOTIFICATION_BATCH_DELAY",500);let oe=v;oe.init();
//# sourceMappingURL=crlngn-roll-requests.js.map
