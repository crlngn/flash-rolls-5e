var xe=Object.defineProperty;var Ae=C=>{throw TypeError(C)};var He=(C,e,t)=>e in C?xe(C,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):C[e]=t;var b=(C,e,t)=>He(C,typeof e!="symbol"?e+"":e,t),Re=(C,e,t)=>e.has(C)||Ae("Cannot "+t);var X=(C,e,t)=>(Re(C,e,"read from private field"),t?t.call(C):e.get(C)),Y=(C,e,t)=>e.has(C)?Ae("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(C):e.set(C,t);var j=(C,e,t)=>(Re(C,e,"access private method"),t);const V={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessage",RENDER_ROLL_RESOLVER:"renderRollResolver",USER_CONNECTED:"userConnected",COLLAPSE_SIDE_BAR:"collapseSidebar"},Ke={READY:"socketlib.ready"},Z={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog"},k="crlngn-roll-requests",_=["%cRoll That For Me","color:rgb(47, 151, 161); font-weight: bold;","|"],G={ATTACK:{name:"attack",requestType:"attack"},DAMAGE:{name:"damage",requestType:"damage"},SAVE:{name:"save",requestType:"damage"},SAVING_THROW:{name:"savingthrow",requestType:"check"},ABILITY_CHECK:{name:"abilitycheck",requestType:"check"},CONCENTRATION:{name:"concentration",requestType:"check"},DEATH_SAVE:{name:"deathsave",requestType:"save"},SKILL:{name:"skill",requestType:"check"},TOOL:{name:"tool",requestType:"check"},HIT_DIE:{name:"hitdie",requestType:"formula"},INITIATIVE:{name:"initiative",requestType:"check"},FORMULA:{name:"formula",requestType:"formula"},RECHARGE:{name:"recharge",requestType:"formula"},D20_TEST:{name:"d20Test",requestType:"formula"},SHORT_REST:{name:"shortRest",requestType:"formula"},LONG_REST:{name:"longRest",requestType:"formula"}},Be={SAVE:"save"},Se={ACTIVITY:"activity",CHECK:"check"},L={ABILITY_CHECK:{name:"abilityCheck",label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:"savingThrow",label:"Saving Throw",subList:"abilities",actorPath:"system.savingThrows"},SKILL:{name:"skill",label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:"tool",label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:"concentration",label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:"initiativeDialog",label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:"deathSave",label:"Death Save",subList:null,actorPath:""},CUSTOM:{name:"custom",label:"Custom Roll",subList:null,actorPath:""}},le=class le{static log(e="",t=[],s=!1){try{const a=game.settings.get(k,"debugMode")||le.debugOn;if(!(s||a))return;console.log(..._,e,...t)}catch{console.log(..._,e,...t)}}static warn(e="",t=[]){console.warn(..._,e,...t)}static error(e,t={ui:!1,console:!0,permanent:!1}){var s;t.ui&&((s=ui.notifications)==null||s.error(e,{localize:!0,permanent:t.permanent})),t.console&&console.error(..._,e)}};b(le,"debugOn",!1);let c=le;const ee={checkbox:"checkbox"},te={client:"client",world:"world"},H=()=>({debugMode:{tag:"debug-mode",label:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:ee.checkbox,default:!0,scope:te.client,config:!0},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:ee.checkbox,default:!0,scope:te.world,config:!0},skipDialogs:{tag:"skip-dialogs",label:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.hint"),propType:Boolean,inputType:ee.checkbox,default:!1,scope:te.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:ee.checkbox,default:!1,scope:te.world,config:!0}});class P{static getTargets(e){let t=game.users.find(a=>a.isGM===!0),s=e.targets||t.targets;return new Set([...s])}static getActorFromItem(e){const t=e.split(".")[1];return game.actors.get(t)}static isModuleOn(e){var s;const t=(s=game.modules)==null?void 0:s.get(e);return!!(t!=null&&t.active)}static isPrivateRoll(e){return e===CONST.DICE_ROLL_MODES.BLIND||e===CONST.DICE_ROLL_MODES.PRIVATE}static removeTemplateForItem(e){c.log("removeTemplateForItem - A",[e]);const t=I.get("remove-template");if(c.log("removeTemplateForItem - B",[t]),!t)return;const s=canvas.templates.objects.children.filter(a=>a.document.flags.dnd5e.item===(e==null?void 0:e.uuid));canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",s.map(a=>a.id))}static getPlayerOwner(e){let t;if(!e)return null;const s=e?game.actors.get(e):null;return t=game.users.players.find(o=>o.active===!0&&o.character.id===e),t||game.users.players.forEach(o=>{o.active&&s.testUserPermission(o,foundry.CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER,{exact:!0})&&(t=o)}),t}static html(e,t){return e.querySelector(t)}static getActivityType(e){var t;return((t=Object.values(G).find(s=>s.name.toLowerCase()===e.toLowerCase()))==null?void 0:t.activityType)||""}static getPartsFromActivityUuid(e){const t=e.split(".");return{actorId:t[1],itemId:t[3],activityId:t[5]}}static getElement(e){return(e==null?void 0:e[0])||e}static getSceneTargets(){var t;let e=((t=canvas.tokens)==null?void 0:t.controlled.filter(s=>s.actor))??[];return!e.length&&game.user.character&&(e=game.user.character.getActiveTokens()),e}static getAdvantageMode(e){return e.advantage?CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE:e.disadvantage?CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE:CONFIG.Dice.D20Roll.ADV_MODE.NORMAL}}b(P,"getClientTargets",()=>{if(!game.user)return[];const e=Array.from(game.user.targets);return c.log("Selected Targets",[game.user.id,e,e.filter(t=>t.actor)]),e}),b(P,"getTargetDescriptors",()=>{var t,s;const e=new Map;for(const a of game.user.targets){const{name:o}=a,{img:l,system:d,uuid:u,statuses:n}=a.actor??{};if(u){const r=n.has("coverTotal")?null:(s=(t=d.attributes)==null?void 0:t.ac)==null?void 0:s.value;e.set(u,{name:o,img:l,uuid:u,ac:r??null})}}return Array.from(e.values())}),b(P,"findItemFromActor",(e,t,s)=>{const a=game.actors.get(e);if(c.log("findItemFromActor",[t,s]),!a)return null;let o=t?a.items.find(l=>l.id===t):null;return o||(o=s?a.items.find(l=>l.name.toLowerCase()===s.toLowerCase()):null,o||(o=a.items.find(l=>l.name.toLowerCase()===(s+" (Legacy)").toLowerCase()))),o}),b(P,"addCSSVars",(e,t)=>{let s=document.querySelector("#crlngn-chat-vars");if(!s){const f=document.querySelector("body");s=document.createElement("style"),s.id="crlngn-chat-vars",s.textContent=`body.crlngn-chat {
}
`,f.prepend(s)}let a=s.textContent,o=a.indexOf("body.crlngn-chat {"),l=a.indexOf("}",o);o===-1&&(a=`body.crlngn-chat {
}
`,o=0,l=a.indexOf("}"));const u=a.substring(o+18,l).split(";").map(f=>f.trim()).filter(f=>f!==""),n={};u.forEach(f=>{const m=f.split(":");if(m.length>=2){const y=m[0].trim(),T=m.slice(1).join(":").trim();y&&(n[y]=T)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),n[e]=t;const r=Object.entries(n).map(([f,m])=>`  ${f}: ${m};`).join(`
`),g=a.substring(0,o)+`body.crlngn-chat {
`+r+`
}`+a.substring(l+1);s.textContent=g});const h=class h{static serializeForTransport(e,t=!1){return e==null||(t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(s=>s instanceof Roll?s.toJSON():s)),c.log("ROLLS DATA",[e,e.subject])),e}static deserializeFromTransport(e,t=!1){let s={...e};if(!e)return s;if(t&&e.rolls&&e.rolls.length>0){const a=s.rolls.map(o=>{let l=o;return typeof o=="string"?l=Roll.fromJSON(o):l=Roll.fromJSON(JSON.stringify(o)),c.log("ROLL",[l,o]),l});return s.rolls=[...a],s}return s}};b(h,"socket"),b(h,"_activeExecutions",new Map),b(h,"initialize",e=>{Hooks.once(Ke.READY,()=>{if(c.log("Attempting to register module..."),typeof socketlib>"u"){c.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("CRLNGN_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{h.socket=socketlib.registerModule(k),e&&e(),c.log("SocketUtil | Module registered",[h.socket])}catch(t){c.log("Problem registering module",[t])}})}),b(h,"registerCall",(e,t)=>{h.socket?(h.socket.register(e,t),c.log("SocketUtil - Registered callback",[h.socket,e])):c.log("SocketUtil - Failed to register callback (socket not initialized)",[h.socket,e])}),b(h,"sendMessage",(e,t)=>{c.log("SocketUtil - sendMessage",[e]),t&&t()}),b(h,"execForGMs",async(e,...t)=>{if(!h.socket){c.log("SocketUtil - Socket not initialized. Cannot execute as GM.");return}return await h.socket.executeForAllGMs(e,...t)}),b(h,"execForAll",async(e,...t)=>{if(!h.socket){c.log("SocketUtil - Socket not initialized. Cannot execute for all clients.");return}return await h.socket.executeForEveryone(e,...t)}),b(h,"execForUser",async(e,t,...s)=>{if(!h.socket){c.log("SocketUtil - Socket not initialized. Cannot execute as user.");return}if(t===game.user.id)return c.log("SocketUtil - Preventing recursive call",[t]),null;const a=`${e}-${t}`;if(h._activeExecutions.has(a))return c.log("SocketUtil - Preventing recursive call",[a]),null;h._activeExecutions.set(a,!0);try{const o=await h.socket.executeAsUser(e,t,...s);return c.log("SocketUtil - Executed as user.",[o]),o}catch(o){return c.log("SocketUtil - Error executing as user",[o]),null}finally{h._activeExecutions.delete(a)}});let F=h;var ie,Ie;const M=class M{static init(){Hooks.on(V.RENDER_CHAT_MESSAGE,j(M,ie,Ie))}static testDamage(e){const{activity:t,config:s,message:a,dialog:o}=e;t.rollDamage()}static rollModifiedAttack(e,t,s){c.log("rollModifiedAttack",[e,t,s,this]);const{activity:a}=M.getDataFromUuid(t.dataset.activityUuid);a.rollAttack({event:e,advantage:t.dataset.advantage==="true",disadvantage:t.dataset.disadvantage==="true",attackMode:t.dataset.attackMode,ammunition:t.dataset.ammunition,situational:t.dataset.situational},{},s)}static getDataFromUuid(e){var l,d,u;const t=e.split("."),s=game.actors.get(t[1]),a=s==null?void 0:s.items.get(t[3]),o=((d=(l=a==null?void 0:a.system)==null?void 0:l.activities)==null?void 0:d.get(t[5]))||((u=a==null?void 0:a.activities)==null?void 0:u.get(t[5]));return{actor:s,item:a,activity:o}}};ie=new WeakSet,Ie=function(e,t,s){var d,u,n;const a=((d=e.flags)==null?void 0:d[k])||((n=(u=s.message)==null?void 0:u.flags)==null?void 0:n[k]);if(c.log("#onRenderChatMessage",[e,t,s,a]),!(a!=null&&a.modifiedActions))return;const o=a.activityUuid;if(!o)return;const{activity:l}=M.getDataFromUuid(o);l&&(c.log("#onRenderChatMessage Activating button listeners",[l,e,t]),l.activateChatListeners(e,t[0]))},Y(M,ie),b(M,"triggerActivity",async e=>{var S,E,D,w;const{activityUuid:t,diceTypes:s,config:a,dialog:o,message:l}=e;c.log("triggerActivity #1",[s,a,o,l,e]),R.playerDiceConfigs[game.user.id];const d=a.situational?Number(a.situational):0,u=t.split("."),n=game.actors.get(u[1]),r=n==null?void 0:n.items.get(u[3]),g=((E=(S=r==null?void 0:r.system)==null?void 0:S.activities)==null?void 0:E.get(u[5]))||((D=r==null?void 0:r.activities)==null?void 0:D.get(u[5])),f=((w=a.hookNames)==null?void 0:w[0])||g.type,m=F.deserializeFromTransport(a,!0);if(c.log("triggerActivity #2",[f,m,e]),!n||!r||!g)return;const y={...m,subject:g,parts:m.parts||[]},T={...o},A={...l,flavor:m.flavor};switch(d&&!y.parts.includes("@situational")&&y.parts.push("@situational"),f){case G.ATTACK.name:{M.useAttack({activity:g,config:y,message:A,dialog:T}),c.log("triggerActivity attack",[y,T,A]);break}case G.DAMAGE.name:{c.log("triggerActivity damage",[g,y,T,A]),M.useDamage({activity:g,config:y,message:A,dialog:T});break}case G.SAVE.name:{c.log("triggerActivity save",[y]),A.create=!0,g.use(y,T,A);break}}c.log("triggerActivity #3",[t,a,e])}),b(M,"useAttack",async e=>{const{activity:t,config:s,message:a,dialog:o}=e,l=await t._usageChatContext(a);t.metadata.usage.actions;const d=l.buttons.find(f=>f.dataset.action==="rollAttack");c.log("useAttack #1",[e]);const u={situational:s.situational,attackMode:s.attackMode,advantage:s.advantage,disadvantage:s.disadvantage,ammunition:s.ammunition};d.dataset={...d==null?void 0:d.dataset,...u,action:"rollAttack",activityUuid:t.uuid||""},t.metadata.usage.actions={...t.metadata.usage.actions,rollAttack:M.rollModifiedAttack};const n=foundry.utils.mergeObject({rollMode:a.rollMode||game.settings.get("core","rollMode"),data:{content:await renderTemplate(t.metadata.usage.chatCard,l),speaker:ChatMessage.getSpeaker({actor:t.actor}),flags:{core:{canPopout:!0},[k]:{modifiedActions:!0,activityType:t.type,activityUuid:t.uuid}}}},a),r=["d20"],g=R.areDiceConfigured(r,game.user.id);o.configure=!g,c.log("useAttack",[t,l,n,e]),await ChatMessage.create(n.data),t.rollAttack(u,o,{create:!0})}),b(M,"useDamage",async e=>{var l,d,u;const{activity:t,config:s,message:a,dialog:o}=e;if(c.log("useDamage #1",[e,s.attackMode]),s.rolls&&s.rolls.length>0){s.rolls[0];const n={event:s.event,situational:s.situational||"",attackMode:s.attackMode,subject:t};c.log("useDamage - Using roll from config",[n]);const g=(((l=t==null?void 0:t.damage)==null?void 0:l.parts)||((u=(d=t==null?void 0:t.rolls)==null?void 0:d[0])==null?void 0:u.parts)||[]).map(m=>"d"+m.denomination),f=R.areDiceConfigured(g,game.user.id);o.configure=!f,c.log("useDamage #2",[n,o]),M.rollDamage({config:n,attackMode:n.attackMode});return}c.log("useDamage - No rolls in config, using direct roll"),t.rollDamage()}),b(M,"rollDamage",async e=>{let{activity:t,attackMode:s,config:a,formulas:o,damageTypes:l,rollType:d,scaling:u}=e;o=(o==null?void 0:o.split("&"))??[],l=(l==null?void 0:l.split("&"))??[];const n={...a,attackMode:s,hookNames:["damage"],rolls:o.map((f,m)=>{var T;const y=((T=l[m])==null?void 0:T.split("|"))??[];return{parts:[f],options:{type:y[0],types:y}}})},r={create:!0,data:{flags:{dnd5e:{messageType:"roll",roll:{type:d},targets:P.getTargetDescriptors()}},flavor:game.i18n.localize(`DND5E.${d==="healing"?"Healing":"Damage"}Roll`),speaker:ChatMessage.implementation.getSpeaker()}},g=await CONFIG.Dice.DamageRoll.build(n,{},r);g!=null&&g.length&&Hooks.callAll("dnd5e.rollDamageV2",g)});let oe=M;var De,Oe;const{MODIFIER_CODES:se,MODIFIER_KEYS:Ye}=((Oe=(De=foundry.helpers)==null?void 0:De.interaction)==null?void 0:Oe.KeyboardManager)??KeyboardManager;se.Alt,se.Control.filter(C=>C.startsWith("Control")),se.Control.filter(C=>!C.startsWith("Control")),se.Shift;const ae={};function Ee(C,{indexOnly:e=!1,fullItem:t=!1}={}){const s=Ue(C),{collection:a,documentId:o}=foundry.utils.parseUuid(s),l=a==null?void 0:a.metadata.id;if(t&&!e)return a==null?void 0:a.getDocument(o);const d=ae[l],u=d instanceof Promise;if(e){const g=a==null?void 0:a.index.get(o);return u?g:(d==null?void 0:d[o])??g}if(u)return d.then(()=>ae[l][o]);if(d)return d[o];if(!a)return;const n=je(),r=a.getIndex({fields:n}).then(g=>{const f=g.reduce((m,y)=>(m[y._id]=y,m),{});return ae[l]=f,f[o]});return ae[l]=r,r}function Ue(C){if(C.startsWith("Compendium."))return C;let e=CONFIG.DND5E.sourcePacks.ITEMS,[t,s,a]=C.split(".");return t&&s&&(e=`${t}.${s}`),a||(a=C),`Compendium.${e}.Item.${a}`}function je(){const C=["system.type.value"];for(const e of Object.values(CONFIG.DND5E.traits))e.subtypes&&C.push(`system.${e.subtypes.keyPath}`);return C}var ce,W;const i=class i{static init(){i.preloadHandlebarsTemplates()}static getPlayerActors(){const e=game.actors.filter((t,s)=>t.type==="character");return e.sort((t,s)=>t.name.localeCompare(s.name)),i.actors.pc=e,e}static getNPCActors(){var s;const e=(s=game.scenes.viewed)==null?void 0:s.tokens.map(a=>a.actor);c.log("getNPCActors",[e]);const t=e.filter((a,o)=>a.type==="npc");return t.sort((a,o)=>a.name.localeCompare(o.name)),i.actors.npc=t,t}static preloadHandlebarsTemplates(){const e=["modules/crlngn-roll-requests/templates/requests-menus.hbs"];return loadTemplates(e)}static injectRollRequestsMenu(){document.querySelector("#chat-controls").insertAdjacentHTML("afterbegin",'<label class="chat-control-icon active" id="crlngn-request-toggle" data-tooltip-direction="RIGHT"><i class="fas fa-bolt"></i></label>');const t=document.querySelector("#crlngn-request-toggle");return R.requestsEnabled,t.addEventListener("click",i.onRequestsToggleClick),t.addEventListener("mouseenter",i.showActorsMenu),t.addEventListener("mouseleave",i.hideActorsMenu),c.log("TEST",[game,CONFIG.DND5E]),t}static async showActorsMenu(e){H();const t=i.getPlayerActors(),s=i.getNPCActors(),a=document.querySelector("#crlngn-actors-menu"),o=document.querySelector("#crlngn-request-toggle"),l=i.selectedTab;a&&a.remove();const d=l==="pc"?t:s;c.log("showActorsMenu",[l,i.selectedActors[l],i.selectedTab]),c.log("NPCs",[i.getNPCActors()]);const u=Object.values(L).map(m=>({id:m.name,name:m.label,selected:!1,rollable:m.subList===null}));i.selectedActors[l].map(m=>m.id);const n=await renderTemplate("modules/crlngn-roll-requests/templates/requests-menus.hbs",{actors:d.map(m=>{var A,S;const y=i.selectedActors[l].some(E=>E.id===m.id);let T=[];return m.type==="character"?T=[{abbrev:"AC",value:m.system.attributes.ac.value},{abbrev:"HP",value:m.system.attributes.hp.value},{abbrev:"DC",value:m.system.attributes.spelldc},{abbrev:"PRC",value:m.system.skills.prc.passive}]:m.type==="npc"&&(T=[{abbrev:"AC",value:m.system.attributes.ac.value||""},{abbrev:"HP",value:m.system.attributes.hp.value||""},{abbrev:"DC",value:m.system.attributes.spelldc||""},{abbrev:"PRC",value:((S=(A=m.system.skills)==null?void 0:A.prc)==null?void 0:S.passive)||""}]),{id:m.id,name:m.name,img:m.img,selected:y,crlngnStats:T}}),selectedTab:i.selectedTab,showNames:!1,requestTypes:u,actorsLocked:i.actorsLocked,requestsEnabled:R.requestsEnabled,selectAllOn:i.selectAllOn,skipDialogs:R.skipDialogs});document.body.insertAdjacentHTML("beforeend",`<div id="crlngn-actors-menu">${n}</div>`),i.actorsMenu=document.querySelector("#crlngn-actors-menu");const r=o.getBoundingClientRect(),g=r.top;r.height;const f=i.actorsMenu;f.addEventListener("mouseleave",i.hideActorsMenu),f.style.zIndex=100,f.style.right="var(--current-sidebar-width, 0px)",f.style.top=`${g}px`,setTimeout(()=>{const m=f.getBoundingClientRect(),y=window.innerHeight;m.bottom>y?(f.style.top="auto",f.classList.add("grow-up")):f.classList.remove("grow-up"),i.addMenuListeners(i.actorsMenu)},0),i.markSelectedActors()}static addMenuListeners(e){const t=e.querySelectorAll(".actor"),s=e.querySelectorAll(".actor .actor-img"),a=e.querySelector("#crlngn-actors-all"),o=e.querySelector("#crlngn-actors-lock"),l=e.querySelector("#crlngn-request-toggle"),d=e.querySelector("#crlngn-skip-dialogs"),u=e.querySelectorAll(".actors-tabs button");i.selectAllCheckbox=a,t.forEach(n=>{n.addEventListener("click",i.onActorToggle),n.addEventListener("contextmenu",i.onActorContext)}),s.forEach(n=>{n.addEventListener("click",i.onActorOpenSheet)}),a.addEventListener("change",i.onAllActorsToggle),o.addEventListener("click",i.onActorLockClick),l.addEventListener("change",i.onRequestsToggleClick),d.addEventListener("change",i.onDialogsToggleClick),u.forEach(n=>{n.addEventListener("click",i.onTabClick)})}static onRequestsToggleClick(e){var d;const t=H(),s=document.querySelector("#crlngn-request-toggle"),a=(d=i.actorsMenu)==null?void 0:d.querySelector("#crlngn-rolls-toggle-requests input[type='checkbox']"),o=e.target.id==="crlngn-request-toggle",l=o?!e.target.classList.contains("active"):a==null?void 0:a.checked;c.log("onRequestsToggleClick",[l,o]),l?(s.classList.add("active"),a&&(a.checked=!0)):(s.classList.remove("active"),a&&(a.checked=!1)),R.requestsEnabled=l,I.set(t.rollRequestsEnabled.tag,l)}static onDialogsToggleClick(e){const t=H(),a=e.target.checked;c.log("onDialogsToggleClick",[a]),R.skipDialogs=a,I.set(t.skipDialogs.tag,a)}static hideActorsMenu(){const e=i.actorsMenu;i.actorsLocked||e&&setTimeout(()=>{e.matches(":hover")||(e.remove(),i.selectedRequestType=null)},750)}static showRequestTypes(){const e=i.actorsMenu.querySelector("ul.request-types");e?(e.classList.add("visible"),e.querySelectorAll("li").forEach(s=>{s._hasClickListener||(s.addEventListener("click",X(i,ce)),s._hasClickListener=!0)})):c.log("Request types menu not found",[])}static hideRequestTypes(){const e=i.actorsMenu.querySelector("ul.request-types");e&&e.classList.remove("visible"),i.hideRollTypes()}static showOptionsForRequestType(e){var d;const t=i.selectedTab,s=i.selectedActors[t],a=Object.values(L).find(u=>u.name===e);if(c.log("showOptionsForRequestType",[s,a,e]),!a)return;if(a.subList===null&&s.length>0){R.sendRollRequest(s[0],{config:{hookNames:[e]},actors:s||[]}),c.log("showOptionsForRequestType - Sending roll request",[s,e]);return}const o=i.actorsMenu.querySelector("ul.roll-types");if(!o)return;o.innerHTML="";const l=CONFIG.DND5E[a.subList];if(c.log("System list for request type",[e,l,CONFIG.DND5E]),!!l){for(const[u,n]of Object.entries(l)){const r=document.createElement("li");if(r.dataset.abbreviation=u,r.dataset.fullKey=n.fullKey||u,r.dataset.label=n.label||"",r.dataset.type=e,a.subList===L.TOOL.subList){const g=CONFIG.DND5E.enrichmentLookup.tools[u],f=g?(d=Ee(g.id,{indexOnly:!0}))==null?void 0:d.name:null;r.dataset.label=f}r.innerHTML=`<i class="icon fas fa-dice-d20"></i>${r.dataset.label}`,r.addEventListener("click",X(i,W)),o.appendChild(r)}o.classList.add("visible")}}static hideRollTypes(){const e=i.actorsMenu.querySelector("ul.roll-types");e&&(e.classList.remove("visible"),e.querySelectorAll(".selected").forEach(t=>t.classList.remove("selected")),i.selectedOptionType=null)}static onActorLockClick(e){const t=e.target;i.actorsLocked=!i.actorsLocked,i.actorsLocked?(t.classList.add("fa-lock-keyhole"),t.classList.remove("fa-lock-keyhole-open")):(t.classList.add("fa-lock-keyhole-open"),t.classList.remove("fa-lock-keyhole"))}static setItemSelection(e,t){e.dataset.selected=t?"true":"false";const s=e.querySelector(".actor-select i");c.log("setItemSelection",[e,t]),t?(e.classList.add("selected"),s.classList.add("fa-circle-dot"),s.classList.remove("fa-circle")):(e.classList.remove("selected"),s.classList.remove("fa-circle-dot")),i.hideRollTypes()}static showOptionsForRequestType(e){var d;const t=i.selectedTab,s=i.selectedActors[t],a=Object.values(L).find(u=>u.name===e);if(c.log("showOptionsForRequestType",[s,a,e]),!a)return;if(a.subList===null&&s.length>0){R.sendRollRequest(s[0],{config:{hookNames:[e]},actors:s||[]}),c.log("showOptionsForRequestType - Sending roll request",[s,e]);return}const o=i.actorsMenu.querySelector("ul.roll-types");if(!o)return;o.innerHTML="";const l=CONFIG.DND5E[a.subList];if(c.log("System list for request type",[e,l,CONFIG.DND5E]),!!l){for(const[u,n]of Object.entries(l)){const r=document.createElement("li");if(r.dataset.abbreviation=u,r.dataset.fullKey=n.fullKey||u,r.dataset.label=n.label||"",r.dataset.type=e,a.subList===L.TOOL.subList){const g=CONFIG.DND5E.enrichmentLookup.tools[u],f=g?(d=Ee(g.id,{indexOnly:!0}))==null?void 0:d.name:null;r.dataset.label=f}r.innerHTML=`<i class="icon fas fa-dice-d20"></i>${r.dataset.label}`,r.addEventListener("click",X(i,W)),o.appendChild(r)}o.classList.add("visible")}}static hideRollTypes(){const e=i.actorsMenu.querySelector("ul.roll-types");e&&(e.classList.remove("visible"),e.querySelectorAll(".selected").forEach(t=>t.classList.remove("selected")),i.selectedOptionType=null)}static onActorLockClick(e){const t=e.target;i.actorsLocked=!i.actorsLocked,i.actorsLocked?(t.classList.add("fa-lock-keyhole"),t.classList.remove("fa-lock-keyhole-open")):(t.classList.add("fa-lock-keyhole-open"),t.classList.remove("fa-lock-keyhole"))}static setItemSelection(e,t){e.dataset.selected=t?"true":"false";const s=e.querySelector(".actor-select i");c.log("setItemSelection",[e,t]),t?(e.classList.add("selected"),s.classList.add("fa-circle-dot"),s.classList.remove("fa-circle")):(e.classList.remove("selected"),s.classList.remove("fa-circle-dot"),s.classList.add("fa-circle"))}static onActorToggle(e){c.log("onActorToggle",[e]);const t=e.target.closest(".actor");if(!t)return;i.setItemSelection(t,t.dataset.selected!="true");const s=i.actorsMenu.querySelectorAll(".actor"),a=Array.from(s).every(n=>n.dataset.selected==="true"),o=Array.from(s).some(n=>n.dataset.selected==="true");i.selectAllCheckbox.checked=a,i.selectAllCheckbox.indeterminate=o&&!a,c.log("onActorToggle - checked states",[a,o]);const d=Array.from(s).filter(n=>n.dataset.selected==="true").map(n=>n.dataset.id),u=i.selectedTab;i.selectedActors[u]=i.actors[u].filter(n=>d.includes(n.id)),i.selectAllOn=a,o?i.showRequestTypes():i.hideRequestTypes(),c.log("onActorToggle - selected actors",[d,i.selectedActors])}static onActorContext(e){const t=e.target.closest(".actor");if(!t)return;const s=i.selectedTab,a=t.dataset.id,l=i.actors[s].find(d=>d.id===a).token;l&&canvas.animatePan({x:l.x,y:l.y,scale:1})}static onActorOpenSheet(e){e.stopPropagation();const t=e.target.closest(".actor");if(!t)return;const s=i.selectedTab,a=t.dataset.id,o=i.actors[s].find(l=>l.id===a);o&&o.sheet.render(!0)}static onAllActorsToggle(e){const t=i.selectedTab,s=e.target.checked,a=i.actorsMenu.querySelectorAll(".actor");i.selectedActors[t]=[],i.selectAllOn=s,a.forEach(o=>{i.setItemSelection(o,s),i.selectedActors[t].push(i.actors[t].find(l=>l.id===o.dataset.id))}),s?i.showRequestTypes():i.hideRequestTypes()}static markSelectedActors(){const e=i.selectedTab,t=i.actorsMenu.querySelectorAll(".actor"),s=i.selectedActors[e].map(a=>a.id);t.forEach(a=>{s.includes(a.dataset.id)?i.setItemSelection(a,!0):i.setItemSelection(a,!1)}),i.selectedActors[e].length>0?i.showRequestTypes():i.hideRequestTypes()}static onTabClick(e){const t=e.target.dataset.tab;if(t===i.selectedTab)return;i.selectedTab=t,e.target.closest(".actors-tabs").querySelectorAll("button").forEach(a=>{a.classList.remove("active")}),e.target.classList.add("active"),i.showActorsMenu(),c.log("Tab changed",[t,i.selectedTab])}};ce=new WeakMap,W=new WeakMap,b(i,"actorsMenu",null),b(i,"actors",{pc:[],npc:[]}),b(i,"selectedActors",{pc:[],npc:[]}),b(i,"selectedRequestType",null),b(i,"selectedOptionType",null),b(i,"selectAllCheckbox",null),b(i,"actorsLocked",!1),b(i,"selectAllOn",!1),b(i,"selectedTab","pc"),Y(i,ce,e=>{const t=i.actorsMenu.querySelector("ul.request-types");t&&(i.hideRollTypes(),t.querySelectorAll(".selected").forEach(s=>{s!==e.target&&s.classList.remove("selected")}),e.target.classList.toggle("selected"),e.target.classList.contains("selected")?(i.selectedRequestType=e.target.dataset.id,i.showOptionsForRequestType(i.selectedRequestType)):(i.selectedRequestType=null,i.hideRollTypes()),c.log("showRequestTypes - item clicked",[e.target.dataset,i.selectedRequestType]))}),Y(i,W,e=>{const t=i.selectedTab,s=i.actorsMenu.querySelector("ul.roll-types");if(!s)return;s.querySelectorAll(".selected").forEach(o=>o.classList.remove("selected")),e.target.classList.add("selected");const a=e.target.dataset.type;i.selectedOptionType={key:e.target.dataset.abbreviation,fullKey:e.target.dataset.fullKey,label:e.target.dataset.label},R.sendRollRequest(i.selectedActors[t][0],{config:{hookNames:[a]},dataset:e.target.dataset,actors:i.selectedActors[t]}),c.log("Selected option",[i.selectedOptionType])});let $=i;var N,qe,Ne,Me,we,Pe,Ve,Ge;const p=class p{static init(){c.log("RequestsUtil.init() - Registering hooks",[],!0),Hooks.on(Z.PRE_ROLL_V2,j(p,N,Ge)),Hooks.on(Z.PRE_USE_ACTIVITY,j(p,N,Pe)),Hooks.on(Z.RENDER_ROLL_CONFIGURATION_DIALOG,j(p,N,Ne)),Hooks.on(Z.POST_ROLL_CONFIG,j(p,N,Me)),Hooks.on(V.RENDER_ROLL_RESOLVER,j(p,N,we)),Hooks.on(V.RENDER_CHAT_MESSAGE,j(p,N,qe))}static registerSocketCalls(){Object.values(p.SOCKET_CALLS).forEach(e=>{e.type===Se.ACTIVITY?F.registerCall(e.action,oe[e.action]):F.registerCall(e.action,p[e.action])})}static sendRollRequest(e,t={config:{},dialog:{configure:!0},message:{},actors:[],activityUuid:null}){var d,u,n,r,g,f,m,y,T,A,S,E,D,w,K,B,U,q,x;p.SOCKET_CALLS.triggerRollRequest.action,P.getPlayerOwner(e.id);const s={actorId:e.id,...t};c.log("sendRollRequest #A",[s]),t.config={...t.config,flags:{...t.config.flags,[k]:{rollRequest:!0,triggerOnRender:!0,type:t.type}}};const a={...s,message:{...t.message},actors:t.actors.map(J=>J.id)};p.forcePublicRoll&&(a.message.rollMode=CONST.DICE_ROLL_MODES.PUBLIC),a.config.tool=((d=s.dataset)==null?void 0:d.type)===L.TOOL.name?(u=s.dataset)==null?void 0:u.abbreviation:"",a.config.skill=((n=s.dataset)==null?void 0:n.type)===L.SKILL.name?(r=s.dataset)==null?void 0:r.abbreviation:"";const o=(g=s.dataset)==null?void 0:g.abbreviation;let l="";((f=s.dataset)==null?void 0:f.type)===L.TOOL.name?l=((T=(y=(m=e.system)==null?void 0:m.tools)==null?void 0:y[o])==null?void 0:T.ability)||((A=CONFIG.DND5E.tools[o])==null?void 0:A.ability):((S=s.dataset)==null?void 0:S.type)===L.SKILL.name?l=((w=(D=(E=e.system)==null?void 0:E.skills)==null?void 0:D[o])==null?void 0:w.ability)||((K=CONFIG.DND5E.skills[o])==null?void 0:K.ability):((B=s.dataset)==null?void 0:B.type)===L.SAVING_THROW.name||((U=a.dataset)==null?void 0:U.type)===L.ABILITY_CHECK.name?l=o:((q=s.dataset)==null?void 0:q.type)===G.ATTACK.name&&(a.rollOptions={actorId:e.id,activityUuid:s.activityUuid,attackMode:"",hookNames:((x=s.config)==null?void 0:x.hookNames)||[]}),a.config.ability=l,a.config.abilityId=l,c.log("sendRollRequest #B",[o,a]),p.triggerRollRequest(a)}static triggerRollRequest(e){var S,E,D,w,K,B,U;let{actorId:t="",config:s={},dialog:a={},message:o={},rollOptions:l=null,actors:d=[]}=e,u=null,n=null;const r=game.actors.get(t);if(c.log("triggerRollRequest #A",[r.name,e]),!r){c.log("triggerRollRequest - actor not found",[t,r]);return}const g=H(),f=I.get(g.useGMTargetTokens.tag),m=P.getTargets(game.user);if((f||m.length===0)&&(l!=null&&l.targetTokens)){(S=canvas.tokens.placeables[0])==null||S.setTarget(!1,{releaseOthers:!0});for(let q of canvas.tokens.placeables)l.targetTokens.includes(q.id)&&q.setTarget(!0,{releaseOthers:!1})}let y={};if(l){y={actorId:t,ability:l.ability,abilityId:l.ability,tool:l.tool,skill:l.skill,advantage:l.advantage||!1,disadvantage:l.disadvantage||!1,situational:l.situational||"",attackMode:l.attackMode||"",target:l.target||null,dc:l.dc||null,type:l.rollType||"",flavor:((E=o==null?void 0:o.data)==null?void 0:E.flavor)||"",hookNames:s.hookNames||[]},s={...y,event:null,rolls:[{parts:[],options:{dc:y.dc||null,rollType:y.rollType||""}}]};const{itemId:q,activityId:x}=l.activityUuid?P.getPartsFromActivityUuid(l.activityUuid):{};u=q?r.items.get(q):null,n=x?(w=(D=u==null?void 0:u.system)==null?void 0:D.activities)==null?void 0:w.get(x):null}a={...a,options:{...a.options,window:{...(K=a.options)==null?void 0:K.window,subtitle:r.name}}},((B=o==null?void 0:o.data)!=null&&B.flavor||s!=null&&s.flavor)&&(a.options.window.title=((U=o==null?void 0:o.data)==null?void 0:U.flavor)||(s==null?void 0:s.flavor));let T=p.getTypeFromHookNames(s.hookNames||[]);o={flags:{[k]:{rollRequest:!0,rollOptions:l,type:T,actors:game.user.isGM?d.filter(q=>q.id!==r.id):[]}}},p.forcePublicRoll&&(o.rollMode=CONST.DICE_ROLL_MODES.PUBLIC);const A=Object.values(L).find(q=>q.name===T);switch(o.flavor=A==null?void 0:A.label,c.log("triggerRollRequest #C",[s,a,o]),!0){case s.hookNames[0].toLowerCase()===L.SKILL.name.toLowerCase():r.rollSkill(s,a,o),T=L.SKILL.name;break;case s.hookNames[0].toLowerCase()===L.TOOL.name.toLowerCase():r.rollToolCheck(s,a,o),T=L.TOOL.name;break;case s.hookNames[0].toLowerCase()===L.ABILITY_CHECK.name.toLowerCase():r.rollAbilityCheck(s,a,o),T=L.ABILITY_CHECK.name;break;case s.hookNames[0].toLowerCase()===L.SAVING_THROW.name.toLowerCase():r.rollSavingThrow(s,a,o),T=L.SAVING_THROW.name;break;case s.hookNames[0].toLowerCase()===L.INITIATIVE.name.toLowerCase():r.rollInitiativeDialog({situational:s.situational||"",advantage:s.advantage,disadvantage:s.disadvantage}),T=L.INITIATIVE.name;break;case s.hookNames[0].toLowerCase()===L.DEATH_SAVE.name.toLowerCase():r.rollDeathSave(s,a,o),T=L.DEATH_SAVE.name;break;case s.hookNames[0].toLowerCase()===L.CONCENTRATION.name.toLowerCase():r.rollConcentration(s,a,o),T=L.CONCENTRATION.name;break;case s.hookNames[0].toLowerCase()===G.DAMAGE.name.toLowerCase():c.log("triggerRollRequest - damage #1",[n,s,a,o]),n&&(s.rolls=[],n.rollDamage(s,a,o));break;case s.hookNames[0].toLowerCase()===G.ATTACK.name.toLowerCase():c.log("triggerRollRequest - attack #1",[n,s,a,o]),n&&(o.flavor="",o.content="",c.log("triggerRollRequest - use",[o]),n.use({},a,o));break;case s.hookNames.includes(G.FORMULA.name):c.log("triggerRollRequest - formula",[s,a,o]);break;default:c.log("triggerRollRequest - default",[s,a,o]);break}}static areDiceConfigured(e,t){const s=p.playerDiceConfigs[t];if(!s)return!1;const a=(e==null?void 0:e.map(l=>(s==null?void 0:s[l])!==""&&(s==null?void 0:s[l])!==void 0&&(s==null?void 0:s[l])!==null))||[],o=a.includes(!0)||!1;return c.log("areDiceConfigured",[a,e,s,o]),o}static allowsDC(e){return e[0].toLowerCase()===G.SKILL.name.toLowerCase()||e[0].toLowerCase()===G.TOOL.name.toLowerCase()||e[0].toLowerCase()===G.SAVING_THROW.name.toLowerCase()||e[0].toLowerCase()===G.ABILITY_CHECK.name.toLowerCase()}static getTypeFromHookNames(e){let t="";return Object.values(L).forEach(s=>{e.includes(s.name)&&(t=s.name)}),t}static addModuleFlags(e,t,s){var o,l,d,u,n,r,g,f;const a={...(l=(o=e.data)==null?void 0:o.flags)==null?void 0:l[k],...(d=e.flags)==null?void 0:d[k]};return(!((u=e.data)!=null&&u.flags)||!((r=(n=e.data)==null?void 0:n.flags)!=null&&r[k]))&&(e.data={...e.data,flags:{...(g=e.data)==null?void 0:g.flags,[k]:a}}),(f=e.data.flags[k].actors)!=null&&f.length||(e.data.flags[k].actors=[s.id]),t.subject instanceof dnd5e.dataModels.activity.BaseActivityData&&(e.data.flags[k].activityUuid=t.subject.uuid,e.data.flags[k].requestType="activity"),c.log("addModuleFlags",[e]),e}};N=new WeakSet,qe=function(e,t){const s=e.getFlag(k,"rollRequest"),a=e.getFlag(k,"type"),o=t[0]||t;c.log("#onRenderChatMessage",[e,t,a]),s&&o.querySelector(`button[data-type=${a}]`).addEventListener("click",d=>{const n=d.currentTarget.dataset,r=game.actors.get(n.actorId);r&&(c.log("onButtonClick",[d,r]),r.rollInitiativeDialog({event:d}))})},Ne=function(e,t){var n,r,g,f,m,y,T;const s=e.config,a=e.message,o=((n=s==null?void 0:s.subject)==null?void 0:n.actor)||(s==null?void 0:s.subject),l=o?P.getPlayerOwner(o.id):null;if(c.log("#onRenderRollConfigurationDialog #1",[l,e,a,p.requestsEnabled]),!(l!=null&&l.active)||!p.requestsEnabled)return;game.user.isGM&&p.addModuleFlags(a,s,o);let d=P.getElement((r=s==null?void 0:s.event)==null?void 0:r.target);const u=d?(g=d.closest(".card-buttons"))==null?void 0:g.querySelector("button[data-action]"):null;if(c.log("#onRenderRollConfigurationDialog #2",[]),p.handleRollDialogInputs(u,e,t),!game.user.isGM||$.selectedTab!=="pc"){const A=t.querySelector("button[autofocus]"),S=s.subject;S&&((f=S.damage)==null||f.parts);const E=((T=(y=(m=s.rolls)==null?void 0:m[0])==null?void 0:y.dice)==null?void 0:T.map(w=>w.denomination))||["d20"],D=p.areDiceConfigured(E,l.id);c.log("#onRenderRollConfigurationDialog #3",[e,s,D,E]),D&&setTimeout(()=>A.click(),500)}c.log("#onRenderRollConfigurationDialog #4",[])},Me=function(e,t,s,a){var f,m,y,T,A,S,E,D,w,K,B,U,q;const o=((m=(f=a.data)==null?void 0:f.flags)==null?void 0:m[k])||((y=a.flags)==null?void 0:y[k])||{},l=(o==null?void 0:o.actors)||[],u=!!((o==null?void 0:o["ddb-game-log"])||((A=(T=a.data)==null?void 0:T.flags)==null?void 0:A["ddb-game-log"])),n=((S=t.subject)==null?void 0:S.actor)||t.subject;c.log("#onPostRollConfiguration #A",[l==null?void 0:l.length,e==null?void 0:e[0],n]),!(l!=null&&l.length)&&n instanceof dnd5e.dataModels.actor.Actor5e&&(l=[n.id]),(D=(E=e==null?void 0:e[0])==null?void 0:E.data)!=null&&D.flags&&(e[0].data.flags={...e[0].data.flags,[k]:{isDdbGl:u}});const r=((K=(w=e==null?void 0:e[0])==null?void 0:w.dice)==null?void 0:K.map(x=>x.denomination))||[];let g=((q=(U=(B=a.data)==null?void 0:B.flags)==null?void 0:U[k])==null?void 0:q.requestType)==="activity"||!1;return c.log("#onPostRollConfiguration #A1",[g,r]),(async()=>{var x,J,ue,ge,fe,me,pe,ye,be,Te,Ce,ke;c.log("#onPostRollConfiguration #A2",[l]);for(let Q=0;Q<l.length;Q++){const z=l[Q].id||l[Q],ne=game.actors.get(z),O=z?P.getPlayerOwner(z):null;if(c.log("#onPostRollConfiguration #B",[u,ne.name,O==null?void 0:O.name,e,t,s,a]),game.user.isGM&&(O!=null&&O.active)&&p.requestsEnabled){const Le=p.SOCKET_CALLS.triggerRollRequest.action;p.areDiceConfigured(["d20"],O.id),s.configure=!0;const ve=t.subject instanceof dnd5e.dataModels.activity.BaseActivityData,Fe=(P.getClientTargets()||[]).map(re=>re.id),he={actorId:z,config:t,dialog:s,message:a,rollOptions:{ability:((J=(x=e[0])==null?void 0:x.data)==null?void 0:J.abilityId)||t.ability,abilityId:((ge=(ue=e[0])==null?void 0:ue.data)==null?void 0:ge.abilityId)||t.ability,tool:t==null?void 0:t.tool,skill:t==null?void 0:t.skill,advantage:((fe=e[0])==null?void 0:fe.hasAdvantage)||!1,disadvantage:((me=e[0])==null?void 0:me.hasDisadvantage)||!1,situational:((ye=(pe=e[0])==null?void 0:pe.data)==null?void 0:ye.situational)||"",target:t.target||t.dc||null,dc:t.dc||t.target||null,rollType:((Te=(be=e[0])==null?void 0:be.options)==null?void 0:Te.rollType)||"",attackMode:((ke=(Ce=e[0])==null?void 0:Ce.options)==null?void 0:ke.attackMode)||t.attackMode||"",diceTypes:r,actorId:z,activityUuid:ve?t.subject.uuid:null,targetTokens:ve?Fe:null,playerOwner:(O==null?void 0:O.id)||""}};ui.notifications.info(`Roll Request sent to ${O.name}`),g=!0,await F.execForUser(Le,O.id,he),c.log("#onPostRollConfiguration - sending to...",[g,Le,O==null?void 0:O.id,he]),await new Promise(re=>setTimeout(re,500))}else g=!1,t.event=null,s={...s,configure:s.configure,window:{...s.window,subtitle:ne.name}},p.triggerRollRequest({actorId:z,config:t,dialog:s}),c.log("#onPostRollConfiguration - rolling for...",[ne,O==null?void 0:O.name,t,s,a])}})(),g?!1:void 0},we=function(e,t){var a,o,l;const s=e.roll;if(c.log("#onRenderRollResolver AAA",[s==null?void 0:s.data,e,t]),(l=(o=(a=s==null?void 0:s.data)==null?void 0:a.flags)==null?void 0:o[k])!=null&&l.isDdbGl)return e.close(),!1},Pe=function(e,t,s,a){var u,n,r,g,f;c.log("#onPreUseActivity #A",[e,t,s,a]);const o=e==null?void 0:e.actor,l=o?P.getPlayerOwner(o.id):null,d=((n=(u=a==null?void 0:a.flags)==null?void 0:u[k])==null?void 0:n.rollRequest)||!1;c.log("#onPreUseActivity #B",[l==null?void 0:l.active,p.requestsEnabled,d]),l!=null&&l.active&&p.requestsEnabled&&!d?(a.create=!1,a.data={...a.data,flags:{...(r=a.data)==null?void 0:r.flags,[k]:{...(f=(g=a.data)==null?void 0:g.flags)==null?void 0:f[k],playerOwner:(l==null?void 0:l.id)||""}}},c.log("#onPreUseActivity #C",[l])):c.log("#onPreUseActivity #D",[l,d])},Ve=function(e,t,s,a){var l,d,u;c.log("#onPostUseActivity",[e.type,Be.SAVE,e,t,s,a]);const o=p.getPlayerOwner(e.actor.id);if(c.log("#onPostUseActivity #2",[o,p.requestsEnabled]),o!=null&&o.active&&p.requestsEnabled){a.create=!1,a.data={...a.data,flags:{...(l=a.data)==null?void 0:l.flags,[k]:{...(u=(d=a.data)==null?void 0:d.flags)==null?void 0:u[k],playerOwner:(o==null?void 0:o.id)||""}}},c.log("#onPostUseActivity #3",[o]);return}},Ge=function(e,t,s){c.log("#onPreRollV2",[e.flags,e,t,s,p.skipDialogs]),(game.user.isGM?p.skipDialogs:!1)&&(t.configure=!1)},Y(p,N),b(p,"forcePublicRoll",!1),b(p,"requestsEnabled",!1),b(p,"skipDialogs",!1),b(p,"SOCKET_CALLS",{triggerRollRequest:{action:"triggerRollRequest",type:Se.CHECK}}),b(p,"diceConfig",{}),b(p,"playerDiceConfigs",{}),b(p,"createRequestMessage",async(e,t,s=!1)=>{var d;c.log("createRequestMessage",[e,t,s]);const a=Object.values(L).find(u=>u.name===t.type);if(!a)return;const o={type:t.type,ability:t.config.ability,abilityId:t.config.ability,skill:t.config.skill,tool:t.config.tool,dc:t.config.target||"",actorId:e.id,action:t.action||"roll",visibility:(d=game.users.find(u=>e===u.character))==null?void 0:d.id,target:e.uuid},l=[];game.user.id,await renderTemplate("systems/dnd5e/templates/chat/request-card.hbs",{buttons:l}),ChatMessage.implementation.getSpeaker({alias:"Roll That For Me"}),`${o.actorId}${o.type}${a==null?void 0:a.label}`,s&&e.id,c.log("createRequestMessage",[chatMessage])}),b(p,"handleRollDialogInputs",async(e,t,s)=>{var r,g,f,m,y,T,A,S;const a=((f=(g=(r=t.message)==null?void 0:r.flags)==null?void 0:g[k])==null?void 0:f.rollOptions)||{};s.querySelector(".formulas.dc");let o=s.querySelector('input[name="dc"]');const l=e?Number((m=e==null?void 0:e.dataset)==null?void 0:m.dc):(a==null?void 0:a.dc)||t.config.dc||void 0;if(o&&(o.value=l),(y=t==null?void 0:t.config)!=null&&y.flavor){const E=s.querySelector(".window-title");E.textContent=t.config.flavor}if(!o){const E=await renderTemplate(`modules/${k}/templates/roll-dc-field.hbs`,{label:game.i18n.localize("CRLNGN_ROLLS.ui.forms.dcFieldLabel"),dc:l});if(p.allowsDC(t.config.hookNames)){const D=s.querySelector(".window-content .rolls .formulas");D==null||D.insertAdjacentHTML("beforebegin",E)}}o=s.querySelector('input[name="dc"]'),game.user.isGM||((T=s.querySelector(".formulas.dc"))==null||T.classList.add("hidden"),o==null||o.setAttribute("hidden",!0)),e&&o&&(o.value=(A=e==null?void 0:e.dataset)==null?void 0:A.dc),o&&(a.dc=Number(o.value),t.config.dc=Number(o.value)),o==null||o.addEventListener("change",()=>{a.dc=Number(o.value),t.config.dc=Number(o.value)||""}),c.log("handleRollDialogInputs",[t.config,a]);const d=`data-${k}-${game.user.id}-custom-event`,u=s.querySelector('input[name="roll.0.situational"]'),n=Number((S=e==null?void 0:e.dataset)==null?void 0:S.situational)||(a==null?void 0:a.situational)||"";!s.hasAttribute(d)&&u&&(s.setAttribute(d,"true"),u.value=n||"",u.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))),s.setAttribute(d,"true")});let R=p;class I{static registerSettings(){const e=H();Object.entries(e).forEach(async s=>{const a=s[1];c.log("Registering... ",[s]);const o={name:a.label,hint:a.hint,default:a.default,type:a.propType,scope:a.scope,config:a.config,requiresReload:a.requiresReload||!1,onChange:l=>I.apply(a.tag,l)};a.choices&&(o.choices=a.choices),await game.settings.register(k,a.tag,o),I.get(a.tag)===void 0&&I.set(a.tag,a.default),c.log("registerSettings",[a.tag,I.get(a.tag)])}),I.applySkipDialogsSetting()}static get(e,t=k){if(!e)return null;let s=!1;if(t===k)s=game.settings.get(t,e);else{let o=game.settings.storage.get("client")[`${t}.${e}`];o===void 0&&(o=game.settings.storage.get("world").getSetting(`${t}.${e}`),s=o==null?void 0:o.value),c.log("GET Setting",[o,s])}return s}static set(e,t,s=k){if(!e)return!1;let a=game.settings.storage.get("client")[`${s}.${e}`];a||(a=game.settings.storage.get("world").getSetting(`${s}.${e}`)),c.log("Setting",[e,a]);try{game.settings.set(s,e,t)}catch{c.log("Unable to change setting",[e,a])}return!0}static apply(e,t){const s=H();switch(e){case s.rollRequestsEnabled.tag:I.applyRollRequestsSetting(t);break;case s.skipDialogs.tag:I.applySkipDialogsSetting(t);break}}static applyRollRequestsSetting(e){const t=H();c.log("applyRollRequestsSetting",[e]);const s=e||I.get(t.rollRequestsEnabled.tag);R.requestsEnabled=s;const a=document.querySelector("#crlngn-request-toggle");if(!a)return;s===!1?a.classList.remove("active"):a.classList.add("active");const o=game.i18n.localize(a.classList.contains("active")?"CRLNGN_ROLLS.ui.buttons.rollRequestsToggleOn":"CRLNGN_ROLLS.ui.buttons.rollRequestsToggleOff");a.dataset.tooltip=o,game.user.isGM&&game.tooltip&&game.tooltip.activate(a,{text:o}),$.hideActorsMenu(),$.showActorsMenu(),c.log("Roll Requests Toggle",[s,a])}static applySkipDialogsSetting(e){const t=H();R.skipDialogs=e||I.get(t.skipDialogs.tag),c.log("applySkipDialogsSetting",[e])}}const v=class v{static init(){F.initialize(v.registerSocketCalls),Hooks.once(V.INIT,()=>{H(),c.log("Initiating module...",[],!0),I.registerSettings(),R.init(),oe.init(),$.init(),v.setDiceConfig()}),Hooks.once(V.READY,()=>{var s,a;c.log("Core Ready",[ui==null?void 0:ui.sidebar,(s=ui==null?void 0:ui.sidebar)==null?void 0:s._collapsed]);const e=H();var t=I.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),game.user.isGM?(Hooks.on(V.USER_CONNECTED,v.onUserConnected),game.users.forEach(o=>{v.onUserConnected(o)}),I.applyRollRequestsSetting(),$.injectRollRequestsMenu(),Hooks.on(V.COLLAPSE_SIDE_BAR,o=>{c.log(V.COLLAPSE_SIDE_BAR,[o._collapsed]),o&&v.checkSideBar(!o._collapsed)}),v.checkSideBar(!((a=ui==null?void 0:ui.sidebar)!=null&&a._collapsed))):v.getDiceConfig()})}static onUserConnected(e){e.active&&e.id!==game.user.id&&(c.log("onUserConnected",[e]),F.execForUser(v.SOCKET_CALLS.getDiceConfig,e.id))}static setDiceConfig(){if(!game.user)return;const e=game.settings.storage.get("client");return v.diceConfig=e["core.diceConfiguration"]||"",c.log("getDiceConfig",[v.diceConfig]),v.diceConfig}static getDiceConfig(){if(game.user)if(v.setDiceConfig(),game.user.isGM){R.playerDiceConfigs[game.user.id]=v.diceConfig,F.execForGMs(v.SOCKET_CALLS.receiveDiceConfig,game.user.id,v.diceConfig);return}else R.playerDiceConfigs[game.user.id]=v.diceConfig?JSON.parse(v.diceConfig):{}}static receiveDiceConfig(e,t){var s;((s=game.user)!=null&&s.isGM||e===game.user.id)&&(R.playerDiceConfigs||(R.playerDiceConfigs={}),R.playerDiceConfigs[e]=t?JSON.parse(t):{},c.log(`Received dice configuration from user ${e}`,[R.playerDiceConfigs]))}static registerSocketCalls(){F.registerCall(v.SOCKET_CALLS.getDiceConfig,v.getDiceConfig),F.registerCall(v.SOCKET_CALLS.receiveDiceConfig,v.receiveDiceConfig),R.registerSocketCalls()}};b(v,"diceConfig",{}),b(v,"SOCKET_CALLS",{receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig"}),b(v,"checkSideBar",e=>{const t=document.querySelector("body");e?t.classList.add("sidebar-expanded"):t.classList.remove("sidebar-expanded")});let de=v;de.init();
//# sourceMappingURL=crlngn-roll-requests.js.map
