var Ie=Object.defineProperty;var fe=u=>{throw TypeError(u)};var Ee=(u,e,t)=>e in u?Ie(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var k=(u,e,t)=>Ee(u,typeof e!="symbol"?e+"":e,t),he=(u,e,t)=>e.has(u)||fe("Cannot "+t);var Q=(u,e,t)=>(he(u,e,"read from private field"),t?t.call(u):e.get(u)),me=(u,e,t)=>e.has(u)?fe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(u):e.set(u,t),Re=(u,e,t,s)=>(he(u,e,"write to private field"),s?s.call(u,t):e.set(u,t),t);const K={checkbox:"checkbox"},J={client:"client",world:"world"},H=()=>({debugMode:{tag:"debug-mode",label:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:J.client,config:!0},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:J.world,config:!0},skipDialogs:{tag:"skip-dialogs",label:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.skipDialogs.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:J.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:K.checkbox,default:!1,scope:J.world,config:!0},rollInterceptionEnabled:{tag:"roll-interception-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:J.world,config:!0},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("CRLNGN_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:K.checkbox,default:!0,scope:J.world,config:!0}}),q="crlngn-roll-requests",oe=["%cFlash Rolls 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],ce={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest"},r={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",ATTACK:"attack",CONCENTRATION:"concentration",CUSTOM:"custom",DEATH_SAVE:"deathsave",FORMULA:"formula",DAMAGE:"damage",HEALING:"healing",HIT_DIE:"hitdie",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",ITEM_SAVE:"itemsave",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool"},Ae={ABILITY_CHECK:{name:r.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:r.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:r.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:r.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:r.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:r.INITIATIVE_DIALOG,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:r.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:r.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:r.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},$={ID:q,ROLL_REQUEST_OPTIONS:Ae},Z={INIT:"init",READY:"ready",RENDER_SIDEBAR_TAB:"renderSidebarTab",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage"},ke={READY:"socketlib.ready"},w={PRE_USE_ACTIVITY:"dnd5e.preUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG_V2:"dnd5e.preRollInitiativeDialogV2",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog",RENDER_SKILL_TOOL_ROLL_DIALOG:"renderSkillToolRollConfigurationDialog"},se=class se{static log(e="",t=[],s=!1){try{const i=game.settings.get(q,"debug-mode")||se.debugOn;if(!(s||i))return;console.log(...oe,e,...t)}catch{(s||se.debugOn)&&console.log(...oe,e,...t)}}static warn(e="",t=[]){console.warn(...oe,e,...t)}static error(e,t={ui:!1,console:!0,permanent:!1}){var s;t.ui&&((s=ui.notifications)==null||s.error(e,{localize:!0,permanent:t.permanent})),t.console&&console.error(...oe,e)}};k(se,"debugOn",!1);let n=se;const O=class O{static serializeForTransport(e,t=!1){return n.log("serializeForTransport",[e,t]),e==null||t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(s=>s instanceof Roll?s.toJSON():s)),e}static deserializeFromTransport(e,t=!1){n.log("deserializeFromTransport",[e,t]);let s={...e};if(!e)return s;if(t&&e.rolls&&e.rolls.length>0){const i=s.rolls.map(o=>{let l=o;return typeof o=="string"?l=Roll.fromJSON(o):l=Roll.fromJSON(JSON.stringify(o)),l});return s.rolls=[...i],s}return s}};k(O,"socket"),k(O,"_activeExecutions",new Map),k(O,"initialize",e=>{n.log("initialize",[e]),Hooks.once(ke.READY,()=>{if(typeof socketlib>"u"){n.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("CRLNGN_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{O.socket=socketlib.registerModule(q),e&&e()}catch{}})}),k(O,"registerCall",(e,t)=>{n.log("registerCall",[e]),O.socket&&O.socket.register(e,t)}),k(O,"sendMessage",(e,t)=>{n.log("sendMessage",[e]),t&&t()}),k(O,"execForGMs",async(e,...t)=>{if(n.log("execForGMs",[e,...t]),!!O.socket)return await O.socket.executeForAllGMs(e,...t)}),k(O,"execForAll",async(e,...t)=>{if(O.socket)return await O.socket.executeForEveryone(e,...t)}),k(O,"execForUser",async(e,t,...s)=>{if(n.log("execForUser",[e,t,...s]),!O.socket)return;if(t===game.user.id)return null;const i=`${e}-${t}`;if(O._activeExecutions.has(i))return null;O._activeExecutions.set(i,!0);try{return await O.socket.executeAsUser(e,t,...s)}catch{return null}finally{O._activeExecutions.delete(i)}});let U=O;class W{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const e=game.settings.storage.get("client");return this.diceConfig=e["core.diceConfiguration"]||"",this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){U.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(e,t){var s,i;((s=game.user)!=null&&s.isGM||e===((i=game.user)==null?void 0:i.id))&&(this.playerDiceConfigs[e]=t?JSON.parse(t):{})}static getUserDiceConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?this.diceConfig:this.playerDiceConfigs[e]||{}}static requestDiceConfigFromUser(e){U.execForUser("getDiceConfig",e)}static requestDiceConfigFromAllPlayers(){var e;(e=game.user)!=null&&e.isGM&&game.users.forEach(t=>{t.active&&!t.isGM&&t.id!==game.user.id&&this.requestDiceConfigFromUser(t.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?!!this.diceConfig:!!this.playerDiceConfigs[e]}}k(W,"diceConfig",{}),k(W,"playerDiceConfigs",{});class A{static registerSettings(){const e=H();Object.entries(e).forEach(async s=>{const i=s[1],o={name:i.label,hint:i.hint,default:i.default,type:i.propType,scope:i.scope,config:i.config,requiresReload:i.requiresReload||!1,onChange:l=>A.apply(i.tag,l)};i.choices&&(o.choices=i.choices),await game.settings.register(q,i.tag,o),(A.get(i.tag)===void 0||A.get(i.tag)===null)&&A.set(i.tag,i.default)})}static get(e,t=q){if(!e)return null;let s=!1;if(t===q)s=game.settings.get(t,e);else{let o=game.settings.storage.get("client")[`${t}.${e}`];o===void 0&&(o=game.settings.storage.get("world").getSetting(`${t}.${e}`),s=o==null?void 0:o.value)}return s}static set(e,t,s=q){if(!e)return!1;let i=game.settings.storage.get("client")[`${s}.${e}`];i||(i=game.settings.storage.get("world").getSetting(`${s}.${e}`));try{game.settings.set(s,e,t)}catch{}return!0}static apply(e,t){const s=H();switch(e){case s.rollRequestsEnabled.tag:A.applyRollRequestsEnabled(t);break}}static applyRollRequestsEnabled(e){const t=document.querySelector("#chat-controls .chat-control-icon.roll-requests-icon");t&&(e?t.classList.add("active"):t.classList.remove("active"))}}class te{static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}static getMidiQOL(){return this.isMidiQOLActive()&&typeof MidiQOL<"u"?MidiQOL:null}}class de{static findActivityForRoll(e,t){var o;if(!((o=e==null?void 0:e.system)!=null&&o.activities))return null;const s=e.system.activities;switch(t==null?void 0:t.toLowerCase()){case r.ATTACK:const l=s.getByType("attack");return(l==null?void 0:l[0])||null;case r.DAMAGE:const a=s.getByType("attack");if((a==null?void 0:a.length)>0)return a[0];const c=s.getByType("damage");if((c==null?void 0:c.length)>0)return c[0];const d=s.getByType("save");return(d==null?void 0:d.length)>0?d[0]:null;case r.ITEM_SAVE:const f=s.getByType("save");return(f==null?void 0:f[0])||null;default:return null}}static getActivitiesByType(e,t){var s;return(s=e==null?void 0:e.system)!=null&&s.activities?e.system.activities.getByType(t):[]}static hasActivityForRoll(e,t){return n.log("hasActivityForRoll",[e,t]),!!this.findActivityForRoll(e,t)}static async executeActivityRoll(e,t,s,i,o){var d,f,g,C,m,h,R,p,_,D;n.log("executeActivityRoll",[e,t,s,i,o]);const l=e.items.get(s);if(!l)throw new Error(`Item ${s} not found on actor ${e.name}`);let a=null;if(i&&(a=(d=l.system.activities)==null?void 0:d.get(i)),a=a||this.findActivityForRoll(l,t),!a)throw new Error(`Activity not found on item ${l.name}`);n.log("executeActivityRoll - activity",[a,t]);const c=t==null?void 0:t.toLowerCase();if(a)switch(c){case r.ATTACK:n.log("executeActivityRoll - is attack activity",[o]);const T={attackMode:o.usage.attackMode,ammunition:o.usage.ammunition,mastery:o.usage.mastery,situational:(C=(g=(f=o.usage.rolls)==null?void 0:f[0])==null?void 0:g.data)==null?void 0:C.situational,advantage:o.usage.advantage,disadvantage:o.usage.disadvantage};await a.item.setFlag(q,"tempAttackConfig",T),n.log("executeActivityRoll - stored temp config as flag",[T]);try{if(te.isModuleActive("midi-qol")&&te.getMidiQOL()){const S=await de.syntheticItemRoll(l,{...o});return}await a.use(o.usage,o.dialog,o.message)}finally{await a.item.unsetFlag(q,"tempAttackConfig")}return;case r.DAMAGE:if(te.isModuleActive("midi-qol")){const L=te.getMidiQOL();if(L){const S=(m=L.Workflow)==null?void 0:m.getWorkflow(a.uuid);await S.activity.rollDamage({...o,workflow:S});return}}n.log("executeActivityRoll - damage roll",[a,o]);const b={critical:o.usage.critical||!1,event:o.usage.event,rollMode:(h=o.message)==null?void 0:h.rollMode,create:((R=o.message)==null?void 0:R.create)!==!1};return(D=(_=(p=o.usage.rolls)==null?void 0:p[0])==null?void 0:_.data)!=null&&D.situational&&(b.data||(b.data={}),b.data.situational=o.usage.rolls[0].data.situational),n.log("executeActivityRoll - damage config with situational",[b]),a!=null&&a.previousAttack||a!=null&&a.damageOnly?await a.rollDamage(b,o.dialog,o.message):await a.rollDamage(b,o.dialog,o.message);case r.ITEM_SAVE:return await l.use({activity:a.id},{skipDialog:o.fastForward});default:n.log("executeActivityRoll - unknown roll type",[c]);return}throw new Error(`No suitable method found for ${c} on item ${l.name}`)}static getActivityDisplayInfo(e){return n.log("getActivityDisplayInfo",[e]),e?{name:e.name||e.constructor.metadata.label,type:e.type,icon:e.constructor.metadata.icon,canAttack:e.type==="attack",canDamage:["attack","damage","save"].includes(e.type),canSave:e.type==="save"}:null}static getDamageFormula(e){var s,i;if(n.log("getDamageFormula",[e]),!((i=(s=e==null?void 0:e.damage)==null?void 0:s.parts)!=null&&i.length))return null;const t=e.damage.parts.map(o=>o.formula).filter(o=>o);return t.length>0?t.join(" + "):null}static async syntheticItemRoll(e,t={}){n.log("syntheticItemRoll",[e,t]);const s=te.getMidiQOL();if(!s){n.warn("MidiQOL is not active");return}let i={consumeUsage:!1,consumeSpellSlot:!1},o={configureDialog:!0,workflowOptions:{autoRollAttack:!1,autoFastAttack:!1,autoRollDamage:"none",autoFastDamage:!1}};return t={...i,...t},await s.completeItemUse(e,t,o)}static async replaceDamage(e,t,{ignoreCrit:s=!1,damageType:i}={}){t=String(t),e.isCritical&&!s&&(t=await rollUtils.getCriticalFormula(t,e.item.getRollData()));let o=await new CONFIG.Dice.DamageRoll(t).evaluate();return await e.setDamageRolls([o]),o}}Hooks.once("ready",()=>{dnd5e.applications.dice.DamageRollConfigurationDialog||n.warn("DamageRollConfigurationDialog not found in dnd5e.applications.dice")});function ie(u){return class extends u{constructor(e={},t={},s={}){var i,o;super(e,t,s),this.actors=s.actors||[],this.sendRequest=s.defaultSendRequest??s.sendRequest??!0,this.showDC=s.showDC||!1,this.dcValue=s.dcValue||null,this.rollKey=s.rollKey||e.skill||e.ability||null,this.rollTypeString=s.rollTypeString||null,this.windowTitle=((i=s.window)==null?void 0:i.title)||"",this.windowSubtitle=((o=s.window)==null?void 0:o.subtitle)||""}_buildConfig(e,t,s){const i=t==null?void 0:t.get("ability"),o=t==null?void 0:t.get("dc"),l=t==null?void 0:t.get(`rolls.${s}.situational`);if(l&&e.situational!==!1)e.parts||(e.parts=[]),e.parts.push("@situational"),e.data||(e.data={}),e.data.situational=l;else if(e.parts){const c=e.parts.indexOf("@situational");c!==-1&&e.parts.splice(c,1)}i&&(e.ability=i,this.config.ability=i);const a=super._buildConfig(e,t,s);if(o){const c=parseInt(o);isNaN(c)||(a.options=a.options||{},a.options.target=c)}else this.dcValue!==void 0&&this.dcValue!==null&&(a.options=a.options||{},a.options.target=this.dcValue);return n.log(`${this.constructor.name}._buildConfig`,[this.config,t,a]),a}_onChangeForm(e,t){super._onChangeForm(e,t);const s=this.element.querySelector('input[name="crlngn-send-request"]');s&&(this.sendRequest=s.checked);const i=this.element.querySelector('input[name="dc"]');i&&i.value&&(this.dcValue=parseInt(i.value)||null)}_finalizeRolls(e){const t=super._finalizeRolls(e);if(this.dcValue!==void 0&&this.dcValue!==null)for(const s of t)s.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,t}async _onRender(e,t){var s,i,o;await super._onRender(e,t),((o=(i=(s=this.config.rolls)==null?void 0:s[0])==null?void 0:i.data)!=null&&o.situational||this.config.situational)&&(n.log(`${this.constructor.name}._onRender`,["Triggering rebuild for initial situational bonus"]),setTimeout(()=>{this.rebuild()},100))}}}class V extends ie(dnd5e.applications.dice.D20RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(e,t,s),n.log("constructor - initializing GM Dialog",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(e,t,s,i){n.log("_prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.showDC=this.showDC,o.dcValue=this.dcValue,o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return n.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(n.log("_onRender",[e,t]),super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const i={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await renderTemplate(`modules/${q}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}this._attachButtonListeners()}_attachButtonListeners(){n.log("_attachButtonListeners",[this.element]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(t=>{t.addEventListener("click",s=>{s.currentTarget.dataset.action})})}static async getConfiguration(e,t,s,i={}){var L,S,E,y,I,F,P;e.length>0&&typeof e[0]=="string"&&(e=e.map(N=>game.actors.get(N)).filter(N=>N)),n.log("GMRollConfigDialog.getConfiguration",[e,e.map(N=>N.name),t,s,i]);const o=t==null?void 0:t.toLowerCase(),l=[r.SAVE,r.SAVING_THROW,r.ABILITY,r.ABILITY_CHECK,r.CONCENTRATION].includes(o),a=e[0];if(!a)return null;let c=CONFIG.Dice.D20Roll;[r.DAMAGE,r.HEALING].includes(o)?c=CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[r.FORMULA,r.CUSTOM,r.HIT_DIE].includes(o)&&(c=CONFIG.Dice.BasicRoll);const d={data:a.getRollData(),subject:a,rolls:[{parts:[],data:a.getRollData(),options:{}}]};switch(o){case r.SKILL:d.skill=s;break;case r.SAVE:case r.SAVING_THROW:d.ability=s;break;case r.ABILITY:case r.ABILITY_CHECK:d.ability=s;break;case r.HIT_DIE:d.rolls[0].parts=[],d.rolls[0].options.flavor="Hit Die";break}const f={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:a})}},g={options:{actors:e,sendRequest:e.some(N=>this._isPlayerOwned(N)),showDC:l,rollKey:s,rollType:c,rollTypeString:o,window:{title:V._getRollTitle(o,s,a),subtitle:V._getSubtitle(e)},...i}},C=new this(d,f,g.options),m=await new Promise(N=>{C.addEventListener("close",()=>{N({rolls:C.rolls,config:C.config,message:C.message,sendRequest:C.sendRequest})},{once:!0}),C.render({force:!0})});if(!m.rolls||m.rolls.length===0)return null;const h=m.rolls[0];let R=!1,p=!1;((L=h==null?void 0:h.options)==null?void 0:L.advantageMode)!==void 0&&(R=h.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,p=h.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);let _=((S=h==null?void 0:h.data)==null?void 0:S.situational)||"";h!=null&&h.parts;let D=(E=h==null?void 0:h.options)==null?void 0:E.target;const T={rolls:[{parts:[],data:_?{situational:_}:{},options:D?{target:D}:{}}],subject:a,advantage:R,disadvantage:p,target:D,sendRequest:m.sendRequest,isRollRequest:m.sendRequest,skipDialog:i.skipDialogs||!1,chatMessage:!0},b=game.settings.get("core","rollMode");if(m.message.rollMode&&m.message.rollMode!==b&&(T.rollMode=m.message.rollMode),m.config.ability&&[r.SKILL,r.TOOL].includes(o)){const N=((I=(y=a.system.skills)==null?void 0:y[s])==null?void 0:I.ability)||((P=(F=CONFIG.DND5E.skills)==null?void 0:F[s])==null?void 0:P.ability);m.config.ability!==N&&(T.ability=m.config.ability)}return T.rollTitle=g.options.window.title,T.rollType=o,T.rollKey=s,T}static _isPlayerOwned(e){return n.log("GMRollConfigDialog._isPlayerOwned",[e]),Object.entries(e.ownership).some(([t,s])=>{const i=game.users.get(t);return i&&!i.isGM&&s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}static _getRollTitle(e,t,s){var l,a,c,d,f,g,C,m,h,R,p,_,D;n.log("GMRollConfigDialog._getRollTitle",[e,t,s]),n.log("GMRollConfigDialog._getRollTitle - Detailed",{rollType:e,rollKey:t,actorName:s==null?void 0:s.name,actorAbilities:(l=s==null?void 0:s.system)!=null&&l.abilities?Object.keys(s.system.abilities):[],actorSkills:(a=s==null?void 0:s.system)!=null&&a.skills?Object.keys(s.system.skills):[],actorInitAbility:(f=(d=(c=s==null?void 0:s.system)==null?void 0:c.attributes)==null?void 0:d.init)==null?void 0:f.ability});let i="";const o=e==null?void 0:e.toLowerCase();switch([r.SAVE,r.ABILITY,r.ABILITY_CHECK].includes(o)&&!t&&n.warn("Missing rollKey for roll type",[o,t]),o){case r.SKILL:const T=((g=CONFIG.DND5E.skills[t])==null?void 0:g.label)||t,b=(C=s==null?void 0:s.system.skills)==null?void 0:C[t],L=(b==null?void 0:b.ability)||((m=CONFIG.DND5E.skills[t])==null?void 0:m.ability)||"int",S=((h=CONFIG.DND5E.abilities[L])==null?void 0:h.label)||L;i=game.i18n.format("DND5E.SkillPromptTitle",{skill:T,ability:S});break;case r.SAVE:case r.SAVING_THROW:const E=((R=CONFIG.DND5E.abilities[t])==null?void 0:R.label)||t;i=game.i18n.format("DND5E.SavePromptTitle",{ability:E});break;case r.ABILITY:case r.ABILITY_CHECK:const y=((p=CONFIG.DND5E.abilities[t])==null?void 0:p.label)||t;i=game.i18n.format("DND5E.AbilityPromptTitle",{ability:y});break;case r.CONCENTRATION:i=game.i18n.localize("DND5E.Concentration");break;case r.TOOL:const I=(D=(_=CONFIG.DND5E.enrichmentLookup)==null?void 0:_.tools)==null?void 0:D[t];let F=t;if(I!=null&&I.id){const P=dnd5e.documents.Trait.getBaseItem(I.id,{indexOnly:!0});F=(P==null?void 0:P.name)||t}i=game.i18n.format("DND5E.ToolPromptTitle",{tool:F});break;case r.DEATH_SAVE:i=game.i18n.localize("DND5E.DeathSave");break;case r.INITIATIVE:case r.INITIATIVE_DIALOG:i=game.i18n.localize("DND5E.Initiative");break;default:i=game.i18n.localize("DND5E.Roll")}return n.log("_getRollTitle",[o,i]),i}static _getSubtitle(e=[]){return e.length===1?e[0].name:e.length>1?game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.multipleActors"):""}}class _e extends ie(dnd5e.applications.dice.RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=CONFIG.Dice.BasicRoll||Roll,s.showDC=!1,super(e,t,s),n.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(e,t,s,i){n.log("_prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.formula="Hit Die (varies by actor)",o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length,t.formula="Hit Die (varies by actor)"),t}async _onRender(e,t){if(super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const i={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await renderTemplate(`modules/${q}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}}async _processSubmitData(e,t,s){await super._processSubmitData(e,t,s),this.sendRequest=s.get("crlngn-send-request")!=="false",n.log("_processSubmitData",[s,this.config])}_finalizeRolls(e){const t=super._finalizeRolls(e);return this.config.sendRequest=this.sendRequest,t}static async getConfiguration(e,t,s,i={}){var D,T,b;n.log("GMRollConfigDialog.getConfiguration",[e,t,s,i]);const o=e[0];if(!o)return null;const l={data:o.getRollData(),subject:o,rolls:[{parts:[],data:o.getRollData(),options:{flavor:"Hit Die Roll"}}]},a={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:o})}},c={options:{actors:e,sendRequest:e.some(L=>V._isPlayerOwned(L)),rollKey:s,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:V._getSubtitle(e)},...i}},d=new this(l,a,c.options),f=await new Promise(L=>{d.addEventListener("close",()=>{L({rolls:d.rolls,config:d.config,message:d.message,sendRequest:d.sendRequest})},{once:!0}),d.render({force:!0})});if(!f.rolls||f.rolls.length===0)return null;const g=f.rolls[0];let C=!1,m=!1;((D=g==null?void 0:g.options)==null?void 0:D.advantageMode)!==void 0&&(C=g.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,m=g.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const h=((T=g==null?void 0:g.data)==null?void 0:T.situational)||"",R=(b=g==null?void 0:g.options)==null?void 0:b.target,p={rolls:[{parts:[],data:h?{situational:h}:{},options:R?{target:R}:{}}],subject:e[0],advantage:C,disadvantage:m,target:R,sendRequest:f.sendRequest,isRollRequest:f.sendRequest,skipDialog:i.skipDialogs||!1,chatMessage:!0},_=game.settings.get("core","rollMode");return f.message.rollMode&&f.message.rollMode!==_&&(p.rollMode=f.message.rollMode),f.config.ability&&(p.ability=f.config.ability),p}}class be extends ie(dnd5e.applications.dice.SkillToolRollConfigurationDialog){constructor(e={},t={},s={}){const i=foundry.utils.mergeObject(e,{chooseAbility:!0});s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(i,t,s),n.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,i){n.log("_prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.showDC=this.showDC,o.dcValue=this.dcValue,o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return n.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(n.log("_onRender",[e,t]),super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const i={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await renderTemplate(`modules/${q}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}this._attachButtonListeners()}_attachButtonListeners(){n.log("_attachButtonListeners",[]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(t=>{t.addEventListener("click",s=>{s.currentTarget.dataset.action})})}static async getConfiguration(e,t,s,i={}){var S,E,y,I,F,P,N,v;n.log("getConfiguration",[e,t,s,i]);const o=t==null?void 0:t.toLowerCase(),l=[r.SKILL,r.TOOL].includes(o),a=e[0];if(!a)return null;const c=CONFIG.Dice.D20Roll;let d=null;if(o===r.SKILL){const B=a.system.skills[s];d=(B==null?void 0:B.ability)||((S=CONFIG.DND5E.skills[s])==null?void 0:S.ability)||"int"}else if(o===r.TOOL){const B=(E=a.system.tools)==null?void 0:E[s];d=(B==null?void 0:B.ability)||((F=(I=(y=CONFIG.DND5E.enrichmentLookup)==null?void 0:y.tools)==null?void 0:I[s])==null?void 0:F.ability)||"int"}const f={data:a.getRollData(),subject:a,ability:d,chooseAbility:!0,rolls:[{parts:[],data:a.getRollData(),options:{}}]};o===r.SKILL?f.skill=s:o===r.TOOL&&(f.tool=s);const g={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:a})}},C={options:{actors:e,sendRequest:e.some(B=>V._isPlayerOwned(B)),showDC:l,rollKey:s,rollType:c,window:{title:V._getRollTitle(o,s,a),subtitle:V._getSubtitle(e)},...i}},m=new this(f,g,C.options),h=await new Promise(B=>{m.addEventListener("close",()=>{B({rolls:m.rolls,config:m.config,message:m.message,sendRequest:m.sendRequest})},{once:!0}),m.render({force:!0})});if(!h.rolls||h.rolls.length===0)return null;const R=h.rolls[0];let p=!1,_=!1;((P=R==null?void 0:R.options)==null?void 0:P.advantageMode)!==void 0&&(p=R.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,_=R.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const D=((N=R==null?void 0:R.data)==null?void 0:N.situational)||"",T=(v=R==null?void 0:R.options)==null?void 0:v.target,b={rolls:[{parts:[],data:D?{situational:D}:{},options:T?{target:T}:{}}],subject:e[0],advantage:p,disadvantage:_,target:T,sendRequest:h.sendRequest,isRollRequest:h.sendRequest,skipDialog:i.skipDialogs||!1,chatMessage:!0},L=game.settings.get("core","rollMode");return h.message.rollMode&&h.message.rollMode!==L&&(b.rollMode=h.message.rollMode),h.config.ability&&[r.SKILL,r.TOOL].includes(o)&&(b.ability=h.config.ability),b.rollTitle=C.options.window.title,b.rollType=o,b.rollKey=s,b}}class Oe extends ie(dnd5e.applications.dice.DamageRollConfigurationDialog){constructor(e={},t={},s={}){const i=foundry.utils.mergeObject({configure:!0},e);super(i,t,s),n.log("GMDamageConfigDialog.constructor",[i,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","damage-roll","gm-roll-config"]})}_prepareConfigurationData(e,t,s,i){n.log("GMDamageConfigDialog._prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _onRender(e,t){if(await super._onRender(e,t),this.actors.length>0){const s=this.element.querySelector(".rolls + .dialog-buttons");if(s&&!this.element.querySelector(".gm-roll-config-fields")){const i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=`
          <div class="form-group">
            <label class="checkbox">
              <input type="checkbox" name="crlngn-send-request" ${this.sendRequest?"checked":""}>
              ${game.i18n.localize("CRLNGN_ROLL_REQUESTS.ui.dialogs.sendRequestToPlayers")}
            </label>
          </div>
        `,s.insertAdjacentElement("beforebegin",i)}}}static async getConfiguration(e,t,s,i={},o={},l={}){var D;n.log("GMDamageConfigDialog.getConfiguration",[e,t,s,i,o,l]);const a=e[0];if(!a)return null;const c=t==null?void 0:t.toLowerCase(),d={subject:o.subject,data:a.getRollData(),critical:o.critical||!1,rolls:o.rolls||[{parts:[],data:a.getRollData(),options:{}}]},f={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:a})}},{position:g,...C}=(l==null?void 0:l.options)||{},m={options:{actors:e,sendRequest:e.some(T=>V._isPlayerOwned(T)),rollKey:s,rollType:CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll,rollTypeString:c,window:{title:game.i18n.localize("DND5E.DamageRoll"),subtitle:V._getSubtitle(e)},...C,...i}},h=new this(d,f,m.options),R=await new Promise(T=>{h.addEventListener("close",()=>{var b;T({rolls:h.rolls,sendRequest:h.sendRequest,advantage:h.config.advantage,disadvantage:h.config.disadvantage,critical:h.config.critical,rollMode:(b=h.message)==null?void 0:b.rollMode})},{once:!0}),h.render(!0)});if(!((D=R.rolls)!=null&&D.length))return n.log("GMDamageConfigDialog.getConfiguration - cancelled"),null;n.log("GMDamageConfigDialog.getConfiguration - result",[R]);const p={rolls:R.rolls,sendRequest:R.sendRequest,critical:R.critical,skipDialog:i.skipDialogs||!1,chatMessage:!0},_=game.settings.get("core","rollMode");return R.rollMode&&R.rollMode!==_&&(p.rollMode=R.rollMode),p.rollTitle=m.options.window.title,p.rollType=c,p.rollKey=s,n.log("GMDamageConfigDialog.getConfiguration - final result",[p]),p}}class Se extends ie(dnd5e.applications.dice.AttackRollConfigurationDialog){constructor(e={},t={},s={}){super(e,t,s),n.log("GMAttackConfigDialog.constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,i){n.log("GMAttackConfigDialog._prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(await super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const i={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await renderTemplate(`modules/${q}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}}_finalizeRolls(e){return this.config.sendRequest=this.sendRequest,!this.sendRequest&&this.config.isRollRequest&&(this.config.isRollRequest=!1),super._finalizeRolls(e)}static async getConfiguration(e,t,s,i={},o={},l={}){var E,y,I,F,P,N;n.log("GMAttackConfigDialog.getConfiguration",[e,t,s,i,o,l]);const a=e[0];if(!a)return null;const c=t==null?void 0:t.toLowerCase(),d={subject:o.subject||a,data:a.getRollData(),rollMode:CONST.DICE_ROLL_MODES.PUBLIC,rolls:[{parts:[],data:a.getRollData(),options:{}}]},f={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:a})}},{position:g,...C}=(l==null?void 0:l.options)||{},m={options:{actors:e,sendRequest:e.some(v=>V._isPlayerOwned(v)),rollKey:s,rollType:CONFIG.Dice.D20Roll,rollTypeString:c,window:{title:game.i18n.localize("DND5E.Attack"),subtitle:V._getSubtitle(e)},...C,...i}},h=new this(d,f,m.options),R=await new Promise(v=>{h.addEventListener("close",()=>{v({rolls:h.rolls,config:h.config,message:h.message,sendRequest:h.sendRequest})},{once:!0}),h.render({force:!0})});if(n.log("GMAttackConfigDialog.getConfiguration",[h.sendRequest]),!R.rolls||R.rolls.length===0)return null;const p=R.rolls[0];let _=!1,D=!1;((E=p==null?void 0:p.options)==null?void 0:E.advantageMode)!==void 0&&(_=p.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,D=p.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const T=((y=p==null?void 0:p.data)==null?void 0:y.situational)||"",b=(I=p==null?void 0:p.options)==null?void 0:I.target,L={rolls:[{parts:[],data:T?{situational:T}:{},options:{...b&&{target:b},...((F=p==null?void 0:p.options)==null?void 0:F.ammunition)&&{ammunition:p.options.ammunition},...((P=p==null?void 0:p.options)==null?void 0:P.attackMode)&&{attackMode:p.options.attackMode},...((N=p==null?void 0:p.options)==null?void 0:N.mastery)!==void 0&&{mastery:p.options.mastery}}}],subject:o.subject||a,advantage:_,disadvantage:D,target:b,sendRequest:R.sendRequest,isRollRequest:R.sendRequest,skipDialog:i.skipDialogs||!1,chatMessage:!0},S=game.settings.get("core","rollMode");return R.message.rollMode&&R.message.rollMode!==S&&(L.rollMode=R.message.rollMode),L.rollTitle=m.options.window.title,L.rollType=c,L.rollKey=s,n.log("GMAttackConfigDialog.getConfiguration - SIMPLIFIED result",[L]),L}}const Y={addSituationalBonus(u,e){var t;return n.log("Config before adding bonus:",[e,!u.rolls,u]),e&&((t=u.rolls)!=null&&t[0])&&(u.rolls[0].parts||(u.rolls[0].parts=[]),u.rolls[0].data||(u.rolls[0].data={}),u.rolls[0].data.situational=e,u.situational=!0,n.log("Config after adding bonus:",[u])),u},buildRollConfig(u,e,t={}){const s={rolls:[{parts:e.parts||[],data:e.data||{},options:e.options||{}}],advantage:u.config.advantage||!1,disadvantage:u.config.disadvantage||!1,target:u.config.target,subject:null,chatMessage:!0,legacy:!1,...t},i=u.config.situational;return i&&this.addSituationalBonus(s,i),this.ensureRollFlags(s,u)},ensureRollFlags(u,e){return{...u,isRollRequest:!game.user.isGM,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM"}}};class ne extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){constructor(e={}){super(e),this.formula=e.formula||"",this.readonly=e.readonly||!1,this.actor=e.actor,this.callback=e.callback,this.diceCounts={}}_onClickAction(e,t){switch(t.dataset.action){case"rollDice":return this.rollDice(e,t);case"addDie":return this.addDie(e,t);case"cancel":return this.cancel(e,t)}}async _prepareContext(e={}){return{...await super._prepareContext(e),formula:this.formula,readonly:this.readonly}}_attachPartListeners(e,t,s){super._attachPartListeners(e,t,s);const i=t.querySelector("#custom-roll-formula"),o=t.querySelector("#formula-validation-message");i&&!this.readonly&&(i.addEventListener("input",l=>{this.formula=l.target.value.trim(),this.updateValidationMessage(o)}),this.formula&&this.updateValidationMessage(o))}updateValidationMessage(e){if(!e)return;if(!this.formula){e.textContent="&nbsp;",e.classList.remove("error","success");return}this.validateFormula(this.formula)?(e.textContent=game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.formulaValid"),e.classList.remove("error"),e.classList.add("success")):(e.textContent=game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.formulaInvalid"),e.classList.remove("success"),e.classList.add("error"))}addDie(e,t){const s=t.dataset.die,i=this.element.querySelector("#custom-roll-formula");if(!i)return;const o=i.value.trim();if(o){const l=/(\d*)d(\d+)/g,a=new Map;let c=o,d;for(;(d=l.exec(o))!==null;){const C=parseInt(d[1]||"1"),m=d[2];a.set(m,(a.get(m)||0)+C),c=c.replace(d[0],"").trim()}const f=s.substring(1);a.set(f,(a.get(f)||0)+1);const g=[];for(const[C,m]of a)g.push(`${m}d${C}`);c=c.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),c&&c!=="+"?this.formula=`${g.join(" + ")} + ${c}`:this.formula=g.join(" + ")}else this.formula=`1${s}`;i.value=this.formula,i.dispatchEvent(new Event("input"))}validateFormula(e){var t;if(!e||e.trim()==="")return!1;try{return Roll.validate(e)}catch{try{return new Roll(e,((t=this.actor)==null?void 0:t.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(n.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("CRLNGN_ROLLS.ui.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback(this.formula),this.close()}cancel(){this.close()}static async prompt(e={}){return new Promise(t=>{const s=new this({...e,callback:i=>t(i)});s.addEventListener("close",()=>{s._resolved||t(null)}),s.render(!0)})}async close(e={}){return this._resolved=!0,super.close(e)}}k(ne,"DEFAULT_OPTIONS",{id:"crlngn-custom-roll-dialog",classes:["crlngn-rolls-dialog","crlngn-custom-roll-dialog"],tag:"div",window:{title:"CRLNGN_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:420,height:"auto"}}),k(ne,"PARTS",{main:{template:`modules/${$.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${$.ID}/templates/custom-roll-dialog-footer.hbs`}});const x={ability:async(u,e,t,s,i)=>{const o=Y.buildRollConfig(e,t,{ability:e.rollKey});await u.rollAbilityCheck(o,s,i)},abilitycheck:async(u,e,t,s,i)=>x.ability(u,e,t,s,i),save:async(u,e,t,s,i)=>{const o=Y.buildRollConfig(e,t,{ability:e.rollKey});await u.rollSavingThrow(o,s,i)},savingthrow:async(u,e,t,s,i)=>x.save(u,e,t,s,i),skill:async(u,e,t,s,i)=>{const o=Y.buildRollConfig(e,t,{skill:e.rollKey,chooseAbility:!0,ability:e.config.ability||void 0});await u.rollSkill(o,s,i)},tool:async(u,e,t,s,i)=>{const o=Y.buildRollConfig(e,t,{tool:e.rollKey,chooseAbility:!0,ability:e.config.ability||void 0});await u.rollToolCheck(o,s,i)},concentration:async(u,e,t,s,i)=>{const o=Y.buildRollConfig(e,t);await u.rollConcentration(o,s,i)},attack:async(u,e,t,s,i)=>{await x.handleActivityRoll(u,r.ATTACK,e,t,s,i)},damage:async(u,e,t,s,i)=>{await x.handleActivityRoll(u,r.DAMAGE,e,t,s,i)},itemsave:async(u,e,t,s,i)=>{await x.handleActivityRoll(u,r.ITEM_SAVE,e,t,s,i)},initiative:async(u,e,t,s,i)=>{if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));return}const o=Y.buildRollConfig(e,t),l=e.config.situational;l&&s.configure&&!game.user.isGM&&(u._initiativeSituationalBonus=l),s.configure&&!game.user.isGM?await u.rollInitiativeDialog(o):await u.rollInitiative({createCombatants:!0},o)},initiativedialog:async(u,e,t,s,i)=>x.initiative(u,e,t,s,i),deathsave:async(u,e,t,s,i)=>{const o=Y.buildRollConfig(e,t);await u.rollDeathSave(o,s,i)},hitdie:async(u,e,t,s,i)=>{s.configure=game.user.isGM?s.configure:!0;const o=Y.buildRollConfig(e,t,{denomination:e.rollKey});await u.rollHitDie(o,s,i)},custom:async(u,e,t,s,i)=>{await x.handleCustomRoll(u,e)},async handleActivityRoll(u,e,t,s,i,o){var l,a,c,d,f,g,C,m,h,R,p,_;if(n.log("RollHandlers.handleActivityRoll",[e,t,s]),t.rollKey){const D=Y.buildRollConfig(t,s),T=((a=(l=D.rolls)==null?void 0:l[0])==null?void 0:a.options)||{},b={usage:{...t.config,rolls:D.rolls,...T.attackMode&&{attackMode:T.attackMode},...T.ammunition&&{ammunition:T.ammunition},...T.mastery!==void 0&&{mastery:T.mastery}},dialog:i,message:o};n.log("handleActivityRoll - final activity config",[b,"situational:",(g=(f=(d=(c=b.usage)==null?void 0:c.rolls)==null?void 0:d[0])==null?void 0:f.data)==null?void 0:g.situational,"roll options:",(h=(m=(C=b.usage)==null?void 0:C.rolls)==null?void 0:m[0])==null?void 0:h.options,"top-level attack options:",{attackMode:(R=b.usage)==null?void 0:R.attackMode,ammunition:(p=b.usage)==null?void 0:p.ammunition,mastery:(_=b.usage)==null?void 0:_.mastery}]),await de.executeActivityRoll(u,e,t.rollKey,t.activityId,b)}},async handleCustomRoll(u,e){const t=e.rollKey;new ne({formula:t,readonly:!0,actor:u,callback:async i=>{try{const o=new Roll(i,u.getRollData());o.options=o.options||{},o.options.isRollRequest=!0,await o.evaluate({async:!0}),await o.toMessage({speaker:ChatMessage.getSpeaker({actor:u}),flavor:game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${r.CUSTOM}`),rollMode:e.config.rollMode,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM"})}catch{ui.notifications.error(game.i18n.format("CRLNGN_ROLLS.ui.notifications.invalidFormula",{formula:i}))}}}).render(!0)},async handleHitDieRecovery(u){const e=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in e&&(e.deltas.hitDice=e.dhd),u._getRestHitDiceRecovery({maxHitDice:u.system.attributes.hd.max,type:"long"},e),e.dhd=e.deltas.hitDice,e.longRest=!0;try{if(e.updateData&&Object.keys(e.updateData).length>0){const t=await u.update(e.updateData,{isRest:!1})}else n.log("No actor updates to perform",[]);if(e.updateItems&&e.updateItems.length>0){const t=await u.updateEmbeddedDocuments("Item",e.updateItems,{isRest:!1})}else n.log("No item updates to perform",[])}catch(t){throw n.error("Error during updates in handleHitDieRecovery:",[t]),t}return n.log("handleHitDieRecovery #3",[e]),e}};class Te{static initialize(){n.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){n.log("RollInterceptor.registerHooks"),this._registerHook(w.PRE_ROLL_ABILITY_CHECK,this._handlePreRoll.bind(this,r.ABILITY)),this._registerHook(w.PRE_ROLL_SAVING_THROW,this._handlePreRoll.bind(this,r.SAVE)),this._registerHook(w.PRE_ROLL_SKILL_V2,this._handlePreRoll.bind(this,r.SKILL)),this._registerHook(w.PRE_ROLL_TOOL_V2,this._handlePreRoll.bind(this,r.TOOL)),this._registerHook(w.PRE_ROLL_ATTACK_V2,this._handlePreRoll.bind(this,r.ATTACK)),this._registerHook(w.PRE_ROLL_DAMAGE_V2,this._handlePreRoll.bind(this,r.DAMAGE)),this._registerHook(w.PRE_ROLL_INITIATIVE,this._handlePreRoll.bind(this,r.INITIATIVE)),this._registerHook(w.PRE_ROLL_INITIATIVE_DIALOG_V2,this._handlePreRoll.bind(this,r.INITIATIVE)),this._registerHook(w.PRE_ROLL_DEATH_SAVE_V2,this._handlePreRoll.bind(this,r.DEATH_SAVE)),this._registerHook(w.PRE_ROLL_HIT_DIE_V2,this._handlePreRoll.bind(this,r.HIT_DIE))}static _registerHook(e,t){n.log("RollInterceptor._registerHook");const s=Hooks.on(e,t);this.registeredHooks.add({hookName:e,hookId:s})}static unregisterHooks(){n.log("RollInterceptor.unregisterHooks");for(const{hookName:e,hookId:t}of this.registeredHooks)Hooks.off(e,t);this.registeredHooks.clear()}static _handlePreRoll(e,t,s,i){var C,m,h,R,p,_,D,T;if(!game.user.isGM||t.isRollRequest===!1)return;const o=(t==null?void 0:t.hookNames)||(s==null?void 0:s.hookNames)||(i==null?void 0:i.hookNames)||[],l=o.includes("initiativeDialog")||o.includes("initiative");if(e===r.ATTACK){n.log("RollInterceptor._handlePreRoll - is Attack roll",[(C=t.subject)==null?void 0:C.item]);const b=(h=(m=t.subject)==null?void 0:m.item)==null?void 0:h.getFlag(q,"tempAttackConfig");if(b){n.log("RollInterceptor._handlePreRoll - found module flags, skipping interception",[b]);return}}if(e===r.DAMAGE){n.log("RollInterceptor._handlePreRoll - is Damage roll",[t]);const b=(p=(R=t.subject)==null?void 0:R.item)==null?void 0:p.getFlag(q,"tempDamageConfig");if(b){n.log("RollInterceptor._handlePreRoll - found module flags, skipping interception",[b]);return}}if(l&&e===r.ABILITY&&(n.log("RollInterceptor._handlePreRoll - Overriding ability to initiative",[o]),e=r.INITIATIVE),t!=null&&t.isRollRequest||s!=null&&s.isRollRequest||i!=null&&i.isRollRequest)return;let a;e===r.INITIATIVE&&t instanceof Actor?a=t:e===r.HIT_DIE?a=((_=s==null?void 0:s.subject)==null?void 0:_.actor)||(s==null?void 0:s.subject)||(s==null?void 0:s.actor):e===r.ATTACK||e===r.DAMAGE?a=(D=t.subject)==null?void 0:D.actor:a=((T=t.subject)==null?void 0:T.actor)||t.subject||t.actor;const c=H(),d=A.get(c.rollInterceptionEnabled.tag),f=A.get(c.rollRequestsEnabled.tag);if(!d||!f||!a||a.documentName!=="Actor")return;n.log("_handlePreRoll",[t,i]);const g=this._getActorOwner(a);if(!(!g||g.id===game.user.id||!g.active||s.configure===!1||t.isRollRequest===!1||t.skipDialog===!0||t.fastForward===!0))return n.log("_handlePreRoll - intercepting roll #1",[t,i]),e===r.ATTACK&&(i={...i,rollMode:CONST.DICE_ROLL_MODES.PUBLIC}),n.log("_handlePreRoll - intercepting roll #2",[t,i]),this._showGMConfigDialog(a,g,e,t,s,i),!1}static async _showGMConfigDialog(e,t,s,i,o,l){var a,c,d,f,g,C,m,h,R,p,_,D,T,b,L,S;n.log("_showGMConfigDialog - config",[s,i]);try{const E=s==null?void 0:s.toLowerCase();let y;[r.SKILL,r.TOOL].includes(E)?y=be:E===r.HIT_DIE?y=_e:E===r.ATTACK?y=Se:E===r.DAMAGE?(c=(a=dnd5e.applications)==null?void 0:a.dice)!=null&&c.DamageRollConfigurationDialog?y=Oe:(n.log("DamageRollConfigurationDialog not found, using GMRollConfigDialog"),y=V):y=V,n.log("_showGMConfigDialog - DialogClass selected",["rollType:",E,"DialogClass:",y,"DialogClass.name:",y==null?void 0:y.name,"DialogClass.getConfiguration:",y==null?void 0:y.getConfiguration,"typeof getConfiguration:",typeof(y==null?void 0:y.getConfiguration),"DamageRollConfigurationDialog exists:",!!((f=(d=dnd5e.applications)==null?void 0:d.dice)!=null&&f.DamageRollConfigurationDialog)]);let I={rolls:[{parts:[],data:{},options:{}}]};switch(E){case r.ABILITY:I.ability=i.ability||((g=i.subject)==null?void 0:g.ability);break;case r.SAVE:I.ability=i.ability||((C=i.subject)==null?void 0:C.ability),i.ability==="con"&&i.targetValue!==void 0&&(s=r.CONCENTRATION);break;case r.SKILL:I.skill=i.skill,I.ability=i.ability;break;case r.TOOL:I.tool=i.tool,I.ability=i.ability;break;case r.CONCENTRATION:I.ability="con";break;case r.INITIATIVE:break;case r.HIT_DIE:I.denomination=typeof i=="string"?i:i.denomination||((m=i.subject)==null?void 0:m.denomination);break;case r.ATTACK:o!=null&&o.options&&(I.ammunition=o.options.ammunition,I.attackMode=o.options.attackMode,I.mastery=o.options.mastery);break;case r.DAMAGE:I.item=(h=i.subject)==null?void 0:h.item,I.subject=i.subject,I.critical=i.critical||!1;break}const F=H(),P=A.get(F.skipDialogs.tag),N={actors:[e],rollType:E,showDC:!0,defaultSendRequest:!0,skipDialogs:P};let v;if(P)v={sendRequest:!0,advantage:!1,disadvantage:!1,situational:"",rollMode:game.settings.get("core","rollMode")};else{let z=null;switch(E){case r.SKILL:z=i.skill;break;case r.TOOL:z=i.tool;break;case r.ABILITY:case r.SAVE:z=i.ability||((R=i.subject)==null?void 0:R.ability);break;case r.CONCENTRATION:z="con";break;case r.INITIATIVE:z=((_=(p=e.system.attributes)==null?void 0:p.init)==null?void 0:_.ability)||"dex";break;case r.HIT_DIE:z=typeof i=="string"?i:i.denomination||((D=i.subject)==null?void 0:D.denomination);break;case r.ATTACK:z=(b=(T=i.subject)==null?void 0:T.item)==null?void 0:b.id;break;case r.DAMAGE:z=(S=(L=i.subject)==null?void 0:L.item)==null?void 0:S.id;break}if(!y.getConfiguration)throw n.error("DialogClass.getConfiguration not found",[y,y.name]),new Error(`DialogClass ${y.name} does not have getConfiguration method`);E===r.ATTACK||E===r.DAMAGE?v=await y.getConfiguration([e],E,z,{skipDialogs:!1,defaultSendRequest:!0},i,o):v=await y.getConfiguration([e],E,z,{skipDialogs:!1,defaultSendRequest:!0})}if(!v){n.log("RollInterceptor._showGMConfigDialog - Dialog cancelled");return}if(!v.sendRequest){await this._executeLocalRoll(e,s,i,v);return}const{event:B,...Le}=i,re={...Le,...v,rolls:v.rolls,requestedBy:game.user.name,...s===r.ATTACK&&{chatMessage:!1}};n.log("_showGMConfigDialog - finalConfig for damage roll",["rollType:",s,"result:",v,"result.rolls:",v.rolls,"finalConfig:",re,"finalConfig.rolls:",re.rolls]),this._sendRollRequest(e,t,s,re)}catch{this._sendRollRequest(e,t,s,i)}}static async _executeLocalRoll(e,t,s,i){var g,C,m,h,R;n.log("RollInterceptor._executeLocalRoll",[e,t,s,i]);const o=t==null?void 0:t.toLowerCase(),l=((g=i.rolls)==null?void 0:g[0])||{},a=((C=l.data)==null?void 0:C.situational)||"",c={rollKey:s.ability||s.skill||s.tool||s.denomination,config:{advantage:i.advantage||s.advantage,disadvantage:i.disadvantage||s.disadvantage,target:i.target||i.dc||s.target,rollMode:i.rollMode||s.rollMode,situational:a,isRollRequest:!1}},d={configure:!1,isRollRequest:!1},f={rollMode:c.config.rollMode,create:!0,isRollRequest:!1};try{const _={[r.SAVE]:"save",[r.SAVING_THROW]:"savingthrow",[r.ABILITY]:"ability",[r.ABILITY_CHECK]:"abilitycheck",[r.SKILL]:"skill",[r.TOOL]:"tool",[r.CONCENTRATION]:"concentration",[r.INITIATIVE]:"initiative",[r.DEATH_SAVE]:"deathsave",[r.HIT_DIE]:"hitdie"}[o],D=x[_];D?((o===r.ATTACK||o===r.DAMAGE)&&(c.rollKey=(h=(m=s.subject)==null?void 0:m.item)==null?void 0:h.id,c.activityId=(R=s.subject)==null?void 0:R.id),await D(e,c,l,d,f)):n.warn(`No handler found for roll type: ${o}`)}catch(p){n.error("RollInterceptor._executeLocalRoll",[p])}}static async _showConfigurationDialog(e,t,s,i,o,l){n.log("RollInterceptor._showConfigurationDialog",[e,t,s,i,o,l]);try{const c={...i,_rollMethod:async C=>(this._sendRollRequest(e,t,s,C),new Roll("1d20").evaluate({async:!1})),configured:!1},d=o.cls,g=await new d(c,o.options).render(!0)}catch{this._sendRollRequest(e,t,s,i)}}static _getActorOwner(e){n.log("_getActorOwner",[e]);const t=e.ownership||{};for(const[s,i]of Object.entries(t))if(i>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.get(s);if(o&&!o.isGM)return o}return null}static _sendRollRequest(e,t,s,i){var g,C,m,h,R,p,_;n.log("_sendRollRequest",[e,t,s,i]),n.log("_sendRollRequest - config.rolls check",["config.rolls:",i.rolls,"config.rolls[0]:",(g=i.rolls)==null?void 0:g[0],"config.rolls[0].data:",(m=(C=i.rolls)==null?void 0:C[0])==null?void 0:m.data,"config.rolls[0].data.situational:",(p=(R=(h=i.rolls)==null?void 0:h[0])==null?void 0:R.data)==null?void 0:p.situational]);const o=H(),l=A.get(o.skipDialogs.tag);let a=s==null?void 0:s.toLowerCase();a===r.INITIATIVE&&(a=r.INITIATIVE_DIALOG);let c=null,d=null;switch(a){case r.ABILITY:case r.SAVE:c=i.ability;break;case r.SKILL:c=i.skill;break;case r.TOOL:c=i.tool;break;case r.ATTACK:case r.DAMAGE:n.log("_sendRollRequest - Attack/Damage roll config",[s,i]),c=(_=i.subject.item)==null?void 0:_.id,d=i.subject.id;break;case r.HIT_DIE:c=typeof i=="string"?i:i.denomination;break;case r.INITIATIVE_DIALOG:case r.INITIATIVE:c=null;break;case r.DEATH_SAVE:c=null;break;default:n.warn(`Unknown roll type: ${s}`);return}const f={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:e.id,rollType:a,rollKey:c,activityId:d,rollProcessConfig:{...i,_requestedBy:game.user.name},skipDialog:l,targetTokenIds:Array.from(game.user.targets).map(D=>D.id),preserveTargets:A.get(o.useGMTargetTokens.tag)};U.execForUser("handleRollRequest",t.id,f),ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestSent",{player:t.name,actor:e.name}))}}k(Te,"registeredHooks",new Set);function Ne(u,e){var i,o,l,a,c;let t=game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${u}`)||u;const s=u==null?void 0:u.toLowerCase();if(e)switch(s){case r.SKILL:t+=` (${((i=CONFIG.DND5E.skills[e])==null?void 0:i.label)||e})`;break;case r.SAVE:t+=` (${((o=CONFIG.DND5E.abilities[e])==null?void 0:o.label)||e})`;break;case r.ABILITY:t+=` (${((l=CONFIG.DND5E.abilities[e])==null?void 0:l.label)||e})`;break;case r.TOOL:const d=(c=(a=CONFIG.DND5E.enrichmentLookup)==null?void 0:a.tools)==null?void 0:c[e];if(d!=null&&d.id){const f=dnd5e.documents.Trait.getBaseItem(d.id,{indexOnly:!0});t+=` (${(f==null?void 0:f.name)||e})`}else t+=` (${e})`;break;case r.CUSTOM:t=`${t}: ${e}`;break}return t}function we(u,e=Ne){if(u.length===0)return;const t={};for(const i of u){const o=`${i.rollType}_${i.rollKey||""}`;t[o]||(t[o]={rollType:i.rollType,rollKey:i.rollKey,actors:[],gm:i.gm}),t[o].actors.push(i.actor)}const s=Object.values(t);if(s.length===1&&s[0].actors.length===1){const i=s[0];ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestReceived",{gm:i.gm,rollType:e(i.rollType,i.rollKey)}))}else{const i=[];for(const o of s){const l=e(o.rollType,o.rollKey),a=o.actors.join(", ");i.push(`${l} (${a})`)}ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsReceivedMultiple",{gm:s[0].gm,requests:i.join("; ")}))}}function ve(u){const e=u.ownership||{};for(const[t,s]of Object.entries(e))if(s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const i=game.users.get(t);if(i&&!i.isGM)return i}return null}function Me(u,e=game.user){if(!(u!=null&&u.length))return;u.map(s=>canvas.tokens.get(s)).filter(s=>s).forEach(s=>s.setTarget(!0,{user:e}))}function ae(u){return u.type!=="character"&&u.type!=="npc"?!1:Object.entries(u.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function pe(u){if(u.type!=="character"&&u.type!=="npc")return!1;const e=game.scenes.active;return e&&e.tokens.some(t=>t.actorId===u.id)}function le(u,e){if(!game.scenes.active)return;const s=canvas.tokens.placeables.filter(i=>{var o;return((o=i.actor)==null?void 0:o.id)===u});for(const i of s)e?i.control({releaseOthers:!1}):i.release()}function Ce(u){return new Promise(e=>setTimeout(e,u))}function qe(){var u;return!((u=ui==null?void 0:ui.sidebar)!=null&&u._collapsed)}function Ge(u){const e=document.querySelector("body");u?e.classList.add("sidebar-expanded"):e.classList.remove("sidebar-expanded")}function He(u,e){var l;const t=[];if(!u||e.size===0)return t;const s=$.ROLL_REQUEST_OPTIONS[u];if(!s||!s.subList)return t;const i=Array.from(e)[0],o=game.actors.get(i);if(s.subList==="tools"){const a=((l=CONFIG.DND5E.enrichmentLookup)==null?void 0:l.tools)||CONFIG.DND5E.tools||{};for(const[c,d]of Object.entries(a)){let f=c;if(d!=null&&d.id){const g=dnd5e.documents.Trait.getBaseItem(d.id,{indexOnly:!0});f=(g==null?void 0:g.name)||c}else f=c.replace(/([A-Z])/g," $1").replace(/^./,g=>g.toUpperCase()).trim();t.push({id:c,name:f,rollable:!0})}t.sort((c,d)=>c.name.localeCompare(d.name))}else if(o&&s.actorPath){const a=foundry.utils.getProperty(o,s.actorPath)||{},c=CONFIG.DND5E[s.subList];for(const[d,f]of Object.entries(a)){let g="";s.subList==="skills"&&(c!=null&&c[d])||s.subList==="abilities"&&(c!=null&&c[d])?g=c[d].label:g=f.label||game.i18n.localize(f.name||d)||d,t.push({id:d,name:g,rollable:!0})}s.subList==="skills"&&t.sort((d,f)=>d.name.localeCompare(f.name))}return t}const M=class M{static notify(e,t,s={}){if(!s.batch){ui.notifications[e](t);return}s.batchData&&(M.pendingNotifications.push(s.batchData),M.notificationTimer&&clearTimeout(M.notificationTimer),M.notificationTimer=setTimeout(()=>{we(M.pendingNotifications),M.pendingNotifications=[],M.notificationTimer=null},M.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(e,t){const s=Object.entries(e);if(s.length!==0)if(s.length===1){const i=Object.values(e)[0],o=i.actors.map(l=>l.name).join(", ");ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsSentSingle",{rollType:t,actors:o,player:i.player.name}))}else{const i=s.map(([o,l])=>{const a=l.actors.map(c=>c.name).join(", ");return`${l.player.name} (${a})`});ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsSentMultiple",{rollType:t,count:s.length,players:i.join("; ")}))}}static clearPending(){M.notificationTimer&&(clearTimeout(M.notificationTimer),M.notificationTimer=null),M.pendingNotifications=[]}};k(M,"pendingNotifications",[]),k(M,"notificationTimer",null),k(M,"NOTIFICATION_BATCH_DELAY",500);let G=M;function Pe(u){var s;const e=[],t=[];for(const i of u){const o=((s=i.system.attributes.hp)==null?void 0:s.value)||0,l=i.system.attributes.death||{},a=l.success||0,c=l.failure||0;o<=0&&a<3&&c<3?e.push(i):t.push(i.name)}return t.length>0&&G.notify("info",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.actorsSkippingDeathSave",{actors:t.join(", ")})),e}function Ve(u){const e=[],t=[];for(const s of u){const i=ve(s);i?e.push({actor:s,owner:i}):t.push(s)}return{pcActors:e,npcActors:t}}async function Fe(){return game.combat?!0:await Dialog.confirm({title:game.i18n.localize("COMBAT.Create"),content:"<p>"+game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.noCombatActive")+"</p>",yes:()=>!0,no:()=>!1,defaultYes:!0,options:{classes:["crlngn-rolls-dialog"]}})?(await(await game.combats.documentClass.create({scene:game.scenes.active.id})).activate(),G.notify("info",game.i18n.localize("CRLNGN_ROLL_REQUESTS.notifications.combatCreated")),!0):!1}async function Be(u,e){if(!e.combat)return u;const t=u.map(o=>e.actors.get(o)).filter(o=>o),s=[],i=new Set;for(const o of t){const l=e.combat.getCombatantByActor(o.id);l&&l.initiative!==null&&(s.push(o.name),i.add(o.id))}if(s.length>0)if(await Dialog.confirm({title:e.i18n.localize("CRLNGN_ROLLS.ui.dialogs.rerollInitiativeTitle"),content:"<p>"+e.i18n.format("CRLNGN_ROLLS.ui.dialogs.rerollInitiative",{actors:s.join(", ")})+"</p>",yes:()=>!0,no:()=>!1,defaultYes:!1,options:{classes:["crlngn-rolls-dialog"]}})){for(const l of i){const a=e.combat.getCombatantByActor(l);a&&await a.update({initiative:null})}return u}else{const l=u.filter(a=>!i.has(a));return l.length===0&&G.notify("info",e.i18n.localize("CRLNGN_ROLL_REQUESTS.notifications.allActorsHaveInitiative")),l}return u}var j;const ee=class ee extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){constructor(t={}){n.log("RollRequestsMenu.constructor");super(t);k(this,"_onClickOutside",t=>{if(n.log("_onClickOutside"),this.isLocked)return;const s=this.element;s&&(t.target.closest(".roll-requests-menu")||s.contains(t.target)||t.target.closest("#crlngn-requests-icon")||t.target.closest(".dialog, .app, .notification")||this.close())});this.selectedActors=new Set,this.currentTab="pc",this.selectedRequestType=null,this.isLocked=!1,this.optionsExpanded=game.user.getFlag($.ID,"menuOptionsExpanded")??!1,this._initializeFromSelectedTokens()}async _prepareContext(t){n.log("_prepareContext");const s=await super._prepareContext(t),i=game.actors.contents,o=[],l=[],a=game.scenes.active;for(const R of i){if(R.type!=="character"&&R.type!=="npc")continue;const p={id:R.id,uuid:R.uuid,name:R.name,img:R.img,selected:this.selectedActors.has(R.id),crlngnStats:this._getActorStats(R)};Object.entries(R.ownership).some(([D,T])=>{const b=game.users.get(D);return b&&!b.isGM&&T>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})?o.push(p):a&&a.tokens.some(T=>T.actorId===R.id)&&l.push(p)}const c=H(),d=A.get(c.rollRequestsEnabled.tag),f=A.get(c.skipDialogs.tag),g=this.currentTab==="pc"?o:l,C=g.length>0&&g.every(R=>this.selectedActors.has(R.id)),m=[];if(this.selectedActors.size>0)for(const[R,p]of Object.entries($.ROLL_REQUEST_OPTIONS))m.push({id:R,name:game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${p.name}`)||p.label,rollable:p.subList==null,hasSubList:!!p.subList,selected:this.selectedRequestType===R});const h=He(this.selectedRequestType,this.selectedActors);return{...s,actors:g,currentTab:this.currentTab,isPCTab:this.currentTab==="pc",isNPCTab:this.currentTab==="npc",selectedTab:this.currentTab,rollRequestsEnabled:d,skipDialogs:f,selectAllOn:C,hasSelectedActors:this.selectedActors.size>0,requestTypes:m,rollTypes:h,showNames:!0,actorsLocked:this.isLocked,optionsExpanded:this.optionsExpanded}}_getActorStats(t){var l,a,c,d,f,g;n.log("_getActorStats");const s=t.system,i=[];(l=s.attributes)!=null&&l.hp&&i.push({abbrev:"HP",value:s.attributes.hp.value}),(a=s.attributes)!=null&&a.ac&&i.push({abbrev:"AC",value:s.attributes.ac.value});const o=(d=(c=s.attributes)==null?void 0:c.spell)==null?void 0:d.dc;return o&&i.push({abbrev:"DC",value:o}),(g=(f=s.skills)==null?void 0:f.prc)!=null&&g.passive&&i.push({abbrev:"PRC",value:s.skills.prc.passive}),i}_onRender(t,s){if(n.log("_onRender"),super._onRender(t,s),this._attachListeners(),this.optionsExpanded){const i=this.element.querySelector(".options-toggle"),o=this.element.querySelector("li.options");i&&i.classList.add("expanded"),o&&o.classList.add("expanded")}setTimeout(()=>{document.addEventListener("click",this._onClickOutside,!0)},100),this._tokenControlHook=Hooks.on("controlToken",this._onTokenControlChange.bind(this))}_onTokenControlChange(t,s){n.log("_onTokenControlChange"),this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{this._initializeFromSelectedTokens(),this.render(),this._tokenUpdateTimeout=null},100)))}_attachListeners(){var l,a,c,d,f;n.log("_attachListeners");const t=this.element;(l=t.querySelector("#crlngn-requests-toggle"))==null||l.addEventListener("change",this._onToggleRollRequests.bind(this)),(a=t.querySelector("#crlngn-skip-dialogs"))==null||a.addEventListener("change",this._onToggleSkipDialogs.bind(this)),(c=t.querySelector("#crlngn-actors-all"))==null||c.addEventListener("change",this._onToggleSelectAll.bind(this)),(d=t.querySelector("#crlngn-actors-lock"))==null||d.addEventListener("click",this._onToggleLock.bind(this)),(f=t.querySelector(".options-toggle"))==null||f.addEventListener("click",this._onToggleOptions.bind(this)),t.querySelectorAll(".actor-tab").forEach(g=>{g.addEventListener("click",this._onTabClick.bind(this))}),t.querySelectorAll(".actor").forEach(g=>{g.addEventListener("click",this._onActorClick.bind(this))}),t.querySelectorAll(".actor-select").forEach(g=>{g.addEventListener("click",this._onActorSelectClick.bind(this))});const i=t.querySelector(".request-types");i&&i.addEventListener("click",g=>{const C=g.target.closest("li");if(C&&C.dataset.id){const m={...g,currentTarget:C};this._onRequestTypeClick(m)}});const o=t.querySelector(".roll-types");o&&o.addEventListener("click",g=>{const C=g.target.closest("li");if(C&&C.dataset.id){const m={...g,currentTarget:C};this._onRollTypeClick(m)}})}async _onToggleRollRequests(t){n.log("_onToggleRollRequests");const s=H(),i=t.target.checked;await A.set(s.rollRequestsEnabled.tag,i),De.updateRollRequestsIcon(i)}async _onToggleSkipDialogs(t){n.log("_onToggleSkipDialogs");const s=H(),i=t.target.checked;await A.set(s.skipDialogs.tag,i)}_onToggleSelectAll(t){n.log("_onToggleSelectAll");const s=t.target.checked;this._ignoreTokenControl=!0,(this.currentTab==="pc"?game.actors.contents.filter(o=>ae(o)):game.actors.contents.filter(o=>!ae(o)&&pe(o))).forEach(o=>{s?(this.selectedActors.add(o.id),le(o.id,!0)):(this.selectedActors.delete(o.id),le(o.id,!1))}),setTimeout(()=>{this._ignoreTokenControl=!1},200),this.render(),this._updateRequestTypesVisibility()}_onToggleLock(t){n.log("_onToggleLock"),t.preventDefault(),this.isLocked=!this.isLocked;const s=t.currentTarget;s.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),s.classList.add(this.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open")}async _onToggleOptions(t){n.log("_onToggleOptions"),t.preventDefault(),this.optionsExpanded=!this.optionsExpanded,await game.user.setFlag($.ID,"menuOptionsExpanded",this.optionsExpanded);const s=t.currentTarget||t.target.closest(".options-toggle");s&&s.classList.toggle("expanded",this.optionsExpanded);const i=this.element.querySelector("li.options");i&&i.classList.toggle("expanded",this.optionsExpanded)}_initializeFromSelectedTokens(){var s;n.log("_initializeFromSelectedTokens");const t=((s=canvas.tokens)==null?void 0:s.controlled)||[];this.selectedActors.clear();for(const i of t)if(i.actor&&(this.selectedActors.add(i.actor.id),this.selectedActors.size===1)){const o=ae(i.actor);this.currentTab=o?"pc":"npc"}}async _onTabClick(t){var i;n.log("_onTabClick");const s=t.currentTarget.dataset.tab;s!==this.currentTab&&(this.selectedActors.clear(),(i=canvas.tokens)==null||i.releaseAll(),this.selectedRequestType=null,this.currentTab=s,await this.render())}_onActorClick(t){if(n.log("_onActorClick"),t.target.closest(".actor-select"))return;const i=t.currentTarget.dataset.id;this._toggleActorSelection(i)}_onActorSelectClick(t){n.log("_onActorSelectClick"),t.stopPropagation();const s=t.currentTarget.dataset.id;this._toggleActorSelection(s)}_toggleActorSelection(t){n.log("_toggleActorSelection"),this._ignoreTokenControl=!0,this.selectedActors.has(t)?(this.selectedActors.delete(t),le(t,!1)):(this.selectedActors.add(t),le(t,!0)),setTimeout(()=>{this._ignoreTokenControl=!1},100),this.render(),this._updateRequestTypesVisibility(),this._updateSelectAllState()}_updateRequestTypesVisibility(){n.log("_updateRequestTypesVisibility"),this.render()}_updateSelectAllState(){n.log("_updateSelectAllState");const t=this.element.querySelector("#crlngn-actors-all"),s=this.currentTab==="pc"?"pc":"npc",i=this.element.querySelectorAll(`.${s}-actors .actor-item input[type="checkbox"]`),o=Array.from(i).filter(l=>l.checked).length;t.checked=o>0&&o===i.length,t.indeterminate=o>0&&o<i.length}async _onRequestTypeClick(t){const s=t.currentTarget,i=s.dataset.id,o=$.ROLL_REQUEST_OPTIONS[i];if(n.log("_onRequestTypeClick",[i,s.dataset,o]),!o){n.error("Unknown request type:",i);return}this.selectedRequestType===i?this.selectedRequestType=null:this.selectedRequestType=i,o.subList?await this.render():this.selectedRequestType&&this._triggerRoll(i,null)}_onRollTypeClick(t){n.log("_onRollTypeClick");const s=t.currentTarget.dataset.id;this._triggerRoll(this.selectedRequestType,s)}_getValidActorIds(t){return t.filter(s=>{const i=game.actors.get(s);if(!i)return!1;const o=ae(i),l=!o&&pe(i);return this.currentTab==="pc"&&o||this.currentTab==="npc"&&l})}async _handleCustomRoll(){return await this._showCustomRollDialog()}async _getRollConfiguration(t,s,i,o,l){const a=H(),c=A.get(a.rollRequestsEnabled.tag);if(!o&&s!==r.CUSTOM){let d;return[r.SKILL,r.TOOL].includes(s)?d=be:s===r.HIT_DIE?d=_e:d=V,await d.getConfiguration(t,s,i,{skipDialogs:o,defaultSendRequest:c})}else{const d={rolls:[{parts:[],data:{},options:{}}],advantage:!1,disadvantage:!1,rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipDialog:!0,sendRequest:c&&l.length>0};return s===r.DEATH_SAVE&&(d.target=10),d}}async _orchestrateRollsForActors(t,s,i,o,l){const a=H(),c=[],d=[];if(n.log("_orchestrateRollsForActors",[{config:t,rollMethodName:o,rollKey:l}]),t.sendRequest){for(const{actor:f,owner:g}of s){if(!g.active){A.get(a.showOfflineNotifications.tag)&&G.notify("info",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.playerOffline",{player:g.name})),d.push(f);continue}await this._sendRollRequestToPlayer(f,g,o,l,t,!0),c.push({actor:f,owner:g}),await Ce(100)}c.length>0&&this._showConsolidatedNotification(c,o,l)}else i.push(...s.map(({actor:f})=>f));if(d.length>0){const f={...t,skipDialog:!0};await this._handleGMRolls(d,o,l,f)}if(i.length>0){const f={...t};f.fastForward=!0,f.skipDialog=!0,await this._handleGMRolls(i,o,l,f)}}async _triggerRoll(t,s){var h;n.log("_triggerRoll",[t,s]);const i=H(),o=Array.from(this.selectedActors),l=A.get(i.skipDialogs.tag),a=this._getValidActorIds(o);let c=a.map(R=>game.actors.get(R)).filter(R=>R);const d=$.ROLL_REQUEST_OPTIONS[t],f=(h=(d==null?void 0:d.name)||t)==null?void 0:h.toLowerCase();switch(f){case r.CUSTOM:if(s=await this._handleCustomRoll(),!s)return;break;case r.INITIATIVE:case r.INITIATIVE_DIALOG:if(!await Fe())return;if(game.combat){const p=await Be(a,game);if(n.log("_triggerRoll filteredActorIds",[p]),!p.length)return;c=p.map(_=>game.actors.get(_)).filter(_=>_)}break;case r.DEATH_SAVE:c=await Pe(c);break}if(!c.length){G.notify("warn","No valid actors selected");return}const{pcActors:g,npcActors:C}=Ve(c),m=await this._getRollConfiguration(c,f,s,l,g);n.log("_triggerRoll config",[m]),m&&(await this._orchestrateRollsForActors(m,g,C,f,s),setTimeout(()=>this.close(),500))}async _sendRollRequestToPlayer(t,s,i,o,l,a=!1){n.log("_sendRollRequestToPlayer #A",[i,o]);const c=H();let d=i==null?void 0:i.toLowerCase();if(d===r.ABILITY_CHECK?d=r.ABILITY:d===r.SAVING_THROW?d=r.SAVE:d===r.INITIATIVE_DIALOG&&(d=r.INITIATIVE),d===r.HIT_DIE){const g=t.system.attributes.hd;if(g.value>0)o=g.largestAvailable;else if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["crlngn-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("CRLNGN_ROLLS.ui.dialogs.hitDie.refillMessage",{actor:t.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){try{n.log("About to call handleHitDieRecovery for",[t.name]);const m=await x.handleHitDieRecovery(t);n.log("handleHitDieRecovery completed",[m])}catch(m){n.error("Error calling handleHitDieRecovery:",[m])}o=t.system.attributes.hd.largestAvailable,n.log("_sendRollRequestToPlayer - Hit Die REFILL",[{hdData:t.system.attributes.hd}]),G.notify("info",game.i18n.format("CRLNGN_ROLLS.ui.dialogs.hitDie.refilled",{actor:t.name})||`Hit dice refilled for ${t.name}`)}else return}n.log("_sendRollRequestToPlayer - Hit Die Debug",[{rollType:d,rollKey:o,actor:t.name}]);const f={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:t.id,rollType:d,rollKey:o,activityId:null,rollProcessConfig:{...l,_requestedBy:game.user.name},skipDialog:!1,targetTokenIds:Array.from(game.user.targets).map(g=>g.id),preserveTargets:A.get(c.useGMTargetTokens.tag)};U.execForUser("handleRollRequest",s.id,f),a||G.notify("info",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestSent",{player:s.name,actor:t.name}))}_showConsolidatedNotification(t,s,i){var c,d,f,g,C;n.log("_showConsolidatedNotification");const o={};for(const{actor:m,owner:h}of t)o[h.id]||(o[h.id]={player:h,actors:[]}),o[h.id].actors.push(m);for(const[m,h]of Object.entries($.ROLL_REQUEST_OPTIONS))if(h.name===s)break;const l=s;let a=game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${l}`)||l;if(i){const m=l.toLowerCase();if(m===r.SKILL)a=`${a} (${((c=CONFIG.DND5E.skills[i])==null?void 0:c.label)||i})`;else if(m===r.SAVING_THROW)a=`${a} (${((d=CONFIG.DND5E.abilities[i])==null?void 0:d.label)||i})`;else if(m===r.ABILITY_CHECK)a=`${a} (${((f=CONFIG.DND5E.abilities[i])==null?void 0:f.label)||i})`;else if(m===r.TOOL){const h=(C=(g=CONFIG.DND5E.enrichmentLookup)==null?void 0:g.tools)==null?void 0:C[i];if(h!=null&&h.id){const R=dnd5e.documents.Trait.getBaseItem(h.id,{indexOnly:!0});a=`${a} (${(R==null?void 0:R.name)||i})`}else a=`${a} (${i})`}else m===r.CUSTOM&&(a=`${a}: ${i}`)}G.notifyRollRequestsSent(o,a)}async _handleGMRolls(t,s,i,o){n.log("_handleGMRolls",[t,s,i,o]);for(const l of t)await this._executeActorRoll(l,s,i,o),await Ce(100)}async _executeActorRoll(t,s,i,o){var l,a,c,d,f;n.log("_executeActorRoll",[s,i,o]);try{const g=s.toLowerCase();let C=i;if(g===r.HIT_DIE){const T=t.system.attributes.hd;if(T){const b=["d6","d8","d10","d12","d20"];for(const L of b)if((((l=T[L])==null?void 0:l.value)||0)>0){C=L;break}}if(!C){n.log("_executeActorRoll - No hit dice available",[t.name]),G.notify("warn",game.i18n.format("DND5E.HitDiceWarn",{name:t.name}));return}}const m=((d=(c=(a=o.rolls)==null?void 0:a[0])==null?void 0:c.data)==null?void 0:d.situational)||"",h={rollKey:C,config:{...o,situational:m,rollMode:o.rollMode||game.settings.get("core","rollMode"),advantage:o.advantage||!1,disadvantage:o.disadvantage||!1,target:o.target}},R={configure:!o.fastForward&&!o.skipDialog},p={rollMode:o.rollMode||game.settings.get("core","rollMode"),create:o.chatMessage!==!1},_=((f=o.rolls)==null?void 0:f[0])||{};n.log("_executeActorRoll - rollConfig",[_,h]);const D=x[g];D?(n.log("_executeActorRoll - handler",[D]),await D(t,h,_,R,p)):G.notify("warn",`Unknown roll type: ${s}`)}catch(g){n.error("executeActorRoll",[g]),G.notify("error",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollError",{actor:t.name}))}}async _onClose(t){n.log("_onClose"),await super._onClose(t),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),this._tokenControlHook&&(Hooks.off("controlToken",this._tokenControlHook),this._tokenControlHook=null),this._tokenUpdateTimeout&&(clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=null)}setPosition(t={}){return n.log("setPosition"),this}async _showCustomRollDialog(){return n.log("_showCustomRollDialog"),ne.prompt({formula:"",readonly:!1})}static toggle(){n.log("RollRequestsMenu.toggle"),Q(this,j)?Q(this,j).rendered?Q(this,j).close():(Q(this,j)._initializeFromSelectedTokens(),Q(this,j).render(!0)):(Re(this,j,new ee),Q(this,j).render(!0))}};j=new WeakMap,me(ee,j,null),k(ee,"DEFAULT_OPTIONS",{id:"crlngn-requests-menu",classes:["roll-requests-menu"],tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:null}),k(ee,"PARTS",{main:{template:`modules/${$.ID}/templates/requests-menus.hbs`}});let ue=ee;class De{static addSidebarControls(e,t,s){if(!game.user.isGM||e.id!=="chat")return;const o=(t[0]||t).querySelector("#chat-controls");if(!o||o.querySelector(".roll-requests-icon"))return;const l=H(),a=A.get(l.rollRequestsEnabled.tag),c=document.createElement("a");c.id="crlngn-requests-icon",c.setAttribute("data-tooltip-direction","RIGHT"),c.className=`chat-control-icon roll-requests-icon${a?" active":""}`,c.title=game.i18n.localize("CRLNGN_ROLLS.ui.menus.rollRequestsTitle"),c.innerHTML=`<i class="fas fa-bolt${a?"":"-slash"}"></i>`;const d=o.querySelector(".chat-control-icon");d?d.parentNode.insertBefore(c,d):o.insertBefore(c,o.firstChild),c.addEventListener("click",()=>{ue.toggle()})}static updateRollRequestsIcon(e){const t=document.querySelector("#crlngn-requests-icon i");t&&(t.className=`fas fa-bolt${e?"":"-slash"}`)}}class ye{static initialize(){Hooks.once(Z.INIT,this._onInit.bind(this)),Hooks.once(Z.READY,this._onReady.bind(this))}static _onInit(){H(),document.body.classList.add("crlngn-rolls"),A.registerSettings(),W.initialize(),this._registerHook(Z.RENDER_SIDEBAR_TAB,this._onRenderSidebarTab.bind(this))}static _onReady(){const e=H();A.get(e.debugMode.tag)&&(CONFIG.debug.hooks=!0),Te.initialize(),this._registerDnd5eHooks(),game.user.isGM?this._registerGMHooks():(W.getDiceConfig(),this._registerPlayerHooks()),Ge(qe())}static _registerDnd5eHooks(){this._registerHook(w.POST_ROLL_CONFIG,this._onPostRollConfig.bind(this)),this._registerHook(Z.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessage.bind(this)),this._registerHook(Z.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageFlavor.bind(this)),this._registerHook(w.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this)),this._registerHook(w.RENDER_SKILL_TOOL_ROLL_DIALOG,this._onRenderSkillToolDialog.bind(this)),this._registerHook(w.PRE_USE_ACTIVITY,this._onPreUseActivity.bind(this))}static _registerGMHooks(){this._registerHook(Z.USER_CONNECTED,this._onUserConnected.bind(this)),game.users.forEach(e=>{this._onUserConnected(e)})}static _registerPlayerHooks(){this._registerHook(w.PRE_ROLL_HIT_DIE_V2,this._onPreRollHitDieV2.bind(this)),this._registerHook(w.PRE_ROLL_INITIATIVE_DIALOG_V2,this._onPreRollInitiativeDialogV2.bind(this)),this._registerHook(w.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderHitDieDialog.bind(this)),this._registerHook(w.PRE_ROLL_ATTACK_V2,this._onPreRollAttackV2.bind(this))}static _onPostRollConfig(e,t,s,i){t._showRequestedBy&&e.length>0&&(i.data=i.data||{},i.data._showRequestedBy=!0,i.data._requestedBy=t._requestedBy)}static _onPreCreateChatMessage(e,t,s,i){var o;if(t._showRequestedBy&&((o=t.rolls)==null?void 0:o.length)>0){const l=t._requestedBy||"GM",a=game.i18n.format("CRLNGN_ROLL_REQUESTS.chat.requestedBy",{gm:l}),c=t.flavor||"";t.flavor=c?`${c} ${a}`:a}}static _onPreCreateChatMessageFlavor(e,t,s,i){var o,l;if(((o=t.rolls)==null?void 0:o.length)>0&&t.rolls[0])try{const a=t.rolls[0];(l=a.options)!=null&&l._customFlavor&&(t.flavor=a.options._customFlavor)}catch{}}static _onRenderRollConfigDialog(e,t,s){if(n.log("_onRenderRollConfigDialog triggered",[e,s]),e._situationalTriggered)return;const i=t.querySelectorAll('input[name*="situational"]');n.log("Found situational inputs:",[i.length]);let o=!1;i.forEach((l,a)=>{var c,d,f,g,C;!l.value&&((g=(f=(d=(c=e.config)==null?void 0:c.rolls)==null?void 0:d[0])==null?void 0:f.data)!=null&&g.situational)&&((C=e.config)!=null&&C.isConcentration)&&(l.value=e.config.rolls[0].data.situational,o=!0),l.value&&!o&&(e._situationalTriggered=!0,o=!0,setTimeout(()=>{var m,h,R;l.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1})),(R=(h=(m=e.config)==null?void 0:m.rolls)==null?void 0:h[0])!=null&&R.data&&delete e.config.rolls[0].data.situational},50))})}static _onUserConnected(e){e.active&&e.id!==game.user.id&&W.requestDiceConfigFromUser(e.id)}static _onRenderSidebarTab(e,t,s){De.addSidebarControls(e,t,s)}static _registerHook(e,t){const s=Hooks.on(e,t);return this.registeredHooks.set(`${e}_${s}`,s),s}static unregisterAll(){this.registeredHooks.forEach((e,t)=>{const s=t.split("_")[0];Hooks.off(s,e)}),this.registeredHooks.clear()}static isRegistered(e){for(const t of this.registeredHooks.keys())if(t.startsWith(`${e}_`))return!0;return!1}static _onPreRollHitDieV2(e,t,s){if(n.log("_onPreRollHitDieV2 triggered",[e,t,s]),e.rolls&&e.rolls.length>1){const i=e.rolls[1];i&&i.data&&i.data.situational&&(e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=i.data.situational,e.rolls.splice(1,1),n.log("Consolidated hit die rolls with situational bonus",e.rolls))}}static _onPreRollInitiativeDialogV2(e,t,s){n.log("_onPreRollInitiativeDialogV2 triggered",[e,t,s]);const i=e.subject;if(i&&i._initiativeSituationalBonus){if(!e.rolls||e.rolls.length===0){const o=i.getInitiativeRollConfig({});e.rolls=o.rolls||[]}e.rolls.length>0&&(e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=i._initiativeSituationalBonus,n.log("Added situational bonus to initiative dialog",[{bonus:i._initiativeSituationalBonus,rolls:e.rolls}]),delete i._initiativeSituationalBonus)}}static _onPreRollAttackV2(e,t,s){var o,l;n.log("_onPreRollAttackV2 triggered",[e,t,s]);const i=(l=(o=e.subject)==null?void 0:o.item)==null?void 0:l.getFlag(q,"tempAttackConfig");if(i){if(n.log("_onPreRollAttackV2 - Found stored request config from flag",[i]),i.isRollRequest===!1||i.skipDialog===!0||i.sendRequest===!1){n.log("_onPreRollAttackV2 - Not a roll request, skipping",[i]);return}i.attackMode&&(e.attackMode=i.attackMode),i.ammunition&&(e.ammunition=i.ammunition),i.mastery!==void 0&&(e.mastery=i.mastery),i.advantage&&(e.advantage=!0),i.disadvantage&&(e.disadvantage=!0),i.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=i.situational),n.log("_onPreRollAttackV2 - Applied stored configuration to attack roll",[e])}}static _onPreUseActivity(e,t,s,i){if(n.log("_onPreUseActivity triggered",[e,t,s,i]),!game.user.isGM)return;e.item.unsetFlag(q,"tempAttackConfig");const o=H();if(!A.get(o.rollRequestsEnabled.tag))return;const a=e.actor;if(!a)return;Object.entries(a.ownership).some(([d,f])=>{const g=game.users.get(d);return g&&!g.isGM&&f>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})&&(n.log("Preventing usage message for player-owned actor",[a.name]),i.create=!1)}static _onRenderSkillToolDialog(e,t,s){var a,c;if(n.log("_onRenderSkillToolDialog triggered",[e]),!((a=e.config)!=null&&a.isRollRequest)||!((c=e.config)!=null&&c.ability))return;const i=t.querySelector('select[name="ability"]');if(!i)return;const o=i.value,l=e.config.ability;o===l&&setTimeout(()=>{const d=new Event("change",{bubbles:!0,cancelable:!0});i.dispatchEvent(d)},50)}static _onRenderHitDieDialog(e,t,s){var c,d,f,g,C;const i=(c=t.querySelector(".window-title"))==null?void 0:c.textContent;if(!i||!i.includes("Hit Die"))return;const o=(d=e.config)==null?void 0:d.subject;if(!o)return;n.log("_onRenderHitDieDialog triggered",[{app:e,actor:o.name,hd:o.system.attributes.hd}]);const l=o.system.attributes.hd,a=[];for(const m of Object.values(o.classes||{})){const h=m.system.hitDice,R=m.system.levels,p=m.system.hitDiceUsed||0,_=R-p;if(_>0){const D=a.find(T=>T.denomination===h);D?(D.available+=_,D.classes.push(m.name)):a.push({denomination:h,available:_,max:R,classes:[m.name]})}}if(a.length>1){const m=t.querySelector(".formulas");if(!m)return;const h=((C=(g=(f=e.config.rolls)==null?void 0:f[0])==null?void 0:g.options)==null?void 0:C.denomination)||l.largestAvailable,R=`
        <div class="form-group">
          <label>${game.i18n.localize("DND5E.HitDice")}</label>
          <select name="hitDieSelector" class="hit-die-selector">
            ${a.map(_=>`
              <option value="${_.denomination}" ${_.denomination===h?"selected":""}>
                ${_.denomination} (${_.available} ${game.i18n.localize("DND5E.available")}) - ${_.classes.join(", ")}
              </option>
            `).join("")}
          </select>
        </div>
      `,p=m.querySelector(".form-group");if(p){p.insertAdjacentHTML("beforebegin",R);const _=t.querySelector(".hit-die-selector");_==null||_.addEventListener("change",async D=>{var S,E,y;const T=D.target.value;(E=(S=e.config.rolls)==null?void 0:S[0])!=null&&E.options&&(e.config.rolls[0].options.denomination=T);const b=o.system.abilities.con.mod,L=`max(0, 1${T} + ${b})`;if((y=e.config.rolls)!=null&&y[0]){e.config.rolls[0].formula=L;const I=new CONFIG.Dice.D20Roll(L,o.getRollData());await I.evaluate({async:!1}),e.config.rolls[0]=I}e.render(!0),n.log("Updated hit die denomination",[{newDenom:T,newFormula:L,conMod:b}])})}}}}k(ye,"registeredHooks",new Map);class ge{static async handleRequest(e){var s;if(n.log("handleRequest",[e]),game.user.isGM)return;const t=game.actors.get(e.actorId);!t||!t.isOwner||(e.preserveTargets&&((s=e.targetTokenIds)==null?void 0:s.length)>0&&game.user.targets.size===0&&Me(e.targetTokenIds),G.notify("info","",{batch:!0,batchData:{actor:t.name,rollType:e.rollType,rollKey:e.rollKey,gm:e.rollProcessConfig._requestedBy||"GM"}}),ge.executePlayerRollRequest(t,e))}static async executePlayerRollRequest(e,t){var s,i,o,l,a;n.log("executePlayerRollRequest",[e,t]),n.log("executePlayerRollRequest - checking rolls",["rollProcessConfig:",t.rollProcessConfig,"rollProcessConfig.rolls:",t.rollProcessConfig.rolls,"rollProcessConfig.rolls[0]:",(s=t.rollProcessConfig.rolls)==null?void 0:s[0],"rollProcessConfig.rolls[0].data:",(o=(i=t.rollProcessConfig.rolls)==null?void 0:i[0])==null?void 0:o.data]);try{const c=(l=t.rollType)==null?void 0:l.toLowerCase(),d=((a=t.rollProcessConfig.rolls)==null?void 0:a[0])||{parts:[],data:{},options:{}},g={configure:!(game.user.isGM?t.skipDialog:!1)},C={rollMode:t.rollProcessConfig.rollMode||game.settings.get("core","rollMode"),create:!0},m={rollKey:t.rollKey,activityId:t.activityId,config:t.rollProcessConfig};n.log("executePlayerRollRequest",[m,d]);const h=x[c];h?await h(e,m,d,g,C):(n.warn(`No handler found for roll type: ${c}`),G.notify("warn",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollError",{actor:e.name||"Unknown Actor"})))}catch(c){n.error("Error executing roll request:",[c]),G.notify("error",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollError",{actor:e.name||"Unknown Actor"}))}}}class X{static init(){U.initialize(X.registerSocketCalls),ye.initialize()}static getDiceConfig(){return W.getDiceConfig()}static receiveDiceConfig(e,t){W.receiveDiceConfig(e,t)}static async handleRollRequest(e){return ge.handleRequest(e)}static registerSocketCalls(){U.registerCall(ce.getDiceConfig,X.getDiceConfig),U.registerCall(ce.receiveDiceConfig,X.receiveDiceConfig),U.registerCall(ce.handleRollRequest,X.handleRollRequest)}}X.init();
//# sourceMappingURL=crlngn-roll-requests.js.map
