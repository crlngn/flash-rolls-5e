var Xe=Object.defineProperty;var De=c=>{throw TypeError(c)};var Je=(c,t,e)=>t in c?Xe(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var M=(c,t,e)=>Je(c,typeof t!="symbol"?t+"":t,e),Te=(c,t,e)=>t.has(c)||De("Cannot "+e);var x=(c,t,e)=>(Te(c,t,"read from private field"),e?e.call(c):t.get(c)),ae=(c,t,e)=>t.has(c)?De("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(c):t.set(c,e),ne=(c,t,e,s)=>(Te(c,t,"write to private field"),s?s.call(c,e):t.set(c,e),e),pe=(c,t,e)=>(Te(c,t,"access private method"),e);const W={select:"select",checkbox:"checkbox"},B={client:"client",world:"world"},D=()=>({generalSettings:{tag:"flash5e-general-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["showMenuOnLoad","rollInterceptionEnabled","useGMTargetTokens","templateAutoTarget","showOfflineNotifications","initiateCombatOnRequest","showOnlyPCsWithToken"],default:{showMenuOnLoad:!1,rollInterceptionEnabled:!0,useGMTargetTokens:!0,templateAutoTarget:1,showOfflineNotifications:!0,initiateCombatOnRequest:!0,showOnlyPCsWithToken:!0},scope:B.world,config:!1,requiresReload:!1},groupRollsSettings:{tag:"flash5e-group-rolls-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["groupRollsMsgEnabled","groupRollResultMode","showGroupDCToPlayers"],default:{groupRollsMsgEnabled:!0,groupRollResultMode:1,showGroupDCToPlayers:!1},scope:B.world,config:!1,requiresReload:!1},showGroupDCToPlayers:{tag:"show-group-dc-to-players",label:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.hint"),propType:Boolean,inputType:W.checkbox,default:!1,scope:B.world,config:!1},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:B.world,config:!0},groupRollsMsgEnabled:{tag:"group-roll-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:B.world,config:!1},groupRollResultMode:{tag:"group-roll-result-mode",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.hint"),propType:Number,inputType:W.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.4")},default:1,scope:B.world,config:!1},consumptionConfigMode:{tag:"consumption-config-mode",label:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.hint"),propType:Number,inputType:W.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.4")},default:4,scope:B.world,config:!0},skipRollDialog:{tag:"skip-roll-dialog",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.hint"),propType:Boolean,inputType:W.checkbox,default:!1,scope:B.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:B.world,config:!1},rollInterceptionEnabled:{tag:"roll-interception-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:B.world,config:!1},publicPlayerRolls:{tag:"public-player-rolls",label:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:B.world,config:!0},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:B.world,config:!1},showRequestNotifications:{tag:"show-request-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:B.world,config:!1},initiateCombatOnRequest:{tag:"initiate-combat-on-request",label:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:B.world,config:!1},showOnlyPCsWithToken:{tag:"show-only-pcs-with-token",label:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.hint"),propType:Boolean,inputType:W.checkbox,default:!0,scope:B.world,config:!1},favoriteActorsList:{tag:"favorite-actors-list",label:game.i18n.localize("FLASH_ROLLS.settings.favoriteActorsList.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.favoriteActorsList.hint"),propType:Array,inputType:W.text,default:[],scope:B.world,config:!1},templateAutoTarget:{tag:"template-auto-target",label:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.hint"),propType:Number,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.all.label"),2:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.notFriendly.label"),3:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.none.label")},inputType:W.select,default:1,scope:B.world,config:!1},debugMode:{tag:"debug-mode-on",label:game.i18n.localize("FLASH_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:W.checkbox,default:!1,scope:B.client,config:!0},showMenuOnLoad:{tag:"show-menu-on-load",label:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.hint"),propType:Boolean,inputType:W.checkbox,default:!1,scope:B.client,config:!0}}),_="flash-rolls-5e",Le=["%cFlash Rolls 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],_e={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest"},Pe={SAVE:"save"},f={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",ATTACK:"attack",CONCENTRATION:"concentration",CUSTOM:"custom",DEATH_SAVE:"deathsave",FORMULA:"formula",DAMAGE:"damage",HEALING:"healing",HIT_DIE:"hitdie",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",ITEM_SAVE:"itemsave",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool"},Ze={ABILITY_CHECK:{name:f.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:f.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:f.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:f.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:f.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:f.INITIATIVE,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:f.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:f.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:f.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},Q={ID:_,ROLL_REQUEST_OPTIONS:Ze},N={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessageHTML",RENDER_CHAT_LOG:"renderChatLog",CHANGE_SIDEBAR_TAB:"changeSidebarTab",RENDER_SIDEBAR:"renderSidebar",UPDATE_SCENE:"updateScene",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",COLLAPSE_SIDE_BAR:"collapseSidebar",REFRESH_MEASURED_TEMPLATE:"refreshMeasuredTemplate",CONTROL_TOKEN:"controlToken",DELETE_TOKEN:"deleteToken",CREATE_TOKEN:"createToken",UPDATE_ACTOR:"updateActor",UPDATE_ITEM:"updateItem",CREATE_ITEM:"createItem",DELETE_ITEM:"deleteItem",UPDATE_SETTING:"updateSetting",GET_ACTOR_CONTEXT_OPTIONS:"getActorContextOptions"},et={READY:"socketlib.ready"},tt={READY:"midi-qol.ready"},U={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG:"dnd5e.preRollInitiativeDialog",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",ROLL_INITIATIVE:"dnd5e.rollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog",RENDER_SKILL_TOOL_ROLL_DIALOG:"renderSkillToolRollConfigurationDialog"},me=class me{static log(t="",e=[],s=!1){try{const o=game.settings.get(_,"debug-mode-on")||me.debugOn;if(!(s||o))return;const l=Array.isArray(e)?e:[e];console.log(...Le,t,...l)}catch{if(s||me.debugOn){const i=Array.isArray(e)?e:[e];console.log(...Le,t,...i)}}}static warn(t="",e=[]){const s=Array.isArray(e)?e:[e];console.warn(...Le,t,...s)}static error(t,e=[],s={ui:!1,console:!0,permanent:!1}){var i;const o=Array.isArray(e)?e:[e];s.ui&&((i=ui.notifications)==null||i.error(t,{localize:!0,permanent:s.permanent})),s.console&&console.error(...Le,t,...o)}};M(me,"debugOn",!1);let r=me;const V=class V{static serializeForTransport(t,e=!1){return r.log("serializeForTransport",[t,e]),t==null||e&&t.rolls&&Array.isArray(t.rolls)&&(t.rolls=t.rolls.map(s=>s instanceof Roll?s.toJSON():s)),t}static deserializeFromTransport(t,e=!1){r.log("deserializeFromTransport",[t,e]);let s={...t};if(!t)return s;if(e&&t.rolls&&t.rolls.length>0){const o=s.rolls.map(i=>{let l=i;return typeof i=="string"?l=Roll.fromJSON(i):l=Roll.fromJSON(JSON.stringify(i)),l});return s.rolls=[...o],s}return s}};M(V,"socket"),M(V,"_activeExecutions",new Map),M(V,"initialize",t=>{r.log("initialize",[t]),Hooks.once(et.READY,()=>{if(typeof socketlib>"u"){r.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{V.socket=socketlib.registerModule(_),t&&t()}catch{}})}),M(V,"registerCall",(t,e)=>{r.log("registerCall",[t]),V.socket&&V.socket.register(t,e)}),M(V,"sendMessage",(t,e)=>{r.log("sendMessage",[t]),e&&e()}),M(V,"execForGMs",async(t,...e)=>{if(r.log("execForGMs",[t,...e]),!!V.socket)return await V.socket.executeForAllGMs(t,...e)}),M(V,"execForAll",async(t,...e)=>{if(V.socket)return await V.socket.executeForEveryone(t,...e)}),M(V,"execForUser",async(t,e,...s)=>{if(r.log("execForUser #0",[t,e,...s]),!V.socket)return;if(r.log("execForUser #1",[e===game.user.id]),e===game.user.id)return null;const o=`${t}-${e}`;if(r.log("execForUser #2",[V._activeExecutions.has(o)]),V._activeExecutions.has(o))return null;V._activeExecutions.set(o,!0);try{const i=await V.socket.executeAsUser(t,e,...s);return r.log("execForUser #3 - response",[i]),i}catch(i){return r.error("execForUser #4 - error",[i]),null}finally{r.log("execForUser #5 - success",[]),V._activeExecutions.delete(o)}});let Z=V;class ue{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const t=game.settings.storage.get("client");return this.diceConfig=t["core.diceConfiguration"]||"",this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){Z.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(t,e){var s,o;((s=game.user)!=null&&s.isGM||t===((o=game.user)==null?void 0:o.id))&&(this.playerDiceConfigs[t]=e?JSON.parse(e):{})}static getUserDiceConfig(t){var e;return t===((e=game.user)==null?void 0:e.id)?this.diceConfig:this.playerDiceConfigs[t]||{}}static requestDiceConfigFromUser(t){Z.execForUser("getDiceConfig",t)}static requestDiceConfigFromAllPlayers(){var t;(t=game.user)!=null&&t.isGM&&game.users.forEach(e=>{e.active&&!e.isGM&&e.id!==game.user.id&&this.requestDiceConfigFromUser(e.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(t){var e;return t===((e=game.user)==null?void 0:e.id)?!!this.diceConfig:!!this.playerDiceConfigs[t]}}M(ue,"diceConfig",{}),M(ue,"playerDiceConfigs",{});var ye,qe;class q{static isModuleOn(t){var s;const e=(s=game.modules)==null?void 0:s.get(t);return!!(e!=null&&e.active)}static html(t,e){return t.querySelector(e)}static getFullWidth(t){return window.getComputedStyle(t).width==="0px"?0:t.offsetWidth}static preventDialogFlicker(t,e=100){t&&(t.style.opacity="0",t.style.transition="opacity 0.15s ease-in",setTimeout(()=>{t&&(t.style.opacity="1")},e))}static addCSSVars(t,e){let s=document.querySelector("#flash5e-vars");if(!s){const g=document.querySelector("body.flash5e");if(!g)return;s=document.createElement("style"),s.id="flash5e-vars",s.textContent=`body.flash5e {
}
`,g.prepend(s)}let o=s.textContent,i=o.indexOf("body.flash5e {"),l=o.indexOf("}",i);i===-1&&(o=`body.flash5e {
}
`,i=0,l=o.indexOf("}"));const n=o.substring(i+14,l).split(";").map(g=>g.trim()).filter(g=>g!==""),u={};n.forEach(g=>{const p=g.split(":");if(p.length>=2){const m=p[0].trim(),b=p.slice(1).join(":").trim();m&&(u[m]=b)}}),t.includes("i18n")&&typeof e=="string"&&!e.startsWith('"')&&!e.startsWith("'")&&!e.match(/^url\(|^rgba?\(|^hsla?\(/)&&(e=`"${e}"`),u[t]=e;const d=Object.entries(u).map(([g,p])=>`  ${g}: ${p};`).join(`
`),h=o.substring(0,i)+`body.flash5e {
`+d+`
}`+o.substring(l+1);s.textContent=h}static getOffsetBottom(t){const e=t.offsetTop,s=t.offsetHeight;return window.innerHeight-(e+s)}static async getAllFonts(){const t=new Set(Object.keys(CONFIG.fontDefinitions)),e=game.settings.get("core","fonts")||{},s=Object.entries(e).map(([l])=>l),o=await this.processStyleSheets();return Array.from(new Set([...t,...s,...o])).filter(l=>!/FontAwesome|Font Awesome|FoundryVTT/.test(l)).map(l=>l.replace(/['"]/g,"").trim()).sort((l,a)=>l.toLowerCase().localeCompare(a.toLowerCase()))||[]}static addCustomCSS(t,e="flash5e-custom-css",s=!0){if(!t)return;let o=document.querySelector("#"+e);o||(o=document.createElement("style"),o.id=e,o.textContent="",document.head.appendChild(o));const i=/@import\s+(?:url\()?\s*['"]?[^'")]+['"]?\s*\)?\s*;/g,l=[];let a=t,n;for(;(n=i.exec(t))!==null;)l.push(n[0]);if(a=t.replace(i,"").trim(),!s){o.textContent=l.join(`
`)+(l.length?`

`:"")+a;return}if(!o.textContent.includes(a)){const u=o.textContent,d=[];let h;for(;(h=i.exec(u))!==null;)d.push(h[0]);const g=u.replace(i,"").trim(),p=l.filter(b=>!d.includes(b)),m=[...d,...p];o.textContent=m.join(`
`)+(m.length?`

`:"")+g+(g&&a?`

`:"")+a}}static smoothScrollTo(t,e,s="horizontal",o=300,i=null){const l=t.dataset.scrollAnimationId;l&&cancelAnimationFrame(Number(l));const a=s==="horizontal",n=a?t.scrollLeft:t.scrollTop,u=e-n;if(u===0)return i&&i(),null;const d=performance.now(),h=p=>{const m=p-d;if(m>=o){a?t.scrollLeft=e:t.scrollTop=e,delete t.dataset.scrollAnimationId,i&&i();return}const b=m/o,S=b<.5?2*b*b:1-Math.pow(-2*b+2,2)/2;a?t.scrollLeft=n+u*S:t.scrollTop=n+u*S;const y=requestAnimationFrame(h);return t.dataset.scrollAnimationId=y,y},g=requestAnimationFrame(h);return t.dataset.scrollAnimationId=g,g}static confirmReload(t=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredTitle"),e=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredLabel"),s={}){const o={window:{title:t},position:{width:420,height:"auto"},content:e,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.reloadButton"),callback:()=>(r.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(o,s),foundry.applications.api.DialogV2.confirm(o)}static renderTemplate(t,e){return foundry.applications.handlebars.renderTemplate(t,e)}static loadTemplate(t){return foundry.applications.handlebars.loadTemplate(t)}static loadTemplates(t){return Array.isArray(t)||(t=[t]),foundry.applications.handlebars.loadTemplates(t)}static isValidCSSRule(t){if(!t||typeof t!="string")return!1;const e=t.trim();if(!e)return!1;try{const s=document.createElement("style"),o=`${e} { color: inherit; }`;s.textContent=o,document.head.appendChild(s);const i=!!(s.sheet&&s.sheet.cssRules&&s.sheet.cssRules.length>0);return document.head.removeChild(s),i}catch(s){return r.log("CSS validation error:",[s,t]),!1}}static processCSSRules(t,e){if(!t||!e)return"";const s=pe(this,ye,qe).call(this,t),o=e+` {
`+s.baseProperties.join(`
`)+`
}`,i=[],l=new Map;return s.nestedRules.forEach(a=>{const{selector:n,content:u}=a;if(n.startsWith("&")){const g=n.substring(1),p=e.split(",").map(m=>m.trim()).filter(Boolean).map(m=>m+g).join(", ");i.push(`${p} {
${u}
}`);return}l.has(u)||l.set(u,[]);const d=n.split(",").map(g=>g.trim()),h=e.split(",").map(g=>g.trim()).filter(Boolean);d.forEach(g=>{h.forEach(p=>{l.get(u).push(`${p} ${g}`)})})}),l.forEach((a,n)=>{i.push(`${a.join(", ")} {
${n}
}`)}),o+`

`+i.join(`

`)}static getActorOwner(t){const e=t.ownership||{};for(const[s,o]of Object.entries(e))if(o>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const i=game.users.get(s);if(i&&!i.isGM)return i}if((e==null?void 0:e.default)>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const s=game.users.filter(o=>!o.isGM)[0];if(s)return s}return null}static confirmReload(t=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredTitle"),e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredLabel"),s={}){const o={window:{title:t},position:{width:420,height:"auto"},content:e,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.reloadButton"),callback:()=>(r.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(o,s),foundry.applications.api.DialogV2.confirm(o)}}ye=new WeakSet,qe=function(t){const e=[],s=[],o=t.split(`
`);let i=null,l=0;for(let a=0;a<o.length;a++){const n=o[a].trim();if(!n)continue;const u=(n.match(/{/g)||[]).length,d=(n.match(/}/g)||[]).length;if(n.includes("{")&&!i){i={selector:n.substring(0,n.indexOf("{")).trim(),content:"",startLine:a},l=1;const g=n.substring(n.indexOf("{")+1).trim();g&&!g.includes("}")&&(i.content+=g+`
`)}else i?(l+=u-d,l>0?i.content+=n+`
`:(i.content=i.content.replace(/}\s*$/,"").trim(),s.push(i),i=null)):!n.includes("{")&&!n.includes("}")&&e.push(n)}return{baseProperties:e,nestedRules:s}},ae(q,ye),M(q,"wrapFontName",t=>{const e=t.replace(/['"`]/g,"");return e.includes(" ")?`"${e}"`:e});const{FormDataExtended:Lt}=foundry.utils,{ApplicationV2:st,HandlebarsApplicationMixin:ot}=foundry.applications.api;var Ge,se,he,Ee,le,xe,Ve,ze;const F=class F extends ot(st){constructor(){super(...arguments);M(this,"_onRender",(e,s)=>{D(),ne(F,se,this.element),x(F,se).querySelectorAll(".toggle-hint").forEach(l=>{l.addEventListener("click",()=>{x(F,se).querySelectorAll("p.hint").forEach(a=>a.classList.toggle("shown"))})}),x(F,se).querySelectorAll("select[data-current-value]").forEach(l=>{const a=String(l.dataset.currentValue),n=l.querySelector(`option[value="${a}"]`);n&&(n.selected=!0)})})}_configureRenderParts(e){const s=super._configureRenderParts(e),o=F.getRestrictedTabs();return game.user.isGM||o.forEach(i=>{delete s[i]}),s}async _prepareContext(e){const s=await super._prepareContext(e);return s.activeTab=e.activeTab||Object.keys(s.tabs)[0],s.isGM=game.user.isGM,s}async _preparePartContext(e,s,o){var a,n,u;const i=await super._preparePartContext(e,s,o);e in s.tabs&&(i.tab=i.tabs[e]),D(),Ue();const l=F.getRestrictedTabs();switch(game.user.isGM||l.forEach(d=>{delete i.tabs[d]}),e){case"tabs":break;case"footer":{i.buttons=[{type:"button",icon:"",label:"FLASH_ROLLS.ui.buttons.reset",action:"redefine"},{type:"submit",icon:"",label:"FLASH_ROLLS.ui.buttons.save"}];break}default:{i.tab=i.tabs[e];const d=((a=F.PARTS[e])==null?void 0:a.menuKey)||null;if(d){const h=F.getMenuContext(d);h.fields&&(i.fields={...i.fields,...h.fields}),h.fieldDefaults&&(i.fieldDefaults={...i.fieldDefaults,...h.fieldDefaults}),h.fieldValues&&Object.assign(i,h.fieldValues),i.sidebarTabs=Object.values(((u=(n=foundry.applications)==null?void 0:n.sidebar)==null?void 0:u.tabs)||{}).map(g=>({tabName:g.tabName,name:g.name,hideForGM:!1,hideForPlayer:!1,localizedName:`FLASH_ROLLS.settings.sidebarTabs.${g.name}`}))}break}}return r.log("_preparePartContext",[i,e]),i}static getMenuContext(e){var n;const s=D(),o=((n=s[e])==null?void 0:n.fields)||null;if(!o)return{};const i={},l={},a={};return o.forEach(u=>{if(s[u]){const d=I.get(s[u].tag);i[u]=s[u],l[u]=d!==void 0?d:s[u].default,a[u]=s[u].default}}),{fields:i,fieldValues:l,fieldDefaults:a}}static getRestrictedTabs(){const e=[];return Object.entries(F.PARTS).forEach((s,o)=>{s[0]!=="tabs"&&s[0]!=="footer"&&s[1].isGMOnly&&e.push(s[0])}),e}static updateSettings(e){let s=!1;const o=D(),a=x(F,se).querySelector(".form-content.active").dataset.tab;if(ne(F,he,a),!e)return;let n;return e.object&&(n=foundry.utils.expandObject(e.object)),Object.entries(n).forEach(([u,d])=>{var h;if(!u.endsWith("_value")&&(r.log("updateSettings #1",[o,o[u]]),n[u]!==void 0&&o[u])){const g=I.get(o[u].tag);I.set(o[u].tag,n[u]),(h=o[u])!=null&&h.requiresReload&&g!==n[u]&&(s=!0)}}),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.settingsUpdated")),s}changeTab(e,s,o){super.changeTab(e,s,o),ne(F,he,e)}};se=new WeakMap,he=new WeakMap,Ee=new WeakMap,le=new WeakSet,xe=async function(e,s,o){e.preventDefault(),e.stopPropagation(),F.updateSettings(o)&&q.confirmReload()},Ve=async function(e,s){const o=D(),l=x(F,se).querySelector(".form-content.active"),a=l.dataset.tab,n=F.PARTS[a].menuKey,u=o[n].default;l.querySelectorAll("input, select").forEach(h=>{h.value=u[h.name],h.type==="checkbox"&&(h.checked=u[h.name])}),r.log("#onReset",[x(F,he),a,e,s])},ze=function(){const e=[];return Object.entries(F.PARTS).forEach(([s,o])=>{o.menuKey&&e.push({id:s,icon:"",group:"primary-tabs",label:`FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${s}`})}),e},ae(F,le),ae(F,se),ae(F,he),ae(F,Ee),M(F,"selectedTheme"),M(F,"DEFAULT_OPTIONS",{id:"flash-rolls-settings",tag:"form",window:{icon:"fas fa-cog",title:"FLASH_ROLLS.settings.moduleSettingsMenu.title",contentClasses:["standard-form","crlngn","tabbed-settings"],resizable:!0},position:{width:700,height:"auto"},actions:{redefine:pe(F,le,Ve)},form:{handler:pe(F,le,xe),closeOnSubmit:!0}}),M(F,"PARTS",{tabs:{template:"templates/generic/tab-navigation.hbs",isGMOnly:!1},generalSettings:{menuKey:"generalSettings",template:"modules/flash-rolls-5e/templates/settings-general.hbs",isGMOnly:!0},groupRolls:{menuKey:"groupRollsSettings",template:"modules/flash-rolls-5e/templates/settings-group-rolls.hbs",isGMOnly:!0},footer:{template:"templates/generic/form-footer.hbs",isGMOnly:!1}}),M(F,"TABS",{primary:{initial:"generalSettings",tabs:pe(Ge=F,le,ze).call(Ge),labelPrefix:""}});let Ae=F;function Ue(){return{moduleSettingsMenu:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),name:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),icon:"fas fa-cog",propType:Ae,restricted:!0}}}class I{static registerSettings(){const t=D();var e=I.get(t.debugMode.tag);e&&(CONFIG.debug.hooks=!0),Object.entries(t).forEach(o=>{const i=o[1],l={name:i.label,hint:i.hint,default:i.default,type:i.propType,scope:i.scope,config:i.config,requiresReload:i.requiresReload||!1,restricted:i.scope===B.world,onChange:a=>I.apply(i.tag,a)};i.choices&&(l.choices=i.choices),r.log("registerSettings",[l,l.scope],!0);try{game.settings.register(_,i.tag,l)}catch(a){r.log(`Setting ${i.tag} already registered or error:`,a)}})}static registerSettingsMenu(){var s;const e=Object.entries(Ue()).find(o=>o[0]==="moduleSettingsMenu");if(e){const o=e[1];if(o.restricted&&((s=game.user)!=null&&s.isGM)||!o.restricted){const i={name:o.tag,label:o.label,hint:o.hint,icon:o.icon,type:o.propType,restricted:o.restricted};game.settings.registerMenu(_,o.tag,i)}}}static get(t,e=_){if(!t)return null;let s=!1;try{if(e===_)s=game.settings.get(e,t);else{let i=game.settings.storage.get("client")[`${e}.${t}`];i===void 0&&(i=game.settings.storage.get("world").getSetting(`${e}.${t}`),s=i==null?void 0:i.value)}}catch{return r.log(`Setting ${e}.${t} not found, returning false`),!1}return s}static set(t,e,s=_){if(!t)return!1;let o=game.settings.storage.get("client")[`${s}.${t}`];o||(o=game.settings.storage.get("world").getSetting(`${s}.${t}`),r.log("SettingsUtil.set - world Setting?",[o]));try{game.settings.set(s,t,e),r.log("SettingsUtil.set - success",[s,t,e])}catch(i){r.error("SettingsUtil.set - error",[i])}return!0}static apply(t,e){const s=D();switch(t){case s.rollRequestsEnabled.tag:I.applyRollRequestsEnabled(e);break}}static applyRollRequestsEnabled(t){const e=document.querySelector(".chat-controls .flash-rolls-icon");e&&(t?e.classList.add("active"):e.classList.remove("active"))}}Hooks.once(N.READY,()=>{dnd5e.applications.dice.DamageRollConfigurationDialog||r.warn("DamageRollConfigurationDialog not found in dnd5e.applications.dice")});function Re(c){return class extends c{constructor(t={},e={},s={}){var o,i;super(t,e,s),this.actors=s.actors||[],this.sendRequest=s.sendRequest??s.sendRequest??!0,this.showDC=s.showDC||!1,this.dcValue=s.dcValue||null,this.rollKey=s.rollKey||t.skill||t.ability||null,this.rollTypeString=s.rollTypeString||null,this.windowTitle=((o=s.window)==null?void 0:o.title)||"",this.windowSubtitle=((i=s.window)==null?void 0:i.subtitle)||""}_buildConfig(t,e,s){const o=e==null?void 0:e.get("ability"),i=e==null?void 0:e.get("dc"),l=e==null?void 0:e.get(`rolls.${s}.situational`);if(r.log("_buildConfig",[l,e,t]),l)t.parts||(t.parts=[]),t.parts.push("@situational"),t.data||(t.data={}),t.data.situational=l;else if(t.parts){const n=t.parts.indexOf("@situational");n!==-1&&t.parts.splice(n,1)}o&&(t.ability=o,this.config.ability=o);const a=super._buildConfig(t,e,s);if(i){const n=parseInt(i);isNaN(n)||(a.options=a.options||{},a.options.target=n)}else this.dcValue!==void 0&&this.dcValue!==null&&(a.options=a.options||{},a.options.target=this.dcValue);return r.log(`${this.constructor.name}._buildConfig`,[this.config,e,a]),a}_onChangeForm(t,e){r.log("_onChangeForm",[e.target.value]),super._onChangeForm(t,e);const s=this.element.querySelector('input[name="flash5e-send-request"]');s&&(this.sendRequest=s.checked);const o=this.element.querySelector('input[name="dc"]');o&&o.value&&(this.dcValue=parseInt(o.value)||null)}_finalizeRolls(t){const e=super._finalizeRolls(t);if(r.log("_finalizeRolls #1",[e,this.sendRequest]),this.dcValue!==void 0&&this.dcValue!==null)for(const s of e)s.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,e}async _onRender(t,e){var s,o,i;await super._onRender(t,e),((i=(o=(s=this.config.rolls)==null?void 0:s[0])==null?void 0:o.data)!=null&&i.situational||this.config.situational)&&(r.log(`${this.constructor.name}._onRender`,["Triggering rebuild for initial situational bonus"]),setTimeout(()=>{this.rebuild()},100))}}}function it(c,t){var o,i,l,a,n;let e=game.i18n.localize(`FLASH_ROLLS.rollTypes.${c}`)||c;const s=c==null?void 0:c.toLowerCase();if(t)switch(s){case f.SKILL:e+=` (${((o=CONFIG.DND5E.skills[t])==null?void 0:o.label)||t})`;break;case f.SAVE:e+=` (${((i=CONFIG.DND5E.abilities[t])==null?void 0:i.label)||t})`;break;case f.ABILITY:e+=` (${((l=CONFIG.DND5E.abilities[t])==null?void 0:l.label)||t})`;break;case f.TOOL:const u=(n=(a=CONFIG.DND5E.enrichmentLookup)==null?void 0:a.tools)==null?void 0:n[t];if(u!=null&&u.id){const d=dnd5e.documents.Trait.getBaseItem(u.id,{indexOnly:!0});e+=` (${(d==null?void 0:d.name)||t})`}else e+=` (${t})`;break;case f.CUSTOM:e=`${e}: ${t}`;break}return e}function lt(c,t=it){if(c.length===0)return;const e={};for(const o of c){const i=`${o.rollType}_${o.rollKey||""}`;e[i]||(e[i]={rollType:o.rollType,rollKey:o.rollKey,actors:[],gm:o.gm}),e[i].actors.push(o.actor)}const s=Object.values(e);if(s.length===1&&s[0].actors.length===1){const o=s[0];ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestReceived",{gm:o.gm,rollType:t(o.rollType,o.rollKey)}))}else{const o=[];for(const i of s){const l=t(i.rollType,i.rollKey),a=i.actors.join(", ");o.push(`${l} (${a})`)}ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsReceivedMultiple",{gm:s[0].gm,requests:o.join("; ")}))}}function Be(c){const t=c.ownership||{};for(const[e,s]of Object.entries(t))if(s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.get(e);if(o&&!o.isGM)return o}return null}function at(c,t=game.user){if(!(c!=null&&c.length))return;c.map(s=>canvas.tokens.get(s)).filter(s=>s).forEach(s=>s.setTarget(!0,{user:t}))}function $e(c){return c.type!=="character"&&c.type!=="npc"?!1:Object.entries(c.ownership).some(([t,e])=>{const s=game.users.get(t);return s&&!s.isGM&&e>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function je(c){if(c.type!=="character"&&c.type!=="npc")return!1;const t=game.scenes.active;return t&&t.tokens.some(e=>e.actorId===c.id)}function ie(c,t,e=null){if(!game.scenes.active)return;let o;if(e){const i=canvas.tokens.placeables.find(l=>l.id===e);o=i?[i]:[]}else o=canvas.tokens.placeables.filter(i=>{var l;return((l=i.actor)==null?void 0:l.id)===c});for(const i of o)t?i.control({releaseOthers:!1}):i.release()}function we(c){return new Promise(t=>setTimeout(t,c))}function Me(){var c;return((c=ui==null?void 0:ui.sidebar)==null?void 0:c.expanded)||!1}function Fe(c){const t=document.querySelector("body");c?t.classList.add("flash5e-sidebar-expanded"):t.classList.remove("flash5e-sidebar-expanded"),fe()}function Ne(c,t){var i,l;const e=[];if(!c)return e;const s=Q.ROLL_REQUEST_OPTIONS[c];if(!s||!s.subList)return e;const o=CONFIG.DND5E[s.subList];if(o){for(const[a,n]of Object.entries(o)){let u=n.label||n.name||a;if(s.subList==="tools"&&((l=(i=CONFIG.DND5E.enrichmentLookup)==null?void 0:i.tools)!=null&&l[a])){const d=CONFIG.DND5E.enrichmentLookup.tools[a];if(d!=null&&d.id){const h=dnd5e.documents.Trait.getBaseItem(d.id,{indexOnly:!0});u=(h==null?void 0:h.name)||u}}e.push({id:a,name:u,rollable:!0})}e.sort((a,n)=>a.name.localeCompare(n.name))}return e}const Y=class Y{static notify(t,e,s={}){if(!s.batch){ui.notifications[t](e);return}s.batchData&&(Y.pendingNotifications.push(s.batchData),Y.notificationTimer&&clearTimeout(Y.notificationTimer),Y.notificationTimer=setTimeout(()=>{lt(Y.pendingNotifications),Y.pendingNotifications=[],Y.notificationTimer=null},Y.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(t,e){const s=Object.entries(t);if(s.length!==0)if(s.length===1){const o=Object.values(t)[0],i=o.actors.map(l=>l.name).join(", ");ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentSingle",{rollType:e,actors:i,player:o.player.name}))}else{const o=s.map(([i,l])=>{const a=l.actors.map(n=>n.name).join(", ");return`${l.player.name} (${a})`});ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentMultiple",{rollType:e,count:s.length,players:o.join("; ")}))}}static clearPending(){Y.notificationTimer&&(clearTimeout(Y.notificationTimer),Y.notificationTimer=null),Y.pendingNotifications=[]}};M(Y,"pendingNotifications",[]),M(Y,"notificationTimer",null),M(Y,"NOTIFICATION_BATCH_DELAY",500);let $=Y;function nt(c){var s;const t=[],e=[];for(const o of c){const i=((s=o.system.attributes.hp)==null?void 0:s.value)||0,l=o.system.attributes.death||{},a=l.success||0,n=l.failure||0;i<=0&&a<3&&n<3?t.push(o):e.push(o.name)}return e.length>0&&$.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorsSkippingDeathSave",{actors:e.join(", ")})),t}function rt(c){const t=[],e=[];for(const s of c){const o=Be(s);o?t.push({actor:s,owner:o}):e.push(s)}return{pcActors:t,npcActors:e}}function fe(c=!0){const t=document.querySelector("#chat-notifications #roll-privacy"),e=t?q.getFullWidth(t):36,s=!!document.querySelector("body.crlngn-tabs");q.addCSSVars("--flash-rolls-menu-offset",(s?e:e+16)+"px")}const k={addSituationalBonus(c,t){var e;return r.log("Config before adding bonus:",[t,c]),t&&((e=c.rolls)!=null&&e[0])&&(c.rolls[0].parts||(c.rolls[0].parts=[]),c.rolls[0].data||(c.rolls[0].data={}),c.rolls[0].data.situational=t,c.rolls[0].parts.includes("@situational")||c.rolls[0].parts.push("@situational"),r.log("Config after adding bonus:",[c])),c},buildRollConfig(c,t,e={}){var i;const s={rolls:[{parts:t.parts||[],data:t.data||{},options:{...t.options||{},...((i=t.options)==null?void 0:i._fromFlashRolls)&&{_fromFlashRolls:!0}}}],advantage:c.config.advantage||!1,disadvantage:c.config.disadvantage||!1,target:c.config.target,subject:null,chatMessage:!0,legacy:!1,...c.config.rollMode&&{rollMode:c.config.rollMode},...e},o=c.config.situational;return o&&this.addSituationalBonus(s,o),this.ensureRollFlags(s,c)},ensureRollFlags(c,t){return c.isRollRequest=!game.user.isGM,c._showRequestedBy=!0,c._requestedBy=t.config.requestedBy||"GM",c},validateActors(c){return!c||c.length===0?null:(typeof c[0]=="string"&&(c=c.map(t=>game.actors.get(t)).filter(t=>t)),c.length>0?c:null)},getRollClass(c){const t=c==null?void 0:c.toLowerCase();return[f.DAMAGE,f.HEALING].includes(t)?CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[f.FORMULA,f.CUSTOM,f.HIT_DIE].includes(t)?CONFIG.Dice.BasicRoll:CONFIG.Dice.D20Roll},shouldShowDC(c){const t=c==null?void 0:c.toLowerCase();return[f.SAVE,f.SAVING_THROW,f.ABILITY,f.ABILITY_CHECK,f.CONCENTRATION,f.SKILL,f.TOOL].includes(t)},createBaseRollConfig(c,t,e){const s=t==null?void 0:t.toLowerCase(),o={data:c.getRollData(),subject:c,rolls:[{parts:[],data:c.getRollData(),options:{}}]};switch(s){case f.SKILL:o.skill=e;break;case f.TOOL:o.tool=e;break;case f.SAVE:case f.SAVING_THROW:case f.ABILITY:case f.ABILITY_CHECK:o.ability=e;break;case f.HIT_DIE:o.rolls[0].options.flavor="Hit Die";break}return o},createMessageConfig(c,t=null){const e={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:c})}};return t&&(e.rollMode=t),e},async triggerRollDialog(c,t,e,s){const o=new c(t,e,s);return await new Promise(l=>{o.addEventListener("close",()=>{l({rolls:o.rolls,config:o.config,message:o.message,sendRequest:o.sendRequest,critical:o.config.critical,isCritical:o.config.isCritical})},{once:!0}),o.render({force:!0})})},processDialogResult(c,t,e,s,o={}){var b,S,y,R,A,L;if(!(c!=null&&c.rolls)||c.rolls.length===0)return null;const i=e==null?void 0:e.toLowerCase(),l=c.rolls[0];let a=!1,n=!1;((b=l==null?void 0:l.options)==null?void 0:b.advantageMode)!==void 0&&(a=l.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,n=l.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const u=((S=l==null?void 0:l.data)==null?void 0:S.situational)||"",d=(y=l==null?void 0:l.options)==null?void 0:y.target,h={rolls:[{parts:((R=l==null?void 0:l.parts)==null?void 0:R.slice())||[],data:u?{situational:u}:{},options:d?{target:d}:{}}],subject:t[0],advantage:a,disadvantage:n,target:d,sendRequest:c.sendRequest,isRollRequest:c.sendRequest,skipRollDialog:o.skipRollDialog||!1,chatMessage:!0},g=D(),p=I.get(g.publicPlayerRolls.tag)===!0,m=this.determineRollMode(p,(A=c.message)==null?void 0:A.rollMode);return h.rollMode=m,(L=c.config)!=null&&L.ability&&[f.SKILL,f.TOOL].includes(i)&&(h.ability=c.config.ability),h},determineRollMode(c,t){return t||(c?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode"))},isPlayerOwned(c){return Object.entries(c.ownership).some(([t,e])=>{const s=game.users.get(t);return s&&!s.isGM&&e>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})},isPlayerOwnerActive(c){const t=Be(c);return t&&t.active},calculateStandardRule(c,t){const e=c.filter(i=>i.total>=t).length,s=c.length-e,o=Math.ceil(c.length/2);return{finalResult:e>=o,successes:e,failures:s,summary:game.i18n.format("FLASH_ROLLS.groupRoll.standardRule.summary",{successes:e,total:c.length,threshold:o}),method:"Standard Rule"}},calculateGroupAverage(c,t){const e=c.reduce((o,i)=>o+i.total,0),s=Math.floor(e/c.length);return{finalResult:s,average:s,success:s>=t,summary:game.i18n.format("FLASH_ROLLS.groupRoll.groupAverage.summary",{average:s,dc:t}),method:"Group Average"}},calculateLeaderWithHelp(c,t,e,s,o){var p;let i=-999,l=null,a=0;for(const m of e){const b=this._getActorModifier(m,s,o);b>i&&(i=b,l=m.id,a=b)}const n=c.find(m=>m.actorId===l);if(!n)return{finalResult:0,error:"Leader actor did not roll",method:"Leader with Help"};const u=c.filter(m=>m.actorId!==l),d=u.filter(m=>m.total>=t).length,h=u.filter(m=>m.total<t).length,g=n.total+d-h;return{finalResult:g,leaderRoll:n.total,leaderName:(p=e.find(m=>m.id===l))==null?void 0:p.name,leaderModifier:a,bonus:d,penalty:h,success:g>=t,summary:game.i18n.format("FLASH_ROLLS.groupRoll.leaderWithHelp.summary",{leaderRoll:n.total,bonus:d,penalty:h,adjustedResult:g,dc:t}),method:"Leader with Help"}},calculateWeakestLink(c,t,e,s,o){var g;let i=999,l=null,a=0;for(const p of e){const m=this._getActorModifier(p,s,o);m<i&&(i=m,l=p.id,a=m)}const n=c.find(p=>p.actorId===l);if(!n)return{finalResult:0,error:"Weakest link actor did not roll",method:"Weakest Link"};const u=c.filter(p=>p.actorId!==l&&p.total>=t).length,d=n.total+u,h=u===1?game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successPlural");return{finalResult:d,weakestRoll:n.total,weakestName:(g=e.find(p=>p.id===l))==null?void 0:g.name,weakestModifier:a,bonus:u,success:d>=t,summary:game.i18n.format("FLASH_ROLLS.groupRoll.weakestLink.summary",{weakestRoll:n.total,bonus:u,successWord:h,adjustedResult:d,dc:t}),method:"Weakest Link"}},_getActorModifier(c,t,e){var o,i,l,a,n,u,d;switch(t==null?void 0:t.toLowerCase()){case f.SKILL:return((o=c.system.skills[e])==null?void 0:o.total)||((i=c.system.skills[e])==null?void 0:i.mod)||0;case f.SAVE:case f.SAVING_THROW:return((a=(l=c.system.abilities[e])==null?void 0:l.save)==null?void 0:a.value)||((n=c.system.abilities[e])==null?void 0:n.save)||0;case f.ABILITY:case f.ABILITY_CHECK:return((u=c.system.abilities[e])==null?void 0:u.mod)||0;case f.TOOL:if((d=c.system.tools)!=null&&d[e])return c.system.tools[e].total||c.system.tools[e].mod||0;const h=c.items.find(g=>g.type==="tool"&&g.system.toolType===e);return(h==null?void 0:h.system.bonus)||0;default:return 0}},getGroupResult(c,t,e,s,o){if(!c.every(u=>u.total!==null&&u.total!==void 0))return{complete:!1,success:!1,result:0};const l=D(),a=I.get(l.groupRollResultMode.tag)||1;let n;switch(a){case 1:return n=this.calculateStandardRule(c,t),{complete:!0,success:n.finalResult,result:n.finalResult?1:0,details:n};case 2:return n=this.calculateGroupAverage(c,t),{complete:!0,success:n.success,result:n.finalResult,details:n};case 3:return n=this.calculateLeaderWithHelp(c,t,e,s,o),{complete:!0,success:n.success,result:n.finalResult,details:n};case 4:return n=this.calculateWeakestLink(c,t,e,s,o),{complete:!0,success:n.success,result:n.finalResult,details:n};default:return n=this.calculateStandardRule(c,t),{complete:!0,success:n.finalResult,result:n.finalResult?1:0,details:n}}}};class J extends Re(dnd5e.applications.dice.D20RollConfigurationDialog){constructor(t={},e={},s={}){s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(t,e,s),r.log("constructor - initializing GM Dialog",[t,e,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(t,e,s,o){r.log("_prepareConfigurationData",[t,e,s,o]);const i=super._prepareConfigurationData(t,e,s,o);return i.showDC=this.showDC,i.dcValue=this.dcValue,i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(t,e,s){return r.log("_preparePartContext",[t,e,s]),e=await super._preparePartContext(t,e,s),t==="configuration"&&(e.showDC=this.showDC,e.dcValue=this.dcValue,e.sendRequest=this.sendRequest,e.actorCount=this.actors.length),e}async _onRender(t,e){if(r.log("_onRender",[t,e]),super._onRender(t,e),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},i=await q.renderTemplate(`modules/${_}/templates/gm-roll-config-fields.hbs`,o),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=i,s.parentNode.insertBefore(l,s),s.parentNode.insertBefore(l,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[this.element]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(e=>{e.addEventListener("click",s=>{s.currentTarget.dataset.action})})}static async initConfiguration(t,e,s,o={}){var R,A,L,T,E,v,w,H,G;if(t=k.validateActors(t),!t)return null;const i=t[0];r.log("GMRollConfigDialog, initConfiguration",[]);const l=e==null?void 0:e.toLowerCase(),a=D(),n=I.get(a.publicPlayerRolls.tag)===!0,u=k.determineRollMode(n),d=k.shouldShowDC(l),h=k.getRollClass(l),g=k.createBaseRollConfig(i,e,s),p=k.createMessageConfig(i,u),m={options:{actors:t,sendRequest:t.some(C=>k.isPlayerOwned(C)),showDC:d,rollKey:s,rollType:h,rollTypeString:l,window:{title:J._getRollTitle(l,s,i),subtitle:J._getSubtitle(t)},position:{width:420,height:"auto"},...o}},b=await k.triggerRollDialog(this,g,p,m.options),S=k.processDialogResult(b,t,e,s,o);if(!S)return null;if((R=b.config)!=null&&R.ability&&[f.SKILL,f.TOOL].includes(l)){const C=((L=(A=i.system.skills)==null?void 0:A[s])==null?void 0:L.ability)||((E=(T=CONFIG.DND5E.skills)==null?void 0:T[s])==null?void 0:E.ability);b.config.ability!==C&&(S.ability=b.config.ability)}let y=m.options.window.title;if(b.config.ability&&[f.SKILL,f.TOOL].includes(l)){const C=((v=CONFIG.DND5E.abilities[b.config.ability])==null?void 0:v.label)||b.config.ability;if(l===f.SKILL){const O=((w=CONFIG.DND5E.skills[s])==null?void 0:w.label)||s;y=game.i18n.format("DND5E.SkillPromptTitle",{skill:O,ability:C})}else if(l===f.TOOL){const O=(G=(H=CONFIG.DND5E.enrichmentLookup)==null?void 0:H.tools)==null?void 0:G[s];let P=s;if(O!=null&&O.id){const K=dnd5e.documents.Trait.getBaseItem(O.id,{indexOnly:!0});P=(K==null?void 0:K.name)||s}y=game.i18n.format("DND5E.ToolPromptTitle",{tool:P,ability:C})}}return S.rollTitle=y,S.rollType=l,S.rollKey=s,S}static _getRollTitle(t,e,s){var l,a,n,u,d,h,g,p,m,b,S,y,R;let o="";const i=t==null?void 0:t.toLowerCase();switch([f.SAVE,f.ABILITY,f.ABILITY_CHECK].includes(i)&&!e&&r.warn("Missing rollKey for roll type",[i,e]),i){case f.SKILL:const A=((l=CONFIG.DND5E.skills[e])==null?void 0:l.label)||e,L=(a=s==null?void 0:s.system.skills)==null?void 0:a[e],T=(L==null?void 0:L.ability)||((n=CONFIG.DND5E.skills[e])==null?void 0:n.ability)||"int",E=((u=CONFIG.DND5E.abilities[T])==null?void 0:u.label)||T;o=game.i18n.format("DND5E.SkillPromptTitle",{skill:A,ability:E});break;case f.SAVE:case f.SAVING_THROW:const v=((d=CONFIG.DND5E.abilities[e])==null?void 0:d.label)||e;o=game.i18n.format("DND5E.SavePromptTitle",{ability:v});break;case f.ABILITY:case f.ABILITY_CHECK:const w=((h=CONFIG.DND5E.abilities[e])==null?void 0:h.label)||e;o=game.i18n.format("DND5E.AbilityPromptTitle",{ability:w});break;case f.CONCENTRATION:o=game.i18n.localize("DND5E.Concentration");break;case f.TOOL:const H=(p=(g=CONFIG.DND5E.enrichmentLookup)==null?void 0:g.tools)==null?void 0:p[e];let G=e;if(H!=null&&H.id){const K=dnd5e.documents.Trait.getBaseItem(H.id,{indexOnly:!0});G=(K==null?void 0:K.name)||e}const C=(m=s==null?void 0:s.system.tools)==null?void 0:m[e],O=(C==null?void 0:C.ability)||((y=(S=(b=CONFIG.DND5E.enrichmentLookup)==null?void 0:b.tools)==null?void 0:S[e])==null?void 0:y.ability)||"int",P=((R=CONFIG.DND5E.abilities[O])==null?void 0:R.label)||O;o=game.i18n.format("DND5E.ToolPromptTitle",{tool:G,ability:P});break;case f.DEATH_SAVE:o=game.i18n.localize("DND5E.DeathSave");break;case f.INITIATIVE:case f.INITIATIVE_DIALOG:o=game.i18n.localize("DND5E.Initiative");break;default:o=game.i18n.localize("DND5E.Roll")}return r.log("_getRollTitle",[i,o]),o}static _getSubtitle(t=[]){return t.length===1?t[0].name:t.length>1?game.i18n.localize("FLASH_ROLLS.ui.dialogs.multipleActors"):""}}class Oe extends Re(dnd5e.applications.dice.RollConfigurationDialog){constructor(t={},e={},s={}){s.rollType=CONFIG.Dice.BasicRoll||Roll,s.showDC=!1,super(t,e,s),r.log("constructor",[t,e,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(t,e,s,o){const i=super._prepareConfigurationData(t,e,s,o);return r.log("GMHitDieConfigDialog._prepareConfigurationData",[i]),i.formula="Hit Die (varies by actor)",i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(t,e,s){return e=await super._preparePartContext(t,e,s),t==="configuration"&&(e.sendRequest=this.sendRequest,e.actorCount=this.actors.length,e.formula="Hit Die (varies by actor)"),e}async _onRender(t,e){if(super._onRender(t,e),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},i=await q.renderTemplate(`modules/${_}/templates/gm-roll-config-fields.hbs`,o),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=i,s.parentNode.insertBefore(l,s)}}async _processSubmitData(t,e,s){await super._processSubmitData(t,e,s),this.sendRequest=s.get("flash5e-send-request")!=="false",r.log("_processSubmitData",[s,this.config])}_finalizeRolls(t){const e=super._finalizeRolls(t);return this.config.sendRequest=this.sendRequest,e}static async initConfiguration(t,e,s,o={}){var m;if(t=k.validateActors(t),!t)return null;const i=t[0];r.log("GMHitDieConfigDialog, initConfiguration",[]);const l=D(),a=I.get(l.publicPlayerRolls.tag)===!0,n=k.determineRollMode(a),u={data:i.getRollData(),subject:i,rolls:[{parts:[],data:i.getRollData(),options:{flavor:"Hit Die Roll"}}]},d=k.createMessageConfig(i,n),h={options:{actors:t,sendRequest:t.some(b=>k.isPlayerOwned(b)),rollKey:s,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:J._getSubtitle(t)},position:{width:420,height:"auto"},...o}},g=await k.triggerRollDialog(this,u,d,h.options);if(!(g!=null&&g.rolls)||g.rolls.length===0)return null;r.log("GMHitDieConfigDialog - dialog result",[g.rolls]);const p=k.processDialogResult(g,t,e,s,o);return p?((m=g.config)!=null&&m.ability&&(p.ability=g.config.ability),p):null}}class ke extends Re(dnd5e.applications.dice.SkillToolRollConfigurationDialog){constructor(t={},e={},s={}){const o=foundry.utils.mergeObject(t,{chooseAbility:!0});s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(o,e,s),r.log("constructor",[t,e,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(t,e,s,o){r.log("_prepareConfigurationData",[t,e,s,o]);const i=super._prepareConfigurationData(t,e,s,o);return i.showDC=this.showDC,i.dcValue=this.dcValue,i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(t,e,s){return r.log("_preparePartContext",[t,e,s]),e=await super._preparePartContext(t,e,s),t==="configuration"&&(e.showDC=this.showDC,e.dcValue=this.dcValue,e.sendRequest=this.sendRequest,e.actorCount=this.actors.length),e}async _onRender(t,e){if(r.log("_onRender",[t,e]),super._onRender(t,e),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},i=await q.renderTemplate(`modules/${_}/templates/gm-roll-config-fields.hbs`,o),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=i,s.parentNode.insertBefore(l,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(e=>{e.addEventListener("click",s=>{s.currentTarget.dataset.action})})}static async initConfiguration(t,e,s,o={}){var R,A,L,T,E,v;if(t=k.validateActors(t),!t)return null;const i=t[0];r.log("GMSkillToolConfigDialog, initConfiguration",[]);const l=e==null?void 0:e.toLowerCase(),a=D(),n=I.get(a.publicPlayerRolls.tag)===!0,u=k.determineRollMode(n),d=k.shouldShowDC(l),h=CONFIG.Dice.D20Roll;let g=null;if(l===f.SKILL){const w=i.system.skills[s];g=(w==null?void 0:w.ability)||((R=CONFIG.DND5E.skills[s])==null?void 0:R.ability)||"int"}else if(l===f.TOOL){const w=(A=i.system.tools)==null?void 0:A[s];g=(w==null?void 0:w.ability)||((E=(T=(L=CONFIG.DND5E.enrichmentLookup)==null?void 0:L.tools)==null?void 0:T[s])==null?void 0:E.ability)||"int"}const p={data:i.getRollData(),subject:i,ability:g,chooseAbility:!0,rolls:[{parts:[],data:i.getRollData(),options:{}}]};l===f.SKILL?p.skill=s:l===f.TOOL&&(p.tool=s);const m=k.createMessageConfig(i,u),b={options:{actors:t,sendRequest:t.some(w=>k.isPlayerOwned(w)),showDC:d,rollKey:s,rollType:h,rollTypeString:l,window:{title:J._getRollTitle(l,s,i),subtitle:J._getSubtitle(t)},position:{width:420,height:"auto"},...o}},S=await k.triggerRollDialog(this,p,m,b.options),y=k.processDialogResult(S,t,e,s,o);return y?((v=S.config)!=null&&v.ability&&[f.SKILL,f.TOOL].includes(l)&&(y.ability=S.config.ability),y.rollTitle=b.options.window.title,y.rollType=l,y.rollKey=s,y):null}}class ct extends Re(dnd5e.applications.dice.DamageRollConfigurationDialog){constructor(t={},e={},s={}){const o=foundry.utils.mergeObject({configure:!0},t);super(o,e,s),r.log("GMDamageConfigDialog.constructor",[o,e,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","damage-roll","gm-roll-config"]})}_prepareConfigurationData(t,e,s,o){r.log("GMDamageConfigDialog._prepareConfigurationData",[t,e,s,o]);const i=super._prepareConfigurationData(t,e,s,o);return i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _onRender(t,e){if(await super._onRender(t,e),q.preventDialogFlicker(this.element),this.actors.length>0){const s=this.element.querySelector(".rolls + .dialog-buttons");if(s&&!this.element.querySelector(".gm-roll-config-fields")){const o=document.createElement("div");o.className="gm-roll-config-fields",o.innerHTML=`
          <div class="form-group">
            <label class="checkbox">
              <input type="checkbox" name="flash5e-send-request" ${this.sendRequest?"checked":""}>
              ${game.i18n.localize("FLASH_ROLLS.ui.dialogs.sendRequestToPlayers")}
            </label>
          </div>
        `,s.insertAdjacentElement("beforebegin",o)}}}static async initConfiguration(t,e,s,o={},i={},l={}){var v,w,H,G,C;if(t=k.validateActors(t),r.log("GMDamageConfigDialog, initConfiguration actors",[t]),!t)return null;const a=t[0],n=D(),u=I.get(n.publicPlayerRolls.tag)===!0,d=k.determineRollMode(u,i.rollMode),h=e==null?void 0:e.toLowerCase(),g={subject:i.subject||a,data:a.getRollData(),critical:i.critical||{},rolls:i.rolls||[{parts:[],data:a.getRollData(),options:{}}]};r.log("GMDamageConfigDialog, initConfiguration #1",[g]);const p=k.createMessageConfig(a,d);r.log("GMDamageConfigDialog, initConfiguration #2",[p]);const{position:m,...b}=(l==null?void 0:l.options)||{},S={options:{actors:t,sendRequest:t.some(O=>k.isPlayerOwned(O)),rollKey:s,rollType:CONFIG.Dice.DamageRoll,rollTypeString:h,window:{title:game.i18n.localize("DND5E.DamageRoll"),subtitle:J._getSubtitle(t)},...b,...o}},y=await k.triggerRollDialog(this,g,p,S.options);if(!(y!=null&&y.rolls)||y.rolls.length===0)return null;const R=y.rolls[0],A=((v=R==null?void 0:R.data)==null?void 0:v.situational)||"",L=(w=R==null?void 0:R.options)==null?void 0:w.target,T={rolls:[{parts:[],data:A?{situational:A}:{},options:{...L&&{target:L},isCritical:((H=R==null?void 0:R.options)==null?void 0:H.isCritical)||(R==null?void 0:R.isCritical)||!1}}],subject:i.subject||a,target:L,isCritical:((G=R==null?void 0:R.options)==null?void 0:G.isCritical)||(R==null?void 0:R.isCritical)||!1,sendRequest:y.sendRequest,isRollRequest:y.sendRequest,skipRollDialog:o.skipRollDialog||!1,chatMessage:!0};r.log("GMDamageConfigDialog, initConfiguration #6",[T]);const E=k.determineRollMode(u,(C=y.message)==null?void 0:C.rollMode);return T.rollMode=E,T.rollTitle=S.options.window.title,T.rollType=h,T.rollKey=s,r.log("GMDamageConfigDialog, initConfiguration - result",[T]),T}}class ut extends Re(dnd5e.applications.dice.AttackRollConfigurationDialog){constructor(t={},e={},s={}){super(t,e,s),r.log("GMAttackConfigDialog.constructor",[t,e,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(t,e,s,o){r.log("GMAttackConfigDialog._prepareConfigurationData",[t,e,s,o]);const i=super._prepareConfigurationData(t,e,s,o);return i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(t,e,s){return e=await super._preparePartContext(t,e,s),t==="configuration"&&(e.sendRequest=this.sendRequest,e.actorCount=this.actors.length),e}async _onRender(t,e){if(await super._onRender(t,e),q.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},i=await q.renderTemplate(`modules/${_}/templates/gm-roll-config-fields.hbs`,o),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=i,s.parentNode.insertBefore(l,s)}}_finalizeRolls(t){return this.config.sendRequest=this.sendRequest,!this.sendRequest&&this.config.isRollRequest&&(this.config.isRollRequest=!1),super._finalizeRolls(t)}static async initConfiguration(t,e,s,o={},i={},l={}){var H,G,C,O,P,K,be;if(t=k.validateActors(t),!t)return null;const a=t[0];r.log("GMAttackConfigDialog, initConfiguration",[]);const n=D(),u=I.get(n.publicPlayerRolls.tag)===!0,d=e==null?void 0:e.toLowerCase(),h={subject:i.subject||a,data:a.getRollData(),rolls:[{parts:[],data:a.getRollData(),options:{}}]},g=k.determineRollMode(u),p=k.createMessageConfig(a,g),{position:m,...b}=(l==null?void 0:l.options)||{},S={options:{actors:t,sendRequest:t.some(Qe=>k.isPlayerOwned(Qe)),rollKey:s,rollType:CONFIG.Dice.D20Roll,rollTypeString:d,window:{title:game.i18n.localize("DND5E.Attack"),subtitle:J._getSubtitle(t)},...b,...o}},y=await k.triggerRollDialog(this,h,p,S.options);if(r.log("GMAttackConfigDialog, initConfiguration",[y==null?void 0:y.sendRequest]),!(y!=null&&y.rolls)||y.rolls.length===0)return null;const R=y.rolls[0];let A=!1,L=!1;((H=R==null?void 0:R.options)==null?void 0:H.advantageMode)!==void 0&&(A=R.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,L=R.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const T=((G=R==null?void 0:R.data)==null?void 0:G.situational)||"",E=(C=R==null?void 0:R.options)==null?void 0:C.target,v={rolls:[{parts:[],data:T?{situational:T}:{},options:{...E&&{target:E},...((O=R==null?void 0:R.options)==null?void 0:O.ammunition)&&{ammunition:R.options.ammunition},...((P=R==null?void 0:R.options)==null?void 0:P.attackMode)&&{attackMode:R.options.attackMode},...((K=R==null?void 0:R.options)==null?void 0:K.mastery)!==void 0&&{mastery:R.options.mastery}}}],subject:i.subject||a,advantage:A,disadvantage:L,target:E,sendRequest:y.sendRequest,isRollRequest:y.sendRequest,skipDialog:o.skipDialogs||!1,chatMessage:!q.isModuleOn("midi-qol")||!0},w=k.determineRollMode(u,(be=y.message)==null?void 0:be.rollMode);return v.rollMode=w,v.rollTitle=S.options.window.title,v.rollType=d,v.rollKey=s,r.log("GMAttackConfigDialog, initConfiguration - SIMPLIFIED result",[v]),v}}const ge=class ge{static isModuleActive(t){const e=game.modules.get(t);return e&&e.active}static getMidiQOL(){return this.isModuleActive("midi-qol")&&typeof MidiQOL<"u"?MidiQOL:null}static async prepareMidiQOLSettings(){let t=null;if(r.log("prepareMidiQOLSettings #0",[game.settings]),ge.isModuleActive("midi-qol")){r.log("prepareMidiQOLSettings #1",[MidiQOL]),t={autoFastForwardAbilityRolls:I.get("AutoFastForwardAbilityRolls","midi-qol")},clearTimeout(ge.midiTimeout),ge.midiTimeout=setTimeout(()=>{t&&I.set("AutoFastForwardAbilityRolls",t.autoFastForwardAbilityRolls,"midi-qol"),r.log("prepareMidiQOLSettings #timeout 1",[game.user.getFlag(_,"savedMidiQOLSettings")]),game.user.unsetFlag(_,"savedMidiQOLSettings"),r.log("prepareMidiQOLSettings #timeout 2",[game.user.getFlag(_,"savedMidiQOLSettings")])},4e3);try{r.log("prepareMidiQOLSettings #before",[I.get("AutoFastForwardAbilityRolls","midi-qol")]),await game.user.setFlag(_,"savedMidiQOLSettings",t),await I.set("AutoFastForwardAbilityRolls",!1,"midi-qol"),r.log("prepareMidiQOLSettings #after",[I.get("AutoFastForwardAbilityRolls","midi-qol"),MidiQOL])}catch(e){r.error("prepareMidiQOLSettings",[e])}finally{r.log("prepareMidiQOLSettings - saved temporary settings for MidiQOL",[])}}}};M(ge,"midiTimeout",null);let re=ge;class dt{static findActivityForRoll(t,e){var i;if(!((i=t==null?void 0:t.system)!=null&&i.activities))return null;const s=t.system.activities;switch(e==null?void 0:e.toLowerCase()){case f.ATTACK:const l=s.getByType("attack");return(l==null?void 0:l[0])||null;case f.DAMAGE:const a=s.getByType("attack");if((a==null?void 0:a.length)>0)return a[0];const n=s.getByType("damage");if((n==null?void 0:n.length)>0)return n[0];const u=s.getByType("save");return(u==null?void 0:u.length)>0?u[0]:null;case f.ITEM_SAVE:const d=s.getByType("save");return(d==null?void 0:d[0])||null;default:return null}}static getActivitiesByType(t,e){var s;return(s=t==null?void 0:t.system)!=null&&s.activities?t.system.activities.getByType(e):[]}static hasActivityForRoll(t,e){return r.log("hasActivityForRoll",[t,e]),!!this.findActivityForRoll(t,e)}static async executeActivityRoll(t,e,s,o,i){var h,g,p,m,b,S,y,R;r.log("executeActivityRoll",[t,e,s,o,i]);const l=re.isModuleActive("midi-qol"),a=t.items.get(s);if(!a)throw new Error(`Item ${s} not found on actor ${t.name}`);let n=null,u=null;if(o&&(n=(h=a.system.activities)==null?void 0:h.get(o)),n=n||this.findActivityForRoll(a,e),!n)throw new Error(`Activity not found on item ${a.name}`);r.log("executeActivityRoll - activity",[n,e]);const d=e==null?void 0:e.toLowerCase();if(n)switch(d){case f.ATTACK:r.log("executeActivityRoll - is attack activity",[i]);const A={attackMode:i.usage.attackMode,ammunition:i.usage.ammunition,mastery:i.usage.mastery,situational:(m=(p=(g=i.usage.rolls)==null?void 0:g[0])==null?void 0:p.data)==null?void 0:m.situational,advantage:i.usage.advantage,disadvantage:i.usage.disadvantage,rollMode:(b=i.message)==null?void 0:b.rollMode};await n.item.setFlag(_,"tempAttackConfig",A),r.log("executeActivityRoll - stored temp config as flag",[A]);try{if(i.message.create=!0,await n.use(i.usage,i.dialog,i.message),r.log("FLASH_ROLLS TEST",[i]),l&&re.getMidiQOL())return}catch(L){r.error("executeActivityRoll - attack roll error",[L])}finally{await n.item.unsetFlag(_,"tempAttackConfig")}return;case f.DAMAGE:r.log("executeActivityRoll - damage roll",[n,i]),l||(i.message.create=!0),u={critical:i.usage.critical||{},situational:i.usage.rolls[0].data.situational||"",rollMode:(S=i.message)==null?void 0:S.rollMode,create:((y=i.message)==null?void 0:y.create)!==!1},(n.type===Pe.SAVE||n!=null&&n.damageOnly)&&await n.use(i.usage,i.dialog,i.message),await n.item.setFlag(_,"tempDamageConfig",u),r.log("executeActivityRoll - damage config with situational",[u]);try{if(l){const L=re.getMidiQOL();if(L){const T=(R=L.Workflow)==null?void 0:R.getWorkflow(n.uuid);if(r.log("executeActivityRoll - workflow",[T]),T){const E=await T.activity.rollDamage({...i,workflow:T})}return}}else r.log("executeActivityRoll - damage roll",[n,u,i]),await n.rollDamage(u,i.dialog,i.message)}catch(L){r.error(["executeActivityRoll - damage roll error",L])}finally{await n.item.unsetFlag(_,"tempDamageConfig")}return;default:r.log("executeActivityRoll - unknown roll type",[d]),await n.use(i.usage,i.dialog,i.message);return}throw new Error(`No suitable method found for ${d} on item ${a.name}`)}static getActivityDisplayInfo(t){return r.log("getActivityDisplayInfo",[t]),t?{name:t.name||t.constructor.metadata.label,type:t.type,icon:t.constructor.metadata.icon,canAttack:t.type==="attack",canDamage:["attack","damage","save"].includes(t.type),canSave:t.type==="save"}:null}static getDamageFormula(t){var s,o;if(r.log("getDamageFormula",[t]),!((o=(s=t==null?void 0:t.damage)==null?void 0:s.parts)!=null&&o.length))return null;const e=t.damage.parts.map(i=>i.formula).filter(i=>i);return e.length>0?e.join(" + "):null}static async syntheticItemRoll(t,e={}){r.log("syntheticItemRoll",[t,e]);const s=re.getMidiQOL();if(!s){r.warn("MidiQOL is not active");return}let o={consumeUsage:!1,consumeSpellSlot:!1},i={fastForward:!1,fastForwardAttack:!1,dialogOptions:{fastForward:!1,fastForwardAttack:!1},configureDialog:!0,workflowOptions:{fastForward:!1,fastForwardAttack:!1}};return e={...o,...e},await s.completeItemUse(t,e,i)}}const{ApplicationV2:gt,HandlebarsApplicationMixin:ft}=foundry.applications.api;class Se extends ft(gt){constructor(t={}){super(t),this.formula=t.formula||"",this.readonly=t.readonly||!1,this.actor=t.actor,this.callback=t.callback,this.diceCounts={}}static get DEFAULT_OPTIONS(){return foundry.utils.mergeObject(super.DEFAULT_OPTIONS,{id:"flash5e-custom-roll-dialog",classes:["flash5e-dialog","flash5e-custom-roll-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:420,height:"auto"}})}_onClickAction(t,e){switch(e.dataset.action){case"rollDice":return this.rollDice(t,e);case"addDie":return this.addDie(t,e);case"cancel":return this.cancel(t,e)}}async _prepareContext(t={}){return{...await super._prepareContext(t),formula:this.formula,readonly:this.readonly}}_attachPartListeners(t,e,s){super._attachPartListeners(t,e,s);const o=e.querySelector("#custom-roll-formula"),i=e.querySelector("#formula-validation-message");o&&!this.readonly&&(o.addEventListener("input",l=>{this.formula=l.target.value.trim(),this.updateValidationMessage(i)}),this.formula&&this.updateValidationMessage(i))}updateValidationMessage(t){if(!t)return;if(!this.formula){t.textContent="&nbsp;",t.classList.remove("error","success");return}this.validateFormula(this.formula)?(t.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaValid"),t.classList.remove("error"),t.classList.add("success")):(t.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaInvalid"),t.classList.remove("success"),t.classList.add("error"))}addDie(t,e){const s=e.dataset.die,o=this.element.querySelector("#custom-roll-formula");if(!o)return;const i=o.value.trim();if(i){const l=/(\d*)d(\d+)/g,a=new Map;let n=i,u;for(;(u=l.exec(i))!==null;){const g=parseInt(u[1]||"1"),p=u[2];a.set(p,(a.get(p)||0)+g),n=n.replace(u[0],"").trim()}const d=s.substring(1);a.set(d,(a.get(d)||0)+1);const h=[];for(const[g,p]of a)h.push(`${p}d${g}`);n=n.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),n&&n!=="+"?this.formula=`${h.join(" + ")} + ${n}`:this.formula=h.join(" + ")}else this.formula=`1${s}`;o.value=this.formula,o.dispatchEvent(new Event("input"))}validateFormula(t){var e;if(!t||t.trim()==="")return!1;try{return Roll.validate(t)}catch{try{return new Roll(t,((e=this.actor)==null?void 0:e.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(r.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback(this.formula),this.close()}cancel(){this.close()}static async prompt(t={}){return new Promise(e=>{const s=new this({...t,callback:o=>e(o)});s.addEventListener("close",()=>{s._resolved||e(null)}),s.render(!0)})}async close(t={}){return this._resolved=!0,super.close(t)}}M(Se,"PARTS",{main:{template:`modules/${Q.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${Q.ID}/templates/custom-roll-dialog-footer.hbs`}});class j{static async initialize(){r.log("ChatMessageUtils.initialize"),await this.preloadTemplate(),this.registerEventListeners()}static registerEventListeners(){const t=(e,s)=>{e.querySelectorAll(".actor-result").forEach(l=>{l.addEventListener("click",a=>{if(a.target.closest(".dice-btn.rollable"))return;a.preventDefault(),a.stopPropagation();const n=l;r.log("actor-result click",[l]),n.classList.contains("expanded")?n.classList.remove("expanded"):n.classList.add("expanded")})}),e.querySelectorAll(".dice-btn.rollable").forEach(l=>{l.addEventListener("click",async a=>{var L;a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation();const n=l.dataset,u=n.actorId,d=game.actors.get(u);if(!d){ui.notifications.warn("Actor not found");return}if(!(game.user.isGM||d.isOwner)){ui.notifications.warn(`You don't have permission to roll for ${d.name}`);return}const g=(L=n.type)==null?void 0:L.toLowerCase(),p=n.rollKey,m=n.groupRollId,b=n.dc?parseInt(n.dc):null;r.log("Rollable dice clicked",[g,p,u,m]);const S={rollKey:p,groupRollId:m,config:{advantage:!1,disadvantage:!1,target:b,rollMode:game.settings.get("core","rollMode")}},y={configure:!0,isRollRequest:!0},R={rollMode:game.settings.get("core","rollMode"),create:!0,isRollRequest:!0},A={parts:[],data:{},options:{}};try{const T=X[g];if(T)await T(d,S,A,y,R);else{let E;switch(g){case f.SKILL:E="rollSkill";break;case f.ABILITY:case f.ABILITY_CHECK:E="rollAbilityTest";break;case f.SAVE:case f.SAVING_THROW:E="rollAbilitySave";break;case f.TOOL:E="rollToolCheck";break;default:ui.notifications.warn(`Unknown roll type: ${g}`);return}E&&d[E]&&await d[E](p,{...S.config,messageOptions:{"flags.flash-rolls-5e.groupRollId":m}})}}catch(T){r.error("Error executing roll from chat",T),ui.notifications.error(`Failed to execute roll: ${T.message}`)}})});const o=e.querySelector(".group-roll-dc-control"),i=e.querySelector(".dc-input");if(o){const l=o.dataset.showToPlayers==="true";if(game.user.isGM||(o.style.display="none"),!game.user.isGM&&!l){const a=e.querySelector(".group-roll-footer .group-result-details");a&&(a.style.display="none")}}if(i)if(!game.user.isGM)i.readOnly=!0,i.style.cursor="not-allowed";else{let l=null;const a=async()=>{const n=parseInt(i.value);if(!i.value)return;if(isNaN(n)||n<1||n>99){i.value="";return}const u=i.dataset.messageId,d=game.messages.get(u);d&&await this.updateGroupRollDC(d,n)};i.addEventListener("input",n=>{l&&clearTimeout(l),l=setTimeout(()=>{a()},750)}),i.addEventListener("keypress",n=>{n.key==="Enter"&&(l&&clearTimeout(l),a())})}};Hooks.on(N.RENDER_CHAT_MESSAGE,(e,s)=>{e.getFlag(_,"isGroupRoll")&&t(s)}),Hooks.on(N.RENDER_CHAT_LOG,(e,s)=>{s.querySelectorAll(".flash5e-group-roll").forEach(i=>{const l=i.closest(".chat-message");if(l){const a=l.dataset.messageId,n=game.messages.get(a);n&&n.getFlag(_,"isGroupRoll")&&t(i)}})})}static async preloadTemplate(){r.log("ChatMessageUtils.preloadTemplate");try{await q.loadTemplates([this.templatePath])}catch(t){r.error("Failed to preload template",t)}}static async createGroupRollMessage(t,e,s,o,i){r.log("ChatMessageUtils.createGroupRollMessage",[t.length,e,s,i]);const l=this.buildGroupRollData(t,e,s,o);if(!l)return r.error("createGroupRollMessage - Failed to build group roll data"),null;l.groupRollId=i;const a=t.filter(h=>h&&h.actor),u=a.some(h=>k.isPlayerOwnerActive(h.actor))?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode");return this.pendingRolls.set(i,{actorEntries:a.map(h=>({actorId:h.actor.id,uniqueId:h.uniqueId,tokenId:h.tokenId})),rollType:e,rollKey:s,config:o,results:new Map}),await this.postGroupMessage(l,u)}static buildGroupRollData(t,e,s,o){r.log("ChatMessageUtils.buildGroupRollData",[t.length,e,s,o]),r.log("ChatMessageUtils.buildGroupRollData - actorEntries structure",t.map(g=>{var p,m;return{hasEntry:!!g,hasActor:!!(g&&g.actor),entryKeys:g?Object.keys(g):"null",actorType:((m=(p=g==null?void 0:g.actor)==null?void 0:p.constructor)==null?void 0:m.name)||"undefined"}}));const i=t.filter(g=>g&&g.actor);if(i.length===0)return r.error("buildGroupRollData - No valid actor entries found",[t]),null;let l=this._buildFlavorText(e,s,o);const a=(o==null?void 0:o.dc)||(o==null?void 0:o.target),n=i.map(g=>{var p,m,b,S;return{actorId:g.actor.id,uniqueId:g.uniqueId,tokenId:g.tokenId,actorImg:g.actor.img||((m=(p=g.actor.prototypeToken)==null?void 0:p.texture)==null?void 0:m.src)||"icons/svg/mystery-man.svg",actorName:g.tokenId&&((S=(b=canvas.tokens)==null?void 0:b.get(g.tokenId))==null?void 0:S.name)||g.actor.name,rolled:!1,showDice:!0,total:null,success:!1,failure:!1}}),u=k.shouldShowDC(e),d=D(),h=I.get(d.showGroupDCToPlayers.tag);return{flavor:l,results:n,showDC:a!=null,dc:a,rollType:e,rollKey:s,supportsDC:u,showDCToPlayers:h,actorEntries:i.map(g=>({actorId:g.actor.id,uniqueId:g.uniqueId,tokenId:g.tokenId})),moduleId:_}}static _buildFlavorText(t,e,s){var i,l,a,n,u;let o="";switch(t==null?void 0:t.toLowerCase()){case"ability":case"abilitycheck":const d=((i=CONFIG.DND5E.abilities[e])==null?void 0:i.label)||e;o=game.i18n.format("DND5E.AbilityPromptTitle",{ability:d});break;case"save":case"savingthrow":const h=((l=CONFIG.DND5E.abilities[e])==null?void 0:l.label)||e;o=game.i18n.format("DND5E.SavePromptTitle",{ability:h});break;case"skill":const g=((a=CONFIG.DND5E.skills[e])==null?void 0:a.label)||e,p=(s==null?void 0:s.ability)||((n=CONFIG.DND5E.skills[e])==null?void 0:n.ability)||"int",m=((u=CONFIG.DND5E.abilities[p])==null?void 0:u.label)||p;o=game.i18n.format("DND5E.SkillPromptTitle",{skill:g,ability:m});break;case"tool":o=`Tool Check: ${e}`;break;case"initiative":o=game.i18n.localize("DND5E.Initiative");break;case"attack":o=(s==null?void 0:s.flavor)||"Attack Roll";break;case"damage":o=(s==null?void 0:s.flavor)||"Damage Roll";break;default:o=(s==null?void 0:s.flavor)||""}return o}static async postGroupMessage(t,e=null){r.log("postGroupMessage - groupRollId",[t.groupRollId,e]);try{const o={content:await q.renderTemplate(this.templatePath,t),speaker:{alias:"Group Roll"},flags:{[_]:{isGroupRoll:!0,groupRollId:t.groupRollId,rollData:t}}};e&&ChatMessage.applyRollMode(o,e);const i=await ChatMessage.create(o);return this.groupRollMessages.set(t.groupRollId,i),i}catch(s){return r.error("Failed to post group message",s),null}}static async updateGroupRollMessage(t,e,s){if(r.log("ChatMessageUtils.updateGroupRollMessage",[t,e,s]),!game.user.isGM)return;const i=(this.updateQueue.get(t)||Promise.resolve()).then(()=>this._performGroupRollUpdate(t,e,s));return this.updateQueue.set(t,i),i}static async _performGroupRollUpdate(t,e,s){var d,h;let o=this.groupRollMessages.get(t),i=this.pendingRolls.get(t);if(!o&&(o=game.messages.contents.find(p=>p.getFlag(_,"groupRollId")===t&&p.getFlag(_,"isGroupRoll")),o&&(this.groupRollMessages.set(t,o),r.log("updateGroupRollMessage - Found and registered group message",[t]),!i))){const p=o.getFlag(_,"rollData");i={actorEntries:p.actorEntries||p.results.map(m=>({actorId:m.actorId,uniqueId:m.uniqueId,tokenId:m.tokenId})),results:new Map},this.pendingRolls.set(t,i)}if(!o){r.log("No group message found for groupRollId",t);return}i&&i.results&&i.results.set(e,{total:s.total,roll:s});const l=o.getFlag(_,"rollData"),a=l.results.findIndex(g=>g.uniqueId===e);if(a!==-1){l.results[a].rolled=!0,l.results[a].showDice=!1,l.results[a].total=s.total;try{l.results[a].rollBreakdown=await s.render()}catch(g){r.error("Error rendering roll breakdown",g),l.results[a].rollBreakdown=null}l.showDC&&l.dc&&(l.results[a].success=s.total>=l.dc,l.results[a].failure=s.total<l.dc)}l.allRolled=l.results.every(g=>g.rolled),l.messageId=o.id,l.supportsDC=k.shouldShowDC(l.rollType);const n=D();if(l.showDCToPlayers=I.get(n.showGroupDCToPlayers.tag),l.supportsDC&&l.showDC&&l.dc){const g=((d=l.actorEntries)==null?void 0:d.map(m=>game.actors.get(m.actorId)).filter(m=>m))||((h=l.actors)==null?void 0:h.map(m=>game.actors.get(m)).filter(m=>m))||[],p=k.getGroupResult(l.results,l.dc,g,l.rollType,l.rollKey);l.groupResult=p,r.log("updateGroupRollMessage - COMPLETE?",[p.complete]),p.complete&&p.details&&(l.groupSummary=p.details.summary)}const u=await q.renderTemplate(this.templatePath,l);await o.update({content:u,flags:{[_]:{rollData:l}}}),i!=null&&i.results&&(i!=null&&i.actorEntries)&&i.results.size===i.actorEntries.length&&(this.pendingRolls.delete(t),setTimeout(()=>{this.groupRollMessages.delete(t),this.updateQueue.delete(t)},6e4))}static async updateGroupRollDC(t,e){var n,u;const s=t.getFlag(_,"rollData");if(!s||(s.supportsDC=k.shouldShowDC(s.rollType),!s.supportsDC))return;s.dc=e,s.showDC=!0,s.results.forEach(d=>{d.rolled&&d.total!==null&&(d.success=d.total>=e,d.failure=d.total<e)});const o=((n=s.actorEntries)==null?void 0:n.map(d=>game.actors.get(d.actorId)).filter(d=>d))||((u=s.actors)==null?void 0:u.map(d=>game.actors.get(d)).filter(d=>d))||[],i=k.getGroupResult(s.results,e,o,s.rollType,s.rollKey);s.groupResult=i,i.complete&&i.details&&(s.groupSummary=i.details.summary),s.allRolled=s.results.every(d=>d.rolled),s.messageId=t.id;const l=D();s.showDCToPlayers=I.get(l.showGroupDCToPlayers.tag);const a=await q.renderTemplate(this.templatePath,s);await t.update({content:a,flags:{[_]:{rollData:s}}})}static interceptRollMessage(t,e,s){var g,p,m,b,S,y,R,A;const o=D();if(!I.get(o.groupRollsMsgEnabled.tag))return;const l=(g=t.speaker)==null?void 0:g.actor,a=(p=t.speaker)==null?void 0:p.token;let n;if(a){const L=((m=canvas.tokens)==null?void 0:m.get(a))||((S=(b=game.scenes.active)==null?void 0:b.tokens)==null?void 0:S.get(a));n=L==null?void 0:L.actor}if(n||(n=game.actors.get(l)),!n)return;const u=a||l,d=t.getFlag(_,"groupRollId")||((y=n.getFlag(_,"tempInitiativeConfig"))==null?void 0:y.groupRollId);if(r.log("interceptRollMessage #1",[n,t.getFlag(_,"groupRollId"),(R=n.getFlag(_,"tempInitiativeConfig"))==null?void 0:R.groupRollId]),!d){r.log("interceptRollMessage #2 - no groupRollId in flag",[n.name]);return}if(!game.user.isGM&&!this.groupRollMessages.has(d)){const T=game.messages.contents.find(E=>E.getFlag(_,"groupRollId")===d&&E.getFlag(_,"isGroupRoll"));T&&(this.groupRollMessages.set(d,T),r.log("interceptRollMessage - Registered group roll message",[n.name,d]))}if(!this.groupRollMessages.has(d)){r.log("interceptRollMessage - groupRollId not in map",[n.name,d,Array.from(this.groupRollMessages.keys())]),r.log("interceptRollMessage - All group messages in chat:",[game.messages.contents,game.messages.contents.filter(E=>E.getFlag(_,"isGroupRoll")).map(E=>({id:E.id,groupRollId:E.getFlag(_,"groupRollId")}))]);const T=game.messages.contents.find(E=>E.getFlag(_,"groupRollId")===d&&E.getFlag(_,"isGroupRoll"));if(T)r.log("interceptRollMessage - Found group message in chat log, registering",[d]),this.groupRollMessages.set(d,T);else{r.log("interceptRollMessage - No group message found in chat log either",[d]);return}}const h=(A=t.rolls)==null?void 0:A[0];if(h)if(e&&e instanceof HTMLElement&&e.style&&(e.style.display="none"),game.user.isGM){this.updateGroupRollMessage(d,u,h);const L=t.id;if(this.messagesScheduledForDeletion.has(L))return;this.messagesScheduledForDeletion.add(L),L&&setTimeout(async()=>{r.log("interceptRollMessage - deletion",[L]);try{game.messages.get(L)?(await t.delete(),r.log("interceptRollMessage - Deleted individual message",[L])):r.log("interceptRollMessage - Message already deleted",[L])}catch(T){r.log("interceptRollMessage - Error deleting message",[L,T.message])}finally{this.messagesScheduledForDeletion.delete(L)}},500)}else r.log("interceptRollMessage - Player roll intercepted, GM will handle update",[d])}static isGroupRoll(t){return this.pendingRolls.has(t)||this.groupRollMessages.has(t)}static async addGroupRollFlag(t,e,s=null){const o=D(),i=I.get(o.groupRollsMsgEnabled.tag);if(r.log("addGroupRollFlag called",[t,e.groupRollId,this.isGroupRoll(e.groupRollId)]),r.log("addGroupRollFlag - detailed check",["groupRollId:",e.groupRollId,"type:",typeof e.groupRollId,"isGM:",game.user.isGM,"actor:",s==null?void 0:s.name,"requestData keys:",Object.keys(e)]),!game.user.isGM&&e.groupRollId&&s&&(await s.setFlag(_,"tempGroupRollId",e.groupRollId),r.log("addGroupRollFlag - Stored tempGroupRollId on actor for player",[e.groupRollId,s.id]),!this.groupRollMessages.has(e.groupRollId))){const a=game.messages.contents.find(n=>n.getFlag(_,"groupRollId")===e.groupRollId&&n.getFlag(_,"isGroupRoll"));a&&(this.groupRollMessages.set(e.groupRollId,a),r.log("addGroupRollFlag - Registered group roll message on player side",[e.groupRollId]))}i&&e.groupRollId&&(!game.user.isGM||this.isGroupRoll(e.groupRollId))&&(t.data=t.data||{},t.data.flags=t.data.flags||{},t.data.flags[_]=t.data.flags[_]||{},t.data.flags[_].groupRollId=e.groupRollId,r.log("addGroupRollFlag - Added flag to messageConfig",[t]))}static cleanup(){const t=Date.now()-3e5;for(const[e,s]of this.groupRollMessages.entries())s.timestamp<t&&(this.groupRollMessages.delete(e),this.pendingRolls.delete(e))}}M(j,"groupRollMessages",new Map),M(j,"pendingRolls",new Map),M(j,"messagesScheduledForDeletion",new Set),M(j,"updateQueue",new Map),M(j,"templatePath","modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs");const X={ability:async(c,t,e,s,o)=>{var l;r.log("RollHandlers.ability #1",[e]);const i=k.buildRollConfig(t,e,{ability:t.rollKey});r.log("RollHandlers.ability #2",[(l=i.rolls)==null?void 0:l[0]]),r.log("RollHandlers.ability - messageConfig",o),await j.addGroupRollFlag(o,t,c),await c.rollAbilityCheck(i,s,o)},abilitycheck:async(c,t,e,s,o)=>X.ability(c,t,e,s,o),save:async(c,t,e,s,o)=>{var l;const i=k.buildRollConfig(t,e,{ability:((l=t.config)==null?void 0:l.ability)||t.rollKey});await j.addGroupRollFlag(o,t,c),await c.rollSavingThrow(i,s,o)},savingthrow:async(c,t,e,s,o)=>X.save(c,t,e,s,o),skill:async(c,t,e,s,o)=>{var a,n,u,d,h,g;r.log("RollHandlers.skill #1",[t,e,s]);const i=((n=(a=c.system.skills)==null?void 0:a[t.rollKey])==null?void 0:n.ability)||((d=(u=CONFIG.DND5E.skills)==null?void 0:u[t.rollKey])==null?void 0:d.ability)||void 0,l=k.buildRollConfig(t,e,{skill:t.rollKey,chooseAbility:s.configure!==!1,ability:t.config.ability||i});if(t.config.ability&&s.configure===!1){const p=((h=CONFIG.DND5E.skills[t.rollKey])==null?void 0:h.label)||t.rollKey,m=((g=CONFIG.DND5E.abilities[t.config.ability])==null?void 0:g.label)||t.config.ability,b=game.i18n.format("DND5E.SkillPromptTitle",{skill:p,ability:m});o.data=o.data||{},o.data.flavor=b}r.log("RollHandlers.skill #2",[l,s,o]),await j.addGroupRollFlag(o,t,c),await c.rollSkill(l,s,o)},tool:async(c,t,e,s,o)=>{var n,u,d,h,g,p,m;r.log("RollHandlers.tool #1",[t,e]);const i=(n=c.system.tools)==null?void 0:n[t.rollKey],l=(i==null?void 0:i.ability)||((h=(d=(u=CONFIG.DND5E.enrichmentLookup)==null?void 0:u.tools)==null?void 0:d[t.rollKey])==null?void 0:h.ability)||"int",a=k.buildRollConfig(t,e,{tool:t.rollKey,chooseAbility:s.configure!==!1,ability:t.config.ability||l});if(t.config.ability&&s.configure===!1){const b=(p=(g=CONFIG.DND5E.enrichmentLookup)==null?void 0:g.tools)==null?void 0:p[t.rollKey];let S=t.rollKey;if(b!=null&&b.id){const A=dnd5e.documents.Trait.getBaseItem(b.id,{indexOnly:!0});S=(A==null?void 0:A.name)||t.rollKey}const y=((m=CONFIG.DND5E.abilities[t.config.ability])==null?void 0:m.label)||t.config.ability,R=game.i18n.format("DND5E.ToolPromptTitle",{tool:S,ability:y});o.data=o.data||{},o.data.flavor=R}r.log("RollHandlers.tool #2",[a,s,o]),await j.addGroupRollFlag(o,t,c),await c.rollToolCheck(a,s,o)},concentration:async(c,t,e,s,o)=>{const i=k.buildRollConfig(t,e);await j.addGroupRollFlag(o,t,c),await c.rollConcentration(i,s,o)},attack:async(c,t,e,s,o)=>{await X.handleActivityRoll(c,f.ATTACK,t,e,s,o)},damage:async(c,t,e,s,o)=>{await X.handleActivityRoll(c,f.DAMAGE,t,e,s,o)},itemsave:async(c,t,e,s,o)=>{await X.handleActivityRoll(c,f.ITEM_SAVE,t,e,s,o)},initiative:async(c,t,e,s,o)=>{var l,a,n;if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));return}t.config.situational||(l=e.data)!=null&&l.situational,t.groupRollId;let i=c;if(!c.isToken){const u=canvas.tokens.placeables.find(d=>{var h;return((h=d.actor)==null?void 0:h.id)===c.id});if(u)i=u.actor;else{ui.notifications.error(game.i18n.format("COMBAT.NoneActive"));return}}await j.addGroupRollFlag(o,t,c),r.log("RollHandlers.initiative - START",[c,t,e,s]);try{if(s.configure){if(r.log("RollHandlers.initiative - Dialog",[]),t.config){const u=k.buildRollConfig(t,e,{ability:((n=(a=c.system.attributes)==null?void 0:a.init)==null?void 0:n.ability)||"dex"}),d={advantage:t.config.advantage||!1,disadvantage:t.config.disadvantage||!1,rollMode:t.config.rollMode||game.settings.get("core","rollMode"),rolls:u.rolls,groupRollId:t.groupRollId};r.log("RollHandlers.initiative - Setting tempConfig with groupRollId",[t.groupRollId,c.name,i.name]),await c.setFlag(_,"tempInitiativeConfig",d),await i.setFlag(_,"tempInitiativeConfig",d)}await i.rollInitiativeDialog(),await i.unsetFlag(_,"tempInitiativeConfig"),await c.unsetFlag(_,"tempInitiativeConfig")}else{r.log("RollHandlers.initiative - Not dialog");const u={rollMode:t.config.rollMode||game.settings.get("core","rollMode"),groupRollId:t.groupRollId};r.log("RollHandlers.initiative - Setting tempConfig (no dialog) with groupRollId",[t.groupRollId,c.name,i.name]),await c.setFlag(_,"tempInitiativeConfig",u),await i.setFlag(_,"tempInitiativeConfig",u);const d={createCombatants:!0,rerollInitiative:!0};await i.rollInitiative(d),await i.unsetFlag(_,"tempInitiativeConfig"),await c.unsetFlag(_,"tempInitiativeConfig")}r.log("RollHandlers.initiative - COMPLETE")}catch(u){r.error("RollHandlers.initiative - Error",[u]),$.notify("error",`Initiative roll failed: ${u.message}`)}},initiativedialog:async(c,t,e,s,o)=>X.initiative(c,t,e,s,o),deathsave:async(c,t,e,s,o)=>{const i=k.buildRollConfig(t,e);await j.addGroupRollFlag(o,t,c),await c.rollDeathSave(i,s,o)},hitdie:async(c,t,e,s,o)=>{s.configure=game.user.isGM?s.configure:!0;const i=k.buildRollConfig(t,e,{denomination:t.rollKey});r.log("RollHandlers.hitdie",[i,s,o]),await c.rollHitDie(i,s,o)},custom:async(c,t,e,s,o)=>{await X.handleCustomRoll(c,t,s,o)},async handleActivityRoll(c,t,e,s,o,i){var l,a;if(r.log("RollHandlers.handleActivityRoll",[t,e,s]),e.rollKey){const n=k.buildRollConfig(e,s),u=((a=(l=n.rolls)==null?void 0:l[0])==null?void 0:a.options)||{},d={usage:{...e.config,rolls:n.rolls,...u.attackMode&&{attackMode:u.attackMode},...u.ammunition&&{ammunition:u.ammunition},...u.mastery!==void 0&&{mastery:u.mastery}},dialog:o,message:i};r.log("handleActivityRoll - final activity config",[d]),await dt.executeActivityRoll(c,t,e.rollKey,e.activityId,d)}},async handleCustomRoll(c,t,e,s){var l,a,n,u;const o=t.rollKey;if((e==null?void 0:e.configure)===!1){try{const d=new Roll(o,c.getRollData());d.options=d.options||{},d.options.isRollRequest=((l=t.config)==null?void 0:l.isRollRequest)!==!1,await d.evaluate(),await j.addGroupRollFlag(s,t,c),await d.toMessage({speaker:ChatMessage.getSpeaker({actor:c}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${f.CUSTOM}`),rollMode:(s==null?void 0:s.rollMode)||((a=t.config)==null?void 0:a.rollMode)||game.settings.get("core","rollMode"),isRollRequest:((n=t.config)==null?void 0:n.isRollRequest)!==!1,create:(s==null?void 0:s.create)!==!1,flags:(u=s==null?void 0:s.data)==null?void 0:u.flags})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:o}))}return}new Se({formula:o,readonly:!0,actor:c,callback:async d=>{var h;try{const g=new Roll(d,c.getRollData());g.options=g.options||{},g.options.isRollRequest=!0,await g.evaluate(),await j.addGroupRollFlag(s,t,c),await g.toMessage({speaker:ChatMessage.getSpeaker({actor:c}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${f.CUSTOM}`),rollMode:t.config.rollMode,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:t.config.requestedBy||"GM",flags:(h=s==null?void 0:s.data)==null?void 0:h.flags})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:d}))}}}).render(!0)},async handleHitDieRecovery(c){const t=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in t&&(t.deltas.hitDice=t.dhd),c._getRestHitDiceRecovery({maxHitDice:c.system.attributes.hd.max,type:"long"},t),t.dhd=t.deltas.hitDice,t.longRest=!0;try{if(t.updateData&&Object.keys(t.updateData).length>0){const e=await c.update(t.updateData,{isRest:!1})}else r.log("No actor updates to perform",[]);if(t.updateItems&&t.updateItems.length>0){const e=await c.updateEmbeddedDocuments("Item",t.updateItems,{isRest:!1})}else r.log("No item updates to perform",[])}catch(e){throw r.error("Error during updates in handleHitDieRecovery:",[e]),e}return r.log("handleHitDieRecovery #3",[t]),t}};async function We(){return game.combat||(await(await Combat.create({scene:game.scenes.active.id})).activate(),$.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.combatCreated"))),game.combat}async function Ye(c,t){if(!t.combat)return c;const e=c.map(i=>t.actors.get(i)).filter(i=>i),s=[],o=new Set;for(const i of e)t.combat.getCombatantsByActor(i.id).some(n=>n.initiative!==null)&&(s.push(i.name),o.add(i.id));if(r.log("filterActorsForInitiative",[s]),s.length>0)if(await foundry.applications.api.DialogV2.confirm({window:{title:t.i18n.localize("FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle"),classes:["flash5e-dialog"]},position:{width:420,height:"auto"},content:"<p>"+t.i18n.format("FLASH_ROLLS.ui.dialogs.rerollInitiative",{actors:s.join(", ")})+"</p>",rejectClose:!1,modal:!0})){if(t.user.isGM)for(const l of o){const a=t.combat.getCombatantsByActor(l);r.log("filterActorsForInitiative - resetting initiative for combatants",[a]);for(const n of a)await n.update({initiative:null})}else r.log("filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll");return c}else{const l=c.filter(a=>!o.has(a));return l.length===0&&$.notify("info",t.i18n.localize("FLASH_ROLLS.notifications.allActorsHaveInitiative")),l}return c}class Ke{static initialize(){r.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){r.log("RollInterceptor.registerHooks"),this._registerHook(U.PRE_ROLL_ABILITY_CHECK,this._handlePreRoll.bind(this,f.ABILITY)),this._registerHook(U.PRE_ROLL_SAVING_THROW,this._handlePreRoll.bind(this,f.SAVE)),this._registerHook(U.PRE_ROLL_SKILL_V2,this._handlePreRoll.bind(this,f.SKILL)),this._registerHook(U.PRE_ROLL_TOOL_V2,this._handlePreRoll.bind(this,f.TOOL)),this._registerHook(U.PRE_ROLL_ATTACK_V2,this._handlePreRoll.bind(this,f.ATTACK)),this._registerHook(U.PRE_ROLL_DAMAGE_V2,this._handlePreRoll.bind(this,f.DAMAGE)),this._registerHook(U.PRE_ROLL_DEATH_SAVE_V2,this._handlePreRoll.bind(this,f.DEATH_SAVE)),this._registerHook(U.PRE_ROLL_HIT_DIE_V2,this._handlePreRoll.bind(this,f.HIT_DIE)),this._registerHook(U.PRE_ROLL_INITIATIVE,this._handlePreRollInitiative.bind(this,f.INITIATIVE)),this._registerHook(U.PRE_ROLL_INITIATIVE_DIALOG,this._handlePreRollInitiative.bind(this,f.INITIATIVE)),this._registerHook(U.ROLL_INITIATIVE,this._handleRollInitiative.bind(this,f.INITIATIVE))}static _registerHook(t,e){r.log("RollInterceptor._registerHook");const s=Hooks.on(t,e);this.registeredHooks.add({hookName:t,hookId:s})}static unregisterHooks(){r.log("RollInterceptor.unregisterHooks");for(const{hookName:t,hookId:e}of this.registeredHooks)Hooks.off(t,e);this.registeredHooks.clear()}static _handlePreRollInitiative(t,e,s){}static _handlePreRoll(t,e,s,o){var g,p,m,b,S,y,R,A,L;if(r.log("_handlePreRoll #0",[t,e,s,o]),!game.user.isGM||e.isRollRequest===!1)return;q.isModuleOn(_,"midi-qol");const i=(e==null?void 0:e.hookNames)||(s==null?void 0:s.hookNames)||(o==null?void 0:o.hookNames)||[],l=i.includes("initiativeDialog")||i.includes("initiative");if(t===f.ATTACK){const T=(p=(g=e.subject)==null?void 0:g.item)==null?void 0:p.getFlag(_,"tempAttackConfig");if(r.log("_handlePreRoll - is Attack roll",[(m=e.subject)==null?void 0:m.item,T]),T){r.log("_handlePreRoll - found module flags, skipping interception",[T]);return}}if(t===f.DAMAGE){const T=(S=(b=e.subject)==null?void 0:b.item)==null?void 0:S.getFlag(_,"tempDamageConfig");if(r.log("RollInterceptor._handlePreRoll - is Damage roll",[(y=e.subject)==null?void 0:y.item,T]),T){r.log("RollInterceptor._handlePreRoll - found module flags, skipping interception",[T]);return}}if(l&&t===f.ABILITY&&(r.log("RollInterceptor._handlePreRoll - Overriding ability to initiative",[i]),t=f.INITIATIVE),e!=null&&e.isRollRequest||e.sendRequest===!1||s!=null&&s.isRollRequest||o!=null&&o.isRollRequest){r.log("_handlePreRoll - skipping interception (roll request)",[e,s,o]);return}let a;if(t===f.INITIATIVE&&e instanceof Actor){if(a=e,r.log("_handlePreRoll - Initiative",[e,s,o]),(s==null?void 0:s.isRollRequest)===!1||(o==null?void 0:o.isRollRequest)===!1)return}else t===f.HIT_DIE?a=((R=s==null?void 0:s.subject)==null?void 0:R.actor)||(s==null?void 0:s.subject)||(s==null?void 0:s.actor):t===f.ATTACK||t===f.DAMAGE?a=(A=e.subject)==null?void 0:A.actor:a=((L=e.subject)==null?void 0:L.actor)||e.subject||e.actor;const n=D();if(!I.get(n.rollInterceptionEnabled.tag)||!a||a.documentName!=="Actor")return;const d=q.getActorOwner(a);if(r.log("_handlePreRoll - ownership",[d]),!d||!d.active||d.id===game.user.id){r.log("_handlePreRoll - skipping interception (owner unavailable)",[d==null?void 0:d.name,d==null?void 0:d.active]);return}t===f.ATTACK&&(o={...o,rollMode:CONST.DICE_ROLL_MODES.PUBLIC});const h=e.midiOptions!==null&&e.midiOptions!==void 0;if(h&&game.user.isGM)return r.log("_handlePreRoll - isMidiActive",[h]),this._showGMConfigDialog(a,d,t,e,s,o),!1;if(s.configure===!1||e.isRollRequest===!1||e.skipRollDialog===!0||e.fastForward===!0){r.log("_handlePreRoll - skipping interception (config flags)",[s.configure,e]);return}return r.log("_handlePreRoll - intercepting roll #1",[e,o]),this._showGMConfigDialog(a,d,t,e,s,o),!1}static _handleRollInitiative(t,e,s,o,i){r.log("_handleRollInitiative",[t,e,s,o,i])}static async _handleInitiativePreChecks(t){return!game.combat&&!await We()?!1:(await Ye([t.id],game)).length>0}static _getDialogClass(t){const e=t==null?void 0:t.toLowerCase();return[f.SKILL,f.TOOL].includes(e)?ke:e===f.HIT_DIE?Oe:e===f.ATTACK?ut:e===f.DAMAGE?ct:J}static _extractRollConfiguration(t,e,s,o){var n,u,d,h,g,p,m,b,S,y,R;const i=t==null?void 0:t.toLowerCase();let l=null;const a={rolls:[{parts:[],data:{},options:{}}]};switch(i){case f.SKILL:a.skill=e.skill,a.ability=e.ability||((n=e.subject)==null?void 0:n.ability),l=a.skill;break;case f.TOOL:a.tool=e.tool,a.ability=e.ability||((u=e.subject)==null?void 0:u.ability),l=a.tool;break;case f.ABILITY:case f.SAVE:a.ability=e.ability||((d=e.subject)==null?void 0:d.ability),l=a.ability,a.ability==="con"&&e.targetValue!==void 0&&(t=f.CONCENTRATION);break;case f.CONCENTRATION:a.ability="con",l="con";break;case f.INITIATIVE:case f.INITIATIVE_DIALOG:l=((g=(h=o.system.attributes)==null?void 0:h.init)==null?void 0:g.ability)||"dex";break;case f.HIT_DIE:a.denomination=typeof e=="string"?e:e.denomination||((p=e.subject)==null?void 0:p.denomination),l=a.denomination;break;case f.ATTACK:s!=null&&s.options&&(a.ammunition=s.options.ammunition,a.attackMode=s.options.attackMode,a.mastery=s.options.mastery),l=(b=(m=e.subject)==null?void 0:m.item)==null?void 0:b.id;break;case f.DAMAGE:a.item=(S=e.subject)==null?void 0:S.item,a.subject=e.subject,a.critical=e.critical||{},l=(R=(y=e.subject)==null?void 0:y.item)==null?void 0:R.id;break}return{rollKey:l,rollConfig:a}}static async _getDialogResult(t,e,s,o,i,l,a,n){const u=s==null?void 0:s.toLowerCase();if(i)return{sendRequest:!0,advantage:!1,disadvantage:!1,situational:"",rollMode:game.settings.get("core","rollMode")};if(!t.initConfiguration)throw r.error("DialogClass.initConfiguration not found",[t,t.name]),new Error(`DialogClass ${t.name} does not have initConfiguration method`);const d={skipRollDialog:!1,sendRequest:l};return u===f.ATTACK||u===f.DAMAGE?await t.initConfiguration([e],u,o,d,a,n):await t.initConfiguration([e],u,o,d)}static async _showGMConfigDialog(t,e,s,o,i,l){r.log("_showGMConfigDialog - config",[s,o]);const a=D(),n=I.get(a.rollRequestsEnabled.tag),u=I.get(a.skipRollDialog.tag);try{if((s==null?void 0:s.toLowerCase())===f.INITIATIVE&&!await this._handleInitiativePreChecks(t))return;const h=this._getDialogClass(s),{rollKey:g,rollConfig:p}=this._extractRollConfiguration(s,o,i,t);r.log("_showGMConfigDialog - rollConfig",[p,g]);const m=await this._getDialogResult(h,t,s,g,u,n,o,i);if(!m){r.log("_showGMConfigDialog - Dialog cancelled");return}if(!m.sendRequest||!n){r.log("_showGMConfigDialog - triggering _executeInterceptedRoll",[s,o,m]),await this._executeInterceptedRoll(t,s,o,m);return}delete o.event;const b={...o,...m,rolls:m.rolls,requestedBy:game.user.name,...s===f.ATTACK&&{chatMessage:!1}};r.log("_showGMConfigDialog - triggering _sendRollRequest",[s,b]),this._sendRollRequest(t,e,s,b)}catch(d){r.error("RollInterceptor._showGMConfigDialog - Error",[d])}}static async _executeInterceptedRoll(t,e,s,o){var g,p,m,b,S,y,R,A,L,T,E,v,w,H;r.log("RollInterceptor._executeInterceptedRoll",[t,e,s,o]);const i=e==null?void 0:e.toLowerCase(),l=((g=o.rolls)==null?void 0:g[0])||{parts:[],data:{},options:{}},a=((p=l.data)==null?void 0:p.situational)||o.situational||"";let n;switch(i){case f.SKILL:n=s.skill;break;case f.TOOL:n=s.tool;break;case f.ABILITY:case f.SAVE:n=s.ability||((m=s.subject)==null?void 0:m.ability);break;case f.HIT_DIE:n=s.denomination;break;default:n=s.ability||s.skill||s.tool||s.denomination}const u={rollKey:n,config:{advantage:o.advantage||s.advantage,disadvantage:o.disadvantage||s.disadvantage,target:o.target||o.dc||s.target,rollMode:o.rollMode||s.rollMode,situational:a,isRollRequest:!1,ability:s.ability}};if(i===f.SKILL&&!u.config.ability)u.config.ability=((S=(b=t.system.skills)==null?void 0:b[u.rollKey])==null?void 0:S.ability)||((R=(y=CONFIG.DND5E.skills)==null?void 0:y[u.rollKey])==null?void 0:R.ability);else if(i===f.TOOL&&!u.config.ability){const G=(A=t.system.tools)==null?void 0:A[u.rollKey];u.config.ability=(G==null?void 0:G.ability)||((E=(T=(L=CONFIG.DND5E.enrichmentLookup)==null?void 0:L.tools)==null?void 0:T[u.rollKey])==null?void 0:E.ability)||"int"}else(i===f.ABILITY||i===f.SAVE)&&!u.config.ability&&(u.config.ability=u.rollKey);r.log("RollInterceptor._executeInterceptedRoll - requestData",[u,s,o]);const d={configure:!1,isRollRequest:!1},h={rollMode:u.config.rollMode,create:!0,isRollRequest:!1};try{const G=f,C=X[i];r.log("RollInterceptor._executeInterceptedRoll - handler 1",[C,i,X[i]]),C?((i===f.ATTACK||i===f.DAMAGE||i===f.SAVE)&&(u.rollKey=(w=(v=s.subject)==null?void 0:v.item)==null?void 0:w.id,u.activityId=(H=s.subject)==null?void 0:H.id),r.log("RollInterceptor._executeInterceptedRoll - handler 2",[u,l,d,h]),await C(t,u,l,d,h)):r.warn(`No handler found for roll type: ${i}`)}catch(G){r.error("RollInterceptor._executeInterceptedRoll",[G])}}static async _sendRollRequest(t,e,s,o){var g;r.log("_sendRollRequest",[t,e,s,o]),r.log("_sendRollRequest - config.rolls",[o.rolls]);const i=D(),l=I.get(i.skipRollDialog.tag);let a=s==null?void 0:s.toLowerCase();a===f.INITIATIVE&&(a=f.INITIATIVE_DIALOG);let n=null,u=null;switch(a){case f.ABILITY:case f.SAVE:n=o.ability;break;case f.SKILL:n=o.skill;break;case f.TOOL:n=o.tool;break;case f.ATTACK:case f.DAMAGE:r.log("_sendRollRequest - Attack/Damage roll config",[s,o]),n=(g=o.subject.item)==null?void 0:g.id,u=o.subject.id;break;case f.HIT_DIE:n=typeof o=="string"?o:o.denomination;break;case f.INITIATIVE_DIALOG:case f.INITIATIVE:n=null;break;case f.DEATH_SAVE:n=null;break;default:r.warn(`Unknown roll type: ${s}`);return}const d={...o};delete d.subject,delete d.workflow,delete d.item,delete d.activity;const h={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:t.id,rollType:a,rollKey:n,activityId:u,rollProcessConfig:{...d,_requestedBy:game.user.name},skipRollDialog:l,targetTokenIds:Array.from(game.user.targets).map(p=>p.id),preserveTargets:I.get(i.useGMTargetTokens.tag)};if(r.log("_sendRollRequest - requestData",[e,h]),!e||!h){ui.notifications.warn("Flash Rolls: No owner found for actor "+t.name);return}if(!e.active){const p=D();I.get(p.showOfflineNotifications.tag)&&ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:e.name})),await this._executeInterceptedRoll(t,s,o,{...o,sendRequest:!1});return}Z.execForUser("handleRollRequest",e.id,h),ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:(e==null?void 0:e.name)||"Unknown",actor:t.name||"Unknown"}))}}M(Ke,"registeredHooks",new Set);class ht{static getActorStats(t){var i,l,a,n,u,d;const e=t.system,s=[];(i=e.attributes)!=null&&i.hp&&s.push({abbrev:"HP",value:e.attributes.hp.value}),(l=e.attributes)!=null&&l.ac&&s.push({abbrev:"AC",value:e.attributes.ac.value});const o=(n=(a=e.attributes)==null?void 0:a.spell)==null?void 0:n.dc;return o&&s.push({abbrev:"DC",value:o}),(d=(u=e.skills)==null?void 0:u.prc)!=null&&d.passive&&s.push({abbrev:"PRC",value:e.skills.prc.passive}),s}static getValidActorIds(t,e){return t.filter(s=>{const o=game.actors.get(s);if(!o)return!1;const i=$e(o),l=!i&&je(o);return e==="pc"&&i||e==="npc"&&l})}}class He{static async getRollConfiguration(t,e,s,o,i){const l=D(),a=I.get(l.rollRequestsEnabled.tag);if(!o&&e!==f.CUSTOM){let n;[f.SKILL,f.TOOL].includes(e)?n=ke:e===f.HIT_DIE?n=Oe:n=J;const u=await n.initConfiguration(t,e,s,{skipRollDialog:o,sendRequest:a||!1});return r.log("getRollConfiguration",[u]),u}else{const n={rolls:[{parts:[],data:{},options:{}}],advantage:!1,disadvantage:!1,rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:!0,sendRequest:a&&i.length>0};return e===f.DEATH_SAVE&&(n.target=10),n}}static async handleCustomRoll(){return await this.showCustomRollDialog()}static async showCustomRollDialog(){return r.log("showCustomRollDialog"),Se.prompt({formula:"",readonly:!1})}}class ce{static initializeDrag(t){const e=t.element.querySelector(this.DRAG_HANDLE_SELECTOR);if(!e){r.error("RollMenuDragUtil.initializeDrag - No drag handle found!");return}e.addEventListener("mousedown",s=>{this.handleDragStart(s,t)})}static handleDragStart(t,e){if(t.preventDefault(),t.stopPropagation(),e.isDragging=!0,!e.element)return;e.element.classList.add("dragging"),e.element.classList.remove("docked-right");const s=e.element.getBoundingClientRect(),o=t.clientX,i=t.clientY,l=s.left,a=s.top;e.element.parentElement,document.body.appendChild(e.element),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${a}px`,e.element.style.left=`${l}px`,e.element.style.right="auto",e.element.style.bottom="auto",e.element.style.zIndex="var(--z-index-app)",e.element.offsetHeight;const n={startX:o,startY:i,initialLeft:l,initialTop:a,currentLeft:l,currentTop:a},u=h=>this.handleDragMove(h,e,n),d=h=>this.handleDragEnd(h,e,n,u,d);document.addEventListener("mousemove",u),document.addEventListener("mouseup",d)}static handleDragMove(t,e,s){if(!e.isDragging)return;const o=t.clientX-s.startX,i=t.clientY-s.startY;s.currentLeft=s.initialLeft+o,s.currentTop=s.initialTop+i,e.element.style.inset="",e.element.style.right="auto",e.element.style.bottom="auto",e.element.style.position="fixed",e.element.style.top=`${s.currentTop}px`,e.element.style.left=`${s.currentLeft}px`;const l=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<l?e.element.classList.add("left-edge"):e.element.classList.remove("left-edge"),window.getComputedStyle(e.element),this.calculateSnapDistance(e).type!=="none"?e.element.classList.add("near-snap"):e.element.classList.remove("near-snap")}static async handleDragEnd(t,e,s,o,i){r.log("RollMenuDragUtil.handleDragEnd"),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i),e.isDragging=!1,e.element.classList.remove("dragging"),e.element.classList.remove("near-snap"),e.element.style.zIndex="";const l=this.calculateSnapDistance(e);if(l.type==="both-edges"){const a=document.querySelector("#chat-notifications");a&&a.insertBefore(e.element,a.firstChild),await this.snapToDefault(e)}else if(l.type==="right-edge"){const a=document.querySelector("#chat-notifications");a&&a.insertBefore(e.element,a.firstChild),await this.snapToRightEdge(e,s.currentTop)}else{e.isCustomPosition=!0,e.customPosition={x:s.currentLeft,y:s.currentTop,isCustom:!0,dockedRight:!1};const a=!!document.querySelector("body.crlngn-tabs");q.addCSSVars("--flash-rolls-menu-offset",a?"0px":"16px"),await this.saveCustomPosition(e.customPosition),e.element.classList.add("custom-position");const n=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<n&&e.element.classList.add("left-edge")}}static calculateSnapDistance(t){const e=document.querySelector(this.LIGHTNING_BOLT_SELECTOR);if(!e)return{type:"none",distance:1/0};const s=t.element.getBoundingClientRect(),o=e.getBoundingClientRect(),i=Math.abs(o.left-s.right),l=window.innerHeight-s.bottom;return i<=this.SNAP_DISTANCE?l<=this.SNAP_DISTANCE?{type:"both-edges",distance:0}:{type:"right-edge",distance:0}:{type:"none",distance:1/0}}static async snapToRightEdge(t,e){r.log("RollMenuDragUtil.snapToRightEdge",[e]),t.isCustomPosition=!0,t.customPosition={y:e,isCustom:!0,dockedRight:!0},t.element.classList.remove("custom-position","left-edge"),t.element.classList.add("docked-right","snapping"),t.element.style.position="fixed",t.element.style.inset="",t.element.style.left="",t.element.style.right="",t.element.style.bottom="",t.element.style.top=`${e}px`,t.element.style.zIndex="",fe(),await this.saveCustomPosition(t.customPosition),setTimeout(()=>{t.element.classList.remove("snapping")},300)}static async snapToDefault(t){r.log("RollMenuDragUtil.snapToDefault"),t.isCustomPosition=!1,t.customPosition=null,t.element.classList.remove("custom-position"),t.element.classList.remove("left-edge"),t.element.classList.add("snapping"),t.element.style.position="",t.element.style.inset="",t.element.style.left="",t.element.style.top="",t.element.style.right="",t.element.style.bottom="",t.element.style.zIndex="",fe(),await this.saveCustomPosition(null),setTimeout(()=>{t.element.classList.remove("snapping")},300)}static applyCustomPosition(t,e){if(!(!e||!e.isCustom))if(r.log("RollMenuDragUtil.applyCustomPosition",[e]),t.isCustomPosition=!0,t.customPosition=e,e.dockedRight){const s=document.querySelector("#chat-notifications");s&&s.insertBefore(t.element,s.firstChild),t.element.style.position="fixed",t.element.style.inset="",t.element.style.top=`${e.y}px`,t.element.style.left="",t.element.style.right="",t.element.style.bottom="",t.element.classList.add("docked-right"),t.element.classList.remove("custom-position","left-edge"),fe()}else{document.body.appendChild(t.element),t.element.style.position="fixed",t.element.style.inset="",t.element.style.top=`${e.y}px`,t.element.style.left=`${e.x}px`,t.element.style.right="auto",t.element.style.bottom="auto";const s=!!document.querySelector("body.crlngn-tabs");q.addCSSVars("--flash-rolls-menu-offset",s?"0px":"16px"),t.element.classList.add("custom-position"),t.element.classList.remove("docked-right");const o=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;e.x<o&&t.element.classList.add("left-edge")}}static async saveCustomPosition(t){await game.user.setFlag(Q.ID,"menuCustomPosition",t)}static loadCustomPosition(){return game.user.getFlag(Q.ID,"menuCustomPosition")||null}static async resetPosition(t){await this.snapToDefault(t)}}M(ce,"SNAP_DISTANCE",50),M(ce,"DRAG_HANDLE_SELECTOR",".drag-handle"),M(ce,"LIGHTNING_BOLT_SELECTOR","#flash-rolls-icon");class pt{static getFavoriteActors(){const t=D();return I.get(t.favoriteActorsList.tag)||[]}static isFavorite(t){return this.getFavoriteActors().some(s=>s.actorId===t)}static async addToFavorites(t){r.log("FavoriteActorsUtil.addToFavorites",[t]);const e=D(),s=this.getFavoriteActors();if(s.some(n=>n.actorId===t)){r.log("Actor already in favorites",[t]);return}const o=game.actors.get(t);if(!o){r.error("Actor not found",[t]);return}const i=game.scenes.active,l=i==null?void 0:i.tokens.find(n=>n.actorId===t),a={actorId:t,tokenId:(l==null?void 0:l.id)||null};s.push(a),await I.set(e.favoriteActorsList.tag,s),ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.actorAddedToFavorites",{actor:o.name})||`${o.name} added to Flash Rolls favorites`),this._refreshMenu()}static async removeFromFavorites(t){r.log("FavoriteActorsUtil.removeFromFavorites",[t]);const e=D(),s=this.getFavoriteActors(),o=s.filter(l=>l.actorId!==t);if(o.length===s.length){r.log("Actor not in favorites",[t]);return}await I.set(e.favoriteActorsList.tag,o);const i=game.actors.get(t);ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.actorRemovedFromFavorites",{actor:(i==null?void 0:i.name)||"Unknown"})||`${(i==null?void 0:i.name)||"Unknown"} removed from Flash Rolls favorites`),this._refreshMenu()}static async updateTokenId(t,e){r.log("FavoriteActorsUtil.updateTokenId",[t,e]);const s=D(),o=this.getFavoriteActors(),i=o.find(l=>l.actorId===t);if(!i){r.log("Actor not in favorites",[t]);return}i.tokenId=e,await I.set(s.favoriteActorsList.tag,o)}static getContextMenuOptions(t,e){return r.log("FavoriteActorsUtil.getContextMenuOptions"),e.push({name:"FLASH_ROLLS.contextMenu.toggleFavorite",icon:'<i class="fas fa-bolt"></i>',condition:s=>game.user.isGM,callback:s=>{const o=s.data("documentId");this.toggleFavorite(o)}}),e}static async toggleFavorite(t){this.isFavorite(t)?await this.removeFromFavorites(t):await this.addToFavorites(t)}static _refreshMenu(){oe.refreshIfOpen()}static async cleanupFavorites(){r.log("FavoriteActorsUtil.cleanupFavorites");const t=D(),e=this.getFavoriteActors(),s=e.filter(o=>game.actors.get(o.actorId)?!0:(r.log("Removing non-existent actor from favorites",[o.actorId]),!1));s.length!==e.length&&(await I.set(t.favoriteActorsList.tag,s),r.log("Cleaned up favorites list",[e.length-s.length,"removed"]))}}const{ApplicationV2:mt,HandlebarsApplicationMixin:Rt}=foundry.applications.api;var z;const ee=class ee extends Rt(mt){constructor(e={}){r.log("RollRequestsMenu.constructor",[e]);super(e);M(this,"_onClickOutside",e=>{if(r.log("_onClickOutside"),this.isLocked)return;const s=this.element;s&&(e.target.closest(".flash-rolls-menu")||s.contains(e.target)||e.target.closest("#flash-rolls-icon")||e.target.closest(".dialog, .app, .notification, .application")||this.close())});this.selectedActors=new Set,this.currentTab="pc",this.selectedRequestType=null,this.isLocked=!1,this.optionsExpanded=game.user.getFlag(Q.ID,"menuOptionsExpanded")??!1,this.accordionStates=game.user.getFlag(Q.ID,"menuAccordionStates")??{},this.isDragging=!1,this.isCustomPosition=!1,this.customPosition=ce.loadCustomPosition(),this._initializeFromSelectedTokens()}async _prepareContext(e){var y,R,A;r.log("_prepareContext");const s=D(),o=await super._prepareContext(e),i=game.actors.contents,l=[],a=[],n=game.scenes.active;for(const L of i){if(L.type!=="character"&&L.type!=="npc")continue;const T=(v=null)=>({id:L.id,uuid:L.uuid,name:v?v.name:L.name,img:L.img,selected:this.selectedActors.has((v==null?void 0:v.id)||L.id),crlngnStats:ht.getActorStats(L),tokenId:(v==null?void 0:v.id)||null,isToken:!!v,uniqueId:(v==null?void 0:v.id)||L.id});if(Object.entries(L.ownership).some(([v,w])=>{const H=game.users.get(v);return H&&!H.isGM&&w>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})){const v=I.get((y=s.showOnlyPCsWithToken)==null?void 0:y.tag),H=(I.get((R=s.favoriteActorsList)==null?void 0:R.tag)||[]).find(O=>O.actorId===L.id),G=!!H,C=(n==null?void 0:n.tokens.filter(O=>O.actorId===L.id))||[];if(G)if(C.length>0)C.forEach(O=>{const P=T(O);P.isFavorite=!0,l.push(P)});else{const O=T();O.isFavorite=!0,O.tokenId=H.tokenId||null,l.push(O)}else if(v)C.length>0&&C.forEach(O=>{const P=T(O);l.push(P)});else if(C.length>0)C.forEach(O=>{const P=T(O);l.push(P)});else{const O=T();l.push(O)}}else{const w=(I.get((A=s.favoriteActorsList)==null?void 0:A.tag)||[]).find(C=>C.actorId===L.id),H=!!w,G=(n==null?void 0:n.tokens.filter(C=>C.actorId===L.id))||[];if(H)if(G.length>0)G.forEach(C=>{const O=T(C);O.isFavorite=!0,a.push(O)});else{const C=T();C.isFavorite=!0,C.tokenId=w.tokenId||null,a.push(C)}else G.length>0&&G.forEach(C=>{const O=T(C);a.push(O)})}}const u=I.get(s.rollRequestsEnabled.tag),d=I.get(s.skipRollDialog.tag),h=I.get(s.groupRollsMsgEnabled.tag);I.get(s.showOnlyPCsWithToken.tag);const g=this.currentTab==="pc"?l:a,p=g.length>0&&g.every(L=>this.selectedActors.has(L.uniqueId)),m=[];for(const[L,T]of Object.entries(Q.ROLL_REQUEST_OPTIONS)){const E={id:L,name:game.i18n.localize(`FLASH_ROLLS.rollTypes.${T.name}`)||T.label,rollable:T.subList==null,hasSubList:!!T.subList,selected:this.selectedRequestType===L,expanded:this.accordionStates[L]??!1,subItems:[]};T.subList&&(E.subItems=Ne(L,this.selectedActors)),m.push(E)}const b=Ne(this.selectedRequestType,this.selectedActors),S={...o,actors:g,currentTab:this.currentTab,isPCTab:this.currentTab==="pc",isNPCTab:this.currentTab==="npc",selectedTab:this.currentTab,rollRequestsEnabled:u,skipRollDialog:d,groupRollsMsgEnabled:h,selectAllOn:p,hasSelectedActors:this.selectedActors.size>0,requestTypes:m,rollTypes:b,showNames:!0,actorsLocked:this.isLocked,optionsExpanded:this.optionsExpanded};return this._lastPreparedContext=S,S}async _renderFrame(e){const s=await super._renderFrame(e),o=this.customPosition||ce.loadCustomPosition();if(o!=null&&o.isCustom&&s)if(o.dockedRight){s.style.position="fixed",s.style.top=`${o.y}px`,s.style.left="",s.style.right="",s.style.bottom="",s.classList.add("docked-right");const i=document.querySelector("#chat-notifications");i&&i.insertBefore(s,i.firstChild),fe(),this.isCustomPosition=!0,this.customPosition=o}else{s.style.position="fixed",s.style.top=`${o.y}px`,s.style.left=`${o.x}px`,s.style.right="auto",s.style.bottom="auto",s.classList.add("custom-position");const i=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;o.x<i&&s.classList.add("left-edge"),document.body.appendChild(s);const l=!!document.querySelector("body.crlngn-tabs");q.addCSSVars("--flash-rolls-menu-offset",l?"0px":"16px"),this.isCustomPosition=!0,this.customPosition=o}else{const i=document.querySelector("#chat-notifications");i&&s&&i.insertBefore(s,i.firstChild)}return s}_onRender(e,s){if(r.log("_onRender"),super._onRender(e,s),this._attachListeners(),fe(),this.optionsExpanded){const i=this.element.querySelector(".options-toggle"),l=this.element.querySelector("li.options");this.element.querySelector(".options-toggle-btn"),i==null||i.classList.add("expanded"),l==null||l.classList.add("expanded")}setTimeout(()=>{document.addEventListener("click",this._onClickOutside,!0)},100),this._tokenControlHook=Hooks.on(N.CONTROL_TOKEN,this._onTokenControlChange.bind(this)),this._updateItemHook=Hooks.on(N.UPDATE_ITEM,this._onItemUpdate.bind(this)),this._createItemHook=Hooks.on(N.CREATE_ITEM,this._onItemUpdate.bind(this)),this._deleteItemHook=Hooks.on(N.DELETE_ITEM,this._onItemUpdate.bind(this));const o=this.element.querySelector(ce.DRAG_HANDLE_SELECTOR);o&&o.addEventListener("mousedown",i=>{ce.handleDragStart(i,this)})}_onTokenControlChange(e,s){r.log("_onTokenControlChange"),this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{const o=new Set(this.selectedActors);this._initializeFromSelectedTokens();const i=new Set([...o,...this.selectedActors]);for(const l of i)this._updateActorSelectionUI(l);this._updateSelectAllState(),this._updateRequestTypesVisibilityNoRender(),this._tokenUpdateTimeout=null},100)))}_onItemUpdate(e,s,o,i){var h,g;if(!this.rendered||!(e.type==="equipment"||((h=s.system)==null?void 0:h.equipped)!==void 0||((g=s.system)==null?void 0:g.attunement)!==void 0))return;const a=e.parent;if(!a||a.documentName!=="Actor")return;const n=this.currentTab,u=Object.entries(a.ownership).some(([p,m])=>{const b=game.users.get(p);return b&&!b.isGM&&m>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER});(n==="pc"&&u||n==="npc"&&!u&&je(a))&&(this._itemUpdateTimeout&&clearTimeout(this._itemUpdateTimeout),this._itemUpdateTimeout=setTimeout(()=>{this.render(),this._itemUpdateTimeout=null},500))}_attachListeners(){var a,n,u,d,h,g;r.log("_attachListeners");const e=this.element;(a=e.querySelector("#flash-rolls-toggle"))==null||a.addEventListener("change",this._onToggleRollRequests.bind(this)),(n=e.querySelector("#flash5e-skip-dialogs"))==null||n.addEventListener("change",this._onToggleSkipDialogs.bind(this)),(u=e.querySelector("#flash5e-group-rolls-msg"))==null||u.addEventListener("change",this._onToggleGroupRollsMsg.bind(this)),(d=e.querySelector("#flash5e-actors-all"))==null||d.addEventListener("change",this._onToggleSelectAll.bind(this)),(h=e.querySelector("#flash5e-actors-lock"))==null||h.addEventListener("click",this._onToggleLock.bind(this)),(g=e.querySelector(".options-toggle-btn"))==null||g.addEventListener("click",this._onToggleOptions.bind(this)),e.querySelectorAll(".actor-tab").forEach(p=>{p.addEventListener("click",this._onTabClick.bind(this)),p.addEventListener("dblclick",this._onTabDoubleClick.bind(this))}),e.querySelectorAll(".actor").forEach(p=>{p.addEventListener("click",this._onActorClick.bind(this))});const o=e.querySelector(".search-input");o&&o.addEventListener("input",this._onSearchInput.bind(this));const i=e.querySelector(".request-types-accordion");i&&(e.addEventListener("mouseenter",()=>{this.selectedActors.size>0&&i.classList.add("hover-visible")}),e.addEventListener("mouseleave",()=>{i.classList.remove("hover-visible")}));const l=e.querySelector(".request-types");l&&l.addEventListener("click",p=>{const m=p.target.closest(".request-type-header");if(m){const S=m.closest(".request-type-item");if(m.classList.contains("accordion-header")){this._onAccordionToggle(p);return}if(m.classList.contains("toggle")&&S&&S.classList.contains("rollable")){const y={...p,currentTarget:S};this._onRequestTypeClick(y);return}}const b=p.target.closest(".sub-item");if(b&&b.dataset.id){const S={...p,currentTarget:b};this._onRollTypeClick(S)}})}async _onToggleRollRequests(e){r.log("_onToggleRollRequests");const s=D(),o=e.target.checked;await I.set(s.rollRequestsEnabled.tag,o),Ie.updateRollRequestsIcon(o)}async _onToggleSkipDialogs(e){r.log("_onToggleSkipDialogs");const s=D(),o=e.target.checked;await I.set(s.skipRollDialog.tag,o)}async _onToggleGroupRollsMsg(e){r.log("_onToggleGroupRollsMsg");const s=D(),o=e.target.checked;await I.set(s.groupRollsMsgEnabled.tag,o)}_onToggleSelectAll(e){r.log("_onToggleSelectAll");const s=e.target.checked;this._ignoreTokenControl=!0,((this._lastPreparedContext||{}).actors||[]).forEach(a=>{const n=a.uniqueId;s?(this.selectedActors.add(n),a.tokenId?ie(a.id,!0,a.tokenId):ie(a.id,!0)):(this.selectedActors.delete(n),a.tokenId?ie(a.id,!1,a.tokenId):ie(a.id,!1))}),setTimeout(()=>{this._ignoreTokenControl=!1},200),this.render(),this._updateRequestTypesVisibility();const l=this.element.querySelector(".request-types-accordion");l&&(this.selectedActors.size>0?l.classList.add("hover-visible"):l.classList.remove("hover-visible"))}_onToggleLock(e){r.log("_onToggleLock"),e.preventDefault(),this.isLocked=!this.isLocked;const s=e.currentTarget;s.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),s.classList.add(this.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open")}async _onToggleOptions(e){r.log("_onToggleOptions"),e.preventDefault(),e.stopPropagation(),this.optionsExpanded=!this.optionsExpanded,await game.user.setFlag(Q.ID,"menuOptionsExpanded",this.optionsExpanded);const s=this.element.querySelector(".options-toggle");s&&s.classList.toggle("expanded",this.optionsExpanded);const o=this.element.querySelector("li.options");o&&o.classList.toggle("expanded",this.optionsExpanded)}_initializeFromSelectedTokens(){var s;r.log("_initializeFromSelectedTokens");const e=((s=canvas.tokens)==null?void 0:s.controlled)||[];this.selectedActors.clear();for(const o of e)if(o.actor){const i=o.id;if(this.selectedActors.add(i),this.selectedActors.size===1){const l=$e(o.actor);this.currentTab=l?"pc":"npc"}}r.log("_initializeFromSelectedTokens",[this.selectedActors])}async _onTabClick(e){const s=e.currentTarget.dataset.tab;s!==this.currentTab&&(this.selectedRequestType=null,this.currentTab=s,await this.render())}async _onTabDoubleClick(e){var s;r.log("_onTabDoubleClick"),e.preventDefault(),e.stopPropagation(),this._ignoreTokenControl=!0,this.selectedActors.clear(),(s=canvas.tokens)==null||s.releaseAll(),this.selectedRequestType=null,setTimeout(()=>{this._ignoreTokenControl=!1},200),await this.render(),this._updateRequestTypesVisibility()}_onActorClick(e){if(e.target.closest(".actor-select"))return;const s=e.currentTarget,o=s.dataset.id,i=s.dataset.actorId,l=s.dataset.tokenId;this._toggleActorSelection(o,i,l)}_toggleActorSelection(e,s,o){r.log("_toggleActorSelection"),this._ignoreTokenControl=!0,this.selectedActors.has(e)?(this.selectedActors.delete(e),o?ie(s,!1,o):ie(s,!1)):(this.selectedActors.add(e),o?ie(s,!0,o):ie(s,!0)),setTimeout(()=>{this._ignoreTokenControl=!1},100),this._updateActorSelectionUI(e),this._updateSelectAllState(),this._updateRequestTypesVisibilityNoRender();const i=this.element.querySelector(".request-types-accordion");i&&(this.selectedActors.size>0?i.classList.add("hover-visible"):i.classList.remove("hover-visible"))}_updateActorSelectionUI(e){const s=this.element.querySelector(`.actor[data-id="${e}"]`);if(!s)return;const o=s.querySelector(".actor-select"),i=this.selectedActors.has(e);o&&(o.checked=i),s.classList.toggle("selected",i),s.dataset.selected=i.toString()}_updateRequestTypesVisibility(){r.log("_updateRequestTypesVisibility"),this.render()}_updateRequestTypesVisibilityNoRender(){r.log("_updateRequestTypesVisibilityNoRender");const e=this.selectedActors.size>0,s=this.element.querySelector(".request-types");s&&(s.classList.toggle("disabled",!e),s.querySelectorAll(".request-type-item").forEach(i=>{i.classList.toggle("disabled",!e)}))}_updateSelectAllState(){r.log("_updateSelectAllState");const e=this.element.querySelector("#flash5e-actors-all"),s=this.currentTab==="pc"?"pc":"npc",o=this.element.querySelectorAll(`.${s}-actors .actor-item input[type="checkbox"]`),i=Array.from(o).filter(l=>l.checked).length;e.checked=i>0&&i===o.length,e.indeterminate=i>0&&i<o.length}_onSearchInput(e){r.log("_onSearchInput");const s=e.target.value.toLowerCase().trim(),o=this.element.querySelector(".request-types");if(!o)return;o.querySelectorAll(".request-type-item").forEach(l=>{var d;const a=((d=l.querySelector(".request-type-name"))==null?void 0:d.textContent.toLowerCase())||"",n=l.querySelectorAll(".sub-item");let u=!1;if(n.length>0){n.forEach(p=>{var S;const b=(((S=p.querySelector(".sub-item-name"))==null?void 0:S.textContent.toLowerCase())||"").includes(s);p.classList.toggle("hidden",!b),b&&(u=!0)});const h=a.includes(s),g=s===""||h||u;if(l.classList.toggle("hidden",!g),s&&u){const p=l.querySelector(".roll-types-nested"),m=l.querySelector(".accordion-toggle");p&&m&&(p.style.display="block",m.classList.add("expanded"))}}else{const h=s===""||a.includes(s);l.classList.toggle("hidden",!h)}})}async _onAccordionToggle(e){e.stopPropagation();const o=e.target.closest(".request-type-header").closest(".request-type-item"),i=o.dataset.id,l=o.querySelector(".accordion-toggle"),a=o.querySelector(".roll-types-nested");if(!a)return;const n=l.classList.contains("expanded");l.classList.toggle("expanded",!n),a.style.display=n?"none":"block",this.accordionStates[i]=!n,await game.user.setFlag(Q.ID,"menuAccordionStates",this.accordionStates)}async _onRequestTypeClick(e){const o=e.currentTarget.dataset.id,i=Q.ROLL_REQUEST_OPTIONS[o];if(!i){r.error("Unknown request type:",[o]);return}this.selectedRequestType===o?this.selectedRequestType=null:this.selectedRequestType=o,i.subList?await this.render():this.selectedRequestType&&this._triggerRoll(o,null)}_onRollTypeClick(e){r.log("_onRollTypeClick");const s=e.currentTarget.dataset.id,i=e.currentTarget.dataset.parent||this.selectedRequestType;this._triggerRoll(i,s)}async _getRollConfiguration(e,s,o,i,l){const a=D(),n=I.get(a.rollRequestsEnabled.tag);if(!i&&s!==f.CUSTOM){let u;[f.SKILL,f.TOOL].includes(s)?u=ke:s===f.HIT_DIE?u=Oe:u=J;const d=await u.initConfiguration(e,s,o,{skipRollDialog:i,sendRequest:n||!1});return r.log("_getRollConfiguration",[d]),d}else{const u={rolls:[{parts:[],data:{},options:{}}],advantage:!1,disadvantage:!1,rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:!0,sendRequest:n&&l.length>0};return s===f.DEATH_SAVE&&(u.target=10),u}}async _orchestrateRollsForActors(e,s,o,i,l,a){const n=D(),u=[],d=[],h=[];let g=foundry.utils.randomID();r.log("_orchestrateRollsForActors",[e,s,o]);const p=[],m=[];if(e.sendRequest){for(const{actor:R,owner:A}of s)A.active?h.push({actor:R,owner:A}):(I.get(n.showOfflineNotifications.tag)&&$.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:A.name})),d.push(R));m.push(...h.map(({actor:R})=>R))}else o.push(...s.map(({actor:R})=>R));m.push(...d,...o);const b=m.map(R=>R.id);p.push(...a.filter(R=>R&&R.actor&&b.includes(R.actor.id)));const S=I.get(n.groupRollsMsgEnabled.tag);S&&m.length>1&&(r.log("_orchestrateRollsForActors - generated new groupRollId",[g]),await j.createGroupRollMessage(p,i,l,e,g));for(const{actor:R,owner:A}of h){const L=S&&m.length>1?g:null;await this._sendRollRequestToPlayer(R,A,i,l,e,!0,L),u.push({actor:R,owner:A}),await we(100)}u.length>0&&this._showConsolidatedNotification(u,i,l);const y=[...d,...o];if(y.length>0){e.skipRollDialog=!0,e.groupRollId=S&&m.length>1?g:null;const R=y.map(L=>L.id),A=a.filter(L=>L&&L.actor&&R.includes(L.actor.id));await this._handleGMRollsWithTokens(A,i,l,e)}}async _triggerRoll(e,s){var m,b,S,y,R;r.log("_triggerRoll",[e,s]);const o=D(),i=Array.from(this.selectedActors),l=I.get(o.skipRollDialog.tag);let a=i.map(A=>{var v,w;let L=game.actors.get(A);if(L)return{actor:L,uniqueId:A,tokenId:null};const T=(v=canvas.tokens)==null?void 0:v.get(A);if(T!=null&&T.actor)return{actor:T.actor,uniqueId:A,tokenId:A};const E=(w=game.scenes.active)==null?void 0:w.tokens.get(A);return E!=null&&E.actor?{actor:E.actor,uniqueId:A,tokenId:A}:null}).filter(A=>A),n=a.map(A=>A.actor);const u=Q.ROLL_REQUEST_OPTIONS[e],d=(m=(u==null?void 0:u.name)||e)==null?void 0:m.toLowerCase();switch(d){case f.CUSTOM:if(s=await He.handleCustomRoll(),!s)return;break;case f.INITIATIVE:case f.INITIATIVE_DIALOG:if(await We()){r.log("_triggerRoll - initiative",[i]);const L=[],T=[];for(const C of i){let O=game.actors.get(C),P=null;if(O){if(P=((R=(y=O.getActiveTokens())==null?void 0:y[0])==null?void 0:R.id)||null,!P){L.push(O.name);continue}T.push(O.name),r.log("_triggerRoll - actor",[O.name,O,P]),game.combat.combatants.find(be=>be.tokenId===P)||(r.log("_triggerRoll - adding token to combat",[O.name,P]),await game.combat.createEmbeddedDocuments("Combatant",[{actorId:O.id,tokenId:P}]))}else{const K=((b=canvas.tokens)==null?void 0:b.get(C))||((S=game.scenes.active)==null?void 0:S.tokens.get(C));K!=null&&K.actor&&(O=K.actor,P=C,T.push(O.name)),r.log("_triggerRoll - actor from token",[O.name,O,P])}}if(T.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noTokensForInitiative")||"Cannot roll initiative: None of the selected actors have tokens on the scene.");return}L.length>0&&ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.actorsSkippedInitiative",{actors:L.join(", ")})||`Initiative skipped for actors without tokens: ${L.join(", ")}`);const E=a.filter(C=>{var P;return C.tokenId?!0:!!((P=C.actor.getActiveTokens())==null?void 0:P[0])});a.length=0,a.push(...E),n=E.map(C=>C.actor);const v=[...new Set(n.map(C=>C.id))],w=await Ye(v,game);if(r.log("_triggerRoll filteredActorIds",[w,!w.length]),!w.length)return;const H=a.filter(C=>C&&C.actor&&w.includes(C.actor.id));n=w.map(C=>game.actors.get(C)).filter(C=>C),a.length=0,a.push(...H),I.get(o.initiateCombatOnRequest.tag)&&game.combat.startCombat()}break;case f.DEATH_SAVE:n=await nt(n);break}if(!n.length){$.notify("warn","No valid actors selected");return}const{pcActors:h,npcActors:g}=rt(n),p=await He.getRollConfiguration(n,d,s,l,h);r.log("_triggerRoll config",[p]),p&&(await this._orchestrateRollsForActors(p,h,g,d,s,a),this.isLocked||setTimeout(()=>this.close(),500))}async _sendRollRequestToPlayer(e,s,o,i,l,a=!1,n=null){r.log("_sendRollRequestToPlayer #A",[o,i]);const u=D();let d=o==null?void 0:o.toLowerCase();if(d===f.ABILITY_CHECK?d=f.ABILITY:d===f.SAVING_THROW?d=f.SAVE:d===f.INITIATIVE_DIALOG&&(d=f.INITIATIVE),d===f.HIT_DIE){const p=e.system.attributes.hd;if(p.value>0)i=p.largestAvailable;else if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessage",{actors:e.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){try{r.log("About to call handleHitDieRecovery for",[e.name]);const b=await X.handleHitDieRecovery(e);r.log("handleHitDieRecovery completed",[b])}catch(b){r.error("Error calling handleHitDieRecovery:",[b])}i=e.system.attributes.hd.largestAvailable,$.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:e.name})||`Hit dice refilled for ${e.name}`)}else return}const h={...l};delete h.subject,delete h.workflow,delete h.item,delete h.activity;const g={type:"rollRequest",groupRollId:n||foundry.utils.randomID(),actorId:e.id,rollType:d,rollKey:i,activityId:null,rollProcessConfig:{...h,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(p=>p.id),preserveTargets:I.get(u.useGMTargetTokens.tag)};r.log("_sendRollRequestToPlayer - prepareMidiQOLSettings",[]),Z.execForUser("handleRollRequest",s.id,g),a||$.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:s.name,actor:e.name}))}_showConsolidatedNotification(e,s,o){var n,u,d,h,g;r.log("_showConsolidatedNotification");const i={};for(const{actor:p,owner:m}of e)i[m.id]||(i[m.id]={player:m,actors:[]}),i[m.id].actors.push(p);for(const[p,m]of Object.entries(Q.ROLL_REQUEST_OPTIONS))if(m.name===s)break;const l=s;let a=game.i18n.localize(`FLASH_ROLLS.rollTypes.${l}`)||l;if(o){const p=l.toLowerCase();if(p===f.SKILL)a=`${a} (${((n=CONFIG.DND5E.skills[o])==null?void 0:n.label)||o})`;else if(p===f.SAVING_THROW)a=`${a} (${((u=CONFIG.DND5E.abilities[o])==null?void 0:u.label)||o})`;else if(p===f.ABILITY_CHECK)a=`${a} (${((d=CONFIG.DND5E.abilities[o])==null?void 0:d.label)||o})`;else if(p===f.TOOL){const m=(g=(h=CONFIG.DND5E.enrichmentLookup)==null?void 0:h.tools)==null?void 0:g[o];if(m!=null&&m.id){const b=dnd5e.documents.Trait.getBaseItem(m.id,{indexOnly:!0});a=`${a} (${(b==null?void 0:b.name)||o})`}else a=`${a} (${o})`}else p===f.CUSTOM&&(a=`${a}: ${o}`)}$.notifyRollRequestsSent(i,a)}async _handleGMRolls(e,s,o,i){r.log("_handleGMRolls",[e,s,o,i]);for(const l of e)await this._initiateRoll(l,s,o,i),await we(100)}async _handleGMRollsWithTokens(e,s,o,i){var l,a;r.log("_handleGMRollsWithTokens",[e.length,s,o,i]);for(const n of e)if(n.tokenId){const u=((l=canvas.tokens)==null?void 0:l.get(n.tokenId))||((a=game.scenes.active)==null?void 0:a.tokens.get(n.tokenId));u?(r.log("_handleGMRollsWithTokens - Rolling for token",[n.actor,n.tokenId]),await this._initiateRollForToken(n.actor,u,s,o,i)):(r.log("_handleGMRollsWithTokens - Token not found, rolling for actor",[n.actor,n.tokenId]),await this._initiateRoll(n.actor,s,o,i))}else r.log("_handleGMRollsWithTokens - No token, rolling for actor",[n.actor]),await this._initiateRoll(n.actor,s,o,i)}async _initiateRollForToken(e,s,o,i,l){r.log("_initiateRollForToken",[e.name,s.name,o,i,l]);const a=s.controlled;a||s.control({releaseOthers:!1});try{await this._initiateRoll(e,o,i,l)}finally{a||s.release()}}async _initiateRoll(e,s,o,i){var l,a,n,u,d;r.log("_initiateRoll",[e.name,s,o,i]);try{const h=s.toLowerCase();let g=o;if(h===f.HIT_DIE){const A=e.system.attributes.hd;if(A){const L=["d6","d8","d10","d12","d20"];for(const T of L)if((((l=A[T])==null?void 0:l.value)||0)>0){g=T;break}}if(!g)if(r.log("_initiateRoll - No hit dice available",[e.name]),await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessageLocal",{actors:e.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndRoll")||"Refill & Roll",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){const T=await X.handleHitDieRecovery(e);if(r.log("Hit die recovery result",[T]),$.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:e.name})),g=e.system.attributes.hd.largestAvailable,!g){$.notify("warn",game.i18n.format("DND5E.HitDiceWarn",{name:e.name}));return}}else return}const p=((u=(n=(a=i.rolls)==null?void 0:a[0])==null?void 0:n.data)==null?void 0:u.situational)||"",m={rollKey:g,groupRollId:i.groupRollId,config:{...i,situational:p,rollMode:i.rollMode||game.settings.get("core","rollMode"),advantage:i.advantage||!1,disadvantage:i.disadvantage||!1,target:i.target}},b={configure:!i.fastForward&&!i.skipRollDialog,isRollRequest:!0},S={rollMode:i.rollMode||game.settings.get("core","rollMode"),create:i.chatMessage!==!1,isRollRequest:!0},y=((d=i.rolls)==null?void 0:d[0])||{},R=X[h];R?await R(e,m,y,b,S):$.notify("warn",`Unknown roll type: ${s}`)}catch(h){r.error("executeActorRoll",[h]),$.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name}))}}async _onClose(e){if(r.log("_onClose",[e]),!!this.element){if(this.isCustomPosition&&this.element.parentElement===document.body){const s=document.querySelector("#chat-notifications");s&&s.insertBefore(this.element,s.firstChild),this.element.style.position="",this.element.style.inset="",this.element.style.top="",this.element.style.left="",this.element.style.right="",this.element.style.bottom="",this.element.classList.remove("custom-position")}await super._onClose(e),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),this._tokenControlHook&&(Hooks.off(N.CONTROL_TOKEN,this._tokenControlHook),this._tokenControlHook=null),this._updateItemHook&&(Hooks.off(N.UPDATE_ITEM,this._updateItemHook),this._updateItemHook=null),this._createItemHook&&(Hooks.off(N.CREATE_ITEM,this._createItemHook),this._createItemHook=null),this._deleteItemHook&&(Hooks.off(N.DELETE_ITEM,this._deleteItemHook),this._deleteItemHook=null),this._tokenUpdateTimeout&&(clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=null),this._actorUpdateTimeout&&(clearTimeout(this._actorUpdateTimeout),this._actorUpdateTimeout=null),this._itemUpdateTimeout&&(clearTimeout(this._itemUpdateTimeout),this._itemUpdateTimeout=null),x(ee,z)===this&&ne(ee,z,null)}}setPosition(e={}){return r.log("setPosition"),this}async _showCustomRollDialog(){return r.log("_showCustomRollDialog"),Se.prompt({formula:"",readonly:!1})}static toggle(){r.log("RollRequestsMenu.toggle"),document.querySelectorAll("#flash-rolls-menu").forEach(s=>{r.log("Removing orphaned menu element"),s.remove()}),x(this,z)?x(this,z).rendered?x(this,z).close():(x(this,z)._initializeFromSelectedTokens(),x(this,z).render(!0)):(ne(this,z,new ee),x(this,z).render(!0))}static refreshIfOpen(){x(this,z)&&x(this,z).rendered&&(r.log("RollRequestsMenu.refreshIfOpen - refreshing menu"),x(this,z).render())}static showOnLoadIfEnabled(){r.log("RollRequestsMenu.showOnLoadIfEnabled");const e=D();I.get(e.showMenuOnLoad.tag)&&game.user.isGM&&(document.querySelectorAll("#flash-rolls-menu").forEach(i=>{r.log("Removing orphaned menu element"),i.remove()}),x(this,z)?x(this,z).rendered||(x(this,z)._initializeFromSelectedTokens(),x(this,z).render(!0),x(this,z).isLocked=!0):(ne(this,z,new ee),x(this,z).render(!0),x(this,z).isLocked=!0))}};z=new WeakMap,ae(ee,z,null),M(ee,"DEFAULT_OPTIONS",{id:"flash-rolls-menu",classes:["flash-rolls-menu"],tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:{}}),M(ee,"PARTS",{main:{template:`modules/${Q.ID}/templates/requests-menus.hbs`}});let oe=ee;class Ie{static addSidebarControls(t,e){if(r.log("addSidebarControls",[t,e]),!game.user.isGM||!t||t.id!=="sidebar")return;const s=document.querySelector("#roll-privacy");if(r.log("addSidebarControls",[s]),!s||s.querySelector(".flash-rolls-icon"))return;const o=D(),i=I.get(o.rollRequestsEnabled.tag),l=document.createElement("button");l.id="flash-rolls-icon",l.setAttribute("data-tooltip-direction","RIGHT"),l.className=`ui-control icon chat-control-icon flash-rolls-icon${i?" active":""}`,l.title=game.i18n.localize("FLASH_ROLLS.ui.menus.rollRequestsTitle"),l.innerHTML=`<i class="fas fa-bolt${i?"":"-slash"}"></i>`;const a=s.firstChild;a?a.parentNode.insertBefore(l,a):s.insertBefore(l,s.firstChild),r.log("addSidebarControls",[a,l]),l.addEventListener("click",n=>{n.stopPropagation(),n.preventDefault(),oe.toggle()})}static updateRollRequestsIcon(t){const e=document.querySelector("#flash-rolls-icon i");e&&(e.className=`fas fa-bolt${t?"":"-slash"}`)}}const te=class te{static initialize(){Hooks.once(N.INIT,this._onInit.bind(this)),Hooks.once(N.READY,this._onReady.bind(this)),Hooks.once(N.GET_ACTOR_CONTEXT_OPTIONS,(t,e)=>{r.log("getActorContextOptions hook",[t,e]),game.user.isGM&&e.push({name:"FLASH_ROLLS.contextMenu.toggleFavorite",icon:'<i class="fas fa-bolt"></i>',callback:s=>{r.log("Context menu callback li:",[s]);const i=s.dataset.entryId;r.log("Actor ID from context menu:",[i]),i&&pt.toggleFavorite(i)},condition:s=>game.user.isGM})})}static _onInit(){D(),document.body.classList.add("flash5e"),I.registerSettings(),ue.initialize(),this._registerHooks()}static _onReady(){var t;I.registerSettingsMenu(),Ie.addSidebarControls(ui.sidebar,(t=ui.sidebar)==null?void 0:t.element),re.isModuleActive("midi-qol")?(r.log("HooksUtil.initialize",["midi-qol is active. Awaiting for it to be ready..."]),Hooks.once(tt.READY,this._initModule.bind(this))):(r.log("HooksUtil.initialize",["midi-qol is NOT active. Starting..."]),this._initModule())}static async _initModule(){const t=D();I.get(t.debugMode.tag)&&(CONFIG.debug.hooks=!0),await j.initialize(),game.user.isGM?(Ke.initialize(),this._registerGMHooks(),oe.showOnLoadIfEnabled()):(ue.getDiceConfig(),this._registerPlayerHooks()),Fe(Me())}static _registerHooks(){this._registerHook(N.RENDER_SIDEBAR,this._onRenderSidebar.bind(this)),this._registerHook(N.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessage.bind(this)),this._registerHook(N.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageFlavor.bind(this)),this._registerHook(N.RENDER_CHAT_MESSAGE,this._onRenderChatMessageHTML.bind(this)),this._registerHook(N.CHANGE_SIDEBAR_TAB,this._onSidebarUpdate.bind(this)),this._registerHook(N.COLLAPSE_SIDE_BAR,this._onSidebarUpdate.bind(this)),this._registerHook(N.REFRESH_MEASURED_TEMPLATE,this.onRefreshTemplate.bind(this)),this._registerHook(U.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this)),this._registerHook(U.RENDER_SKILL_TOOL_ROLL_DIALOG,this._onRenderSkillToolDialog.bind(this)),this._registerHook(U.PRE_USE_ACTIVITY,this._onPreUseActivity.bind(this)),this._registerHook(U.POST_USE_ACTIVITY,this._onPostUseActivity.bind(this)),this._registerHook(U.PRE_ROLL_HIT_DIE_V2,this._onPreRollHitDieV2.bind(this)),this._registerHook(U.POST_ROLL_CONFIG,this._onPostRollConfig.bind(this))}static _registerGMHooks(){this._registerHook(N.USER_CONNECTED,this._onUserConnected.bind(this)),this._registerHook(N.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageGM.bind(this)),this._registerHook(U.PRE_ROLL_V2,this._onPreRoll.bind(this)),this._registerHook(N.CREATE_TOKEN,this._onTokenChange.bind(this)),this._registerHook(N.DELETE_TOKEN,this._onTokenChange.bind(this)),this._registerHook(N.UPDATE_SETTING,this._onSettingUpdate.bind(this)),this._registerHook(N.UPDATE_SCENE,this._onSceneUpdate.bind(this)),this._registerHook(N.UPDATE_ACTOR,this._onActorUpdate.bind(this)),game.users.forEach(t=>{this._onUserConnected(t)})}static _registerPlayerHooks(){this._registerHook(U.PRE_ROLL_INITIATIVE_DIALOG,this._onPreRollInitiativeDialog.bind(this)),this._registerHook(U.PRE_ROLL_ATTACK_V2,this._onPreRollAttackV2.bind(this)),this._registerHook(U.PRE_ROLL_DAMAGE_V2,this._onPreRollDamageV2.bind(this)),Hooks.on(U.PRE_ROLL_ABILITY_CHECK,(t,e,s)=>{r.log("_onPreRollAbilityCheckV2",[t,e,s]),t.isRollRequest&&(e.configure=!0)})}static _onSidebarUpdate(t){r.log("_onSidebarUpdate",[t]),Fe(Me())}static _onPostRollConfig(t,e,s,o){e._showRequestedBy&&t.length>0&&(o.data=o.data||{},o.data._showRequestedBy=!0,o.data._requestedBy=e._requestedBy)}static _onPreCreateChatMessage(t,e,s,o){var i,l,a,n,u,d,h,g,p,m;if(e._showRequestedBy&&((i=e.rolls)==null?void 0:i.length)>0){const b=e._requestedBy||"GM",S=game.i18n.format("FLASH_ROLLS.chat.requestedBy",{gm:b}),y=e.flavor||"";e.flavor=y?`${y} ${S}`:S}if((a=(l=e.flags)==null?void 0:l[_])!=null&&a.groupRollId&&r.log("_onPreCreateChatMessage - Found groupRollId in data flags",[e]),((n=e.rolls)==null?void 0:n.length)>0||(d=(u=e.flags)==null?void 0:u.core)!=null&&d.initiativeRoll){const b=e.speaker,S=b==null?void 0:b.actor;if(S){let y=game.actors.get(S);if(!y&&(b!=null&&b.token)){const R=canvas.tokens.get(b.token);R!=null&&R.actor&&(y=R.actor,r.log("_onPreCreateChatMessage - Using token actor from speaker",[y.name,y.id]))}if(!y){r.log("_onPreCreateChatMessage - No actor found",[S,b]);return}if(game.user.isGM){const R=y.isToken?(h=y.actor)==null?void 0:h.id:y.id,A=[S,R].filter(L=>L);for(const[L,T]of j.pendingRolls.entries()){const E=T.actorEntries||(T.actors?T.actors.map(v=>({actorId:v})):[]);if(A.some(v=>E.some(w=>w.actorId===v))){e.flags=e.flags||{},e.flags[_]=e.flags[_]||{},e.flags[_].groupRollId=L,r.log("_onPreCreateChatMessage - Added groupRollId flag (GM)",[L,S]);break}}}else{let R=y.getFlag(_,"tempGroupRollId");if(!R&&y.isToken){const L=game.actors.get((g=y.actor)==null?void 0:g.id);L&&(R=L.getFlag(_,"tempGroupRollId"),r.log("_onPreCreateChatMessage - Checking base actor for tempGroupRollId",[L.id,R]))}if(R&&(y.unsetFlag(_,"tempGroupRollId"),y.isToken)){const L=game.actors.get((p=y.actor)==null?void 0:p.id);L&&L.unsetFlag(_,"tempGroupRollId")}let A=y.getFlag(_,"tempInitiativeConfig");if(!A&&y.isToken){const L=game.actors.get((m=y.actor)==null?void 0:m.id);L&&(A=L.getFlag(_,"tempInitiativeConfig"))}(A!=null&&A.groupRollId||R)&&(e.flags=e.flags||{},e.flags[_]=e.flags[_]||{},e.flags[_].groupRollId=R||(A==null?void 0:A.groupRollId)||"")}}}}static _onPreCreateChatMessageFlavor(t,e,s,o){var i,l;if(((i=e.rolls)==null?void 0:i.length)>0&&e.rolls[0])try{const a=e.rolls[0];(l=a.options)!=null&&l._customFlavor&&(e.flavor=a.options._customFlavor)}catch(a){r.error("_onPreCreateChatMessageFlavor",[a])}}static _onRenderRollConfigDialog(t,e,s){var i,l,a,n,u;if(r.log("_onRenderRollConfigDialog #0",[t,s]),t._flashRollsApplied)return;if(((l=(i=t.config)==null?void 0:i.hookNames)==null?void 0:l.includes("initiativeDialog"))||((n=(a=t.element)==null?void 0:a.id)==null?void 0:n.includes("initiative"))){const d=(u=t.config)==null?void 0:u.subject;if(!d)return;if(d.getFlag(_,"tempInitiativeConfig")){t._flashRollsApplied=!0;const g=e.querySelector('input[name*="situational"]');setTimeout(()=>{g.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},50)}return}else e.querySelectorAll('input[name*="situational"]').forEach((h,g)=>{var p,m,b,S;!h.value&&((S=(b=(m=(p=t.config)==null?void 0:p.rolls)==null?void 0:m[0])==null?void 0:b.data)!=null&&S.situational)&&(h.value=t.config.rolls[0].data.situational),r.log("_onRenderRollConfigDialog #1",[h.value,t.config.rolls[0]]),h.value&&(t._flashRollsApplied=!0,setTimeout(()=>{var y,R,A;h.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1})),(A=(R=(y=t.config)==null?void 0:y.rolls)==null?void 0:R[0])!=null&&A.data&&delete t.config.rolls[0].data.situational},50))})}static _onPreCreateChatMessageGM(t,e,s,o){}static _onRenderChatMessageHTML(t,e,s){j.interceptRollMessage(t,e,s),this._addSelectTargetsButton(t,e)}static _addSelectTargetsButton(t,e){var o,i,l;if(r.log("_addSelectTargetsButton #0",[t,e,e.querySelector(".message-content")]),((l=(i=(o=t.flags)==null?void 0:o.dnd5e)==null?void 0:i.roll)==null?void 0:l.type)!=="damage"||e.querySelector(".select-targeted"))return;const s=document.createElement("button");s.className="select-targeted",s.type="button",s.setAttribute("data-tooltip-direction","LEFT"),s.setAttribute("data-tooltip","Select Targeted"),s.innerHTML='<i class="fas fa-crosshairs"></i>',s.addEventListener("click",a=>{a.preventDefault(),this._selectTargetedTokens(a)}),e.querySelector(".message-content").appendChild(s),t.update({content:e})}static _selectTargetedTokens(t){const e=t.currentTarget.closest(".chat-message"),s=e.querySelectorAll("[data-target-uuid]");if(s.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noTargetedTokens"));return}r.log("_selectTargetedTokens",[e,s,canvas.tokens.placeables,game.scenes.active]);for(let o=0;o<s.length;o++){const l=s[o].dataset.targetUuid.split("Actor.")[1],a=canvas.tokens.placeables.find(n=>n.document.actorId===l);a==null||a.control({releaseOthers:o===0})}}static _onUserConnected(t){t.active&&t.id!==game.user.id&&ue.requestDiceConfigFromUser(t.id)}static _onTokenChange(t,e,s){this._tokenChangeTimeout&&clearTimeout(this._tokenChangeTimeout),this._tokenChangeTimeout=setTimeout(()=>{r.log("HooksUtil._onTokenChange - Re-rendering roll requests menu due to token create/delete"),oe.refreshIfOpen(),this._tokenChangeTimeout=null},200)}static _onSettingUpdate(t,e,s,o){const i=D(),l={ID:"flash-rolls-5e"};(t.key===`${l.ID}.${i.showOnlyPCsWithToken.tag}`||t.key===`${l.ID}.${i.favoriteActorsList.tag}`)&&(r.log("HooksUtil._onSettingUpdate - Re-rendering roll requests menu due to setting change",[t.key]),oe.refreshIfOpen())}static _onSceneUpdate(t,e,s,o){e.active===!0&&(r.log("HooksUtil._onSceneUpdate - Re-rendering roll requests menu due to active scene change"),oe.refreshIfOpen())}static _onActorUpdate(t,e,s,o){var a,n,u,d,h,g,p,m,b,S,y,R;const i=e["==ownership"]!==void 0;!((n=(a=e.system)==null?void 0:a.attributes)!=null&&n.hp||(d=(u=e.system)==null?void 0:u.attributes)!=null&&d.ac||(p=(g=(h=e.system)==null?void 0:h.attributes)==null?void 0:g.spell)!=null&&p.dc||(b=(m=e.system)==null?void 0:m.skills)!=null&&b.prc||(S=e.system)!=null&&S.abilities||(R=(y=e.system)==null?void 0:y.attributes)!=null&&R.prof)&&!i||(this._actorUpdateTimeout&&clearTimeout(this._actorUpdateTimeout),this._actorUpdateTimeout=setTimeout(()=>{oe.refreshIfOpen(),this._actorUpdateTimeout=null},100))}static _onRenderApplicationV2(t,e,s){r.log("_onRenderApplicationV2",[t,e,s])}static _onRenderSidebar(t,e,s){r.log("_onRenderSidebar",[t,e]),game.ready&&Ie.addSidebarControls(t,e)}static _registerHook(t,e){const s=Hooks.on(t,e);return this.registeredHooks.set(`${t}_${s}`,s),s}static unregisterAll(){this.registeredHooks.forEach((t,e)=>{const s=e.split("_")[0];Hooks.off(s,t)}),this.registeredHooks.clear()}static isRegistered(t){for(const e of this.registeredHooks.keys())if(e.startsWith(`${t}_`))return!0;return!1}static _onPreRoll(t,e,s,o){r.log("_onPreRoll #0",[t,e,s,o])}static _onPreRollHitDieV2(t,e,s){if(r.log("_onPreRollHitDieV2 triggered",[t,e,s]),t.rolls&&t.rolls.length>1){const o=[];for(let i=0;i<t.rolls.length;i++){const l=t.rolls[i];l&&l.data&&l.data.situational&&o.push(l.data.situational)}if(o.length>0){t.rolls[0].data||(t.rolls[0].data={});const i=[...new Set(o)];t.rolls[0].data.situational=i.map(l=>{const a=l.toString().trim();return a.startsWith("-")?`(${a})`:a.startsWith("+")?`${a.substring(1)}`:`${a}`}).join(" + "),game.user.isGM&&!t.rolls[0].parts.find(l=>l.includes("@situational"))&&t.rolls[0].parts.push("@situational")}t.rolls=t.rolls.slice(0,1),r.log("Cleaned up hit die rolls",t.rolls)}}static _onPreRollInitiativeDialog(t,e,s){var l,a,n,u,d;const i=t.subject.getFlag(_,"tempInitiativeConfig");r.log("_onPreRollInitiativeDialog triggered",[t,i,e,s]),t.advantage=(i==null?void 0:i.advantage)||t.advantage||!1,t.disadvantage=(i==null?void 0:i.disadvantage)||t.disadvantage||!1,t.rollMode=(i==null?void 0:i.rollMode)||t.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,s.rollMode=(i==null?void 0:i.rollMode)||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,(n=(a=(l=i.rolls)==null?void 0:l[0])==null?void 0:a.data)!=null&&n.situational&&((d=(u=t.rolls)==null?void 0:u[0])!=null&&d.data)&&(t.rolls[0].data.situational=i.rolls[0].data.situational)}static _onPreRollAttackV2(t,e,s){var i,l;r.log("_onPreRollAttackV2 triggered",[t,e,s]);const o=(l=(i=t.subject)==null?void 0:i.item)==null?void 0:l.getFlag(_,"tempAttackConfig");if(o){if(r.log("_onPreRollAttackV2 - Found stored request config from flag",[o]),o.isRollRequest===!1||o.skipRollDialog===!0||o.sendRequest===!1){r.log("_onPreRollAttackV2 - Not a roll request, skipping",[o]);return}o.attackMode&&(t.attackMode=o.attackMode),o.ammunition&&(t.ammunition=o.ammunition),o.mastery!==void 0&&(t.mastery=o.mastery),t.advantage=o.advantage||!1,t.disadvantage=o.disadvantage||!1,s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,o.situational&&((!t.rolls||t.rolls.length===0)&&(t.rolls=[{parts:[],data:{},options:{}}]),t.rolls[0].data||(t.rolls[0].data={}),t.rolls[0].data.situational=o.situational),r.log("_onPreRollAttackV2 - Applied stored configuration to attack roll",[t,s])}}static _onPreRollDamageV2(t,e,s){var i,l;r.log("_onPreRollDamageV2 triggered",[t,e,s]);const o=(l=(i=t.subject)==null?void 0:i.item)==null?void 0:l.getFlag(_,"tempDamageConfig");if(o){if(r.log("_onPreRollDamageV2 - Found stored request config from flag",[o,o.situational]),o.isRollRequest===!1||o.skipRollDialog===!0||o.sendRequest===!1){r.log("_onPreRollDamageV2 - Not a roll request, skipping",[o]);return}o.critical&&(t.critical=o.critical),s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,o.situational&&((!t.rolls||t.rolls.length===0)&&(t.rolls=[{parts:[],data:{},options:{}}]),t.rolls[0].data||(t.rolls[0].data={}),t.rolls[0].data.situational=o.situational),r.log("_onPreRollDamageV2 - Applied stored configuration to damage roll",[t,s])}}static _onPreUseActivity(t,e,s,o){r.log("_onPreUseActivity triggered",[t,e,s,o]);const i=D(),l=I.get(i.rollRequestsEnabled.tag),a=I.get(i.rollInterceptionEnabled.tag);if(r.log("_onPreUseActivity - Settings",[l,a]),t.item.unsetFlag(_,"tempAttackConfig"),t.item.unsetFlag(_,"tempDamageConfig"),t.item.unsetFlag(_,"tempSaveConfig"),!game.user.isGM||!l||!a)return;const n=t.actor;if(!n)return;switch(I.get(i.consumptionConfigMode.tag)){case 1:s.configure=!1;break;case 2:s.configure=game.user.isGM;break;case 3:s.configure=!game.user.isGM;break;default:s.configure=!0;break}const d=q.getActorOwner(n);d&&d.active&&!d.isGM&&(r.log("Preventing usage message for player-owned actor",[n.name]),o.create=!1)}static _onPostUseActivity(t,e,s,o){var i;if(game.user.isGM&&t.type===Pe.SAVE){r.log("_onPostUseActivity triggered",[t.damage]);const l=D(),a=I.get(l.skipRollDialog.tag);t.damage&&((i=t.damage.parts)==null?void 0:i.length)>0&&t.rollDamage(e,{...s,configure:!a},o)}}static _onRenderSkillToolDialog(t,e,s){var i,l;if(r.log("_onRenderSkillToolDialog triggered",[t]),t._abilityFlavorFixed)return;const o=e.querySelector('select[name="ability"]');if(o&&(i=t.config)!=null&&i.isRollRequest&&(l=t.config)!=null&&l.ability){const a=o.value,n=t.config.ability;a===n&&(t._abilityFlavorFixed=!0,setTimeout(()=>{const u=new Event("change",{bubbles:!0,cancelable:!0});o.dispatchEvent(u)},50))}}static onRefreshTemplate(t,e){if(!t.isOwner)return;const s=`refresh-template-${t.id}`,o=D(),i=I.get(o.templateAutoTarget.tag);te.throttleTimers[s]&&clearTimeout(te.throttleTimers[s]),te.throttleTimers[s]=setTimeout(()=>{let l=3;switch(i){case 1:l=3;break;case 2:l=0;break;default:return}game.user.targets.forEach(n=>n.setTarget(!1,{releaseOthers:!1}));const a=[];for(let n of canvas.tokens.placeables)n.document.disposition<=l&&t.shape.contains(n.center.x-t.x,n.center.y-t.y)&&a.push(n);a.forEach((n,u)=>{n.setTarget(!0,{releaseOthers:u===0,groupSelection:!0})}),a.length>0&&game.user.broadcastActivity({targets:game.user.targets.ids}),delete te.throttleTimers[s]},50)}};M(te,"registeredHooks",new Map),M(te,"midiTimeout",null),M(te,"throttleTimers",{});let Ce=te;class ve{static async handleRequest(t){var o;const e=q.isModuleOn(_,"midi-qol");if(r.log("handleRequest",[t]),game.user.isGM)return;const s=game.actors.get(t.actorId);!s||!s.isOwner||(e&&t.rollProcessConfig.midiOptions&&(t.rollProcessConfig.midiOptions={...t.rollProcessConfig.midiOptions,fastForward:!1,fastForwardAttack:!1,dialogOptions:{...t.rollProcessConfig.midiOptions.dialogOptions,fastForward:!1,fastForwardAttack:!1},workflowOptions:{...t.rollProcessConfig.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1}}),t.preserveTargets&&((o=t.targetTokenIds)==null?void 0:o.length)>0&&game.user.targets.size===0&&at(t.targetTokenIds),$.notify("info","",{batch:!0,batchData:{actor:s.name,rollType:t.rollType,rollKey:t.rollKey,gm:t.rollProcessConfig._requestedBy||"GM"}}),ve.executePlayerRollRequest(s,t))}static async executePlayerRollRequest(t,e){var o,i;const s=D();I.get(s.publicPlayerRolls.tag),r.log("executePlayerRollRequest",[t,e]),r.log("executePlayerRollRequest - groupRollId check",[e.groupRollId,typeof e.groupRollId]);try{const l=(o=e.rollType)==null?void 0:o.toLowerCase(),a=((i=e.rollProcessConfig.rolls)==null?void 0:i[0])||{parts:[],data:{},options:{}},u={configure:!(game.user.isGM?e.skipRollDialog:!1)},d=e.rollProcessConfig.rollMode,h=game.settings.get("core","rollMode"),p={rollMode:d||h,create:e.rollProcessConfig.chatMessage!==!1},m={rollKey:e.rollKey,activityId:e.activityId,config:e.rollProcessConfig,groupRollId:e.groupRollId},b=X[l];b?await b(t,m,a,u,p):(r.warn(`No handler found for roll type: ${l}`),$.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:t.name||"Unknown Actor"})))}catch(l){r.error("Error executing roll request:",[l]),$.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:t.name||"Unknown Actor"}))}}}class de{static init(){Z.initialize(de.registerSocketCalls),Ce.initialize()}static getDiceConfig(){return ue.getDiceConfig()}static receiveDiceConfig(t,e){ue.receiveDiceConfig(t,e)}static async handleRollRequest(t){return r.log("Main.handleRollRequest",t),ve.handleRequest(t)}static registerSocketCalls(){Z.registerCall(_e.getDiceConfig,de.getDiceConfig),Z.registerCall(_e.receiveDiceConfig,de.receiveDiceConfig),Z.registerCall(_e.handleRollRequest,de.handleRollRequest)}}de.init();
//# sourceMappingURL=flash-rolls-5e.js.map
