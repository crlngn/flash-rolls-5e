var Ge=Object.defineProperty;var ye=a=>{throw TypeError(a)};var Pe=(a,e,t)=>e in a?Ge(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var N=(a,e,t)=>Pe(a,typeof e!="symbol"?e+"":e,t),ge=(a,e,t)=>e.has(a)||ye("Cannot "+t);var Q=(a,e,t)=>(ge(a,e,"read from private field"),t?t.call(a):e.get(a)),fe=(a,e,t)=>e.has(a)?ye("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(a):e.set(a,t),he=(a,e,t,i)=>(ge(a,e,"write to private field"),i?i.call(a,t):e.set(a,t),t),Ce=(a,e,t)=>(ge(a,e,"access private method"),t);const J={select:"select",checkbox:"checkbox"},Z={client:"client",world:"world"},O=()=>({debugMode:{tag:"debug-mode",label:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:J.checkbox,default:!0,scope:Z.client,config:!0},rollRequestsEnabled:{tag:"flash-rolls-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:J.checkbox,default:!0,scope:Z.world,config:!0},consumptionConfigMode:{tag:"consumption-config-mode",label:game.i18n.localize("CRLNGN_ROLLS.settings.consumptionConfigMode.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.consumptionConfigMode.hint"),propType:Number,inputType:J.select,choices:{1:"Skip dialog for player and GM",2:"Skip dialog for player",3:"Skip dialog for GM",4:"Do not skip dialog"},default:1,scope:Z.world,config:!0},skipRollDialog:{tag:"skip-roll-dialog",label:game.i18n.localize("CRLNGN_ROLLS.settings.skipRollDialog.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.skipRollDialog.hint"),propType:Boolean,inputType:J.checkbox,default:!1,scope:Z.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:J.checkbox,default:!1,scope:Z.world,config:!0},rollInterceptionEnabled:{tag:"roll-interception-enabled",label:game.i18n.localize("CRLNGN_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:J.checkbox,default:!0,scope:Z.world,config:!0},publicPlayerRolls:{tag:"public-player-rolls",label:game.i18n.localize("CRLNGN_ROLLS.settings.publicPlayerRolls.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.publicPlayerRolls.hint"),propType:Boolean,inputType:J.checkbox,default:!0,scope:Z.world,config:!0},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("CRLNGN_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("CRLNGN_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:J.checkbox,default:!0,scope:Z.world,config:!0}}),v="flash-rolls-5e",ne=["%cFlash Rolls 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],Re={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest"},d={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",ATTACK:"attack",CONCENTRATION:"concentration",CUSTOM:"custom",DEATH_SAVE:"deathsave",FORMULA:"formula",DAMAGE:"damage",HEALING:"healing",HIT_DIE:"hitdie",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",ITEM_SAVE:"itemsave",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool"},qe={ABILITY_CHECK:{name:d.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:d.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:d.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:d.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:d.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:d.INITIATIVE,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:d.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:d.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:d.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},j={ID:v,ROLL_REQUEST_OPTIONS:qe},X={INIT:"init",READY:"ready",CHANGE_SIDEBAR_TAB:"changeSidebarTab",RENDER_SIDEBAR:"renderSidebar",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",COLLAPSE_SIDE_BAR:"collapseSidebar"},Fe={READY:"socketlib.ready"},G={PRE_USE_ACTIVITY:"dnd5e.preUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG:"dnd5e.preRollInitiativeDialog",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",ROLL_INITIATIVE:"dnd5e.rollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog",RENDER_SKILL_TOOL_ROLL_DIALOG:"renderSkillToolRollConfigurationDialog"},oe=class oe{static log(e="",t=[],i=!1){try{const s=game.settings.get(v,"debug-mode")||oe.debugOn;if(!(i||s))return;const l=Array.isArray(t)?t:[t];console.log(...ne,e,...l)}catch{if(i||oe.debugOn){const o=Array.isArray(t)?t:[t];console.log(...ne,e,...o)}}}static warn(e="",t=[]){const i=Array.isArray(t)?t:[t];console.warn(...ne,e,...i)}static error(e,t=[],i={ui:!1,console:!0,permanent:!1}){var o;const s=Array.isArray(t)?t:[t];i.ui&&((o=ui.notifications)==null||o.error(e,{localize:!0,permanent:i.permanent})),i.console&&console.error(...ne,e,...s)}};N(oe,"debugOn",!1);let r=oe;const w=class w{static serializeForTransport(e,t=!1){return r.log("serializeForTransport",[e,t]),e==null||t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(i=>i instanceof Roll?i.toJSON():i)),e}static deserializeFromTransport(e,t=!1){r.log("deserializeFromTransport",[e,t]);let i={...e};if(!e)return i;if(t&&e.rolls&&e.rolls.length>0){const s=i.rolls.map(o=>{let l=o;return typeof o=="string"?l=Roll.fromJSON(o):l=Roll.fromJSON(JSON.stringify(o)),l});return i.rolls=[...s],i}return i}};N(w,"socket"),N(w,"_activeExecutions",new Map),N(w,"initialize",e=>{r.log("initialize",[e]),Hooks.once(Fe.READY,()=>{if(typeof socketlib>"u"){r.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("CRLNGN_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{w.socket=socketlib.registerModule(v),e&&e()}catch{}})}),N(w,"registerCall",(e,t)=>{r.log("registerCall",[e]),w.socket&&w.socket.register(e,t)}),N(w,"sendMessage",(e,t)=>{r.log("sendMessage",[e]),t&&t()}),N(w,"execForGMs",async(e,...t)=>{if(r.log("execForGMs",[e,...t]),!!w.socket)return await w.socket.executeForAllGMs(e,...t)}),N(w,"execForAll",async(e,...t)=>{if(w.socket)return await w.socket.executeForEveryone(e,...t)}),N(w,"execForUser",async(e,t,...i)=>{if(r.log("execForUser",[e,t,...i]),!w.socket)return;if(t===game.user.id)return null;const s=`${e}-${t}`;if(w._activeExecutions.has(s))return null;w._activeExecutions.set(s,!0);try{return await w.socket.executeAsUser(e,t,...i)}catch{return null}finally{w._activeExecutions.delete(s)}});let U=w;class te{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const e=game.settings.storage.get("client");return this.diceConfig=e["core.diceConfiguration"]||"",this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){U.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(e,t){var i,s;((i=game.user)!=null&&i.isGM||e===((s=game.user)==null?void 0:s.id))&&(this.playerDiceConfigs[e]=t?JSON.parse(t):{})}static getUserDiceConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?this.diceConfig:this.playerDiceConfigs[e]||{}}static requestDiceConfigFromUser(e){U.execForUser("getDiceConfig",e)}static requestDiceConfigFromAllPlayers(){var e;(e=game.user)!=null&&e.isGM&&game.users.forEach(t=>{t.active&&!t.isGM&&t.id!==game.user.id&&this.requestDiceConfigFromUser(t.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?!!this.diceConfig:!!this.playerDiceConfigs[e]}}N(te,"diceConfig",{}),N(te,"playerDiceConfigs",{});class E{static registerSettings(){const e=O();Object.entries(e).forEach(async i=>{const s=i[1],o={name:s.label,hint:s.hint,default:s.default,type:s.propType,scope:s.scope,config:s.config,requiresReload:s.requiresReload||!1,onChange:l=>E.apply(s.tag,l)};s.choices&&(o.choices=s.choices),await game.settings.register(v,s.tag,o),(E.get(s.tag)===void 0||E.get(s.tag)===null)&&E.set(s.tag,s.default)})}static get(e,t=v){if(!e)return null;let i=!1;if(t===v)i=game.settings.get(t,e);else{let o=game.settings.storage.get("client")[`${t}.${e}`];o===void 0&&(o=game.settings.storage.get("world").getSetting(`${t}.${e}`),i=o==null?void 0:o.value)}return i}static set(e,t,i=v){if(!e)return!1;let s=game.settings.storage.get("client")[`${i}.${e}`];s||(s=game.settings.storage.get("world").getSetting(`${i}.${e}`));try{game.settings.set(i,e,t)}catch{}return!0}static apply(e,t){const i=O();switch(e){case i.rollRequestsEnabled.tag:E.applyRollRequestsEnabled(t);break}}static applyRollRequestsEnabled(e){const t=document.querySelector(".chat-controls .flash-rolls-icon");t&&(e?t.classList.add("active"):t.classList.remove("active"))}}var ce,Se;const se=class se{static isModuleOn(e){var i;const t=(i=game.modules)==null?void 0:i.get(e);return!!(t!=null&&t.active)}static html(e,t){return e.querySelector(t)}static getFullWidth(e){return window.getComputedStyle(e).width==="0px"?0:e.offsetWidth}static addCSSVars(e,t){let i=document.querySelector("#crlngn-ui-vars");if(!i){const h=document.querySelector("body.crlngn-ui");if(!h)return;i=document.createElement("style"),i.id="crlngn-ui-vars",i.textContent=`body.crlngn-ui {
}
`,h.prepend(i)}let s=i.textContent,o=s.indexOf("body.crlngn-ui {"),l=s.indexOf("}",o);o===-1&&(s=`body.crlngn-ui {
}
`,o=0,l=s.indexOf("}"));const c=s.substring(o+16,l).split(";").map(h=>h.trim()).filter(h=>h!==""),u={};c.forEach(h=>{const R=h.split(":");if(R.length>=2){const b=R[0].trim(),m=R.slice(1).join(":").trim();b&&(u[b]=m)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),u[e]=t;const g=Object.entries(u).map(([h,R])=>`  ${h}: ${R};`).join(`
`),f=s.substring(0,o)+`body.crlngn-ui {
`+g+`
}`+s.substring(l+1);i.textContent=f}static async processStyleSheetRules(e,t){var i;try{if(((i=e.ownerNode)==null?void 0:i.tagName)==="STYLE"){const s=e.ownerNode.textContent;this.extractFontsFromCSSText(s,t)}try{const s=e.cssRules||e.rules;if(!s)return;for(let o=0;o<s.length;o++){const l=s[o];if(l instanceof CSSFontFaceRule){const n=l.style.getPropertyValue("font-family");n&&(t.add(n),r.log("Found font-face rule:",[n]))}else if(l instanceof CSSImportRule){if(r.log("Found import rule:",[l.href]),l.styleSheet)await this.processStyleSheetRules(l.styleSheet,t);else if(l.href)try{const c=await(await fetch(l.href)).text();this.extractFontsFromCSSText(c,t)}catch(n){r.warn("Error fetching imported CSS:",[n])}}}}catch(s){if(s.name==="SecurityError"&&e.href){r.log("Security restriction on stylesheet, trying to fetch directly:",[e.href]);try{const l=await(await fetch(e.href)).text();this.extractFontsFromCSSText(l,t)}catch(o){r.warn("Error fetching cross-origin stylesheet:",[o])}}else r.warn("Error accessing CSS rules:",[s])}}catch(s){r.warn("Error in processStyleSheetRules:",[s])}}static extractFontsFromCSSText(e,t){if(!e)return;const i=/@font-face\s*{[^}]*font-family\s*:\s*(['"])(.+?)\1[^}]*}/gs;(e.match(i)||[]).forEach(o=>{const l=/font-family\s*:\s*(['"])(.+?)\1/,n=o.match(l);if(n&&n[2]){const c=n[2].trim();t.add(c)}})}static getOffsetBottom(e){const t=e.offsetTop,i=e.offsetHeight;return window.innerHeight-(t+i)}static async getAllFonts(){const e=new Set(Object.keys(CONFIG.fontDefinitions)),t=game.settings.get("core","fonts")||{},i=Object.entries(t).map(([l])=>l),s=await this.processStyleSheets();return Array.from(new Set([...e,...i,...s])).filter(l=>!/FontAwesome|Font Awesome|FoundryVTT/.test(l)).map(l=>l.replace(/['"]/g,"").trim()).sort((l,n)=>l.toLowerCase().localeCompare(n.toLowerCase()))||[]}static addCustomCSS(e,t="crlngn-ui-custom-css",i=!0){if(!e)return;let s=document.querySelector("#"+t);s||(s=document.createElement("style"),s.id=t,s.textContent="",document.head.appendChild(s));const o=/@import\s+(?:url\()?\s*['"]?[^'")]+['"]?\s*\)?\s*;/g,l=[];let n=e,c;for(;(c=o.exec(e))!==null;)l.push(c[0]);if(n=e.replace(o,"").trim(),!i){s.textContent=l.join(`
`)+(l.length?`

`:"")+n;return}if(!s.textContent.includes(n)){const u=s.textContent,g=[];let f;for(;(f=o.exec(u))!==null;)g.push(f[0]);const h=u.replace(o,"").trim(),R=l.filter(m=>!g.includes(m)),b=[...g,...R];s.textContent=b.join(`
`)+(b.length?`

`:"")+h+(h&&n?`

`:"")+n}}static smoothScrollTo(e,t,i="horizontal",s=300,o=null){const l=e.dataset.scrollAnimationId;l&&cancelAnimationFrame(Number(l));const n=i==="horizontal",c=n?e.scrollLeft:e.scrollTop,u=t-c;if(u===0)return o&&o(),null;const g=performance.now(),f=R=>{const b=R-g;if(b>=s){n?e.scrollLeft=t:e.scrollTop=t,delete e.dataset.scrollAnimationId,o&&o();return}const m=b/s,C=m<.5?2*m*m:1-Math.pow(-2*m+2,2)/2;n?e.scrollLeft=c+u*C:e.scrollTop=c+u*C;const y=requestAnimationFrame(f);return e.dataset.scrollAnimationId=y,y},h=requestAnimationFrame(f);return e.dataset.scrollAnimationId=h,h}static confirmReload(e=game.i18n.localize("CRLNGN_UI.ui.reloadRequiredTitle"),t=game.i18n.localize("CRLNGN_UI.ui.reloadRequiredLabel"),i={}){const s={title:e,content:t,yes:{label:game.i18n.localize("CRLNGN_UI.ui.reloadButton"),callback:()=>(r.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("CRLNGN_UI.ui.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(s,i),foundry.applications.api.DialogV2.confirm(s)}static renderTemplate(e,t){return foundry.applications.handlebars.renderTemplate(e,t)}static loadTemplate(e){return foundry.applications.handlebars.loadTemplate(e)}static isValidCSSRule(e){if(!e||typeof e!="string")return!1;const t=e.trim();if(!t)return!1;try{const i=document.createElement("style"),s=`${t} { color: inherit; }`;i.textContent=s,document.head.appendChild(i);const o=!!(i.sheet&&i.sheet.cssRules&&i.sheet.cssRules.length>0);return document.head.removeChild(i),o}catch(i){return r.log("CSS validation error:",[i,e]),!1}}static processCSSRules(e,t){if(!e||!t)return"";const i=Ce(this,ce,Se).call(this,e),s=t+` {
`+i.baseProperties.join(`
`)+`
}`,o=[],l=new Map;return i.nestedRules.forEach(n=>{const{selector:c,content:u}=n;if(c.startsWith("&")){const h=c.substring(1),R=t.split(",").map(b=>b.trim()).filter(Boolean).map(b=>b+h).join(", ");o.push(`${R} {
${u}
}`);return}l.has(u)||l.set(u,[]);const g=c.split(",").map(h=>h.trim()),f=t.split(",").map(h=>h.trim()).filter(Boolean);g.forEach(h=>{f.forEach(R=>{l.get(u).push(`${R} ${h}`)})})}),l.forEach((n,c)=>{o.push(`${n.join(", ")} {
${c}
}`)}),s+`

`+o.join(`

`)}static getActorOwner(e){const t=e.ownership||{};for(const[i,s]of Object.entries(t))if(r.log("getActorOwner #1",[i,s,CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER]),s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.get(i);if(o&&!o.isGM)return o}if((t==null?void 0:t.default)>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const i=game.users.filter(s=>!s.isGM)[0];if(r.log("getActorOwner #2",[i]),i)return i}return null}};ce=new WeakSet,Se=function(e){const t=[],i=[],s=e.split(`
`);let o=null,l=0;for(let n=0;n<s.length;n++){const c=s[n].trim();if(!c)continue;const u=(c.match(/{/g)||[]).length,g=(c.match(/}/g)||[]).length;if(c.includes("{")&&!o){o={selector:c.substring(0,c.indexOf("{")).trim(),content:"",startLine:n},l=1;const h=c.substring(c.indexOf("{")+1).trim();h&&!h.includes("}")&&(o.content+=h+`
`)}else o?(l+=u-g,l>0?o.content+=c+`
`:(o.content=o.content.replace(/}\s*$/,"").trim(),i.push(o),o=null)):!c.includes("{")&&!c.includes("}")&&t.push(c)}return{baseProperties:t,nestedRules:i}},fe(se,ce),N(se,"processStyleSheets",async()=>{const e=new Set(Object.keys(CONFIG.fontDefinitions)),t=game.settings.get("core","fonts")||{},i=Object.entries(t).map(([l])=>l),s=new Set;for(const l of document.styleSheets)try{if(l.ownerNode){const n=l.href||"",c=n.includes("css/")||n.includes("styles/"),u=n.includes("modules/crlngn-ui/"),g=n.includes("systems/");if(n&&!c&&!u&&!g)continue;await se.processStyleSheetRules(l,s)}}catch(n){r.warn("Error processing stylesheet:",[n])}return r.log("Found fonts:",[{foundry:Array.from(e),custom:i,cssImported:Array.from(s)}]),Array.from(new Set([...e,...i,...s])).filter(l=>!/FontAwesome|Font Awesome|FoundryVTT/.test(l)).map(l=>l.replace(/['"]/g,"").trim()).sort((l,n)=>l.toLowerCase().localeCompare(n.toLowerCase()))}),N(se,"wrapFontName",e=>{const t=e.replace(/['"`]/g,"");return t.includes(" ")?`"${t}"`:t});let W=se;Hooks.once("ready",()=>{dnd5e.applications.dice.DamageRollConfigurationDialog||r.warn("DamageRollConfigurationDialog not found in dnd5e.applications.dice")});function le(a){return class extends a{constructor(e={},t={},i={}){var s,o;super(e,t,i),this.actors=i.actors||[],this.sendRequest=i.sendRequest??i.sendRequest??!0,this.showDC=i.showDC||!1,this.dcValue=i.dcValue||null,this.rollKey=i.rollKey||e.skill||e.ability||null,this.rollTypeString=i.rollTypeString||null,this.windowTitle=((s=i.window)==null?void 0:s.title)||"",this.windowSubtitle=((o=i.window)==null?void 0:o.subtitle)||""}_buildConfig(e,t,i){const s=t==null?void 0:t.get("ability"),o=t==null?void 0:t.get("dc"),l=t==null?void 0:t.get(`rolls.${i}.situational`);if(r.log("_buildConfig",[l,t,e]),l)e.parts||(e.parts=[]),e.parts.push("@situational"),e.data||(e.data={}),e.data.situational=l;else if(e.parts){const c=e.parts.indexOf("@situational");c!==-1&&e.parts.splice(c,1)}s&&(e.ability=s,this.config.ability=s);const n=super._buildConfig(e,t,i);if(o){const c=parseInt(o);isNaN(c)||(n.options=n.options||{},n.options.target=c)}else this.dcValue!==void 0&&this.dcValue!==null&&(n.options=n.options||{},n.options.target=this.dcValue);return r.log(`${this.constructor.name}._buildConfig`,[this.config,t,n]),n}_onChangeForm(e,t){r.log("_onChangeForm",[t.target.value]),super._onChangeForm(e,t);const i=this.element.querySelector('input[name="crlngn-send-request"]');i&&(this.sendRequest=i.checked);const s=this.element.querySelector('input[name="dc"]');s&&s.value&&(this.dcValue=parseInt(s.value)||null)}_finalizeRolls(e){const t=super._finalizeRolls(e);if(r.log("_finalizeRolls #1",[t,this.sendRequest]),this.dcValue!==void 0&&this.dcValue!==null)for(const i of t)i.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,t}async _onRender(e,t){var i,s,o;await super._onRender(e,t),((o=(s=(i=this.config.rolls)==null?void 0:i[0])==null?void 0:s.data)!=null&&o.situational||this.config.situational)&&(r.log(`${this.constructor.name}._onRender`,["Triggering rebuild for initial situational bonus"]),setTimeout(()=>{this.rebuild()},100))}}}const L={addSituationalBonus(a,e){var t;return r.log("Config before adding bonus:",[e,a]),e&&((t=a.rolls)!=null&&t[0])&&(a.rolls[0].parts||(a.rolls[0].parts=[]),a.rolls[0].data||(a.rolls[0].data={}),a.rolls[0].data.situational=e,a.rolls[0].parts.includes("@situational")||a.rolls[0].parts.push("@situational"),r.log("Config after adding bonus:",[a])),a},buildRollConfig(a,e,t={}){var o;const i={rolls:[{parts:e.parts||[],data:e.data||{},options:{...e.options||{},...((o=e.options)==null?void 0:o._fromFlashRolls)&&{_fromFlashRolls:!0}}}],advantage:a.config.advantage||!1,disadvantage:a.config.disadvantage||!1,target:a.config.target,subject:null,chatMessage:!0,legacy:!1,...a.config.rollMode&&{rollMode:a.config.rollMode},...t},s=a.config.situational;return s&&this.addSituationalBonus(i,s),this.ensureRollFlags(i,a)},ensureRollFlags(a,e){return a.isRollRequest=!game.user.isGM,a._showRequestedBy=!0,a._requestedBy=e.config.requestedBy||"GM",a},validateAndNormalizeActors(a){return!a||a.length===0?null:(typeof a[0]=="string"&&(a=a.map(e=>game.actors.get(e)).filter(e=>e)),a.length>0?a:null)},getRollClass(a){const e=a==null?void 0:a.toLowerCase();return[d.DAMAGE,d.HEALING].includes(e)?CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[d.FORMULA,d.CUSTOM,d.HIT_DIE].includes(e)?CONFIG.Dice.BasicRoll:CONFIG.Dice.D20Roll},shouldShowDC(a){const e=a==null?void 0:a.toLowerCase();return[d.SAVE,d.SAVING_THROW,d.ABILITY,d.ABILITY_CHECK,d.CONCENTRATION,d.SKILL,d.TOOL].includes(e)},createBaseRollConfig(a,e,t){const i=e==null?void 0:e.toLowerCase(),s={data:a.getRollData(),subject:a,rolls:[{parts:[],data:a.getRollData(),options:{}}]};switch(i){case d.SKILL:s.skill=t;break;case d.TOOL:s.tool=t;break;case d.SAVE:case d.SAVING_THROW:case d.ABILITY:case d.ABILITY_CHECK:s.ability=t;break;case d.HIT_DIE:s.rolls[0].options.flavor="Hit Die";break}return s},createMessageConfig(a,e=null){const t={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:a})}};return e&&(t.rollMode=e),t},async executeRollDialog(a,e,t,i){const s=new a(e,t,i);return await new Promise(l=>{s.addEventListener("close",()=>{l({rolls:s.rolls,config:s.config,message:s.message,sendRequest:s.sendRequest})},{once:!0}),s.render({force:!0})})},processDialogResult(a,e,t,i,s={}){var m,C,y,p,_,T;if(!(a!=null&&a.rolls)||a.rolls.length===0)return null;const o=t==null?void 0:t.toLowerCase(),l=a.rolls[0];let n=!1,c=!1;((m=l==null?void 0:l.options)==null?void 0:m.advantageMode)!==void 0&&(n=l.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,c=l.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const u=((C=l==null?void 0:l.data)==null?void 0:C.situational)||"",g=(y=l==null?void 0:l.options)==null?void 0:y.target,f={rolls:[{parts:((p=l==null?void 0:l.parts)==null?void 0:p.slice())||[],data:u?{situational:u}:{},options:g?{target:g}:{}}],subject:e[0],advantage:n,disadvantage:c,target:g,sendRequest:a.sendRequest,isRollRequest:a.sendRequest,skipRollDialog:s.skipRollDialog||!1,chatMessage:!0},h=O(),R=E.get(h.publicPlayerRolls.tag)===!0,b=this.determineRollMode(R,(_=a.message)==null?void 0:_.rollMode);return f.rollMode=b,(T=a.config)!=null&&T.ability&&[d.SKILL,d.TOOL].includes(o)&&(f.ability=a.config.ability),f},determineRollMode(a,e){return e||(a?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode"))},isPlayerOwned(a){return Object.entries(a.ownership).some(([e,t])=>{const i=game.users.get(e);return i&&!i.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}};class $ extends le(dnd5e.applications.dice.D20RollConfigurationDialog){constructor(e={},t={},i={}){i.rollType=i.rollType||CONFIG.Dice.D20Roll,super(e,t,i),r.log("constructor - initializing GM Dialog",[e,t,i])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(e,t,i,s){r.log("_prepareConfigurationData",[e,t,i,s]);const o=super._prepareConfigurationData(e,t,i,s);return o.showDC=this.showDC,o.dcValue=this.dcValue,o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,i){return r.log("_preparePartContext",[e,t,i]),t=await super._preparePartContext(e,t,i),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(r.log("_onRender",[e,t]),super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let i=this.element.querySelector(".rolls .formulas");if(i&&(this.showDC||this.actors.length>0)){const s={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await W.renderTemplate(`modules/${v}/templates/gm-roll-config-fields.hbs`,s),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,i.parentNode.insertBefore(l,i)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[this.element]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(t=>{t.addEventListener("click",i=>{i.currentTarget.dataset.action})})}static async initConfiguration(e,t,i,s={}){var p,_,T,D,S,A,I,V,M;if(e=L.validateAndNormalizeActors(e),!e)return null;const o=e[0];r.log("GMRollConfigDialog, initConfiguration",[]);const l=t==null?void 0:t.toLowerCase(),n=O(),c=E.get(n.publicPlayerRolls.tag)===!0,u=L.determineRollMode(c),g=L.shouldShowDC(l),f=L.getRollClass(l),h=L.createBaseRollConfig(o,t,i),R=L.createMessageConfig(o,u),b={options:{actors:e,sendRequest:e.some(H=>L.isPlayerOwned(H)),showDC:g,rollKey:i,rollType:f,rollTypeString:l,window:{title:$._getRollTitle(l,i,o),subtitle:$._getSubtitle(e)},...s}},m=await L.executeRollDialog(this,h,R,b.options),C=L.processDialogResult(m,e,t,i,s);if(!C)return null;if((p=m.config)!=null&&p.ability&&[d.SKILL,d.TOOL].includes(l)){const H=((T=(_=o.system.skills)==null?void 0:_[i])==null?void 0:T.ability)||((S=(D=CONFIG.DND5E.skills)==null?void 0:D[i])==null?void 0:S.ability);m.config.ability!==H&&(C.ability=m.config.ability)}let y=b.options.window.title;if(m.config.ability&&[d.SKILL,d.TOOL].includes(l)){const H=((A=CONFIG.DND5E.abilities[m.config.ability])==null?void 0:A.label)||m.config.ability;if(l===d.SKILL){const k=((I=CONFIG.DND5E.skills[i])==null?void 0:I.label)||i;y=game.i18n.format("DND5E.SkillPromptTitle",{skill:k,ability:H})}else if(l===d.TOOL){const k=(M=(V=CONFIG.DND5E.enrichmentLookup)==null?void 0:V.tools)==null?void 0:M[i];let Y=i;if(k!=null&&k.id){const x=dnd5e.documents.Trait.getBaseItem(k.id,{indexOnly:!0});Y=(x==null?void 0:x.name)||i}y=game.i18n.format("DND5E.ToolPromptTitle",{tool:Y,ability:H})}}return C.rollTitle=y,C.rollType=l,C.rollKey=i,C}static _getRollTitle(e,t,i){var l,n,c,u,g,f,h,R,b,m,C,y,p,_,T,D,S,A;r.log("GMRollConfigDialog._getRollTitle",[e,t,i]),r.log("GMRollConfigDialog._getRollTitle - Detailed",{rollType:e,rollKey:t,actorName:i==null?void 0:i.name,actorAbilities:(l=i==null?void 0:i.system)!=null&&l.abilities?Object.keys(i.system.abilities):[],actorSkills:(n=i==null?void 0:i.system)!=null&&n.skills?Object.keys(i.system.skills):[],actorInitAbility:(g=(u=(c=i==null?void 0:i.system)==null?void 0:c.attributes)==null?void 0:u.init)==null?void 0:g.ability});let s="";const o=e==null?void 0:e.toLowerCase();switch([d.SAVE,d.ABILITY,d.ABILITY_CHECK].includes(o)&&!t&&r.warn("Missing rollKey for roll type",[o,t]),o){case d.SKILL:const I=((f=CONFIG.DND5E.skills[t])==null?void 0:f.label)||t,V=(h=i==null?void 0:i.system.skills)==null?void 0:h[t],M=(V==null?void 0:V.ability)||((R=CONFIG.DND5E.skills[t])==null?void 0:R.ability)||"int",H=((b=CONFIG.DND5E.abilities[M])==null?void 0:b.label)||M;s=game.i18n.format("DND5E.SkillPromptTitle",{skill:I,ability:H});break;case d.SAVE:case d.SAVING_THROW:const k=((m=CONFIG.DND5E.abilities[t])==null?void 0:m.label)||t;s=game.i18n.format("DND5E.SavePromptTitle",{ability:k});break;case d.ABILITY:case d.ABILITY_CHECK:const Y=((C=CONFIG.DND5E.abilities[t])==null?void 0:C.label)||t;s=game.i18n.format("DND5E.AbilityPromptTitle",{ability:Y});break;case d.CONCENTRATION:s=game.i18n.localize("DND5E.Concentration");break;case d.TOOL:const x=(p=(y=CONFIG.DND5E.enrichmentLookup)==null?void 0:y.tools)==null?void 0:p[t];let K=t;if(x!=null&&x.id){const de=dnd5e.documents.Trait.getBaseItem(x.id,{indexOnly:!0});K=(de==null?void 0:de.name)||t}const q=(_=i==null?void 0:i.system.tools)==null?void 0:_[t],ue=(q==null?void 0:q.ability)||((S=(D=(T=CONFIG.DND5E.enrichmentLookup)==null?void 0:T.tools)==null?void 0:D[t])==null?void 0:S.ability)||"int",Me=((A=CONFIG.DND5E.abilities[ue])==null?void 0:A.label)||ue;s=game.i18n.format("DND5E.ToolPromptTitle",{tool:K,ability:Me});break;case d.DEATH_SAVE:s=game.i18n.localize("DND5E.DeathSave");break;case d.INITIATIVE:case d.INITIATIVE_DIALOG:s=game.i18n.localize("DND5E.Initiative");break;default:s=game.i18n.localize("DND5E.Roll")}return r.log("_getRollTitle",[o,s]),s}static _getSubtitle(e=[]){return e.length===1?e[0].name:e.length>1?game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.multipleActors"):""}}class Ee extends le(dnd5e.applications.dice.RollConfigurationDialog){constructor(e={},t={},i={}){i.rollType=CONFIG.Dice.BasicRoll||Roll,i.showDC=!1,super(e,t,i),r.log("constructor",[e,t,i])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(e,t,i,s){const o=super._prepareConfigurationData(e,t,i,s);return r.log("GMHitDieConfigDialog._prepareConfigurationData",[o]),o.formula="Hit Die (varies by actor)",o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,i){return t=await super._preparePartContext(e,t,i),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length,t.formula="Hit Die (varies by actor)"),t}async _onRender(e,t){if(super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let i=this.element.querySelector(".rolls .formulas");if(i&&this.actors.length>0){const s={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await W.renderTemplate(`modules/${v}/templates/gm-roll-config-fields.hbs`,s),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,i.parentNode.insertBefore(l,i)}}async _processSubmitData(e,t,i){await super._processSubmitData(e,t,i),this.sendRequest=i.get("crlngn-send-request")!=="false",r.log("_processSubmitData",[i,this.config])}_finalizeRolls(e){const t=super._finalizeRolls(e);return this.config.sendRequest=this.sendRequest,r.log("GMHitDieConfigDialog._finalizeRolls - before merge",[t]),t}static async initConfiguration(e,t,i,s={}){var b;if(e=L.validateAndNormalizeActors(e),!e)return null;const o=e[0];r.log("GMHitDieConfigDialog, initConfiguration",[]);const l=O(),n=E.get(l.publicPlayerRolls.tag)===!0,c=L.determineRollMode(n),u={data:o.getRollData(),subject:o,rolls:[{parts:[],data:o.getRollData(),options:{flavor:"Hit Die Roll"}}]},g=L.createMessageConfig(o,c),f={options:{actors:e,sendRequest:e.some(m=>L.isPlayerOwned(m)),rollKey:i,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:$._getSubtitle(e)},...s}},h=await L.executeRollDialog(this,u,g,f.options);if(!(h!=null&&h.rolls)||h.rolls.length===0)return null;r.log("GMHitDieConfigDialog - dialog result",[h.rolls]);const R=L.processDialogResult(h,e,t,i,s);return R?((b=h.config)!=null&&b.ability&&(R.ability=h.config.ability),R):null}}class Ae extends le(dnd5e.applications.dice.SkillToolRollConfigurationDialog){constructor(e={},t={},i={}){const s=foundry.utils.mergeObject(e,{chooseAbility:!0});i.rollType=i.rollType||CONFIG.Dice.D20Roll,super(s,t,i),r.log("constructor",[e,t,i])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,i,s){r.log("_prepareConfigurationData",[e,t,i,s]);const o=super._prepareConfigurationData(e,t,i,s);return o.showDC=this.showDC,o.dcValue=this.dcValue,o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,i){return r.log("_preparePartContext",[e,t,i]),t=await super._preparePartContext(e,t,i),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(r.log("_onRender",[e,t]),super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let i=this.element.querySelector(".rolls .formulas");if(i&&(this.showDC||this.actors.length>0)){const s={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await W.renderTemplate(`modules/${v}/templates/gm-roll-config-fields.hbs`,s),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,i.parentNode.insertBefore(l,i)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(t=>{t.addEventListener("click",i=>{i.currentTarget.dataset.action})})}static async initConfiguration(e,t,i,s={}){var p,_,T,D,S,A;if(e=L.validateAndNormalizeActors(e),!e)return null;const o=e[0];r.log("GMSkillToolConfigDialog, initConfiguration",[]);const l=t==null?void 0:t.toLowerCase(),n=O(),c=E.get(n.publicPlayerRolls.tag)===!0,u=L.determineRollMode(c),g=L.shouldShowDC(l),f=CONFIG.Dice.D20Roll;let h=null;if(l===d.SKILL){const I=o.system.skills[i];h=(I==null?void 0:I.ability)||((p=CONFIG.DND5E.skills[i])==null?void 0:p.ability)||"int"}else if(l===d.TOOL){const I=(_=o.system.tools)==null?void 0:_[i];h=(I==null?void 0:I.ability)||((S=(D=(T=CONFIG.DND5E.enrichmentLookup)==null?void 0:T.tools)==null?void 0:D[i])==null?void 0:S.ability)||"int"}const R={data:o.getRollData(),subject:o,ability:h,chooseAbility:!0,rolls:[{parts:[],data:o.getRollData(),options:{}}]};l===d.SKILL?R.skill=i:l===d.TOOL&&(R.tool=i);const b=L.createMessageConfig(o,u),m={options:{actors:e,sendRequest:e.some(I=>L.isPlayerOwned(I)),showDC:g,rollKey:i,rollType:f,rollTypeString:l,window:{title:$._getRollTitle(l,i,o),subtitle:$._getSubtitle(e)},...s}},C=await L.executeRollDialog(this,R,b,m.options),y=L.processDialogResult(C,e,t,i,s);return y?((A=C.config)!=null&&A.ability&&[d.SKILL,d.TOOL].includes(l)&&(y.ability=C.config.ability),y.rollTitle=m.options.window.title,y.rollType=l,y.rollKey=i,y):null}}class He extends le(dnd5e.applications.dice.DamageRollConfigurationDialog){constructor(e={},t={},i={}){const s=foundry.utils.mergeObject({configure:!0},e);super(s,t,i),r.log("GMDamageConfigDialog.constructor",[s,t,i])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","damage-roll","gm-roll-config"]})}_prepareConfigurationData(e,t,i,s){r.log("GMDamageConfigDialog._prepareConfigurationData",[e,t,i,s]);const o=super._prepareConfigurationData(e,t,i,s);return o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _onRender(e,t){if(await super._onRender(e,t),this.actors.length>0){const i=this.element.querySelector(".rolls + .dialog-buttons");if(i&&!this.element.querySelector(".gm-roll-config-fields")){const s=document.createElement("div");s.className="gm-roll-config-fields",s.innerHTML=`
          <div class="form-group">
            <label class="checkbox">
              <input type="checkbox" name="crlngn-send-request" ${this.sendRequest?"checked":""}>
              ${game.i18n.localize("CRLNGN_ROLL_REQUESTS.ui.dialogs.sendRequestToPlayers")}
            </label>
          </div>
        `,i.insertAdjacentElement("beforebegin",s)}}}static async initConfiguration(e,t,i,s={},o={},l={}){var _,T,D;if(e=L.validateAndNormalizeActors(e),!e)return null;const n=e[0];r.log("GMDamageConfigDialog, initConfiguration",[]);const c=O(),u=E.get(c.publicPlayerRolls.tag)===!0,g=t==null?void 0:t.toLowerCase(),f=L.determineRollMode(u,(_=y.message)==null?void 0:_.rollMode),h={subject:o.subject,data:n.getRollData(),critical:o.critical||!1,rolls:o.rolls||[{parts:[],data:n.getRollData(),options:{}}]},R=L.createMessageConfig(n,f),{position:b,...m}=(l==null?void 0:l.options)||{},C={options:{actors:e,sendRequest:e.some(S=>L.isPlayerOwned(S)),rollKey:i,rollType:CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll,rollTypeString:g,window:{title:game.i18n.localize("DND5E.DamageRoll"),subtitle:$._getSubtitle(e)},...m,...s}},y=await L.executeRollDialog(this,h,R,C.options);if(!((T=y==null?void 0:y.rolls)!=null&&T.length))return r.log("GMDamageConfigDialog, initConfiguration - cancelled"),null;r.log("GMDamageConfigDialog, initConfiguration - result",[y]);const p={rolls:y.rolls,sendRequest:y.sendRequest,critical:((D=y.config)==null?void 0:D.critical)||!1,skipRollDialog:s.skipRollDialog||!1,chatMessage:!0};return p.rollMode=f,p.rollTitle=C.options.window.title,p.rollType=g,p.rollKey=i,r.log("GMDamageConfigDialog, initConfiguration - final result",[p]),p}}class Ve extends le(dnd5e.applications.dice.AttackRollConfigurationDialog){constructor(e={},t={},i={}){super(e,t,i),r.log("GMAttackConfigDialog.constructor",[e,t,i])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,i,s){r.log("GMAttackConfigDialog._prepareConfigurationData",[e,t,i,s]);const o=super._prepareConfigurationData(e,t,i,s);return o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,i){return t=await super._preparePartContext(e,t,i),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(await super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let i=this.element.querySelector(".rolls .formulas");if(i&&this.actors.length>0){const s={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await W.renderTemplate(`modules/${v}/templates/gm-roll-config-fields.hbs`,s),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,i.parentNode.insertBefore(l,i)}}_finalizeRolls(e){return this.config.sendRequest=this.sendRequest,!this.sendRequest&&this.config.isRollRequest&&(this.config.isRollRequest=!1),super._finalizeRolls(e)}static async initConfiguration(e,t,i,s={},o={},l={}){var V,M,H,k,Y,x,K;if(e=L.validateAndNormalizeActors(e),!e)return null;const n=e[0];r.log("GMAttackConfigDialog, initConfiguration",[]);const c=O(),u=E.get(c.publicPlayerRolls.tag)===!0,g=t==null?void 0:t.toLowerCase(),f={subject:o.subject||n,data:n.getRollData(),rolls:[{parts:[],data:n.getRollData(),options:{}}]},h=L.determineRollMode(u),R=L.createMessageConfig(n,h),{position:b,...m}=(l==null?void 0:l.options)||{},C={options:{actors:e,sendRequest:e.some(q=>L.isPlayerOwned(q)),rollKey:i,rollType:CONFIG.Dice.D20Roll,rollTypeString:g,window:{title:game.i18n.localize("DND5E.Attack"),subtitle:$._getSubtitle(e)},...m,...s}},y=await L.executeRollDialog(this,f,R,C.options);if(r.log("GMAttackConfigDialog, initConfiguration",[y==null?void 0:y.sendRequest]),!(y!=null&&y.rolls)||y.rolls.length===0)return null;const p=y.rolls[0];let _=!1,T=!1;((V=p==null?void 0:p.options)==null?void 0:V.advantageMode)!==void 0&&(_=p.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,T=p.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const D=((M=p==null?void 0:p.data)==null?void 0:M.situational)||"",S=(H=p==null?void 0:p.options)==null?void 0:H.target,A={rolls:[{parts:[],data:D?{situational:D}:{},options:{...S&&{target:S},...((k=p==null?void 0:p.options)==null?void 0:k.ammunition)&&{ammunition:p.options.ammunition},...((Y=p==null?void 0:p.options)==null?void 0:Y.attackMode)&&{attackMode:p.options.attackMode},...((x=p==null?void 0:p.options)==null?void 0:x.mastery)!==void 0&&{mastery:p.options.mastery}}}],subject:o.subject||n,advantage:_,disadvantage:T,target:S,sendRequest:y.sendRequest,isRollRequest:y.sendRequest,skipDialog:s.skipDialogs||!1,chatMessage:!0},I=L.determineRollMode(u,(K=y.message)==null?void 0:K.rollMode);return A.rollMode=I,A.rollTitle=C.options.window.title,A.rollType=g,A.rollKey=i,r.log("GMAttackConfigDialog, initConfiguration - SIMPLIFIED result",[A]),A}}class xe{static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}static getMidiQOL(){return this.isMidiQOLActive()&&typeof MidiQOL<"u"?MidiQOL:null}}class Be{static findActivityForRoll(e,t){var o;if(!((o=e==null?void 0:e.system)!=null&&o.activities))return null;const i=e.system.activities;switch(t==null?void 0:t.toLowerCase()){case d.ATTACK:const l=i.getByType("attack");return(l==null?void 0:l[0])||null;case d.DAMAGE:const n=i.getByType("attack");if((n==null?void 0:n.length)>0)return n[0];const c=i.getByType("damage");if((c==null?void 0:c.length)>0)return c[0];const u=i.getByType("save");return(u==null?void 0:u.length)>0?u[0]:null;case d.ITEM_SAVE:const g=i.getByType("save");return(g==null?void 0:g[0])||null;default:return null}}static getActivitiesByType(e,t){var i;return(i=e==null?void 0:e.system)!=null&&i.activities?e.system.activities.getByType(t):[]}static hasActivityForRoll(e,t){return r.log("hasActivityForRoll",[e,t]),!!this.findActivityForRoll(e,t)}static async executeActivityRoll(e,t,i,s,o){var u,g,f,h,R,b,m,C,y,p;r.log("executeActivityRoll",[e,t,i,s,o]);const l=e.items.get(i);if(!l)throw new Error(`Item ${i} not found on actor ${e.name}`);let n=null;if(s&&(n=(u=l.system.activities)==null?void 0:u.get(s)),n=n||this.findActivityForRoll(l,t),!n)throw new Error(`Activity not found on item ${l.name}`);r.log("executeActivityRoll - activity",[n,t]);const c=t==null?void 0:t.toLowerCase();if(n)switch(c){case d.ATTACK:r.log("executeActivityRoll - is attack activity",[o]);const _={attackMode:o.usage.attackMode,ammunition:o.usage.ammunition,mastery:o.usage.mastery,situational:(h=(f=(g=o.usage.rolls)==null?void 0:g[0])==null?void 0:f.data)==null?void 0:h.situational,advantage:o.usage.advantage,disadvantage:o.usage.disadvantage,rollMode:(R=o.message)==null?void 0:R.rollMode};await n.item.setFlag(v,"tempAttackConfig",_),r.log("executeActivityRoll - stored temp config as flag",[_]);try{await n.use(o.usage,o.dialog,{...o.message,create:!0})}finally{await n.item.unsetFlag(v,"tempAttackConfig")}return;case d.DAMAGE:r.log("executeActivityRoll - damage roll",[n,o]);const T={critical:o.usage.critical||!1,event:o.usage.event,rollMode:(b=o.message)==null?void 0:b.rollMode,create:((m=o.message)==null?void 0:m.create)!==!1};return(p=(y=(C=o.usage.rolls)==null?void 0:C[0])==null?void 0:y.data)!=null&&p.situational&&(T.data||(T.data={}),T.data.situational=o.usage.rolls[0].data.situational),r.log("executeActivityRoll - damage config with situational",[T]),n!=null&&n.previousAttack||n!=null&&n.damageOnly?await n.rollDamage(T,o.dialog,o.message):await n.rollDamage(T,o.dialog,o.message);case d.ITEM_SAVE:return await l.use({activity:n.id},{skipRollDialog:o.fastForward});default:r.log("executeActivityRoll - unknown roll type",[c]);return}throw new Error(`No suitable method found for ${c} on item ${l.name}`)}static getActivityDisplayInfo(e){return r.log("getActivityDisplayInfo",[e]),e?{name:e.name||e.constructor.metadata.label,type:e.type,icon:e.constructor.metadata.icon,canAttack:e.type==="attack",canDamage:["attack","damage","save"].includes(e.type),canSave:e.type==="save"}:null}static getDamageFormula(e){var i,s;if(r.log("getDamageFormula",[e]),!((s=(i=e==null?void 0:e.damage)==null?void 0:i.parts)!=null&&s.length))return null;const t=e.damage.parts.map(o=>o.formula).filter(o=>o);return t.length>0?t.join(" + "):null}static async syntheticItemRoll(e,t={}){r.log("syntheticItemRoll",[e,t]);const i=xe.getMidiQOL();if(!i){r.warn("MidiQOL is not active");return}let s={consumeUsage:!1,consumeSpellSlot:!1},o={configureDialog:!0,workflowOptions:{autoRollAttack:!1,autoFastAttack:!1,autoRollDamage:"none",autoFastDamage:!1}};return t={...s,...t},await i.completeItemUse(e,t,o)}static async replaceDamage(e,t,{ignoreCrit:i=!1,damageType:s}={}){t=String(t),e.isCritical&&!i&&(t=await rollUtils.getCriticalFormula(t,e.item.getRollData()));let o=await new CONFIG.Dice.DamageRoll(t).evaluate();return await e.setDamageRolls([o]),o}}const{ApplicationV2:ze,HandlebarsApplicationMixin:$e}=foundry.applications.api;class pe extends $e(ze){constructor(e={}){super(e),this.formula=e.formula||"",this.readonly=e.readonly||!1,this.actor=e.actor,this.callback=e.callback,this.diceCounts={}}static get DEFAULT_OPTIONS(){return foundry.utils.mergeObject(super.DEFAULT_OPTIONS,{id:"crlngn-custom-roll-dialog",classes:["flash-rolls-5e-dialog","crlngn-custom-roll-dialog"],tag:"div",window:{title:"CRLNGN_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:420,height:"auto"}})}_onClickAction(e,t){switch(t.dataset.action){case"rollDice":return this.rollDice(e,t);case"addDie":return this.addDie(e,t);case"cancel":return this.cancel(e,t)}}async _prepareContext(e={}){return{...await super._prepareContext(e),formula:this.formula,readonly:this.readonly}}_attachPartListeners(e,t,i){super._attachPartListeners(e,t,i);const s=t.querySelector("#custom-roll-formula"),o=t.querySelector("#formula-validation-message");s&&!this.readonly&&(s.addEventListener("input",l=>{this.formula=l.target.value.trim(),this.updateValidationMessage(o)}),this.formula&&this.updateValidationMessage(o))}updateValidationMessage(e){if(!e)return;if(!this.formula){e.textContent="&nbsp;",e.classList.remove("error","success");return}this.validateFormula(this.formula)?(e.textContent=game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.formulaValid"),e.classList.remove("error"),e.classList.add("success")):(e.textContent=game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.formulaInvalid"),e.classList.remove("success"),e.classList.add("error"))}addDie(e,t){const i=t.dataset.die,s=this.element.querySelector("#custom-roll-formula");if(!s)return;const o=s.value.trim();if(o){const l=/(\d*)d(\d+)/g,n=new Map;let c=o,u;for(;(u=l.exec(o))!==null;){const h=parseInt(u[1]||"1"),R=u[2];n.set(R,(n.get(R)||0)+h),c=c.replace(u[0],"").trim()}const g=i.substring(1);n.set(g,(n.get(g)||0)+1);const f=[];for(const[h,R]of n)f.push(`${R}d${h}`);c=c.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),c&&c!=="+"?this.formula=`${f.join(" + ")} + ${c}`:this.formula=f.join(" + ")}else this.formula=`1${i}`;s.value=this.formula,s.dispatchEvent(new Event("input"))}validateFormula(e){var t;if(!e||e.trim()==="")return!1;try{return Roll.validate(e)}catch{try{return new Roll(e,((t=this.actor)==null?void 0:t.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(r.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("CRLNGN_ROLLS.ui.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback(this.formula),this.close()}cancel(){this.close()}static async prompt(e={}){return new Promise(t=>{const i=new this({...e,callback:s=>t(s)});i.addEventListener("close",()=>{i._resolved||t(null)}),i.render(!0)})}async close(e={}){return this._resolved=!0,super.close(e)}}N(pe,"PARTS",{main:{template:`modules/${j.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${j.ID}/templates/custom-roll-dialog-footer.hbs`}});function je(a,e){var s,o,l,n,c;let t=game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${a}`)||a;const i=a==null?void 0:a.toLowerCase();if(e)switch(i){case d.SKILL:t+=` (${((s=CONFIG.DND5E.skills[e])==null?void 0:s.label)||e})`;break;case d.SAVE:t+=` (${((o=CONFIG.DND5E.abilities[e])==null?void 0:o.label)||e})`;break;case d.ABILITY:t+=` (${((l=CONFIG.DND5E.abilities[e])==null?void 0:l.label)||e})`;break;case d.TOOL:const u=(c=(n=CONFIG.DND5E.enrichmentLookup)==null?void 0:n.tools)==null?void 0:c[e];if(u!=null&&u.id){const g=dnd5e.documents.Trait.getBaseItem(u.id,{indexOnly:!0});t+=` (${(g==null?void 0:g.name)||e})`}else t+=` (${e})`;break;case d.CUSTOM:t=`${t}: ${e}`;break}return t}function Ue(a,e=je){if(a.length===0)return;const t={};for(const s of a){const o=`${s.rollType}_${s.rollKey||""}`;t[o]||(t[o]={rollType:s.rollType,rollKey:s.rollKey,actors:[],gm:s.gm}),t[o].actors.push(s.actor)}const i=Object.values(t);if(i.length===1&&i[0].actors.length===1){const s=i[0];ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestReceived",{gm:s.gm,rollType:e(s.rollType,s.rollKey)}))}else{const s=[];for(const o of i){const l=e(o.rollType,o.rollKey),n=o.actors.join(", ");s.push(`${l} (${n})`)}ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsReceivedMultiple",{gm:i[0].gm,requests:s.join("; ")}))}}function We(a){const e=a.ownership||{};for(const[t,i]of Object.entries(e))if(i>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const s=game.users.get(t);if(s&&!s.isGM)return s}return null}function Ke(a,e=game.user){if(!(a!=null&&a.length))return;a.map(i=>canvas.tokens.get(i)).filter(i=>i).forEach(i=>i.setTarget(!0,{user:e}))}function ae(a){return a.type!=="character"&&a.type!=="npc"?!1:Object.entries(a.ownership).some(([e,t])=>{const i=game.users.get(e);return i&&!i.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function _e(a){if(a.type!=="character"&&a.type!=="npc")return!1;const e=game.scenes.active;return e&&e.tokens.some(t=>t.actorId===a.id)}function re(a,e){if(!game.scenes.active)return;const i=canvas.tokens.placeables.filter(s=>{var o;return((o=s.actor)==null?void 0:o.id)===a});for(const s of i)e?s.control({releaseOthers:!1}):s.release()}function Te(a){return new Promise(e=>setTimeout(e,a))}function Le(){var a;return((a=ui==null?void 0:ui.sidebar)==null?void 0:a.expanded)||!1}function Ie(a){const e=document.querySelector("body");a?e.classList.add("crlngn-sidebar-expanded"):e.classList.remove("crlngn-sidebar-expanded"),De()}function Ye(a,e){var l;const t=[];if(!a||e.size===0)return t;const i=j.ROLL_REQUEST_OPTIONS[a];if(!i||!i.subList)return t;const s=Array.from(e)[0],o=game.actors.get(s);if(i.subList==="tools"){const n=((l=CONFIG.DND5E.enrichmentLookup)==null?void 0:l.tools)||CONFIG.DND5E.tools||{};for(const[c,u]of Object.entries(n)){let g=c;if(u!=null&&u.id){const f=dnd5e.documents.Trait.getBaseItem(u.id,{indexOnly:!0});g=(f==null?void 0:f.name)||c}else g=c.replace(/([A-Z])/g," $1").replace(/^./,f=>f.toUpperCase()).trim();t.push({id:c,name:g,rollable:!0})}t.sort((c,u)=>c.name.localeCompare(u.name))}else if(o&&i.actorPath){const n=foundry.utils.getProperty(o,i.actorPath)||{},c=CONFIG.DND5E[i.subList];for(const[u,g]of Object.entries(n)){let f="";i.subList==="skills"&&(c!=null&&c[u])||i.subList==="abilities"&&(c!=null&&c[u])?f=c[u].label:f=g.label||game.i18n.localize(g.name||u)||u,t.push({id:u,name:f,rollable:!0})}i.subList==="skills"&&t.sort((u,g)=>u.name.localeCompare(g.name))}return t}const F=class F{static notify(e,t,i={}){if(!i.batch){ui.notifications[e](t);return}i.batchData&&(F.pendingNotifications.push(i.batchData),F.notificationTimer&&clearTimeout(F.notificationTimer),F.notificationTimer=setTimeout(()=>{Ue(F.pendingNotifications),F.pendingNotifications=[],F.notificationTimer=null},F.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(e,t){const i=Object.entries(e);if(i.length!==0)if(i.length===1){const s=Object.values(e)[0],o=s.actors.map(l=>l.name).join(", ");ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsSentSingle",{rollType:t,actors:o,player:s.player.name}))}else{const s=i.map(([o,l])=>{const n=l.actors.map(c=>c.name).join(", ");return`${l.player.name} (${n})`});ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestsSentMultiple",{rollType:t,count:i.length,players:s.join("; ")}))}}static clearPending(){F.notificationTimer&&(clearTimeout(F.notificationTimer),F.notificationTimer=null),F.pendingNotifications=[]}};N(F,"pendingNotifications",[]),N(F,"notificationTimer",null),N(F,"NOTIFICATION_BATCH_DELAY",500);let P=F;function Qe(a){var i;const e=[],t=[];for(const s of a){const o=((i=s.system.attributes.hp)==null?void 0:i.value)||0,l=s.system.attributes.death||{},n=l.success||0,c=l.failure||0;o<=0&&n<3&&c<3?e.push(s):t.push(s.name)}return t.length>0&&P.notify("info",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.actorsSkippingDeathSave",{actors:t.join(", ")})),e}function Je(a){const e=[],t=[];for(const i of a){const s=We(i);s?e.push({actor:i,owner:s}):t.push(i)}return{pcActors:e,npcActors:t}}function De(a=!0){const e=document.querySelector("#chat-notifications #roll-privacy"),t=e?W.getFullWidth(e):0;W.addCSSVars("--flash-rolls-menu-offset",t+"px")}const B={ability:async(a,e,t,i,s)=>{var l;r.log("RollHandlers.ability #1",[t]);const o=L.buildRollConfig(e,t,{ability:e.rollKey});r.log("RollHandlers.ability #2",[(l=o.rolls)==null?void 0:l[0]]),r.log("RollHandlers.ability - messageConfig",s),await a.rollAbilityCheck(o,i,s)},abilitycheck:async(a,e,t,i,s)=>B.ability(a,e,t,i,s),save:async(a,e,t,i,s)=>{var l;const o=L.buildRollConfig(e,t,{ability:((l=e.config)==null?void 0:l.ability)||e.rollKey});await a.rollSavingThrow(o,i,s)},savingthrow:async(a,e,t,i,s)=>B.save(a,e,t,i,s),skill:async(a,e,t,i,s)=>{var n,c,u,g,f,h;r.log("RollHandlers.skill #1",[e,t,i]);const o=((c=(n=a.system.skills)==null?void 0:n[e.rollKey])==null?void 0:c.ability)||((g=(u=CONFIG.DND5E.skills)==null?void 0:u[e.rollKey])==null?void 0:g.ability)||void 0,l=L.buildRollConfig(e,t,{skill:e.rollKey,chooseAbility:i.configure!==!1,ability:e.config.ability||o});if(e.config.ability&&i.configure===!1){const R=((f=CONFIG.DND5E.skills[e.rollKey])==null?void 0:f.label)||e.rollKey,b=((h=CONFIG.DND5E.abilities[e.config.ability])==null?void 0:h.label)||e.config.ability,m=game.i18n.format("DND5E.SkillPromptTitle",{skill:R,ability:b});s.data=s.data||{},s.data.flavor=m}r.log("RollHandlers.skill #2",[l,i,s]),await a.rollSkill(l,i,s)},tool:async(a,e,t,i,s)=>{var c,u,g,f,h,R,b;r.log("RollHandlers.tool #1",[e,t]);const o=(c=a.system.tools)==null?void 0:c[e.rollKey],l=(o==null?void 0:o.ability)||((f=(g=(u=CONFIG.DND5E.enrichmentLookup)==null?void 0:u.tools)==null?void 0:g[e.rollKey])==null?void 0:f.ability)||"int",n=L.buildRollConfig(e,t,{tool:e.rollKey,chooseAbility:i.configure!==!1,ability:e.config.ability||l});if(e.config.ability&&i.configure===!1){const m=(R=(h=CONFIG.DND5E.enrichmentLookup)==null?void 0:h.tools)==null?void 0:R[e.rollKey];let C=e.rollKey;if(m!=null&&m.id){const _=dnd5e.documents.Trait.getBaseItem(m.id,{indexOnly:!0});C=(_==null?void 0:_.name)||e.rollKey}const y=((b=CONFIG.DND5E.abilities[e.config.ability])==null?void 0:b.label)||e.config.ability,p=game.i18n.format("DND5E.ToolPromptTitle",{tool:C,ability:y});s.data=s.data||{},s.data.flavor=p}r.log("RollHandlers.tool #2",[n,i,s]),await a.rollToolCheck(n,i,s)},concentration:async(a,e,t,i,s)=>{const o=L.buildRollConfig(e,t);await a.rollConcentration(o,i,s)},attack:async(a,e,t,i,s)=>{await B.handleActivityRoll(a,d.ATTACK,e,t,i,s)},damage:async(a,e,t,i,s)=>{await B.handleActivityRoll(a,d.DAMAGE,e,t,i,s)},itemsave:async(a,e,t,i,s)=>{await B.handleActivityRoll(a,d.ITEM_SAVE,e,t,i,s)},initiative:async(a,e,t,i,s)=>{var l,n,c;if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));return}e.config.situational||(l=t.data)!=null&&l.situational;let o=a;if(!a.isToken){const u=canvas.tokens.placeables.find(g=>{var f;return((f=g.actor)==null?void 0:f.id)===a.id});if(u)o=u.actor;else{ui.notifications.error(game.i18n.format("COMBAT.NoneActive"));return}}try{if(i.configure){if(e.config){r.log("RollHandlers.initiative - Building roll config for flag storage",[{actorId:a.id,requestData:e,rollConfig:t}]);const u=L.buildRollConfig(e,t,{ability:((c=(n=a.system.attributes)==null?void 0:n.init)==null?void 0:c.ability)||"dex"}),g={advantage:e.config.advantage||!1,disadvantage:e.config.disadvantage||!1,rollMode:e.config.rollMode||game.settings.get("core","rollMode"),rolls:u.rolls};r.log("RollHandlers.initiative - Storing built config as actor flag",[{tempConfig:g}]),await a.setFlag(v,"tempInitiativeConfig",g)}await o.rollInitiativeDialog(),await a.unsetFlag(v,"tempInitiativeConfig")}else{const u={createCombatants:!0,rerollInitiative:!0};await o.rollInitiative(u)}r.log("RollHandlers.initiative - COMPLETE")}catch(u){r.error("RollHandlers.initiative - Error",[u]),P.notify("error",`Initiative roll failed: ${u.message}`)}},initiativedialog:async(a,e,t,i,s)=>B.initiative(a,e,t,i,s),deathsave:async(a,e,t,i,s)=>{const o=L.buildRollConfig(e,t);await a.rollDeathSave(o,i,s)},hitdie:async(a,e,t,i,s)=>{i.configure=game.user.isGM?i.configure:!0;const o=L.buildRollConfig(e,t,{denomination:e.rollKey});r.log("RollHandlers.hitdie",[o,i,s]),await a.rollHitDie(o,i,s)},custom:async(a,e,t,i,s)=>{await B.handleCustomRoll(a,e,i,s)},async handleActivityRoll(a,e,t,i,s,o){var l,n;if(r.log("RollHandlers.handleActivityRoll",[e,t,i]),t.rollKey){const c=L.buildRollConfig(t,i),u=((n=(l=c.rolls)==null?void 0:l[0])==null?void 0:n.options)||{},g={usage:{...t.config,rolls:c.rolls,...u.attackMode&&{attackMode:u.attackMode},...u.ammunition&&{ammunition:u.ammunition},...u.mastery!==void 0&&{mastery:u.mastery}},dialog:s,message:o};r.log("handleActivityRoll - final activity config",[g]),await Be.executeActivityRoll(a,e,t.rollKey,t.activityId,g)}},async handleCustomRoll(a,e,t,i){var l,n,c;const s=e.rollKey;if((t==null?void 0:t.configure)===!1){try{const u=new Roll(s,a.getRollData());u.options=u.options||{},u.options.isRollRequest=((l=e.config)==null?void 0:l.isRollRequest)!==!1,await u.evaluate({async:!0}),await u.toMessage({speaker:ChatMessage.getSpeaker({actor:a}),flavor:game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${d.CUSTOM}`),rollMode:(i==null?void 0:i.rollMode)||((n=e.config)==null?void 0:n.rollMode)||game.settings.get("core","rollMode"),isRollRequest:((c=e.config)==null?void 0:c.isRollRequest)!==!1,create:(i==null?void 0:i.create)!==!1})}catch{ui.notifications.error(game.i18n.format("CRLNGN_ROLLS.ui.notifications.invalidFormula",{formula:s}))}return}new pe({formula:s,readonly:!0,actor:a,callback:async u=>{try{const g=new Roll(u,a.getRollData());g.options=g.options||{},g.options.isRollRequest=!0,await g.evaluate({async:!0}),await g.toMessage({speaker:ChatMessage.getSpeaker({actor:a}),flavor:game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${d.CUSTOM}`),rollMode:e.config.rollMode,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM"})}catch{ui.notifications.error(game.i18n.format("CRLNGN_ROLLS.ui.notifications.invalidFormula",{formula:u}))}}}).render(!0)},async handleHitDieRecovery(a){const e=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in e&&(e.deltas.hitDice=e.dhd),a._getRestHitDiceRecovery({maxHitDice:a.system.attributes.hd.max,type:"long"},e),e.dhd=e.deltas.hitDice,e.longRest=!0;try{if(e.updateData&&Object.keys(e.updateData).length>0){const t=await a.update(e.updateData,{isRest:!1})}else r.log("No actor updates to perform",[]);if(e.updateItems&&e.updateItems.length>0){const t=await a.updateEmbeddedDocuments("Item",e.updateItems,{isRest:!1})}else r.log("No item updates to perform",[])}catch(t){throw r.error("Error during updates in handleHitDieRecovery:",[t]),t}return r.log("handleHitDieRecovery #3",[e]),e}};async function Oe(){return game.combat||(await(await Combat.create({scene:game.scenes.active.id})).activate(),P.notify("info",game.i18n.localize("CRLNGN_ROLL_REQUESTS.notifications.combatCreated"))),game.combat}async function ke(a,e){if(!e.combat)return a;const t=a.map(o=>e.actors.get(o)).filter(o=>o),i=[],s=new Set;for(const o of t)e.combat.getCombatantsByActor(o.id).some(c=>c.initiative!==null)&&(i.push(o.name),s.add(o.id));if(r.log("filterActorsForInitiative",[i]),i.length>0)if(await foundry.applications.api.DialogV2.confirm({window:{title:e.i18n.localize("CRLNGN_ROLLS.ui.dialogs.rerollInitiativeTitle"),classes:["flash-rolls-5e-dialog"]},content:"<p>"+e.i18n.format("CRLNGN_ROLLS.ui.dialogs.rerollInitiative",{actors:i.join(", ")})+"</p>",rejectClose:!1,modal:!0})){if(e.user.isGM)for(const l of s){const n=e.combat.getCombatantsByActor(l);r.log("filterActorsForInitiative - resetting initiative for combatants",[n]);for(const c of n)await c.update({initiative:null})}else r.log("filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll");return a}else{const l=a.filter(n=>!s.has(n));return l.length===0&&P.notify("info",e.i18n.localize("CRLNGN_ROLL_REQUESTS.notifications.allActorsHaveInitiative")),l}return a}class Ne{static initialize(){r.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){r.log("RollInterceptor.registerHooks"),this._registerHook(G.PRE_ROLL_ABILITY_CHECK,this._handlePreRoll.bind(this,d.ABILITY)),this._registerHook(G.PRE_ROLL_SAVING_THROW,this._handlePreRoll.bind(this,d.SAVE)),this._registerHook(G.PRE_ROLL_SKILL_V2,this._handlePreRoll.bind(this,d.SKILL)),this._registerHook(G.PRE_ROLL_TOOL_V2,this._handlePreRoll.bind(this,d.TOOL)),this._registerHook(G.PRE_ROLL_ATTACK_V2,this._handlePreRoll.bind(this,d.ATTACK)),this._registerHook(G.PRE_ROLL_DAMAGE_V2,this._handlePreRoll.bind(this,d.DAMAGE)),this._registerHook(G.PRE_ROLL_DEATH_SAVE_V2,this._handlePreRoll.bind(this,d.DEATH_SAVE)),this._registerHook(G.PRE_ROLL_HIT_DIE_V2,this._handlePreRoll.bind(this,d.HIT_DIE)),this._registerHook(G.PRE_ROLL_INITIATIVE,this._handlePreRollInitiative.bind(this,d.INITIATIVE)),this._registerHook(G.PRE_ROLL_INITIATIVE_DIALOG,this._handlePreRollInitiative.bind(this,d.INITIATIVE)),this._registerHook(G.ROLL_INITIATIVE,this._handleRollInitiative.bind(this,d.INITIATIVE))}static _registerHook(e,t){r.log("RollInterceptor._registerHook");const i=Hooks.on(e,t);this.registeredHooks.add({hookName:e,hookId:i})}static unregisterHooks(){r.log("RollInterceptor.unregisterHooks");for(const{hookName:e,hookId:t}of this.registeredHooks)Hooks.off(e,t);this.registeredHooks.clear()}static _handlePreRollInitiative(e,t,i){r.log("_handlePreRollInitiative",[e,t,i])}static _handlePreRoll(e,t,i,s){var f,h,R,b,m,C,y,p;if(r.log("_handlePreRoll #0",[e,t,i,s]),!game.user.isGM||t.isRollRequest===!1)return;const o=(t==null?void 0:t.hookNames)||(i==null?void 0:i.hookNames)||(s==null?void 0:s.hookNames)||[],l=o.includes("initiativeDialog")||o.includes("initiative");if(e===d.ATTACK){r.log("_handlePreRoll - is Attack roll",[(f=t.subject)==null?void 0:f.item]);const _=(R=(h=t.subject)==null?void 0:h.item)==null?void 0:R.getFlag(v,"tempAttackConfig");if(_){r.log("_handlePreRoll - found module flags, skipping interception",[_]);return}}if(e===d.DAMAGE){r.log("RollInterceptor._handlePreRoll - is Damage roll",[t]);const _=(m=(b=t.subject)==null?void 0:b.item)==null?void 0:m.getFlag(v,"tempDamageConfig");if(_){r.log("RollInterceptor._handlePreRoll - found module flags, skipping interception",[_]);return}}if(l&&e===d.ABILITY&&(r.log("RollInterceptor._handlePreRoll - Overriding ability to initiative",[o]),e=d.INITIATIVE),t!=null&&t.isRollRequest||t.sendRequest===!1||i!=null&&i.isRollRequest||s!=null&&s.isRollRequest)return;let n;if(e===d.INITIATIVE&&t instanceof Actor){if(n=t,r.log("_handlePreRoll - Initiative",[t,i,s]),(i==null?void 0:i.isRollRequest)===!1||(s==null?void 0:s.isRollRequest)===!1)return}else e===d.HIT_DIE?n=((C=i==null?void 0:i.subject)==null?void 0:C.actor)||(i==null?void 0:i.subject)||(i==null?void 0:i.actor):e===d.ATTACK||e===d.DAMAGE?n=(y=t.subject)==null?void 0:y.actor:n=((p=t.subject)==null?void 0:p.actor)||t.subject||t.actor;const c=O();if(!E.get(c.rollInterceptionEnabled.tag)||!n||n.documentName!=="Actor")return;r.log("_handlePreRoll",[t,s]);const g=W.getActorOwner(n);if(!(!g||!g.active||g.id===game.user.id||i.configure===!1||t.isRollRequest===!1||t.skipRollDialog===!0||t.fastForward===!0))return r.log("_handlePreRoll - intercepting roll #1",[t,s]),e===d.ATTACK&&(s={...s,rollMode:CONST.DICE_ROLL_MODES.PUBLIC}),r.log("_handlePreRoll - intercepting roll #2",[t,s]),this._showGMConfigDialog(n,g,e,t,i,s),!1}static _handleRollInitiative(e,t,i,s,o){r.log("_handleRollInitiative",[e,t,i,s,o])}static async _showGMConfigDialog(e,t,i,s,o,l){var u,g,f,h,R,b,m,C,y,p,_,T,D;r.log("_showGMConfigDialog - config",[i,s]);const n=O();E.get(n.rollInterceptionEnabled.tag);const c=E.get(n.rollRequestsEnabled.tag);try{const S=i==null?void 0:i.toLowerCase();if(S===d.INITIATIVE&&(!game.combat&&!await Oe()||(await ke([e.id],game)).length===0))return;let A;[d.SKILL,d.TOOL].includes(S)?A=Ae:S===d.HIT_DIE?A=Ee:S===d.ATTACK?A=Ve:S===d.DAMAGE&&(g=(u=dnd5e.applications)==null?void 0:u.dice)!=null&&g.DamageRollConfigurationDialog?A=He:A=$;let I={rolls:[{parts:[],data:{},options:{}}]};const V=O(),M=E.get(V.skipRollDialog.tag),H={actors:[e],rollType:S,showDC:!0,sendRequest:!0,skipRollDialog:M};let k;if(M)k={sendRequest:!0,advantage:!1,disadvantage:!1,situational:"",rollMode:game.settings.get("core","rollMode")};else{let q=null;switch(S){case d.SKILL:I.skill=s.skill,I.ability=s.ability||((f=s.subject)==null?void 0:f.ability),q=I.skill;break;case d.TOOL:I.tool=s.tool,I.ability=s.ability||((h=s.subject)==null?void 0:h.ability),q=I.tool;break;case d.ABILITY:case d.SAVE:I.ability=s.ability||((R=s.subject)==null?void 0:R.ability),q=I.ability,I.ability==="con"&&s.targetValue!==void 0&&(i=d.CONCENTRATION);break;case d.CONCENTRATION:I.ability="con",q="con";break;case d.INITIATIVE:case d.INITIATIVE_DIALOG:q=((m=(b=e.system.attributes)==null?void 0:b.init)==null?void 0:m.ability)||"dex";break;case d.HIT_DIE:I.denomination=typeof s=="string"?s:s.denomination||((C=s.subject)==null?void 0:C.denomination),q=I.denomination;break;case d.ATTACK:o!=null&&o.options&&(I.ammunition=o.options.ammunition,I.attackMode=o.options.attackMode,I.mastery=o.options.mastery),q=(p=(y=s.subject)==null?void 0:y.item)==null?void 0:p.id;break;case d.DAMAGE:I.item=(_=s.subject)==null?void 0:_.item,I.subject=s.subject,I.critical=s.critical||!1,q=(D=(T=s.subject)==null?void 0:T.item)==null?void 0:D.id;break;default:break}if(!A.initConfiguration)throw r.error("DialogClass.initConfiguration not found",[A,A.name]),new Error(`DialogClass ${A.name} does not have initConfiguration method`);S===d.ATTACK||S===d.DAMAGE?k=await A.initConfiguration([e],S,q,{skipRollDialog:!1,sendRequest:c},s,o):k=await A.initConfiguration([e],S,q,{skipRollDialog:!1,sendRequest:c})}if(!k){r.log("_showGMConfigDialog - Dialog cancelled");return}if(r.log("_showGMConfigDialog - sending _executeInterceptedRoll",[i,s,k]),!k.sendRequest||!c){await this._executeInterceptedRoll(e,i,s,k);return}const{event:Y,...x}=s,K={...x,...k,rolls:k.rolls,requestedBy:game.user.name,...i===d.ATTACK&&{chatMessage:!1}};r.log("_showGMConfigDialog - finalConfig for damage roll",["rollType:",i,"result:",k,"result.rolls:",k.rolls,"finalConfig:",K,"finalConfig.rolls:",K.rolls]),this._sendRollRequest(e,t,i,K)}catch{this._sendRollRequest(e,t,i,s)}}static async _executeInterceptedRoll(e,t,i,s){var h,R,b,m,C,y,p,_,T,D,S,A,I,V;r.log("RollInterceptor._executeInterceptedRoll",[e,t,i,s]);const o=t==null?void 0:t.toLowerCase(),l=((h=s.rolls)==null?void 0:h[0])||{parts:[],data:{},options:{}},n=((R=l.data)==null?void 0:R.situational)||s.situational||"";let c;switch(o){case d.SKILL:c=i.skill;break;case d.TOOL:c=i.tool;break;case d.ABILITY:case d.SAVE:c=i.ability||((b=i.subject)==null?void 0:b.ability);break;case d.HIT_DIE:c=i.denomination;break;default:c=i.ability||i.skill||i.tool||i.denomination}const u={rollKey:c,config:{advantage:s.advantage||i.advantage,disadvantage:s.disadvantage||i.disadvantage,target:s.target||s.dc||i.target,rollMode:s.rollMode||i.rollMode,situational:n,isRollRequest:!1,ability:i.ability}};if(o===d.SKILL&&!u.config.ability)u.config.ability=((C=(m=e.system.skills)==null?void 0:m[u.rollKey])==null?void 0:C.ability)||((p=(y=CONFIG.DND5E.skills)==null?void 0:y[u.rollKey])==null?void 0:p.ability);else if(o===d.TOOL&&!u.config.ability){const M=(_=e.system.tools)==null?void 0:_[u.rollKey];u.config.ability=(M==null?void 0:M.ability)||((S=(D=(T=CONFIG.DND5E.enrichmentLookup)==null?void 0:T.tools)==null?void 0:D[u.rollKey])==null?void 0:S.ability)||"int"}else(o===d.ABILITY||o===d.SAVE)&&!u.config.ability&&(u.config.ability=u.rollKey);r.log("RollInterceptor._executeInterceptedRoll - requestData",[u,i,s]);const g={configure:!1,isRollRequest:!1},f={rollMode:u.config.rollMode,create:!0,isRollRequest:!1};try{const M=d,H=B[o];r.log("RollInterceptor._executeInterceptedRoll - handler 1",[H,o,B[o]]),H?((o===d.ATTACK||o===d.DAMAGE||o===d.SAVE)&&(u.rollKey=(I=(A=i.subject)==null?void 0:A.item)==null?void 0:I.id,u.activityId=(V=i.subject)==null?void 0:V.id),r.log("RollInterceptor._executeInterceptedRoll - handler 2",[u,l,g,f]),await H(e,u,l,g,f)):r.warn(`No handler found for roll type: ${o}`)}catch(M){r.error("RollInterceptor._executeInterceptedRoll",[M])}}static async _showConfigurationDialog(e,t,i,s,o,l){r.log("RollInterceptor._showConfigurationDialog",[e,t,i,s,o,l]);try{const c={...s,_rollMethod:async h=>(this._sendRollRequest(e,t,i,h),new Roll("1d20").evaluate({async:!1})),configured:!1},u=o.cls,f=await new u(c,o.options).render(!0)}catch{this._sendRollRequest(e,t,i,s)}}static _sendRollRequest(e,t,i,s){var f,h,R,b,m,C,y;r.log("_sendRollRequest",[e,t,i,s]),r.log("_sendRollRequest - config.rolls check",["config.rolls:",s.rolls,"config.rolls[0]:",(f=s.rolls)==null?void 0:f[0],"config.rolls[0].data:",(R=(h=s.rolls)==null?void 0:h[0])==null?void 0:R.data,"config.rolls[0].data.situational:",(C=(m=(b=s.rolls)==null?void 0:b[0])==null?void 0:m.data)==null?void 0:C.situational]);const o=O(),l=E.get(o.skipRollDialog.tag);let n=i==null?void 0:i.toLowerCase();n===d.INITIATIVE&&(n=d.INITIATIVE_DIALOG);let c=null,u=null;switch(n){case d.ABILITY:case d.SAVE:c=s.ability;break;case d.SKILL:c=s.skill;break;case d.TOOL:c=s.tool;break;case d.ATTACK:case d.DAMAGE:r.log("_sendRollRequest - Attack/Damage roll config",[i,s]),c=(y=s.subject.item)==null?void 0:y.id,u=s.subject.id;break;case d.HIT_DIE:c=typeof s=="string"?s:s.denomination;break;case d.INITIATIVE_DIALOG:case d.INITIATIVE:c=null;break;case d.DEATH_SAVE:c=null;break;default:r.warn(`Unknown roll type: ${i}`);return}const g={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:e.id,rollType:n,rollKey:c,activityId:u,rollProcessConfig:{...s,_requestedBy:game.user.name},skipRollDialog:l,targetTokenIds:Array.from(game.user.targets).map(p=>p.id),preserveTargets:E.get(o.useGMTargetTokens.tag)};U.execForUser("handleRollRequest",t.id,g),ui.notifications.info(game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestSent",{player:t.name,actor:e.name}))}}N(Ne,"registeredHooks",new Set);const{ApplicationV2:Ze,HandlebarsApplicationMixin:Xe}=foundry.applications.api;var z;const ee=class ee extends Xe(Ze){constructor(t={}){r.log("RollRequestsMenu.constructor",[t]);super(t);N(this,"_onClickOutside",t=>{if(r.log("_onClickOutside"),this.isLocked)return;const i=this.element;i&&(t.target.closest(".flash-rolls-menu")||i.contains(t.target)||t.target.closest("#flash-rolls-icon")||t.target.closest(".dialog, .app, .notification, .application")||this.close())});this.selectedActors=new Set,this.currentTab="pc",this.selectedRequestType=null,this.isLocked=!1,this.optionsExpanded=game.user.getFlag(j.ID,"menuOptionsExpanded")??!1,this._initializeFromSelectedTokens()}async _prepareContext(t){r.log("_prepareContext");const i=await super._prepareContext(t),s=game.actors.contents,o=[],l=[],n=game.scenes.active;for(const m of s){if(m.type!=="character"&&m.type!=="npc")continue;const C={id:m.id,uuid:m.uuid,name:m.name,img:m.img,selected:this.selectedActors.has(m.id),crlngnStats:this._getActorStats(m)};Object.entries(m.ownership).some(([p,_])=>{const T=game.users.get(p);return T&&!T.isGM&&_>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})?o.push(C):n!=null&&n.tokens.some(_=>_.actorId===m.id)&&l.push(C)}const c=O(),u=E.get(c.rollRequestsEnabled.tag),g=E.get(c.skipRollDialog.tag),f=this.currentTab==="pc"?o:l,h=f.length>0&&f.every(m=>this.selectedActors.has(m.id)),R=[];if(this.selectedActors.size>0)for(const[m,C]of Object.entries(j.ROLL_REQUEST_OPTIONS))R.push({id:m,name:game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${C.name}`)||C.label,rollable:C.subList==null,hasSubList:!!C.subList,selected:this.selectedRequestType===m});const b=Ye(this.selectedRequestType,this.selectedActors);return{...i,actors:f,currentTab:this.currentTab,isPCTab:this.currentTab==="pc",isNPCTab:this.currentTab==="npc",selectedTab:this.currentTab,rollRequestsEnabled:u,skipRollDialog:g,selectAllOn:h,hasSelectedActors:this.selectedActors.size>0,requestTypes:R,rollTypes:b,showNames:!0,actorsLocked:this.isLocked,optionsExpanded:this.optionsExpanded}}_getActorStats(t){var l,n,c,u,g,f;r.log("_getActorStats");const i=t.system,s=[];(l=i.attributes)!=null&&l.hp&&s.push({abbrev:"HP",value:i.attributes.hp.value}),(n=i.attributes)!=null&&n.ac&&s.push({abbrev:"AC",value:i.attributes.ac.value});const o=(u=(c=i.attributes)==null?void 0:c.spell)==null?void 0:u.dc;return o&&s.push({abbrev:"DC",value:o}),(f=(g=i.skills)==null?void 0:g.prc)!=null&&f.passive&&s.push({abbrev:"PRC",value:i.skills.prc.passive}),s}async _renderFrame(t){const i=await super._renderFrame(t),s=document.querySelector("#chat-notifications");return s&&i&&s.insertBefore(i,s.firstChild),i}_onRender(t,i){if(r.log("_onRender"),super._onRender(t,i),this._attachListeners(),De(),this.optionsExpanded){const s=this.element.querySelector(".options-toggle"),o=this.element.querySelector("li.options");s==null||s.classList.add("expanded"),o==null||o.classList.add("expanded")}setTimeout(()=>{document.addEventListener("click",this._onClickOutside,!0)},100),this._tokenControlHook=Hooks.on("controlToken",this._onTokenControlChange.bind(this))}_onTokenControlChange(t,i){r.log("_onTokenControlChange"),this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{this._initializeFromSelectedTokens(),this.render(),this._tokenUpdateTimeout=null},100)))}_attachListeners(){var l,n,c,u,g;r.log("_attachListeners");const t=this.element;(l=t.querySelector("#flash-rolls-toggle"))==null||l.addEventListener("change",this._onToggleRollRequests.bind(this)),(n=t.querySelector("#crlngn-skip-dialogs"))==null||n.addEventListener("change",this._onToggleSkipDialogs.bind(this)),(c=t.querySelector("#crlngn-actors-all"))==null||c.addEventListener("change",this._onToggleSelectAll.bind(this)),(u=t.querySelector("#crlngn-actors-lock"))==null||u.addEventListener("click",this._onToggleLock.bind(this)),(g=t.querySelector(".options-toggle"))==null||g.addEventListener("click",this._onToggleOptions.bind(this)),t.querySelectorAll(".actor-tab").forEach(f=>{f.addEventListener("click",this._onTabClick.bind(this))}),t.querySelectorAll(".actor").forEach(f=>{f.addEventListener("click",this._onActorClick.bind(this))}),t.querySelectorAll(".actor-select").forEach(f=>{f.addEventListener("click",this._onActorSelectClick.bind(this))});const s=t.querySelector(".request-types");s&&s.addEventListener("click",f=>{const h=f.target.closest("li");if(h&&h.dataset.id){const R={...f,currentTarget:h};this._onRequestTypeClick(R)}});const o=t.querySelector(".roll-types");o&&o.addEventListener("click",f=>{const h=f.target.closest("li");if(h&&h.dataset.id){const R={...f,currentTarget:h};this._onRollTypeClick(R)}})}async _onToggleRollRequests(t){r.log("_onToggleRollRequests");const i=O(),s=t.target.checked;await E.set(i.rollRequestsEnabled.tag,s),we.updateRollRequestsIcon(s)}async _onToggleSkipDialogs(t){r.log("_onToggleSkipDialogs");const i=O(),s=t.target.checked;await E.set(i.skipRollDialog.tag,s)}_onToggleSelectAll(t){r.log("_onToggleSelectAll");const i=t.target.checked;this._ignoreTokenControl=!0,(this.currentTab==="pc"?game.actors.contents.filter(o=>ae(o)):game.actors.contents.filter(o=>!ae(o)&&_e(o))).forEach(o=>{i?(this.selectedActors.add(o.id),re(o.id,!0)):(this.selectedActors.delete(o.id),re(o.id,!1))}),setTimeout(()=>{this._ignoreTokenControl=!1},200),this.render(),this._updateRequestTypesVisibility()}_onToggleLock(t){r.log("_onToggleLock"),t.preventDefault(),this.isLocked=!this.isLocked;const i=t.currentTarget;i.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),i.classList.add(this.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open")}async _onToggleOptions(t){r.log("_onToggleOptions"),t.preventDefault(),this.optionsExpanded=!this.optionsExpanded,await game.user.setFlag(j.ID,"menuOptionsExpanded",this.optionsExpanded);const i=t.currentTarget||t.target.closest(".options-toggle");i&&i.classList.toggle("expanded",this.optionsExpanded);const s=this.element.querySelector("li.options");s&&s.classList.toggle("expanded",this.optionsExpanded)}_initializeFromSelectedTokens(){var i;r.log("_initializeFromSelectedTokens");const t=((i=canvas.tokens)==null?void 0:i.controlled)||[];this.selectedActors.clear();for(const s of t)if(s.actor&&(this.selectedActors.add(s.actor.id),this.selectedActors.size===1)){const o=ae(s.actor);this.currentTab=o?"pc":"npc"}}async _onTabClick(t){var s;r.log("_onTabClick");const i=t.currentTarget.dataset.tab;i!==this.currentTab&&(this.selectedActors.clear(),(s=canvas.tokens)==null||s.releaseAll(),this.selectedRequestType=null,this.currentTab=i,await this.render())}_onActorClick(t){if(r.log("_onActorClick"),t.target.closest(".actor-select"))return;const s=t.currentTarget.dataset.id;this._toggleActorSelection(s)}_onActorSelectClick(t){r.log("_onActorSelectClick"),t.stopPropagation();const i=t.currentTarget.dataset.id;this._toggleActorSelection(i)}_toggleActorSelection(t){r.log("_toggleActorSelection"),this._ignoreTokenControl=!0,this.selectedActors.has(t)?(this.selectedActors.delete(t),re(t,!1)):(this.selectedActors.add(t),re(t,!0)),setTimeout(()=>{this._ignoreTokenControl=!1},100),this.render(),this._updateRequestTypesVisibility(),this._updateSelectAllState()}_updateRequestTypesVisibility(){r.log("_updateRequestTypesVisibility"),this.render()}_updateSelectAllState(){r.log("_updateSelectAllState");const t=this.element.querySelector("#crlngn-actors-all"),i=this.currentTab==="pc"?"pc":"npc",s=this.element.querySelectorAll(`.${i}-actors .actor-item input[type="checkbox"]`),o=Array.from(s).filter(l=>l.checked).length;t.checked=o>0&&o===s.length,t.indeterminate=o>0&&o<s.length}async _onRequestTypeClick(t){const i=t.currentTarget,s=i.dataset.id,o=j.ROLL_REQUEST_OPTIONS[s];if(r.log("_onRequestTypeClick",[s,i.dataset,o]),!o){r.error("Unknown request type:",[s]);return}this.selectedRequestType===s?this.selectedRequestType=null:this.selectedRequestType=s,o.subList?await this.render():this.selectedRequestType&&this._triggerRoll(s,null)}_onRollTypeClick(t){r.log("_onRollTypeClick");const i=t.currentTarget.dataset.id;this._triggerRoll(this.selectedRequestType,i)}_getValidActorIds(t){return t.filter(i=>{const s=game.actors.get(i);if(!s)return!1;const o=ae(s),l=!o&&_e(s);return this.currentTab==="pc"&&o||this.currentTab==="npc"&&l})}async _handleCustomRoll(){return await this._showCustomRollDialog()}async _getRollConfiguration(t,i,s,o,l){const n=O(),c=E.get(n.rollRequestsEnabled.tag);if(!o&&i!==d.CUSTOM){let u;[d.SKILL,d.TOOL].includes(i)?u=Ae:i===d.HIT_DIE?u=Ee:u=$;const g=await u.initConfiguration(t,i,s,{skipRollDialog:o,sendRequest:c||!1});return r.log("_getRollConfiguration",[g]),g}else{const u={rolls:[{parts:[],data:{},options:{}}],advantage:!1,disadvantage:!1,rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:!0,sendRequest:c&&l.length>0};return i===d.DEATH_SAVE&&(u.target=10),u}}async _orchestrateRollsForActors(t,i,s,o,l){const n=O(),c=[],u=[],g=[];if(r.log("_orchestrateRollsForActors",[t,i,s]),t.sendRequest)for(const{actor:h,owner:R}of i)R.active?g.push({actor:h,owner:R}):(E.get(n.showOfflineNotifications.tag)&&P.notify("info",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.playerOffline",{player:R.name})),u.push(h));else s.push(...i.map(({actor:h})=>h));for(const{actor:h,owner:R}of g)await this._sendRollRequestToPlayer(h,R,o,l,t,!0),c.push({actor:h,owner:R}),await Te(100);c.length>0&&this._showConsolidatedNotification(c,o,l);const f=[...u,...s];f.length>0&&(t.skipRollDialog=!0,await this._handleGMRolls(f,o,l,t))}async _triggerRoll(t,i){var b,m,C;r.log("_triggerRoll",[t,i]);const s=O(),o=Array.from(this.selectedActors),l=E.get(s.skipRollDialog.tag),n=this._getValidActorIds(o);let c=n.map(y=>game.actors.get(y));const u=j.ROLL_REQUEST_OPTIONS[t],g=(b=(u==null?void 0:u.name)||t)==null?void 0:b.toLowerCase();switch(g){case d.CUSTOM:if(i=await this._handleCustomRoll(),!i)return;break;case d.INITIATIVE:case d.INITIATIVE_DIALOG:if(await Oe()){r.log("_triggerRoll - initiative",[n]);for(const _ of n){const T=game.actors.get(_);if(T){const D=game.combat.getCombatantsByActor(_);(!D||D.length===0)&&(r.log("_triggerRoll - adding actor to combat",T.name),await game.combat.createEmbeddedDocuments("Combatant",[{actorId:_,tokenId:(C=(m=T.getActiveTokens())==null?void 0:m[0])==null?void 0:C.id}]))}}const p=await ke(n,game);if(r.log("_triggerRoll filteredActorIds",[p,!p.length]),!p.length)return;c=p.map(_=>game.actors.get(_))}break;case d.DEATH_SAVE:c=await Qe(c);break}if(!c.length){P.notify("warn","No valid actors selected");return}const{pcActors:f,npcActors:h}=Je(c),R=await this._getRollConfiguration(c,g,i,l,f);r.log("_triggerRoll config",[R]),R&&(await this._orchestrateRollsForActors(R,f,h,g,i),setTimeout(()=>this.close(),500))}async _sendRollRequestToPlayer(t,i,s,o,l,n=!1){r.log("_sendRollRequestToPlayer #A",[s,o]);const c=O();let u=s==null?void 0:s.toLowerCase();if(u===d.ABILITY_CHECK?u=d.ABILITY:u===d.SAVING_THROW?u=d.SAVE:u===d.INITIATIVE_DIALOG&&(u=d.INITIATIVE),u===d.HIT_DIE){const f=t.system.attributes.hd;if(f.value>0)o=f.largestAvailable;else if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["crlngn-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("CRLNGN_ROLLS.ui.dialogs.hitDie.refillMessage",{actors:t.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){try{r.log("About to call handleHitDieRecovery for",[t.name]);const R=await B.handleHitDieRecovery(t);r.log("handleHitDieRecovery completed",[R])}catch(R){r.error("Error calling handleHitDieRecovery:",[R])}o=t.system.attributes.hd.largestAvailable,r.log("_sendRollRequestToPlayer - Hit Die REFILL",[{hdData:t.system.attributes.hd}]),P.notify("info",game.i18n.format("CRLNGN_ROLLS.ui.dialogs.hitDie.refilled",{actor:t.name})||`Hit dice refilled for ${t.name}`)}else return}const g={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:t.id,rollType:u,rollKey:o,activityId:null,rollProcessConfig:{...l,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(f=>f.id),preserveTargets:E.get(c.useGMTargetTokens.tag)};U.execForUser("handleRollRequest",i.id,g),n||P.notify("info",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollRequestSent",{player:i.name,actor:t.name}))}_showConsolidatedNotification(t,i,s){var c,u,g,f,h;r.log("_showConsolidatedNotification");const o={};for(const{actor:R,owner:b}of t)o[b.id]||(o[b.id]={player:b,actors:[]}),o[b.id].actors.push(R);for(const[R,b]of Object.entries(j.ROLL_REQUEST_OPTIONS))if(b.name===i)break;const l=i;let n=game.i18n.localize(`CRLNGN_ROLLS.rollTypes.${l}`)||l;if(s){const R=l.toLowerCase();if(R===d.SKILL)n=`${n} (${((c=CONFIG.DND5E.skills[s])==null?void 0:c.label)||s})`;else if(R===d.SAVING_THROW)n=`${n} (${((u=CONFIG.DND5E.abilities[s])==null?void 0:u.label)||s})`;else if(R===d.ABILITY_CHECK)n=`${n} (${((g=CONFIG.DND5E.abilities[s])==null?void 0:g.label)||s})`;else if(R===d.TOOL){const b=(h=(f=CONFIG.DND5E.enrichmentLookup)==null?void 0:f.tools)==null?void 0:h[s];if(b!=null&&b.id){const m=dnd5e.documents.Trait.getBaseItem(b.id,{indexOnly:!0});n=`${n} (${(m==null?void 0:m.name)||s})`}else n=`${n} (${s})`}else R===d.CUSTOM&&(n=`${n}: ${s}`)}P.notifyRollRequestsSent(o,n)}async _handleGMRolls(t,i,s,o){r.log("_handleGMRolls",[t,i,s,o]);for(const l of t)await this._initiateRoll(l,i,s,o),await Te(100)}async _initiateRoll(t,i,s,o){var l,n,c,u,g;r.log("_initiateRoll",[i,s,o]);try{const f=i.toLowerCase();let h=s;if(f===d.HIT_DIE){const _=t.system.attributes.hd;if(_){const T=["d6","d8","d10","d12","d20"];for(const D of T)if((((l=_[D])==null?void 0:l.value)||0)>0){h=D;break}}if(!h)if(r.log("_initiateRoll - No hit dice available",[t.name]),await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["crlngn-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("CRLNGN_ROLLS.ui.dialogs.hitDie.refillMessageLocal",{actors:t.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("CRLNGN_ROLLS.ui.dialogs.hitDie.refillAndRoll")||"Refill & Roll",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){const D=await B.handleHitDieRecovery(t);if(r.log("Hit die recovery result",[D]),P.notify("info",game.i18n.format("CRLNGN_ROLLS.ui.dialogs.hitDie.refilled",{actor:t.name})),h=t.system.attributes.hd.largestAvailable,!h){P.notify("warn",game.i18n.format("DND5E.HitDiceWarn",{name:t.name}));return}}else return}const R=((u=(c=(n=o.rolls)==null?void 0:n[0])==null?void 0:c.data)==null?void 0:u.situational)||"",b={rollKey:h,config:{...o,situational:R,rollMode:o.rollMode||game.settings.get("core","rollMode"),advantage:o.advantage||!1,disadvantage:o.disadvantage||!1,target:o.target}},m={configure:!o.fastForward&&!o.skipRollDialog,isRollRequest:!0},C={rollMode:o.rollMode||game.settings.get("core","rollMode"),create:o.chatMessage!==!1,isRollRequest:!0},y=((g=o.rolls)==null?void 0:g[0])||{},p=B[f];p?await p(t,b,y,m,C):P.notify("warn",`Unknown roll type: ${i}`)}catch(f){r.error("executeActorRoll",[f]),P.notify("error",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollError",{actor:t.name}))}}async _onClose(t){r.log("_onClose",[t]),await super._onClose(t),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),this._tokenControlHook&&(Hooks.off("controlToken",this._tokenControlHook),this._tokenControlHook=null),this._tokenUpdateTimeout&&(clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=null),Q(ee,z)===this&&he(ee,z,null)}setPosition(t={}){return r.log("setPosition"),this}async _showCustomRollDialog(){return r.log("_showCustomRollDialog"),pe.prompt({formula:"",readonly:!1})}static toggle(){r.log("RollRequestsMenu.toggle"),Q(this,z)?Q(this,z).rendered?Q(this,z).close():(Q(this,z)._initializeFromSelectedTokens(),Q(this,z).render(!0)):(he(this,z,new ee),Q(this,z).render(!0))}};z=new WeakMap,fe(ee,z,null),N(ee,"DEFAULT_OPTIONS",{id:"flash-rolls-menu",classes:["flash-rolls-menu"],tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:{}}),N(ee,"PARTS",{main:{template:`modules/${j.ID}/templates/requests-menus.hbs`}});let me=ee;class we{static addSidebarControls(e,t,i){if(!game.user.isGM||e.id!=="sidebar")return;const s=document.querySelector("#roll-privacy");if(r.log("addSidebarControls",[s]),!s||s.querySelector(".flash-rolls-icon"))return;const o=O(),l=E.get(o.rollRequestsEnabled.tag),n=document.createElement("button");n.id="flash-rolls-icon",n.setAttribute("data-tooltip-direction","RIGHT"),n.className=`ui-control icon chat-control-icon flash-rolls-icon${l?" active":""}`,n.title=game.i18n.localize("CRLNGN_ROLLS.ui.menus.rollRequestsTitle"),n.innerHTML=`<i class="fas fa-bolt${l?"":"-slash"}"></i>`;const c=s.firstChild;c?c.parentNode.insertBefore(n,c):s.insertBefore(n,s.firstChild),r.log("addSidebarControls",[c,n]),n.addEventListener("click",u=>{u.stopPropagation(),u.preventDefault(),me.toggle()})}static updateRollRequestsIcon(e){const t=document.querySelector("#flash-rolls-icon i");t&&(t.className=`fas fa-bolt${e?"":"-slash"}`)}}class ve{static initialize(){Hooks.once(X.INIT,this._onInit.bind(this)),Hooks.once(X.READY,this._onReady.bind(this))}static _onInit(){O(),document.body.classList.add("flash-rolls-5e"),E.registerSettings(),te.initialize(),this._registerHooks()}static _onReady(){const e=O();E.get(e.debugMode.tag)&&(CONFIG.debug.hooks=!0),game.user.isGM?(Ne.initialize(),this._registerGMHooks()):(te.getDiceConfig(),this._registerPlayerHooks()),Ie(Le())}static _registerHooks(){this._registerHook(X.RENDER_SIDEBAR,this._onRenderSidebar.bind(this)),this._registerHook(X.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessage.bind(this)),this._registerHook(X.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageFlavor.bind(this)),this._registerHook(X.CHANGE_SIDEBAR_TAB,this._onSidebarUpdate.bind(this)),this._registerHook(X.COLLAPSE_SIDE_BAR,this._onSidebarUpdate.bind(this)),this._registerHook(G.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this)),this._registerHook(G.RENDER_SKILL_TOOL_ROLL_DIALOG,this._onRenderSkillToolDialog.bind(this)),this._registerHook(G.PRE_USE_ACTIVITY,this._onPreUseActivity.bind(this)),this._registerHook(G.PRE_ROLL_HIT_DIE_V2,this._onPreRollHitDieV2.bind(this)),this._registerHook(G.POST_ROLL_CONFIG,this._onPostRollConfig.bind(this))}static _registerGMHooks(){this._registerHook(X.USER_CONNECTED,this._onUserConnected.bind(this)),game.users.forEach(e=>{this._onUserConnected(e)})}static _registerPlayerHooks(){this._registerHook(G.PRE_ROLL_INITIATIVE_DIALOG,this._onPreRollInitiativeDialog.bind(this)),this._registerHook(G.PRE_ROLL_ATTACK_V2,this._onPreRollAttackV2.bind(this))}static _onSidebarUpdate(e){r.log("_onSidebarUpdate",[e]),Ie(Le())}static _onPostRollConfig(e,t,i,s){t._showRequestedBy&&e.length>0&&(s.data=s.data||{},s.data._showRequestedBy=!0,s.data._requestedBy=t._requestedBy)}static _onPreCreateChatMessage(e,t,i,s){var o;if(t._showRequestedBy&&((o=t.rolls)==null?void 0:o.length)>0){const l=t._requestedBy||"GM",n=game.i18n.format("CRLNGN_ROLL_REQUESTS.chat.requestedBy",{gm:l}),c=t.flavor||"";t.flavor=c?`${c} ${n}`:n}}static _onPreCreateChatMessageFlavor(e,t,i,s){var o,l;if(((o=t.rolls)==null?void 0:o.length)>0&&t.rolls[0])try{const n=t.rolls[0];(l=n.options)!=null&&l._customFlavor&&(t.flavor=n.options._customFlavor)}catch(n){r.error("_onPreCreateChatMessageFlavor",[n])}}static _onRenderRollConfigDialog(e,t,i){var l,n,c,u,g;if(r.log("_onRenderRollConfigDialog triggered",[e,i]),e._flashRollsApplied)return;if(((n=(l=e.config)==null?void 0:l.hookNames)==null?void 0:n.includes("initiativeDialog"))||((u=(c=e.element)==null?void 0:c.id)==null?void 0:u.includes("initiative"))){const f=(g=e.config)==null?void 0:g.subject;if(!f)return;if(f.getFlag(v,"tempInitiativeConfig")){e._flashRollsApplied=!0;const R=t.querySelector('input[name*="situational"]');setTimeout(()=>{R.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},50)}return}t.querySelectorAll('input[name*="situational"]').forEach((f,h)=>{var R,b,m,C,y;!f.value&&((C=(m=(b=(R=e.config)==null?void 0:R.rolls)==null?void 0:b[0])==null?void 0:m.data)!=null&&C.situational)&&((y=e.config)!=null&&y.isConcentration)&&(f.value=e.config.rolls[0].data.situational),f.value&&(e._flashRollsApplied=!0,setTimeout(()=>{var p,_,T;f.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1})),(T=(_=(p=e.config)==null?void 0:p.rolls)==null?void 0:_[0])!=null&&T.data&&delete e.config.rolls[0].data.situational},50))})}static _onUserConnected(e){e.active&&e.id!==game.user.id&&te.requestDiceConfigFromUser(e.id)}static _onRenderApplicationV2(e,t,i){r.log("_onRenderApplicationV2",[e,t,i])}static _onRenderSidebar(e,t,i){r.log("_onRenderSidebar",[e,t,i]),we.addSidebarControls(e,t,i)}static _registerHook(e,t){const i=Hooks.on(e,t);return this.registeredHooks.set(`${e}_${i}`,i),i}static unregisterAll(){this.registeredHooks.forEach((e,t)=>{const i=t.split("_")[0];Hooks.off(i,e)}),this.registeredHooks.clear()}static isRegistered(e){for(const t of this.registeredHooks.keys())if(t.startsWith(`${e}_`))return!0;return!1}static _onPreRollHitDieV2(e,t,i){if(r.log("_onPreRollHitDieV2 triggered",[e,t,i]),e.rolls&&e.rolls.length>1){const s=[];for(let o=0;o<e.rolls.length;o++){const l=e.rolls[o];l&&l.data&&l.data.situational&&s.push(l.data.situational)}if(s.length>0){e.rolls[0].data||(e.rolls[0].data={});const o=[...new Set(s)];e.rolls[0].data.situational=o.map(l=>{const n=l.toString().trim();return n.startsWith("-")?`(${n})`:n.startsWith("+")?`${n.substring(1)}`:`${n}`}).join(" + "),game.user.isGM&&!e.rolls[0].parts.find(l=>l.includes("@situational"))&&e.rolls[0].parts.push("@situational")}e.rolls=e.rolls.slice(0,1),r.log("Cleaned up hit die rolls",e.rolls)}}static _onPreRollInitiativeDialog(e,t,i){var l,n,c,u,g;const o=e.subject.getFlag(v,"tempInitiativeConfig");r.log("_onPreRollInitiativeDialog triggered",[e,o,t,i]),e.advantage=(o==null?void 0:o.advantage)||e.advantage||!1,e.disadvantage=(o==null?void 0:o.disadvantage)||e.disadvantage||!1,e.rollMode=(o==null?void 0:o.rollMode)||e.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,i.rollMode=(o==null?void 0:o.rollMode)||i.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,(c=(n=(l=o.rolls)==null?void 0:l[0])==null?void 0:n.data)!=null&&c.situational&&((g=(u=e.rolls)==null?void 0:u[0])!=null&&g.data)&&(e.rolls[0].data.situational=o.rolls[0].data.situational)}static _onPreRollAttackV2(e,t,i){var o,l;r.log("_onPreRollAttackV2 triggered",[e,t,i]);const s=(l=(o=e.subject)==null?void 0:o.item)==null?void 0:l.getFlag(v,"tempAttackConfig");if(s){if(r.log("_onPreRollAttackV2 - Found stored request config from flag",[s]),s.isRollRequest===!1||s.skipRollDialog===!0||s.sendRequest===!1){r.log("_onPreRollAttackV2 - Not a roll request, skipping",[s]);return}s.attackMode&&(e.attackMode=s.attackMode),s.ammunition&&(e.ammunition=s.ammunition),s.mastery!==void 0&&(e.mastery=s.mastery),e.advantage=s.advantage||!1,e.disadvantage=s.disadvantage||!1,i.rollMode=s.rollMode||i.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,s.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=s.situational),r.log("_onPreRollAttackV2 - Applied stored configuration to attack roll",[e,i])}}static _onPreUseActivity(e,t,i,s){r.log("_onPreUseActivity triggered",[e,t,i,s]);const o=O(),l=E.get(o.rollRequestsEnabled.tag),n=E.get(o.rollInterceptionEnabled.tag);if(r.log("_onPreUseActivity - Settings",[l,n]),e.item.unsetFlag(v,"tempAttackConfig"),!game.user.isGM||!l||!n)return;const c=e.actor;if(!c)return;i.configure=!1;const u=W.getActorOwner(c);u&&u.active&&!u.isGM&&(r.log("Preventing usage message for player-owned actor",[c.name]),s.create=!1)}static _onRenderSkillToolDialog(e,t,i){var o,l;if(r.log("_onRenderSkillToolDialog triggered",[e]),e._abilityFlavorFixed)return;const s=t.querySelector('select[name="ability"]');if(s&&(o=e.config)!=null&&o.isRollRequest&&(l=e.config)!=null&&l.ability){const n=s.value,c=e.config.ability;n===c&&(e._abilityFlavorFixed=!0,setTimeout(()=>{const u=new Event("change",{bubbles:!0,cancelable:!0});s.dispatchEvent(u)},50))}}}N(ve,"registeredHooks",new Map);class be{static async handleRequest(e){var i;if(r.log("handleRequest",[e]),game.user.isGM)return;const t=game.actors.get(e.actorId);!t||!t.isOwner||(e.preserveTargets&&((i=e.targetTokenIds)==null?void 0:i.length)>0&&game.user.targets.size===0&&Ke(e.targetTokenIds),P.notify("info","",{batch:!0,batchData:{actor:t.name,rollType:e.rollType,rollKey:e.rollKey,gm:e.rollProcessConfig._requestedBy||"GM"}}),be.executePlayerRollRequest(t,e))}static async executePlayerRollRequest(e,t){var o,l;const i=O(),s=E.get(i.publicPlayerRolls.tag);r.log("executePlayerRollRequest",[e,t]);try{const n=(o=t.rollType)==null?void 0:o.toLowerCase(),c=((l=t.rollProcessConfig.rolls)==null?void 0:l[0])||{parts:[],data:{},options:{}},g={configure:!(game.user.isGM?t.skipRollDialog:!1)},f=t.rollProcessConfig.rollMode,h=game.settings.get("core","rollMode"),R=f||h;r.log("executePlayerRollRequest - Roll Mode Debug",{publicPlayerRolls:s,rollModeFromGM:f,defaultRollMode:h,finalRollMode:R,fullConfig:t.rollProcessConfig});const b={rollMode:R,create:t.rollProcessConfig.chatMessage!==!1},m={rollKey:t.rollKey,activityId:t.activityId,config:t.rollProcessConfig},C=B[n];C?await C(e,m,c,g,b):(r.warn(`No handler found for roll type: ${n}`),P.notify("warn",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollError",{actor:e.name||"Unknown Actor"})))}catch(n){r.error("Error executing roll request:",[n]),P.notify("error",game.i18n.format("CRLNGN_ROLL_REQUESTS.notifications.rollError",{actor:e.name||"Unknown Actor"}))}}}class ie{static init(){U.initialize(ie.registerSocketCalls),ve.initialize()}static getDiceConfig(){return te.getDiceConfig()}static receiveDiceConfig(e,t){te.receiveDiceConfig(e,t)}static async handleRollRequest(e){return be.handleRequest(e)}static registerSocketCalls(){U.registerCall(Re.getDiceConfig,ie.getDiceConfig),U.registerCall(Re.receiveDiceConfig,ie.receiveDiceConfig),U.registerCall(Re.handleRollRequest,ie.handleRollRequest)}}ie.init();
//# sourceMappingURL=flash-rolls-5e.js.map
