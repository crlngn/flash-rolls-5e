var st=Object.defineProperty;var Pe=d=>{throw TypeError(d)};var ot=(d,e,t)=>e in d?st(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var w=(d,e,t)=>ot(d,typeof e!="symbol"?e+"":e,t),De=(d,e,t)=>e.has(d)||Pe("Cannot "+t);var P=(d,e,t)=>(De(d,e,"read from private field"),t?t.call(d):e.get(d)),re=(d,e,t)=>e.has(d)?Pe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(d):e.set(d,t),ce=(d,e,t,s)=>(De(d,e,"write to private field"),s?s.call(d,t):e.set(d,t),t),Re=(d,e,t)=>(De(d,e,"access private method"),t);const j={select:"select",checkbox:"checkbox"},V={client:"client",world:"world"},v=()=>({generalSettings:{tag:"flash5e-general-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["showMenuOnLoad","rollInterceptionEnabled","useGMTargetTokens","templateAutoTarget","consumptionConfigMode","showOfflineNotifications","initiateCombatOnRequest","showOnlyPCsWithToken","publicPlayerRolls"],default:{showMenuOnLoad:!1,rollInterceptionEnabled:!0,useGMTargetTokens:!0,templateAutoTarget:1,consumptionConfigMode:4,showOfflineNotifications:!0,initiateCombatOnRequest:!0,showOnlyPCsWithToken:!0,publicPlayerRolls:!0},scope:V.world,config:!1,requiresReload:!1},groupRollsSettings:{tag:"flash5e-group-rolls-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["groupRollsMsgEnabled","groupRollResultMode","showGroupDCToPlayers"],default:{groupRollsMsgEnabled:!0,groupRollResultMode:1,showGroupDCToPlayers:!1},scope:V.world,config:!1,requiresReload:!1},showGroupDCToPlayers:{tag:"show-group-dc-to-players",label:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.hint"),propType:Boolean,inputType:j.checkbox,default:!1,scope:V.world,config:!1},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:V.world,config:!0},groupRollsMsgEnabled:{tag:"group-roll-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:V.world,config:!1},groupRollResultMode:{tag:"group-roll-result-mode",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.hint"),propType:Number,inputType:j.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.4")},default:1,scope:V.world,config:!1},consumptionConfigMode:{tag:"consumption-config-mode",label:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.hint"),propType:Number,inputType:j.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.4")},default:4,scope:V.world,config:!1},skipRollDialog:{tag:"skip-roll-dialog",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.hint"),propType:Boolean,inputType:j.checkbox,default:!1,scope:V.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:V.world,config:!1},rollInterceptionEnabled:{tag:"roll-interception-on",label:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:j.checkbox,default:!1,scope:V.world,config:!1},publicPlayerRolls:{tag:"public-player-rolls",label:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:V.world,config:!1},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:V.world,config:!1},showRequestNotifications:{tag:"show-request-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:V.world,config:!1},initiateCombatOnRequest:{tag:"initiate-combat-on-request",label:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:V.world,config:!1},showOnlyPCsWithToken:{tag:"show-only-pcs-with-token",label:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.hint"),propType:Boolean,inputType:j.checkbox,default:!0,scope:V.world,config:!1},templateAutoTarget:{tag:"template-auto-target",label:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.hint"),propType:Number,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.all.label"),2:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.notFriendly.label"),3:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.none.label")},inputType:j.select,default:1,scope:V.world,config:!1},debugMode:{tag:"debug-mode-on",label:game.i18n.localize("FLASH_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:j.checkbox,default:!1,scope:V.client,config:!0},showMenuOnLoad:{tag:"show-menu-on-world-load",label:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showMenuOnLoad.hint"),propType:Boolean,inputType:j.checkbox,default:!1,scope:V.world,config:!1}}),S="flash-rolls-5e",Le=["%cFlash Rolls 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],Ce={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest"},Ae={DAMAGE:"damage",SAVE:"save"},g={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",ATTACK:"attack",CONCENTRATION:"concentration",CUSTOM:"custom",DEATH_SAVE:"deathsave",FORMULA:"formula",DAMAGE:"damage",HEALING:"healing",HIT_DIE:"hitdie",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",ITEM_SAVE:"itemsave",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool"},it={ABILITY_CHECK:{name:g.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:g.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:g.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:g.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:g.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:g.INITIATIVE,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:g.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:g.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:g.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},K={ID:S,ROLL_REQUEST_OPTIONS:it},F={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessageHTML",RENDER_CHAT_LOG:"renderChatLog",CHANGE_SIDEBAR_TAB:"changeSidebarTab",RENDER_SIDEBAR:"renderSidebar",UPDATE_SCENE:"updateScene",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",COLLAPSE_SIDE_BAR:"collapseSidebar",REFRESH_MEASURED_TEMPLATE:"refreshMeasuredTemplate",CONTROL_TOKEN:"controlToken",DELETE_TOKEN:"deleteToken",CREATE_TOKEN:"createToken",UPDATE_ACTOR:"updateActor",UPDATE_ITEM:"updateItem",CREATE_ITEM:"createItem",DELETE_ITEM:"deleteItem",UPDATE_SETTING:"updateSetting",GET_ACTOR_CONTEXT_OPTIONS:"getActorContextOptions",RENDER_ACTOR_DIRECTORY:"renderActorDirectory"},lt={READY:"socketlib.ready"},at={READY:"midi-qol.ready"},U={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG:"dnd5e.preRollInitiativeDialog",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",ROLL_INITIATIVE:"dnd5e.rollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog",RENDER_SKILL_TOOL_ROLL_DIALOG:"renderSkillToolRollConfigurationDialog"},be=class be{static log(e="",t=[],s=!1){try{const o=game.settings.get(S,"debug-mode-on")||be.debugOn;if(!(s||o))return;const l=Array.isArray(t)?t:[t];console.log(...Le,e,...l)}catch{if(s||be.debugOn){const i=Array.isArray(t)?t:[t];console.log(...Le,e,...i)}}}static warn(e="",t=[]){const s=Array.isArray(t)?t:[t];console.warn(...Le,e,...s)}static error(e,t=[],s={ui:!1,console:!0,permanent:!1}){var i;const o=Array.isArray(t)?t:[t];s.ui&&((i=ui.notifications)==null||i.error(e,{localize:!0,permanent:s.permanent})),s.console&&console.error(...Le,e,...o)}};w(be,"debugOn",!1);let r=be;const x=class x{static serializeForTransport(e,t=!1){return r.log("serializeForTransport",[e,t]),e==null||t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(s=>s instanceof Roll?s.toJSON():s)),e}static deserializeFromTransport(e,t=!1){r.log("deserializeFromTransport",[e,t]);let s={...e};if(!e)return s;if(t&&e.rolls&&e.rolls.length>0){const o=s.rolls.map(i=>{let l=i;return typeof i=="string"?l=Roll.fromJSON(i):l=Roll.fromJSON(JSON.stringify(i)),l});return s.rolls=[...o],s}return s}};w(x,"socket"),w(x,"_activeExecutions",new Map),w(x,"initialize",e=>{r.log("initialize",[e]),Hooks.once(lt.READY,()=>{if(typeof socketlib>"u"){r.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{x.socket=socketlib.registerModule(S),e&&e()}catch{}})}),w(x,"registerCall",(e,t)=>{r.log("registerCall",[e]),x.socket&&x.socket.register(e,t)}),w(x,"sendMessage",(e,t)=>{r.log("sendMessage",[e]),t&&t()}),w(x,"execForGMs",async(e,...t)=>{if(r.log("execForGMs",[e,...t]),!!x.socket)return await x.socket.executeForAllGMs(e,...t)}),w(x,"execForAll",async(e,...t)=>{if(x.socket)return await x.socket.executeForEveryone(e,...t)}),w(x,"execForUser",async(e,t,...s)=>{if(r.log("execForUser #0",[e,t,...s]),!x.socket)return;if(r.log("execForUser #1",[t===game.user.id]),t===game.user.id)return null;const o=`${e}-${t}`;if(r.log("execForUser #2",[x._activeExecutions.has(o)]),x._activeExecutions.has(o))return null;x._activeExecutions.set(o,!0);try{const i=await x.socket.executeAsUser(e,t,...s);return r.log("execForUser #3 - response",[i]),i}catch(i){return r.error("execForUser #4 - error",[i]),null}finally{r.log("execForUser #5 - success",[]),x._activeExecutions.delete(o)}});let ee=x;class ge{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const e=game.settings.storage.get("client");return this.diceConfig=e["core.diceConfiguration"]||"",this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){ee.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(e,t){var s,o;((s=game.user)!=null&&s.isGM||e===((o=game.user)==null?void 0:o.id))&&(this.playerDiceConfigs[e]=t?JSON.parse(t):{})}static getUserDiceConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?this.diceConfig:this.playerDiceConfigs[e]||{}}static requestDiceConfigFromUser(e){ee.execForUser("getDiceConfig",e)}static requestDiceConfigFromAllPlayers(){var e;(e=game.user)!=null&&e.isGM&&game.users.forEach(t=>{t.active&&!t.isGM&&t.id!==game.user.id&&this.requestDiceConfigFromUser(t.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?!!this.diceConfig:!!this.playerDiceConfigs[e]}}w(ge,"diceConfig",{}),w(ge,"playerDiceConfigs",{});var _e,$e;class H{static isModuleOn(e){var s;const t=(s=game.modules)==null?void 0:s.get(e);return!!(t!=null&&t.active)}static html(e,t){return e.querySelector(t)}static getFullWidth(e){return window.getComputedStyle(e).width==="0px"?0:e.offsetWidth}static preventDialogFlicker(e,t=100){e&&(e.style.opacity="0",e.style.transition="opacity 0.15s ease-in",setTimeout(()=>{e&&(e.style.opacity="1")},t))}static addCSSVars(e,t){let s=document.querySelector("#flash5e-vars");if(!s){const f=document.querySelector("body.flash5e");if(!f)return;s=document.createElement("style"),s.id="flash5e-vars",s.textContent=`body.flash5e {
}
`,f.prepend(s)}let o=s.textContent,i=o.indexOf("body.flash5e {"),l=o.indexOf("}",i);i===-1&&(o=`body.flash5e {
}
`,i=0,l=o.indexOf("}"));const n=o.substring(i+14,l).split(";").map(f=>f.trim()).filter(f=>f!==""),c={};n.forEach(f=>{const m=f.split(":");if(m.length>=2){const R=m[0].trim(),b=m.slice(1).join(":").trim();R&&(c[R]=b)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),c[e]=t;const u=Object.entries(c).map(([f,m])=>`  ${f}: ${m};`).join(`
`),h=o.substring(0,i)+`body.flash5e {
`+u+`
}`+o.substring(l+1);s.textContent=h}static getOffsetBottom(e){const t=e.offsetTop,s=e.offsetHeight;return window.innerHeight-(t+s)}static async getAllFonts(){const e=new Set(Object.keys(CONFIG.fontDefinitions)),t=game.settings.get("core","fonts")||{},s=Object.entries(t).map(([l])=>l),o=await this.processStyleSheets();return Array.from(new Set([...e,...s,...o])).filter(l=>!/FontAwesome|Font Awesome|FoundryVTT/.test(l)).map(l=>l.replace(/['"]/g,"").trim()).sort((l,a)=>l.toLowerCase().localeCompare(a.toLowerCase()))||[]}static addCustomCSS(e,t="flash5e-custom-css",s=!0){if(!e)return;let o=document.querySelector("#"+t);o||(o=document.createElement("style"),o.id=t,o.textContent="",document.head.appendChild(o));const i=/@import\s+(?:url\()?\s*['"]?[^'")]+['"]?\s*\)?\s*;/g,l=[];let a=e,n;for(;(n=i.exec(e))!==null;)l.push(n[0]);if(a=e.replace(i,"").trim(),!s){o.textContent=l.join(`
`)+(l.length?`

`:"")+a;return}if(!o.textContent.includes(a)){const c=o.textContent,u=[];let h;for(;(h=i.exec(c))!==null;)u.push(h[0]);const f=c.replace(i,"").trim(),m=l.filter(b=>!u.includes(b)),R=[...u,...m];o.textContent=R.join(`
`)+(R.length?`

`:"")+f+(f&&a?`

`:"")+a}}static smoothScrollTo(e,t,s="horizontal",o=300,i=null){const l=e.dataset.scrollAnimationId;l&&cancelAnimationFrame(Number(l));const a=s==="horizontal",n=a?e.scrollLeft:e.scrollTop,c=t-n;if(c===0)return i&&i(),null;const u=performance.now(),h=m=>{const R=m-u;if(R>=o){a?e.scrollLeft=t:e.scrollTop=t,delete e.dataset.scrollAnimationId,i&&i();return}const b=R/o,T=b<.5?2*b*b:1-Math.pow(-2*b+2,2)/2;a?e.scrollLeft=n+c*T:e.scrollTop=n+c*T;const y=requestAnimationFrame(h);return e.dataset.scrollAnimationId=y,y},f=requestAnimationFrame(h);return e.dataset.scrollAnimationId=f,f}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredLabel"),s={}){const o={window:{title:e},position:{width:420,height:"auto"},content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.reloadButton"),callback:()=>(r.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(o,s),foundry.applications.api.DialogV2.confirm(o)}static renderTemplate(e,t){return foundry.applications.handlebars.renderTemplate(e,t)}static loadTemplate(e){return foundry.applications.handlebars.loadTemplate(e)}static loadTemplates(e){return Array.isArray(e)||(e=[e]),foundry.applications.handlebars.loadTemplates(e)}static isValidCSSRule(e){if(!e||typeof e!="string")return!1;const t=e.trim();if(!t)return!1;try{const s=document.createElement("style"),o=`${t} { color: inherit; }`;s.textContent=o,document.head.appendChild(s);const i=!!(s.sheet&&s.sheet.cssRules&&s.sheet.cssRules.length>0);return document.head.removeChild(s),i}catch(s){return r.log("CSS validation error:",[s,e]),!1}}static processCSSRules(e,t){if(!e||!t)return"";const s=Re(this,_e,$e).call(this,e),o=t+` {
`+s.baseProperties.join(`
`)+`
}`,i=[],l=new Map;return s.nestedRules.forEach(a=>{const{selector:n,content:c}=a;if(n.startsWith("&")){const f=n.substring(1),m=t.split(",").map(R=>R.trim()).filter(Boolean).map(R=>R+f).join(", ");i.push(`${m} {
${c}
}`);return}l.has(c)||l.set(c,[]);const u=n.split(",").map(f=>f.trim()),h=t.split(",").map(f=>f.trim()).filter(Boolean);u.forEach(f=>{h.forEach(m=>{l.get(c).push(`${m} ${f}`)})})}),l.forEach((a,n)=>{i.push(`${a.join(", ")} {
${n}
}`)}),o+`

`+i.join(`

`)}static getActorOwner(e){const t=e.ownership||{};for(const[s,o]of Object.entries(t))if(o>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const i=game.users.get(s);if(i&&!i.isGM)return i}if((t==null?void 0:t.default)>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const s=game.users.filter(o=>!o.isGM)[0];if(s)return s}return null}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredLabel"),s={}){const o={window:{title:e},position:{width:420,height:"auto"},content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.reloadButton"),callback:()=>(r.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(o,s),foundry.applications.api.DialogV2.confirm(o)}}_e=new WeakSet,$e=function(e){const t=[],s=[],o=e.split(`
`);let i=null,l=0;for(let a=0;a<o.length;a++){const n=o[a].trim();if(!n)continue;const c=(n.match(/{/g)||[]).length,u=(n.match(/}/g)||[]).length;if(n.includes("{")&&!i){i={selector:n.substring(0,n.indexOf("{")).trim(),content:"",startLine:a},l=1;const f=n.substring(n.indexOf("{")+1).trim();f&&!f.includes("}")&&(i.content+=f+`
`)}else i?(l+=c-u,l>0?i.content+=n+`
`:(i.content=i.content.replace(/}\s*$/,"").trim(),s.push(i),i=null)):!n.includes("{")&&!n.includes("}")&&t.push(n)}return{baseProperties:t,nestedRules:s}},re(H,_e),w(H,"wrapFontName",e=>{const t=e.replace(/['"`]/g,"");return t.includes(" ")?`"${t}"`:t});const{FormDataExtended:_t}=foundry.utils,{ApplicationV2:nt,HandlebarsApplicationMixin:rt}=foundry.applications.api;var Be,le,me,Me,ne,je,We,Ye;const M=class M extends rt(nt){constructor(){super(...arguments);w(this,"_onRender",(t,s)=>{v(),ce(M,le,this.element),P(M,le).querySelectorAll(".toggle-hint").forEach(l=>{l.addEventListener("click",()=>{P(M,le).querySelectorAll("p.hint").forEach(a=>a.classList.toggle("shown"))})}),P(M,le).querySelectorAll("select[data-current-value]").forEach(l=>{const a=String(l.dataset.currentValue),n=l.querySelector(`option[value="${a}"]`);n&&(n.selected=!0)})})}_configureRenderParts(t){const s=super._configureRenderParts(t),o=M.getRestrictedTabs();return game.user.isGM||o.forEach(i=>{delete s[i]}),s}async _prepareContext(t){const s=await super._prepareContext(t);return s.activeTab=t.activeTab||Object.keys(s.tabs)[0],s.isGM=game.user.isGM,s}async _preparePartContext(t,s,o){var a,n,c;const i=await super._preparePartContext(t,s,o);t in s.tabs&&(i.tab=i.tabs[t]),v(),Ke();const l=M.getRestrictedTabs();switch(game.user.isGM||l.forEach(u=>{delete i.tabs[u]}),t){case"tabs":break;case"footer":{i.buttons=[{type:"button",icon:"",label:"FLASH_ROLLS.ui.buttons.reset",action:"redefine"},{type:"submit",icon:"",label:"FLASH_ROLLS.ui.buttons.save"}];break}default:{i.tab=i.tabs[t];const u=((a=M.PARTS[t])==null?void 0:a.menuKey)||null;if(u){const h=M.getMenuContext(u);h.fields&&(i.fields={...i.fields,...h.fields}),h.fieldDefaults&&(i.fieldDefaults={...i.fieldDefaults,...h.fieldDefaults}),h.fieldValues&&Object.assign(i,h.fieldValues),i.sidebarTabs=Object.values(((c=(n=foundry.applications)==null?void 0:n.sidebar)==null?void 0:c.tabs)||{}).map(f=>({tabName:f.tabName,name:f.name,hideForGM:!1,hideForPlayer:!1,localizedName:`FLASH_ROLLS.settings.sidebarTabs.${f.name}`}))}break}}return r.log("_preparePartContext",[i,t]),i}static getMenuContext(t){var n;const s=v(),o=((n=s[t])==null?void 0:n.fields)||null;if(!o)return{};const i={},l={},a={};return o.forEach(c=>{if(s[c]){const u=I.get(s[c].tag);i[c]=s[c],l[c]=u!==void 0?u:s[c].default,a[c]=s[c].default}}),{fields:i,fieldValues:l,fieldDefaults:a}}static getRestrictedTabs(){const t=[];return Object.entries(M.PARTS).forEach((s,o)=>{s[0]!=="tabs"&&s[0]!=="footer"&&s[1].isGMOnly&&t.push(s[0])}),t}static updateSettings(t){let s=!1;const o=v(),a=P(M,le).querySelector(".form-content.active").dataset.tab;if(ce(M,me,a),!t)return;let n;return t.object&&(n=foundry.utils.expandObject(t.object)),Object.entries(n).forEach(([c,u])=>{var h;if(!c.endsWith("_value")&&(r.log("updateSettings #1",[o,o[c]]),n[c]!==void 0&&o[c])){const f=I.get(o[c].tag);I.set(o[c].tag,n[c]),(h=o[c])!=null&&h.requiresReload&&f!==n[c]&&(s=!0)}}),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.settingsUpdated")),s}changeTab(t,s,o){super.changeTab(t,s,o),ce(M,me,t)}};le=new WeakMap,me=new WeakMap,Me=new WeakMap,ne=new WeakSet,je=async function(t,s,o){t.preventDefault(),t.stopPropagation(),M.updateSettings(o)&&H.confirmReload()},We=async function(t,s){const o=v(),l=P(M,le).querySelector(".form-content.active"),a=l.dataset.tab,n=M.PARTS[a].menuKey,c=o[n].default;l.querySelectorAll("input, select").forEach(h=>{h.value=c[h.name],h.type==="checkbox"&&(h.checked=c[h.name])}),r.log("#onReset",[P(M,me),a,t,s])},Ye=function(){const t=[];return Object.entries(M.PARTS).forEach(([s,o])=>{o.menuKey&&t.push({id:s,icon:"",group:"primary-tabs",label:`FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${s}`})}),t},re(M,ne),re(M,le),re(M,me),re(M,Me),w(M,"selectedTheme"),w(M,"DEFAULT_OPTIONS",{id:"flash-rolls-settings",tag:"form",window:{icon:"fas fa-cog",title:"FLASH_ROLLS.settings.moduleSettingsMenu.title",contentClasses:["standard-form","crlngn","flash5e","tabbed-settings"],resizable:!0},position:{width:700,height:"auto"},actions:{redefine:Re(M,ne,We)},form:{handler:Re(M,ne,je),closeOnSubmit:!0}}),w(M,"PARTS",{tabs:{template:"templates/generic/tab-navigation.hbs",isGMOnly:!1},generalSettings:{menuKey:"generalSettings",template:"modules/flash-rolls-5e/templates/settings-general.hbs",isGMOnly:!0},groupRolls:{menuKey:"groupRollsSettings",template:"modules/flash-rolls-5e/templates/settings-group-rolls.hbs",isGMOnly:!0},footer:{template:"templates/generic/form-footer.hbs",isGMOnly:!1}}),w(M,"TABS",{primary:{initial:"generalSettings",tabs:Re(Be=M,ne,Ye).call(Be),labelPrefix:""}});let Oe=M;function Ke(){return{moduleSettingsMenu:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),name:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),icon:"fas fa-cog",propType:Oe,restricted:!0}}}const se=class se{static registerSettings(){const e=v();var t=se.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),Object.entries(e).forEach(o=>{const i=o[1],l={name:i.label,hint:i.hint,default:i.default,type:i.propType,scope:i.scope,config:i.config,requiresReload:i.requiresReload||!1,restricted:i.scope===V.world,onChange:a=>se.apply(i.tag,a)};i.choices&&(l.choices=i.choices),r.log("registerSettings",[l,l.scope],!0);try{game.settings.register(S,i.tag,l)}catch(a){r.log(`Setting ${i.tag} already registered or error:`,a)}})}static registerSettingsMenu(){var s;const t=Object.entries(Ke()).find(o=>o[0]==="moduleSettingsMenu");if(t){const o=t[1];if(o.restricted&&((s=game.user)!=null&&s.isGM)||!o.restricted){const i={name:o.tag,label:o.label,hint:o.hint,icon:o.icon,type:o.propType,restricted:o.restricted};game.settings.registerMenu(S,o.tag,i)}}se.updateColorScheme()}static updateColorScheme(){var t;const e=game.settings.get("core","uiConfig");se.coreColorScheme=((t=e==null?void 0:e.colorScheme)==null?void 0:t.interface)||"dark",r.log("SettingsUtil.updateColorScheme",[e,se.coreColorScheme])}static get(e,t=S){if(!e)return null;let s=!1;try{if(t===S)s=game.settings.get(t,e);else{let i=game.settings.storage.get("client")[`${t}.${e}`];i===void 0&&(i=game.settings.storage.get("world").getSetting(`${t}.${e}`),s=i==null?void 0:i.value)}}catch{return r.log(`Setting ${t}.${e} not found, returning false`),!1}return s}static set(e,t,s=S){if(!e)return!1;let o=game.settings.storage.get("client")[`${s}.${e}`];o||(o=game.settings.storage.get("world").getSetting(`${s}.${e}`),r.log("SettingsUtil.set - world Setting?",[o]));try{game.settings.set(s,e,t),r.log("SettingsUtil.set - success",[s,e,t])}catch(i){r.error("SettingsUtil.set - error",[i])}return!0}static apply(e,t){const s=v();switch(e){case s.rollRequestsEnabled.tag:se.applyRollRequestsEnabled(t);break}}static applyRollRequestsEnabled(e){const t=document.querySelector(".chat-controls .flash-rolls-icon");t&&(e?t.classList.add("active"):t.classList.remove("active"))}};w(se,"coreColorScheme","dark");let I=se;Hooks.once(F.READY,()=>{dnd5e.applications.dice.DamageRollConfigurationDialog||r.warn("DamageRollConfigurationDialog not found in dnd5e.applications.dice")});function ye(d){return class extends d{constructor(e={},t={},s={}){var o,i;super(e,t,s),this.actors=s.actors||[],this.sendRequest=s.sendRequest??s.sendRequest??!0,this.showDC=s.showDC||!1,this.dcValue=s.dcValue||null,this.rollKey=s.rollKey||e.skill||e.ability||null,this.rollTypeString=s.rollTypeString||null,this.windowTitle=((o=s.window)==null?void 0:o.title)||"",this.windowSubtitle=((i=s.window)==null?void 0:i.subtitle)||""}_buildConfig(e,t,s){const o=t==null?void 0:t.get("ability"),i=t==null?void 0:t.get("dc"),l=t==null?void 0:t.get(`rolls.${s}.situational`);if(r.log("_buildConfig",[l,t,e]),l)e.parts||(e.parts=[]),e.parts.push("@situational"),e.data||(e.data={}),e.data.situational=l;else if(e.parts){const n=e.parts.indexOf("@situational");n!==-1&&e.parts.splice(n,1)}o&&(e.ability=o,this.config.ability=o);const a=super._buildConfig(e,t,s);if(i){const n=parseInt(i);isNaN(n)||(a.options=a.options||{},a.options.target=n)}else this.dcValue!==void 0&&this.dcValue!==null&&(a.options=a.options||{},a.options.target=this.dcValue);return r.log(`${this.constructor.name}._buildConfig`,[this.config,t,a]),a}_onChangeForm(e,t){r.log("_onChangeForm",[t.target.value]),super._onChangeForm(e,t);const s=this.element.querySelector('input[name="flash5e-send-request"]');s&&(this.sendRequest=s.checked);const o=this.element.querySelector('input[name="dc"]');o&&o.value&&(this.dcValue=parseInt(o.value)||null)}_finalizeRolls(e){const t=super._finalizeRolls(e);if(r.log("_finalizeRolls #1",[t,this.sendRequest]),this.dcValue!==void 0&&this.dcValue!==null)for(const s of t)s.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,t}async _onRender(e,t){var s,o,i;await super._onRender(e,t),((i=(o=(s=this.config.rolls)==null?void 0:s[0])==null?void 0:o.data)!=null&&i.situational||this.config.situational)&&(r.log(`${this.constructor.name}._onRender`,["Triggering rebuild for initial situational bonus"]),setTimeout(()=>{this.rebuild()},100))}}}function ct(d,e){var o,i,l,a,n;let t=game.i18n.localize(`FLASH_ROLLS.rollTypes.${d}`)||d;const s=d==null?void 0:d.toLowerCase();if(e)switch(s){case g.SKILL:t+=` (${((o=CONFIG.DND5E.skills[e])==null?void 0:o.label)||e})`;break;case g.SAVE:t+=` (${((i=CONFIG.DND5E.abilities[e])==null?void 0:i.label)||e})`;break;case g.ABILITY:t+=` (${((l=CONFIG.DND5E.abilities[e])==null?void 0:l.label)||e})`;break;case g.TOOL:const c=(n=(a=CONFIG.DND5E.enrichmentLookup)==null?void 0:a.tools)==null?void 0:n[e];if(c!=null&&c.id){const u=dnd5e.documents.Trait.getBaseItem(c.id,{indexOnly:!0});t+=` (${(u==null?void 0:u.name)||e})`}else t+=` (${e})`;break;case g.CUSTOM:t=`${t}: ${e}`;break}return t}function dt(d,e=ct){if(d.length===0)return;const t={};for(const o of d){const i=`${o.rollType}_${o.rollKey||""}`;t[i]||(t[i]={rollType:o.rollType,rollKey:o.rollKey,actors:[],gm:o.gm}),t[i].actors.push(o.actor)}const s=Object.values(t);if(s.length===1&&s[0].actors.length===1){const o=s[0];ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestReceived",{gm:o.gm,rollType:e(o.rollType,o.rollKey)}))}else{const o=[];for(const i of s){const l=e(i.rollType,i.rollKey),a=i.actors.join(", ");o.push(`${l} (${a})`)}ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsReceivedMultiple",{gm:s[0].gm,requests:o.join("; ")}))}}function Qe(d){const e=d.ownership||{};for(const[t,s]of Object.entries(e))if(s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.get(t);if(o&&!o.isGM)return o}return null}function ut(d,e=game.user){d!=null&&d.length&&d.forEach((t,s)=>{r.log("applyTargetTokens",[t,canvas.tokens.placeables.map(i=>i.id)]);const o=canvas.tokens.placeables.find(i=>i.id===t);o?o.setTarget(!0,{releaseOthers:s===0}):r.warn("applyTargetTokens - Token not found:",[t])})}function Fe(d){return d.type!=="character"&&d.type!=="npc"?!1:Object.entries(d.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function Je(d){if(d.type!=="character"&&d.type!=="npc")return!1;const e=game.scenes.active;return e&&e.tokens.some(t=>t.actorId===d.id)}function ae(d,e,t=null){if(!game.scenes.active)return;let o;if(t){const i=canvas.tokens.placeables.find(l=>l.id===t);o=i?[i]:[]}else o=canvas.tokens.placeables.filter(i=>{var l;return((l=i.actor)==null?void 0:l.id)===d});for(const i of o)e?i.control({releaseOthers:!1}):i.release()}function Te(d){return new Promise(e=>setTimeout(e,d))}function qe(){var d;return((d=ui==null?void 0:ui.sidebar)==null?void 0:d.expanded)||!1}function xe(d){const e=document.querySelector("body");d?e.classList.add("flash5e-sidebar-expanded"):e.classList.remove("flash5e-sidebar-expanded"),pe()}function Ue(d,e){var i,l;const t=[];if(!d)return t;const s=K.ROLL_REQUEST_OPTIONS[d];if(!s||!s.subList)return t;const o=CONFIG.DND5E[s.subList];if(o){for(const[a,n]of Object.entries(o)){let c=n.label||n.name||a;if(s.subList==="tools"&&((l=(i=CONFIG.DND5E.enrichmentLookup)==null?void 0:i.tools)!=null&&l[a])){const u=CONFIG.DND5E.enrichmentLookup.tools[a];if(u!=null&&u.id){const h=dnd5e.documents.Trait.getBaseItem(u.id,{indexOnly:!0});c=(h==null?void 0:h.name)||c}}t.push({id:a,name:c,rollable:!0})}t.sort((a,n)=>a.name.localeCompare(n.name))}return t}const $=class ${static notify(e,t,s={}){if(!s.batch){ui.notifications[e](t);return}s.batchData&&($.pendingNotifications.push(s.batchData),$.notificationTimer&&clearTimeout($.notificationTimer),$.notificationTimer=setTimeout(()=>{dt($.pendingNotifications),$.pendingNotifications=[],$.notificationTimer=null},$.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(e,t){const s=Object.entries(e);if(s.length!==0)if(s.length===1){const o=Object.values(e)[0],i=o.actors.map(l=>l.name).join(", ");ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentSingle",{rollType:t,actors:i,player:o.player.name}))}else{const o=s.map(([i,l])=>{const a=l.actors.map(n=>n.name).join(", ");return`${l.player.name} (${a})`});ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentMultiple",{rollType:t,count:s.length,players:o.join("; ")}))}}static clearPending(){$.notificationTimer&&(clearTimeout($.notificationTimer),$.notificationTimer=null),$.pendingNotifications=[]}};w($,"pendingNotifications",[]),w($,"notificationTimer",null),w($,"NOTIFICATION_BATCH_DELAY",500);let B=$;function gt(d){var s;const e=[],t=[];for(const o of d){const i=((s=o.system.attributes.hp)==null?void 0:s.value)||0,l=o.system.attributes.death||{},a=l.success||0,n=l.failure||0;i<=0&&a<3&&n<3?e.push(o):t.push(o.name)}return t.length>0&&B.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorsSkippingDeathSave",{actors:t.join(", ")})),e}function ft(d){const e=[],t=[];for(const s of d){const o=Qe(s);o?e.push({actor:s,owner:o}):t.push(s)}return{pcActors:e,npcActors:t}}function pe(d=!0){const e=document.querySelector("#chat-notifications #roll-privacy"),t=e?H.getFullWidth(e):36,s=!!document.querySelector("body.crlngn-tabs");H.addCSSVars("--flash-rolls-menu-offset",(s?t:t+16)+"px")}function Ee(d){var o,i;const e=game.actors.get(d);if(e)return e;const t=(o=canvas.tokens)==null?void 0:o.get(d),s=(i=game.scenes.active)==null?void 0:i.tokens.get(d);return e||(t==null?void 0:t.actor)||(s==null?void 0:s.actor)||null}const E={addSituationalBonus(d,e){var t;return r.log("Config before adding bonus:",[e,d]),e&&((t=d.rolls)!=null&&t[0])&&(d.rolls[0].parts||(d.rolls[0].parts=[]),d.rolls[0].data||(d.rolls[0].data={}),d.rolls[0].data.situational=e,d.rolls[0].parts.includes("@situational")||d.rolls[0].parts.push("@situational"),r.log("Config after adding bonus:",[d])),d},buildRollConfig(d,e,t={}){var i;const s={rolls:[{parts:e.parts||[],data:e.data||{},options:{...e.options||{},...((i=e.options)==null?void 0:i._fromFlashRolls)&&{_fromFlashRolls:!0}}}],advantage:d.config.advantage||!1,disadvantage:d.config.disadvantage||!1,target:d.config.target,subject:null,chatMessage:!0,legacy:!1,...d.config.rollMode&&{rollMode:d.config.rollMode},...t},o=d.config.situational;return o&&this.addSituationalBonus(s,o),this.ensureRollFlags(s,d)},ensureRollFlags(d,e){return d.isRollRequest=!game.user.isGM,d._showRequestedBy=!0,d._requestedBy=e.config.requestedBy||"GM",d},validateActors(d){return!d||d.length===0?null:(typeof d[0]=="string"&&(d=d.map(e=>game.actors.get(e)).filter(e=>e)),d.length>0?d:null)},getRollClass(d){const e=d==null?void 0:d.toLowerCase();return[g.DAMAGE,g.HEALING].includes(e)?CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[g.FORMULA,g.CUSTOM,g.HIT_DIE].includes(e)?CONFIG.Dice.BasicRoll:CONFIG.Dice.D20Roll},shouldShowDC(d){const e=d==null?void 0:d.toLowerCase();return[g.SAVE,g.SAVING_THROW,g.ABILITY,g.ABILITY_CHECK,g.CONCENTRATION,g.SKILL,g.TOOL].includes(e)},createBaseRollConfig(d,e,t){const s=e==null?void 0:e.toLowerCase(),o={data:d.getRollData(),subject:d,rolls:[{parts:[],data:d.getRollData(),options:{}}]};switch(s){case g.SKILL:o.skill=t;break;case g.TOOL:o.tool=t;break;case g.SAVE:case g.SAVING_THROW:case g.ABILITY:case g.ABILITY_CHECK:o.ability=t;break;case g.HIT_DIE:o.rolls[0].options.flavor="Hit Die";break}return o},createMessageConfig(d,e=null){const t={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:d})}};return e&&(t.rollMode=e),t},async triggerRollDialog(d,e,t,s){const o=new d(e,t,s);return await new Promise(l=>{o.addEventListener("close",()=>{l({rolls:o.rolls,config:o.config,message:o.message,sendRequest:o.sendRequest,critical:o.config.critical,isCritical:o.config.isCritical})},{once:!0}),o.render({force:!0})})},processDialogResult(d,e,t,s,o={}){var b,T,y,p,L,_;if(!(d!=null&&d.rolls)||d.rolls.length===0)return null;const i=t==null?void 0:t.toLowerCase(),l=d.rolls[0];let a=!1,n=!1;((b=l==null?void 0:l.options)==null?void 0:b.advantageMode)!==void 0&&(a=l.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,n=l.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const c=((T=l==null?void 0:l.data)==null?void 0:T.situational)||"",u=(y=l==null?void 0:l.options)==null?void 0:y.target,h={rolls:[{parts:((p=l==null?void 0:l.parts)==null?void 0:p.slice())||[],data:c?{situational:c}:{},options:u?{target:u}:{}}],subject:e[0],advantage:a,disadvantage:n,target:u,sendRequest:d.sendRequest,isRollRequest:d.sendRequest,skipRollDialog:o.skipRollDialog||!1,chatMessage:!0},f=v(),m=I.get(f.publicPlayerRolls.tag)===!0,R=this.determineRollMode(m,(L=d.message)==null?void 0:L.rollMode);return h.rollMode=R,(_=d.config)!=null&&_.ability&&[g.SKILL,g.TOOL].includes(i)&&(h.ability=d.config.ability),h},determineRollMode(d,e){return e||(d?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode"))},isPlayerOwned(d){return Object.entries(d.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})},isPlayerOwnerActive(d){const e=Qe(d);return e&&e.active},calculateStandardRule(d,e){const t=d.filter(i=>i.total>=e).length,s=d.length-t,o=Math.ceil(d.length/2);return{finalResult:t>=o,successes:t,failures:s,summary:game.i18n.format("FLASH_ROLLS.groupRoll.standardRule.summary",{successes:t,total:d.length,threshold:o}),method:"Standard Rule"}},calculateGroupAverage(d,e){const t=d.reduce((o,i)=>o+i.total,0),s=Math.floor(t/d.length);return{finalResult:s,average:s,success:s>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.groupAverage.summary",{average:s,dc:e}),method:"Group Average"}},calculateLeaderWithHelp(d,e,t,s,o){var m;let i=-999,l=null,a=0;for(const R of t){const b=this._getActorModifier(R,s,o);b>i&&(i=b,l=R.id,a=b)}const n=d.find(R=>R.actorId===l);if(!n)return{finalResult:0,error:"Leader actor did not roll",method:"Leader with Help"};const c=d.filter(R=>R.actorId!==l),u=c.filter(R=>R.total>=e).length,h=c.filter(R=>R.total<e).length,f=n.total+u-h;return{finalResult:f,leaderRoll:n.total,leaderName:(m=t.find(R=>R.id===l))==null?void 0:m.name,leaderModifier:a,bonus:u,penalty:h,success:f>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.leaderWithHelp.summary",{leaderRoll:n.total,bonus:u,penalty:h,adjustedResult:f,dc:e}),method:"Leader with Help"}},calculateWeakestLink(d,e,t,s,o){var f;let i=999,l=null,a=0;for(const m of t){const R=this._getActorModifier(m,s,o);R<i&&(i=R,l=m.id,a=R)}const n=d.find(m=>m.actorId===l);if(!n)return{finalResult:0,error:"Weakest link actor did not roll",method:"Weakest Link"};const c=d.filter(m=>m.actorId!==l&&m.total>=e).length,u=n.total+c,h=c===1?game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successPlural");return{finalResult:u,weakestRoll:n.total,weakestName:(f=t.find(m=>m.id===l))==null?void 0:f.name,weakestModifier:a,bonus:c,success:u>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.weakestLink.summary",{weakestRoll:n.total,bonus:c,successWord:h,adjustedResult:u,dc:e}),method:"Weakest Link"}},_getActorModifier(d,e,t){var o,i,l,a,n,c,u;switch(e==null?void 0:e.toLowerCase()){case g.SKILL:return((o=d.system.skills[t])==null?void 0:o.total)||((i=d.system.skills[t])==null?void 0:i.mod)||0;case g.SAVE:case g.SAVING_THROW:return((a=(l=d.system.abilities[t])==null?void 0:l.save)==null?void 0:a.value)||((n=d.system.abilities[t])==null?void 0:n.save)||0;case g.ABILITY:case g.ABILITY_CHECK:return((c=d.system.abilities[t])==null?void 0:c.mod)||0;case g.TOOL:if((u=d.system.tools)!=null&&u[t])return d.system.tools[t].total||d.system.tools[t].mod||0;const h=d.items.find(f=>f.type==="tool"&&f.system.toolType===t);return(h==null?void 0:h.system.bonus)||0;default:return 0}},getGroupResult(d,e,t,s,o){if(!d.every(c=>c.total!==null&&c.total!==void 0))return{complete:!1,success:!1,result:0};const l=v(),a=I.get(l.groupRollResultMode.tag)||1;let n;switch(a){case 1:return n=this.calculateStandardRule(d,e),{complete:!0,success:n.finalResult,result:n.finalResult?1:0,details:n};case 2:return n=this.calculateGroupAverage(d,e),{complete:!0,success:n.success,result:n.finalResult,details:n};case 3:return n=this.calculateLeaderWithHelp(d,e,t,s,o),{complete:!0,success:n.success,result:n.finalResult,details:n};case 4:return n=this.calculateWeakestLink(d,e,t,s,o),{complete:!0,success:n.success,result:n.finalResult,details:n};default:return n=this.calculateStandardRule(d,e),{complete:!0,success:n.finalResult,result:n.finalResult?1:0,details:n}}}};class J extends ye(dnd5e.applications.dice.D20RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(e,t,s),r.log("constructor - initializing GM Dialog",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(e,t,s,o){r.log("_prepareConfigurationData",[e,t,s,o]);const i=super._prepareConfigurationData(e,t,s,o);return i.showDC=this.showDC,i.dcValue=this.dcValue,i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(e,t,s){return r.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(r.log("_onRender",[e,t]),super._onRender(e,t),H.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},i=await H.renderTemplate(`modules/${S}/templates/gm-roll-config-fields.hbs`,o),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=i,s.parentNode.insertBefore(l,s),s.parentNode.insertBefore(l,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[this.element]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(t=>{t.addEventListener("click",s=>{s.currentTarget.dataset.action})})}static async initConfiguration(e,t,s,o={}){var p,L,_,A,D,C,O,k,G;if(e=E.validateActors(e),!e)return null;const i=e[0];r.log("GMRollConfigDialog, initConfiguration",[]);const l=t==null?void 0:t.toLowerCase(),a=v(),n=I.get(a.publicPlayerRolls.tag)===!0,c=E.determineRollMode(n),u=E.shouldShowDC(l),h=E.getRollClass(l),f=E.createBaseRollConfig(i,t,s),m=E.createMessageConfig(i,c),R={options:{actors:e,sendRequest:e.some(N=>E.isPlayerOwned(N)),showDC:u,rollKey:s,rollType:h,rollTypeString:l,window:{title:J._getRollTitle(l,s,i),subtitle:J._getSubtitle(e)},position:{width:420,height:"auto"},...o}},b=await E.triggerRollDialog(this,f,m,R.options),T=E.processDialogResult(b,e,t,s,o);if(!T)return null;if((p=b.config)!=null&&p.ability&&[g.SKILL,g.TOOL].includes(l)){const N=((_=(L=i.system.skills)==null?void 0:L[s])==null?void 0:_.ability)||((D=(A=CONFIG.DND5E.skills)==null?void 0:A[s])==null?void 0:D.ability);b.config.ability!==N&&(T.ability=b.config.ability)}let y=R.options.window.title;if(b.config.ability&&[g.SKILL,g.TOOL].includes(l)){const N=((C=CONFIG.DND5E.abilities[b.config.ability])==null?void 0:C.label)||b.config.ability;if(l===g.SKILL){const W=((O=CONFIG.DND5E.skills[s])==null?void 0:O.label)||s;y=game.i18n.format("DND5E.SkillPromptTitle",{skill:W,ability:N})}else if(l===g.TOOL){const W=(G=(k=CONFIG.DND5E.enrichmentLookup)==null?void 0:k.tools)==null?void 0:G[s];let te=s;if(W!=null&&W.id){const X=dnd5e.documents.Trait.getBaseItem(W.id,{indexOnly:!0});te=(X==null?void 0:X.name)||s}y=game.i18n.format("DND5E.ToolPromptTitle",{tool:te,ability:N})}}return T.rollTitle=y,T.rollType=l,T.rollKey=s,T}static _getRollTitle(e,t,s){var l,a,n,c,u,h,f,m,R,b,T,y,p;let o="";const i=e==null?void 0:e.toLowerCase();switch([g.SAVE,g.ABILITY,g.ABILITY_CHECK].includes(i)&&!t&&r.warn("Missing rollKey for roll type",[i,t]),i){case g.SKILL:const L=((l=CONFIG.DND5E.skills[t])==null?void 0:l.label)||t,_=(a=s==null?void 0:s.system.skills)==null?void 0:a[t],A=(_==null?void 0:_.ability)||((n=CONFIG.DND5E.skills[t])==null?void 0:n.ability)||"int",D=((c=CONFIG.DND5E.abilities[A])==null?void 0:c.label)||A;o=game.i18n.format("DND5E.SkillPromptTitle",{skill:L,ability:D});break;case g.SAVE:case g.SAVING_THROW:const C=((u=CONFIG.DND5E.abilities[t])==null?void 0:u.label)||t;o=game.i18n.format("DND5E.SavePromptTitle",{ability:C});break;case g.ABILITY:case g.ABILITY_CHECK:const O=((h=CONFIG.DND5E.abilities[t])==null?void 0:h.label)||t;o=game.i18n.format("DND5E.AbilityPromptTitle",{ability:O});break;case g.CONCENTRATION:o=game.i18n.localize("DND5E.Concentration");break;case g.TOOL:const k=(m=(f=CONFIG.DND5E.enrichmentLookup)==null?void 0:f.tools)==null?void 0:m[t];let G=t;if(k!=null&&k.id){const X=dnd5e.documents.Trait.getBaseItem(k.id,{indexOnly:!0});G=(X==null?void 0:X.name)||t}const N=(R=s==null?void 0:s.system.tools)==null?void 0:R[t],W=(N==null?void 0:N.ability)||((y=(T=(b=CONFIG.DND5E.enrichmentLookup)==null?void 0:b.tools)==null?void 0:T[t])==null?void 0:y.ability)||"int",te=((p=CONFIG.DND5E.abilities[W])==null?void 0:p.label)||W;o=game.i18n.format("DND5E.ToolPromptTitle",{tool:G,ability:te});break;case g.DEATH_SAVE:o=game.i18n.localize("DND5E.DeathSave");break;case g.INITIATIVE:case g.INITIATIVE_DIALOG:o=game.i18n.localize("DND5E.Initiative");break;default:o=game.i18n.localize("DND5E.Roll")}return r.log("_getRollTitle",[i,o]),o}static _getSubtitle(e=[]){return e.length===1?e[0].name:e.length>1?game.i18n.localize("FLASH_ROLLS.ui.dialogs.multipleActors"):""}}class Ne extends ye(dnd5e.applications.dice.RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=CONFIG.Dice.BasicRoll||Roll,s.showDC=!1,super(e,t,s),r.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(e,t,s,o){const i=super._prepareConfigurationData(e,t,s,o);return r.log("GMHitDieConfigDialog._prepareConfigurationData",[i]),i.formula="Hit Die (varies by actor)",i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length,t.formula="Hit Die (varies by actor)"),t}async _onRender(e,t){if(super._onRender(e,t),H.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},i=await H.renderTemplate(`modules/${S}/templates/gm-roll-config-fields.hbs`,o),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=i,s.parentNode.insertBefore(l,s)}}async _processSubmitData(e,t,s){await super._processSubmitData(e,t,s),this.sendRequest=s.get("flash5e-send-request")!=="false",r.log("_processSubmitData",[s,this.config])}_finalizeRolls(e){const t=super._finalizeRolls(e);return this.config.sendRequest=this.sendRequest,t}static async initConfiguration(e,t,s,o={}){var R;if(e=E.validateActors(e),!e)return null;const i=e[0];r.log("GMHitDieConfigDialog, initConfiguration",[]);const l=v(),a=I.get(l.publicPlayerRolls.tag)===!0,n=E.determineRollMode(a),c={data:i.getRollData(),subject:i,rolls:[{parts:[],data:i.getRollData(),options:{flavor:"Hit Die Roll"}}]},u=E.createMessageConfig(i,n),h={options:{actors:e,sendRequest:e.some(b=>E.isPlayerOwned(b)),rollKey:s,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:J._getSubtitle(e)},position:{width:420,height:"auto"},...o}},f=await E.triggerRollDialog(this,c,u,h.options);if(!(f!=null&&f.rolls)||f.rolls.length===0)return null;r.log("GMHitDieConfigDialog - dialog result",[f.rolls]);const m=E.processDialogResult(f,e,t,s,o);return m?((R=f.config)!=null&&R.ability&&(m.ability=f.config.ability),m):null}}class He extends ye(dnd5e.applications.dice.SkillToolRollConfigurationDialog){constructor(e={},t={},s={}){const o=foundry.utils.mergeObject(e,{chooseAbility:!0});s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(o,t,s),r.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){r.log("_prepareConfigurationData",[e,t,s,o]);const i=super._prepareConfigurationData(e,t,s,o);return i.showDC=this.showDC,i.dcValue=this.dcValue,i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(e,t,s){return r.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(r.log("_onRender",[e,t]),super._onRender(e,t),H.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const o={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},i=await H.renderTemplate(`modules/${S}/templates/gm-roll-config-fields.hbs`,o),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=i,s.parentNode.insertBefore(l,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(t=>{t.addEventListener("click",s=>{s.currentTarget.dataset.action})})}static async initConfiguration(e,t,s,o={}){var p,L,_,A,D,C;if(e=E.validateActors(e),!e)return null;const i=e[0];r.log("GMSkillToolConfigDialog, initConfiguration",[]);const l=t==null?void 0:t.toLowerCase(),a=v(),n=I.get(a.publicPlayerRolls.tag)===!0,c=E.determineRollMode(n),u=E.shouldShowDC(l),h=CONFIG.Dice.D20Roll;let f=null;if(l===g.SKILL){const O=i.system.skills[s];f=(O==null?void 0:O.ability)||((p=CONFIG.DND5E.skills[s])==null?void 0:p.ability)||"int"}else if(l===g.TOOL){const O=(L=i.system.tools)==null?void 0:L[s];f=(O==null?void 0:O.ability)||((D=(A=(_=CONFIG.DND5E.enrichmentLookup)==null?void 0:_.tools)==null?void 0:A[s])==null?void 0:D.ability)||"int"}const m={data:i.getRollData(),subject:i,ability:f,chooseAbility:!0,rolls:[{parts:[],data:i.getRollData(),options:{}}]};l===g.SKILL?m.skill=s:l===g.TOOL&&(m.tool=s);const R=E.createMessageConfig(i,c),b={options:{actors:e,sendRequest:e.some(O=>E.isPlayerOwned(O)),showDC:u,rollKey:s,rollType:h,rollTypeString:l,window:{title:J._getRollTitle(l,s,i),subtitle:J._getSubtitle(e)},position:{width:420,height:"auto"},...o}},T=await E.triggerRollDialog(this,m,R,b.options),y=E.processDialogResult(T,e,t,s,o);return y?((C=T.config)!=null&&C.ability&&[g.SKILL,g.TOOL].includes(l)&&(y.ability=T.config.ability),y.rollTitle=b.options.window.title,y.rollType=l,y.rollKey=s,y):null}}class ht extends ye(dnd5e.applications.dice.DamageRollConfigurationDialog){constructor(e={},t={},s={}){const o=foundry.utils.mergeObject({configure:!0},e);super(o,t,s),r.log("GMDamageConfigDialog.constructor",[o,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","damage-roll","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){r.log("GMDamageConfigDialog._prepareConfigurationData",[e,t,s,o]);const i=super._prepareConfigurationData(e,t,s,o);return i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _onRender(e,t){if(await super._onRender(e,t),H.preventDialogFlicker(this.element),this.actors.length>0){const s=this.element.querySelector(".rolls + .dialog-buttons");if(s&&!this.element.querySelector(".gm-roll-config-fields")){const o=document.createElement("div");o.className="gm-roll-config-fields",o.innerHTML=`
          <div class="form-group">
            <label class="checkbox">
              <input type="checkbox" name="flash5e-send-request" ${this.sendRequest?"checked":""}>
              ${game.i18n.localize("FLASH_ROLLS.ui.dialogs.sendRequestToPlayers")}
            </label>
          </div>
        `,s.insertAdjacentElement("beforebegin",o)}}}static async initConfiguration(e,t,s,o={},i={},l={}){var C,O,k,G,N;if(e=E.validateActors(e),r.log("GMDamageConfigDialog, initConfiguration actors",[e]),!e)return null;const a=e[0],n=v(),c=I.get(n.publicPlayerRolls.tag)===!0,u=E.determineRollMode(c,i.rollMode),h=t==null?void 0:t.toLowerCase(),f={subject:i.subject||a,data:a.getRollData(),critical:i.critical||{},rolls:i.rolls||[{parts:[],data:a.getRollData(),options:{}}]};r.log("GMDamageConfigDialog, initConfiguration #1",[f]);const m=E.createMessageConfig(a,u);r.log("GMDamageConfigDialog, initConfiguration #2",[m]);const{position:R,...b}=(l==null?void 0:l.options)||{},T={options:{actors:e,sendRequest:e.some(W=>E.isPlayerOwned(W)),rollKey:s,rollType:CONFIG.Dice.DamageRoll,rollTypeString:h,window:{title:game.i18n.localize("DND5E.DamageRoll"),subtitle:J._getSubtitle(e)},...b,...o}},y=await E.triggerRollDialog(this,f,m,T.options);if(!(y!=null&&y.rolls)||y.rolls.length===0)return null;const p=y.rolls[0],L=((C=p==null?void 0:p.data)==null?void 0:C.situational)||"",_=(O=p==null?void 0:p.options)==null?void 0:O.target,A={rolls:[{parts:[],data:L?{situational:L}:{},options:{..._&&{target:_},isCritical:((k=p==null?void 0:p.options)==null?void 0:k.isCritical)||(p==null?void 0:p.isCritical)||!1}}],subject:i.subject||a,target:_,isCritical:((G=p==null?void 0:p.options)==null?void 0:G.isCritical)||(p==null?void 0:p.isCritical)||!1,sendRequest:y.sendRequest,isRollRequest:y.sendRequest,skipRollDialog:o.skipRollDialog||!1,chatMessage:!0};r.log("GMDamageConfigDialog, initConfiguration #6",[A]);const D=E.determineRollMode(c,(N=y.message)==null?void 0:N.rollMode);return A.rollMode=D,A.rollTitle=T.options.window.title,A.rollType=h,A.rollKey=s,r.log("GMDamageConfigDialog, initConfiguration - result",[A]),A}}class pt extends ye(dnd5e.applications.dice.AttackRollConfigurationDialog){constructor(e={},t={},s={}){super(e,t,s),r.log("GMAttackConfigDialog.constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,o){r.log("GMAttackConfigDialog._prepareConfigurationData",[e,t,s,o]);const i=super._prepareConfigurationData(e,t,s,o);return i.sendRequest=this.sendRequest,i.actorCount=this.actors.length,i}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(await super._onRender(e,t),H.preventDialogFlicker(this.element),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const o={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},i=await H.renderTemplate(`modules/${S}/templates/gm-roll-config-fields.hbs`,o),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=i,s.parentNode.insertBefore(l,s)}}_finalizeRolls(e){return this.config.sendRequest=this.sendRequest,!this.sendRequest&&this.config.isRollRequest&&(this.config.isRollRequest=!1),super._finalizeRolls(e)}static async initConfiguration(e,t,s,o={},i={},l={}){var k,G,N,W,te,X,Ge;if(e=E.validateActors(e),!e)return null;const a=e[0];r.log("GMAttackConfigDialog, initConfiguration",[]);const n=v(),c=I.get(n.publicPlayerRolls.tag)===!0,u=t==null?void 0:t.toLowerCase(),h={subject:i.subject||a,data:a.getRollData(),rolls:[{parts:[],data:a.getRollData(),options:{}}]},f=E.determineRollMode(c),m=E.createMessageConfig(a,f),{position:R,...b}=(l==null?void 0:l.options)||{},T={options:{actors:e,sendRequest:e.some(tt=>E.isPlayerOwned(tt)),rollKey:s,rollType:CONFIG.Dice.D20Roll,rollTypeString:u,window:{title:game.i18n.localize("DND5E.Attack"),subtitle:J._getSubtitle(e)},...b,...o}},y=await E.triggerRollDialog(this,h,m,T.options);if(r.log("GMAttackConfigDialog, initConfiguration",[y==null?void 0:y.sendRequest]),!(y!=null&&y.rolls)||y.rolls.length===0)return null;const p=y.rolls[0];let L=!1,_=!1;((k=p==null?void 0:p.options)==null?void 0:k.advantageMode)!==void 0&&(L=p.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,_=p.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const A=((G=p==null?void 0:p.data)==null?void 0:G.situational)||"",D=(N=p==null?void 0:p.options)==null?void 0:N.target,C={rolls:[{parts:[],data:A?{situational:A}:{},options:{...D&&{target:D},...((W=p==null?void 0:p.options)==null?void 0:W.ammunition)&&{ammunition:p.options.ammunition},...((te=p==null?void 0:p.options)==null?void 0:te.attackMode)&&{attackMode:p.options.attackMode},...((X=p==null?void 0:p.options)==null?void 0:X.mastery)!==void 0&&{mastery:p.options.mastery}}}],subject:i.subject||a,advantage:L,disadvantage:_,target:D,sendRequest:y.sendRequest,isRollRequest:y.sendRequest,skipDialog:o.skipDialogs||!1,chatMessage:!H.isModuleOn("midi-qol")||!0},O=E.determineRollMode(c,(Ge=y.message)==null?void 0:Ge.rollMode);return C.rollMode=O,C.rollTitle=T.options.window.title,C.rollType=u,C.rollKey=s,r.log("GMAttackConfigDialog, initConfiguration - SIMPLIFIED result",[C]),C}}const he=class he{static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}static getMidiQOL(){return this.isModuleActive("midi-qol")&&typeof MidiQOL<"u"?MidiQOL:null}static async prepareMidiQOLSettings(){let e=null;if(r.log("prepareMidiQOLSettings #0",[game.settings]),he.isModuleActive("midi-qol")){r.log("prepareMidiQOLSettings #1",[MidiQOL]),e={autoFastForwardAbilityRolls:I.get("AutoFastForwardAbilityRolls","midi-qol")},clearTimeout(he.midiTimeout),he.midiTimeout=setTimeout(()=>{e&&I.set("AutoFastForwardAbilityRolls",e.autoFastForwardAbilityRolls,"midi-qol"),r.log("prepareMidiQOLSettings #timeout 1",[game.user.getFlag(S,"savedMidiQOLSettings")]),game.user.unsetFlag(S,"savedMidiQOLSettings"),r.log("prepareMidiQOLSettings #timeout 2",[game.user.getFlag(S,"savedMidiQOLSettings")])},4e3);try{r.log("prepareMidiQOLSettings #before",[I.get("AutoFastForwardAbilityRolls","midi-qol")]),await game.user.setFlag(S,"savedMidiQOLSettings",e),await I.set("AutoFastForwardAbilityRolls",!1,"midi-qol"),r.log("prepareMidiQOLSettings #after",[I.get("AutoFastForwardAbilityRolls","midi-qol"),MidiQOL])}catch(t){r.error("prepareMidiQOLSettings",[t])}finally{r.log("prepareMidiQOLSettings - saved temporary settings for MidiQOL",[])}}}};w(he,"midiTimeout",null);let de=he;class mt{static findActivityForRoll(e,t){var i;if(!((i=e==null?void 0:e.system)!=null&&i.activities))return null;const s=e.system.activities;switch(t==null?void 0:t.toLowerCase()){case g.ATTACK:const l=s.getByType("attack");return(l==null?void 0:l[0])||null;case g.DAMAGE:const a=s.getByType("attack");if((a==null?void 0:a.length)>0)return a[0];const n=s.getByType("damage");if((n==null?void 0:n.length)>0)return n[0];const c=s.getByType("save");return(c==null?void 0:c.length)>0?c[0]:null;case g.ITEM_SAVE:const u=s.getByType("save");return(u==null?void 0:u[0])||null;default:return null}}static getActivitiesByType(e,t){var s;return(s=e==null?void 0:e.system)!=null&&s.activities?e.system.activities.getByType(t):[]}static hasActivityForRoll(e,t){return r.log("hasActivityForRoll",[e,t]),!!this.findActivityForRoll(e,t)}static async executeActivityRoll(e,t,s,o,i){var h,f,m,R,b,T,y,p;r.log("executeActivityRoll",[e,t,s,o,i]);const l=de.isModuleActive("midi-qol"),a=e.items.get(s);if(!a)throw new Error(`Item ${s} not found on actor ${e.name}`);let n=null,c=null;if(o&&(n=(h=a.system.activities)==null?void 0:h.get(o)),n=n||this.findActivityForRoll(a,t),!n)throw new Error(`Activity not found on item ${a.name}`);r.log("executeActivityRoll - activity",[n,t]);const u=t==null?void 0:t.toLowerCase();if(n)switch(u){case g.ATTACK:r.log("executeActivityRoll - is attack activity",[i]);const L={attackMode:i.usage.attackMode,ammunition:i.usage.ammunition,mastery:i.usage.mastery,situational:(R=(m=(f=i.usage.rolls)==null?void 0:f[0])==null?void 0:m.data)==null?void 0:R.situational,advantage:i.usage.advantage,disadvantage:i.usage.disadvantage,rollMode:(b=i.message)==null?void 0:b.rollMode};await n.item.setFlag(S,"tempAttackConfig",L),r.log("executeActivityRoll - stored temp config as flag",[L]);try{if(i.message.create=!0,await n.use(i.usage,i.dialog,i.message),r.log("FLASH_ROLLS TEST",[i]),l&&de.getMidiQOL())return}catch(A){r.error("executeActivityRoll - attack roll error",[A])}finally{await n.item.unsetFlag(S,"tempAttackConfig")}return;case g.DAMAGE:r.log("executeActivityRoll - damage roll #0",[n,i]),l||(i.message.create=!0),c={critical:i.usage.critical||{},situational:i.usage.rolls[0].data.situational||"",rollMode:(T=i.message)==null?void 0:T.rollMode,create:((y=i.message)==null?void 0:y.create)!==!1,scaling:i.usage.scaling};let _=!1;!game.user.isGM&&(n.type===Ae.SAVE||n.type===Ae.DAMAGE||!(n!=null&&n.attack))&&(await n.use(i.usage,i.dialog,i.message),_=n.type===Ae.DAMAGE),await n.item.setFlag(S,"tempDamageConfig",c),r.log("executeActivityRoll - damage config with situational",[c]);try{if(l){const A=de.getMidiQOL();if(A){const D=(p=A.Workflow)==null?void 0:p.getWorkflow(n.uuid);if(r.log("executeActivityRoll - workflow",[D]),D){const C=await D.activity.rollDamage({...c,workflow:D})}return}}else r.log("executeActivityRoll - damage roll",[n,c,i]),_||await n.rollDamage(c,i.dialog,i.message)}catch(A){r.error(["executeActivityRoll - damage roll error",A])}finally{await n.item.unsetFlag(S,"tempDamageConfig")}return;default:r.log("executeActivityRoll - unknown roll type",[u]),await n.use(i.usage,i.dialog,i.message);return}throw new Error(`No suitable method found for ${u} on item ${a.name}`)}static getActivityDisplayInfo(e){return r.log("getActivityDisplayInfo",[e]),e?{name:e.name||e.constructor.metadata.label,type:e.type,icon:e.constructor.metadata.icon,canAttack:e.type==="attack",canDamage:["attack","damage","save"].includes(e.type),canSave:e.type==="save"}:null}static getDamageFormula(e){var s,o;if(r.log("getDamageFormula",[e]),!((o=(s=e==null?void 0:e.damage)==null?void 0:s.parts)!=null&&o.length))return null;const t=e.damage.parts.map(i=>i.formula).filter(i=>i);return t.length>0?t.join(" + "):null}static async syntheticItemRoll(e,t={}){r.log("syntheticItemRoll",[e,t]);const s=de.getMidiQOL();if(!s){r.warn("MidiQOL is not active");return}let o={consumeUsage:!1,consumeSpellSlot:!1},i={fastForward:!1,fastForwardAttack:!1,dialogOptions:{fastForward:!1,fastForwardAttack:!1},configureDialog:!0,workflowOptions:{fastForward:!1,fastForwardAttack:!1}};return t={...o,...t},await s.completeItemUse(e,t,i)}}const{ApplicationV2:Rt,HandlebarsApplicationMixin:bt}=foundry.applications.api;class Ie extends bt(Rt){constructor(e={}){super(e),this.formula=e.formula||"",this.readonly=e.readonly||!1,this.actor=e.actor,this.callback=e.callback,this.diceCounts={}}static get DEFAULT_OPTIONS(){return foundry.utils.mergeObject(super.DEFAULT_OPTIONS,{id:"flash5e-custom-roll-dialog",classes:["flash5e-dialog","flash5e-custom-roll-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:420,height:"auto"}})}_onClickAction(e,t){switch(t.dataset.action){case"rollDice":return this.rollDice(e,t);case"addDie":return this.addDie(e,t);case"cancel":return this.cancel(e,t)}}async _prepareContext(e={}){return{...await super._prepareContext(e),formula:this.formula,readonly:this.readonly}}_attachPartListeners(e,t,s){super._attachPartListeners(e,t,s);const o=t.querySelector("#custom-roll-formula"),i=t.querySelector("#formula-validation-message");o&&!this.readonly&&(o.addEventListener("input",l=>{this.formula=l.target.value.trim(),this.updateValidationMessage(i)}),this.formula&&this.updateValidationMessage(i))}updateValidationMessage(e){if(!e)return;if(!this.formula){e.textContent="&nbsp;",e.classList.remove("error","success");return}this.validateFormula(this.formula)?(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaValid"),e.classList.remove("error"),e.classList.add("success")):(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaInvalid"),e.classList.remove("success"),e.classList.add("error"))}addDie(e,t){const s=t.dataset.die,o=this.element.querySelector("#custom-roll-formula");if(!o)return;const i=o.value.trim();if(i){const l=/(\d*)d(\d+)/g,a=new Map;let n=i,c;for(;(c=l.exec(i))!==null;){const f=parseInt(c[1]||"1"),m=c[2];a.set(m,(a.get(m)||0)+f),n=n.replace(c[0],"").trim()}const u=s.substring(1);a.set(u,(a.get(u)||0)+1);const h=[];for(const[f,m]of a)h.push(`${m}d${f}`);n=n.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),n&&n!=="+"?this.formula=`${h.join(" + ")} + ${n}`:this.formula=h.join(" + ")}else this.formula=`1${s}`;o.value=this.formula,o.dispatchEvent(new Event("input"))}validateFormula(e){var t;if(!e||e.trim()==="")return!1;try{return Roll.validate(e)}catch{try{return new Roll(e,((t=this.actor)==null?void 0:t.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(r.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback(this.formula),this.close()}cancel(){this.close()}static async prompt(e={}){return new Promise(t=>{const s=new this({...e,callback:o=>t(o)});s.addEventListener("close",()=>{s._resolved||t(null)}),s.render(!0)})}async close(e={}){return this._resolved=!0,super.close(e)}}w(Ie,"PARTS",{main:{template:`modules/${K.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${K.ID}/templates/custom-roll-dialog-footer.hbs`}});class z{static async initialize(){r.log("ChatMessageUtils.initialize"),await this.preloadTemplate(),this.registerEventListeners()}static registerEventListeners(){const e=(t,s)=>{t.querySelectorAll(".actor-result").forEach(l=>{l.addEventListener("click",a=>{if(a.target.closest(".dice-btn.rollable"))return;a.preventDefault(),a.stopPropagation();const n=l;r.log("actor-result click",[l]),n.classList.contains("expanded")?n.classList.remove("expanded"):n.classList.add("expanded")})}),t.querySelectorAll(".dice-btn.rollable").forEach(l=>{l.addEventListener("click",async a=>{var _;a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation();const n=l.dataset,c=n.actorId,u=game.actors.get(c);if(!u){ui.notifications.warn("Actor not found");return}if(!(game.user.isGM||u.isOwner)){ui.notifications.warn(`You don't have permission to roll for ${u.name}`);return}const f=(_=n.type)==null?void 0:_.toLowerCase(),m=n.rollKey,R=n.groupRollId,b=n.dc?parseInt(n.dc):null;r.log("Rollable dice clicked",[f,m,c,R]);const T={rollKey:m,groupRollId:R,config:{advantage:!1,disadvantage:!1,target:b,rollMode:game.settings.get("core","rollMode")}},y={configure:!0,isRollRequest:!0},p={rollMode:game.settings.get("core","rollMode"),create:!0,isRollRequest:!0},L={parts:[],data:{},options:{}};try{const A=Q[f];if(A)await A(u,T,L,y,p);else{let D;switch(f){case g.SKILL:D="rollSkill";break;case g.ABILITY:case g.ABILITY_CHECK:D="rollAbilityTest";break;case g.SAVE:case g.SAVING_THROW:D="rollAbilitySave";break;case g.TOOL:D="rollToolCheck";break;default:ui.notifications.warn(`Unknown roll type: ${f}`);return}D&&u[D]&&await u[D](m,{...T.config,messageOptions:{"flags.flash-rolls-5e.groupRollId":R}})}}catch(A){r.error("Error executing roll from chat",A),ui.notifications.error(`Failed to execute roll: ${A.message}`)}})});const o=t.querySelector(".group-roll-dc-control"),i=t.querySelector(".dc-input");if(o){const l=o.dataset.showToPlayers==="true";if(game.user.isGM||(o.style.display="none"),!game.user.isGM&&!l){const a=t.querySelector(".group-roll-footer .group-result-details");a&&(a.style.display="none")}}if(i)if(!game.user.isGM)i.readOnly=!0,i.style.cursor="not-allowed";else{let l=null;const a=async()=>{const n=parseInt(i.value);if(!i.value)return;if(isNaN(n)||n<1||n>99){i.value="";return}const c=i.dataset.messageId,u=game.messages.get(c);u&&await this.updateGroupRollDC(u,n)};i.addEventListener("input",n=>{l&&clearTimeout(l),l=setTimeout(()=>{a()},750)}),i.addEventListener("keypress",n=>{n.key==="Enter"&&(l&&clearTimeout(l),a())})}};Hooks.on(F.RENDER_CHAT_MESSAGE,(t,s)=>{t.getFlag(S,"isGroupRoll")&&e(s)}),Hooks.on(F.RENDER_CHAT_LOG,(t,s)=>{s.querySelectorAll(".flash5e-group-roll").forEach(i=>{const l=i.closest(".chat-message");if(l){const a=l.dataset.messageId,n=game.messages.get(a);n&&n.getFlag(S,"isGroupRoll")&&e(i)}})})}static async preloadTemplate(){r.log("ChatMessageUtils.preloadTemplate");try{await H.loadTemplates([this.templatePath])}catch(e){r.error("Failed to preload template",e)}}static async createGroupRollMessage(e,t,s,o,i){r.log("ChatMessageUtils.createGroupRollMessage",[e.length,t,s,i]);const l=this.buildGroupRollData(e,t,s,o);if(!l)return r.error("createGroupRollMessage - Failed to build group roll data"),null;l.groupRollId=i;const a=e.filter(h=>h&&h.actor),c=a.some(h=>E.isPlayerOwnerActive(h.actor))?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode");return this.pendingRolls.set(i,{actorEntries:a.map(h=>({actorId:h.actor.id,uniqueId:h.uniqueId,tokenId:h.tokenId})),rollType:t,rollKey:s,config:o,results:new Map}),await this.postGroupMessage(l,c)}static buildGroupRollData(e,t,s,o){r.log("ChatMessageUtils.buildGroupRollData",[e.length,t,s,o]),r.log("ChatMessageUtils.buildGroupRollData - actorEntries structure",e.map(f=>{var m,R;return{hasEntry:!!f,hasActor:!!(f&&f.actor),entryKeys:f?Object.keys(f):"null",actorType:((R=(m=f==null?void 0:f.actor)==null?void 0:m.constructor)==null?void 0:R.name)||"undefined"}}));const i=e.filter(f=>f&&f.actor);if(i.length===0)return r.error("buildGroupRollData - No valid actor entries found",[e]),null;let l=this._buildFlavorText(t,s,o);const a=(o==null?void 0:o.dc)||(o==null?void 0:o.target),n=i.map(f=>{var m,R,b,T;return{actorId:f.actor.id,uniqueId:f.uniqueId,tokenId:f.tokenId,actorImg:f.actor.img||((R=(m=f.actor.prototypeToken)==null?void 0:m.texture)==null?void 0:R.src)||"icons/svg/mystery-man.svg",actorName:f.tokenId&&((T=(b=canvas.tokens)==null?void 0:b.get(f.tokenId))==null?void 0:T.name)||f.actor.name,rolled:!1,showDice:!0,total:null,success:!1,failure:!1}}),c=E.shouldShowDC(t),u=v(),h=I.get(u.showGroupDCToPlayers.tag);return{flavor:l,results:n,showDC:a!=null,dc:a,rollType:t,rollKey:s,supportsDC:c,showDCToPlayers:h,actorEntries:i.map(f=>({actorId:f.actor.id,uniqueId:f.uniqueId,tokenId:f.tokenId})),moduleId:S}}static _buildFlavorText(e,t,s){var i,l,a,n,c,u,h,f;let o="";switch(e==null?void 0:e.toLowerCase()){case g.ABILITY:case g.ABILITY_CHECK:const m=((i=CONFIG.DND5E.abilities[t])==null?void 0:i.label)||t;o=game.i18n.format("DND5E.AbilityPromptTitle",{ability:m});break;case g.SAVE:case g.SAVING_THROW:const R=((l=CONFIG.DND5E.abilities[t])==null?void 0:l.label)||t;o=game.i18n.format("DND5E.SavePromptTitle",{ability:R});break;case g.SKILL:const b=((a=CONFIG.DND5E.skills[t])==null?void 0:a.label)||t,T=(s==null?void 0:s.ability)||((n=CONFIG.DND5E.skills[t])==null?void 0:n.ability)||"int",y=((c=CONFIG.DND5E.abilities[T])==null?void 0:c.label)||T;o=game.i18n.format("DND5E.SkillPromptTitle",{skill:b,ability:y});break;case g.TOOL:const p=(h=(u=CONFIG.DND5E.enrichmentLookup)==null?void 0:u.tools)==null?void 0:h[t];let L=t;if(p!=null&&p.id){const D=dnd5e.documents.Trait.getBaseItem(p.id,{indexOnly:!0});L=(D==null?void 0:D.name)||t}const _=(s==null?void 0:s.ability)||(p==null?void 0:p.ability)||"int",A=((f=CONFIG.DND5E.abilities[_])==null?void 0:f.label)||_;o=game.i18n.format("DND5E.ToolPromptTitle",{tool:L,ability:A});break;case g.CONCENTRATION:o=game.i18n.localize("DND5E.ConcentrationBreaking")||"Concentration";break;case g.DEATH_SAVE:o=game.i18n.localize("DND5E.DeathSave")||"Death Saving Throw";break;case g.HIT_DIE:case"hitdice":o=game.i18n.localize("DND5E.HitDice")||"Hit Dice";break;case g.HEALING:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Healing")||"Healing";break;case g.CUSTOM:o=(s==null?void 0:s.flavor)||t||game.i18n.localize("DND5E.Roll")||"Custom Roll";break;case g.FORMULA:o=(s==null?void 0:s.flavor)||t||game.i18n.localize("DND5E.Roll")||"Custom Formula";break;case g.ITEM_SAVE:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.SavingThrow")||"Saving Throw";break;case g.INITIATIVE:o=game.i18n.localize("DND5E.Initiative");break;case g.ATTACK:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Attack")||"Attack Roll";break;case g.DAMAGE:o=(s==null?void 0:s.flavor)||game.i18n.localize("DND5E.Damage")||"Damage Roll";break;default:o=(s==null?void 0:s.flavor)||"Roll"}return o}static async postGroupMessage(e,t=null){r.log("postGroupMessage - groupRollId",[e.groupRollId,t]);try{const o={content:await H.renderTemplate(this.templatePath,e),speaker:{alias:"Group Roll"},flags:{[S]:{isGroupRoll:!0,groupRollId:e.groupRollId,rollData:e}}};t&&ChatMessage.applyRollMode(o,t);const i=await ChatMessage.create(o);return this.groupRollMessages.set(e.groupRollId,i),i}catch(s){return r.error("Failed to post group message",s),null}}static async updateGroupRollMessage(e,t,s){if(r.log("ChatMessageUtils.updateGroupRollMessage",[e,t,s]),!game.user.isGM)return;const i=(this.updateQueue.get(e)||Promise.resolve()).then(()=>this._performGroupRollUpdate(e,t,s));return this.updateQueue.set(e,i),i}static async _performGroupRollUpdate(e,t,s){var u,h,f;let o=this.groupRollMessages.get(e),i=this.pendingRolls.get(e);if(!o&&(o=game.messages.contents.find(R=>R.getFlag(S,"groupRollId")===e&&R.getFlag(S,"isGroupRoll")),o&&(this.groupRollMessages.set(e,o),r.log("updateGroupRollMessage - Found and registered group message",[e]),!i))){const R=o.getFlag(S,"rollData");i={actorEntries:R.actorEntries||R.results.map(b=>({actorId:b.actorId,uniqueId:b.uniqueId,tokenId:b.tokenId})),results:new Map},this.pendingRolls.set(e,i)}if(!o){r.log("No group message found for groupRollId",e);return}i&&i.results&&i.results.set(t,{total:s.total,roll:s});const l=o.getFlag(S,"rollData");let a=l.results.findIndex(m=>m.uniqueId===t);if(a===-1&&(a=l.results.findIndex(m=>m.actorId===t),a===-1&&(a=l.results.findIndex(m=>m.tokenId===t)),a===-1&&((u=o.speaker)!=null&&u.actor))){const m=o.speaker.actor;a=l.results.findIndex(R=>R.actorId===m)}if(a!==-1){l.results[a].rolled=!0,l.results[a].showDice=!1,l.results[a].total=s.total;try{let m=await s.render();l.results[a].rollBreakdown=m}catch(m){r.error("Error rendering roll breakdown",m),l.results[a].rollBreakdown=null}l.showDC&&l.dc&&(l.results[a].success=s.total>=l.dc,l.results[a].failure=s.total<l.dc)}l.allRolled=l.results.every(m=>m.rolled),l.messageId=o.id,l.supportsDC=E.shouldShowDC(l.rollType);const n=v();if(l.showDCToPlayers=I.get(n.showGroupDCToPlayers.tag),l.supportsDC&&l.showDC&&l.dc){const m=((h=l.actorEntries)==null?void 0:h.map(b=>game.actors.get(b.actorId)).filter(b=>b))||((f=l.actors)==null?void 0:f.map(b=>game.actors.get(b)).filter(b=>b))||[],R=E.getGroupResult(l.results,l.dc,m,l.rollType,l.rollKey);l.groupResult=R,r.log("updateGroupRollMessage - COMPLETE?",[R.complete]),R.complete&&R.details&&(l.groupSummary=R.details.summary)}const c=await H.renderTemplate(this.templatePath,l);await o.update({content:c,flags:{[S]:{rollData:l}}}),i!=null&&i.results&&(i!=null&&i.actorEntries)&&i.results.size===i.actorEntries.length&&(this.pendingRolls.delete(e),setTimeout(()=>{this.groupRollMessages.delete(e),this.updateQueue.delete(e)},6e4))}static async updateGroupRollDC(e,t){var n,c;const s=e.getFlag(S,"rollData");if(!s||(s.supportsDC=E.shouldShowDC(s.rollType),!s.supportsDC))return;s.dc=t,s.showDC=!0,s.results.forEach(u=>{u.rolled&&u.total!==null&&(u.success=u.total>=t,u.failure=u.total<t)});const o=((n=s.actorEntries)==null?void 0:n.map(u=>game.actors.get(u.actorId)).filter(u=>u))||((c=s.actors)==null?void 0:c.map(u=>game.actors.get(u)).filter(u=>u))||[],i=E.getGroupResult(s.results,t,o,s.rollType,s.rollKey);s.groupResult=i,i.complete&&i.details&&(s.groupSummary=i.details.summary),s.allRolled=s.results.every(u=>u.rolled),s.messageId=e.id;const l=v();s.showDCToPlayers=I.get(l.showGroupDCToPlayers.tag);const a=await H.renderTemplate(this.templatePath,s);await e.update({content:a,flags:{[S]:{rollData:s}}})}static interceptRollMessage(e,t,s){var f,m,R,b,T,y,p;const o=v();if(!I.get(o.groupRollsMsgEnabled.tag))return;const l=(f=e.speaker)==null?void 0:f.actor,a=(m=e.speaker)==null?void 0:m.token;let n;if(a){const L=((R=canvas.tokens)==null?void 0:R.get(a))||((T=(b=game.scenes.active)==null?void 0:b.tokens)==null?void 0:T.get(a));n=L==null?void 0:L.actor}if(n||(n=game.actors.get(l)),!n)return;const c=a||l,u=e.getFlag(S,"groupRollId")||((y=n.getFlag(S,"tempInitiativeConfig"))==null?void 0:y.groupRollId);if(!u){r.log("interceptRollMessage #2 - no groupRollId in flag",[n.name]);return}if(!game.user.isGM&&!this.groupRollMessages.has(u)){const _=game.messages.contents.find(A=>A.getFlag(S,"groupRollId")===u&&A.getFlag(S,"isGroupRoll"));_&&(this.groupRollMessages.set(u,_),r.log("interceptRollMessage - Registered group roll message",[n.name,u]))}if(!this.groupRollMessages.has(u)){r.log("interceptRollMessage - groupRollId not in map",[n.name,u,Array.from(this.groupRollMessages.keys())]),r.log("interceptRollMessage - All group messages in chat:",[game.messages.contents,game.messages.contents.filter(A=>A.getFlag(S,"isGroupRoll")).map(A=>({id:A.id,groupRollId:A.getFlag(S,"groupRollId")}))]);const _=game.messages.contents.find(A=>A.getFlag(S,"groupRollId")===u&&A.getFlag(S,"isGroupRoll"));if(_)r.log("interceptRollMessage - Found group message in chat log, registering",[u]),this.groupRollMessages.set(u,_);else{r.log("interceptRollMessage - No group message found in chat log either",[u]);return}}const h=(p=e.rolls)==null?void 0:p[0];if(h)if(t&&t instanceof HTMLElement&&t.style&&(t.style.display="none"),game.user.isGM){this.updateGroupRollMessage(u,c,h);const L=e.id;if(this.messagesScheduledForDeletion.has(L))return;this.messagesScheduledForDeletion.add(L),L&&setTimeout(async()=>{r.log("interceptRollMessage - deletion",[L]);try{game.messages.get(L)?(await e.delete(),r.log("interceptRollMessage - Deleted individual message",[L])):r.log("interceptRollMessage - Message already deleted",[L])}catch(_){r.log("interceptRollMessage - Error deleting message",[L,_.message])}finally{this.messagesScheduledForDeletion.delete(L)}},500)}else r.log("interceptRollMessage - Player roll intercepted, GM will handle update",[u])}static isGroupRoll(e){return this.pendingRolls.has(e)||this.groupRollMessages.has(e)}static async addGroupRollFlag(e,t,s=null){const o=v(),i=I.get(o.groupRollsMsgEnabled.tag);if(r.log("addGroupRollFlag called",[e,t.groupRollId,this.isGroupRoll(t.groupRollId)]),r.log("addGroupRollFlag - detailed check",["groupRollId:",t.groupRollId,"type:",typeof t.groupRollId,"isGM:",game.user.isGM,"actor:",s==null?void 0:s.name,"requestData keys:",Object.keys(t)]),!game.user.isGM&&t.groupRollId&&s&&(await s.setFlag(S,"tempGroupRollId",t.groupRollId),r.log("addGroupRollFlag - Stored tempGroupRollId on actor for player",[t.groupRollId,s.id]),s.isToken&&s.actor&&(await s.actor.setFlag(S,"tempGroupRollId",t.groupRollId),r.log("addGroupRollFlag - Also stored tempGroupRollId on base actor for player",[t.groupRollId,s.actor.id])),!this.groupRollMessages.has(t.groupRollId))){const a=game.messages.contents.find(n=>n.getFlag(S,"groupRollId")===t.groupRollId&&n.getFlag(S,"isGroupRoll"));a&&(this.groupRollMessages.set(t.groupRollId,a),r.log("addGroupRollFlag - Registered group roll message on player side",[t.groupRollId]))}i&&t.groupRollId&&(!game.user.isGM||this.isGroupRoll(t.groupRollId))&&(e.data=e.data||{},e.data.flags=e.data.flags||{},e.data.flags[S]=e.data.flags[S]||{},e.data.flags[S].groupRollId=t.groupRollId,r.log("addGroupRollFlag - Added flag to messageConfig",[e]))}static cleanup(){const e=Date.now()-3e5;for(const[t,s]of this.groupRollMessages.entries())s.timestamp<e&&(this.groupRollMessages.delete(t),this.pendingRolls.delete(t))}}w(z,"groupRollMessages",new Map),w(z,"pendingRolls",new Map),w(z,"messagesScheduledForDeletion",new Set),w(z,"updateQueue",new Map),w(z,"templatePath","modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs");const Q={ability:async(d,e,t,s,o)=>{const i=E.buildRollConfig(e,t,{ability:e.rollKey});await z.addGroupRollFlag(o,e,d),await d.rollAbilityCheck(i,s,o)},abilitycheck:async(d,e,t,s,o)=>Q.ability(d,e,t,s,o),save:async(d,e,t,s,o)=>{var l;const i=E.buildRollConfig(e,t,{ability:((l=e.config)==null?void 0:l.ability)||e.rollKey});await z.addGroupRollFlag(o,e,d),await d.rollSavingThrow(i,s,o)},savingthrow:async(d,e,t,s,o)=>Q.save(d,e,t,s,o),skill:async(d,e,t,s,o)=>{var a,n,c,u,h,f;const i=((n=(a=d.system.skills)==null?void 0:a[e.rollKey])==null?void 0:n.ability)||((u=(c=CONFIG.DND5E.skills)==null?void 0:c[e.rollKey])==null?void 0:u.ability)||void 0,l=E.buildRollConfig(e,t,{skill:e.rollKey,chooseAbility:s.configure!==!1,ability:e.config.ability||i});if(e.config.ability&&s.configure===!1){const m=((h=CONFIG.DND5E.skills[e.rollKey])==null?void 0:h.label)||e.rollKey,R=((f=CONFIG.DND5E.abilities[e.config.ability])==null?void 0:f.label)||e.config.ability,b=game.i18n.format("DND5E.SkillPromptTitle",{skill:m,ability:R});o.data=o.data||{},o.data.flavor=b}await z.addGroupRollFlag(o,e,d),await d.rollSkill(l,s,o)},tool:async(d,e,t,s,o)=>{var n,c,u,h,f,m,R;const i=(n=d.system.tools)==null?void 0:n[e.rollKey],l=(i==null?void 0:i.ability)||((h=(u=(c=CONFIG.DND5E.enrichmentLookup)==null?void 0:c.tools)==null?void 0:u[e.rollKey])==null?void 0:h.ability)||"int",a=E.buildRollConfig(e,t,{tool:e.rollKey,chooseAbility:s.configure!==!1,ability:e.config.ability||l});if(e.config.ability&&s.configure===!1){const b=(m=(f=CONFIG.DND5E.enrichmentLookup)==null?void 0:f.tools)==null?void 0:m[e.rollKey];let T=e.rollKey;if(b!=null&&b.id){const L=dnd5e.documents.Trait.getBaseItem(b.id,{indexOnly:!0});T=(L==null?void 0:L.name)||e.rollKey}const y=((R=CONFIG.DND5E.abilities[e.config.ability])==null?void 0:R.label)||e.config.ability,p=game.i18n.format("DND5E.ToolPromptTitle",{tool:T,ability:y});o.data=o.data||{},o.data.flavor=p}r.log("RollHandlers.tool #2",[a,s,o]),await z.addGroupRollFlag(o,e,d),await d.rollToolCheck(a,s,o)},concentration:async(d,e,t,s,o)=>{const i=E.buildRollConfig(e,t);await z.addGroupRollFlag(o,e,d),await d.rollConcentration(i,s,o)},attack:async(d,e,t,s,o)=>{await Q.handleActivityRoll(d,g.ATTACK,e,t,s,o)},damage:async(d,e,t,s,o)=>{await Q.handleActivityRoll(d,g.DAMAGE,e,t,s,o)},itemsave:async(d,e,t,s,o)=>{await Q.handleActivityRoll(d,g.ITEM_SAVE,e,t,s,o)},initiative:async(d,e,t,s,o)=>{var l,a,n;if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));return}e.config.situational||(l=t.data)!=null&&l.situational,e.groupRollId;let i=d;if(!d.isToken){const c=canvas.tokens.placeables.find(u=>{var h;return((h=u.actor)==null?void 0:h.id)===d.id});if(c)i=c.actor;else{ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.noTokensForInitiative"));return}}await z.addGroupRollFlag(o,e,d);try{if(s.configure){if(r.log("RollHandlers.initiative - Dialog",[]),e.config){const c=E.buildRollConfig(e,t,{ability:((n=(a=d.system.attributes)==null?void 0:a.init)==null?void 0:n.ability)||"dex"}),u={advantage:e.config.advantage||!1,disadvantage:e.config.disadvantage||!1,rollMode:e.config.rollMode||game.settings.get("core","rollMode"),rolls:c.rolls,groupRollId:e.groupRollId};await d.setFlag(S,"tempInitiativeConfig",u),await i.setFlag(S,"tempInitiativeConfig",u)}await i.rollInitiativeDialog(),await i.unsetFlag(S,"tempInitiativeConfig"),await d.unsetFlag(S,"tempInitiativeConfig")}else{const c={rollMode:e.config.rollMode||game.settings.get("core","rollMode"),groupRollId:e.groupRollId};await d.setFlag(S,"tempInitiativeConfig",c),await i.setFlag(S,"tempInitiativeConfig",c);const u={createCombatants:!0,rerollInitiative:!0};await i.rollInitiative(u),await i.unsetFlag(S,"tempInitiativeConfig"),await d.unsetFlag(S,"tempInitiativeConfig")}}catch(c){r.error("RollHandlers.initiative - Error",[c]),B.notify("error",`Initiative roll failed: ${c.message}`)}},initiativedialog:async(d,e,t,s,o)=>Q.initiative(d,e,t,s,o),deathsave:async(d,e,t,s,o)=>{const i=E.buildRollConfig(e,t);await z.addGroupRollFlag(o,e,d),await d.rollDeathSave(i,s,o)},hitdie:async(d,e,t,s,o)=>{s.configure=game.user.isGM?s.configure:!0;const i=E.buildRollConfig(e,t,{denomination:e.rollKey});r.log("RollHandlers.hitdie",[i,s,o]),await z.addGroupRollFlag(o,e,d),await d.rollHitDie(i,s,o)},custom:async(d,e,t,s,o)=>{await Q.handleCustomRoll(d,e,s,o)},async handleActivityRoll(d,e,t,s,o,i){var l,a;if(r.log("RollHandlers.handleActivityRoll",[e,t,s]),t.rollKey){const n=E.buildRollConfig(t,s),c=((a=(l=n.rolls)==null?void 0:l[0])==null?void 0:a.options)||{},u={usage:{...t.config,rolls:n.rolls,...c.attackMode&&{attackMode:c.attackMode},...c.ammunition&&{ammunition:c.ammunition},...c.mastery!==void 0&&{mastery:c.mastery}},dialog:o,message:i};r.log("handleActivityRoll - final activity config",[u]),await mt.executeActivityRoll(d,e,t.rollKey,t.activityId,u)}},async handleCustomRoll(d,e,t,s){var l,a,n,c;const o=e.rollKey;if((t==null?void 0:t.configure)===!1){try{const u=new Roll(o,d.getRollData());u.options=u.options||{},u.options.isRollRequest=((l=e.config)==null?void 0:l.isRollRequest)!==!1,await u.evaluate(),await z.addGroupRollFlag(s,e,d),await u.toMessage({speaker:ChatMessage.getSpeaker({actor:d}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${g.CUSTOM}`),rollMode:(s==null?void 0:s.rollMode)||((a=e.config)==null?void 0:a.rollMode)||game.settings.get("core","rollMode"),isRollRequest:((n=e.config)==null?void 0:n.isRollRequest)!==!1,create:(s==null?void 0:s.create)!==!1,flags:(c=s==null?void 0:s.data)==null?void 0:c.flags})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:o}))}return}new Ie({formula:o,readonly:!0,actor:d,callback:async u=>{var h;try{const f=new Roll(u,d.getRollData());f.options=f.options||{},f.options.isRollRequest=!0,await f.evaluate(),await z.addGroupRollFlag(s,e,d),await f.toMessage({speaker:ChatMessage.getSpeaker({actor:d}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${g.CUSTOM}`),rollMode:e.config.rollMode,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM",flags:(h=s==null?void 0:s.data)==null?void 0:h.flags})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:u}))}}}).render(!0)},async handleHitDieRecovery(d){const e=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in e&&(e.deltas.hitDice=e.dhd),d._getRestHitDiceRecovery({maxHitDice:d.system.attributes.hd.max,type:"long"},e),e.dhd=e.deltas.hitDice,e.longRest=!0;try{if(e.updateData&&Object.keys(e.updateData).length>0){const t=await d.update(e.updateData,{isRest:!1})}else r.log("No actor updates to perform",[]);if(e.updateItems&&e.updateItems.length>0){const t=await d.updateEmbeddedDocuments("Item",e.updateItems,{isRest:!1})}else r.log("No item updates to perform",[])}catch(t){throw r.error("Error during updates in handleHitDieRecovery:",[t]),t}return r.log("handleHitDieRecovery #3",[e]),e}};async function Xe(){return game.combat||(await(await Combat.create({scene:game.scenes.active.id})).activate(),B.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.combatCreated"))),game.combat}async function Ze(d,e){if(!e.combat)return d;const t=d.map(i=>e.actors.get(i)).filter(i=>i),s=[],o=new Set;for(const i of t)e.combat.getCombatantsByActor(i.id).some(n=>n.initiative!==null)&&(s.push(i.name),o.add(i.id));if(r.log("filterActorsForInitiative",[s]),s.length>0)if(await foundry.applications.api.DialogV2.confirm({window:{title:e.i18n.localize("FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle"),classes:["flash5e-dialog"]},position:{width:420,height:"auto"},content:"<p>"+e.i18n.format("FLASH_ROLLS.ui.dialogs.rerollInitiative",{actors:s.join(", ")})+"</p>",rejectClose:!1,modal:!0})){if(e.user.isGM)for(const l of o){const a=e.combat.getCombatantsByActor(l);r.log("filterActorsForInitiative - resetting initiative for combatants",[a]);for(const n of a)await n.update({initiative:null})}else r.log("filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll");return d}else{const l=d.filter(a=>!o.has(a));return l.length===0&&B.notify("info",e.i18n.localize("FLASH_ROLLS.notifications.allActorsHaveInitiative")),l}return d}class et{static initialize(){r.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){r.log("RollInterceptor.registerHooks"),this._registerHook(U.PRE_ROLL_ABILITY_CHECK,this._handlePreRoll.bind(this,g.ABILITY)),this._registerHook(U.PRE_ROLL_SAVING_THROW,this._handlePreRoll.bind(this,g.SAVE)),this._registerHook(U.PRE_ROLL_SKILL_V2,this._handlePreRoll.bind(this,g.SKILL)),this._registerHook(U.PRE_ROLL_TOOL_V2,this._handlePreRoll.bind(this,g.TOOL)),this._registerHook(U.PRE_ROLL_ATTACK_V2,this._handlePreRoll.bind(this,g.ATTACK)),this._registerHook(U.PRE_ROLL_DAMAGE_V2,this._handlePreRoll.bind(this,g.DAMAGE)),this._registerHook(U.PRE_ROLL_DEATH_SAVE_V2,this._handlePreRoll.bind(this,g.DEATH_SAVE)),this._registerHook(U.PRE_ROLL_HIT_DIE_V2,this._handlePreRoll.bind(this,g.HIT_DIE)),this._registerHook(U.PRE_ROLL_INITIATIVE,this._handlePreRollInitiative.bind(this,g.INITIATIVE)),this._registerHook(U.PRE_ROLL_INITIATIVE_DIALOG,this._handlePreRollInitiative.bind(this,g.INITIATIVE)),this._registerHook(U.ROLL_INITIATIVE,this._handleRollInitiative.bind(this,g.INITIATIVE))}static _registerHook(e,t){r.log("RollInterceptor._registerHook");const s=Hooks.on(e,t);this.registeredHooks.add({hookName:e,hookId:s})}static unregisterHooks(){r.log("RollInterceptor.unregisterHooks");for(const{hookName:e,hookId:t}of this.registeredHooks)Hooks.off(e,t);this.registeredHooks.clear()}static _handlePreRollInitiative(e,t,s){}static _handlePreRoll(e,t,s,o){var f,m,R,b,T,y;if(r.log("_handlePreRoll #0",[e,t,s,o]),!game.user.isGM||t.isRollRequest===!1)return;H.isModuleOn(S,"midi-qol");const i=(t==null?void 0:t.hookNames)||(s==null?void 0:s.hookNames)||(o==null?void 0:o.hookNames)||[],l=i.includes("initiativeDialog")||i.includes("initiative");if(e===g.ATTACK){const p=(m=(f=t.subject)==null?void 0:f.item)==null?void 0:m.getFlag(S,"tempAttackConfig");if(r.log("_handlePreRoll - is Attack roll",[(R=t.subject)==null?void 0:R.item,p]),p){r.log("_handlePreRoll - found module flags, skipping interception",[p]);return}}if(l&&e===g.ABILITY&&(r.log("RollInterceptor._handlePreRoll - Overriding ability to initiative",[i]),e=g.INITIATIVE),t!=null&&t.isRollRequest||t.sendRequest===!1||s!=null&&s.isRollRequest||o!=null&&o.isRollRequest){r.log("_handlePreRoll - skipping interception (roll request)",[t,s,o]);return}let a;if(e===g.INITIATIVE&&t instanceof Actor){if(a=t,r.log("_handlePreRoll - Initiative",[t,s,o]),(s==null?void 0:s.isRollRequest)===!1||(o==null?void 0:o.isRollRequest)===!1)return}else e===g.HIT_DIE?a=((b=s==null?void 0:s.subject)==null?void 0:b.actor)||(s==null?void 0:s.subject)||(s==null?void 0:s.actor):e===g.ATTACK||e===g.DAMAGE?a=(T=t.subject)==null?void 0:T.actor:a=((y=t.subject)==null?void 0:y.actor)||t.subject||t.actor;const n=v();if(!I.get(n.rollInterceptionEnabled.tag)||!a||a.documentName!=="Actor")return;const u=H.getActorOwner(a);if(r.log("_handlePreRoll - ownership",[u]),!u||!u.active||u.id===game.user.id){r.log("_handlePreRoll - skipping interception (ownership)",[u==null?void 0:u.name,u==null?void 0:u.active]);return}else t.isRollRequest=!0;e===g.ATTACK&&(o={...o,rollMode:CONST.DICE_ROLL_MODES.PUBLIC});const h=t.midiOptions!==null&&t.midiOptions!==void 0;if(h&&game.user.isGM)return r.log("_handlePreRoll - isMidiActive",[h]),this._showGMConfigDialog(a,u,e,t,s,o),!1;if(t.sendRequest===!1){r.log("_handlePreRoll - skipping interception",[s.configure,t.sendRequest]);return}return r.log("_handlePreRoll - intercepting roll #1",[t,o]),this._showGMConfigDialog(a,u,e,t,s,o),!1}static _handleRollInitiative(e,t,s){}static async _handleInitiativePreChecks(e){return!game.combat&&!await Xe()?!1:(await Ze([e.id],game)).length>0}static _getDialogClass(e){const t=e==null?void 0:e.toLowerCase();return[g.SKILL,g.TOOL].includes(t)?He:t===g.HIT_DIE?Ne:t===g.ATTACK?pt:t===g.DAMAGE?ht:J}static _extractRollConfiguration(e,t,s,o){var n,c,u,h,f,m,R,b,T,y,p;const i=e==null?void 0:e.toLowerCase();let l=null;const a={rolls:[{parts:[],data:{},options:{}}]};switch(i){case g.SKILL:a.skill=t.skill,a.ability=t.ability||((n=t.subject)==null?void 0:n.ability),l=a.skill;break;case g.TOOL:a.tool=t.tool,a.ability=t.ability||((c=t.subject)==null?void 0:c.ability),l=a.tool;break;case g.ABILITY:case g.SAVE:a.ability=t.ability||((u=t.subject)==null?void 0:u.ability),l=a.ability,a.ability==="con"&&t.targetValue!==void 0&&(e=g.CONCENTRATION);break;case g.CONCENTRATION:a.ability="con",l="con";break;case g.INITIATIVE:case g.INITIATIVE_DIALOG:l=((f=(h=o.system.attributes)==null?void 0:h.init)==null?void 0:f.ability)||"dex";break;case g.HIT_DIE:a.denomination=typeof t=="string"?t:t.denomination||((m=t.subject)==null?void 0:m.denomination),l=a.denomination;break;case g.ATTACK:s!=null&&s.options&&(a.ammunition=s.options.ammunition,a.attackMode=s.options.attackMode,a.mastery=s.options.mastery),l=(b=(R=t.subject)==null?void 0:R.item)==null?void 0:b.id;break;case g.DAMAGE:a.item=(T=t.subject)==null?void 0:T.item,a.subject=t.subject,a.critical=t.critical||{},l=(p=(y=t.subject)==null?void 0:y.item)==null?void 0:p.id;break}return{rollKey:l,rollConfig:a}}static async _getDialogResult(e,t,s,o,i,l,a,n){const c=s==null?void 0:s.toLowerCase();if(r.log("_getDialogResult",[t,s,o,a,n]),i)return{sendRequest:!0,advantage:!1,disadvantage:!1,situational:"",rollMode:game.settings.get("core","rollMode")};if(!e.initConfiguration)throw r.error("DialogClass.initConfiguration not found",[e,e.name]),new Error(`DialogClass ${e.name} does not have initConfiguration method`);const u={skipRollDialog:!1,sendRequest:l};return c===g.ATTACK||c===g.DAMAGE?await e.initConfiguration([t],c,o,u,a,n):await e.initConfiguration([t],c,o,u)}static async _showGMConfigDialog(e,t,s,o,i,l){r.log("_showGMConfigDialog - config",[s,o]);const a=v(),n=I.get(a.rollRequestsEnabled.tag),c=I.get(a.skipRollDialog.tag);try{if((s==null?void 0:s.toLowerCase())===g.INITIATIVE&&!await this._handleInitiativePreChecks(e))return;const h=this._getDialogClass(s),{rollKey:f,rollConfig:m}=this._extractRollConfiguration(s,o,i,e);r.log("_showGMConfigDialog - rollConfig",[m,f]);const R=await this._getDialogResult(h,e,s,f,c,n,o,i);if(!R){r.log("_showGMConfigDialog - Dialog cancelled");return}if(!R.sendRequest||!n){r.log("_showGMConfigDialog - triggering _executeInterceptedRoll",[s,o,R]),await this._executeInterceptedRoll(e,s,o,R);return}delete o.event;const b={...o,...R,rolls:R.rolls,requestedBy:game.user.name,...s===g.ATTACK&&{chatMessage:!1}};r.log("_showGMConfigDialog - triggering _sendRollRequest",[s,b]),this._sendRollRequest(e,t,s,b)}catch(u){r.error("RollInterceptor._showGMConfigDialog - Error",[u])}}static async _executeInterceptedRoll(e,t,s,o){var f,m,R,b,T,y,p,L,_,A,D,C,O,k;r.log("RollInterceptor._executeInterceptedRoll",[e,t,s,o]);const i=t==null?void 0:t.toLowerCase(),l=((f=o.rolls)==null?void 0:f[0])||{parts:[],data:{},options:{}},a=((m=l.data)==null?void 0:m.situational)||o.situational||"";let n;switch(i){case g.SKILL:n=s.skill;break;case g.TOOL:n=s.tool;break;case g.ABILITY:case g.SAVE:n=s.ability||((R=s.subject)==null?void 0:R.ability);break;case g.HIT_DIE:n=s.denomination;break;default:n=s.ability||s.skill||s.tool||s.denomination}const c={rollKey:n,config:{advantage:o.advantage||s.advantage,disadvantage:o.disadvantage||s.disadvantage,target:o.target||o.dc||s.target,rollMode:o.rollMode||s.rollMode,situational:a,isRollRequest:!1,ability:s.ability}};if(i===g.SKILL&&!c.config.ability)c.config.ability=((T=(b=e.system.skills)==null?void 0:b[c.rollKey])==null?void 0:T.ability)||((p=(y=CONFIG.DND5E.skills)==null?void 0:y[c.rollKey])==null?void 0:p.ability);else if(i===g.TOOL&&!c.config.ability){const G=(L=e.system.tools)==null?void 0:L[c.rollKey];c.config.ability=(G==null?void 0:G.ability)||((D=(A=(_=CONFIG.DND5E.enrichmentLookup)==null?void 0:_.tools)==null?void 0:A[c.rollKey])==null?void 0:D.ability)||"int"}else(i===g.ABILITY||i===g.SAVE)&&!c.config.ability&&(c.config.ability=c.rollKey);r.log("RollInterceptor._executeInterceptedRoll - requestData",[c,s,o]);const u={configure:!1,isRollRequest:!1},h={rollMode:c.config.rollMode,create:!0,isRollRequest:!1};try{const G=g,N=Q[i];N?((i===g.ATTACK||i===g.DAMAGE||i===g.SAVE)&&(c.rollKey=(O=(C=s.subject)==null?void 0:C.item)==null?void 0:O.id,c.activityId=(k=s.subject)==null?void 0:k.id),await N(e,c,l,u,h)):r.warn(`No handler found for roll type: ${i}`)}catch(G){r.error("RollInterceptor._executeInterceptedRoll",[G])}}static async _sendRollRequest(e,t,s,o){var f;r.log("_sendRollRequest",[e,t,s,o]),r.log("_sendRollRequest - config.rolls",[o.rolls]);const i=v(),l=I.get(i.skipRollDialog.tag);let a=s==null?void 0:s.toLowerCase();a===g.INITIATIVE&&(a=g.INITIATIVE_DIALOG);let n=null,c=null;switch(a){case g.ABILITY:case g.SAVE:n=o.ability;break;case g.SKILL:n=o.skill;break;case g.TOOL:n=o.tool;break;case g.ATTACK:case g.DAMAGE:r.log("_sendRollRequest - Attack/Damage roll config",[s,o]),n=(f=o.subject.item)==null?void 0:f.id,c=o.subject.id;break;case g.HIT_DIE:n=typeof o=="string"?o:o.denomination;break;case g.INITIATIVE_DIALOG:case g.INITIATIVE:n=null;break;case g.DEATH_SAVE:n=null;break;default:r.warn(`Unknown roll type: ${s}`);return}const u={...o};delete u.subject,delete u.workflow,delete u.item,delete u.activity;const h={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:e.id,rollType:a,rollKey:n,activityId:c,rollProcessConfig:{...u,_requestedBy:game.user.name},skipRollDialog:l,targetTokenIds:Array.from(game.user.targets).map(m=>m.id),preserveTargets:I.get(i.useGMTargetTokens.tag)};if(r.log("_sendRollRequest - requestData",[t,h]),!t||!h){ui.notifications.warn("Flash Rolls: No owner found for actor "+e.name);return}if(!t.active){const m=v();I.get(m.showOfflineNotifications.tag)&&ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:t.name})),await this._executeInterceptedRoll(e,s,o,{...o,sendRequest:!1});return}ee.execForUser("handleRollRequest",t.id,h),ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:(t==null?void 0:t.name)||"Unknown",actor:e.name||"Unknown"}))}}w(et,"registeredHooks",new Set);class Ve{static getActorStats(e){var i,l,a,n,c,u;const t=e.system,s=[];(i=t.attributes)!=null&&i.hp&&s.push({abbrev:"HP",value:t.attributes.hp.value}),(l=t.attributes)!=null&&l.ac&&s.push({abbrev:"AC",value:t.attributes.ac.value});const o=(n=(a=t.attributes)==null?void 0:a.spell)==null?void 0:n.dc;return o&&s.push({abbrev:"DC",value:o}),(u=(c=t.skills)==null?void 0:c.prc)!=null&&u.passive&&s.push({abbrev:"PRC",value:t.skills.prc.passive}),s}static getActorHPData(e){var i;const t=(i=e.system.attributes)==null?void 0:i.hp;if(!t||!t.max)return{hpPercent:100,hpColor:"var(--fr5e-color-hp-high)"};const s=Math.round(t.value/t.max*100),o=s>50?"var(--fr5e-color-hp-high)":"var(--fr5e-color-hp-low)";return{hpPercent:s,hpColor:o}}static getValidActorIds(e,t){return e.filter(s=>{const o=game.actors.get(s);if(!o)return!1;const i=Fe(o),l=!i&&Je(o);return t==="pc"&&i||t==="npc"&&l})}}class ze{static async getRollConfiguration(e,t,s,o,i){const l=v(),a=I.get(l.rollRequestsEnabled.tag);if(!o&&t!==g.CUSTOM){let n;[g.SKILL,g.TOOL].includes(t)?n=He:t===g.HIT_DIE?n=Ne:n=J;const c=await n.initConfiguration(e,t,s,{skipRollDialog:o,sendRequest:a||!1});return r.log("getRollConfiguration",[c]),c}else{const n={rolls:[{parts:[],data:{},options:{}}],advantage:!1,disadvantage:!1,rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:!0,sendRequest:a&&i.length>0};return t===g.DEATH_SAVE&&(n.target=10),n}}static async handleCustomRoll(){return await this.showCustomRollDialog()}static async showCustomRollDialog(){return r.log("showCustomRollDialog"),Ie.prompt({formula:"",readonly:!1})}}class ue{static initializeDrag(e){const t=e.element.querySelector(this.DRAG_HANDLE_SELECTOR);if(!t){r.error("RollMenuDragUtil.initializeDrag - No drag handle found!");return}t.addEventListener("mousedown",s=>{this.handleDragStart(s,e)})}static handleDragStart(e,t){if(e.preventDefault(),e.stopPropagation(),t.isDragging=!0,!t.element)return;t.element.classList.add("dragging"),t.element.classList.remove("docked-right");const s=t.element.getBoundingClientRect(),o=e.clientX,i=e.clientY,l=s.left,a=s.top;t.element.parentElement,document.body.appendChild(t.element),t.element.style.position="fixed",t.element.style.inset="",t.element.style.top=`${a}px`,t.element.style.left=`${l}px`,t.element.style.right="auto",t.element.style.bottom="auto",t.element.style.zIndex="var(--z-index-app)",t.element.offsetHeight;const n={startX:o,startY:i,initialLeft:l,initialTop:a,currentLeft:l,currentTop:a},c=h=>this.handleDragMove(h,t,n),u=h=>this.handleDragEnd(h,t,n,c,u);document.addEventListener("mousemove",c),document.addEventListener("mouseup",u)}static handleDragMove(e,t,s){if(!t.isDragging)return;const o=e.clientX-s.startX,i=e.clientY-s.startY;s.currentLeft=s.initialLeft+o,s.currentTop=s.initialTop+i,t.element.style.inset="",t.element.style.right="auto",t.element.style.bottom="auto",t.element.style.position="fixed",t.element.style.top=`${s.currentTop}px`,t.element.style.left=`${s.currentLeft}px`;const l=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<l?t.element.classList.add("left-edge"):t.element.classList.remove("left-edge"),window.getComputedStyle(t.element),this.calculateSnapDistance(t).type!=="none"?t.element.classList.add("near-snap"):t.element.classList.remove("near-snap")}static async handleDragEnd(e,t,s,o,i){r.log("RollMenuDragUtil.handleDragEnd"),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i),t.isDragging=!1,t.element.classList.remove("dragging"),t.element.classList.remove("near-snap"),t.element.style.zIndex="";const l=this.calculateSnapDistance(t);if(l.type==="both-edges"){const a=document.querySelector("#chat-notifications");a&&a.insertBefore(t.element,a.firstChild),await this.snapToDefault(t)}else if(l.type==="right-edge"){const a=document.querySelector("#chat-notifications");a&&a.insertBefore(t.element,a.firstChild),await this.snapToRightEdge(t,s.currentTop)}else{t.isCustomPosition=!0,t.customPosition={x:s.currentLeft,y:s.currentTop,isCustom:!0,dockedRight:!1};const a=!!document.querySelector("body.crlngn-tabs");H.addCSSVars("--flash-rolls-menu-offset",a?"0px":"16px"),await this.saveCustomPosition(t.customPosition),t.element.classList.add("custom-position");const n=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<n&&t.element.classList.add("left-edge")}}static calculateSnapDistance(e){const t=document.querySelector(this.LIGHTNING_BOLT_SELECTOR);if(!t)return{type:"none",distance:1/0};const s=e.element.getBoundingClientRect(),o=t.getBoundingClientRect(),i=Math.abs(o.left-s.right),l=window.innerHeight-s.bottom;return i<=this.SNAP_DISTANCE?l<=this.SNAP_DISTANCE?{type:"both-edges",distance:0}:{type:"right-edge",distance:0}:{type:"none",distance:1/0}}static async snapToRightEdge(e,t){r.log("RollMenuDragUtil.snapToRightEdge",[t]),e.isCustomPosition=!0,e.customPosition={y:t,isCustom:!0,dockedRight:!0},e.element.classList.remove("custom-position","left-edge"),e.element.classList.add("docked-right","snapping"),e.element.style.position="fixed",e.element.style.inset="",e.element.style.left="",e.element.style.right="",e.element.style.bottom="",e.element.style.top=`${t}px`,e.element.style.zIndex="",pe(),await this.saveCustomPosition(e.customPosition),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static async snapToDefault(e){r.log("RollMenuDragUtil.snapToDefault"),e.isCustomPosition=!1,e.customPosition=null,e.element.classList.remove("custom-position"),e.element.classList.remove("left-edge"),e.element.classList.add("snapping"),e.element.style.position="",e.element.style.inset="",e.element.style.left="",e.element.style.top="",e.element.style.right="",e.element.style.bottom="",e.element.style.zIndex="",pe(),await this.saveCustomPosition(null),setTimeout(()=>{e.element.classList.remove("snapping")},300)}static applyCustomPosition(e,t){if(!(!t||!t.isCustom))if(r.log("RollMenuDragUtil.applyCustomPosition",[t]),e.isCustomPosition=!0,e.customPosition=t,t.dockedRight){const s=document.querySelector("#chat-notifications");s&&s.insertBefore(e.element,s.firstChild),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${t.y}px`,e.element.style.left="",e.element.style.right="",e.element.style.bottom="",e.element.classList.add("docked-right"),e.element.classList.remove("custom-position","left-edge"),pe()}else{document.body.appendChild(e.element),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${t.y}px`,e.element.style.left=`${t.x}px`,e.element.style.right="auto",e.element.style.bottom="auto";const s=!!document.querySelector("body.crlngn-tabs");H.addCSSVars("--flash-rolls-menu-offset",s?"0px":"16px"),e.element.classList.add("custom-position"),e.element.classList.remove("docked-right");const o=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;t.x<o&&e.element.classList.add("left-edge")}}static async saveCustomPosition(e){await game.user.setFlag(K.ID,"menuCustomPosition",e)}static loadCustomPosition(){return game.user.getFlag(K.ID,"menuCustomPosition")||null}static async resetPosition(e){await this.snapToDefault(e)}}w(ue,"SNAP_DISTANCE",50),w(ue,"DRAG_HANDLE_SELECTOR",".drag-handle"),w(ue,"LIGHTNING_BOLT_SELECTOR","#flash-rolls-icon");class Y{static isFavorite(e){try{const t=typeof e=="string"?game.actors.get(e):e;return!t||!t.getFlag?!1:t.getFlag(S,this.FLAGS.FAVORITE)===!0}catch(t){return r.error("Error checking favorite status",[t,e]),!1}}static isBlocked(e){const t=typeof e=="string"?game.actors.get(e):e;return t?t.getFlag(S,this.FLAGS.BLOCKED)===!0:!1}static async setFavorite(e,t){const s=typeof e=="string"?game.actors.get(e):e;if(!s){r.error("Actor not found",[e]);return}r.log("ActorStatusUtil.setFavorite",[s.name,t]),t?(await s.setFlag(S,this.FLAGS.FAVORITE,!0),await s.unsetFlag(S,this.FLAGS.BLOCKED)):await s.unsetFlag(S,this.FLAGS.FAVORITE),this._refreshMenu()}static async setBlocked(e,t){const s=typeof e=="string"?game.actors.get(e):e;if(!s){r.error("Actor not found",[e]);return}r.log("ActorStatusUtil.setBlocked",[s.name,t]),t?(await s.setFlag(S,this.FLAGS.BLOCKED,!0),await s.unsetFlag(S,this.FLAGS.FAVORITE)):await s.unsetFlag(S,this.FLAGS.BLOCKED),this._refreshMenu()}static async toggleFavorite(e,t){const s=t?!0:!this.isFavorite(e);await this.setFavorite(e,s)}static async toggleBlocked(e,t){const s=t?!0:!this.isBlocked(e);await this.setBlocked(e,s)}static async blockActor(e){await this.setBlocked(e,!0)}static getFavoriteActors(){return game.actors.filter(e=>this.isFavorite(e))}static getBlockedActors(){return game.actors.filter(e=>this.isBlocked(e))}static filterBlocked(e){return e.filter(t=>!this.isBlocked(t))}static getActorStatus(e){return{isFavorite:this.isFavorite(e),isBlocked:this.isBlocked(e)}}static async clearActorStatus(e){const t=typeof e=="string"?game.actors.get(e):e;t&&(await t.unsetFlag(S,this.FLAGS.FAVORITE),await t.unsetFlag(S,this.FLAGS.BLOCKED),this._refreshMenu())}static _refreshMenu(){Z.refreshIfOpen()}static getContextMenuOptions(e,t){return game.user.isGM&&(t.push({name:"FLASH_ROLLS.contextMenu.toggleFavorite",icon:'<i class="fas fa-bolt"></i>',callback:s=>{const o=s.data("documentId")||s.dataset.entryId;o&&this.toggleFavorite(o)},condition:s=>game.user.isGM}),t.push({name:"FLASH_ROLLS.contextMenu.toggleBlocked",icon:'<i class="fas fa-ban"></i>',callback:s=>{const o=s.data("documentId")||s.dataset.entryId;o&&this.toggleBlocked(o)},condition:s=>game.user.isGM})),t}}w(Y,"FLAGS",{FAVORITE:"isFavorite",BLOCKED:"isBlocked"});class yt{static initializeActorDrag(e){e.element.querySelectorAll('.actor-list .actor.drag-wrapper[draggable="true"]').forEach(o=>{o.addEventListener("dragstart",i=>this.handleDragStart(i,e)),o.addEventListener("dragend",i=>this.handleDragEnd(i,e))});const s=e.element;s.addEventListener("dragover",o=>this.handleDragOver(o)),s.addEventListener("drop",o=>this.handleDrop(o,e)),document.addEventListener("dragover",o=>this.handleGlobalDragOver(o,e)),document.addEventListener("drop",o=>this.handleGlobalDrop(o,e))}static handleDragStart(e,t){const s=e.currentTarget,o=s.dataset.actorId,i=game.actors.get(o);if(!i){e.preventDefault();return}r.log("ActorDragUtil.handleDragStart",[i.name,o]),e.dataTransfer.setData("text/plain",o),e.dataTransfer.setData("application/json",JSON.stringify({actorId:o,actorName:i.name,uniqueId:s.dataset.id,tokenId:s.dataset.tokenId||null})),e.dataTransfer.effectAllowed="move",s.classList.add("dragging");const l=s.getBoundingClientRect(),a=s.cloneNode(!0);a.style.opacity="0.6",a.style.position="absolute",a.style.top="-1000px",a.style.left="-1000px",a.style.width=l.width+"px",a.style.pointerEvents="none",document.body.appendChild(a),e.dataTransfer.setDragImage(a,l.width/2,l.height/2),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},0),t._currentDragData={actorId:o,actorElement:s,startTime:Date.now()}}static handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="none"}static handleDrop(e,t){e.preventDefault(),r.log("ActorDragUtil.handleDrop - dropped within menu, canceling remove"),this.cleanupDrag(t)}static handleGlobalDragOver(e,t){if(!t._currentDragData)return;const s=t.element.getBoundingClientRect();e.clientX>=s.left&&e.clientX<=s.right&&e.clientY>=s.top&&e.clientY<=s.bottom?t._currentDragData.actorElement&&t._currentDragData.actorElement.classList.remove("drag-remove-zone"):(e.preventDefault(),e.dataTransfer.dropEffect="move",t._currentDragData.actorElement&&t._currentDragData.actorElement.classList.add("drag-remove-zone"))}static handleGlobalDrop(e,t){if(!t._currentDragData)return;const s=t.element.getBoundingClientRect();if(!(e.clientX>=s.left&&e.clientX<=s.right&&e.clientY>=s.top&&e.clientY<=s.bottom)){e.preventDefault();const i=JSON.parse(e.dataTransfer.getData("application/json"));r.log("ActorDragUtil.handleGlobalDrop - blocking actor",[i.actorName]),this.blockActor(i.actorId,t)}this.cleanupDrag(t)}static handleDragEnd(e,t){r.log("ActorDragUtil.handleDragEnd"),setTimeout(()=>{this.cleanupDrag(t)},100)}static async blockActor(e,t){try{await Y.blockActor(e);const s=t.element.querySelector(`[data-actor-id="${e}"]`);if(s){const o=s.dataset.id;t.selectedActors.delete(o)}}catch(s){r.error("Error blocking actor",[s]),ui.notifications.error(`Failed to block actor: ${s.message}`)}}static cleanupDrag(e){var t;(t=e._currentDragData)!=null&&t.actorElement&&e._currentDragData.actorElement.classList.remove("dragging","drag-remove-zone"),e._currentDragData=null}static removeDragListeners(e){document.removeEventListener("dragover",this.handleGlobalDragOver),document.removeEventListener("drop",this.handleGlobalDrop)}}class Se{static canDrop(e){return r.log("ActorDropUtil.canDrop",[e]),game.user.isGM}static handleDragOver(e,t){r.log("ActorDropUtil.handleDragOver",[e,e.currentTarget,e.target]),e.preventDefault(),e.stopPropagation(),e.dataTransfer&&(e.dataTransfer.dropEffect="copy",r.log("ActorDropUtil.handleDragOver - dataTransfer types:",[e.dataTransfer.types]));const s=e.currentTarget.closest(".actor-list, .actors");return s&&(s.classList.add("drag-over"),r.log("ActorDropUtil.handleDragOver - added drag-over class")),!1}static handleDragLeave(e){r.log("ActorDropUtil.handleDragLeave",[e,e.currentTarget,e.target]);const t=e.currentTarget.getBoundingClientRect();if(e.clientX<t.left||e.clientX>t.right||e.clientY<t.top||e.clientY>t.bottom){const o=e.currentTarget.closest(".actor-list, .actors");o&&(o.classList.remove("drag-over"),r.log("ActorDropUtil.handleDragLeave - removed drag-over class"))}}static async handleDrop(e,t){e.preventDefault(),e.stopPropagation();for(let o=0;o<e.dataTransfer.types.length;o++){const i=e.dataTransfer.types[o],l=e.dataTransfer.getData(i);r.log(`ActorDropUtil.handleDrop - ${i}:`,[l])}t.element.querySelectorAll(".drag-over").forEach(o=>{o.classList.remove("drag-over")}),r.log("ActorDropUtil.handleDrop - removed drag-over class from all elements");try{const o=this.parseDragData(e);if(!o||o.type!=="Actor"){r.log("ActorDropUtil.handleDrop - Invalid drag data",[o]);return}const i=await this.getActorFromDragData(o);if(!i){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.actorNotFound")||"Actor not found");return}r.log("ActorDropUtil.handleDrop - Processing actor",[i]);const a=Fe(i)?"pc":"npc";t.currentTab!==a&&(r.log("ActorDropUtil.handleDrop - Switching to tab",[a]),t.currentTab=a),await this.addActorToMenu(i,t)}catch(o){r.error("ActorDropUtil.handleDrop - Error processing drop",[o]),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.dropError")||"Error adding actor to menu")}}static parseDragData(e){try{r.log("ActorDropUtil.parseDragData - Starting parse, available types:",[e.dataTransfer.types]);const t=e.dataTransfer.getData("application/json");if(r.log("ActorDropUtil.parseDragData - JSON data:",[t]),t){const o=JSON.parse(t);return r.log("ActorDropUtil.parseDragData - Parsed JSON:",[o]),o}const s=e.dataTransfer.getData("text/plain");if(r.log("ActorDropUtil.parseDragData - Text data:",[s]),s){if(s.startsWith("Actor.")){const o={type:"Actor",uuid:s};return r.log("ActorDropUtil.parseDragData - Created Actor drag data from text:",[o]),o}try{const o=JSON.parse(s);return r.log("ActorDropUtil.parseDragData - Parsed text as JSON:",[o]),o}catch{r.log("ActorDropUtil.parseDragData - Text is not JSON")}}return r.log("ActorDropUtil.parseDragData - No valid data found"),null}catch(t){return r.error("ActorDropUtil.parseDragData - Error parsing drag data",[t]),null}}static async getActorFromDragData(e){try{return e.uuid?await fromUuid(e.uuid):e.id?game.actors.get(e.id):null}catch(t){return r.error("ActorDropUtil.getActorFromDragData - Error getting actor",[t]),null}}static async addActorToMenu(e,t){r.log("ActorDropUtil.addActorToMenu",[e.name,e.id]),r.log("ActorDropUtil.addActorToMenu - Current tab:",[t.currentTab]);const s=Y.isBlocked(e),o=Y.isFavorite(e);if(r.log("ActorDropUtil.addActorToMenu - Actor status:",[{isBlocked:s,isFavorite:o}]),o&&!s){r.log("ActorDropUtil.addActorToMenu - Actor already a favorite",[e.name]),ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.actorAlreadyAdded",{actor:e.name})||`${e.name} is already in the menu`);return}r.log("ActorDropUtil.addActorToMenu - Setting as favorite:",[e.id]),await Y.setFavorite(e,!0),r.log("ActorDropUtil.addActorToMenu - Actor added to favorites successfully",[e.name,e.id])}}const{ApplicationV2:Lt,HandlebarsApplicationMixin:Tt}=foundry.applications.api;var q;const oe=class oe extends Tt(Lt){constructor(t={}){r.log("RollRequestsMenu.constructor",[t]);super(t);w(this,"_onClickOutside",t=>{if(r.log("_onClickOutside"),this.isLocked)return;const s=this.element;s&&(t.target.closest(".flash-rolls-menu")||s.contains(t.target)||t.target.closest("#flash-rolls-icon")||t.target.closest(".dialog, .app, .notification, .application")||this.close())});this.selectedActors=new Set,this.currentTab="pc",this.selectedRequestType=null,this.isLocked=!1,this.optionsExpanded=game.user.getFlag(K.ID,"menuOptionsExpanded")??!1,this.accordionStates=game.user.getFlag(K.ID,"menuAccordionStates")??{},this.isDragging=!1,this.isCustomPosition=!1,this.customPosition=ue.loadCustomPosition(),this._initializeFromSelectedTokens()}async _prepareContext(t){var y;r.log("_prepareContext");const s=v(),o=await super._prepareContext(t),i=game.actors.contents,l=[],a=[],n=game.scenes.active;for(const p of i){if(p.type!=="character"&&p.type!=="npc")continue;const L=(A=null)=>{const D=(A==null?void 0:A.actor)||p,C=Ve.getActorHPData(D);return{id:p.id,uuid:p.uuid,name:A?A.name:p.name,img:p.img,selected:this.selectedActors.has((A==null?void 0:A.id)||p.id),crlngnStats:Ve.getActorStats(D),hpPercent:C.hpPercent,hpColor:C.hpColor,tokenId:(A==null?void 0:A.id)||null,isToken:!!A,uniqueId:(A==null?void 0:A.id)||p.id}};if(Object.entries(p.ownership).some(([A,D])=>{const C=game.users.get(A);return C&&!C.isGM&&D>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})){if(Y.isBlocked(p))continue;const A=I.get((y=s.showOnlyPCsWithToken)==null?void 0:y.tag),D=Y.isFavorite(p),C=(n==null?void 0:n.tokens.filter(O=>O.actorId===p.id))||[];if(D)if(C.length>0)C.forEach(O=>{const k=L(O);k.isFavorite=!0,l.push(k)});else{const O=L();O.isFavorite=!0,l.push(O)}else if(A)C.length>0&&C.forEach(O=>{const k=L(O);l.push(k)});else if(C.length>0)C.forEach(O=>{const k=L(O);l.push(k)});else{const O=L();l.push(O)}}else{if(Y.isBlocked(p))continue;const A=Y.isFavorite(p),D=(n==null?void 0:n.tokens.filter(C=>C.actorId===p.id))||[];if(A)if(D.length>0)D.forEach(C=>{const O=L(C);O.isFavorite=!0,a.push(O)});else{const C=L();C.isFavorite=!0,a.push(C)}else D.length>0&&D.forEach(C=>{const O=L(C);a.push(O)})}}const c=I.get(s.rollRequestsEnabled.tag),u=I.get(s.skipRollDialog.tag),h=I.get(s.groupRollsMsgEnabled.tag);I.get(s.showOnlyPCsWithToken.tag);const f=this.currentTab==="pc"?l:a,m=f.length>0&&f.every(p=>this.selectedActors.has(p.uniqueId)),R=[];for(const[p,L]of Object.entries(K.ROLL_REQUEST_OPTIONS)){const _={id:p,name:game.i18n.localize(`FLASH_ROLLS.rollTypes.${L.name}`)||L.label,rollable:L.subList==null,hasSubList:!!L.subList,selected:this.selectedRequestType===p,expanded:this.accordionStates[p]??!1,subItems:[]};L.subList&&(_.subItems=Ue(p,this.selectedActors)),R.push(_)}const b=Ue(this.selectedRequestType,this.selectedActors),T={...o,actors:f,currentTab:this.currentTab,isPCTab:this.currentTab==="pc",isNPCTab:this.currentTab==="npc",selectedTab:this.currentTab,rollRequestsEnabled:c,skipRollDialog:u,groupRollsMsgEnabled:h,selectAllOn:m,hasSelectedActors:this.selectedActors.size>0,requestTypes:R,rollTypes:b,showNames:!0,actorsLocked:this.isLocked,optionsExpanded:this.optionsExpanded,isGM:game.user.isGM};return this._lastPreparedContext=T,T}async _renderFrame(t){const s=await super._renderFrame(t),o=this.customPosition||ue.loadCustomPosition();if(o!=null&&o.isCustom&&s)if(o.dockedRight){s.style.position="fixed",s.style.top=`${o.y}px`,s.style.left="",s.style.right="",s.style.bottom="",s.classList.add("docked-right");const i=document.querySelector("#chat-notifications");i&&i.insertBefore(s,i.firstChild),pe(),this.isCustomPosition=!0,this.customPosition=o}else{s.style.position="fixed",s.style.top=`${o.y}px`,s.style.left=`${o.x}px`,s.style.right="auto",s.style.bottom="auto",s.classList.add("custom-position");const i=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;o.x<i&&s.classList.add("left-edge"),document.body.appendChild(s);const l=!!document.querySelector("body.crlngn-tabs");H.addCSSVars("--flash-rolls-menu-offset",l?"0px":"16px"),this.isCustomPosition=!0,this.customPosition=o}else{const i=document.querySelector("#chat-notifications");i&&s&&i.insertBefore(s,i.firstChild)}return s}_onRender(t,s){if(r.log("_onRender"),super._onRender(t,s),r.log("_onRender - DragDrop handlers:",[this._dragDrop]),this._dragDrop&&this._dragDrop.length>0&&this._dragDrop.forEach((l,a)=>{r.log(`_onRender - DragDrop handler ${a}:`,[l,l.dropSelector,l.callbacks])}),this._attachListeners(),this.element.querySelectorAll(".actor-list").forEach((l,a)=>{l.removeEventListener("dragover",this._boundDragOver),l.removeEventListener("drop",this._boundDrop),l.removeEventListener("dragenter",this._boundDragEnter),l.removeEventListener("dragleave",this._boundDragLeave),this._boundDragOver=n=>{r.log("Manual dragover event triggered",[n]),this._onDragOver(n)},this._boundDrop=n=>{r.log("Manual drop event triggered",[n]),this._onDrop(n)},this._boundDragEnter=n=>{r.log("Manual dragenter event triggered",[n]),n.preventDefault()},this._boundDragLeave=n=>{r.log("Manual dragleave event triggered",[n]),Se.handleDragLeave(n)},l.addEventListener("dragover",this._boundDragOver),l.addEventListener("drop",this._boundDrop),l.addEventListener("dragenter",this._boundDragEnter),l.addEventListener("dragleave",this._boundDragLeave)}),pe(),I.updateColorScheme(),this.element.classList.add("theme-"+I.coreColorScheme),this.optionsExpanded){const l=this.element.querySelector(".options-toggle"),a=this.element.querySelector("li.options");this.element.querySelector(".options-toggle-btn"),l==null||l.classList.add("expanded"),a==null||a.classList.add("expanded")}setTimeout(()=>{document.addEventListener("click",this._onClickOutside,!0)},100),this._tokenControlHook=Hooks.on(F.CONTROL_TOKEN,this._onTokenControlChange.bind(this)),this._updateItemHook=Hooks.on(F.UPDATE_ITEM,this._onItemUpdate.bind(this)),this._createItemHook=Hooks.on(F.CREATE_ITEM,this._onItemUpdate.bind(this)),this._deleteItemHook=Hooks.on(F.DELETE_ITEM,this._onItemUpdate.bind(this));const i=this.element.querySelector(ue.DRAG_HANDLE_SELECTOR);i&&i.addEventListener("mousedown",l=>{ue.handleDragStart(l,this)}),yt.initializeActorDrag(this),this._updateRequestTypesVisibilityNoRender()}_onTokenControlChange(t,s){r.log("_onTokenControlChange"),this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{const o=new Set(this.selectedActors);this._initializeFromSelectedTokens();const i=new Set([...o,...this.selectedActors]);for(const l of i)this._updateActorSelectionUI(l);this._updateSelectAllState(),this._updateRequestTypesVisibilityNoRender(),this._tokenUpdateTimeout=null},100)))}_onItemUpdate(t,s,o,i){var h,f;if(!this.rendered||!(t.type==="equipment"||((h=s.system)==null?void 0:h.equipped)!==void 0||((f=s.system)==null?void 0:f.attunement)!==void 0))return;const a=t.parent;if(!a||a.documentName!=="Actor")return;const n=this.currentTab,c=Object.entries(a.ownership).some(([m,R])=>{const b=game.users.get(m);return b&&!b.isGM&&R>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER});(n==="pc"&&c||n==="npc"&&!c&&Je(a))&&(this._itemUpdateTimeout&&clearTimeout(this._itemUpdateTimeout),this._itemUpdateTimeout=setTimeout(()=>{this.render(),this._itemUpdateTimeout=null},500))}_attachListeners(){var a,n,c,u,h,f;r.log("_attachListeners");const t=this.element;(a=t.querySelector("#flash-rolls-toggle"))==null||a.addEventListener("change",this._onToggleRollRequests.bind(this)),(n=t.querySelector("#flash5e-skip-dialogs"))==null||n.addEventListener("change",this._onToggleSkipDialogs.bind(this)),(c=t.querySelector("#flash5e-group-rolls-msg"))==null||c.addEventListener("change",this._onToggleGroupRollsMsg.bind(this)),(u=t.querySelector("#flash5e-actors-all"))==null||u.addEventListener("change",this._onToggleSelectAll.bind(this)),(h=t.querySelector("#flash5e-actors-lock"))==null||h.addEventListener("click",this._onToggleLock.bind(this)),(f=t.querySelector(".options-toggle-btn"))==null||f.addEventListener("click",this._onToggleOptions.bind(this)),t.querySelectorAll(".actor-tab").forEach(m=>{m.addEventListener("click",this._onTabClick.bind(this)),m.addEventListener("dblclick",this._onTabDoubleClick.bind(this))}),t.querySelectorAll(".actor.drag-wrapper").forEach(m=>{m.addEventListener("click",this._onActorClick.bind(this))});const o=t.querySelector(".search-input");o&&o.addEventListener("input",this._onSearchInput.bind(this));const i=t.querySelector(".request-types-accordion");i&&(t.addEventListener("mouseenter",()=>{this.selectedActors.size>0&&i.classList.add("hover-visible")}),t.addEventListener("mouseleave",()=>{i.classList.remove("hover-visible")}));const l=t.querySelector(".request-types");l&&l.addEventListener("click",m=>{const R=m.target.closest(".request-type-header");if(R){const T=R.closest(".request-type-item");if(R.classList.contains("accordion-header")){this._onAccordionToggle(m);return}if(R.classList.contains("toggle")&&T&&T.classList.contains("rollable")){const y={...m,currentTarget:T};this._onRequestTypeClick(y);return}}const b=m.target.closest(".sub-item");if(b&&b.dataset.id){const T={...m,currentTarget:b};this._onRollTypeClick(T)}})}async _onToggleRollRequests(t){r.log("_onToggleRollRequests");const s=v(),o=t.target.checked;await I.set(s.rollRequestsEnabled.tag,o),ke.updateRollRequestsIcon(o)}async _onToggleSkipDialogs(t){r.log("_onToggleSkipDialogs");const s=v(),o=t.target.checked;await I.set(s.skipRollDialog.tag,o)}async _onToggleGroupRollsMsg(t){r.log("_onToggleGroupRollsMsg");const s=v(),o=t.target.checked;await I.set(s.groupRollsMsgEnabled.tag,o)}_onToggleSelectAll(t){r.log("_onToggleSelectAll");const s=t.target.checked;this._ignoreTokenControl=!0,((this._lastPreparedContext||{}).actors||[]).forEach(a=>{const n=a.uniqueId;s?(this.selectedActors.add(n),a.tokenId?ae(a.id,!0,a.tokenId):ae(a.id,!0)):(this.selectedActors.delete(n),a.tokenId?ae(a.id,!1,a.tokenId):ae(a.id,!1))}),setTimeout(()=>{this._ignoreTokenControl=!1},200),this.render(),this._updateRequestTypesVisibility();const l=this.element.querySelector(".request-types-accordion");l&&(this.selectedActors.size>0?l.classList.add("hover-visible"):l.classList.remove("hover-visible"))}_onToggleLock(t){r.log("_onToggleLock"),t.preventDefault(),this.isLocked=!this.isLocked;const s=t.currentTarget;s.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),s.classList.add(this.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open")}async _onToggleOptions(t){r.log("_onToggleOptions"),t.preventDefault(),t.stopPropagation(),this.optionsExpanded=!this.optionsExpanded,await game.user.setFlag(K.ID,"menuOptionsExpanded",this.optionsExpanded);const s=this.element.querySelector(".options-toggle");s&&s.classList.toggle("expanded",this.optionsExpanded);const o=this.element.querySelector("li.options");o&&o.classList.toggle("expanded",this.optionsExpanded)}_canDragDrop(t){const s=Se.canDrop(t);return r.log("RollRequestsMenu._canDragDrop",[t,s]),s}_onDragOver(t){r.log("RollRequestsMenu._onDragOver - DRAG OVER TRIGGERED!",[t]),Se.handleDragOver(t,this)}async _onDrop(t){r.log("RollRequestsMenu._onDrop - DROP TRIGGERED!",[t]),await Se.handleDrop(t,this)}_initializeFromSelectedTokens(){var s;r.log("_initializeFromSelectedTokens");const t=((s=canvas.tokens)==null?void 0:s.controlled)||[];this.selectedActors.clear();for(const o of t)if(o.actor){const i=o.id;if(this.selectedActors.add(i),this.selectedActors.size===1){const l=Fe(o.actor);this.currentTab=l?"pc":"npc"}}r.log("_initializeFromSelectedTokens",[this.selectedActors])}async _onTabClick(t){const s=t.currentTarget.dataset.tab;s!==this.currentTab&&(this.selectedRequestType=null,this.currentTab=s,await this.render())}async _onTabDoubleClick(t){var s;r.log("_onTabDoubleClick"),t.preventDefault(),t.stopPropagation(),this._ignoreTokenControl=!0,this.selectedActors.clear(),(s=canvas.tokens)==null||s.releaseAll(),this.selectedRequestType=null,setTimeout(()=>{this._ignoreTokenControl=!1},200),await this.render(),this._updateRequestTypesVisibility()}_onActorClick(t){if(t.target.closest(".actor-select"))return;const s=t.currentTarget,o=s.dataset.id,i=s.dataset.actorId,l=s.dataset.tokenId;this._toggleActorSelection(o,i,l)}_toggleActorSelection(t,s,o){r.log("_toggleActorSelection"),this._ignoreTokenControl=!0,this.selectedActors.has(t)?(this.selectedActors.delete(t),o?ae(s,!1,o):ae(s,!1)):(this.selectedActors.add(t),o?ae(s,!0,o):ae(s,!0)),setTimeout(()=>{this._ignoreTokenControl=!1},100),this._updateActorSelectionUI(t),this._updateSelectAllState(),this._updateRequestTypesVisibilityNoRender();const i=this.element.querySelector(".request-types-accordion");i&&(this.selectedActors.size>0?i.classList.add("hover-visible"):i.classList.remove("hover-visible"))}_updateActorSelectionUI(t){const s=this.element.querySelector(`.actor.drag-wrapper[data-id="${t}"]`);if(!s)return;const o=s.closest(".actor");if(!o)return;const i=o.querySelector(".actor-select"),l=this.selectedActors.has(t);i&&(i.checked=l),s.classList.toggle("selected",l),s.dataset.selected=l.toString()}_updateRequestTypesVisibility(){r.log("_updateRequestTypesVisibility"),this.render()}_updateRequestTypesVisibilityNoRender(){r.log("_updateRequestTypesVisibilityNoRender");const t=this.selectedActors.size>0,s=this.element.querySelector(".request-types");if(s){s.classList.toggle("disabled",!t),s.querySelectorAll(".request-type-item").forEach(a=>{a.classList.toggle("disabled",!t)});const i=Array.from(this.selectedActors).some(a=>{const n=Ee(a);return(n==null?void 0:n.type)==="character"}),l=s.querySelector('[data-id="HIT_DIE"]');l&&(l.style.display=i?"":"none")}}_updateSelectAllState(){r.log("_updateSelectAllState");const t=this.element.querySelector("#flash5e-actors-all"),s=this.currentTab==="pc"?"pc":"npc",o=this.element.querySelectorAll(`.${s}-actors .actor-item input[type="checkbox"]`),i=Array.from(o).filter(l=>l.checked).length;t.checked=i>0&&i===o.length,t.indeterminate=i>0&&i<o.length}_onSearchInput(t){r.log("_onSearchInput");const s=t.target.value.toLowerCase().trim(),o=this.element.querySelector(".request-types");if(!o)return;o.querySelectorAll(".request-type-item").forEach(l=>{var u;const a=((u=l.querySelector(".request-type-name"))==null?void 0:u.textContent.toLowerCase())||"",n=l.querySelectorAll(".sub-item");let c=!1;if(n.length>0){n.forEach(m=>{var T;const b=(((T=m.querySelector(".sub-item-name"))==null?void 0:T.textContent.toLowerCase())||"").includes(s);m.classList.toggle("hidden",!b),b&&(c=!0)});const h=a.includes(s),f=s===""||h||c;if(l.classList.toggle("hidden",!f),s&&c){const m=l.querySelector(".roll-types-nested"),R=l.querySelector(".accordion-toggle");m&&R&&(m.style.display="block",R.classList.add("expanded"))}}else{const h=s===""||a.includes(s);l.classList.toggle("hidden",!h)}})}async _onAccordionToggle(t){t.stopPropagation();const o=t.target.closest(".request-type-header").closest(".request-type-item"),i=o.dataset.id,l=o.querySelector(".accordion-toggle"),a=o.querySelector(".roll-types-nested");if(!a)return;const n=l.classList.contains("expanded");l.classList.toggle("expanded",!n),a.style.display=n?"none":"block",this.accordionStates[i]=!n,await game.user.setFlag(K.ID,"menuAccordionStates",this.accordionStates)}async _onRequestTypeClick(t){const o=t.currentTarget.dataset.id,i=K.ROLL_REQUEST_OPTIONS[o];if(!i){r.error("Unknown request type:",[o]);return}this.selectedRequestType===o?this.selectedRequestType=null:this.selectedRequestType=o,i.subList?await this.render():this.selectedRequestType&&this._triggerRoll(o,null)}_onRollTypeClick(t){r.log("_onRollTypeClick");const s=t.currentTarget.dataset.id,i=t.currentTarget.dataset.parent||this.selectedRequestType;this._triggerRoll(i,s)}async _getRollConfiguration(t,s,o,i,l){const a=v(),n=I.get(a.rollRequestsEnabled.tag);if(!i&&s!==g.CUSTOM){let c;[g.SKILL,g.TOOL].includes(s)?c=He:s===g.HIT_DIE?c=Ne:c=J;const u=await c.initConfiguration(t,s,o,{skipRollDialog:i,sendRequest:n||!1});return r.log("_getRollConfiguration",[u]),u}else{const c={rolls:[{parts:[],data:{},options:{}}],advantage:!1,disadvantage:!1,rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:!0,sendRequest:n&&l.length>0};return s===g.DEATH_SAVE&&(c.target=10),c}}async _orchestrateRollsForActors(t,s,o,i,l,a){const n=v(),c=[],u=[],h=[];let f=foundry.utils.randomID();r.log("_orchestrateRollsForActors",[t,s,o]);const m=[],R=[];if(t.sendRequest){for(const{actor:p,owner:L}of s)L.active?h.push({actor:p,owner:L}):(I.get(n.showOfflineNotifications.tag)&&B.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:L.name})),u.push(p));R.push(...h.map(({actor:p})=>p))}else o.push(...s.map(({actor:p})=>p));R.push(...u,...o);const b=R.map(p=>p.id);m.push(...a.filter(p=>p&&p.actor&&b.includes(p.actor.id)));const T=I.get(n.groupRollsMsgEnabled.tag);if(T&&R.length>1&&(r.log("_orchestrateRollsForActors - generated new groupRollId",[f]),await z.createGroupRollMessage(m,i,l,t,f),await Te(100)),i===g.HIT_DIE){r.log("_orchestrateRollsForActors - hit die roll detected, checking all actors for refill");const p=[];if(h.forEach(({actor:_})=>p.push(_)),u.forEach(_=>p.push(_)),o.forEach(_=>p.push(_)),r.log("_orchestrateRollsForActors - calling _handleHitDieRefill for",p.length,"actors"),!await this._handleHitDieRefill(p)){r.log("_orchestrateRollsForActors - refill cancelled, aborting all rolls");return}r.log("_orchestrateRollsForActors - refill check complete, proceeding with rolls")}for(const{actor:p,owner:L}of h){const _=T&&R.length>1?f:null;let A=l;if(i===g.HIT_DIE&&(A=p.system.attributes.hd.largestAvailable,!A)){r.warn(`No hit dice available for ${p.name} after refill attempt`);continue}await this._sendRollRequestToPlayer(p,L,i,A,t,!0,_),c.push({actor:p,owner:L}),await Te(250)}c.length>0&&this._showConsolidatedNotification(c,i,l);let y=[];if(y=y.concat(u),y=y.concat(o),y.length>0){t.skipRollDialog=!0,t.groupRollId=T&&R.length>1?f:null;const p=y.map(_=>_.id),L=a.filter(_=>_&&_.actor&&p.includes(_.actor.id));await this._handleGMRollsWithTokens(L,i,l,t)}}async _handleHitDieRefill(t){const s=Array.isArray(t)?t:[t];r.log("_handleHitDieRefill - processing actors:",s.map(a=>a.name));const o=s.filter(a=>{const n=a.system.attributes.hd,c=n.value===0;return r.log("_handleHitDieRefill - checking actor",[a.name,"value:",n.value,"needs refill:",c]),c});if(r.log("_handleHitDieRefill - actors needing refill:",o.length,[o]),o.length===0)return r.log("_handleHitDieRefill - no refill needed",[]),!0;const i=o.map(a=>a.name).join(", ");r.log("_handleHitDieRefill - showing dialog for actors:",i);const l=await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessage",{actors:i})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}});if(r.log("_handleHitDieRefill - dialog result:",l),l){r.log("_handleHitDieRefill - proceeding with refill for actors:",i);for(const a of o)try{r.log("About to call handleHitDieRecovery for",[a.name,"isToken:",a.isToken]);const n=await Q.handleHitDieRecovery(a);if(r.log("handleHitDieRecovery completed",[n]),a.isToken&&a._actor){r.log("Also updating base actor for token",[a._actor.name]);try{await Q.handleHitDieRecovery(a._actor),r.log("Base actor updated successfully")}catch(c){r.error("Error updating base actor:",[c])}}}catch(n){r.error("Error calling handleHitDieRecovery:",[n])}return B.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:i})||`Hit dice refilled for ${i}`),r.log("_handleHitDieRefill - refill completed, returning true"),!0}return r.log("_handleHitDieRefill - user cancelled, returning false"),!1}async _triggerRoll(t,s){var R,b,T;r.log("_triggerRoll",[t,s]);const o=v(),i=Array.from(this.selectedActors),l=I.get(o.skipRollDialog.tag);let a=i.map(y=>{const p=Ee(y);if(!p)return null;let L=null;return game.actors.get(y)?L=null:L=y,{actor:p,uniqueId:y,tokenId:L}}).filter(y=>y),n=a.map(y=>y.actor);const c=K.ROLL_REQUEST_OPTIONS[t],u=(R=(c==null?void 0:c.name)||t)==null?void 0:R.toLowerCase();switch(u){case g.CUSTOM:if(s=await ze.handleCustomRoll(),!s)return;break;case g.INITIATIVE:case g.INITIATIVE_DIALOG:if(await Xe()){r.log("_triggerRoll - initiative",[i]);const p=[],L=[];for(const k of i){const G=Ee(k);if(!G)continue;let N=null;if(!game.actors.get(k))N=k,L.push(G.name);else{if(N=((T=(b=G.getActiveTokens())==null?void 0:b[0])==null?void 0:T.id)||null,!N){p.push(G.name);continue}L.push(G.name),game.combat.combatants.find(te=>te.tokenId===N)||await game.combat.createEmbeddedDocuments("Combatant",[{actorId:G.id,tokenId:N}])}}if(L.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noTokensForInitiative")||"Cannot roll initiative: None of the selected actors have tokens on the scene.");return}p.length>0&&ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.actorsSkippedInitiative",{actors:p.join(", ")})||`Initiative skipped for actors without tokens: ${p.join(", ")}`);const _=a.filter(k=>{var N;return k.tokenId?!0:!!((N=k.actor.getActiveTokens())==null?void 0:N[0])});a.length=0,a.push(..._),n=_.map(k=>k.actor);const A=[...new Set(n.map(k=>k.id))],D=await Ze(A,game);if(!D.length)return;const C=a.filter(k=>k&&k.actor&&D.includes(k.actor.id));n=D.map(k=>game.actors.get(k)).filter(k=>k),a.length=0,a.push(...C),I.get(o.initiateCombatOnRequest.tag)&&game.combat.startCombat()}break;case g.DEATH_SAVE:n=await gt(n);break;case g.HIT_DIE:if(n=n.filter(p=>p.type==="character"),a=a.filter(p=>p.actor.type==="character"),n.length===0){B.notify("warn",game.i18n.localize("FLASH_ROLLS.notifications.noCharactersForHitDie")||"Hit dice can only be rolled for player characters, not NPCs.");return}break}if(!n.length){B.notify("warn","No valid actors selected");return}const{pcActors:h,npcActors:f}=ft(n),m=await ze.getRollConfiguration(n,u,s,l,h);r.log("_triggerRoll config",[m]),m&&(await this._orchestrateRollsForActors(m,h,f,u,s,a),this.isLocked||setTimeout(()=>this.close(),500))}async _sendRollRequestToPlayer(t,s,o,i,l,a=!1,n=null){var m;r.log("_sendRollRequestToPlayer #A",[o,i]);const c=v();let u=o==null?void 0:o.toLowerCase();if(u===g.ABILITY_CHECK?u=g.ABILITY:u===g.SAVING_THROW?u=g.SAVE:u===g.INITIATIVE_DIALOG&&(u=g.INITIATIVE),u===g.HIT_DIE&&(i=t.system.attributes.hd.largestAvailable,!i)){r.warn(`No hit dice available for ${t.name}.`);return}const h={...l};delete h.subject,delete h.workflow,delete h.item,delete h.activity;const f={type:"rollRequest",groupRollId:n||foundry.utils.randomID(),actorId:t.isToken?t.token.id:t.id,isTokenActor:t.isToken,baseActorId:t.isToken?(m=t._actor)==null?void 0:m.id:t.id,rollType:u,rollKey:i,activityId:null,rollProcessConfig:{...h,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(R=>R.id),preserveTargets:I.get(c.useGMTargetTokens.tag)};r.log("_sendRollRequestToPlayer - prepareMidiQOLSettings",[]),ee.execForUser("handleRollRequest",s.id,f),a||B.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:s.name,actor:t.name}))}_showConsolidatedNotification(t,s,o){var n,c,u,h,f;r.log("_showConsolidatedNotification");const i={};for(const{actor:m,owner:R}of t)i[R.id]||(i[R.id]={player:R,actors:[]}),i[R.id].actors.push(m);for(const[m,R]of Object.entries(K.ROLL_REQUEST_OPTIONS))if(R.name===s)break;const l=s;let a=game.i18n.localize(`FLASH_ROLLS.rollTypes.${l}`)||l;if(o){const m=l.toLowerCase();if(m===g.SKILL)a=`${a} (${((n=CONFIG.DND5E.skills[o])==null?void 0:n.label)||o})`;else if(m===g.SAVING_THROW)a=`${a} (${((c=CONFIG.DND5E.abilities[o])==null?void 0:c.label)||o})`;else if(m===g.ABILITY_CHECK)a=`${a} (${((u=CONFIG.DND5E.abilities[o])==null?void 0:u.label)||o})`;else if(m===g.TOOL){const R=(f=(h=CONFIG.DND5E.enrichmentLookup)==null?void 0:h.tools)==null?void 0:f[o];if(R!=null&&R.id){const b=dnd5e.documents.Trait.getBaseItem(R.id,{indexOnly:!0});a=`${a} (${(b==null?void 0:b.name)||o})`}else a=`${a} (${o})`}else m===g.CUSTOM&&(a=`${a}: ${o}`)}B.notifyRollRequestsSent(i,a)}async _handleGMRolls(t,s,o,i){r.log("_handleGMRolls",[t,s,o,i]);for(const l of t)await this._initiateRoll(l,s,o,i),await Te(100)}async _handleGMRollsWithTokens(t,s,o,i){var l,a;r.log("_handleGMRollsWithTokens",[t,s,o,i]);for(const n of t){if(n.tokenId){const c=((l=canvas.tokens)==null?void 0:l.get(n.tokenId))||((a=game.scenes.active)==null?void 0:a.tokens.get(n.tokenId));c?await this._initiateRollForToken(n.actor,c,s,o,i):await this._initiateRoll(n.actor,s,o,i)}else await this._initiateRoll(n.actor,s,o,i);await Te(100)}}async _initiateRollForToken(t,s,o,i,l){r.log("_initiateRollForToken",[t.name,s.name,o,i,l]);const a=s.controlled;a||s.control({releaseOthers:!1});try{await this._initiateRoll(t,o,i,l)}finally{a||s.release()}}async _initiateRoll(t,s,o,i){var l,a,n,c;r.log("_initiateRoll",[t,s,o,i]);try{const u=s.toLowerCase();let h=o;if(u===g.HIT_DIE){const p=t.system.attributes.hd;if(p.value>0&&(h=p.largestAvailable),!h){r.warn("_initiateRoll - No hit dice available after orchestration refill",[t.name]),B.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.noHitDice",{actor:t.name})||`No hit dice available for ${t.name}`);return}}const f=((n=(a=(l=i.rolls)==null?void 0:l[0])==null?void 0:a.data)==null?void 0:n.situational)||"",m={rollKey:h,groupRollId:i.groupRollId,config:{...i,situational:f,rollMode:i.rollMode||game.settings.get("core","rollMode"),advantage:i.advantage||!1,disadvantage:i.disadvantage||!1,target:i.target}},R={configure:!i.fastForward&&!i.skipRollDialog,isRollRequest:!0},b={rollMode:i.rollMode||game.settings.get("core","rollMode"),create:i.chatMessage!==!1,isRollRequest:!0},T=((c=i.rolls)==null?void 0:c[0])||{},y=Q[u];y?await y(t,m,T,R,b):B.notify("warn",`Unknown roll type: ${s}`)}catch(u){r.error("executeActorRoll",[u]),B.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:t.name}))}}async _onClose(t){if(r.log("_onClose",[t]),!!this.element){if(this.isCustomPosition&&this.element.parentElement===document.body){const s=document.querySelector("#chat-notifications");s&&s.insertBefore(this.element,s.firstChild),this.element.style.position="",this.element.style.inset="",this.element.style.top="",this.element.style.left="",this.element.style.right="",this.element.style.bottom="",this.element.classList.remove("custom-position")}await super._onClose(t),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),this._tokenControlHook&&(Hooks.off(F.CONTROL_TOKEN,this._tokenControlHook),this._tokenControlHook=null),this._updateItemHook&&(Hooks.off(F.UPDATE_ITEM,this._updateItemHook),this._updateItemHook=null),this._createItemHook&&(Hooks.off(F.CREATE_ITEM,this._createItemHook),this._createItemHook=null),this._deleteItemHook&&(Hooks.off(F.DELETE_ITEM,this._deleteItemHook),this._deleteItemHook=null),this._tokenUpdateTimeout&&(clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=null),this._actorUpdateTimeout&&(clearTimeout(this._actorUpdateTimeout),this._actorUpdateTimeout=null),this._itemUpdateTimeout&&(clearTimeout(this._itemUpdateTimeout),this._itemUpdateTimeout=null),P(oe,q)===this&&ce(oe,q,null)}}setPosition(t={}){return r.log("setPosition"),this}async _showCustomRollDialog(){return r.log("_showCustomRollDialog"),Ie.prompt({formula:"",readonly:!1})}static toggle(){r.log("RollRequestsMenu.toggle"),document.querySelectorAll("#flash-rolls-menu").forEach(s=>{r.log("Removing orphaned menu element"),s.remove()}),P(this,q)?P(this,q).rendered?P(this,q).close():(P(this,q)._initializeFromSelectedTokens(),P(this,q).render(!0)):(ce(this,q,new oe),P(this,q).render(!0))}static refreshIfOpen(){P(this,q)&&P(this,q).rendered&&(r.log("RollRequestsMenu.refreshIfOpen - refreshing menu"),P(this,q).render(),I.updateColorScheme(),P(this,q).element.classList.add("theme-"+I.coreColorScheme))}static showOnLoadIfEnabled(){r.log("RollRequestsMenu.showOnLoadIfEnabled");const t=v();I.get(t.showMenuOnLoad.tag)&&game.user.isGM&&(document.querySelectorAll("#flash-rolls-menu").forEach(i=>{r.log("Removing orphaned menu element"),i.remove()}),P(this,q)?P(this,q).rendered||(P(this,q)._initializeFromSelectedTokens(),P(this,q).render(!0),P(this,q).isLocked=!0):(ce(this,q,new oe),P(this,q).render(!0),P(this,q).isLocked=!0))}};q=new WeakMap,re(oe,q,null),w(oe,"DEFAULT_OPTIONS",{id:"flash-rolls-menu",classes:["flash-rolls-menu"],tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:{},dragDrop:[{dropSelector:".actor-list"}]}),w(oe,"PARTS",{main:{template:`modules/${K.ID}/templates/requests-menus.hbs`}});let Z=oe;class ke{static addSidebarControls(e,t){if(r.log("addSidebarControls",[e,t]),!game.user.isGM||!e||e.id!=="sidebar")return;const s=document.querySelector("#roll-privacy");if(r.log("addSidebarControls",[s]),!s||s.querySelector(".flash-rolls-icon"))return;const o=v(),i=I.get(o.rollRequestsEnabled.tag),l=document.createElement("button");l.id="flash-rolls-icon",l.setAttribute("data-tooltip-direction","RIGHT"),l.className=`ui-control icon chat-control-icon flash-rolls-icon${i?" active":""}`,l.title=game.i18n.localize("FLASH_ROLLS.ui.menus.rollRequestsTitle"),l.innerHTML=`<i class="fas fa-bolt${i?"":"-slash"}"></i>`;const a=s.firstChild;a?a.parentNode.insertBefore(l,a):s.insertBefore(l,s.firstChild),r.log("addSidebarControls",[a,l]),l.addEventListener("click",n=>{n.stopPropagation(),n.preventDefault(),Z.toggle()})}static updateRollRequestsIcon(e){const t=document.querySelector("#flash-rolls-icon i");t&&(t.className=`fas fa-bolt${e?"":"-slash"}`)}}class St{static initialize(){r.log("ActorDirectoryIconUtil.initialize"),Hooks.on(F.RENDER_ACTOR_DIRECTORY,this.onRenderActorDirectory.bind(this)),Hooks.on(F.UPDATE_ACTOR,this.onUpdateActor.bind(this)),this.updateExistingDirectory()}static updateExistingDirectory(){const e=ui.actors;e&&e.rendered&&e.element?(r.log("ActorDirectoryIconUtil.updateExistingDirectory - Found rendered directory, adding icons"),this.onRenderActorDirectory(e,e.element)):r.log("ActorDirectoryIconUtil.updateExistingDirectory - No rendered directory found")}static onRenderActorDirectory(e,t){r.log("ActorDirectoryIconUtil.onRenderActorDirectory",[e,t]),t.querySelectorAll(".directory-item.actor").forEach(o=>{const i=o.dataset.entryId||o.dataset.documentId;i&&this.updateActorIcon(o,i)})}static onUpdateActor(e,t){var o;const s=(o=t.flags)==null?void 0:o["flash-rolls-5e"];s&&(r.log("ActorDirectoryIconUtil.onUpdateActor - Flash Rolls flags changed",[e.name,s]),this.refreshActorIcon(e.id))}static updateActorIcon(e,t){const s=e.querySelector("span.fas.fa-bolt, span.fas.fa-bolt-slash");s&&s.remove();const o=game.actors.get(t);if(!o)return;const i=Y.isFavorite(o),l=Y.isBlocked(o);if(!i&&!l)return;const a=document.createElement("span");l?(a.className="fas fa-bolt-slash",a.title="Blocked from Flash Rolls menu"):i&&(a.className="fas fa-bolt",a.title="Added to Flash Rolls menu"),e.appendChild(a)}static refreshActorIcon(e){const t=document.querySelector(`.directory-item.actor[data-entry-id="${e}"], .directory-item.actor[data-document-id="${e}"]`);t&&this.updateActorIcon(t,e)}static refreshAllIcons(){r.log("ActorDirectoryIconUtil.refreshAllIcons"),document.querySelectorAll(".directory-item.actor").forEach(t=>{const s=t.dataset.entryId||t.dataset.documentId;s&&this.updateActorIcon(t,s)})}}const ie=class ie{static initialize(){Hooks.once(F.INIT,this._onInit.bind(this)),Hooks.once(F.READY,this._onReady.bind(this)),Hooks.once(F.GET_ACTOR_CONTEXT_OPTIONS,(e,t)=>{r.log("getActorContextOptions hook",[e,t]),game.user.isGM&&(t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.unblockFromMenu"),icon:'<i class="fas fa-bolt"></i>',callback:s=>{const o=s.dataset.entryId;return o&&Y.toggleBlocked(o,!1),o},condition:s=>{var l;const o=(l=s==null?void 0:s.dataset)==null?void 0:l.entryId;return Y.isBlocked(o)}}),t.push({name:game.i18n.localize("FLASH_ROLLS.contextMenu.blockFromMenu"),icon:'<i class="fas fa-bolt-slash"></i>',callback:s=>{const o=s.dataset.entryId;return o&&Y.toggleBlocked(o,!0),o},condition:s=>{var l;const o=(l=s==null?void 0:s.dataset)==null?void 0:l.entryId;return!Y.isBlocked(o)}}))})}static _onInit(){v(),document.body.classList.add("flash5e"),I.registerSettings(),ge.initialize(),this._registerHooks()}static _onReady(){var e;I.registerSettingsMenu(),St.initialize(),ke.addSidebarControls(ui.sidebar,(e=ui.sidebar)==null?void 0:e.element),de.isModuleActive("midi-qol")?(r.log("HooksUtil.initialize",["midi-qol is active. Awaiting for it to be ready..."]),Hooks.once(at.READY,this._initModule.bind(this))):(r.log("HooksUtil.initialize",["midi-qol is NOT active. Starting..."]),this._initModule())}static async _initModule(){const e=v();I.get(e.debugMode.tag)&&(CONFIG.debug.hooks=!0),await z.initialize(),game.user.isGM?(et.initialize(),this._registerGMHooks(),Z.showOnLoadIfEnabled()):(ge.getDiceConfig(),this._registerPlayerHooks()),xe(qe())}static _registerHooks(){this._registerHook(F.RENDER_SIDEBAR,this._onRenderSidebar.bind(this)),this._registerHook(F.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessage.bind(this)),this._registerHook(F.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageFlavor.bind(this)),this._registerHook(F.RENDER_CHAT_MESSAGE,this._onRenderChatMessageHTML.bind(this)),this._registerHook(F.CHANGE_SIDEBAR_TAB,this._onSidebarUpdate.bind(this)),this._registerHook(F.COLLAPSE_SIDE_BAR,this._onSidebarUpdate.bind(this)),this._registerHook(F.REFRESH_MEASURED_TEMPLATE,this.onRefreshTemplate.bind(this)),this._registerHook(U.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this)),this._registerHook(U.RENDER_SKILL_TOOL_ROLL_DIALOG,this._onRenderSkillToolDialog.bind(this)),this._registerHook(U.PRE_USE_ACTIVITY,this._onPreUseActivity.bind(this)),this._registerHook(U.POST_USE_ACTIVITY,this._onPostUseActivity.bind(this)),this._registerHook(U.PRE_ROLL_HIT_DIE_V2,this._onPreRollHitDieV2.bind(this)),this._registerHook(U.POST_ROLL_CONFIG,this._onPostRollConfig.bind(this))}static _registerGMHooks(){this._registerHook(F.USER_CONNECTED,this._onUserConnected.bind(this)),this._registerHook(F.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageGM.bind(this)),this._registerHook(U.PRE_ROLL_V2,this._onPreRoll.bind(this)),this._registerHook(F.CREATE_TOKEN,this._onTokenChange.bind(this)),this._registerHook(F.DELETE_TOKEN,this._onTokenChange.bind(this)),this._registerHook(F.UPDATE_SETTING,this._onSettingUpdate.bind(this)),this._registerHook(F.UPDATE_SCENE,this._onSceneUpdate.bind(this)),this._registerHook(F.UPDATE_ACTOR,this._onActorUpdate.bind(this)),game.users.forEach(e=>{this._onUserConnected(e)})}static _registerPlayerHooks(){this._registerHook(U.PRE_ROLL_INITIATIVE_DIALOG,this._onPreRollInitiativeDialog.bind(this)),this._registerHook(U.PRE_ROLL_ATTACK_V2,this._onPreRollAttackV2.bind(this)),this._registerHook(U.PRE_ROLL_DAMAGE_V2,this._onPreRollDamageV2.bind(this)),Hooks.on(U.PRE_ROLL_ABILITY_CHECK,(e,t,s)=>{r.log("_onPreRollAbilityCheckV2",[e,t,s]),e.isRollRequest&&(t.configure=!0)})}static _onSidebarUpdate(e){r.log("_onSidebarUpdate",[e]),xe(qe())}static _onPostRollConfig(e,t,s,o){t._showRequestedBy&&e.length>0&&(o.data=o.data||{},o.data._showRequestedBy=!0,o.data._requestedBy=t._requestedBy)}static _onPreCreateChatMessage(e,t,s,o){var i,l,a,n,c,u,h,f,m,R;if(t._showRequestedBy&&((i=t.rolls)==null?void 0:i.length)>0){const b=t._requestedBy||"GM",T=game.i18n.format("FLASH_ROLLS.chat.requestedBy",{gm:b}),y=t.flavor||"";t.flavor=y?`${y} ${T}`:T}if((a=(l=t.flags)==null?void 0:l[S])!=null&&a.groupRollId&&r.log("_onPreCreateChatMessage - Found groupRollId in data flags",[t]),((n=t.rolls)==null?void 0:n.length)>0||(u=(c=t.flags)==null?void 0:c.core)!=null&&u.initiativeRoll){const b=t.speaker,T=b==null?void 0:b.actor;if(T){let y=game.actors.get(T);if(!y&&(b!=null&&b.token)){const p=canvas.tokens.get(b.token);p!=null&&p.actor&&(y=p.actor,r.log("_onPreCreateChatMessage - Using token actor from speaker",[y.name,y.id]))}if(!y){r.log("_onPreCreateChatMessage - No actor found",[T,b]);return}if(game.user.isGM){const p=y.isToken?(h=y.actor)==null?void 0:h.id:y.id,L=[T,p].filter(_=>_);for(const[_,A]of z.pendingRolls.entries()){const D=A.actorEntries||(A.actors?A.actors.map(C=>({actorId:C})):[]);if(L.some(C=>D.some(O=>O.actorId===C))){t.flags=t.flags||{},t.flags[S]=t.flags[S]||{},t.flags[S].groupRollId=_,r.log("_onPreCreateChatMessage - Added groupRollId flag (GM)",[_,T]);break}}}else{let p=y.getFlag(S,"tempGroupRollId");if(!p&&y.isToken){const _=game.actors.get((f=y.actor)==null?void 0:f.id);_&&(p=_.getFlag(S,"tempGroupRollId"),r.log("_onPreCreateChatMessage - Checking base actor for tempGroupRollId",[_.id,p]))}if(p&&(y.unsetFlag(S,"tempGroupRollId"),y.isToken)){const _=game.actors.get((m=y.actor)==null?void 0:m.id);_&&_.unsetFlag(S,"tempGroupRollId")}let L=y.getFlag(S,"tempInitiativeConfig");if(!L&&y.isToken){const _=game.actors.get((R=y.actor)==null?void 0:R.id);_&&(L=_.getFlag(S,"tempInitiativeConfig"))}(L!=null&&L.groupRollId||p)&&(t.flags=t.flags||{},t.flags[S]=t.flags[S]||{},t.flags[S].groupRollId=p||(L==null?void 0:L.groupRollId)||"")}}}}static _onPreCreateChatMessageFlavor(e,t,s,o){var i,l;if(((i=t.rolls)==null?void 0:i.length)>0&&t.rolls[0])try{const a=t.rolls[0];(l=a.options)!=null&&l._customFlavor&&(t.flavor=a.options._customFlavor)}catch(a){r.error("_onPreCreateChatMessageFlavor",[a])}}static _onRenderRollConfigDialog(e,t,s){var i,l,a,n,c;if(console.trace("Flash Rolls 5e - _onRenderRollConfigDialog"),e._flashRollsApplied)return;if(r.log("_onRenderRollConfigDialog #0",[e,s]),((l=(i=e.config)==null?void 0:i.hookNames)==null?void 0:l.includes("initiativeDialog"))||((n=(a=e.element)==null?void 0:a.id)==null?void 0:n.includes("initiative"))){const u=(c=e.config)==null?void 0:c.subject;if(!u)return;if(u.getFlag(S,"tempInitiativeConfig")){e._flashRollsApplied=!0;const f=t.querySelector('input[name*="situational"]');setTimeout(()=>{f.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},50)}return}else{const u=t.querySelectorAll('input[name*="situational"]');r.log("_onRenderRollConfigDialog - found situational inputs",[u.length]),u.forEach((h,f)=>{var m,R,b,T,y,p,L;r.log("_onRenderRollConfigDialog - processing input",[f,h.name,h.value]),!h.value&&((T=(b=(R=(m=e.config)==null?void 0:m.rolls)==null?void 0:R[0])==null?void 0:b.data)!=null&&T.situational)&&(h.value=e.config.rolls[0].data.situational),r.log("_onRenderRollConfigDialog #1",[h.value,e.config.rolls]),h.value&&(e._flashRollsApplied=!0,(L=(p=(y=e.config)==null?void 0:y.rolls)==null?void 0:p[0])!=null&&L.data&&delete e.config.rolls[0].data.situational,setTimeout(()=>{h.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1})),r.log("_onRenderRollConfigDialog #2 - dispatched change event",[])},150))})}}static _onPreCreateChatMessageGM(e,t,s,o){}static _onRenderChatMessageHTML(e,t,s){z.interceptRollMessage(e,t,s),this._addSelectTargetsButton(e,t)}static _addSelectTargetsButton(e,t){var o,i,l;if(!game.user.isGM||(r.log("_addSelectTargetsButton #0",[e,t,t.querySelector(".message-content")]),((l=(i=(o=e.flags)==null?void 0:o.dnd5e)==null?void 0:i.roll)==null?void 0:l.type)!=="damage"||t.querySelector(".select-targeted")))return;const s=document.createElement("button");s.className="select-targeted",s.type="button",s.setAttribute("data-tooltip-direction","LEFT"),s.setAttribute("data-tooltip","Select Targeted"),s.innerHTML='<i class="fas fa-crosshairs"></i>',s.addEventListener("click",a=>{a.preventDefault(),this._selectTargetedTokens(a)}),t.querySelector(".message-content").appendChild(s),e.update({content:t})}static _selectTargetedTokens(e){const t=e.currentTarget.closest(".chat-message"),s=t.querySelectorAll("[data-target-uuid]");if(s.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noTargetedTokens"));return}r.log("_selectTargetedTokens",[t,s,canvas.tokens.placeables,game.scenes.active]);for(let o=0;o<s.length;o++){const l=s[o].dataset.targetUuid.split("Actor.")[1],a=canvas.tokens.placeables.find(n=>n.document.actorId===l);a==null||a.control({releaseOthers:o===0})}}static _onUserConnected(e){e.active&&e.id!==game.user.id&&ge.requestDiceConfigFromUser(e.id)}static _onTokenChange(e,t,s){this._tokenChangeTimeout&&clearTimeout(this._tokenChangeTimeout),this._tokenChangeTimeout=setTimeout(()=>{r.log("HooksUtil._onTokenChange - Re-rendering roll requests menu due to token create/delete"),Z.refreshIfOpen(),this._tokenChangeTimeout=null},200)}static _onSettingUpdate(e,t,s,o){const i=v(),l={ID:"flash-rolls-5e"};e.key===`${l.ID}.${i.showOnlyPCsWithToken.tag}`?(r.log("HooksUtil._onSettingUpdate - Re-rendering roll requests menu due to setting change",[e.key]),Z.refreshIfOpen()):e.key==="core.uiConfig"&&(I.updateColorScheme(),Z.refreshIfOpen())}static _onSceneUpdate(e,t,s,o){t.active===!0&&(r.log("HooksUtil._onSceneUpdate - Re-rendering roll requests menu due to active scene change"),Z.refreshIfOpen())}static _onActorUpdate(e,t,s,o){var a,n,c,u,h,f,m,R,b,T,y,p;r.log("HooksUtil._onActorUpdate",[e,t]);const i=t["==ownership"]!==void 0;!((n=(a=t.system)==null?void 0:a.attributes)!=null&&n.hp||(u=(c=t.system)==null?void 0:c.attributes)!=null&&u.ac||(m=(f=(h=t.system)==null?void 0:h.attributes)==null?void 0:f.spell)!=null&&m.dc||(b=(R=t.system)==null?void 0:R.skills)!=null&&b.prc||(T=t.system)!=null&&T.abilities||(p=(y=t.system)==null?void 0:y.attributes)!=null&&p.prof)&&!i||(this._actorUpdateTimeout&&clearTimeout(this._actorUpdateTimeout),this._actorUpdateTimeout=setTimeout(()=>{r.log("HooksUtil._onActorUpdate - Re-rendering roll requests menu due to actor update",[e,t]),Z.refreshIfOpen(),this._actorUpdateTimeout=null},250))}static _onRenderApplicationV2(e,t,s){r.log("_onRenderApplicationV2",[e,t,s])}static _onRenderSidebar(e,t,s){r.log("_onRenderSidebar",[e,t]),game.ready&&ke.addSidebarControls(e,t)}static _registerHook(e,t){const s=Hooks.on(e,t);return this.registeredHooks.set(`${e}_${s}`,s),s}static unregisterAll(){this.registeredHooks.forEach((e,t)=>{const s=t.split("_")[0];Hooks.off(s,e)}),this.registeredHooks.clear()}static isRegistered(e){for(const t of this.registeredHooks.keys())if(t.startsWith(`${e}_`))return!0;return!1}static _onPreRoll(e,t,s,o){r.log("_onPreRoll #0",[e,t,s,o])}static _onPreRollHitDieV2(e,t,s){if(r.log("_onPreRollHitDieV2 triggered",[e,t,s]),e.rolls&&e.rolls.length>1){const o=[];for(let i=0;i<e.rolls.length;i++){const l=e.rolls[i];l&&l.data&&l.data.situational&&o.push(l.data.situational)}if(o.length>0){e.rolls[0].data||(e.rolls[0].data={});const i=[...new Set(o)];e.rolls[0].data.situational=i.map(l=>{const a=l.toString().trim();return a.startsWith("-")?`(${a})`:a.startsWith("+")?`${a.substring(1)}`:`${a}`}).join(" + "),game.user.isGM&&!e.rolls[0].parts.find(l=>l.includes("@situational"))&&e.rolls[0].parts.push("@situational")}e.rolls=e.rolls.slice(0,1),r.log("Cleaned up hit die rolls",e.rolls)}}static _onPreRollInitiativeDialog(e,t,s){var l,a,n,c,u;const i=e.subject.getFlag(S,"tempInitiativeConfig");r.log("_onPreRollInitiativeDialog triggered",[e,i,t,s]),e.advantage=(i==null?void 0:i.advantage)||e.advantage||!1,e.disadvantage=(i==null?void 0:i.disadvantage)||e.disadvantage||!1,e.rollMode=(i==null?void 0:i.rollMode)||e.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,s.rollMode=(i==null?void 0:i.rollMode)||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,(n=(a=(l=i.rolls)==null?void 0:l[0])==null?void 0:a.data)!=null&&n.situational&&((u=(c=e.rolls)==null?void 0:c[0])!=null&&u.data)&&(e.rolls[0].data.situational=i.rolls[0].data.situational)}static _onPreRollAttackV2(e,t,s){var i,l;r.log("_onPreRollAttackV2 triggered",[e,t,s]);const o=(l=(i=e.subject)==null?void 0:i.item)==null?void 0:l.getFlag(S,"tempAttackConfig");if(o){if(r.log("_onPreRollAttackV2 - Found stored request config from flag",[o]),o.isRollRequest===!1||o.skipRollDialog===!0||o.sendRequest===!1){r.log("_onPreRollAttackV2 - Not a roll request, skipping",[o]);return}o.attackMode&&(e.attackMode=o.attackMode),o.ammunition&&(e.ammunition=o.ammunition),o.mastery!==void 0&&(e.mastery=o.mastery),e.advantage=o.advantage||!1,e.disadvantage=o.disadvantage||!1,s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,o.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=o.situational),r.log("_onPreRollAttackV2 - Applied stored configuration to attack roll",[e,s])}}static _onPreRollDamageV2(e,t,s){var i,l;console.trace("Flash Rolls 5e - _onPreRollDamageV2 triggered #0",[e]),r.log("_onPreRollDamageV2 triggered",[e,t,s]);const o=(l=(i=e.subject)==null?void 0:i.item)==null?void 0:l.getFlag(S,"tempDamageConfig");if(o){if(r.log("_onPreRollDamageV2 - Found stored request config from flag",[o,o.situational]),o.isRollRequest===!1||o.skipRollDialog===!0||o.sendRequest===!1){r.log("_onPreRollDamageV2 - Not a roll request, skipping",[o]);return}o.critical&&(e.critical=o.critical),s.rollMode=o.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,o.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=o.situational,e._flashRollsSituational=o.situational),r.log("_onPreRollDamageV2 - Applied stored configuration to damage roll",[e,s])}}static _onPreUseActivity(e,t,s,o){r.log("_onPreUseActivity triggered",[e,t,s,o]);const i=v(),l=I.get(i.rollRequestsEnabled.tag),a=I.get(i.rollInterceptionEnabled.tag);if(r.log("_onPreUseActivity - Settings",[l,a]),e.item.unsetFlag(S,"tempAttackConfig"),e.item.unsetFlag(S,"tempDamageConfig"),e.item.unsetFlag(S,"tempSaveConfig"),!game.user.isGM||!l||!a)return;const n=e.actor;if(!n)return;switch(I.get(i.consumptionConfigMode.tag)){case 1:s.configure=!1;break;case 2:s.configure=game.user.isGM;break;case 3:s.configure=!game.user.isGM;break;default:s.configure=!0;break}const u=H.getActorOwner(n);u&&u.active&&!u.isGM&&(r.log("Preventing usage message for player-owned actor",[n.name]),o.create=!1)}static _onPostUseActivity(e,t,s,o){var u;const i=v(),l=I.get(i.skipRollDialog.tag),a=I.get(i.rollRequestsEnabled.tag),n=I.get(i.rollInterceptionEnabled.tag);if(game.user.isGM,r.log("_onPostUseActivity #0",[e,t,s,o]),!a||!n)return;const c=H.getActorOwner(e.actor);if(!(c!=null&&c.active)||c.isGM){r.log("Preventing usage message - no owning player for actor",[actor.name]);return}if(game.user.isGM&&e.type===Ae.SAVE){const h=c&&c.active&&!c.isGM;r.log("_onPostUseActivity #1",[e,t]),e.damage&&((u=e.damage.parts)==null?void 0:u.length)>0&&(r.log("_onPostUseActivity #2 - roll triggered",[e,t]),t.scaling=!0,e.rollDamage(t,{...s,configure:!game.user.isGM||h&&!l},o))}}static _onRenderSkillToolDialog(e,t,s){var i,l;if(r.log("_onRenderSkillToolDialog triggered",[e]),e._abilityFlavorFixed)return;const o=t.querySelector('select[name="ability"]');if(o&&(i=e.config)!=null&&i.isRollRequest&&(l=e.config)!=null&&l.ability){const a=o.value,n=e.config.ability;a===n&&(e._abilityFlavorFixed=!0,setTimeout(()=>{const c=new Event("change",{bubbles:!0,cancelable:!0});o.dispatchEvent(c)},50))}}static onRefreshTemplate(e,t){if(!e.isOwner)return;const s=`refresh-template-${e.id}`,o=v(),i=I.get(o.templateAutoTarget.tag);ie.throttleTimers[s]&&clearTimeout(ie.throttleTimers[s]),ie.throttleTimers[s]=setTimeout(()=>{let l=3;switch(i){case 1:l=3;break;case 2:l=0;break;default:return}game.user.targets.forEach(n=>n.setTarget(!1,{releaseOthers:!1}));const a=[];for(let n of canvas.tokens.placeables)n.document.disposition<=l&&e.shape.contains(n.center.x-e.x,n.center.y-e.y)&&a.push(n);a.forEach((n,c)=>{n.setTarget(!0,{releaseOthers:c===0,groupSelection:!0})}),a.length>0&&game.user.broadcastActivity({targets:game.user.targets.ids}),delete ie.throttleTimers[s]},50)}};w(ie,"registeredHooks",new Map),w(ie,"midiTimeout",null),w(ie,"throttleTimers",{});let we=ie;class ve{static async handleRequest(e){var o,i;const t=H.isModuleOn(S,"midi-qol");if(r.log("handleRequest",[e]),game.user.isGM)return;let s;if(e.isTokenActor){const l=(o=game.scenes.active)==null?void 0:o.tokens.get(e.actorId);if(s=l==null?void 0:l.actor,!s){r.warn("Token actor not found:",e.actorId);return}}else s=game.actors.get(e.actorId);!s||!s.isOwner||(e.preserveTargets&&((i=e.targetTokenIds)==null?void 0:i.length)>0&&(r.log("handleRequest - applyTargetTokens",[e]),ut(e.targetTokenIds)),t&&e.rollProcessConfig.midiOptions&&(e.rollProcessConfig.midiOptions={...e.rollProcessConfig.midiOptions,fastForward:!1,fastForwardAttack:!1,dialogOptions:{...e.rollProcessConfig.midiOptions.dialogOptions,fastForward:!1,fastForwardAttack:!1},workflowOptions:{...e.rollProcessConfig.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1}}),B.notify("info","",{batch:!0,batchData:{actor:s.name,rollType:e.rollType,rollKey:e.rollKey,gm:e.rollProcessConfig._requestedBy||"GM"}}),this.rollQueue.push({actor:s,requestData:e}),r.log("handleRequest - Added to queue",[this.rollQueue.length,this.isProcessingRoll]),this.isProcessingRoll||this.processNextRoll())}static async processNextRoll(){if(this.rollQueue.length===0){this.isProcessingRoll=!1;return}this.isProcessingRoll=!0;const{actor:e,requestData:t}=this.rollQueue.shift();r.log("processNextRoll - Processing",[e.name,this.rollQueue.length,"remaining"]);try{await this.executePlayerRollRequest(e,t)}catch(s){r.error("Error processing roll request:",[s])}setTimeout(()=>{this.processNextRoll()},500)}static async executePlayerRollRequest(e,t){var o,i;const s=v();I.get(s.publicPlayerRolls.tag),r.log("executePlayerRollRequest",[e,t]),r.log("executePlayerRollRequest - groupRollId check",[t.groupRollId,typeof t.groupRollId]);try{const l=(o=t.rollType)==null?void 0:o.toLowerCase(),a=((i=t.rollProcessConfig.rolls)==null?void 0:i[0])||{parts:[],data:{},options:{}},c={configure:!(game.user.isGM?t.skipRollDialog:!1)},u=t.rollProcessConfig.rollMode,h=game.settings.get("core","rollMode"),m={rollMode:u||h,create:t.rollProcessConfig.chatMessage!==!1},R={rollKey:t.rollKey,activityId:t.activityId,config:t.rollProcessConfig,groupRollId:t.groupRollId},b=Q[l];b?await b(e,R,a,c,m):(r.warn(`No handler found for roll type: ${l}`),B.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"})))}catch(l){r.error("Error executing roll request:",[l]),B.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"}))}}}w(ve,"rollQueue",[]),w(ve,"isProcessingRoll",!1);class fe{static init(){ee.initialize(fe.registerSocketCalls),we.initialize()}static getDiceConfig(){return ge.getDiceConfig()}static receiveDiceConfig(e,t){ge.receiveDiceConfig(e,t)}static async handleRollRequest(e){return r.log("Main.handleRollRequest",e),ve.handleRequest(e)}static registerSocketCalls(){ee.registerCall(Ce.getDiceConfig,fe.getDiceConfig),ee.registerCall(Ce.receiveDiceConfig,fe.receiveDiceConfig),ee.registerCall(Ce.handleRollRequest,fe.handleRollRequest)}}fe.init();
//# sourceMappingURL=flash-rolls-5e.js.map
