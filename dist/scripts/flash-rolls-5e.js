var Ke=Object.defineProperty;var De=u=>{throw TypeError(u)};var Je=(u,e,t)=>e in u?Ke(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var k=(u,e,t)=>Je(u,typeof e!="symbol"?e+"":e,t),ye=(u,e,t)=>e.has(u)||De("Cannot "+t);var j=(u,e,t)=>(ye(u,e,"read from private field"),t?t.call(u):e.get(u)),ie=(u,e,t)=>e.has(u)?De("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(u):e.set(u,t),ne=(u,e,t,s)=>(ye(u,e,"write to private field"),s?s.call(u,t):e.set(u,t),t),ge=(u,e,t)=>(ye(u,e,"access private method"),t);const Q={select:"select",checkbox:"checkbox"},$={client:"client",world:"world"},E=()=>({generalSettings:{tag:"flash5e-general-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["rollInterceptionEnabled","useGMTargetTokens","showOfflineNotifications"],default:{rollInterceptionEnabled:!0,useGMTargetTokens:!0,showOfflineNotifications:!0},scope:$.world,config:!1,requiresReload:!1},groupRollsSettings:{tag:"flash5e-group-rolls-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["groupRollsMsgEnabled","groupRollResultMode","showGroupDCToPlayers"],default:{groupRollsMsgEnabled:!0,groupRollResultMode:1,showGroupDCToPlayers:!1},scope:$.world,config:!1,requiresReload:!1},showGroupDCToPlayers:{tag:"show-group-dc-to-players",label:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.hint"),propType:Boolean,inputType:Q.checkbox,default:!1,scope:$.world,config:!1},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:Q.checkbox,default:!0,scope:$.world,config:!0},groupRollsMsgEnabled:{tag:"group-roll-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.hint"),propType:Boolean,inputType:Q.checkbox,default:!0,scope:$.world,config:!1},groupRollResultMode:{tag:"group-roll-result-mode",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.hint"),propType:Number,inputType:Q.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.4")},default:1,scope:$.world,config:!1},consumptionConfigMode:{tag:"consumption-config-mode",label:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.hint"),propType:Number,inputType:Q.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.4")},default:1,scope:$.world,config:!0},skipRollDialog:{tag:"skip-roll-dialog",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.hint"),propType:Boolean,inputType:Q.checkbox,default:!1,scope:$.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:Q.checkbox,default:!0,scope:$.world,config:!1},rollInterceptionEnabled:{tag:"roll-interception-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:Q.checkbox,default:!0,scope:$.world,config:!1},publicPlayerRolls:{tag:"public-player-rolls",label:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.hint"),propType:Boolean,inputType:Q.checkbox,default:!0,scope:$.world,config:!0},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:Q.checkbox,default:!0,scope:$.world,config:!1},debugMode:{tag:"debug-mode",label:game.i18n.localize("FLASH_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:Q.checkbox,default:!0,scope:$.client,config:!0}}),T="flash-rolls-5e",he=["%cFlash Rolls 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],Se={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest"},Te={SAVE:"save"},g={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",ATTACK:"attack",CONCENTRATION:"concentration",CUSTOM:"custom",DEATH_SAVE:"deathsave",FORMULA:"formula",DAMAGE:"damage",HEALING:"healing",HIT_DIE:"hitdie",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",ITEM_SAVE:"itemsave",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool"},Ze={ABILITY_CHECK:{name:g.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:g.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:g.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:g.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:g.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:g.INITIATIVE,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:g.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:g.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:g.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},K={ID:T,ROLL_REQUEST_OPTIONS:Ze},W={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessageHTML",RENDER_CHAT_LOG:"renderChatLog",CHANGE_SIDEBAR_TAB:"changeSidebarTab",RENDER_SIDEBAR:"renderSidebar",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",COLLAPSE_SIDE_BAR:"collapseSidebar"},Xe={READY:"socketlib.ready"},N={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG:"dnd5e.preRollInitiativeDialog",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",ROLL_INITIATIVE:"dnd5e.rollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog",RENDER_SKILL_TOOL_ROLL_DIALOG:"renderSkillToolRollConfigurationDialog"},fe=class fe{static log(e="",t=[],s=!1){try{const i=game.settings.get(T,"debug-mode")||fe.debugOn;if(!(s||i))return;const l=Array.isArray(t)?t:[t];console.log(...he,e,...l)}catch{if(s||fe.debugOn){const o=Array.isArray(t)?t:[t];console.log(...he,e,...o)}}}static warn(e="",t=[]){const s=Array.isArray(t)?t:[t];console.warn(...he,e,...s)}static error(e,t=[],s={ui:!1,console:!0,permanent:!1}){var o;const i=Array.isArray(t)?t:[t];s.ui&&((o=ui.notifications)==null||o.error(e,{localize:!0,permanent:s.permanent})),s.console&&console.error(...he,e,...i)}};k(fe,"debugOn",!1);let n=fe;const G=class G{static serializeForTransport(e,t=!1){return n.log("serializeForTransport",[e,t]),e==null||t&&e.rolls&&Array.isArray(e.rolls)&&(e.rolls=e.rolls.map(s=>s instanceof Roll?s.toJSON():s)),e}static deserializeFromTransport(e,t=!1){n.log("deserializeFromTransport",[e,t]);let s={...e};if(!e)return s;if(t&&e.rolls&&e.rolls.length>0){const i=s.rolls.map(o=>{let l=o;return typeof o=="string"?l=Roll.fromJSON(o):l=Roll.fromJSON(JSON.stringify(o)),l});return s.rolls=[...i],s}return s}};k(G,"socket"),k(G,"_activeExecutions",new Map),k(G,"initialize",e=>{n.log("initialize",[e]),Hooks.once(Xe.READY,()=>{if(typeof socketlib>"u"){n.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{G.socket=socketlib.registerModule(T),e&&e()}catch{}})}),k(G,"registerCall",(e,t)=>{n.log("registerCall",[e]),G.socket&&G.socket.register(e,t)}),k(G,"sendMessage",(e,t)=>{n.log("sendMessage",[e]),t&&t()}),k(G,"execForGMs",async(e,...t)=>{if(n.log("execForGMs",[e,...t]),!!G.socket)return await G.socket.executeForAllGMs(e,...t)}),k(G,"execForAll",async(e,...t)=>{if(G.socket)return await G.socket.executeForEveryone(e,...t)}),k(G,"execForUser",async(e,t,...s)=>{if(n.log("execForUser #0",[e,t,...s]),!G.socket)return;if(n.log("execForUser #1",[t===game.user.id]),t===game.user.id)return null;const i=`${e}-${t}`;if(n.log("execForUser #2",[G._activeExecutions.has(i)]),G._activeExecutions.has(i))return null;G._activeExecutions.set(i,!0);try{const o=await G.socket.executeAsUser(e,t,...s);return n.log("execForUser #3 - response",[o]),o}catch(o){return n.error("execForUser #4 - error",[o]),null}finally{n.log("execForUser #5 - success",[]),G._activeExecutions.delete(i)}});let J=G;class le{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const e=game.settings.storage.get("client");return this.diceConfig=e["core.diceConfiguration"]||"",this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){J.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(e,t){var s,i;((s=game.user)!=null&&s.isGM||e===((i=game.user)==null?void 0:i.id))&&(this.playerDiceConfigs[e]=t?JSON.parse(t):{})}static getUserDiceConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?this.diceConfig:this.playerDiceConfigs[e]||{}}static requestDiceConfigFromUser(e){J.execForUser("getDiceConfig",e)}static requestDiceConfigFromAllPlayers(){var e;(e=game.user)!=null&&e.isGM&&game.users.forEach(t=>{t.active&&!t.isGM&&t.id!==game.user.id&&this.requestDiceConfigFromUser(t.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(e){var t;return e===((t=game.user)==null?void 0:t.id)?!!this.diceConfig:!!this.playerDiceConfigs[e]}}k(le,"diceConfig",{}),k(le,"playerDiceConfigs",{});var be,Ne;class P{static isModuleOn(e){var s;const t=(s=game.modules)==null?void 0:s.get(e);return!!(t!=null&&t.active)}static html(e,t){return e.querySelector(t)}static getFullWidth(e){return window.getComputedStyle(e).width==="0px"?0:e.offsetWidth}static addCSSVars(e,t){let s=document.querySelector("#flash5e-vars");if(!s){const p=document.querySelector("body.flash5e");if(!p)return;s=document.createElement("style"),s.id="flash5e-vars",s.textContent=`body.flash5e {
}
`,p.prepend(s)}let i=s.textContent,o=i.indexOf("body.flash5e {"),l=i.indexOf("}",o);o===-1&&(i=`body.flash5e {
}
`,o=0,l=i.indexOf("}"));const a=i.substring(o+14,l).split(";").map(p=>p.trim()).filter(p=>p!==""),c={};a.forEach(p=>{const h=p.split(":");if(h.length>=2){const m=h[0].trim(),R=h.slice(1).join(":").trim();m&&(c[m]=R)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),c[e]=t;const d=Object.entries(c).map(([p,h])=>`  ${p}: ${h};`).join(`
`),f=i.substring(0,o)+`body.flash5e {
`+d+`
}`+i.substring(l+1);s.textContent=f}static getOffsetBottom(e){const t=e.offsetTop,s=e.offsetHeight;return window.innerHeight-(t+s)}static async getAllFonts(){const e=new Set(Object.keys(CONFIG.fontDefinitions)),t=game.settings.get("core","fonts")||{},s=Object.entries(t).map(([l])=>l),i=await this.processStyleSheets();return Array.from(new Set([...e,...s,...i])).filter(l=>!/FontAwesome|Font Awesome|FoundryVTT/.test(l)).map(l=>l.replace(/['"]/g,"").trim()).sort((l,r)=>l.toLowerCase().localeCompare(r.toLowerCase()))||[]}static addCustomCSS(e,t="flash5e-custom-css",s=!0){if(!e)return;let i=document.querySelector("#"+t);i||(i=document.createElement("style"),i.id=t,i.textContent="",document.head.appendChild(i));const o=/@import\s+(?:url\()?\s*['"]?[^'")]+['"]?\s*\)?\s*;/g,l=[];let r=e,a;for(;(a=o.exec(e))!==null;)l.push(a[0]);if(r=e.replace(o,"").trim(),!s){i.textContent=l.join(`
`)+(l.length?`

`:"")+r;return}if(!i.textContent.includes(r)){const c=i.textContent,d=[];let f;for(;(f=o.exec(c))!==null;)d.push(f[0]);const p=c.replace(o,"").trim(),h=l.filter(R=>!d.includes(R)),m=[...d,...h];i.textContent=m.join(`
`)+(m.length?`

`:"")+p+(p&&r?`

`:"")+r}}static smoothScrollTo(e,t,s="horizontal",i=300,o=null){const l=e.dataset.scrollAnimationId;l&&cancelAnimationFrame(Number(l));const r=s==="horizontal",a=r?e.scrollLeft:e.scrollTop,c=t-a;if(c===0)return o&&o(),null;const d=performance.now(),f=h=>{const m=h-d;if(m>=i){r?e.scrollLeft=t:e.scrollTop=t,delete e.dataset.scrollAnimationId,o&&o();return}const R=m/i,y=R<.5?2*R*R:1-Math.pow(-2*R+2,2)/2;r?e.scrollLeft=a+c*y:e.scrollTop=a+c*y;const b=requestAnimationFrame(f);return e.dataset.scrollAnimationId=b,b},p=requestAnimationFrame(f);return e.dataset.scrollAnimationId=p,p}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredLabel"),s={}){const i={title:e,content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.reloadButton"),callback:()=>(n.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(i,s),foundry.applications.api.DialogV2.confirm(i)}static renderTemplate(e,t){return foundry.applications.handlebars.renderTemplate(e,t)}static loadTemplate(e){return foundry.applications.handlebars.loadTemplate(e)}static loadTemplates(e){return Array.isArray(e)||(e=[e]),foundry.applications.handlebars.loadTemplates(e)}static isValidCSSRule(e){if(!e||typeof e!="string")return!1;const t=e.trim();if(!t)return!1;try{const s=document.createElement("style"),i=`${t} { color: inherit; }`;s.textContent=i,document.head.appendChild(s);const o=!!(s.sheet&&s.sheet.cssRules&&s.sheet.cssRules.length>0);return document.head.removeChild(s),o}catch(s){return n.log("CSS validation error:",[s,e]),!1}}static processCSSRules(e,t){if(!e||!t)return"";const s=ge(this,be,Ne).call(this,e),i=t+` {
`+s.baseProperties.join(`
`)+`
}`,o=[],l=new Map;return s.nestedRules.forEach(r=>{const{selector:a,content:c}=r;if(a.startsWith("&")){const p=a.substring(1),h=t.split(",").map(m=>m.trim()).filter(Boolean).map(m=>m+p).join(", ");o.push(`${h} {
${c}
}`);return}l.has(c)||l.set(c,[]);const d=a.split(",").map(p=>p.trim()),f=t.split(",").map(p=>p.trim()).filter(Boolean);d.forEach(p=>{f.forEach(h=>{l.get(c).push(`${h} ${p}`)})})}),l.forEach((r,a)=>{o.push(`${r.join(", ")} {
${a}
}`)}),i+`

`+o.join(`

`)}static getActorOwner(e){const t=e.ownership||{};for(const[s,i]of Object.entries(t))if(i>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.get(s);if(o&&!o.isGM)return o}if((t==null?void 0:t.default)>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const s=game.users.filter(i=>!i.isGM)[0];if(s)return s}return null}static confirmReload(e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredTitle"),t=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredLabel"),s={}){const i={title:e,content:t,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.reloadButton"),callback:()=>(n.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(i,s),foundry.applications.api.DialogV2.confirm(i)}}be=new WeakSet,Ne=function(e){const t=[],s=[],i=e.split(`
`);let o=null,l=0;for(let r=0;r<i.length;r++){const a=i[r].trim();if(!a)continue;const c=(a.match(/{/g)||[]).length,d=(a.match(/}/g)||[]).length;if(a.includes("{")&&!o){o={selector:a.substring(0,a.indexOf("{")).trim(),content:"",startLine:r},l=1;const p=a.substring(a.indexOf("{")+1).trim();p&&!p.includes("}")&&(o.content+=p+`
`)}else o?(l+=c-d,l>0?o.content+=a+`
`:(o.content=o.content.replace(/}\s*$/,"").trim(),s.push(o),o=null)):!a.includes("{")&&!a.includes("}")&&t.push(a)}return{baseProperties:t,nestedRules:s}},ie(P,be),k(P,"wrapFontName",e=>{const t=e.replace(/['"`]/g,"");return t.includes(" ")?`"${t}"`:t});const{FormDataExtended:mt}=foundry.utils,{ApplicationV2:et,HandlebarsApplicationMixin:tt}=foundry.applications.api;var Ge,ee,ue,Ie,se,He,Pe,qe;const D=class D extends tt(et){constructor(){super(...arguments);k(this,"_onRender",(t,s)=>{E(),ne(D,ee,this.element);const i=j(D,ee).querySelectorAll(".toggle-hint");n.log("_onRender",[t,s,this.element]),i.forEach(l=>{l.addEventListener("click",()=>{j(D,ee).querySelectorAll("p.hint").forEach(r=>r.classList.toggle("shown"))})}),j(D,ee).querySelectorAll("select[data-current-value]").forEach(l=>{const r=String(l.dataset.currentValue),a=l.querySelector(`option[value="${r}"]`);a&&(a.selected=!0)}),n.log("_onRender",[t,s])})}_configureRenderParts(t){const s=super._configureRenderParts(t),i=D.getRestrictedTabs();return game.user.isGM||i.forEach(o=>{delete s[o]}),s}async _prepareContext(t){const s=await super._prepareContext(t);return s.activeTab=t.activeTab||Object.keys(s.tabs)[0],s.isGM=game.user.isGM,s}async _preparePartContext(t,s,i){var r,a,c;const o=await super._preparePartContext(t,s,i);t in s.tabs&&(o.tab=o.tabs[t]),E(),Ve();const l=D.getRestrictedTabs();switch(game.user.isGM||l.forEach(d=>{delete o.tabs[d]}),t){case"tabs":break;case"footer":{o.buttons=[{type:"button",icon:"",label:"FLASH_ROLLS.ui.buttons.reset",action:"redefine"},{type:"submit",icon:"",label:"FLASH_ROLLS.ui.buttons.save"}];break}default:{o.tab=o.tabs[t];const d=((r=D.PARTS[t])==null?void 0:r.menuKey)||null;if(d){const f=D.getMenuContext(d);f.fields&&(o.fields={...o.fields,...f.fields}),f.fieldDefaults&&(o.fieldDefaults={...o.fieldDefaults,...f.fieldDefaults}),f.fieldValues&&Object.assign(o,f.fieldValues),o.sidebarTabs=Object.values(((c=(a=foundry.applications)==null?void 0:a.sidebar)==null?void 0:c.tabs)||{}).map(p=>({tabName:p.tabName,name:p.name,hideForGM:!1,hideForPlayer:!1,localizedName:`FLASH_ROLLS.settings.sidebarTabs.${p.name}`}))}break}}return n.log("_preparePartContext",[o,t]),o}static getMenuContext(t){var a;const s=E(),i=((a=s[t])==null?void 0:a.fields)||null;if(!i)return{};const o={},l={},r={};return i.forEach(c=>{if(s[c]){const d=A.get(s[c].tag);o[c]=s[c],l[c]=d!==void 0?d:s[c].default,r[c]=s[c].default}}),{fields:o,fieldValues:l,fieldDefaults:r}}static getRestrictedTabs(){const t=[];return Object.entries(D.PARTS).forEach((s,i)=>{s[0]!=="tabs"&&s[0]!=="footer"&&s[1].isGMOnly&&t.push(s[0])}),t}static updateSettings(t){let s=!1;const i=E(),r=j(D,ee).querySelector(".form-content.active").dataset.tab;if(ne(D,ue,r),!t)return;let a;return t.object&&(a=foundry.utils.expandObject(t.object)),Object.entries(a).forEach(([c,d])=>{var f;if(!c.endsWith("_value")&&(n.log("updateSettings #1",[i,i[c]]),a[c]!==void 0&&i[c])){const p=A.get(i[c].tag);A.set(i[c].tag,a[c]),(f=i[c])!=null&&f.requiresReload&&p!==a[c]&&(s=!0)}}),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.ui.notifications.settingsUpdated")),s}changeTab(t,s,i){super.changeTab(t,s,i),ne(D,ue,t)}};ee=new WeakMap,ue=new WeakMap,Ie=new WeakMap,se=new WeakSet,He=async function(t,s,i){t.preventDefault(),t.stopPropagation(),D.updateSettings(i)&&P.confirmReload()},Pe=async function(t,s){const i=E(),l=j(D,ee).querySelector(".form-content.active"),r=l.dataset.tab,a=D.PARTS[r].menuKey,c=i[a].default;l.querySelectorAll("input, select").forEach(f=>{f.value=c[f.name],f.type==="checkbox"&&(f.checked=c[f.name])}),n.log("#onReset",[j(D,ue),r,t,s])},qe=function(){const t=[];return Object.entries(D.PARTS).forEach(([s,i])=>{i.menuKey&&t.push({id:s,icon:"",group:"primary-tabs",label:`FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${s}`})}),t},ie(D,se),ie(D,ee),ie(D,ue),ie(D,Ie),k(D,"selectedTheme"),k(D,"DEFAULT_OPTIONS",{id:"flash-rolls-settings",tag:"form",window:{icon:"fas fa-cog",title:"FLASH_ROLLS.settings.moduleSettingsMenu.title",contentClasses:["standard-form","crlngn","tabbed-settings"],resizable:!0},position:{width:700,height:"auto"},actions:{redefine:ge(D,se,Pe)},form:{handler:ge(D,se,He),closeOnSubmit:!0}}),k(D,"PARTS",{tabs:{template:"templates/generic/tab-navigation.hbs",isGMOnly:!1},generalSettings:{menuKey:"generalSettings",template:"modules/flash-rolls-5e/templates/settings-general.hbs",isGMOnly:!0},groupRolls:{menuKey:"groupRollsSettings",template:"modules/flash-rolls-5e/templates/settings-group-rolls.hbs",isGMOnly:!0},footer:{template:"templates/generic/form-footer.hbs",isGMOnly:!1}}),k(D,"TABS",{primary:{initial:"generalSettings",tabs:ge(Ge=D,se,qe).call(Ge),labelPrefix:""}});let _e=D;function Ve(){return{moduleSettingsMenu:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),name:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),icon:"fas fa-cog",propType:_e,restricted:!0}}}class A{static registerSettings(){const e=E();Object.entries(e).forEach(s=>{const i=s[1],o={name:i.label,hint:i.hint,default:i.default,type:i.propType,scope:i.scope,config:i.config,requiresReload:i.requiresReload||!1,restricted:i.scope===$.world,onChange:l=>A.apply(i.tag,l)};i.choices&&(o.choices=i.choices),n.log("registerSettings",[o,o.scope],!0);try{game.settings.register(T,i.tag,o)}catch(l){n.log(`Setting ${i.tag} already registered or error:`,l)}})}static registerSettingsMenu(){var s;const t=Object.entries(Ve()).find(i=>i[0]==="moduleSettingsMenu");if(t){const i=t[1];if(i.restricted&&((s=game.user)!=null&&s.isGM)||!i.restricted){const o={name:i.tag,label:i.label,hint:i.hint,icon:i.icon,type:i.propType,restricted:i.restricted};game.settings.registerMenu(T,i.tag,o)}}}static get(e,t=T){if(!e)return null;let s=!1;try{if(t===T)s=game.settings.get(t,e);else{let o=game.settings.storage.get("client")[`${t}.${e}`];o===void 0&&(o=game.settings.storage.get("world").getSetting(`${t}.${e}`),s=o==null?void 0:o.value)}}catch{return n.log(`Setting ${t}.${e} not found, returning false`),!1}return s}static set(e,t,s=T){if(!e)return!1;let i=game.settings.storage.get("client")[`${s}.${e}`];i||(i=game.settings.storage.get("world").getSetting(`${s}.${e}`),n.log("SettingsUtil.set - world Setting?",[i]));try{game.settings.set(s,e,t),n.log("SettingsUtil.set - success",[s,e,t])}catch(o){n.error("SettingsUtil.set - error",[o])}return!0}static apply(e,t){const s=E();switch(e){case s.rollRequestsEnabled.tag:A.applyRollRequestsEnabled(t);break}}static applyRollRequestsEnabled(e){const t=document.querySelector(".chat-controls .flash-rolls-icon");t&&(e?t.classList.add("active"):t.classList.remove("active"))}}Hooks.once("ready",()=>{dnd5e.applications.dice.DamageRollConfigurationDialog||n.warn("DamageRollConfigurationDialog not found in dnd5e.applications.dice")});function pe(u){return class extends u{constructor(e={},t={},s={}){var i,o;super(e,t,s),this.actors=s.actors||[],this.sendRequest=s.sendRequest??s.sendRequest??!0,this.showDC=s.showDC||!1,this.dcValue=s.dcValue||null,this.rollKey=s.rollKey||e.skill||e.ability||null,this.rollTypeString=s.rollTypeString||null,this.windowTitle=((i=s.window)==null?void 0:i.title)||"",this.windowSubtitle=((o=s.window)==null?void 0:o.subtitle)||""}_buildConfig(e,t,s){const i=t==null?void 0:t.get("ability"),o=t==null?void 0:t.get("dc"),l=t==null?void 0:t.get(`rolls.${s}.situational`);if(n.log("_buildConfig",[l,t,e]),l)e.parts||(e.parts=[]),e.parts.push("@situational"),e.data||(e.data={}),e.data.situational=l;else if(e.parts){const a=e.parts.indexOf("@situational");a!==-1&&e.parts.splice(a,1)}i&&(e.ability=i,this.config.ability=i);const r=super._buildConfig(e,t,s);if(o){const a=parseInt(o);isNaN(a)||(r.options=r.options||{},r.options.target=a)}else this.dcValue!==void 0&&this.dcValue!==null&&(r.options=r.options||{},r.options.target=this.dcValue);return n.log(`${this.constructor.name}._buildConfig`,[this.config,t,r]),r}_onChangeForm(e,t){n.log("_onChangeForm",[t.target.value]),super._onChangeForm(e,t);const s=this.element.querySelector('input[name="flash5e-send-request"]');s&&(this.sendRequest=s.checked);const i=this.element.querySelector('input[name="dc"]');i&&i.value&&(this.dcValue=parseInt(i.value)||null)}_finalizeRolls(e){const t=super._finalizeRolls(e);if(n.log("_finalizeRolls #1",[t,this.sendRequest]),this.dcValue!==void 0&&this.dcValue!==null)for(const s of t)s.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,t}async _onRender(e,t){var s,i,o;await super._onRender(e,t),((o=(i=(s=this.config.rolls)==null?void 0:s[0])==null?void 0:i.data)!=null&&o.situational||this.config.situational)&&(n.log(`${this.constructor.name}._onRender`,["Triggering rebuild for initial situational bonus"]),setTimeout(()=>{this.rebuild()},100))}}}function st(u,e){var i,o,l,r,a;let t=game.i18n.localize(`FLASH_ROLLS.rollTypes.${u}`)||u;const s=u==null?void 0:u.toLowerCase();if(e)switch(s){case g.SKILL:t+=` (${((i=CONFIG.DND5E.skills[e])==null?void 0:i.label)||e})`;break;case g.SAVE:t+=` (${((o=CONFIG.DND5E.abilities[e])==null?void 0:o.label)||e})`;break;case g.ABILITY:t+=` (${((l=CONFIG.DND5E.abilities[e])==null?void 0:l.label)||e})`;break;case g.TOOL:const c=(a=(r=CONFIG.DND5E.enrichmentLookup)==null?void 0:r.tools)==null?void 0:a[e];if(c!=null&&c.id){const d=dnd5e.documents.Trait.getBaseItem(c.id,{indexOnly:!0});t+=` (${(d==null?void 0:d.name)||e})`}else t+=` (${e})`;break;case g.CUSTOM:t=`${t}: ${e}`;break}return t}function it(u,e=st){if(u.length===0)return;const t={};for(const i of u){const o=`${i.rollType}_${i.rollKey||""}`;t[o]||(t[o]={rollType:i.rollType,rollKey:i.rollKey,actors:[],gm:i.gm}),t[o].actors.push(i.actor)}const s=Object.values(t);if(s.length===1&&s[0].actors.length===1){const i=s[0];ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestReceived",{gm:i.gm,rollType:e(i.rollType,i.rollKey)}))}else{const i=[];for(const o of s){const l=e(o.rollType,o.rollKey),r=o.actors.join(", ");i.push(`${l} (${r})`)}ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsReceivedMultiple",{gm:s[0].gm,requests:i.join("; ")}))}}function xe(u){const e=u.ownership||{};for(const[t,s]of Object.entries(e))if(s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const i=game.users.get(t);if(i&&!i.isGM)return i}return null}function ot(u,e=game.user){if(!(u!=null&&u.length))return;u.map(s=>canvas.tokens.get(s)).filter(s=>s).forEach(s=>s.setTarget(!0,{user:e}))}function me(u){return u.type!=="character"&&u.type!=="npc"?!1:Object.entries(u.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function Me(u){if(u.type!=="character"&&u.type!=="npc")return!1;const e=game.scenes.active;return e&&e.tokens.some(t=>t.actorId===u.id)}function Re(u,e){if(!game.scenes.active)return;const s=canvas.tokens.placeables.filter(i=>{var o;return((o=i.actor)==null?void 0:o.id)===u});for(const i of s)e?i.control({releaseOthers:!1}):i.release()}function we(u){return new Promise(e=>setTimeout(e,u))}function ve(){var u;return((u=ui==null?void 0:ui.sidebar)==null?void 0:u.expanded)||!1}function Fe(u){const e=document.querySelector("body");u?e.classList.add("flash5e-sidebar-expanded"):e.classList.remove("flash5e-sidebar-expanded"),ze()}function lt(u,e){var l;const t=[];if(!u||e.size===0)return t;const s=K.ROLL_REQUEST_OPTIONS[u];if(!s||!s.subList)return t;const i=Array.from(e)[0],o=game.actors.get(i);if(s.subList==="tools"){const r=((l=CONFIG.DND5E.enrichmentLookup)==null?void 0:l.tools)||CONFIG.DND5E.tools||{};for(const[a,c]of Object.entries(r)){let d=a;if(c!=null&&c.id){const f=dnd5e.documents.Trait.getBaseItem(c.id,{indexOnly:!0});d=(f==null?void 0:f.name)||a}else d=a.replace(/([A-Z])/g," $1").replace(/^./,f=>f.toUpperCase()).trim();t.push({id:a,name:d,rollable:!0})}t.sort((a,c)=>a.name.localeCompare(c.name))}else if(o&&s.actorPath){const r=foundry.utils.getProperty(o,s.actorPath)||{},a=CONFIG.DND5E[s.subList];for(const[c,d]of Object.entries(r)){let f="";s.subList==="skills"&&(a!=null&&a[c])||s.subList==="abilities"&&(a!=null&&a[c])?f=a[c].label:f=d.label||game.i18n.localize(d.name||c)||c,t.push({id:c,name:f,rollable:!0})}s.subList==="skills"&&t.sort((c,d)=>c.name.localeCompare(d.name))}return t}const x=class x{static notify(e,t,s={}){if(!s.batch){ui.notifications[e](t);return}s.batchData&&(x.pendingNotifications.push(s.batchData),x.notificationTimer&&clearTimeout(x.notificationTimer),x.notificationTimer=setTimeout(()=>{it(x.pendingNotifications),x.pendingNotifications=[],x.notificationTimer=null},x.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(e,t){const s=Object.entries(e);if(s.length!==0)if(s.length===1){const i=Object.values(e)[0],o=i.actors.map(l=>l.name).join(", ");ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentSingle",{rollType:t,actors:o,player:i.player.name}))}else{const i=s.map(([o,l])=>{const r=l.actors.map(a=>a.name).join(", ");return`${l.player.name} (${r})`});ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentMultiple",{rollType:t,count:s.length,players:i.join("; ")}))}}static clearPending(){x.notificationTimer&&(clearTimeout(x.notificationTimer),x.notificationTimer=null),x.pendingNotifications=[]}};k(x,"pendingNotifications",[]),k(x,"notificationTimer",null),k(x,"NOTIFICATION_BATCH_DELAY",500);let q=x;function at(u){var s;const e=[],t=[];for(const i of u){const o=((s=i.system.attributes.hp)==null?void 0:s.value)||0,l=i.system.attributes.death||{},r=l.success||0,a=l.failure||0;o<=0&&r<3&&a<3?e.push(i):t.push(i.name)}return t.length>0&&q.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorsSkippingDeathSave",{actors:t.join(", ")})),e}function nt(u){const e=[],t=[];for(const s of u){const i=xe(s);i?e.push({actor:s,owner:i}):t.push(s)}return{pcActors:e,npcActors:t}}function ze(u=!0){const e=document.querySelector("#chat-notifications #roll-privacy"),t=e?P.getFullWidth(e):0;P.addCSSVars("--flash-rolls-menu-offset",t+"px")}const I={addSituationalBonus(u,e){var t;return n.log("Config before adding bonus:",[e,u]),e&&((t=u.rolls)!=null&&t[0])&&(u.rolls[0].parts||(u.rolls[0].parts=[]),u.rolls[0].data||(u.rolls[0].data={}),u.rolls[0].data.situational=e,u.rolls[0].parts.includes("@situational")||u.rolls[0].parts.push("@situational"),n.log("Config after adding bonus:",[u])),u},buildRollConfig(u,e,t={}){var o;const s={rolls:[{parts:e.parts||[],data:e.data||{},options:{...e.options||{},...((o=e.options)==null?void 0:o._fromFlashRolls)&&{_fromFlashRolls:!0}}}],advantage:u.config.advantage||!1,disadvantage:u.config.disadvantage||!1,target:u.config.target,subject:null,chatMessage:!0,legacy:!1,...u.config.rollMode&&{rollMode:u.config.rollMode},...t},i=u.config.situational;return i&&this.addSituationalBonus(s,i),this.ensureRollFlags(s,u)},ensureRollFlags(u,e){return u.isRollRequest=!game.user.isGM,u._showRequestedBy=!0,u._requestedBy=e.config.requestedBy||"GM",u},validateActors(u){return!u||u.length===0?null:(typeof u[0]=="string"&&(u=u.map(e=>game.actors.get(e)).filter(e=>e)),u.length>0?u:null)},getRollClass(u){const e=u==null?void 0:u.toLowerCase();return[g.DAMAGE,g.HEALING].includes(e)?CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[g.FORMULA,g.CUSTOM,g.HIT_DIE].includes(e)?CONFIG.Dice.BasicRoll:CONFIG.Dice.D20Roll},shouldShowDC(u){const e=u==null?void 0:u.toLowerCase();return[g.SAVE,g.SAVING_THROW,g.ABILITY,g.ABILITY_CHECK,g.CONCENTRATION,g.SKILL,g.TOOL].includes(e)},createBaseRollConfig(u,e,t){const s=e==null?void 0:e.toLowerCase(),i={data:u.getRollData(),subject:u,rolls:[{parts:[],data:u.getRollData(),options:{}}]};switch(s){case g.SKILL:i.skill=t;break;case g.TOOL:i.tool=t;break;case g.SAVE:case g.SAVING_THROW:case g.ABILITY:case g.ABILITY_CHECK:i.ability=t;break;case g.HIT_DIE:i.rolls[0].options.flavor="Hit Die";break}return i},createMessageConfig(u,e=null){const t={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:u})}};return e&&(t.rollMode=e),t},async triggerRollDialog(u,e,t,s){const i=new u(e,t,s);return await new Promise(l=>{i.addEventListener("close",()=>{l({rolls:i.rolls,config:i.config,message:i.message,sendRequest:i.sendRequest,critical:i.config.critical,isCritical:i.config.isCritical})},{once:!0}),i.render({force:!0})})},processDialogResult(u,e,t,s,i={}){var R,y,b,L,_,S;if(!(u!=null&&u.rolls)||u.rolls.length===0)return null;const o=t==null?void 0:t.toLowerCase(),l=u.rolls[0];let r=!1,a=!1;((R=l==null?void 0:l.options)==null?void 0:R.advantageMode)!==void 0&&(r=l.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,a=l.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const c=((y=l==null?void 0:l.data)==null?void 0:y.situational)||"",d=(b=l==null?void 0:l.options)==null?void 0:b.target,f={rolls:[{parts:((L=l==null?void 0:l.parts)==null?void 0:L.slice())||[],data:c?{situational:c}:{},options:d?{target:d}:{}}],subject:e[0],advantage:r,disadvantage:a,target:d,sendRequest:u.sendRequest,isRollRequest:u.sendRequest,skipRollDialog:i.skipRollDialog||!1,chatMessage:!0},p=E(),h=A.get(p.publicPlayerRolls.tag)===!0,m=this.determineRollMode(h,(_=u.message)==null?void 0:_.rollMode);return f.rollMode=m,(S=u.config)!=null&&S.ability&&[g.SKILL,g.TOOL].includes(o)&&(f.ability=u.config.ability),f},determineRollMode(u,e){return e||(u?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode"))},isPlayerOwned(u){return Object.entries(u.ownership).some(([e,t])=>{const s=game.users.get(e);return s&&!s.isGM&&t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})},isPlayerOwnerActive(u){const e=xe(u);return e&&e.active},calculateStandardRule(u,e){const t=u.filter(o=>o.total>=e).length,s=u.length-t,i=Math.ceil(u.length/2);return{finalResult:t>=i,successes:t,failures:s,summary:game.i18n.format("FLASH_ROLLS.groupRoll.standardRule.summary",{successes:t,total:u.length,threshold:i}),method:"Standard Rule"}},calculateGroupAverage(u,e){const t=u.reduce((i,o)=>i+o.total,0),s=Math.floor(t/u.length);return{finalResult:s,average:s,success:s>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.groupAverage.summary",{average:s,dc:e}),method:"Group Average"}},calculateLeaderWithHelp(u,e,t,s,i){var h;let o=-999,l=null,r=0;for(const m of t){const R=this._getActorModifier(m,s,i);R>o&&(o=R,l=m.id,r=R)}const a=u.find(m=>m.actorId===l);if(!a)return{finalResult:0,error:"Leader actor did not roll",method:"Leader with Help"};const c=u.filter(m=>m.actorId!==l),d=c.filter(m=>m.total>=e).length,f=c.filter(m=>m.total<e).length,p=a.total+d-f;return{finalResult:p,leaderRoll:a.total,leaderName:(h=t.find(m=>m.id===l))==null?void 0:h.name,leaderModifier:r,bonus:d,penalty:f,success:p>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.leaderWithHelp.summary",{leaderRoll:a.total,bonus:d,penalty:f,adjustedResult:p,dc:e}),method:"Leader with Help"}},calculateWeakestLink(u,e,t,s,i){var p;let o=999,l=null,r=0;for(const h of t){const m=this._getActorModifier(h,s,i);m<o&&(o=m,l=h.id,r=m)}const a=u.find(h=>h.actorId===l);if(!a)return{finalResult:0,error:"Weakest link actor did not roll",method:"Weakest Link"};const c=u.filter(h=>h.total>=e).length,d=a.total+c,f=c===1?game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successPlural");return{finalResult:d,weakestRoll:a.total,weakestName:(p=t.find(h=>h.id===l))==null?void 0:p.name,weakestModifier:r,bonus:c,success:d>=e,summary:game.i18n.format("FLASH_ROLLS.groupRoll.weakestLink.summary",{weakestRoll:a.total,bonus:c,successWord:f,adjustedResult:d,dc:e}),method:"Weakest Link"}},_getActorModifier(u,e,t){var i,o,l,r,a;switch(e==null?void 0:e.toLowerCase()){case g.SKILL:return((i=u.system.skills[t])==null?void 0:i.total)||((o=u.system.skills[t])==null?void 0:o.mod)||0;case g.SAVE:case g.SAVING_THROW:return((l=u.system.abilities[t])==null?void 0:l.save)||0;case g.ABILITY:case g.ABILITY_CHECK:return((r=u.system.abilities[t])==null?void 0:r.mod)||0;case g.TOOL:if((a=u.system.tools)!=null&&a[t])return u.system.tools[t].total||u.system.tools[t].mod||0;const c=u.items.find(d=>d.type==="tool"&&d.system.toolType===t);return(c==null?void 0:c.system.bonus)||0;default:return 0}},getGroupResult(u,e,t,s,i){if(!u.every(c=>c.total!==null&&c.total!==void 0))return{complete:!1,success:!1,result:0};const l=E(),r=A.get(l.groupRollResultMode.tag)||1;let a;switch(r){case 1:return a=this.calculateStandardRule(u,e),{complete:!0,success:a.finalResult,result:a.finalResult?1:0,details:a};case 2:return a=this.calculateGroupAverage(u,e),{complete:!0,success:a.success,result:a.finalResult,details:a};case 3:return a=this.calculateLeaderWithHelp(u,e,t,s,i),{complete:!0,success:a.success,result:a.finalResult,details:a};case 4:return a=this.calculateWeakestLink(u,e,t,s,i),{complete:!0,success:a.success,result:a.finalResult,details:a};default:return a=this.calculateStandardRule(u,e),{complete:!0,success:a.finalResult,result:a.finalResult?1:0,details:a}}}};class Z extends pe(dnd5e.applications.dice.D20RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(e,t,s),n.log("constructor - initializing GM Dialog",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(e,t,s,i){n.log("_prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.showDC=this.showDC,o.dcValue=this.dcValue,o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return n.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(n.log("_onRender",[e,t]),super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const i={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await P.renderTemplate(`modules/${T}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}this._attachButtonListeners()}_attachButtonListeners(){n.log("_attachButtonListeners",[this.element]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(t=>{t.addEventListener("click",s=>{s.currentTarget.dataset.action})})}static async initConfiguration(e,t,s,i={}){var L,_,S,C,O,v,w,V,M;if(e=I.validateActors(e),!e)return null;const o=e[0];n.log("GMRollConfigDialog, initConfiguration",[]);const l=t==null?void 0:t.toLowerCase(),r=E(),a=A.get(r.publicPlayerRolls.tag)===!0,c=I.determineRollMode(a),d=I.shouldShowDC(l),f=I.getRollClass(l),p=I.createBaseRollConfig(o,t,s),h=I.createMessageConfig(o,c),m={options:{actors:e,sendRequest:e.some(H=>I.isPlayerOwned(H)),showDC:d,rollKey:s,rollType:f,rollTypeString:l,window:{title:Z._getRollTitle(l,s,o),subtitle:Z._getSubtitle(e)},...i}},R=await I.triggerRollDialog(this,p,h,m.options),y=I.processDialogResult(R,e,t,s,i);if(!y)return null;if((L=R.config)!=null&&L.ability&&[g.SKILL,g.TOOL].includes(l)){const H=((S=(_=o.system.skills)==null?void 0:_[s])==null?void 0:S.ability)||((O=(C=CONFIG.DND5E.skills)==null?void 0:C[s])==null?void 0:O.ability);R.config.ability!==H&&(y.ability=R.config.ability)}let b=m.options.window.title;if(R.config.ability&&[g.SKILL,g.TOOL].includes(l)){const H=((v=CONFIG.DND5E.abilities[R.config.ability])==null?void 0:v.label)||R.config.ability;if(l===g.SKILL){const z=((w=CONFIG.DND5E.skills[s])==null?void 0:w.label)||s;b=game.i18n.format("DND5E.SkillPromptTitle",{skill:z,ability:H})}else if(l===g.TOOL){const z=(M=(V=CONFIG.DND5E.enrichmentLookup)==null?void 0:V.tools)==null?void 0:M[s];let X=s;if(z!=null&&z.id){const F=dnd5e.documents.Trait.getBaseItem(z.id,{indexOnly:!0});X=(F==null?void 0:F.name)||s}b=game.i18n.format("DND5E.ToolPromptTitle",{tool:X,ability:H})}}return y.rollTitle=b,y.rollType=l,y.rollKey=s,y}static _getRollTitle(e,t,s){var l,r,a,c,d,f,p,h,m,R,y,b,L,_,S,C,O,v;n.log("GMRollConfigDialog._getRollTitle",[e,t,s]),n.log("GMRollConfigDialog._getRollTitle - Detailed",{rollType:e,rollKey:t,actorName:s==null?void 0:s.name,actorAbilities:(l=s==null?void 0:s.system)!=null&&l.abilities?Object.keys(s.system.abilities):[],actorSkills:(r=s==null?void 0:s.system)!=null&&r.skills?Object.keys(s.system.skills):[],actorInitAbility:(d=(c=(a=s==null?void 0:s.system)==null?void 0:a.attributes)==null?void 0:c.init)==null?void 0:d.ability});let i="";const o=e==null?void 0:e.toLowerCase();switch([g.SAVE,g.ABILITY,g.ABILITY_CHECK].includes(o)&&!t&&n.warn("Missing rollKey for roll type",[o,t]),o){case g.SKILL:const w=((f=CONFIG.DND5E.skills[t])==null?void 0:f.label)||t,V=(p=s==null?void 0:s.system.skills)==null?void 0:p[t],M=(V==null?void 0:V.ability)||((h=CONFIG.DND5E.skills[t])==null?void 0:h.ability)||"int",H=((m=CONFIG.DND5E.abilities[M])==null?void 0:m.label)||M;i=game.i18n.format("DND5E.SkillPromptTitle",{skill:w,ability:H});break;case g.SAVE:case g.SAVING_THROW:const z=((R=CONFIG.DND5E.abilities[t])==null?void 0:R.label)||t;i=game.i18n.format("DND5E.SavePromptTitle",{ability:z});break;case g.ABILITY:case g.ABILITY_CHECK:const X=((y=CONFIG.DND5E.abilities[t])==null?void 0:y.label)||t;i=game.i18n.format("DND5E.AbilityPromptTitle",{ability:X});break;case g.CONCENTRATION:i=game.i18n.localize("DND5E.Concentration");break;case g.TOOL:const F=(L=(b=CONFIG.DND5E.enrichmentLookup)==null?void 0:b.tools)==null?void 0:L[t];let ae=t;if(F!=null&&F.id){const Le=dnd5e.documents.Trait.getBaseItem(F.id,{indexOnly:!0});ae=(Le==null?void 0:Le.name)||t}const de=(_=s==null?void 0:s.system.tools)==null?void 0:_[t],ke=(de==null?void 0:de.ability)||((O=(C=(S=CONFIG.DND5E.enrichmentLookup)==null?void 0:S.tools)==null?void 0:C[t])==null?void 0:O.ability)||"int",Qe=((v=CONFIG.DND5E.abilities[ke])==null?void 0:v.label)||ke;i=game.i18n.format("DND5E.ToolPromptTitle",{tool:ae,ability:Qe});break;case g.DEATH_SAVE:i=game.i18n.localize("DND5E.DeathSave");break;case g.INITIATIVE:case g.INITIATIVE_DIALOG:i=game.i18n.localize("DND5E.Initiative");break;default:i=game.i18n.localize("DND5E.Roll")}return n.log("_getRollTitle",[o,i]),i}static _getSubtitle(e=[]){return e.length===1?e[0].name:e.length>1?game.i18n.localize("FLASH_ROLLS.ui.dialogs.multipleActors"):""}}class Be extends pe(dnd5e.applications.dice.RollConfigurationDialog){constructor(e={},t={},s={}){s.rollType=CONFIG.Dice.BasicRoll||Roll,s.showDC=!1,super(e,t,s),n.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(e,t,s,i){const o=super._prepareConfigurationData(e,t,s,i);return n.log("GMHitDieConfigDialog._prepareConfigurationData",[o]),o.formula="Hit Die (varies by actor)",o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length,t.formula="Hit Die (varies by actor)"),t}async _onRender(e,t){if(super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const i={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await P.renderTemplate(`modules/${T}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}}async _processSubmitData(e,t,s){await super._processSubmitData(e,t,s),this.sendRequest=s.get("flash5e-send-request")!=="false",n.log("_processSubmitData",[s,this.config])}_finalizeRolls(e){const t=super._finalizeRolls(e);return this.config.sendRequest=this.sendRequest,n.log("GMHitDieConfigDialog._finalizeRolls - before merge",[t]),t}static async initConfiguration(e,t,s,i={}){var m;if(e=I.validateActors(e),!e)return null;const o=e[0];n.log("GMHitDieConfigDialog, initConfiguration",[]);const l=E(),r=A.get(l.publicPlayerRolls.tag)===!0,a=I.determineRollMode(r),c={data:o.getRollData(),subject:o,rolls:[{parts:[],data:o.getRollData(),options:{flavor:"Hit Die Roll"}}]},d=I.createMessageConfig(o,a),f={options:{actors:e,sendRequest:e.some(R=>I.isPlayerOwned(R)),rollKey:s,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:Z._getSubtitle(e)},...i}},p=await I.triggerRollDialog(this,c,d,f.options);if(!(p!=null&&p.rolls)||p.rolls.length===0)return null;n.log("GMHitDieConfigDialog - dialog result",[p.rolls]);const h=I.processDialogResult(p,e,t,s,i);return h?((m=p.config)!=null&&m.ability&&(h.ability=p.config.ability),h):null}}class je extends pe(dnd5e.applications.dice.SkillToolRollConfigurationDialog){constructor(e={},t={},s={}){const i=foundry.utils.mergeObject(e,{chooseAbility:!0});s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(i,t,s),n.log("constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,i){n.log("_prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.showDC=this.showDC,o.dcValue=this.dcValue,o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return n.log("_preparePartContext",[e,t,s]),t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.showDC=this.showDC,t.dcValue=this.dcValue,t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(n.log("_onRender",[e,t]),super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const i={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await P.renderTemplate(`modules/${T}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}this._attachButtonListeners()}_attachButtonListeners(){n.log("_attachButtonListeners",[]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(t=>{t.addEventListener("click",s=>{s.currentTarget.dataset.action})})}static async initConfiguration(e,t,s,i={}){var L,_,S,C,O,v;if(e=I.validateActors(e),!e)return null;const o=e[0];n.log("GMSkillToolConfigDialog, initConfiguration",[]);const l=t==null?void 0:t.toLowerCase(),r=E(),a=A.get(r.publicPlayerRolls.tag)===!0,c=I.determineRollMode(a),d=I.shouldShowDC(l),f=CONFIG.Dice.D20Roll;let p=null;if(l===g.SKILL){const w=o.system.skills[s];p=(w==null?void 0:w.ability)||((L=CONFIG.DND5E.skills[s])==null?void 0:L.ability)||"int"}else if(l===g.TOOL){const w=(_=o.system.tools)==null?void 0:_[s];p=(w==null?void 0:w.ability)||((O=(C=(S=CONFIG.DND5E.enrichmentLookup)==null?void 0:S.tools)==null?void 0:C[s])==null?void 0:O.ability)||"int"}const h={data:o.getRollData(),subject:o,ability:p,chooseAbility:!0,rolls:[{parts:[],data:o.getRollData(),options:{}}]};l===g.SKILL?h.skill=s:l===g.TOOL&&(h.tool=s);const m=I.createMessageConfig(o,c),R={options:{actors:e,sendRequest:e.some(w=>I.isPlayerOwned(w)),showDC:d,rollKey:s,rollType:f,rollTypeString:l,window:{title:Z._getRollTitle(l,s,o),subtitle:Z._getSubtitle(e)},...i}},y=await I.triggerRollDialog(this,h,m,R.options),b=I.processDialogResult(y,e,t,s,i);return b?((v=y.config)!=null&&v.ability&&[g.SKILL,g.TOOL].includes(l)&&(b.ability=y.config.ability),b.rollTitle=R.options.window.title,b.rollType=l,b.rollKey=s,b):null}}class rt extends pe(dnd5e.applications.dice.DamageRollConfigurationDialog){constructor(e={},t={},s={}){const i=foundry.utils.mergeObject({configure:!0},e);super(i,t,s),n.log("GMDamageConfigDialog.constructor",[i,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","damage-roll","gm-roll-config"]})}_prepareConfigurationData(e,t,s,i){n.log("GMDamageConfigDialog._prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _onRender(e,t){if(await super._onRender(e,t),this.actors.length>0){const s=this.element.querySelector(".rolls + .dialog-buttons");if(s&&!this.element.querySelector(".gm-roll-config-fields")){const i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=`
          <div class="form-group">
            <label class="checkbox">
              <input type="checkbox" name="flash5e-send-request" ${this.sendRequest?"checked":""}>
              ${game.i18n.localize("FLASH_ROLLS.ui.dialogs.sendRequestToPlayers")}
            </label>
          </div>
        `,s.insertAdjacentElement("beforebegin",i)}}}static async initConfiguration(e,t,s,i={},o={},l={}){var v,w,V,M,H;if(e=I.validateActors(e),n.log("GMDamageConfigDialog, initConfiguration actors",[e]),!e)return null;const r=e[0];n.log("GMDamageConfigDialog, initConfiguration #0",[o]);const a=E(),c=A.get(a.publicPlayerRolls.tag)===!0,d=I.determineRollMode(c,o.rollMode),f=t==null?void 0:t.toLowerCase(),p={subject:o.subject||r,data:r.getRollData(),critical:o.critical||{},rolls:o.rolls||[{parts:[],data:r.getRollData(),options:{}}]};n.log("GMDamageConfigDialog, initConfiguration #1",[p]);const h=I.createMessageConfig(r,d);n.log("GMDamageConfigDialog, initConfiguration #2",[h]);const{position:m,...R}=(l==null?void 0:l.options)||{},y={options:{actors:e,sendRequest:e.some(z=>I.isPlayerOwned(z)),rollKey:s,rollType:CONFIG.Dice.DamageRoll,rollTypeString:f,window:{title:game.i18n.localize("DND5E.DamageRoll"),subtitle:Z._getSubtitle(e)},...R,...i}};n.log("GMDamageConfigDialog, initConfiguration #3",[y]);const b=await I.triggerRollDialog(this,p,h,y.options);if(n.log("GMDamageConfigDialog, initConfiguration #4",[b]),!(b!=null&&b.rolls)||b.rolls.length===0)return null;n.log("GMDamageConfigDialog, initConfiguration #5",[b]);const L=b.rolls[0],_=((v=L==null?void 0:L.data)==null?void 0:v.situational)||"",S=(w=L==null?void 0:L.options)==null?void 0:w.target,C={rolls:[{parts:[],data:_?{situational:_}:{},options:{...S&&{target:S},isCritical:((V=L==null?void 0:L.options)==null?void 0:V.isCritical)||(L==null?void 0:L.isCritical)||!1}}],subject:o.subject||r,target:S,isCritical:((M=L==null?void 0:L.options)==null?void 0:M.isCritical)||(L==null?void 0:L.isCritical)||!1,sendRequest:b.sendRequest,isRollRequest:b.sendRequest,skipRollDialog:i.skipRollDialog||!1,chatMessage:!0};n.log("GMDamageConfigDialog, initConfiguration #6",[C]);const O=I.determineRollMode(c,(H=b.message)==null?void 0:H.rollMode);return C.rollMode=O,C.rollTitle=y.options.window.title,C.rollType=f,C.rollKey=s,n.log("GMDamageConfigDialog, initConfiguration - result",[C]),C}}class ct extends pe(dnd5e.applications.dice.AttackRollConfigurationDialog){constructor(e={},t={},s={}){super(e,t,s),n.log("GMAttackConfigDialog.constructor",[e,t,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(e,t,s,i){n.log("GMAttackConfigDialog._prepareConfigurationData",[e,t,s,i]);const o=super._prepareConfigurationData(e,t,s,i);return o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(e,t,s){return t=await super._preparePartContext(e,t,s),e==="configuration"&&(t.sendRequest=this.sendRequest,t.actorCount=this.actors.length),t}async _onRender(e,t){if(await super._onRender(e,t),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const i={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await P.renderTemplate(`modules/${T}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}}_finalizeRolls(e){return this.config.sendRequest=this.sendRequest,!this.sendRequest&&this.config.isRollRequest&&(this.config.isRollRequest=!1),super._finalizeRolls(e)}static async initConfiguration(e,t,s,i={},o={},l={}){var V,M,H,z,X,F,ae;if(e=I.validateActors(e),!e)return null;const r=e[0];n.log("GMAttackConfigDialog, initConfiguration",[]);const a=E(),c=A.get(a.publicPlayerRolls.tag)===!0,d=t==null?void 0:t.toLowerCase(),f={subject:o.subject||r,data:r.getRollData(),rolls:[{parts:[],data:r.getRollData(),options:{}}]},p=I.determineRollMode(c),h=I.createMessageConfig(r,p),{position:m,...R}=(l==null?void 0:l.options)||{},y={options:{actors:e,sendRequest:e.some(de=>I.isPlayerOwned(de)),rollKey:s,rollType:CONFIG.Dice.D20Roll,rollTypeString:d,window:{title:game.i18n.localize("DND5E.Attack"),subtitle:Z._getSubtitle(e)},...R,...i}},b=await I.triggerRollDialog(this,f,h,y.options);if(n.log("GMAttackConfigDialog, initConfiguration",[b==null?void 0:b.sendRequest]),!(b!=null&&b.rolls)||b.rolls.length===0)return null;const L=b.rolls[0];let _=!1,S=!1;((V=L==null?void 0:L.options)==null?void 0:V.advantageMode)!==void 0&&(_=L.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,S=L.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const C=((M=L==null?void 0:L.data)==null?void 0:M.situational)||"",O=(H=L==null?void 0:L.options)==null?void 0:H.target,v={rolls:[{parts:[],data:C?{situational:C}:{},options:{...O&&{target:O},...((z=L==null?void 0:L.options)==null?void 0:z.ammunition)&&{ammunition:L.options.ammunition},...((X=L==null?void 0:L.options)==null?void 0:X.attackMode)&&{attackMode:L.options.attackMode},...((F=L==null?void 0:L.options)==null?void 0:F.mastery)!==void 0&&{mastery:L.options.mastery}}}],subject:o.subject||r,advantage:_,disadvantage:S,target:O,sendRequest:b.sendRequest,isRollRequest:b.sendRequest,skipDialog:i.skipDialogs||!1,chatMessage:!P.isModuleOn("midi-qol")||!0},w=I.determineRollMode(c,(ae=b.message)==null?void 0:ae.rollMode);return v.rollMode=w,v.rollTitle=y.options.window.title,v.rollType=d,v.rollKey=s,n.log("GMAttackConfigDialog, initConfiguration - SIMPLIFIED result",[v]),v}}const ce=class ce{static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}static getMidiQOL(){return this.isModuleActive("midi-qol")&&typeof MidiQOL<"u"?MidiQOL:null}static async prepareMidiQOLSettings(){let e=null;if(n.log("prepareMidiQOLSettings #0",[game.settings]),ce.isModuleActive("midi-qol")){n.log("prepareMidiQOLSettings #1",[MidiQOL]),e={autoFastForwardAbilityRolls:A.get("AutoFastForwardAbilityRolls","midi-qol")},clearTimeout(ce.midiTimeout),ce.midiTimeout=setTimeout(()=>{e&&A.set("AutoFastForwardAbilityRolls",e.autoFastForwardAbilityRolls,"midi-qol"),n.log("prepareMidiQOLSettings #timeout 1",[game.user.getFlag(T,"savedMidiQOLSettings")]),game.user.unsetFlag(T,"savedMidiQOLSettings"),n.log("prepareMidiQOLSettings #timeout 2",[game.user.getFlag(T,"savedMidiQOLSettings")])},4e3);try{n.log("prepareMidiQOLSettings #before",[A.get("AutoFastForwardAbilityRolls","midi-qol")]),await game.user.setFlag(T,"savedMidiQOLSettings",e),await A.set("AutoFastForwardAbilityRolls",!1,"midi-qol"),n.log("prepareMidiQOLSettings #after",[A.get("AutoFastForwardAbilityRolls","midi-qol"),MidiQOL])}catch(t){n.error("prepareMidiQOLSettings",[t])}finally{n.log("prepareMidiQOLSettings - saved temporary settings for MidiQOL",[])}}}};k(ce,"midiTimeout",null);let oe=ce;class ut{static findActivityForRoll(e,t){var o;if(!((o=e==null?void 0:e.system)!=null&&o.activities))return null;const s=e.system.activities;switch(t==null?void 0:t.toLowerCase()){case g.ATTACK:const l=s.getByType("attack");return(l==null?void 0:l[0])||null;case g.DAMAGE:const r=s.getByType("attack");if((r==null?void 0:r.length)>0)return r[0];const a=s.getByType("damage");if((a==null?void 0:a.length)>0)return a[0];const c=s.getByType("save");return(c==null?void 0:c.length)>0?c[0]:null;case g.ITEM_SAVE:const d=s.getByType("save");return(d==null?void 0:d[0])||null;default:return null}}static getActivitiesByType(e,t){var s;return(s=e==null?void 0:e.system)!=null&&s.activities?e.system.activities.getByType(t):[]}static hasActivityForRoll(e,t){return n.log("hasActivityForRoll",[e,t]),!!this.findActivityForRoll(e,t)}static async executeActivityRoll(e,t,s,i,o){var f,p,h,m,R,y,b,L;n.log("executeActivityRoll",[e,t,s,i,o]);const l=oe.isModuleActive("midi-qol"),r=e.items.get(s);if(!r)throw new Error(`Item ${s} not found on actor ${e.name}`);let a=null,c=null;if(i&&(a=(f=r.system.activities)==null?void 0:f.get(i)),a=a||this.findActivityForRoll(r,t),!a)throw new Error(`Activity not found on item ${r.name}`);n.log("executeActivityRoll - activity",[a,t]);const d=t==null?void 0:t.toLowerCase();if(a)switch(d){case g.ATTACK:n.log("executeActivityRoll - is attack activity",[o]);const _={attackMode:o.usage.attackMode,ammunition:o.usage.ammunition,mastery:o.usage.mastery,situational:(m=(h=(p=o.usage.rolls)==null?void 0:p[0])==null?void 0:h.data)==null?void 0:m.situational,advantage:o.usage.advantage,disadvantage:o.usage.disadvantage,rollMode:(R=o.message)==null?void 0:R.rollMode};await a.item.setFlag(T,"tempAttackConfig",_),n.log("executeActivityRoll - stored temp config as flag",[_]);try{if(o.message.create=!0,await a.use(o.usage,o.dialog,o.message),n.log("CRLNGN TEST",[o]),l&&oe.getMidiQOL())return}catch(S){n.error("executeActivityRoll - attack roll error",[S])}finally{await a.item.unsetFlag(T,"tempAttackConfig")}return;case g.DAMAGE:n.log("executeActivityRoll - damage roll",[a,o]),l||(o.message.create=!0),c={critical:o.usage.critical||{},situational:o.usage.rolls[0].data.situational||"",rollMode:(y=o.message)==null?void 0:y.rollMode,create:((b=o.message)==null?void 0:b.create)!==!1},(a.type===Te.SAVE||a!=null&&a.damageOnly)&&await a.use(o.usage,o.dialog,o.message),await a.item.setFlag(T,"tempDamageConfig",c),n.log("executeActivityRoll - damage config with situational",[c]);try{if(l){const S=oe.getMidiQOL();if(S){const C=(L=S.Workflow)==null?void 0:L.getWorkflow(a.uuid),O=await C.activity.rollDamage({...o,workflow:C});return}}else await a.rollDamage(c,o.dialog,o.message)}catch(S){n.error(["executeActivityRoll - damage roll error",S])}finally{await a.item.unsetFlag(T,"tempDamageConfig")}return;default:n.log("executeActivityRoll - unknown roll type",[d]);return}throw new Error(`No suitable method found for ${d} on item ${r.name}`)}static getActivityDisplayInfo(e){return n.log("getActivityDisplayInfo",[e]),e?{name:e.name||e.constructor.metadata.label,type:e.type,icon:e.constructor.metadata.icon,canAttack:e.type==="attack",canDamage:["attack","damage","save"].includes(e.type),canSave:e.type==="save"}:null}static getDamageFormula(e){var s,i;if(n.log("getDamageFormula",[e]),!((i=(s=e==null?void 0:e.damage)==null?void 0:s.parts)!=null&&i.length))return null;const t=e.damage.parts.map(o=>o.formula).filter(o=>o);return t.length>0?t.join(" + "):null}static async syntheticItemRoll(e,t={}){n.log("syntheticItemRoll",[e,t]);const s=oe.getMidiQOL();if(!s){n.warn("MidiQOL is not active");return}let i={consumeUsage:!1,consumeSpellSlot:!1},o={fastForward:!1,fastForwardAttack:!1,dialogOptions:{fastForward:!1,fastForwardAttack:!1},configureDialog:!0,workflowOptions:{fastForward:!1,fastForwardAttack:!1}};return t={...i,...t},await s.completeItemUse(e,t,o)}}const{ApplicationV2:dt,HandlebarsApplicationMixin:gt}=foundry.applications.api;class Oe extends gt(dt){constructor(e={}){super(e),this.formula=e.formula||"",this.readonly=e.readonly||!1,this.actor=e.actor,this.callback=e.callback,this.diceCounts={}}static get DEFAULT_OPTIONS(){return foundry.utils.mergeObject(super.DEFAULT_OPTIONS,{id:"flash5e-custom-roll-dialog",classes:["flash5e-dialog","flash5e-custom-roll-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:420,height:"auto"}})}_onClickAction(e,t){switch(t.dataset.action){case"rollDice":return this.rollDice(e,t);case"addDie":return this.addDie(e,t);case"cancel":return this.cancel(e,t)}}async _prepareContext(e={}){return{...await super._prepareContext(e),formula:this.formula,readonly:this.readonly}}_attachPartListeners(e,t,s){super._attachPartListeners(e,t,s);const i=t.querySelector("#custom-roll-formula"),o=t.querySelector("#formula-validation-message");i&&!this.readonly&&(i.addEventListener("input",l=>{this.formula=l.target.value.trim(),this.updateValidationMessage(o)}),this.formula&&this.updateValidationMessage(o))}updateValidationMessage(e){if(!e)return;if(!this.formula){e.textContent="&nbsp;",e.classList.remove("error","success");return}this.validateFormula(this.formula)?(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaValid"),e.classList.remove("error"),e.classList.add("success")):(e.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaInvalid"),e.classList.remove("success"),e.classList.add("error"))}addDie(e,t){const s=t.dataset.die,i=this.element.querySelector("#custom-roll-formula");if(!i)return;const o=i.value.trim();if(o){const l=/(\d*)d(\d+)/g,r=new Map;let a=o,c;for(;(c=l.exec(o))!==null;){const p=parseInt(c[1]||"1"),h=c[2];r.set(h,(r.get(h)||0)+p),a=a.replace(c[0],"").trim()}const d=s.substring(1);r.set(d,(r.get(d)||0)+1);const f=[];for(const[p,h]of r)f.push(`${h}d${p}`);a=a.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),a&&a!=="+"?this.formula=`${f.join(" + ")} + ${a}`:this.formula=f.join(" + ")}else this.formula=`1${s}`;i.value=this.formula,i.dispatchEvent(new Event("input"))}validateFormula(e){var t;if(!e||e.trim()==="")return!1;try{return Roll.validate(e)}catch{try{return new Roll(e,((t=this.actor)==null?void 0:t.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(n.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback(this.formula),this.close()}cancel(){this.close()}static async prompt(e={}){return new Promise(t=>{const s=new this({...e,callback:i=>t(i)});s.addEventListener("close",()=>{s._resolved||t(null)}),s.render(!0)})}async close(e={}){return this._resolved=!0,super.close(e)}}k(Oe,"PARTS",{main:{template:`modules/${K.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${K.ID}/templates/custom-roll-dialog-footer.hbs`}});class B{static async initialize(){n.log("ChatMessageUtils.initialize"),await this.preloadTemplate(),this.registerEventListeners()}static registerEventListeners(){const e=(t,s)=>{t.querySelectorAll(".actor-result").forEach(l=>{l.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();const a=l;n.log("actor-result click",[l]),a.classList.contains("expanded")?a.classList.remove("expanded"):a.classList.add("expanded")})});const i=t.querySelector(".group-roll-dc-control"),o=t.querySelector(".dc-input");if(i){const l=i.dataset.showToPlayers==="true";if(game.user.isGM||(i.style.display="none"),!game.user.isGM&&!l){const r=t.querySelector(".group-roll-footer .group-result-details");r&&(r.style.display="none")}}if(o)if(!game.user.isGM)o.readOnly=!0,o.style.cursor="not-allowed";else{let l=null;const r=async()=>{const a=parseInt(o.value);if(!o.value)return;if(isNaN(a)||a<1||a>99){o.value="";return}const c=o.dataset.messageId,d=game.messages.get(c);d&&await this.updateGroupRollDC(d,a)};o.addEventListener("input",a=>{l&&clearTimeout(l),l=setTimeout(()=>{r()},500)}),o.addEventListener("keypress",a=>{a.key==="Enter"&&(l&&clearTimeout(l),r())})}};Hooks.on(W.RENDER_CHAT_MESSAGE,(t,s)=>{t.getFlag(T,"isGroupRoll")&&e(s)}),Hooks.on(W.RENDER_CHAT_LOG,(t,s)=>{s.querySelectorAll(".flash5e-group-roll").forEach(o=>{const l=o.closest(".chat-message");if(l){const r=l.dataset.messageId,a=game.messages.get(r);a&&a.getFlag(T,"isGroupRoll")&&e(o)}})})}static async preloadTemplate(){n.log("ChatMessageUtils.preloadTemplate");try{await P.loadTemplates([this.templatePath])}catch(e){n.error("Failed to preload template",e)}}static async createGroupRollMessage(e,t,s,i,o){n.log("ChatMessageUtils.createGroupRollMessage",[e.length,t,s,o]);const l=this.buildGroupRollData(e,t,s,i);l.groupRollId=o;const r=e.some(d=>I.isPlayerOwnerActive(d)),a=r?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode");n.log("hasPlayerOwnedActor",[r,a]),this.pendingRolls.set(o,{actors:e.map(d=>d.id),rollType:t,rollKey:s,config:i,results:new Map});const c=await this.postGroupMessage(l,a);return c&&this.groupRollMessages.set(o,c),c}static buildGroupRollData(e,t,s,i){n.log("ChatMessageUtils.buildGroupRollData",[e.length,t,s,i]);let o=this._buildFlavorText(t,s,i);const l=(i==null?void 0:i.dc)||(i==null?void 0:i.target),r=e.map(f=>{var p,h;return{actorId:f.id,actorImg:f.img||((h=(p=f.prototypeToken)==null?void 0:p.texture)==null?void 0:h.src)||"icons/svg/mystery-man.svg",actorName:f.name,rolled:!1,showDice:!0,total:null,success:!1,failure:!1}}),a=I.shouldShowDC(t),c=E(),d=A.get(c.showGroupDCToPlayers.tag);return{flavor:o,results:r,showDC:l!=null,dc:l,rollType:t,rollKey:s,supportsDC:a,showDCToPlayers:d,actors:e.map(f=>f.id),moduleId:T}}static _buildFlavorText(e,t,s){var o,l,r,a,c;let i="";switch(e==null?void 0:e.toLowerCase()){case"ability":case"abilitycheck":const d=((o=CONFIG.DND5E.abilities[t])==null?void 0:o.label)||t;i=game.i18n.format("DND5E.AbilityPromptTitle",{ability:d});break;case"save":case"savingthrow":const f=((l=CONFIG.DND5E.abilities[t])==null?void 0:l.label)||t;i=game.i18n.format("DND5E.SavePromptTitle",{ability:f});break;case"skill":const p=((r=CONFIG.DND5E.skills[t])==null?void 0:r.label)||t,h=(s==null?void 0:s.ability)||((a=CONFIG.DND5E.skills[t])==null?void 0:a.ability)||"int",m=((c=CONFIG.DND5E.abilities[h])==null?void 0:c.label)||h;i=game.i18n.format("DND5E.SkillPromptTitle",{skill:p,ability:m});break;case"tool":i=`Tool Check: ${t}`;break;case"initiative":i=game.i18n.localize("DND5E.Initiative");break;case"attack":i=(s==null?void 0:s.flavor)||"Attack Roll";break;case"damage":i=(s==null?void 0:s.flavor)||"Damage Roll";break;default:i=(s==null?void 0:s.flavor)||"Roll Request"}return i}static async postGroupMessage(e,t=null){n.log("ChatMessageUtils.postGroupMessage",[e,t]);try{const i={content:await P.renderTemplate(this.templatePath,e),speaker:{alias:"Group Roll"},flags:{[T]:{isGroupRoll:!0,groupRollId:e.groupRollId,rollData:e}}};return t&&ChatMessage.applyRollMode(i,t),await ChatMessage.create(i)}catch(s){return n.error("Failed to post group message",s),null}}static async updateGroupRollMessage(e,t,s){var d;if(n.log("ChatMessageUtils.updateGroupRollMessage",[e,t,s.total,game.user.isGM]),!game.user.isGM)return;let i=this.groupRollMessages.get(e),o=this.pendingRolls.get(e);if(i||(i=game.messages.contents.find(p=>p.getFlag(T,"groupRollId")===e&&p.getFlag(T,"isGroupRoll")),i&&(this.groupRollMessages.set(e,i),n.log("updateGroupRollMessage - Found and registered group message",[e]),o||(o={actors:i.getFlag(T,"rollData").results.map(h=>h.actorId),results:new Map},this.pendingRolls.set(e,o)))),!i){n.log("No group message found for groupRollId",e);return}o&&o.results&&o.results.set(t,{total:s.total,roll:s});const l=i.getFlag(T,"rollData"),r=l.results.findIndex(f=>f.actorId===t);if(r!==-1){l.results[r].rolled=!0,l.results[r].showDice=!1,l.results[r].total=s.total;try{l.results[r].rollBreakdown=await s.render()}catch(f){n.error("Error rendering roll breakdown",f),l.results[r].rollBreakdown=null}l.showDC&&l.dc&&(l.results[r].success=s.total>=l.dc,l.results[r].failure=s.total<l.dc)}l.allRolled=l.results.every(f=>f.rolled),l.messageId=i.id,l.supportsDC=I.shouldShowDC(l.rollType);const a=E();if(l.showDCToPlayers=A.get(a.showGroupDCToPlayers.tag),l.supportsDC&&l.showDC&&l.dc){const f=((d=l.actors)==null?void 0:d.map(h=>game.actors.get(h)).filter(h=>h))||[],p=I.getGroupResult(l.results,l.dc,f,l.rollType,l.rollKey);l.groupResult=p,n.log("updateGroupRollMessage - COMPLETE?",[p.complete]),p.complete&&p.details&&(l.groupSummary=p.details.summary)}const c=await P.renderTemplate(this.templatePath,l);await i.update({content:c,flags:{[T]:{rollData:l}}}),o!=null&&o.results&&(o!=null&&o.actors)&&o.results.size===o.actors.length&&(this.pendingRolls.delete(e),setTimeout(()=>{this.groupRollMessages.delete(e)},6e4))}static async updateGroupRollDC(e,t){var a;const s=e.getFlag(T,"rollData");if(!s||(s.supportsDC=I.shouldShowDC(s.rollType),!s.supportsDC))return;s.dc=t,s.showDC=!0,s.results.forEach(c=>{c.rolled&&c.total!==null&&(c.success=c.total>=t,c.failure=c.total<t)});const i=((a=s.actors)==null?void 0:a.map(c=>game.actors.get(c)).filter(c=>c))||[],o=I.getGroupResult(s.results,t,i,s.rollType,s.rollKey);s.groupResult=o,o.complete&&o.details&&(s.groupSummary=o.details.summary),s.allRolled=s.results.every(c=>c.rolled),s.messageId=e.id;const l=E();s.showDCToPlayers=A.get(l.showGroupDCToPlayers.tag);const r=await P.renderTemplate(this.templatePath,s);await e.update({content:r,flags:{[T]:{rollData:s}}})}static interceptRollMessage(e,t,s){var d,f,p;n.log("ChatMessageUtils.interceptRollMessage",[e,s]);const i=E();if(!A.get(i.groupRollsMsgEnabled.tag))return;const l=(d=e.speaker)==null?void 0:d.actor,r=game.actors.get(l);if(!l||!r)return;const a=e.getFlag(T,"groupRollId")||((f=r.getFlag(T,"tempInitiativeConfig"))==null?void 0:f.groupRollId);if(!a){n.log("interceptRollMessage - no groupRollId in flag");return}if(!game.user.isGM&&!this.groupRollMessages.has(a)){const m=game.messages.contents.find(R=>R.getFlag(T,"groupRollId")===a&&R.getFlag(T,"isGroupRoll"));m&&(this.groupRollMessages.set(a,m),n.log("interceptRollMessage - Registered group roll message",[a]))}if(!this.groupRollMessages.has(a)){n.log("interceptRollMessage - groupRollId not in map",[a,Array.from(this.groupRollMessages.keys())]);return}const c=(p=e.rolls)==null?void 0:p[0];if(c)if(t&&t instanceof HTMLElement&&t.style&&(t.style.display="none"),game.user.isGM){this.updateGroupRollMessage(a,l,c);const h=e.id;if(this.messagesScheduledForDeletion.has(h))return;this.messagesScheduledForDeletion.add(h),h&&setTimeout(async()=>{n.log("interceptRollMessage - deletion",[h]);try{game.messages.get(h)?(await e.delete(),n.log("interceptRollMessage - Deleted individual message",[h])):n.log("interceptRollMessage - Message already deleted",[h])}catch(m){n.log("interceptRollMessage - Error deleting message",[h,m.message])}finally{this.messagesScheduledForDeletion.delete(h)}},500)}else n.log("interceptRollMessage - Player roll intercepted, GM will handle update",[a])}static isGroupRoll(e){return this.pendingRolls.has(e)||this.groupRollMessages.has(e)}static async addGroupRollFlag(e,t,s=null){const i=E(),o=A.get(i.groupRollsMsgEnabled.tag);if(n.log("addGroupRollFlag called",[e,t.groupRollId,this.isGroupRoll(t.groupRollId)]),!game.user.isGM&&t.groupRollId&&s&&(await s.setFlag(T,"tempGroupRollId",t.groupRollId),n.log("addGroupRollFlag - Stored tempGroupRollId on actor for player",[t.groupRollId,s.id]),!this.groupRollMessages.has(t.groupRollId))){const r=game.messages.contents.find(a=>a.getFlag(T,"groupRollId")===t.groupRollId&&a.getFlag(T,"isGroupRoll"));r&&(this.groupRollMessages.set(t.groupRollId,r),n.log("addGroupRollFlag - Registered group roll message on player side",[t.groupRollId]))}o&&t.groupRollId&&(!game.user.isGM||this.isGroupRoll(t.groupRollId))&&(e.data=e.data||{},e.data.flags=e.data.flags||{},e.data.flags[T]=e.data.flags[T]||{},e.data.flags[T].groupRollId=t.groupRollId,n.log("addGroupRollFlag - Added flag to messageConfig",[e]))}static cleanup(){const e=Date.now()-3e5;for(const[t,s]of this.groupRollMessages.entries())s.timestamp<e&&(this.groupRollMessages.delete(t),this.pendingRolls.delete(t))}}k(B,"groupRollMessages",new Map),k(B,"pendingRolls",new Map),k(B,"messagesScheduledForDeletion",new Set),k(B,"templatePath","modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs");const U={ability:async(u,e,t,s,i)=>{var l;n.log("RollHandlers.ability #1",[t]);const o=I.buildRollConfig(e,t,{ability:e.rollKey});n.log("RollHandlers.ability #2",[(l=o.rolls)==null?void 0:l[0]]),n.log("RollHandlers.ability - messageConfig",i),await B.addGroupRollFlag(i,e,u),await u.rollAbilityCheck(o,s,i)},abilitycheck:async(u,e,t,s,i)=>U.ability(u,e,t,s,i),save:async(u,e,t,s,i)=>{var l;const o=I.buildRollConfig(e,t,{ability:((l=e.config)==null?void 0:l.ability)||e.rollKey});await B.addGroupRollFlag(i,e,u),await u.rollSavingThrow(o,s,i)},savingthrow:async(u,e,t,s,i)=>U.save(u,e,t,s,i),skill:async(u,e,t,s,i)=>{var r,a,c,d,f,p;n.log("RollHandlers.skill #1",[e,t,s]);const o=((a=(r=u.system.skills)==null?void 0:r[e.rollKey])==null?void 0:a.ability)||((d=(c=CONFIG.DND5E.skills)==null?void 0:c[e.rollKey])==null?void 0:d.ability)||void 0,l=I.buildRollConfig(e,t,{skill:e.rollKey,chooseAbility:s.configure!==!1,ability:e.config.ability||o});if(e.config.ability&&s.configure===!1){const h=((f=CONFIG.DND5E.skills[e.rollKey])==null?void 0:f.label)||e.rollKey,m=((p=CONFIG.DND5E.abilities[e.config.ability])==null?void 0:p.label)||e.config.ability,R=game.i18n.format("DND5E.SkillPromptTitle",{skill:h,ability:m});i.data=i.data||{},i.data.flavor=R}n.log("RollHandlers.skill #2",[l,s,i]),await B.addGroupRollFlag(i,e,u),await u.rollSkill(l,s,i)},tool:async(u,e,t,s,i)=>{var a,c,d,f,p,h,m;n.log("RollHandlers.tool #1",[e,t]);const o=(a=u.system.tools)==null?void 0:a[e.rollKey],l=(o==null?void 0:o.ability)||((f=(d=(c=CONFIG.DND5E.enrichmentLookup)==null?void 0:c.tools)==null?void 0:d[e.rollKey])==null?void 0:f.ability)||"int",r=I.buildRollConfig(e,t,{tool:e.rollKey,chooseAbility:s.configure!==!1,ability:e.config.ability||l});if(e.config.ability&&s.configure===!1){const R=(h=(p=CONFIG.DND5E.enrichmentLookup)==null?void 0:p.tools)==null?void 0:h[e.rollKey];let y=e.rollKey;if(R!=null&&R.id){const _=dnd5e.documents.Trait.getBaseItem(R.id,{indexOnly:!0});y=(_==null?void 0:_.name)||e.rollKey}const b=((m=CONFIG.DND5E.abilities[e.config.ability])==null?void 0:m.label)||e.config.ability,L=game.i18n.format("DND5E.ToolPromptTitle",{tool:y,ability:b});i.data=i.data||{},i.data.flavor=L}n.log("RollHandlers.tool #2",[r,s,i]),await B.addGroupRollFlag(i,e,u),await u.rollToolCheck(r,s,i)},concentration:async(u,e,t,s,i)=>{const o=I.buildRollConfig(e,t);await B.addGroupRollFlag(i,e,u),await u.rollConcentration(o,s,i)},attack:async(u,e,t,s,i)=>{await U.handleActivityRoll(u,g.ATTACK,e,t,s,i)},damage:async(u,e,t,s,i)=>{await U.handleActivityRoll(u,g.DAMAGE,e,t,s,i)},itemsave:async(u,e,t,s,i)=>{await U.handleActivityRoll(u,g.ITEM_SAVE,e,t,s,i)},initiative:async(u,e,t,s,i)=>{var l,r,a;if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));return}e.config.situational||(l=t.data)!=null&&l.situational,e.groupRollId;let o=u;if(!u.isToken){const c=canvas.tokens.placeables.find(d=>{var f;return((f=d.actor)==null?void 0:f.id)===u.id});if(c)o=c.actor;else{ui.notifications.error(game.i18n.format("COMBAT.NoneActive"));return}}await B.addGroupRollFlag(i,e,u),n.log("RollHandlers.initiative - START",[u,e,t,s]);try{if(s.configure){if(n.log("RollHandlers.initiative - Dialog",[]),e.config){const c=I.buildRollConfig(e,t,{ability:((a=(r=u.system.attributes)==null?void 0:r.init)==null?void 0:a.ability)||"dex"}),d={advantage:e.config.advantage||!1,disadvantage:e.config.disadvantage||!1,rollMode:e.config.rollMode||game.settings.get("core","rollMode"),rolls:c.rolls,groupRollId:e.groupRollId};await u.setFlag(T,"tempInitiativeConfig",d),await o.setFlag(T,"tempInitiativeConfig",d)}await o.rollInitiativeDialog()}else{n.log("RollHandlers.initiative - Not dialog");const c={rollMode:e.config.rollMode||game.settings.get("core","rollMode"),groupRollId:e.groupRollId};await u.setFlag(T,"tempInitiativeConfig",c),await o.setFlag(T,"tempInitiativeConfig",c);const d={createCombatants:!0,rerollInitiative:!0};await o.rollInitiative(d)}n.log("RollHandlers.initiative - COMPLETE")}catch(c){n.error("RollHandlers.initiative - Error",[c]),q.notify("error",`Initiative roll failed: ${c.message}`)}},initiativedialog:async(u,e,t,s,i)=>U.initiative(u,e,t,s,i),deathsave:async(u,e,t,s,i)=>{const o=I.buildRollConfig(e,t);await B.addGroupRollFlag(i,e,u),await u.rollDeathSave(o,s,i)},hitdie:async(u,e,t,s,i)=>{s.configure=game.user.isGM?s.configure:!0;const o=I.buildRollConfig(e,t,{denomination:e.rollKey});n.log("RollHandlers.hitdie",[o,s,i]),await u.rollHitDie(o,s,i)},custom:async(u,e,t,s,i)=>{await U.handleCustomRoll(u,e,s,i)},async handleActivityRoll(u,e,t,s,i,o){var l,r;if(n.log("RollHandlers.handleActivityRoll",[e,t,s]),t.rollKey){const a=I.buildRollConfig(t,s),c=((r=(l=a.rolls)==null?void 0:l[0])==null?void 0:r.options)||{},d={usage:{...t.config,rolls:a.rolls,...c.attackMode&&{attackMode:c.attackMode},...c.ammunition&&{ammunition:c.ammunition},...c.mastery!==void 0&&{mastery:c.mastery}},dialog:i,message:o};n.log("handleActivityRoll - final activity config",[d]),await ut.executeActivityRoll(u,e,t.rollKey,t.activityId,d)}},async handleCustomRoll(u,e,t,s){var l,r,a;const i=e.rollKey;if((t==null?void 0:t.configure)===!1){try{const c=new Roll(i,u.getRollData());c.options=c.options||{},c.options.isRollRequest=((l=e.config)==null?void 0:l.isRollRequest)!==!1,await c.evaluate({async:!0}),await c.toMessage({speaker:ChatMessage.getSpeaker({actor:u}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${g.CUSTOM}`),rollMode:(s==null?void 0:s.rollMode)||((r=e.config)==null?void 0:r.rollMode)||game.settings.get("core","rollMode"),isRollRequest:((a=e.config)==null?void 0:a.isRollRequest)!==!1,create:(s==null?void 0:s.create)!==!1})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:i}))}return}new Oe({formula:i,readonly:!0,actor:u,callback:async c=>{try{const d=new Roll(c,u.getRollData());d.options=d.options||{},d.options.isRollRequest=!0,await d.evaluate({async:!0}),await d.toMessage({speaker:ChatMessage.getSpeaker({actor:u}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${g.CUSTOM}`),rollMode:e.config.rollMode,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:e.config.requestedBy||"GM"})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:c}))}}}).render(!0)},async handleHitDieRecovery(u){const e=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in e&&(e.deltas.hitDice=e.dhd),u._getRestHitDiceRecovery({maxHitDice:u.system.attributes.hd.max,type:"long"},e),e.dhd=e.deltas.hitDice,e.longRest=!0;try{if(e.updateData&&Object.keys(e.updateData).length>0){const t=await u.update(e.updateData,{isRest:!1})}else n.log("No actor updates to perform",[]);if(e.updateItems&&e.updateItems.length>0){const t=await u.updateEmbeddedDocuments("Item",e.updateItems,{isRest:!1})}else n.log("No item updates to perform",[])}catch(t){throw n.error("Error during updates in handleHitDieRecovery:",[t]),t}return n.log("handleHitDieRecovery #3",[e]),e}};async function $e(){return game.combat||(await(await Combat.create({scene:game.scenes.active.id})).activate(),q.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.combatCreated"))),game.combat}async function Ue(u,e){if(!e.combat)return u;const t=u.map(o=>e.actors.get(o)).filter(o=>o),s=[],i=new Set;for(const o of t)e.combat.getCombatantsByActor(o.id).some(a=>a.initiative!==null)&&(s.push(o.name),i.add(o.id));if(n.log("filterActorsForInitiative",[s]),s.length>0)if(await foundry.applications.api.DialogV2.confirm({window:{title:e.i18n.localize("FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle"),classes:["flash5e-dialog"]},content:"<p>"+e.i18n.format("FLASH_ROLLS.ui.dialogs.rerollInitiative",{actors:s.join(", ")})+"</p>",rejectClose:!1,modal:!0})){if(e.user.isGM)for(const l of i){const r=e.combat.getCombatantsByActor(l);n.log("filterActorsForInitiative - resetting initiative for combatants",[r]);for(const a of r)await a.update({initiative:null})}else n.log("filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll");return u}else{const l=u.filter(r=>!i.has(r));return l.length===0&&q.notify("info",e.i18n.localize("FLASH_ROLLS.notifications.allActorsHaveInitiative")),l}return u}class We{static initialize(){n.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){n.log("RollInterceptor.registerHooks"),this._registerHook(N.PRE_ROLL_ABILITY_CHECK,this._handlePreRoll.bind(this,g.ABILITY)),this._registerHook(N.PRE_ROLL_SAVING_THROW,this._handlePreRoll.bind(this,g.SAVE)),this._registerHook(N.PRE_ROLL_SKILL_V2,this._handlePreRoll.bind(this,g.SKILL)),this._registerHook(N.PRE_ROLL_TOOL_V2,this._handlePreRoll.bind(this,g.TOOL)),this._registerHook(N.PRE_ROLL_ATTACK_V2,this._handlePreRoll.bind(this,g.ATTACK)),this._registerHook(N.PRE_ROLL_DAMAGE_V2,this._handlePreRoll.bind(this,g.DAMAGE)),this._registerHook(N.PRE_ROLL_DEATH_SAVE_V2,this._handlePreRoll.bind(this,g.DEATH_SAVE)),this._registerHook(N.PRE_ROLL_HIT_DIE_V2,this._handlePreRoll.bind(this,g.HIT_DIE)),this._registerHook(N.PRE_ROLL_INITIATIVE,this._handlePreRollInitiative.bind(this,g.INITIATIVE)),this._registerHook(N.PRE_ROLL_INITIATIVE_DIALOG,this._handlePreRollInitiative.bind(this,g.INITIATIVE)),this._registerHook(N.ROLL_INITIATIVE,this._handleRollInitiative.bind(this,g.INITIATIVE))}static _registerHook(e,t){n.log("RollInterceptor._registerHook");const s=Hooks.on(e,t);this.registeredHooks.add({hookName:e,hookId:s})}static unregisterHooks(){n.log("RollInterceptor.unregisterHooks");for(const{hookName:e,hookId:t}of this.registeredHooks)Hooks.off(e,t);this.registeredHooks.clear()}static _handlePreRollInitiative(e,t,s){n.log("_handlePreRollInitiative",[e,t,s])}static _handlePreRoll(e,t,s,i){var p,h,m,R,y,b,L,_,S;if(n.log("_handlePreRoll #0",[e,t,s,i]),!game.user.isGM||t.isRollRequest===!1)return;const o=P.isModuleOn(T,"midi-qol"),l=(t==null?void 0:t.hookNames)||(s==null?void 0:s.hookNames)||(i==null?void 0:i.hookNames)||[],r=l.includes("initiativeDialog")||l.includes("initiative");if(e===g.ATTACK){const C=(h=(p=t.subject)==null?void 0:p.item)==null?void 0:h.getFlag(T,"tempAttackConfig");if(n.log("_handlePreRoll - is Attack roll",[(m=t.subject)==null?void 0:m.item,C]),C){n.log("_handlePreRoll - found module flags, skipping interception",[C]);return}}if(e===g.DAMAGE){const C=(y=(R=t.subject)==null?void 0:R.item)==null?void 0:y.getFlag(T,"tempDamageConfig");if(n.log("RollInterceptor._handlePreRoll - is Damage roll",[(b=t.subject)==null?void 0:b.item,C]),C){n.log("RollInterceptor._handlePreRoll - found module flags, skipping interception",[C]);return}}if(r&&e===g.ABILITY&&(n.log("RollInterceptor._handlePreRoll - Overriding ability to initiative",[l]),e=g.INITIATIVE),t!=null&&t.isRollRequest||t.sendRequest===!1||s!=null&&s.isRollRequest||i!=null&&i.isRollRequest)return;let a;if(e===g.INITIATIVE&&t instanceof Actor){if(a=t,n.log("_handlePreRoll - Initiative",[t,s,i]),(s==null?void 0:s.isRollRequest)===!1||(i==null?void 0:i.isRollRequest)===!1)return}else e===g.HIT_DIE?a=((L=s==null?void 0:s.subject)==null?void 0:L.actor)||(s==null?void 0:s.subject)||(s==null?void 0:s.actor):e===g.ATTACK||e===g.DAMAGE?a=(_=t.subject)==null?void 0:_.actor:a=((S=t.subject)==null?void 0:S.actor)||t.subject||t.actor;const c=E();if(!A.get(c.rollInterceptionEnabled.tag)||!a||a.documentName!=="Actor")return;const f=P.getActorOwner(a);if(n.log("_handlePreRoll - ownership",[f]),!((!f||!f.active||f.id===game.user.id||s.configure===!1||t.isRollRequest===!1||t.skipRollDialog===!0||t.fastForward===!0)&&(n.log("_handlePreRoll - skipping interception",[s.configure,t.midiOptions]),!o)))return n.log("_handlePreRoll - intercepting roll #1",[t,i]),e===g.ATTACK&&(i={...i,rollMode:CONST.DICE_ROLL_MODES.PUBLIC}),n.log("_handlePreRoll - intercepting roll #2",[t,i]),this._showGMConfigDialog(a,f,e,t,s,i),!1}static _handleRollInitiative(e,t,s,i,o){n.log("_handleRollInitiative",[e,t,s,i,o])}static async _showGMConfigDialog(e,t,s,i,o,l){var c,d,f,p,h,m,R,y,b,L,_;n.log("_showGMConfigDialog - config",[s,i]);const r=E();A.get(r.rollInterceptionEnabled.tag);const a=A.get(r.rollRequestsEnabled.tag);try{const S=s==null?void 0:s.toLowerCase();if(S===g.INITIATIVE&&(!game.combat&&!await $e()||(await Ue([e.id],game)).length===0))return;let C;[g.SKILL,g.TOOL].includes(S)?C=je:S===g.HIT_DIE?C=Be:S===g.ATTACK?C=ct:S===g.DAMAGE?C=rt:C=Z;let O={rolls:[{parts:[],data:{},options:{}}]};const v=E(),w=A.get(v.skipRollDialog.tag),V={actors:[e],rollType:S,showDC:!0,sendRequest:!0,skipRollDialog:w};n.log("_showGMConfigDialog #3",[O,V]);let M;if(w)M={sendRequest:!0,advantage:!1,disadvantage:!1,situational:"",rollMode:game.settings.get("core","rollMode")};else{let F=null;switch(S){case g.SKILL:O.skill=i.skill,O.ability=i.ability||((c=i.subject)==null?void 0:c.ability),F=O.skill;break;case g.TOOL:O.tool=i.tool,O.ability=i.ability||((d=i.subject)==null?void 0:d.ability),F=O.tool;break;case g.ABILITY:case g.SAVE:O.ability=i.ability||((f=i.subject)==null?void 0:f.ability),F=O.ability,O.ability==="con"&&i.targetValue!==void 0&&(s=g.CONCENTRATION);break;case g.CONCENTRATION:O.ability="con",F="con";break;case g.INITIATIVE:case g.INITIATIVE_DIALOG:F=((h=(p=e.system.attributes)==null?void 0:p.init)==null?void 0:h.ability)||"dex";break;case g.HIT_DIE:O.denomination=typeof i=="string"?i:i.denomination||((m=i.subject)==null?void 0:m.denomination),F=O.denomination;break;case g.ATTACK:o!=null&&o.options&&(O.ammunition=o.options.ammunition,O.attackMode=o.options.attackMode,O.mastery=o.options.mastery),F=(y=(R=i.subject)==null?void 0:R.item)==null?void 0:y.id;break;case g.DAMAGE:O.item=(b=i.subject)==null?void 0:b.item,O.subject=i.subject,O.critical=i.critical||{},F=(_=(L=i.subject)==null?void 0:L.item)==null?void 0:_.id;break;default:break}if(n.log("_showGMConfigDialog #4",[O,a]),!C.initConfiguration)throw n.error("DialogClass.initConfiguration not found",[C,C.name]),new Error(`DialogClass ${C.name} does not have initConfiguration method`);S===g.ATTACK||S===g.DAMAGE?M=await C.initConfiguration([e],S,F,{skipRollDialog:!1,sendRequest:a},i,o):M=await C.initConfiguration([e],S,F,{skipRollDialog:!1,sendRequest:a}),n.log("_showGMConfigDialog #4",[O])}if(!M){n.log("_showGMConfigDialog - Dialog cancelled");return}if(n.log("_showGMConfigDialog - sending _executeInterceptedRoll",[s,i,M]),!M.sendRequest||!a){await this._executeInterceptedRoll(e,s,i,M);return}const{event:H,...z}=i,X={...z,...M,rolls:M.rolls,requestedBy:game.user.name,...s===g.ATTACK&&{chatMessage:!1}};this._sendRollRequest(e,t,s,X)}catch(S){n.error("RollInterceptor._showGMConfigDialog - Error",[S]),this._sendRollRequest(e,t,s,i)}}static async _executeInterceptedRoll(e,t,s,i){var p,h,m,R,y,b,L,_,S,C,O,v,w,V;n.log("RollInterceptor._executeInterceptedRoll",[e,t,s,i]);const o=t==null?void 0:t.toLowerCase(),l=((p=i.rolls)==null?void 0:p[0])||{parts:[],data:{},options:{}},r=((h=l.data)==null?void 0:h.situational)||i.situational||"";let a;switch(o){case g.SKILL:a=s.skill;break;case g.TOOL:a=s.tool;break;case g.ABILITY:case g.SAVE:a=s.ability||((m=s.subject)==null?void 0:m.ability);break;case g.HIT_DIE:a=s.denomination;break;default:a=s.ability||s.skill||s.tool||s.denomination}const c={rollKey:a,config:{advantage:i.advantage||s.advantage,disadvantage:i.disadvantage||s.disadvantage,target:i.target||i.dc||s.target,rollMode:i.rollMode||s.rollMode,situational:r,isRollRequest:!1,ability:s.ability}};if(o===g.SKILL&&!c.config.ability)c.config.ability=((y=(R=e.system.skills)==null?void 0:R[c.rollKey])==null?void 0:y.ability)||((L=(b=CONFIG.DND5E.skills)==null?void 0:b[c.rollKey])==null?void 0:L.ability);else if(o===g.TOOL&&!c.config.ability){const M=(_=e.system.tools)==null?void 0:_[c.rollKey];c.config.ability=(M==null?void 0:M.ability)||((O=(C=(S=CONFIG.DND5E.enrichmentLookup)==null?void 0:S.tools)==null?void 0:C[c.rollKey])==null?void 0:O.ability)||"int"}else(o===g.ABILITY||o===g.SAVE)&&!c.config.ability&&(c.config.ability=c.rollKey);n.log("RollInterceptor._executeInterceptedRoll - requestData",[c,s,i]);const d={configure:!1,isRollRequest:!1},f={rollMode:c.config.rollMode,create:!0,isRollRequest:!1};try{const M=g,H=U[o];n.log("RollInterceptor._executeInterceptedRoll - handler 1",[H,o,U[o]]),H?((o===g.ATTACK||o===g.DAMAGE||o===g.SAVE)&&(c.rollKey=(w=(v=s.subject)==null?void 0:v.item)==null?void 0:w.id,c.activityId=(V=s.subject)==null?void 0:V.id),n.log("RollInterceptor._executeInterceptedRoll - handler 2",[c,l,d,f]),await H(e,c,l,d,f)):n.warn(`No handler found for roll type: ${o}`)}catch(M){n.error("RollInterceptor._executeInterceptedRoll",[M])}}static async _sendRollRequest(e,t,s,i){var p;n.log("_sendRollRequest",[e,t,s,i]),n.log("_sendRollRequest - config.rolls check",[i.rolls]);const o=E(),l=A.get(o.skipRollDialog);let r=s==null?void 0:s.toLowerCase();r===g.INITIATIVE&&(r=g.INITIATIVE_DIALOG);let a=null,c=null;switch(r){case g.ABILITY:case g.SAVE:a=i.ability;break;case g.SKILL:a=i.skill;break;case g.TOOL:a=i.tool;break;case g.ATTACK:case g.DAMAGE:n.log("_sendRollRequest - Attack/Damage roll config",[s,i]),a=(p=i.subject.item)==null?void 0:p.id,c=i.subject.id;break;case g.HIT_DIE:a=typeof i=="string"?i:i.denomination;break;case g.INITIATIVE_DIALOG:case g.INITIATIVE:a=null;break;case g.DEATH_SAVE:a=null;break;default:n.warn(`Unknown roll type: ${s}`);return}const d={...i};delete d.subject,delete d.workflow,delete d.item,delete d.activity;const f={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:e.id,rollType:r,rollKey:a,activityId:c,rollProcessConfig:{...d,_requestedBy:game.user.name},skipRollDialog:l,targetTokenIds:Array.from(game.user.targets).map(h=>h.id),preserveTargets:A.get(o.useGMTargetTokens.tag)};t&&f&&J.execForUser("handleRollRequest",t.id,f),ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:t.name,actor:e.name}))}}k(We,"registeredHooks",new Set);const{ApplicationV2:ft,HandlebarsApplicationMixin:pt}=foundry.applications.api;var Y;const te=class te extends pt(ft){constructor(t={}){n.log("RollRequestsMenu.constructor",[t]);super(t);k(this,"_onClickOutside",t=>{if(n.log("_onClickOutside"),this.isLocked)return;const s=this.element;s&&(t.target.closest(".flash-rolls-menu")||s.contains(t.target)||t.target.closest("#flash-rolls-icon")||t.target.closest(".dialog, .app, .notification, .application")||this.close())});this.selectedActors=new Set,this.currentTab="pc",this.selectedRequestType=null,this.isLocked=!1,this.optionsExpanded=game.user.getFlag(K.ID,"menuOptionsExpanded")??!1,this._initializeFromSelectedTokens()}async _prepareContext(t){n.log("_prepareContext");const s=await super._prepareContext(t),i=game.actors.contents,o=[],l=[],r=game.scenes.active;for(const y of i){if(y.type!=="character"&&y.type!=="npc")continue;const b={id:y.id,uuid:y.uuid,name:y.name,img:y.img,selected:this.selectedActors.has(y.id),crlngnStats:this._getActorStats(y)};Object.entries(y.ownership).some(([_,S])=>{const C=game.users.get(_);return C&&!C.isGM&&S>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})?o.push(b):r!=null&&r.tokens.some(S=>S.actorId===y.id)&&l.push(b)}const a=E(),c=A.get(a.rollRequestsEnabled.tag),d=A.get(a.skipRollDialog.tag),f=A.get(a.groupRollsMsgEnabled.tag),p=this.currentTab==="pc"?o:l,h=p.length>0&&p.every(y=>this.selectedActors.has(y.id)),m=[];if(this.selectedActors.size>0)for(const[y,b]of Object.entries(K.ROLL_REQUEST_OPTIONS))m.push({id:y,name:game.i18n.localize(`FLASH_ROLLS.rollTypes.${b.name}`)||b.label,rollable:b.subList==null,hasSubList:!!b.subList,selected:this.selectedRequestType===y});const R=lt(this.selectedRequestType,this.selectedActors);return{...s,actors:p,currentTab:this.currentTab,isPCTab:this.currentTab==="pc",isNPCTab:this.currentTab==="npc",selectedTab:this.currentTab,rollRequestsEnabled:c,skipRollDialog:d,groupRollsMsgEnabled:f,selectAllOn:h,hasSelectedActors:this.selectedActors.size>0,requestTypes:m,rollTypes:R,showNames:!0,actorsLocked:this.isLocked,optionsExpanded:this.optionsExpanded}}_getActorStats(t){var l,r,a,c,d,f;n.log("_getActorStats");const s=t.system,i=[];(l=s.attributes)!=null&&l.hp&&i.push({abbrev:"HP",value:s.attributes.hp.value}),(r=s.attributes)!=null&&r.ac&&i.push({abbrev:"AC",value:s.attributes.ac.value});const o=(c=(a=s.attributes)==null?void 0:a.spell)==null?void 0:c.dc;return o&&i.push({abbrev:"DC",value:o}),(f=(d=s.skills)==null?void 0:d.prc)!=null&&f.passive&&i.push({abbrev:"PRC",value:s.skills.prc.passive}),i}async _renderFrame(t){const s=await super._renderFrame(t),i=document.querySelector("#chat-notifications");return i&&s&&i.insertBefore(s,i.firstChild),s}_onRender(t,s){if(n.log("_onRender"),super._onRender(t,s),this._attachListeners(),ze(),this.optionsExpanded){const i=this.element.querySelector(".options-toggle"),o=this.element.querySelector("li.options");i==null||i.classList.add("expanded"),o==null||o.classList.add("expanded")}setTimeout(()=>{document.addEventListener("click",this._onClickOutside,!0)},100),this._tokenControlHook=Hooks.on("controlToken",this._onTokenControlChange.bind(this))}_onTokenControlChange(t,s){n.log("_onTokenControlChange"),this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{this._initializeFromSelectedTokens(),this.render(),this._tokenUpdateTimeout=null},100)))}_attachListeners(){var l,r,a,c,d,f;n.log("_attachListeners");const t=this.element;(l=t.querySelector("#flash-rolls-toggle"))==null||l.addEventListener("change",this._onToggleRollRequests.bind(this)),(r=t.querySelector("#flash5e-skip-dialogs"))==null||r.addEventListener("change",this._onToggleSkipDialogs.bind(this)),(a=t.querySelector("#flash5e-group-rolls-msg"))==null||a.addEventListener("change",this._onToggleGroupRollsMsg.bind(this)),(c=t.querySelector("#flash5e-actors-all"))==null||c.addEventListener("change",this._onToggleSelectAll.bind(this)),(d=t.querySelector("#flash5e-actors-lock"))==null||d.addEventListener("click",this._onToggleLock.bind(this)),(f=t.querySelector(".options-toggle"))==null||f.addEventListener("click",this._onToggleOptions.bind(this)),t.querySelectorAll(".actor-tab").forEach(p=>{p.addEventListener("click",this._onTabClick.bind(this))}),t.querySelectorAll(".actor").forEach(p=>{p.addEventListener("click",this._onActorClick.bind(this))}),t.querySelectorAll(".actor-select").forEach(p=>{p.addEventListener("click",this._onActorSelectClick.bind(this))});const i=t.querySelector(".request-types");i&&i.addEventListener("click",p=>{const h=p.target.closest("li");if(h&&h.dataset.id){const m={...p,currentTarget:h};this._onRequestTypeClick(m)}});const o=t.querySelector(".roll-types");o&&o.addEventListener("click",p=>{const h=p.target.closest("li");if(h&&h.dataset.id){const m={...p,currentTarget:h};this._onRollTypeClick(m)}})}async _onToggleRollRequests(t){n.log("_onToggleRollRequests");const s=E(),i=t.target.checked;await A.set(s.rollRequestsEnabled.tag,i),Ye.updateRollRequestsIcon(i)}async _onToggleSkipDialogs(t){n.log("_onToggleSkipDialogs");const s=E(),i=t.target.checked;await A.set(s.skipRollDialog.tag,i)}async _onToggleGroupRollsMsg(t){n.log("_onToggleGroupRollsMsg");const s=E(),i=t.target.checked;await A.set(s.groupRollsMsgEnabled.tag,i)}_onToggleSelectAll(t){n.log("_onToggleSelectAll");const s=t.target.checked;this._ignoreTokenControl=!0,(this.currentTab==="pc"?game.actors.contents.filter(o=>me(o)):game.actors.contents.filter(o=>!me(o)&&Me(o))).forEach(o=>{s?(this.selectedActors.add(o.id),Re(o.id,!0)):(this.selectedActors.delete(o.id),Re(o.id,!1))}),setTimeout(()=>{this._ignoreTokenControl=!1},200),this.render(),this._updateRequestTypesVisibility()}_onToggleLock(t){n.log("_onToggleLock"),t.preventDefault(),this.isLocked=!this.isLocked;const s=t.currentTarget;s.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),s.classList.add(this.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open")}async _onToggleOptions(t){n.log("_onToggleOptions"),t.preventDefault(),this.optionsExpanded=!this.optionsExpanded,await game.user.setFlag(K.ID,"menuOptionsExpanded",this.optionsExpanded);const s=t.currentTarget||t.target.closest(".options-toggle");s&&s.classList.toggle("expanded",this.optionsExpanded);const i=this.element.querySelector("li.options");i&&i.classList.toggle("expanded",this.optionsExpanded)}_initializeFromSelectedTokens(){var s;n.log("_initializeFromSelectedTokens");const t=((s=canvas.tokens)==null?void 0:s.controlled)||[];this.selectedActors.clear();for(const i of t)if(i.actor&&(this.selectedActors.add(i.actor.id),this.selectedActors.size===1)){const o=me(i.actor);this.currentTab=o?"pc":"npc"}}async _onTabClick(t){var i;n.log("_onTabClick");const s=t.currentTarget.dataset.tab;s!==this.currentTab&&(this.selectedActors.clear(),(i=canvas.tokens)==null||i.releaseAll(),this.selectedRequestType=null,this.currentTab=s,await this.render())}_onActorClick(t){if(n.log("_onActorClick"),t.target.closest(".actor-select"))return;const i=t.currentTarget.dataset.id;this._toggleActorSelection(i)}_onActorSelectClick(t){n.log("_onActorSelectClick"),t.stopPropagation();const s=t.currentTarget.dataset.id;this._toggleActorSelection(s)}_toggleActorSelection(t){n.log("_toggleActorSelection"),this._ignoreTokenControl=!0,this.selectedActors.has(t)?(this.selectedActors.delete(t),Re(t,!1)):(this.selectedActors.add(t),Re(t,!0)),setTimeout(()=>{this._ignoreTokenControl=!1},100),this.render(),this._updateRequestTypesVisibility(),this._updateSelectAllState()}_updateRequestTypesVisibility(){n.log("_updateRequestTypesVisibility"),this.render()}_updateSelectAllState(){n.log("_updateSelectAllState");const t=this.element.querySelector("#flash5e-actors-all"),s=this.currentTab==="pc"?"pc":"npc",i=this.element.querySelectorAll(`.${s}-actors .actor-item input[type="checkbox"]`),o=Array.from(i).filter(l=>l.checked).length;t.checked=o>0&&o===i.length,t.indeterminate=o>0&&o<i.length}async _onRequestTypeClick(t){const s=t.currentTarget,i=s.dataset.id,o=K.ROLL_REQUEST_OPTIONS[i];if(n.log("_onRequestTypeClick",[i,s.dataset,o]),!o){n.error("Unknown request type:",[i]);return}this.selectedRequestType===i?this.selectedRequestType=null:this.selectedRequestType=i,o.subList?await this.render():this.selectedRequestType&&this._triggerRoll(i,null)}_onRollTypeClick(t){n.log("_onRollTypeClick");const s=t.currentTarget.dataset.id;this._triggerRoll(this.selectedRequestType,s)}_getValidActorIds(t){return t.filter(s=>{const i=game.actors.get(s);if(!i)return!1;const o=me(i),l=!o&&Me(i);return this.currentTab==="pc"&&o||this.currentTab==="npc"&&l})}async _handleCustomRoll(){return await this._showCustomRollDialog()}async _getRollConfiguration(t,s,i,o,l){const r=E(),a=A.get(r.rollRequestsEnabled.tag);if(!o&&s!==g.CUSTOM){let c;[g.SKILL,g.TOOL].includes(s)?c=je:s===g.HIT_DIE?c=Be:c=Z;const d=await c.initConfiguration(t,s,i,{skipRollDialog:o,sendRequest:a||!1});return n.log("_getRollConfiguration",[d]),d}else{const c={rolls:[{parts:[],data:{},options:{}}],advantage:!1,disadvantage:!1,rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:!0,sendRequest:a&&l.length>0};return s===g.DEATH_SAVE&&(c.target=10),c}}async _orchestrateRollsForActors(t,s,i,o,l){const r=E(),a=[],c=[],d=[];n.log("_orchestrateRollsForActors",[t,s,i]);const f=foundry.utils.randomID(),p=[];if(t.sendRequest){for(const{actor:R,owner:y}of s)y.active?d.push({actor:R,owner:y}):(A.get(r.showOfflineNotifications.tag)&&q.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:y.name})),c.push(R));p.push(...d.map(({actor:R})=>R))}else i.push(...s.map(({actor:R})=>R));p.push(...c,...i);const h=A.get(r.groupRollsMsgEnabled.tag);h&&p.length>1&&await B.createGroupRollMessage(p,o,l,t,f);for(const{actor:R,owner:y}of d){const b=h&&p.length>1?f:null;await this._sendRollRequestToPlayer(R,y,o,l,t,!0,b),a.push({actor:R,owner:y}),await we(100)}a.length>0&&this._showConsolidatedNotification(a,o,l);const m=[...c,...i];m.length>0&&(t.skipRollDialog=!0,t.groupRollId=h&&p.length>1?f:null,await this._handleGMRolls(m,o,l,t))}async _triggerRoll(t,s){var m,R,y;n.log("_triggerRoll",[t,s]);const i=E(),o=Array.from(this.selectedActors),l=A.get(i.skipRollDialog.tag),r=this._getValidActorIds(o);let a=r.map(b=>game.actors.get(b));const c=K.ROLL_REQUEST_OPTIONS[t],d=(m=(c==null?void 0:c.name)||t)==null?void 0:m.toLowerCase();switch(d){case g.CUSTOM:if(s=await this._handleCustomRoll(),!s)return;break;case g.INITIATIVE:case g.INITIATIVE_DIALOG:if(await $e()){n.log("_triggerRoll - initiative",[r]);for(const _ of r){const S=game.actors.get(_);if(S){const C=game.combat.getCombatantsByActor(_);(!C||C.length===0)&&(n.log("_triggerRoll - adding actor to combat",S.name),await game.combat.createEmbeddedDocuments("Combatant",[{actorId:_,tokenId:(y=(R=S.getActiveTokens())==null?void 0:R[0])==null?void 0:y.id}]))}}const L=await Ue(r,game);if(n.log("_triggerRoll filteredActorIds",[L,!L.length]),!L.length)return;a=L.map(_=>game.actors.get(_))}break;case g.DEATH_SAVE:a=await at(a);break}if(!a.length){q.notify("warn","No valid actors selected");return}const{pcActors:f,npcActors:p}=nt(a),h=await this._getRollConfiguration(a,d,s,l,f);n.log("_triggerRoll config",[h]),h&&(await this._orchestrateRollsForActors(h,f,p,d,s),setTimeout(()=>this.close(),500))}async _sendRollRequestToPlayer(t,s,i,o,l,r=!1,a=null){n.log("_sendRollRequestToPlayer #A",[i,o]);const c=E();let d=i==null?void 0:i.toLowerCase();if(d===g.ABILITY_CHECK?d=g.ABILITY:d===g.SAVING_THROW?d=g.SAVE:d===g.INITIATIVE_DIALOG&&(d=g.INITIATIVE),d===g.HIT_DIE){const h=t.system.attributes.hd;if(h.value>0)o=h.largestAvailable;else if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessage",{actors:t.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){try{n.log("About to call handleHitDieRecovery for",[t.name]);const R=await U.handleHitDieRecovery(t);n.log("handleHitDieRecovery completed",[R])}catch(R){n.error("Error calling handleHitDieRecovery:",[R])}o=t.system.attributes.hd.largestAvailable,q.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:t.name})||`Hit dice refilled for ${t.name}`)}else return}const f={...l};delete f.subject,delete f.workflow,delete f.item,delete f.activity;const p={type:"rollRequest",groupRollId:a||foundry.utils.randomID(),actorId:t.id,rollType:d,rollKey:o,activityId:null,rollProcessConfig:{...f,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(h=>h.id),preserveTargets:A.get(c.useGMTargetTokens.tag)};n.log("_sendRollRequestToPlayer - prepareMidiQOLSettings",[]),J.execForUser("handleRollRequest",s.id,p),r||q.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:s.name,actor:t.name}))}_showConsolidatedNotification(t,s,i){var a,c,d,f,p;n.log("_showConsolidatedNotification");const o={};for(const{actor:h,owner:m}of t)o[m.id]||(o[m.id]={player:m,actors:[]}),o[m.id].actors.push(h);for(const[h,m]of Object.entries(K.ROLL_REQUEST_OPTIONS))if(m.name===s)break;const l=s;let r=game.i18n.localize(`FLASH_ROLLS.rollTypes.${l}`)||l;if(i){const h=l.toLowerCase();if(h===g.SKILL)r=`${r} (${((a=CONFIG.DND5E.skills[i])==null?void 0:a.label)||i})`;else if(h===g.SAVING_THROW)r=`${r} (${((c=CONFIG.DND5E.abilities[i])==null?void 0:c.label)||i})`;else if(h===g.ABILITY_CHECK)r=`${r} (${((d=CONFIG.DND5E.abilities[i])==null?void 0:d.label)||i})`;else if(h===g.TOOL){const m=(p=(f=CONFIG.DND5E.enrichmentLookup)==null?void 0:f.tools)==null?void 0:p[i];if(m!=null&&m.id){const R=dnd5e.documents.Trait.getBaseItem(m.id,{indexOnly:!0});r=`${r} (${(R==null?void 0:R.name)||i})`}else r=`${r} (${i})`}else h===g.CUSTOM&&(r=`${r}: ${i}`)}q.notifyRollRequestsSent(o,r)}async _handleGMRolls(t,s,i,o){n.log("_handleGMRolls",[t,s,i,o]);for(const l of t)await this._initiateRoll(l,s,i,o),await we(100)}async _initiateRoll(t,s,i,o){var l,r,a,c,d;n.log("_initiateRoll",[s,i,o]);try{const f=s.toLowerCase();let p=i;if(f===g.HIT_DIE){const _=t.system.attributes.hd;if(_){const S=["d6","d8","d10","d12","d20"];for(const C of S)if((((l=_[C])==null?void 0:l.value)||0)>0){p=C;break}}if(!p)if(n.log("_initiateRoll - No hit dice available",[t.name]),await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessageLocal",{actors:t.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndRoll")||"Refill & Roll",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){const C=await U.handleHitDieRecovery(t);if(n.log("Hit die recovery result",[C]),q.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:t.name})),p=t.system.attributes.hd.largestAvailable,!p){q.notify("warn",game.i18n.format("DND5E.HitDiceWarn",{name:t.name}));return}}else return}const h=((c=(a=(r=o.rolls)==null?void 0:r[0])==null?void 0:a.data)==null?void 0:c.situational)||"",m={rollKey:p,groupRollId:o.groupRollId,config:{...o,situational:h,rollMode:o.rollMode||game.settings.get("core","rollMode"),advantage:o.advantage||!1,disadvantage:o.disadvantage||!1,target:o.target}},R={configure:!o.fastForward&&!o.skipRollDialog,isRollRequest:!0},y={rollMode:o.rollMode||game.settings.get("core","rollMode"),create:o.chatMessage!==!1,isRollRequest:!0},b=((d=o.rolls)==null?void 0:d[0])||{},L=U[f];L?await L(t,m,b,R,y):q.notify("warn",`Unknown roll type: ${s}`)}catch(f){n.error("executeActorRoll",[f]),q.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:t.name}))}}async _onClose(t){n.log("_onClose",[t]),await super._onClose(t),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),this._tokenControlHook&&(Hooks.off("controlToken",this._tokenControlHook),this._tokenControlHook=null),this._tokenUpdateTimeout&&(clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=null),j(te,Y)===this&&ne(te,Y,null)}setPosition(t={}){return n.log("setPosition"),this}async _showCustomRollDialog(){return n.log("_showCustomRollDialog"),Oe.prompt({formula:"",readonly:!1})}static toggle(){n.log("RollRequestsMenu.toggle"),j(this,Y)?j(this,Y).rendered?j(this,Y).close():(j(this,Y)._initializeFromSelectedTokens(),j(this,Y).render(!0)):(ne(this,Y,new te),j(this,Y).render(!0))}};Y=new WeakMap,ie(te,Y,null),k(te,"DEFAULT_OPTIONS",{id:"flash-rolls-menu",classes:["flash-rolls-menu"],tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:{}}),k(te,"PARTS",{main:{template:`modules/${K.ID}/templates/requests-menus.hbs`}});let Ce=te;class Ye{static addSidebarControls(e,t,s){if(!game.user.isGM||e.id!=="sidebar")return;const i=document.querySelector("#roll-privacy");if(n.log("addSidebarControls",[i]),!i||i.querySelector(".flash-rolls-icon"))return;const o=E(),l=A.get(o.rollRequestsEnabled.tag),r=document.createElement("button");r.id="flash-rolls-icon",r.setAttribute("data-tooltip-direction","RIGHT"),r.className=`ui-control icon chat-control-icon flash-rolls-icon${l?" active":""}`,r.title=game.i18n.localize("FLASH_ROLLS.ui.menus.rollRequestsTitle"),r.innerHTML=`<i class="fas fa-bolt${l?"":"-slash"}"></i>`;const a=i.firstChild;a?a.parentNode.insertBefore(r,a):i.insertBefore(r,i.firstChild),n.log("addSidebarControls",[a,r]),r.addEventListener("click",c=>{c.stopPropagation(),c.preventDefault(),Ce.toggle()})}static updateRollRequestsIcon(e){const t=document.querySelector("#flash-rolls-icon i");t&&(t.className=`fas fa-bolt${e?"":"-slash"}`)}}class Ae{static initialize(){Hooks.once(W.INIT,this._onInit.bind(this)),Hooks.once(W.READY,this._onReady.bind(this))}static _onInit(){E(),document.body.classList.add("flash5e"),A.registerSettings(),le.initialize(),this._registerHooks()}static _onReady(){A.registerSettingsMenu(),oe.isModuleActive("midi-qol")?(n.log("HooksUtil.initialize",["midi-qol is active. Awaiting for it to be ready..."]),Hooks.once("midi-qol.ready",this._initModule.bind(this))):(n.log("HooksUtil.initialize",["midi-qol is NOT active. Starting..."]),this._initModule())}static async _initModule(){const e=E();A.get(e.debugMode.tag)&&(CONFIG.debug.hooks=!0),await B.initialize(),game.user.isGM?(We.initialize(),this._registerGMHooks()):(le.getDiceConfig(),this._registerPlayerHooks()),Fe(ve())}static _registerHooks(){this._registerHook(W.RENDER_SIDEBAR,this._onRenderSidebar.bind(this)),this._registerHook(W.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessage.bind(this)),this._registerHook(W.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageFlavor.bind(this)),this._registerHook(W.RENDER_CHAT_MESSAGE,this._onRenderChatMessageHTML.bind(this)),this._registerHook(W.CHANGE_SIDEBAR_TAB,this._onSidebarUpdate.bind(this)),this._registerHook(W.COLLAPSE_SIDE_BAR,this._onSidebarUpdate.bind(this)),this._registerHook(N.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this)),this._registerHook(N.RENDER_SKILL_TOOL_ROLL_DIALOG,this._onRenderSkillToolDialog.bind(this)),this._registerHook(N.PRE_USE_ACTIVITY,this._onPreUseActivity.bind(this)),this._registerHook(N.POST_USE_ACTIVITY,this._onPostUseActivity.bind(this)),this._registerHook(N.PRE_ROLL_HIT_DIE_V2,this._onPreRollHitDieV2.bind(this)),this._registerHook(N.POST_ROLL_CONFIG,this._onPostRollConfig.bind(this))}static _registerGMHooks(){this._registerHook(W.USER_CONNECTED,this._onUserConnected.bind(this)),this._registerHook(W.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageGM.bind(this)),this._registerHook(N.PRE_ROLL_V2,this._onPreRoll.bind(this)),game.users.forEach(e=>{this._onUserConnected(e)})}static _registerPlayerHooks(){this._registerHook(N.PRE_ROLL_INITIATIVE_DIALOG,this._onPreRollInitiativeDialog.bind(this)),this._registerHook(N.PRE_ROLL_ATTACK_V2,this._onPreRollAttackV2.bind(this)),this._registerHook(N.PRE_ROLL_DAMAGE_V2,this._onPreRollDamageV2.bind(this)),Hooks.on("dnd5e.preRollAbilityCheckV2",(e,t,s)=>{n.log("_onPreRollAbilityCheckV2",[e,t,s]),e.isRollRequest&&(t.configure=!0)})}static _onSidebarUpdate(e){n.log("_onSidebarUpdate",[e]),Fe(ve())}static _onPostRollConfig(e,t,s,i){t._showRequestedBy&&e.length>0&&(i.data=i.data||{},i.data._showRequestedBy=!0,i.data._requestedBy=t._requestedBy)}static _onPreCreateChatMessage(e,t,s,i){var o,l,r,a,c,d,f,p,h,m;if(t._showRequestedBy&&((o=t.rolls)==null?void 0:o.length)>0){const R=t._requestedBy||"GM",y=game.i18n.format("FLASH_ROLLS.chat.requestedBy",{gm:R}),b=t.flavor||"";t.flavor=b?`${b} ${y}`:y}if((r=(l=t.flags)==null?void 0:l[T])!=null&&r.groupRollId&&n.log("_onPreCreateChatMessage - Found groupRollId in data flags",[t]),((a=t.rolls)==null?void 0:a.length)>0||(d=(c=t.flags)==null?void 0:c.core)!=null&&d.initiativeRoll){const R=t.speaker,y=R==null?void 0:R.actor;if(y){let b=game.actors.get(y);if(!b&&(R!=null&&R.token)){const L=canvas.tokens.get(R.token);L!=null&&L.actor&&(b=L.actor,n.log("_onPreCreateChatMessage - Using token actor from speaker",[b.name,b.id]))}if(!b){n.log("_onPreCreateChatMessage - No actor found",[y,R]);return}if(game.user.isGM){const L=b.isToken?(f=b.actor)==null?void 0:f.id:b.id,_=[y,L].filter(S=>S);for(const[S,C]of B.pendingRolls.entries())if(_.some(O=>C.actors.includes(O))){t.flags=t.flags||{},t.flags[T]=t.flags[T]||{},t.flags[T].groupRollId=S,n.log("_onPreCreateChatMessage - Added groupRollId flag (GM)",[S,y]);break}}else{let L=b.getFlag(T,"tempGroupRollId");if(!L&&b.isToken){const S=game.actors.get((p=b.actor)==null?void 0:p.id);S&&(L=S.getFlag(T,"tempGroupRollId"),n.log("_onPreCreateChatMessage - Checking base actor for tempGroupRollId",[S.id,L]))}if(L&&(b.unsetFlag(T,"tempGroupRollId"),b.isToken)){const S=game.actors.get((h=b.actor)==null?void 0:h.id);S&&S.unsetFlag(T,"tempGroupRollId")}let _=b.getFlag(T,"tempInitiativeConfig");if(!_&&b.isToken){const S=game.actors.get((m=b.actor)==null?void 0:m.id);S&&(_=S.getFlag(T,"tempInitiativeConfig"),n.log("_onPreCreateChatMessage - Checking base actor for tempInitiativeConfig",[S.id,_]))}(_!=null&&_.groupRollId||L)&&(t.flags=t.flags||{},t.flags[T]=t.flags[T]||{},t.flags[T].groupRollId=L||_.groupRollId,n.log("_onPreCreateChatMessage - Added groupRollId flag from initiative config",[_.groupRollId,y]))}}}}static _onPreCreateChatMessageFlavor(e,t,s,i){var o,l;if(((o=t.rolls)==null?void 0:o.length)>0&&t.rolls[0])try{const r=t.rolls[0];(l=r.options)!=null&&l._customFlavor&&(t.flavor=r.options._customFlavor)}catch(r){n.error("_onPreCreateChatMessageFlavor",[r])}}static _onRenderRollConfigDialog(e,t,s){var o,l,r,a,c;if(n.log("_onRenderRollConfigDialog #0",[e,s]),e._flashRollsApplied)return;if(((l=(o=e.config)==null?void 0:o.hookNames)==null?void 0:l.includes("initiativeDialog"))||((a=(r=e.element)==null?void 0:r.id)==null?void 0:a.includes("initiative"))){const d=(c=e.config)==null?void 0:c.subject;if(!d)return;if(d.getFlag(T,"tempInitiativeConfig")){e._flashRollsApplied=!0;const p=t.querySelector('input[name*="situational"]');setTimeout(()=>{p.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},50)}return}else t.querySelectorAll('input[name*="situational"]').forEach((f,p)=>{var h,m,R,y;!f.value&&((y=(R=(m=(h=e.config)==null?void 0:h.rolls)==null?void 0:m[0])==null?void 0:R.data)!=null&&y.situational)&&(f.value=e.config.rolls[0].data.situational),n.log("_onRenderRollConfigDialog #1",[f.value,e.config.rolls[0]]),f.value&&(e._flashRollsApplied=!0,setTimeout(()=>{var b,L,_;f.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1})),(_=(L=(b=e.config)==null?void 0:b.rolls)==null?void 0:L[0])!=null&&_.data&&delete e.config.rolls[0].data.situational},50))})}static _onPreCreateChatMessageGM(e,t,s,i){n.log("_onPreCreateChatMessageGM",[e,t,s,i])}static _onRenderChatMessageHTML(e,t,s){n.log("_onRenderChatMessageHTML",[e,t,s]),B.interceptRollMessage(e,t,s)}static _onUserConnected(e){e.active&&e.id!==game.user.id&&le.requestDiceConfigFromUser(e.id)}static _onRenderApplicationV2(e,t,s){n.log("_onRenderApplicationV2",[e,t,s])}static _onRenderSidebar(e,t,s){n.log("_onRenderSidebar",[e,t,s]),Ye.addSidebarControls(e,t,s)}static _registerHook(e,t){const s=Hooks.on(e,t);return this.registeredHooks.set(`${e}_${s}`,s),s}static unregisterAll(){this.registeredHooks.forEach((e,t)=>{const s=t.split("_")[0];Hooks.off(s,e)}),this.registeredHooks.clear()}static isRegistered(e){for(const t of this.registeredHooks.keys())if(t.startsWith(`${e}_`))return!0;return!1}static _onPreRoll(e,t,s,i){n.log("_onPreRoll #0",[e,t,s,i])}static _onPreRollHitDieV2(e,t,s){if(n.log("_onPreRollHitDieV2 triggered",[e,t,s]),e.rolls&&e.rolls.length>1){const i=[];for(let o=0;o<e.rolls.length;o++){const l=e.rolls[o];l&&l.data&&l.data.situational&&i.push(l.data.situational)}if(i.length>0){e.rolls[0].data||(e.rolls[0].data={});const o=[...new Set(i)];e.rolls[0].data.situational=o.map(l=>{const r=l.toString().trim();return r.startsWith("-")?`(${r})`:r.startsWith("+")?`${r.substring(1)}`:`${r}`}).join(" + "),game.user.isGM&&!e.rolls[0].parts.find(l=>l.includes("@situational"))&&e.rolls[0].parts.push("@situational")}e.rolls=e.rolls.slice(0,1),n.log("Cleaned up hit die rolls",e.rolls)}}static _onPreRollInitiativeDialog(e,t,s){var l,r,a,c,d;const o=e.subject.getFlag(T,"tempInitiativeConfig");n.log("_onPreRollInitiativeDialog triggered",[e,o,t,s]),e.advantage=(o==null?void 0:o.advantage)||e.advantage||!1,e.disadvantage=(o==null?void 0:o.disadvantage)||e.disadvantage||!1,e.rollMode=(o==null?void 0:o.rollMode)||e.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,s.rollMode=(o==null?void 0:o.rollMode)||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,(a=(r=(l=o.rolls)==null?void 0:l[0])==null?void 0:r.data)!=null&&a.situational&&((d=(c=e.rolls)==null?void 0:c[0])!=null&&d.data)&&(e.rolls[0].data.situational=o.rolls[0].data.situational)}static _onPreRollAttackV2(e,t,s){var o,l;n.log("_onPreRollAttackV2 triggered",[e,t,s]);const i=(l=(o=e.subject)==null?void 0:o.item)==null?void 0:l.getFlag(T,"tempAttackConfig");if(i){if(n.log("_onPreRollAttackV2 - Found stored request config from flag",[i]),i.isRollRequest===!1||i.skipRollDialog===!0||i.sendRequest===!1){n.log("_onPreRollAttackV2 - Not a roll request, skipping",[i]);return}i.attackMode&&(e.attackMode=i.attackMode),i.ammunition&&(e.ammunition=i.ammunition),i.mastery!==void 0&&(e.mastery=i.mastery),e.advantage=i.advantage||!1,e.disadvantage=i.disadvantage||!1,s.rollMode=i.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,i.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=i.situational),n.log("_onPreRollAttackV2 - Applied stored configuration to attack roll",[e,s])}}static _onPreRollDamageV2(e,t,s){var o,l;n.log("_onPreRollDamageV2 triggered",[e,t,s]);const i=(l=(o=e.subject)==null?void 0:o.item)==null?void 0:l.getFlag(T,"tempDamageConfig");if(i){if(n.log("_onPreRollDamageV2 - Found stored request config from flag",[i,i.situational]),i.isRollRequest===!1||i.skipRollDialog===!0||i.sendRequest===!1){n.log("_onPreRollDamageV2 - Not a roll request, skipping",[i]);return}i.critical&&(e.critical=i.critical),s.rollMode=i.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,i.situational&&((!e.rolls||e.rolls.length===0)&&(e.rolls=[{parts:[],data:{},options:{}}]),e.rolls[0].data||(e.rolls[0].data={}),e.rolls[0].data.situational=i.situational),n.log("_onPreRollDamageV2 - Applied stored configuration to damage roll",[e,s])}}static _onPreUseActivity(e,t,s,i){n.log("_onPreUseActivity triggered",[e,t,s,i]);const o=E(),l=A.get(o.rollRequestsEnabled.tag),r=A.get(o.rollInterceptionEnabled.tag);if(n.log("_onPreUseActivity - Settings",[l,r]),e.item.unsetFlag(T,"tempAttackConfig"),e.item.unsetFlag(T,"tempDamageConfig"),e.item.unsetFlag(T,"tempSaveConfig"),P.isModuleOn(T,"midi-qol"),!game.user.isGM||!l||!r)return;const a=e.actor;if(!a)return;switch(A.get(o.consumptionConfigMode.tag)){case 1:s.configure=!1;break;case 2:s.configure=game.user.isGM;break;case 3:s.configure=!game.user.isGM;break;default:s.configure=!0;break}e.type===Te.SAVE&&(t.create={measuredTemplate:!1},t.hasConsumption=!1,t.consume={action:!1,resources:[],spellSlot:!1});const d=P.getActorOwner(a);d&&d.active&&!d.isGM&&(n.log("Preventing usage message for player-owned actor",[a.name]),i.create=!1)}static _onPostUseActivity(e,t,s,i){var o;if(game.user.isGM&&e.type===Te.SAVE){n.log("_onPostUseActivity triggered",[e.damage]);const l=E(),r=A.get(l.skipRollDialog.tag);e.damage&&((o=e.damage.parts)==null?void 0:o.length)>0&&e.rollDamage(t,{...s,configure:!r},i)}}static _onRenderSkillToolDialog(e,t,s){var o,l;if(n.log("_onRenderSkillToolDialog triggered",[e]),e._abilityFlavorFixed)return;const i=t.querySelector('select[name="ability"]');if(i&&(o=e.config)!=null&&o.isRollRequest&&(l=e.config)!=null&&l.ability){const r=i.value,a=e.config.ability;r===a&&(e._abilityFlavorFixed=!0,setTimeout(()=>{const c=new Event("change",{bubbles:!0,cancelable:!0});i.dispatchEvent(c)},50))}}}k(Ae,"registeredHooks",new Map),k(Ae,"midiTimeout",null);class Ee{static async handleRequest(e){var i;const t=P.isModuleOn(T,"midi-qol");if(n.log("handleRequest",[e]),game.user.isGM)return;const s=game.actors.get(e.actorId);!s||!s.isOwner||(t&&e.rollProcessConfig.midiOptions&&(e.rollProcessConfig.midiOptions={...e.rollProcessConfig.midiOptions,fastForward:!1,fastForwardAttack:!1,dialogOptions:{...e.rollProcessConfig.midiOptions.dialogOptions,fastForward:!1,fastForwardAttack:!1},workflowOptions:{...e.rollProcessConfig.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1}}),e.preserveTargets&&((i=e.targetTokenIds)==null?void 0:i.length)>0&&game.user.targets.size===0&&ot(e.targetTokenIds),q.notify("info","",{batch:!0,batchData:{actor:s.name,rollType:e.rollType,rollKey:e.rollKey,gm:e.rollProcessConfig._requestedBy||"GM"}}),Ee.executePlayerRollRequest(s,e))}static async executePlayerRollRequest(e,t){var i,o;const s=E();A.get(s.publicPlayerRolls.tag),n.log("executePlayerRollRequest",[e,t]);try{const l=(i=t.rollType)==null?void 0:i.toLowerCase(),r=((o=t.rollProcessConfig.rolls)==null?void 0:o[0])||{parts:[],data:{},options:{}},c={configure:!(game.user.isGM?t.skipRollDialog:!1)},d=t.rollProcessConfig.rollMode,f=game.settings.get("core","rollMode"),h={rollMode:d||f,create:t.rollProcessConfig.chatMessage!==!1},m={rollKey:t.rollKey,activityId:t.activityId,config:t.rollProcessConfig,groupRollId:t.groupRollId},R=U[l];R?await R(e,m,r,c,h):(n.warn(`No handler found for roll type: ${l}`),q.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"})))}catch(l){n.error("Error executing roll request:",[l]),q.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name||"Unknown Actor"}))}}}class re{static init(){J.initialize(re.registerSocketCalls),Ae.initialize()}static getDiceConfig(){return le.getDiceConfig()}static receiveDiceConfig(e,t){le.receiveDiceConfig(e,t)}static async handleRollRequest(e){return n.log("Main.handleRollRequest",e),Ee.handleRequest(e)}static registerSocketCalls(){J.registerCall(Se.getDiceConfig,re.getDiceConfig),J.registerCall(Se.receiveDiceConfig,re.receiveDiceConfig),J.registerCall(Se.handleRollRequest,re.handleRollRequest)}}re.init();
//# sourceMappingURL=flash-rolls-5e.js.map
