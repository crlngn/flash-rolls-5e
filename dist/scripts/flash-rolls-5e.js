var et=Object.defineProperty;var Ge=u=>{throw TypeError(u)};var tt=(u,t,e)=>t in u?et(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var D=(u,t,e)=>tt(u,typeof t!="symbol"?t+"":t,e),Ae=(u,t,e)=>t.has(u)||Ge("Cannot "+e);var W=(u,t,e)=>(Ae(u,t,"read from private field"),e?e.call(u):t.get(u)),oe=(u,t,e)=>t.has(u)?Ge("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(u):t.set(u,e),re=(u,t,e,s)=>(Ae(u,t,"write to private field"),s?s.call(u,e):t.set(u,e),e),he=(u,t,e)=>(Ae(u,t,"access private method"),e);const $={select:"select",checkbox:"checkbox"},x={client:"client",world:"world"},E=()=>({generalSettings:{tag:"flash5e-general-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["rollInterceptionEnabled","useGMTargetTokens","templateAutoTarget","showOfflineNotifications","initiateCombatOnRequest","showOnlyPCsWithToken"],default:{rollInterceptionEnabled:!0,useGMTargetTokens:!0,templateAutoTarget:1,showOfflineNotifications:!0,initiateCombatOnRequest:!0,showOnlyPCsWithToken:!0},scope:x.world,config:!1,requiresReload:!1},groupRollsSettings:{tag:"flash5e-group-rolls-settings",label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),title:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),propType:Object,fields:["groupRollsMsgEnabled","groupRollResultMode","showGroupDCToPlayers"],default:{groupRollsMsgEnabled:!0,groupRollResultMode:1,showGroupDCToPlayers:!1},scope:x.world,config:!1,requiresReload:!1},showGroupDCToPlayers:{tag:"show-group-dc-to-players",label:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showGroupDCToPlayers.hint"),propType:Boolean,inputType:$.checkbox,default:!1,scope:x.world,config:!1},rollRequestsEnabled:{tag:"roll-requests-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollRequestsEnabled.hint"),propType:Boolean,inputType:$.checkbox,default:!0,scope:x.world,config:!0},groupRollsMsgEnabled:{tag:"group-roll-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollsMsgEnabled.hint"),propType:Boolean,inputType:$.checkbox,default:!0,scope:x.world,config:!1},groupRollResultMode:{tag:"group-roll-result-mode",label:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.hint"),propType:Number,inputType:$.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.groupRollResultMode.choices.4")},default:1,scope:x.world,config:!1},consumptionConfigMode:{tag:"consumption-config-mode",label:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.hint"),propType:Number,inputType:$.select,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.1"),2:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.2"),3:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.3"),4:game.i18n.localize("FLASH_ROLLS.settings.consumptionConfigMode.choices.4")},default:4,scope:x.world,config:!0},skipRollDialog:{tag:"skip-roll-dialog",label:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.skipRollDialog.hint"),propType:Boolean,inputType:$.checkbox,default:!1,scope:x.world,config:!0},useGMTargetTokens:{tag:"use-gm-target-tokens",label:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.useGMTargetTokens.hint"),propType:Boolean,inputType:$.checkbox,default:!0,scope:x.world,config:!1},rollInterceptionEnabled:{tag:"roll-interception-enabled",label:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.rollInterceptionEnabled.hint"),propType:Boolean,inputType:$.checkbox,default:!0,scope:x.world,config:!1},publicPlayerRolls:{tag:"public-player-rolls",label:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.publicPlayerRolls.hint"),propType:Boolean,inputType:$.checkbox,default:!0,scope:x.world,config:!0},showOfflineNotifications:{tag:"show-offline-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOfflineNotifications.hint"),propType:Boolean,inputType:$.checkbox,default:!0,scope:x.world,config:!1},showRequestNotifications:{tag:"show-request-notifications",label:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showRequestNotifications.hint"),propType:Boolean,inputType:$.checkbox,default:!0,scope:x.world,config:!1},initiateCombatOnRequest:{tag:"initiate-combat-on-request",label:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.initiateCombatOnRequest.hint"),propType:Boolean,inputType:$.checkbox,default:!0,scope:x.world,config:!1},showOnlyPCsWithToken:{tag:"show-only-pcs-with-token",label:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.showOnlyPCsWithToken.hint"),propType:Boolean,inputType:$.checkbox,default:!0,scope:x.world,config:!1},templateAutoTarget:{tag:"template-auto-target",label:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.hint"),propType:Number,choices:{1:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.all.label"),2:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.notFriendly.label"),3:game.i18n.localize("FLASH_ROLLS.settings.templateAutoTarget.choices.none.label")},inputType:$.select,default:1,scope:x.world,config:!1},debugMode:{tag:"debug-mode-on",label:game.i18n.localize("FLASH_ROLLS.settings.debugMode.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.debugMode.hint"),propType:Boolean,inputType:$.checkbox,default:!1,scope:x.client,config:!0}}),_="flash-rolls-5e",Re=["%cFlash Rolls 5e","color:rgb(47, 151, 161); font-weight: bold;","|"],Ie={receiveDiceConfig:"receiveDiceConfig",getDiceConfig:"getDiceConfig",handleRollRequest:"handleRollRequest"},Be={SAVE:"save"},f={ABILITY:"ability",ABILITY_CHECK:"abilitycheck",ATTACK:"attack",CONCENTRATION:"concentration",CUSTOM:"custom",DEATH_SAVE:"deathsave",FORMULA:"formula",DAMAGE:"damage",HEALING:"healing",HIT_DIE:"hitdie",INITIATIVE:"initiative",INITIATIVE_DIALOG:"initiativedialog",ITEM_SAVE:"itemsave",SAVE:"save",SAVING_THROW:"savingthrow",SKILL:"skill",TOOL:"tool"},st={ABILITY_CHECK:{name:f.ABILITY_CHECK,label:"Ability Check",subList:"abilities",actorPath:"system.abilities"},SAVING_THROW:{name:f.SAVING_THROW,label:"Saving Throw",subList:"abilities",actorPath:"system.abilities"},SKILL:{name:f.SKILL,label:"Skill Check",subList:"skills",actorPath:"system.skills"},TOOL:{name:f.TOOL,label:"Tool Check",subList:"tools",actorPath:"system.tools"},CONCENTRATION:{name:f.CONCENTRATION,label:"Concentration Check",subList:null,actorPath:""},INITIATIVE:{name:f.INITIATIVE,label:"Initiative Roll",subList:null,actorPath:""},DEATH_SAVE:{name:f.DEATH_SAVE,label:"Death Save",subList:null,actorPath:""},HIT_DIE:{name:f.HIT_DIE,label:"Hit Die",subList:null,actorPath:""},CUSTOM:{name:f.CUSTOM,label:"Custom Roll",subList:null,actorPath:""}},j={ID:_,ROLL_REQUEST_OPTIONS:st},v={INIT:"init",READY:"ready",RENDER_CHAT_MESSAGE:"renderChatMessageHTML",RENDER_CHAT_LOG:"renderChatLog",CHANGE_SIDEBAR_TAB:"changeSidebarTab",RENDER_SIDEBAR:"renderSidebar",UPDATE_SCENE:"updateScene",USER_CONNECTED:"userConnected",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",COLLAPSE_SIDE_BAR:"collapseSidebar",REFRESH_MEASURED_TEMPLATE:"refreshMeasuredTemplate",CONTROL_TOKEN:"controlToken",UPDATE_ACTOR:"updateActor",UPDATE_ITEM:"updateItem",CREATE_ITEM:"createItem",DELETE_ITEM:"deleteItem",UPDATE_SETTING:"updateSetting"},it={READY:"socketlib.ready"},ot={READY:"midi-qol.ready"},N={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_USE_ACTIVITY:"dnd5e.preUseActivity",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ROLL_ABILITY_CHECK:"dnd5e.preRollAbilityCheckV2",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrowV2",PRE_ROLL_DEATH_SAVE_V2:"dnd5e.preRollDeathSaveV2",PRE_ROLL_SKILL_V2:"dnd5e.preRollSkillV2",PRE_ROLL_TOOL_V2:"dnd5e.preRollToolV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE_DIALOG:"dnd5e.preRollInitiativeDialog",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",ROLL_INITIATIVE:"dnd5e.rollInitiative",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",POST_ROLL_CONFIG:"dnd5e.postRollConfiguration",RENDER_ROLL_CONFIGURATION_DIALOG:"renderRollConfigurationDialog",RENDER_SKILL_TOOL_ROLL_DIALOG:"renderSkillToolRollConfigurationDialog"},pe=class pe{static log(t="",e=[],s=!1){try{const i=game.settings.get(_,"debug-mode-on")||pe.debugOn;if(!(s||i))return;const l=Array.isArray(e)?e:[e];console.log(...Re,t,...l)}catch{if(s||pe.debugOn){const o=Array.isArray(e)?e:[e];console.log(...Re,t,...o)}}}static warn(t="",e=[]){const s=Array.isArray(e)?e:[e];console.warn(...Re,t,...s)}static error(t,e=[],s={ui:!1,console:!0,permanent:!1}){var o;const i=Array.isArray(e)?e:[e];s.ui&&((o=ui.notifications)==null||o.error(t,{localize:!0,permanent:s.permanent})),s.console&&console.error(...Re,t,...i)}};D(pe,"debugOn",!1);let r=pe;const F=class F{static serializeForTransport(t,e=!1){return r.log("serializeForTransport",[t,e]),t==null||e&&t.rolls&&Array.isArray(t.rolls)&&(t.rolls=t.rolls.map(s=>s instanceof Roll?s.toJSON():s)),t}static deserializeFromTransport(t,e=!1){r.log("deserializeFromTransport",[t,e]);let s={...t};if(!t)return s;if(e&&t.rolls&&t.rolls.length>0){const i=s.rolls.map(o=>{let l=o;return typeof o=="string"?l=Roll.fromJSON(o):l=Roll.fromJSON(JSON.stringify(o)),l});return s.rolls=[...i],s}return s}};D(F,"socket"),D(F,"_activeExecutions",new Map),D(F,"initialize",t=>{r.log("initialize",[t]),Hooks.once(it.READY,()=>{if(typeof socketlib>"u"){r.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("FLASH_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{F.socket=socketlib.registerModule(_),t&&t()}catch{}})}),D(F,"registerCall",(t,e)=>{r.log("registerCall",[t]),F.socket&&F.socket.register(t,e)}),D(F,"sendMessage",(t,e)=>{r.log("sendMessage",[t]),e&&e()}),D(F,"execForGMs",async(t,...e)=>{if(r.log("execForGMs",[t,...e]),!!F.socket)return await F.socket.executeForAllGMs(t,...e)}),D(F,"execForAll",async(t,...e)=>{if(F.socket)return await F.socket.executeForEveryone(t,...e)}),D(F,"execForUser",async(t,e,...s)=>{if(r.log("execForUser #0",[t,e,...s]),!F.socket)return;if(r.log("execForUser #1",[e===game.user.id]),e===game.user.id)return null;const i=`${t}-${e}`;if(r.log("execForUser #2",[F._activeExecutions.has(i)]),F._activeExecutions.has(i))return null;F._activeExecutions.set(i,!0);try{const o=await F.socket.executeAsUser(t,e,...s);return r.log("execForUser #3 - response",[o]),o}catch(o){return r.error("execForUser #4 - error",[o]),null}finally{r.log("execForUser #5 - success",[]),F._activeExecutions.delete(i)}});let J=F;class ne{static initialize(){this.setDiceConfig()}static setDiceConfig(){if(!game.user)return{};const t=game.settings.storage.get("client");return this.diceConfig=t["core.diceConfiguration"]||"",this.diceConfig}static getDiceConfig(){return game.user?(this.setDiceConfig(),game.user.isGM&&this._sendDiceConfigToGMs(),this.diceConfig):{}}static _sendDiceConfigToGMs(){J.execForGMs("receiveDiceConfig",game.user.id,this.diceConfig)}static receiveDiceConfig(t,e){var s,i;((s=game.user)!=null&&s.isGM||t===((i=game.user)==null?void 0:i.id))&&(this.playerDiceConfigs[t]=e?JSON.parse(e):{})}static getUserDiceConfig(t){var e;return t===((e=game.user)==null?void 0:e.id)?this.diceConfig:this.playerDiceConfigs[t]||{}}static requestDiceConfigFromUser(t){J.execForUser("getDiceConfig",t)}static requestDiceConfigFromAllPlayers(){var t;(t=game.user)!=null&&t.isGM&&game.users.forEach(e=>{e.active&&!e.isGM&&e.id!==game.user.id&&this.requestDiceConfigFromUser(e.id)})}static clearPlayerConfigs(){this.playerDiceConfigs={}}static hasUserConfig(t){var e;return t===((e=game.user)==null?void 0:e.id)?!!this.diceConfig:!!this.playerDiceConfigs[t]}}D(ne,"diceConfig",{}),D(ne,"playerDiceConfigs",{});var Te,Ue;class G{static isModuleOn(t){var s;const e=(s=game.modules)==null?void 0:s.get(t);return!!(e!=null&&e.active)}static html(t,e){return t.querySelector(e)}static getFullWidth(t){return window.getComputedStyle(t).width==="0px"?0:t.offsetWidth}static addCSSVars(t,e){let s=document.querySelector("#flash5e-vars");if(!s){const h=document.querySelector("body.flash5e");if(!h)return;s=document.createElement("style"),s.id="flash5e-vars",s.textContent=`body.flash5e {
}
`,h.prepend(s)}let i=s.textContent,o=i.indexOf("body.flash5e {"),l=i.indexOf("}",o);o===-1&&(i=`body.flash5e {
}
`,o=0,l=i.indexOf("}"));const a=i.substring(o+14,l).split(";").map(h=>h.trim()).filter(h=>h!==""),c={};a.forEach(h=>{const p=h.split(":");if(p.length>=2){const m=p[0].trim(),R=p.slice(1).join(":").trim();m&&(c[m]=R)}}),t.includes("i18n")&&typeof e=="string"&&!e.startsWith('"')&&!e.startsWith("'")&&!e.match(/^url\(|^rgba?\(|^hsla?\(/)&&(e=`"${e}"`),c[t]=e;const d=Object.entries(c).map(([h,p])=>`  ${h}: ${p};`).join(`
`),g=i.substring(0,o)+`body.flash5e {
`+d+`
}`+i.substring(l+1);s.textContent=g}static getOffsetBottom(t){const e=t.offsetTop,s=t.offsetHeight;return window.innerHeight-(e+s)}static async getAllFonts(){const t=new Set(Object.keys(CONFIG.fontDefinitions)),e=game.settings.get("core","fonts")||{},s=Object.entries(e).map(([l])=>l),i=await this.processStyleSheets();return Array.from(new Set([...t,...s,...i])).filter(l=>!/FontAwesome|Font Awesome|FoundryVTT/.test(l)).map(l=>l.replace(/['"]/g,"").trim()).sort((l,n)=>l.toLowerCase().localeCompare(n.toLowerCase()))||[]}static addCustomCSS(t,e="flash5e-custom-css",s=!0){if(!t)return;let i=document.querySelector("#"+e);i||(i=document.createElement("style"),i.id=e,i.textContent="",document.head.appendChild(i));const o=/@import\s+(?:url\()?\s*['"]?[^'")]+['"]?\s*\)?\s*;/g,l=[];let n=t,a;for(;(a=o.exec(t))!==null;)l.push(a[0]);if(n=t.replace(o,"").trim(),!s){i.textContent=l.join(`
`)+(l.length?`

`:"")+n;return}if(!i.textContent.includes(n)){const c=i.textContent,d=[];let g;for(;(g=o.exec(c))!==null;)d.push(g[0]);const h=c.replace(o,"").trim(),p=l.filter(R=>!d.includes(R)),m=[...d,...p];i.textContent=m.join(`
`)+(m.length?`

`:"")+h+(h&&n?`

`:"")+n}}static smoothScrollTo(t,e,s="horizontal",i=300,o=null){const l=t.dataset.scrollAnimationId;l&&cancelAnimationFrame(Number(l));const n=s==="horizontal",a=n?t.scrollLeft:t.scrollTop,c=e-a;if(c===0)return o&&o(),null;const d=performance.now(),g=p=>{const m=p-d;if(m>=i){n?t.scrollLeft=e:t.scrollTop=e,delete t.dataset.scrollAnimationId,o&&o();return}const R=m/i,y=R<.5?2*R*R:1-Math.pow(-2*R+2,2)/2;n?t.scrollLeft=a+c*y:t.scrollTop=a+c*y;const L=requestAnimationFrame(g);return t.dataset.scrollAnimationId=L,L},h=requestAnimationFrame(g);return t.dataset.scrollAnimationId=h,h}static confirmReload(t=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredTitle"),e=game.i18n.localize("FLASH_ROLLS.ui.reloadRequiredLabel"),s={}){const i={title:t,content:e,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.reloadButton"),callback:()=>(r.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(i,s),foundry.applications.api.DialogV2.confirm(i)}static renderTemplate(t,e){return foundry.applications.handlebars.renderTemplate(t,e)}static loadTemplate(t){return foundry.applications.handlebars.loadTemplate(t)}static loadTemplates(t){return Array.isArray(t)||(t=[t]),foundry.applications.handlebars.loadTemplates(t)}static isValidCSSRule(t){if(!t||typeof t!="string")return!1;const e=t.trim();if(!e)return!1;try{const s=document.createElement("style"),i=`${e} { color: inherit; }`;s.textContent=i,document.head.appendChild(s);const o=!!(s.sheet&&s.sheet.cssRules&&s.sheet.cssRules.length>0);return document.head.removeChild(s),o}catch(s){return r.log("CSS validation error:",[s,t]),!1}}static processCSSRules(t,e){if(!t||!e)return"";const s=he(this,Te,Ue).call(this,t),i=e+` {
`+s.baseProperties.join(`
`)+`
}`,o=[],l=new Map;return s.nestedRules.forEach(n=>{const{selector:a,content:c}=n;if(a.startsWith("&")){const h=a.substring(1),p=e.split(",").map(m=>m.trim()).filter(Boolean).map(m=>m+h).join(", ");o.push(`${p} {
${c}
}`);return}l.has(c)||l.set(c,[]);const d=a.split(",").map(h=>h.trim()),g=e.split(",").map(h=>h.trim()).filter(Boolean);d.forEach(h=>{g.forEach(p=>{l.get(c).push(`${p} ${h}`)})})}),l.forEach((n,a)=>{o.push(`${n.join(", ")} {
${a}
}`)}),i+`

`+o.join(`

`)}static getActorOwner(t){const e=t.ownership||{};for(const[s,i]of Object.entries(e))if(i>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const o=game.users.get(s);if(o&&!o.isGM)return o}if((e==null?void 0:e.default)>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const s=game.users.filter(i=>!i.isGM)[0];if(s)return s}return null}static confirmReload(t=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredTitle"),e=game.i18n.localize("FLASH_ROLLS.ui.dialogs.reloadRequiredLabel"),s={}){const i={title:t,content:e,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.reloadButton"),callback:()=>(r.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("FLASH_ROLLS.ui.buttons.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(i,s),foundry.applications.api.DialogV2.confirm(i)}}Te=new WeakSet,Ue=function(t){const e=[],s=[],i=t.split(`
`);let o=null,l=0;for(let n=0;n<i.length;n++){const a=i[n].trim();if(!a)continue;const c=(a.match(/{/g)||[]).length,d=(a.match(/}/g)||[]).length;if(a.includes("{")&&!o){o={selector:a.substring(0,a.indexOf("{")).trim(),content:"",startLine:n},l=1;const h=a.substring(a.indexOf("{")+1).trim();h&&!h.includes("}")&&(o.content+=h+`
`)}else o?(l+=c-d,l>0?o.content+=a+`
`:(o.content=o.content.replace(/}\s*$/,"").trim(),s.push(o),o=null)):!a.includes("{")&&!a.includes("}")&&e.push(a)}return{baseProperties:e,nestedRules:s}},oe(G,Te),D(G,"wrapFontName",t=>{const e=t.replace(/['"`]/g,"");return e.includes(" ")?`"${e}"`:e});const{FormDataExtended:Tt}=foundry.utils,{ApplicationV2:lt,HandlebarsApplicationMixin:at}=foundry.applications.api;var ze,ee,de,we,se,$e,je,We;const k=class k extends at(lt){constructor(){super(...arguments);D(this,"_onRender",(e,s)=>{E(),re(k,ee,this.element);const i=W(k,ee).querySelectorAll(".toggle-hint");r.log("_onRender",[e,s,this.element]),i.forEach(l=>{l.addEventListener("click",()=>{W(k,ee).querySelectorAll("p.hint").forEach(n=>n.classList.toggle("shown"))})}),W(k,ee).querySelectorAll("select[data-current-value]").forEach(l=>{const n=String(l.dataset.currentValue),a=l.querySelector(`option[value="${n}"]`);a&&(a.selected=!0)}),r.log("_onRender",[e,s])})}_configureRenderParts(e){const s=super._configureRenderParts(e),i=k.getRestrictedTabs();return game.user.isGM||i.forEach(o=>{delete s[o]}),s}async _prepareContext(e){const s=await super._prepareContext(e);return s.activeTab=e.activeTab||Object.keys(s.tabs)[0],s.isGM=game.user.isGM,s}async _preparePartContext(e,s,i){var n,a,c;const o=await super._preparePartContext(e,s,i);e in s.tabs&&(o.tab=o.tabs[e]),E(),Ye();const l=k.getRestrictedTabs();switch(game.user.isGM||l.forEach(d=>{delete o.tabs[d]}),e){case"tabs":break;case"footer":{o.buttons=[{type:"button",icon:"",label:"FLASH_ROLLS.ui.buttons.reset",action:"redefine"},{type:"submit",icon:"",label:"FLASH_ROLLS.ui.buttons.save"}];break}default:{o.tab=o.tabs[e];const d=((n=k.PARTS[e])==null?void 0:n.menuKey)||null;if(d){const g=k.getMenuContext(d);g.fields&&(o.fields={...o.fields,...g.fields}),g.fieldDefaults&&(o.fieldDefaults={...o.fieldDefaults,...g.fieldDefaults}),g.fieldValues&&Object.assign(o,g.fieldValues),o.sidebarTabs=Object.values(((c=(a=foundry.applications)==null?void 0:a.sidebar)==null?void 0:c.tabs)||{}).map(h=>({tabName:h.tabName,name:h.name,hideForGM:!1,hideForPlayer:!1,localizedName:`FLASH_ROLLS.settings.sidebarTabs.${h.name}`}))}break}}return r.log("_preparePartContext",[o,e]),o}static getMenuContext(e){var a;const s=E(),i=((a=s[e])==null?void 0:a.fields)||null;if(!i)return{};const o={},l={},n={};return i.forEach(c=>{if(s[c]){const d=A.get(s[c].tag);o[c]=s[c],l[c]=d!==void 0?d:s[c].default,n[c]=s[c].default}}),{fields:o,fieldValues:l,fieldDefaults:n}}static getRestrictedTabs(){const e=[];return Object.entries(k.PARTS).forEach((s,i)=>{s[0]!=="tabs"&&s[0]!=="footer"&&s[1].isGMOnly&&e.push(s[0])}),e}static updateSettings(e){let s=!1;const i=E(),n=W(k,ee).querySelector(".form-content.active").dataset.tab;if(re(k,de,n),!e)return;let a;return e.object&&(a=foundry.utils.expandObject(e.object)),Object.entries(a).forEach(([c,d])=>{var g;if(!c.endsWith("_value")&&(r.log("updateSettings #1",[i,i[c]]),a[c]!==void 0&&i[c])){const h=A.get(i[c].tag);A.set(i[c].tag,a[c]),(g=i[c])!=null&&g.requiresReload&&h!==a[c]&&(s=!0)}}),ui.notifications.info(game.i18n.localize("FLASH_ROLLS.notifications.settingsUpdated")),s}changeTab(e,s,i){super.changeTab(e,s,i),re(k,de,e)}};ee=new WeakMap,de=new WeakMap,we=new WeakMap,se=new WeakSet,$e=async function(e,s,i){e.preventDefault(),e.stopPropagation(),k.updateSettings(i)&&G.confirmReload()},je=async function(e,s){const i=E(),l=W(k,ee).querySelector(".form-content.active"),n=l.dataset.tab,a=k.PARTS[n].menuKey,c=i[a].default;l.querySelectorAll("input, select").forEach(g=>{g.value=c[g.name],g.type==="checkbox"&&(g.checked=c[g.name])}),r.log("#onReset",[W(k,de),n,e,s])},We=function(){const e=[];return Object.entries(k.PARTS).forEach(([s,i])=>{i.menuKey&&e.push({id:s,icon:"",group:"primary-tabs",label:`FLASH_ROLLS.settings.moduleSettingsMenu.tabs.${s}`})}),e},oe(k,se),oe(k,ee),oe(k,de),oe(k,we),D(k,"selectedTheme"),D(k,"DEFAULT_OPTIONS",{id:"flash-rolls-settings",tag:"form",window:{icon:"fas fa-cog",title:"FLASH_ROLLS.settings.moduleSettingsMenu.title",contentClasses:["standard-form","crlngn","tabbed-settings"],resizable:!0},position:{width:700,height:"auto"},actions:{redefine:he(k,se,je)},form:{handler:he(k,se,$e),closeOnSubmit:!0}}),D(k,"PARTS",{tabs:{template:"templates/generic/tab-navigation.hbs",isGMOnly:!1},generalSettings:{menuKey:"generalSettings",template:"modules/flash-rolls-5e/templates/settings-general.hbs",isGMOnly:!0},groupRolls:{menuKey:"groupRollsSettings",template:"modules/flash-rolls-5e/templates/settings-group-rolls.hbs",isGMOnly:!0},footer:{template:"templates/generic/form-footer.hbs",isGMOnly:!1}}),D(k,"TABS",{primary:{initial:"generalSettings",tabs:he(ze=k,se,We).call(ze),labelPrefix:""}});let Ee=k;function Ye(){return{moduleSettingsMenu:{tab:"",tag:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),name:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.title"),label:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.label"),hint:game.i18n.localize("FLASH_ROLLS.settings.moduleSettingsMenu.hint"),icon:"fas fa-cog",propType:Ee,restricted:!0}}}class A{static registerSettings(){const t=E();Object.entries(t).forEach(s=>{const i=s[1],o={name:i.label,hint:i.hint,default:i.default,type:i.propType,scope:i.scope,config:i.config,requiresReload:i.requiresReload||!1,restricted:i.scope===x.world,onChange:l=>A.apply(i.tag,l)};i.choices&&(o.choices=i.choices),r.log("registerSettings",[o,o.scope],!0);try{game.settings.register(_,i.tag,o)}catch(l){r.log(`Setting ${i.tag} already registered or error:`,l)}})}static registerSettingsMenu(){var s;const e=Object.entries(Ye()).find(i=>i[0]==="moduleSettingsMenu");if(e){const i=e[1];if(i.restricted&&((s=game.user)!=null&&s.isGM)||!i.restricted){const o={name:i.tag,label:i.label,hint:i.hint,icon:i.icon,type:i.propType,restricted:i.restricted};game.settings.registerMenu(_,i.tag,o)}}}static get(t,e=_){if(!t)return null;let s=!1;try{if(e===_)s=game.settings.get(e,t);else{let o=game.settings.storage.get("client")[`${e}.${t}`];o===void 0&&(o=game.settings.storage.get("world").getSetting(`${e}.${t}`),s=o==null?void 0:o.value)}}catch{return r.log(`Setting ${e}.${t} not found, returning false`),!1}return s}static set(t,e,s=_){if(!t)return!1;let i=game.settings.storage.get("client")[`${s}.${t}`];i||(i=game.settings.storage.get("world").getSetting(`${s}.${t}`),r.log("SettingsUtil.set - world Setting?",[i]));try{game.settings.set(s,t,e),r.log("SettingsUtil.set - success",[s,t,e])}catch(o){r.error("SettingsUtil.set - error",[o])}return!0}static apply(t,e){const s=E();switch(t){case s.rollRequestsEnabled.tag:A.applyRollRequestsEnabled(e);break}}static applyRollRequestsEnabled(t){const e=document.querySelector(".chat-controls .flash-rolls-icon");e&&(t?e.classList.add("active"):e.classList.remove("active"))}}Hooks.once(v.READY,()=>{dnd5e.applications.dice.DamageRollConfigurationDialog||r.warn("DamageRollConfigurationDialog not found in dnd5e.applications.dice")});function me(u){return class extends u{constructor(t={},e={},s={}){var i,o;super(t,e,s),this.actors=s.actors||[],this.sendRequest=s.sendRequest??s.sendRequest??!0,this.showDC=s.showDC||!1,this.dcValue=s.dcValue||null,this.rollKey=s.rollKey||t.skill||t.ability||null,this.rollTypeString=s.rollTypeString||null,this.windowTitle=((i=s.window)==null?void 0:i.title)||"",this.windowSubtitle=((o=s.window)==null?void 0:o.subtitle)||""}_buildConfig(t,e,s){const i=e==null?void 0:e.get("ability"),o=e==null?void 0:e.get("dc"),l=e==null?void 0:e.get(`rolls.${s}.situational`);if(r.log("_buildConfig",[l,e,t]),l)t.parts||(t.parts=[]),t.parts.push("@situational"),t.data||(t.data={}),t.data.situational=l;else if(t.parts){const a=t.parts.indexOf("@situational");a!==-1&&t.parts.splice(a,1)}i&&(t.ability=i,this.config.ability=i);const n=super._buildConfig(t,e,s);if(o){const a=parseInt(o);isNaN(a)||(n.options=n.options||{},n.options.target=a)}else this.dcValue!==void 0&&this.dcValue!==null&&(n.options=n.options||{},n.options.target=this.dcValue);return r.log(`${this.constructor.name}._buildConfig`,[this.config,e,n]),n}_onChangeForm(t,e){r.log("_onChangeForm",[e.target.value]),super._onChangeForm(t,e);const s=this.element.querySelector('input[name="flash5e-send-request"]');s&&(this.sendRequest=s.checked);const i=this.element.querySelector('input[name="dc"]');i&&i.value&&(this.dcValue=parseInt(i.value)||null)}_finalizeRolls(t){const e=super._finalizeRolls(t);if(r.log("_finalizeRolls #1",[e,this.sendRequest]),this.dcValue!==void 0&&this.dcValue!==null)for(const s of e)s.options.target=this.dcValue;return this.config.sendRequest=this.sendRequest,e}async _onRender(t,e){var s,i,o;await super._onRender(t,e),((o=(i=(s=this.config.rolls)==null?void 0:s[0])==null?void 0:i.data)!=null&&o.situational||this.config.situational)&&(r.log(`${this.constructor.name}._onRender`,["Triggering rebuild for initial situational bonus"]),setTimeout(()=>{this.rebuild()},100))}}}function nt(u,t){var i,o,l,n,a;let e=game.i18n.localize(`FLASH_ROLLS.rollTypes.${u}`)||u;const s=u==null?void 0:u.toLowerCase();if(t)switch(s){case f.SKILL:e+=` (${((i=CONFIG.DND5E.skills[t])==null?void 0:i.label)||t})`;break;case f.SAVE:e+=` (${((o=CONFIG.DND5E.abilities[t])==null?void 0:o.label)||t})`;break;case f.ABILITY:e+=` (${((l=CONFIG.DND5E.abilities[t])==null?void 0:l.label)||t})`;break;case f.TOOL:const c=(a=(n=CONFIG.DND5E.enrichmentLookup)==null?void 0:n.tools)==null?void 0:a[t];if(c!=null&&c.id){const d=dnd5e.documents.Trait.getBaseItem(c.id,{indexOnly:!0});e+=` (${(d==null?void 0:d.name)||t})`}else e+=` (${t})`;break;case f.CUSTOM:e=`${e}: ${t}`;break}return e}function rt(u,t=nt){if(u.length===0)return;const e={};for(const i of u){const o=`${i.rollType}_${i.rollKey||""}`;e[o]||(e[o]={rollType:i.rollType,rollKey:i.rollKey,actors:[],gm:i.gm}),e[o].actors.push(i.actor)}const s=Object.values(e);if(s.length===1&&s[0].actors.length===1){const i=s[0];ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestReceived",{gm:i.gm,rollType:t(i.rollType,i.rollKey)}))}else{const i=[];for(const o of s){const l=t(o.rollType,o.rollKey),n=o.actors.join(", ");i.push(`${l} (${n})`)}ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsReceivedMultiple",{gm:s[0].gm,requests:i.join("; ")}))}}function Qe(u){const t=u.ownership||{};for(const[e,s]of Object.entries(t))if(s>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER){const i=game.users.get(e);if(i&&!i.isGM)return i}return null}function ct(u,t=game.user){if(!(u!=null&&u.length))return;u.map(s=>canvas.tokens.get(s)).filter(s=>s).forEach(s=>s.setTarget(!0,{user:t}))}function Le(u){return u.type!=="character"&&u.type!=="npc"?!1:Object.entries(u.ownership).some(([t,e])=>{const s=game.users.get(t);return s&&!s.isGM&&e>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})}function ye(u){if(u.type!=="character"&&u.type!=="npc")return!1;const t=game.scenes.active;return t&&t.tokens.some(e=>e.actorId===u.id)}function be(u,t){if(!game.scenes.active)return;const s=canvas.tokens.placeables.filter(i=>{var o;return((o=i.actor)==null?void 0:o.id)===u});for(const i of s)t?i.control({releaseOthers:!1}):i.release()}function Se(u){return new Promise(t=>setTimeout(t,u))}function Pe(){var u;return((u=ui==null?void 0:ui.sidebar)==null?void 0:u.expanded)||!1}function qe(u){const t=document.querySelector("body");u?t.classList.add("flash5e-sidebar-expanded"):t.classList.remove("flash5e-sidebar-expanded"),Me()}function xe(u,t){var l;const e=[];if(!u||t.size===0)return e;const s=j.ROLL_REQUEST_OPTIONS[u];if(!s||!s.subList)return e;const i=Array.from(t)[0],o=game.actors.get(i);if(s.subList==="tools"){const n=((l=CONFIG.DND5E.enrichmentLookup)==null?void 0:l.tools)||CONFIG.DND5E.tools||{};for(const[a,c]of Object.entries(n)){let d=a;if(c!=null&&c.id){const g=dnd5e.documents.Trait.getBaseItem(c.id,{indexOnly:!0});d=(g==null?void 0:g.name)||a}else d=a.replace(/([A-Z])/g," $1").replace(/^./,g=>g.toUpperCase()).trim();e.push({id:a,name:d,rollable:!0})}e.sort((a,c)=>a.name.localeCompare(c.name))}else if(o&&s.actorPath){const n=foundry.utils.getProperty(o,s.actorPath)||{},a=CONFIG.DND5E[s.subList];for(const[c,d]of Object.entries(n)){let g="";s.subList==="skills"&&(a!=null&&a[c])||s.subList==="abilities"&&(a!=null&&a[c])?g=a[c].label:g=d.label||game.i18n.localize(d.name||c)||c,e.push({id:c,name:g,rollable:!0})}s.subList==="skills"&&e.sort((c,d)=>c.name.localeCompare(d.name))}return e}const V=class V{static notify(t,e,s={}){if(!s.batch){ui.notifications[t](e);return}s.batchData&&(V.pendingNotifications.push(s.batchData),V.notificationTimer&&clearTimeout(V.notificationTimer),V.notificationTimer=setTimeout(()=>{rt(V.pendingNotifications),V.pendingNotifications=[],V.notificationTimer=null},V.NOTIFICATION_BATCH_DELAY))}static notifyRollRequestsSent(t,e){const s=Object.entries(t);if(s.length!==0)if(s.length===1){const i=Object.values(t)[0],o=i.actors.map(l=>l.name).join(", ");ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentSingle",{rollType:e,actors:o,player:i.player.name}))}else{const i=s.map(([o,l])=>{const n=l.actors.map(a=>a.name).join(", ");return`${l.player.name} (${n})`});ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestsSentMultiple",{rollType:e,count:s.length,players:i.join("; ")}))}}static clearPending(){V.notificationTimer&&(clearTimeout(V.notificationTimer),V.notificationTimer=null),V.pendingNotifications=[]}};D(V,"pendingNotifications",[]),D(V,"notificationTimer",null),D(V,"NOTIFICATION_BATCH_DELAY",500);let H=V;function ut(u){var s;const t=[],e=[];for(const i of u){const o=((s=i.system.attributes.hp)==null?void 0:s.value)||0,l=i.system.attributes.death||{},n=l.success||0,a=l.failure||0;o<=0&&n<3&&a<3?t.push(i):e.push(i.name)}return e.length>0&&H.notify("info",game.i18n.format("FLASH_ROLLS.notifications.actorsSkippingDeathSave",{actors:e.join(", ")})),t}function dt(u){const t=[],e=[];for(const s of u){const i=Qe(s);i?t.push({actor:s,owner:i}):e.push(s)}return{pcActors:t,npcActors:e}}function Me(u=!0){const t=document.querySelector("#chat-notifications #roll-privacy"),e=t?G.getFullWidth(t):36;G.addCSSVars("--flash-rolls-menu-offset",e+"px")}const I={addSituationalBonus(u,t){var e;return r.log("Config before adding bonus:",[t,u]),t&&((e=u.rolls)!=null&&e[0])&&(u.rolls[0].parts||(u.rolls[0].parts=[]),u.rolls[0].data||(u.rolls[0].data={}),u.rolls[0].data.situational=t,u.rolls[0].parts.includes("@situational")||u.rolls[0].parts.push("@situational"),r.log("Config after adding bonus:",[u])),u},buildRollConfig(u,t,e={}){var o;const s={rolls:[{parts:t.parts||[],data:t.data||{},options:{...t.options||{},...((o=t.options)==null?void 0:o._fromFlashRolls)&&{_fromFlashRolls:!0}}}],advantage:u.config.advantage||!1,disadvantage:u.config.disadvantage||!1,target:u.config.target,subject:null,chatMessage:!0,legacy:!1,...u.config.rollMode&&{rollMode:u.config.rollMode},...e},i=u.config.situational;return i&&this.addSituationalBonus(s,i),this.ensureRollFlags(s,u)},ensureRollFlags(u,t){return u.isRollRequest=!game.user.isGM,u._showRequestedBy=!0,u._requestedBy=t.config.requestedBy||"GM",u},validateActors(u){return!u||u.length===0?null:(typeof u[0]=="string"&&(u=u.map(t=>game.actors.get(t)).filter(t=>t)),u.length>0?u:null)},getRollClass(u){const t=u==null?void 0:u.toLowerCase();return[f.DAMAGE,f.HEALING].includes(t)?CONFIG.Dice.DamageRoll||CONFIG.Dice.BasicRoll:[f.FORMULA,f.CUSTOM,f.HIT_DIE].includes(t)?CONFIG.Dice.BasicRoll:CONFIG.Dice.D20Roll},shouldShowDC(u){const t=u==null?void 0:u.toLowerCase();return[f.SAVE,f.SAVING_THROW,f.ABILITY,f.ABILITY_CHECK,f.CONCENTRATION,f.SKILL,f.TOOL].includes(t)},createBaseRollConfig(u,t,e){const s=t==null?void 0:t.toLowerCase(),i={data:u.getRollData(),subject:u,rolls:[{parts:[],data:u.getRollData(),options:{}}]};switch(s){case f.SKILL:i.skill=e;break;case f.TOOL:i.tool=e;break;case f.SAVE:case f.SAVING_THROW:case f.ABILITY:case f.ABILITY_CHECK:i.ability=e;break;case f.HIT_DIE:i.rolls[0].options.flavor="Hit Die";break}return i},createMessageConfig(u,t=null){const e={create:!1,data:{speaker:ChatMessage.getSpeaker({actor:u})}};return t&&(e.rollMode=t),e},async triggerRollDialog(u,t,e,s){const i=new u(t,e,s);return await new Promise(l=>{i.addEventListener("close",()=>{l({rolls:i.rolls,config:i.config,message:i.message,sendRequest:i.sendRequest,critical:i.config.critical,isCritical:i.config.isCritical})},{once:!0}),i.render({force:!0})})},processDialogResult(u,t,e,s,i={}){var R,y,L,b,S,T;if(!(u!=null&&u.rolls)||u.rolls.length===0)return null;const o=e==null?void 0:e.toLowerCase(),l=u.rolls[0];let n=!1,a=!1;((R=l==null?void 0:l.options)==null?void 0:R.advantageMode)!==void 0&&(n=l.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,a=l.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const c=((y=l==null?void 0:l.data)==null?void 0:y.situational)||"",d=(L=l==null?void 0:l.options)==null?void 0:L.target,g={rolls:[{parts:((b=l==null?void 0:l.parts)==null?void 0:b.slice())||[],data:c?{situational:c}:{},options:d?{target:d}:{}}],subject:t[0],advantage:n,disadvantage:a,target:d,sendRequest:u.sendRequest,isRollRequest:u.sendRequest,skipRollDialog:i.skipRollDialog||!1,chatMessage:!0},h=E(),p=A.get(h.publicPlayerRolls.tag)===!0,m=this.determineRollMode(p,(S=u.message)==null?void 0:S.rollMode);return g.rollMode=m,(T=u.config)!=null&&T.ability&&[f.SKILL,f.TOOL].includes(o)&&(g.ability=u.config.ability),g},determineRollMode(u,t){return t||(u?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode"))},isPlayerOwned(u){return Object.entries(u.ownership).some(([t,e])=>{const s=game.users.get(t);return s&&!s.isGM&&e>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})},isPlayerOwnerActive(u){const t=Qe(u);return t&&t.active},calculateStandardRule(u,t){const e=u.filter(o=>o.total>=t).length,s=u.length-e,i=Math.ceil(u.length/2);return{finalResult:e>=i,successes:e,failures:s,summary:game.i18n.format("FLASH_ROLLS.groupRoll.standardRule.summary",{successes:e,total:u.length,threshold:i}),method:"Standard Rule"}},calculateGroupAverage(u,t){const e=u.reduce((i,o)=>i+o.total,0),s=Math.floor(e/u.length);return{finalResult:s,average:s,success:s>=t,summary:game.i18n.format("FLASH_ROLLS.groupRoll.groupAverage.summary",{average:s,dc:t}),method:"Group Average"}},calculateLeaderWithHelp(u,t,e,s,i){var p;let o=-999,l=null,n=0;for(const m of e){const R=this._getActorModifier(m,s,i);R>o&&(o=R,l=m.id,n=R)}const a=u.find(m=>m.actorId===l);if(!a)return{finalResult:0,error:"Leader actor did not roll",method:"Leader with Help"};const c=u.filter(m=>m.actorId!==l),d=c.filter(m=>m.total>=t).length,g=c.filter(m=>m.total<t).length,h=a.total+d-g;return{finalResult:h,leaderRoll:a.total,leaderName:(p=e.find(m=>m.id===l))==null?void 0:p.name,leaderModifier:n,bonus:d,penalty:g,success:h>=t,summary:game.i18n.format("FLASH_ROLLS.groupRoll.leaderWithHelp.summary",{leaderRoll:a.total,bonus:d,penalty:g,adjustedResult:h,dc:t}),method:"Leader with Help"}},calculateWeakestLink(u,t,e,s,i){var h;let o=999,l=null,n=0;for(const p of e){const m=this._getActorModifier(p,s,i);m<o&&(o=m,l=p.id,n=m)}const a=u.find(p=>p.actorId===l);if(!a)return{finalResult:0,error:"Weakest link actor did not roll",method:"Weakest Link"};const c=u.filter(p=>p.actorId!==l&&p.total>=t).length,d=a.total+c,g=c===1?game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successSingular"):game.i18n.localize("FLASH_ROLLS.groupRoll.weakestLink.successPlural");return{finalResult:d,weakestRoll:a.total,weakestName:(h=e.find(p=>p.id===l))==null?void 0:h.name,weakestModifier:n,bonus:c,success:d>=t,summary:game.i18n.format("FLASH_ROLLS.groupRoll.weakestLink.summary",{weakestRoll:a.total,bonus:c,successWord:g,adjustedResult:d,dc:t}),method:"Weakest Link"}},_getActorModifier(u,t,e){var i,o,l,n,a,c,d;switch(t==null?void 0:t.toLowerCase()){case f.SKILL:return((i=u.system.skills[e])==null?void 0:i.total)||((o=u.system.skills[e])==null?void 0:o.mod)||0;case f.SAVE:case f.SAVING_THROW:return((n=(l=u.system.abilities[e])==null?void 0:l.save)==null?void 0:n.value)||((a=u.system.abilities[e])==null?void 0:a.save)||0;case f.ABILITY:case f.ABILITY_CHECK:return((c=u.system.abilities[e])==null?void 0:c.mod)||0;case f.TOOL:if((d=u.system.tools)!=null&&d[e])return u.system.tools[e].total||u.system.tools[e].mod||0;const g=u.items.find(h=>h.type==="tool"&&h.system.toolType===e);return(g==null?void 0:g.system.bonus)||0;default:return 0}},getGroupResult(u,t,e,s,i){if(!u.every(c=>c.total!==null&&c.total!==void 0))return{complete:!1,success:!1,result:0};const l=E(),n=A.get(l.groupRollResultMode.tag)||1;let a;switch(n){case 1:return a=this.calculateStandardRule(u,t),{complete:!0,success:a.finalResult,result:a.finalResult?1:0,details:a};case 2:return a=this.calculateGroupAverage(u,t),{complete:!0,success:a.success,result:a.finalResult,details:a};case 3:return a=this.calculateLeaderWithHelp(u,t,e,s,i),{complete:!0,success:a.success,result:a.finalResult,details:a};case 4:return a=this.calculateWeakestLink(u,t,e,s,i),{complete:!0,success:a.success,result:a.finalResult,details:a};default:return a=this.calculateStandardRule(u,t),{complete:!0,success:a.finalResult,result:a.finalResult?1:0,details:a}}}};class X extends me(dnd5e.applications.dice.D20RollConfigurationDialog){constructor(t={},e={},s={}){s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(t,e,s),r.log("constructor - initializing GM Dialog",[t,e,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}get title(){return this.windowTitle||super.title}_prepareConfigurationData(t,e,s,i){r.log("_prepareConfigurationData",[t,e,s,i]);const o=super._prepareConfigurationData(t,e,s,i);return o.showDC=this.showDC,o.dcValue=this.dcValue,o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(t,e,s){return r.log("_preparePartContext",[t,e,s]),e=await super._preparePartContext(t,e,s),t==="configuration"&&(e.showDC=this.showDC,e.dcValue=this.dcValue,e.sendRequest=this.sendRequest,e.actorCount=this.actors.length),e}async _onRender(t,e){if(r.log("_onRender",[t,e]),super._onRender(t,e),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const i={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await G.renderTemplate(`modules/${_}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[this.element]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(e=>{e.addEventListener("click",s=>{s.currentTarget.dataset.action})})}static async initConfiguration(t,e,s,i={}){var b,S,T,C,O,w,M,U,P;if(t=I.validateActors(t),!t)return null;const o=t[0];r.log("GMRollConfigDialog, initConfiguration",[]);const l=e==null?void 0:e.toLowerCase(),n=E(),a=A.get(n.publicPlayerRolls.tag)===!0,c=I.determineRollMode(a),d=I.shouldShowDC(l),g=I.getRollClass(l),h=I.createBaseRollConfig(o,e,s),p=I.createMessageConfig(o,c),m={options:{actors:t,sendRequest:t.some(q=>I.isPlayerOwned(q)),showDC:d,rollKey:s,rollType:g,rollTypeString:l,window:{title:X._getRollTitle(l,s,o),subtitle:X._getSubtitle(t)},position:{width:420,height:"auto"},...i}},R=await I.triggerRollDialog(this,h,p,m.options),y=I.processDialogResult(R,t,e,s,i);if(!y)return null;if((b=R.config)!=null&&b.ability&&[f.SKILL,f.TOOL].includes(l)){const q=((T=(S=o.system.skills)==null?void 0:S[s])==null?void 0:T.ability)||((O=(C=CONFIG.DND5E.skills)==null?void 0:C[s])==null?void 0:O.ability);R.config.ability!==q&&(y.ability=R.config.ability)}let L=m.options.window.title;if(R.config.ability&&[f.SKILL,f.TOOL].includes(l)){const q=((w=CONFIG.DND5E.abilities[R.config.ability])==null?void 0:w.label)||R.config.ability;if(l===f.SKILL){const Y=((M=CONFIG.DND5E.skills[s])==null?void 0:M.label)||s;L=game.i18n.format("DND5E.SkillPromptTitle",{skill:Y,ability:q})}else if(l===f.TOOL){const Y=(P=(U=CONFIG.DND5E.enrichmentLookup)==null?void 0:U.tools)==null?void 0:P[s];let ie=s;if(Y!=null&&Y.id){const K=dnd5e.documents.Trait.getBaseItem(Y.id,{indexOnly:!0});ie=(K==null?void 0:K.name)||s}L=game.i18n.format("DND5E.ToolPromptTitle",{tool:ie,ability:q})}}return y.rollTitle=L,y.rollType=l,y.rollKey=s,y}static _getRollTitle(t,e,s){var l,n,a,c,d,g,h,p,m,R,y,L,b,S,T,C,O,w;r.log("GMRollConfigDialog._getRollTitle",[t,e,s]),r.log("GMRollConfigDialog._getRollTitle - Detailed",{rollType:t,rollKey:e,actorName:s==null?void 0:s.name,actorAbilities:(l=s==null?void 0:s.system)!=null&&l.abilities?Object.keys(s.system.abilities):[],actorSkills:(n=s==null?void 0:s.system)!=null&&n.skills?Object.keys(s.system.skills):[],actorInitAbility:(d=(c=(a=s==null?void 0:s.system)==null?void 0:a.attributes)==null?void 0:c.init)==null?void 0:d.ability});let i="";const o=t==null?void 0:t.toLowerCase();switch([f.SAVE,f.ABILITY,f.ABILITY_CHECK].includes(o)&&!e&&r.warn("Missing rollKey for roll type",[o,e]),o){case f.SKILL:const M=((g=CONFIG.DND5E.skills[e])==null?void 0:g.label)||e,U=(h=s==null?void 0:s.system.skills)==null?void 0:h[e],P=(U==null?void 0:U.ability)||((p=CONFIG.DND5E.skills[e])==null?void 0:p.ability)||"int",q=((m=CONFIG.DND5E.abilities[P])==null?void 0:m.label)||P;i=game.i18n.format("DND5E.SkillPromptTitle",{skill:M,ability:q});break;case f.SAVE:case f.SAVING_THROW:const Y=((R=CONFIG.DND5E.abilities[e])==null?void 0:R.label)||e;i=game.i18n.format("DND5E.SavePromptTitle",{ability:Y});break;case f.ABILITY:case f.ABILITY_CHECK:const ie=((y=CONFIG.DND5E.abilities[e])==null?void 0:y.label)||e;i=game.i18n.format("DND5E.AbilityPromptTitle",{ability:ie});break;case f.CONCENTRATION:i=game.i18n.localize("DND5E.Concentration");break;case f.TOOL:const K=(b=(L=CONFIG.DND5E.enrichmentLookup)==null?void 0:L.tools)==null?void 0:b[e];let ge=e;if(K!=null&&K.id){const Ce=dnd5e.documents.Trait.getBaseItem(K.id,{indexOnly:!0});ge=(Ce==null?void 0:Ce.name)||e}const fe=(S=s==null?void 0:s.system.tools)==null?void 0:S[e],Ne=(fe==null?void 0:fe.ability)||((O=(C=(T=CONFIG.DND5E.enrichmentLookup)==null?void 0:T.tools)==null?void 0:C[e])==null?void 0:O.ability)||"int",Ze=((w=CONFIG.DND5E.abilities[Ne])==null?void 0:w.label)||Ne;i=game.i18n.format("DND5E.ToolPromptTitle",{tool:ge,ability:Ze});break;case f.DEATH_SAVE:i=game.i18n.localize("DND5E.DeathSave");break;case f.INITIATIVE:case f.INITIATIVE_DIALOG:i=game.i18n.localize("DND5E.Initiative");break;default:i=game.i18n.localize("DND5E.Roll")}return r.log("_getRollTitle",[o,i]),i}static _getSubtitle(t=[]){return t.length===1?t[0].name:t.length>1?game.i18n.localize("FLASH_ROLLS.ui.dialogs.multipleActors"):""}}class ve extends me(dnd5e.applications.dice.RollConfigurationDialog){constructor(t={},e={},s={}){s.rollType=CONFIG.Dice.BasicRoll||Roll,s.showDC=!1,super(t,e,s),r.log("constructor",[t,e,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config","hit-die-config"]})}_prepareConfigurationData(t,e,s,i){const o=super._prepareConfigurationData(t,e,s,i);return r.log("GMHitDieConfigDialog._prepareConfigurationData",[o]),o.formula="Hit Die (varies by actor)",o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(t,e,s){return e=await super._preparePartContext(t,e,s),t==="configuration"&&(e.sendRequest=this.sendRequest,e.actorCount=this.actors.length,e.formula="Hit Die (varies by actor)"),e}async _onRender(t,e){if(super._onRender(t,e),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const i={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await G.renderTemplate(`modules/${_}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}}async _processSubmitData(t,e,s){await super._processSubmitData(t,e,s),this.sendRequest=s.get("flash5e-send-request")!=="false",r.log("_processSubmitData",[s,this.config])}_finalizeRolls(t){const e=super._finalizeRolls(t);return this.config.sendRequest=this.sendRequest,r.log("GMHitDieConfigDialog._finalizeRolls - before merge",[e]),e}static async initConfiguration(t,e,s,i={}){var m;if(t=I.validateActors(t),!t)return null;const o=t[0];r.log("GMHitDieConfigDialog, initConfiguration",[]);const l=E(),n=A.get(l.publicPlayerRolls.tag)===!0,a=I.determineRollMode(n),c={data:o.getRollData(),subject:o,rolls:[{parts:[],data:o.getRollData(),options:{flavor:"Hit Die Roll"}}]},d=I.createMessageConfig(o,a),g={options:{actors:t,sendRequest:t.some(R=>I.isPlayerOwned(R)),rollKey:s,rollType:CONFIG.Dice.BasicRoll||Roll,window:{title:game.i18n.localize("DND5E.HitDice"),subtitle:X._getSubtitle(t)},position:{width:420,height:"auto"},...i}},h=await I.triggerRollDialog(this,c,d,g.options);if(!(h!=null&&h.rolls)||h.rolls.length===0)return null;r.log("GMHitDieConfigDialog - dialog result",[h.rolls]);const p=I.processDialogResult(h,t,e,s,i);return p?((m=h.config)!=null&&m.ability&&(p.ability=h.config.ability),p):null}}class He extends me(dnd5e.applications.dice.SkillToolRollConfigurationDialog){constructor(t={},e={},s={}){const i=foundry.utils.mergeObject(t,{chooseAbility:!0});s.rollType=s.rollType||CONFIG.Dice.D20Roll,super(i,e,s),r.log("constructor",[t,e,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(t,e,s,i){r.log("_prepareConfigurationData",[t,e,s,i]);const o=super._prepareConfigurationData(t,e,s,i);return o.showDC=this.showDC,o.dcValue=this.dcValue,o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(t,e,s){return r.log("_preparePartContext",[t,e,s]),e=await super._preparePartContext(t,e,s),t==="configuration"&&(e.showDC=this.showDC,e.dcValue=this.dcValue,e.sendRequest=this.sendRequest,e.actorCount=this.actors.length),e}async _onRender(t,e){if(r.log("_onRender",[t,e]),super._onRender(t,e),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&(this.showDC||this.actors.length>0)){const i={showDC:this.showDC,dcValue:this.dcValue,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await G.renderTemplate(`modules/${_}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}this._attachButtonListeners()}_attachButtonListeners(){r.log("_attachButtonListeners",[]),this.element.querySelectorAll('[data-action="advantage"], [data-action="normal"], [data-action="disadvantage"]').forEach(e=>{e.addEventListener("click",s=>{s.currentTarget.dataset.action})})}static async initConfiguration(t,e,s,i={}){var b,S,T,C,O,w;if(t=I.validateActors(t),!t)return null;const o=t[0];r.log("GMSkillToolConfigDialog, initConfiguration",[]);const l=e==null?void 0:e.toLowerCase(),n=E(),a=A.get(n.publicPlayerRolls.tag)===!0,c=I.determineRollMode(a),d=I.shouldShowDC(l),g=CONFIG.Dice.D20Roll;let h=null;if(l===f.SKILL){const M=o.system.skills[s];h=(M==null?void 0:M.ability)||((b=CONFIG.DND5E.skills[s])==null?void 0:b.ability)||"int"}else if(l===f.TOOL){const M=(S=o.system.tools)==null?void 0:S[s];h=(M==null?void 0:M.ability)||((O=(C=(T=CONFIG.DND5E.enrichmentLookup)==null?void 0:T.tools)==null?void 0:C[s])==null?void 0:O.ability)||"int"}const p={data:o.getRollData(),subject:o,ability:h,chooseAbility:!0,rolls:[{parts:[],data:o.getRollData(),options:{}}]};l===f.SKILL?p.skill=s:l===f.TOOL&&(p.tool=s);const m=I.createMessageConfig(o,c),R={options:{actors:t,sendRequest:t.some(M=>I.isPlayerOwned(M)),showDC:d,rollKey:s,rollType:g,rollTypeString:l,window:{title:X._getRollTitle(l,s,o),subtitle:X._getSubtitle(t)},position:{width:420,height:"auto"},...i}},y=await I.triggerRollDialog(this,p,m,R.options),L=I.processDialogResult(y,t,e,s,i);return L?((w=y.config)!=null&&w.ability&&[f.SKILL,f.TOOL].includes(l)&&(L.ability=y.config.ability),L.rollTitle=R.options.window.title,L.rollType=l,L.rollKey=s,L):null}}class gt extends me(dnd5e.applications.dice.DamageRollConfigurationDialog){constructor(t={},e={},s={}){const i=foundry.utils.mergeObject({configure:!0},t);super(i,e,s),r.log("GMDamageConfigDialog.constructor",[i,e,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","damage-roll","gm-roll-config"]})}_prepareConfigurationData(t,e,s,i){r.log("GMDamageConfigDialog._prepareConfigurationData",[t,e,s,i]);const o=super._prepareConfigurationData(t,e,s,i);return o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _onRender(t,e){if(await super._onRender(t,e),this.actors.length>0){const s=this.element.querySelector(".rolls + .dialog-buttons");if(s&&!this.element.querySelector(".gm-roll-config-fields")){const i=document.createElement("div");i.className="gm-roll-config-fields",i.innerHTML=`
          <div class="form-group">
            <label class="checkbox">
              <input type="checkbox" name="flash5e-send-request" ${this.sendRequest?"checked":""}>
              ${game.i18n.localize("FLASH_ROLLS.ui.dialogs.sendRequestToPlayers")}
            </label>
          </div>
        `,s.insertAdjacentElement("beforebegin",i)}}}static async initConfiguration(t,e,s,i={},o={},l={}){var w,M,U,P,q;if(t=I.validateActors(t),r.log("GMDamageConfigDialog, initConfiguration actors",[t]),!t)return null;const n=t[0];r.log("GMDamageConfigDialog, initConfiguration #0",[o]);const a=E(),c=A.get(a.publicPlayerRolls.tag)===!0,d=I.determineRollMode(c,o.rollMode),g=e==null?void 0:e.toLowerCase(),h={subject:o.subject||n,data:n.getRollData(),critical:o.critical||{},rolls:o.rolls||[{parts:[],data:n.getRollData(),options:{}}]};r.log("GMDamageConfigDialog, initConfiguration #1",[h]);const p=I.createMessageConfig(n,d);r.log("GMDamageConfigDialog, initConfiguration #2",[p]);const{position:m,...R}=(l==null?void 0:l.options)||{},y={options:{actors:t,sendRequest:t.some(Y=>I.isPlayerOwned(Y)),rollKey:s,rollType:CONFIG.Dice.DamageRoll,rollTypeString:g,window:{title:game.i18n.localize("DND5E.DamageRoll"),subtitle:X._getSubtitle(t)},...R,...i}};r.log("GMDamageConfigDialog, initConfiguration #3",[y]);const L=await I.triggerRollDialog(this,h,p,y.options);if(r.log("GMDamageConfigDialog, initConfiguration #4",[L]),!(L!=null&&L.rolls)||L.rolls.length===0)return null;r.log("GMDamageConfigDialog, initConfiguration #5",[L]);const b=L.rolls[0],S=((w=b==null?void 0:b.data)==null?void 0:w.situational)||"",T=(M=b==null?void 0:b.options)==null?void 0:M.target,C={rolls:[{parts:[],data:S?{situational:S}:{},options:{...T&&{target:T},isCritical:((U=b==null?void 0:b.options)==null?void 0:U.isCritical)||(b==null?void 0:b.isCritical)||!1}}],subject:o.subject||n,target:T,isCritical:((P=b==null?void 0:b.options)==null?void 0:P.isCritical)||(b==null?void 0:b.isCritical)||!1,sendRequest:L.sendRequest,isRollRequest:L.sendRequest,skipRollDialog:i.skipRollDialog||!1,chatMessage:!0};r.log("GMDamageConfigDialog, initConfiguration #6",[C]);const O=I.determineRollMode(c,(q=L.message)==null?void 0:q.rollMode);return C.rollMode=O,C.rollTitle=y.options.window.title,C.rollType=g,C.rollKey=s,r.log("GMDamageConfigDialog, initConfiguration - result",[C]),C}}class ft extends me(dnd5e.applications.dice.AttackRollConfigurationDialog){constructor(t={},e={},s={}){super(t,e,s),r.log("GMAttackConfigDialog.constructor",[t,e,s])}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e2","roll-configuration","gm-roll-config"]})}_prepareConfigurationData(t,e,s,i){r.log("GMAttackConfigDialog._prepareConfigurationData",[t,e,s,i]);const o=super._prepareConfigurationData(t,e,s,i);return o.sendRequest=this.sendRequest,o.actorCount=this.actors.length,o}async _preparePartContext(t,e,s){return e=await super._preparePartContext(t,e,s),t==="configuration"&&(e.sendRequest=this.sendRequest,e.actorCount=this.actors.length),e}async _onRender(t,e){if(await super._onRender(t,e),this.element.querySelector(".gm-roll-config-fields"))return;let s=this.element.querySelector(".rolls .formulas");if(s&&this.actors.length>0){const i={showDC:!1,showSendRequest:this.actors.length>0,sendRequest:this.sendRequest},o=await G.renderTemplate(`modules/${_}/templates/gm-roll-config-fields.hbs`,i),l=document.createElement("div");l.className="gm-roll-config-fields",l.innerHTML=o,s.parentNode.insertBefore(l,s)}}_finalizeRolls(t){return this.config.sendRequest=this.sendRequest,!this.sendRequest&&this.config.isRollRequest&&(this.config.isRollRequest=!1),super._finalizeRolls(t)}static async initConfiguration(t,e,s,i={},o={},l={}){var U,P,q,Y,ie,K,ge;if(t=I.validateActors(t),!t)return null;const n=t[0];r.log("GMAttackConfigDialog, initConfiguration",[]);const a=E(),c=A.get(a.publicPlayerRolls.tag)===!0,d=e==null?void 0:e.toLowerCase(),g={subject:o.subject||n,data:n.getRollData(),rolls:[{parts:[],data:n.getRollData(),options:{}}]},h=I.determineRollMode(c),p=I.createMessageConfig(n,h),{position:m,...R}=(l==null?void 0:l.options)||{},y={options:{actors:t,sendRequest:t.some(fe=>I.isPlayerOwned(fe)),rollKey:s,rollType:CONFIG.Dice.D20Roll,rollTypeString:d,window:{title:game.i18n.localize("DND5E.Attack"),subtitle:X._getSubtitle(t)},...R,...i}},L=await I.triggerRollDialog(this,g,p,y.options);if(r.log("GMAttackConfigDialog, initConfiguration",[L==null?void 0:L.sendRequest]),!(L!=null&&L.rolls)||L.rolls.length===0)return null;const b=L.rolls[0];let S=!1,T=!1;((U=b==null?void 0:b.options)==null?void 0:U.advantageMode)!==void 0&&(S=b.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.ADVANTAGE,T=b.options.advantageMode===CONFIG.Dice.D20Roll.ADV_MODE.DISADVANTAGE);const C=((P=b==null?void 0:b.data)==null?void 0:P.situational)||"",O=(q=b==null?void 0:b.options)==null?void 0:q.target,w={rolls:[{parts:[],data:C?{situational:C}:{},options:{...O&&{target:O},...((Y=b==null?void 0:b.options)==null?void 0:Y.ammunition)&&{ammunition:b.options.ammunition},...((ie=b==null?void 0:b.options)==null?void 0:ie.attackMode)&&{attackMode:b.options.attackMode},...((K=b==null?void 0:b.options)==null?void 0:K.mastery)!==void 0&&{mastery:b.options.mastery}}}],subject:o.subject||n,advantage:S,disadvantage:T,target:O,sendRequest:L.sendRequest,isRollRequest:L.sendRequest,skipDialog:i.skipDialogs||!1,chatMessage:!G.isModuleOn("midi-qol")||!0},M=I.determineRollMode(c,(ge=L.message)==null?void 0:ge.rollMode);return w.rollMode=M,w.rollTitle=y.options.window.title,w.rollType=d,w.rollKey=s,r.log("GMAttackConfigDialog, initConfiguration - SIMPLIFIED result",[w]),w}}const ue=class ue{static isModuleActive(t){const e=game.modules.get(t);return e&&e.active}static getMidiQOL(){return this.isModuleActive("midi-qol")&&typeof MidiQOL<"u"?MidiQOL:null}static async prepareMidiQOLSettings(){let t=null;if(r.log("prepareMidiQOLSettings #0",[game.settings]),ue.isModuleActive("midi-qol")){r.log("prepareMidiQOLSettings #1",[MidiQOL]),t={autoFastForwardAbilityRolls:A.get("AutoFastForwardAbilityRolls","midi-qol")},clearTimeout(ue.midiTimeout),ue.midiTimeout=setTimeout(()=>{t&&A.set("AutoFastForwardAbilityRolls",t.autoFastForwardAbilityRolls,"midi-qol"),r.log("prepareMidiQOLSettings #timeout 1",[game.user.getFlag(_,"savedMidiQOLSettings")]),game.user.unsetFlag(_,"savedMidiQOLSettings"),r.log("prepareMidiQOLSettings #timeout 2",[game.user.getFlag(_,"savedMidiQOLSettings")])},4e3);try{r.log("prepareMidiQOLSettings #before",[A.get("AutoFastForwardAbilityRolls","midi-qol")]),await game.user.setFlag(_,"savedMidiQOLSettings",t),await A.set("AutoFastForwardAbilityRolls",!1,"midi-qol"),r.log("prepareMidiQOLSettings #after",[A.get("AutoFastForwardAbilityRolls","midi-qol"),MidiQOL])}catch(e){r.error("prepareMidiQOLSettings",[e])}finally{r.log("prepareMidiQOLSettings - saved temporary settings for MidiQOL",[])}}}};D(ue,"midiTimeout",null);let le=ue;class ht{static findActivityForRoll(t,e){var o;if(!((o=t==null?void 0:t.system)!=null&&o.activities))return null;const s=t.system.activities;switch(e==null?void 0:e.toLowerCase()){case f.ATTACK:const l=s.getByType("attack");return(l==null?void 0:l[0])||null;case f.DAMAGE:const n=s.getByType("attack");if((n==null?void 0:n.length)>0)return n[0];const a=s.getByType("damage");if((a==null?void 0:a.length)>0)return a[0];const c=s.getByType("save");return(c==null?void 0:c.length)>0?c[0]:null;case f.ITEM_SAVE:const d=s.getByType("save");return(d==null?void 0:d[0])||null;default:return null}}static getActivitiesByType(t,e){var s;return(s=t==null?void 0:t.system)!=null&&s.activities?t.system.activities.getByType(e):[]}static hasActivityForRoll(t,e){return r.log("hasActivityForRoll",[t,e]),!!this.findActivityForRoll(t,e)}static async executeActivityRoll(t,e,s,i,o){var g,h,p,m,R,y,L,b;r.log("executeActivityRoll",[t,e,s,i,o]);const l=le.isModuleActive("midi-qol"),n=t.items.get(s);if(!n)throw new Error(`Item ${s} not found on actor ${t.name}`);let a=null,c=null;if(i&&(a=(g=n.system.activities)==null?void 0:g.get(i)),a=a||this.findActivityForRoll(n,e),!a)throw new Error(`Activity not found on item ${n.name}`);r.log("executeActivityRoll - activity",[a,e]);const d=e==null?void 0:e.toLowerCase();if(a)switch(d){case f.ATTACK:r.log("executeActivityRoll - is attack activity",[o]);const S={attackMode:o.usage.attackMode,ammunition:o.usage.ammunition,mastery:o.usage.mastery,situational:(m=(p=(h=o.usage.rolls)==null?void 0:h[0])==null?void 0:p.data)==null?void 0:m.situational,advantage:o.usage.advantage,disadvantage:o.usage.disadvantage,rollMode:(R=o.message)==null?void 0:R.rollMode};await a.item.setFlag(_,"tempAttackConfig",S),r.log("executeActivityRoll - stored temp config as flag",[S]);try{if(o.message.create=!0,await a.use(o.usage,o.dialog,o.message),r.log("FLASH_ROLLS TEST",[o]),l&&le.getMidiQOL())return}catch(T){r.error("executeActivityRoll - attack roll error",[T])}finally{await a.item.unsetFlag(_,"tempAttackConfig")}return;case f.DAMAGE:r.log("executeActivityRoll - damage roll",[a,o]),l||(o.message.create=!0),c={critical:o.usage.critical||{},situational:o.usage.rolls[0].data.situational||"",rollMode:(y=o.message)==null?void 0:y.rollMode,create:((L=o.message)==null?void 0:L.create)!==!1},(a.type===Be.SAVE||a!=null&&a.damageOnly)&&await a.use(o.usage,o.dialog,o.message),await a.item.setFlag(_,"tempDamageConfig",c),r.log("executeActivityRoll - damage config with situational",[c]);try{if(l){const T=le.getMidiQOL();if(T){const C=(b=T.Workflow)==null?void 0:b.getWorkflow(a.uuid);if(r.log("executeActivityRoll - workflow",[C]),C){const O=await C.activity.rollDamage({...o,workflow:C})}return}}else r.log("executeActivityRoll - damage roll",[a,c,o]),await a.rollDamage(c,o.dialog,o.message)}catch(T){r.error(["executeActivityRoll - damage roll error",T])}finally{await a.item.unsetFlag(_,"tempDamageConfig")}return;default:r.log("executeActivityRoll - unknown roll type",[d]),await a.use(o.usage,o.dialog,o.message);return}throw new Error(`No suitable method found for ${d} on item ${n.name}`)}static getActivityDisplayInfo(t){return r.log("getActivityDisplayInfo",[t]),t?{name:t.name||t.constructor.metadata.label,type:t.type,icon:t.constructor.metadata.icon,canAttack:t.type==="attack",canDamage:["attack","damage","save"].includes(t.type),canSave:t.type==="save"}:null}static getDamageFormula(t){var s,i;if(r.log("getDamageFormula",[t]),!((i=(s=t==null?void 0:t.damage)==null?void 0:s.parts)!=null&&i.length))return null;const e=t.damage.parts.map(o=>o.formula).filter(o=>o);return e.length>0?e.join(" + "):null}static async syntheticItemRoll(t,e={}){r.log("syntheticItemRoll",[t,e]);const s=le.getMidiQOL();if(!s){r.warn("MidiQOL is not active");return}let i={consumeUsage:!1,consumeSpellSlot:!1},o={fastForward:!1,fastForwardAttack:!1,dialogOptions:{fastForward:!1,fastForwardAttack:!1},configureDialog:!0,workflowOptions:{fastForward:!1,fastForwardAttack:!1}};return e={...i,...e},await s.completeItemUse(t,e,o)}}const{ApplicationV2:pt,HandlebarsApplicationMixin:mt}=foundry.applications.api;class _e extends mt(pt){constructor(t={}){super(t),this.formula=t.formula||"",this.readonly=t.readonly||!1,this.actor=t.actor,this.callback=t.callback,this.diceCounts={}}static get DEFAULT_OPTIONS(){return foundry.utils.mergeObject(super.DEFAULT_OPTIONS,{id:"flash5e-custom-roll-dialog",classes:["flash5e-dialog","flash5e-custom-roll-dialog"],tag:"div",window:{title:"FLASH_ROLLS.ui.dialogs.customRollTitle",icon:"fas fa-dice-d20",resizable:!1,positioned:!0,frame:!0},position:{width:420,height:"auto"}})}_onClickAction(t,e){switch(e.dataset.action){case"rollDice":return this.rollDice(t,e);case"addDie":return this.addDie(t,e);case"cancel":return this.cancel(t,e)}}async _prepareContext(t={}){return{...await super._prepareContext(t),formula:this.formula,readonly:this.readonly}}_attachPartListeners(t,e,s){super._attachPartListeners(t,e,s);const i=e.querySelector("#custom-roll-formula"),o=e.querySelector("#formula-validation-message");i&&!this.readonly&&(i.addEventListener("input",l=>{this.formula=l.target.value.trim(),this.updateValidationMessage(o)}),this.formula&&this.updateValidationMessage(o))}updateValidationMessage(t){if(!t)return;if(!this.formula){t.textContent="&nbsp;",t.classList.remove("error","success");return}this.validateFormula(this.formula)?(t.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaValid"),t.classList.remove("error"),t.classList.add("success")):(t.textContent=game.i18n.localize("FLASH_ROLLS.ui.dialogs.formulaInvalid"),t.classList.remove("success"),t.classList.add("error"))}addDie(t,e){const s=e.dataset.die,i=this.element.querySelector("#custom-roll-formula");if(!i)return;const o=i.value.trim();if(o){const l=/(\d*)d(\d+)/g,n=new Map;let a=o,c;for(;(c=l.exec(o))!==null;){const h=parseInt(c[1]||"1"),p=c[2];n.set(p,(n.get(p)||0)+h),a=a.replace(c[0],"").trim()}const d=s.substring(1);n.set(d,(n.get(d)||0)+1);const g=[];for(const[h,p]of n)g.push(`${p}d${h}`);a=a.replace(/^\+\s*|\s*\+\s*$|\s*\+\s*\+/g,"").trim(),a&&a!=="+"?this.formula=`${g.join(" + ")} + ${a}`:this.formula=g.join(" + ")}else this.formula=`1${s}`;i.value=this.formula,i.dispatchEvent(new Event("input"))}validateFormula(t){var e;if(!t||t.trim()==="")return!1;try{return Roll.validate(t)}catch{try{return new Roll(t,((e=this.actor)==null?void 0:e.getRollData())||{}),!0}catch{return!1}}}async rollDice(){if(r.log("rollDice"),!this.validateFormula(this.formula)){ui.notifications.error(game.i18n.format("FLASH_ROLLS.notifications.invalidFormula",{formula:this.formula||"empty"}));return}this.callback&&await this.callback(this.formula),this.close()}cancel(){this.close()}static async prompt(t={}){return new Promise(e=>{const s=new this({...t,callback:i=>e(i)});s.addEventListener("close",()=>{s._resolved||e(null)}),s.render(!0)})}async close(t={}){return this._resolved=!0,super.close(t)}}D(_e,"PARTS",{main:{template:`modules/${j.ID}/templates/custom-roll-dialog.hbs`},footer:{template:`modules/${j.ID}/templates/custom-roll-dialog-footer.hbs`}});class B{static async initialize(){r.log("ChatMessageUtils.initialize"),await this.preloadTemplate(),this.registerEventListeners()}static registerEventListeners(){const t=(e,s)=>{e.querySelectorAll(".actor-result").forEach(l=>{l.addEventListener("click",n=>{if(n.target.closest(".dice-btn.rollable"))return;n.preventDefault(),n.stopPropagation();const a=l;r.log("actor-result click",[l]),a.classList.contains("expanded")?a.classList.remove("expanded"):a.classList.add("expanded")})}),e.querySelectorAll(".dice-btn.rollable").forEach(l=>{l.addEventListener("click",async n=>{var T;n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();const a=l.dataset,c=a.actorId,d=game.actors.get(c);if(!d){ui.notifications.warn("Actor not found");return}if(!(game.user.isGM||d.isOwner)){ui.notifications.warn(`You don't have permission to roll for ${d.name}`);return}const h=(T=a.type)==null?void 0:T.toLowerCase(),p=a.rollKey,m=a.groupRollId,R=a.dc?parseInt(a.dc):null;r.log("Rollable dice clicked",[h,p,c,m]);const y={rollKey:p,groupRollId:m,config:{advantage:!1,disadvantage:!1,target:R,rollMode:game.settings.get("core","rollMode")}},L={configure:!0,isRollRequest:!0},b={rollMode:game.settings.get("core","rollMode"),create:!0,isRollRequest:!0},S={parts:[],data:{},options:{}};try{const C=z[h];if(C)await C(d,y,S,L,b);else{let O;switch(h){case f.SKILL:O="rollSkill";break;case f.ABILITY:case f.ABILITY_CHECK:O="rollAbilityTest";break;case f.SAVE:case f.SAVING_THROW:O="rollAbilitySave";break;case f.TOOL:O="rollToolCheck";break;default:ui.notifications.warn(`Unknown roll type: ${h}`);return}O&&d[O]&&await d[O](p,{...y.config,messageOptions:{"flags.flash-rolls-5e.groupRollId":m}})}}catch(C){r.error("Error executing roll from chat",C),ui.notifications.error(`Failed to execute roll: ${C.message}`)}})});const i=e.querySelector(".group-roll-dc-control"),o=e.querySelector(".dc-input");if(i){const l=i.dataset.showToPlayers==="true";if(game.user.isGM||(i.style.display="none"),!game.user.isGM&&!l){const n=e.querySelector(".group-roll-footer .group-result-details");n&&(n.style.display="none")}}if(o)if(!game.user.isGM)o.readOnly=!0,o.style.cursor="not-allowed";else{let l=null;const n=async()=>{const a=parseInt(o.value);if(!o.value)return;if(isNaN(a)||a<1||a>99){o.value="";return}const c=o.dataset.messageId,d=game.messages.get(c);d&&await this.updateGroupRollDC(d,a)};o.addEventListener("input",a=>{l&&clearTimeout(l),l=setTimeout(()=>{n()},1e3)}),o.addEventListener("keypress",a=>{a.key==="Enter"&&(l&&clearTimeout(l),n())})}};Hooks.on(v.RENDER_CHAT_MESSAGE,(e,s)=>{e.getFlag(_,"isGroupRoll")&&t(s)}),Hooks.on(v.RENDER_CHAT_LOG,(e,s)=>{s.querySelectorAll(".flash5e-group-roll").forEach(o=>{const l=o.closest(".chat-message");if(l){const n=l.dataset.messageId,a=game.messages.get(n);a&&a.getFlag(_,"isGroupRoll")&&t(o)}})})}static async preloadTemplate(){r.log("ChatMessageUtils.preloadTemplate");try{await G.loadTemplates([this.templatePath])}catch(t){r.error("Failed to preload template",t)}}static async createGroupRollMessage(t,e,s,i,o){r.log("ChatMessageUtils.createGroupRollMessage",[t.length,e,s,o]);const l=this.buildGroupRollData(t,e,s,i);l.groupRollId=o;const n=t.some(d=>I.isPlayerOwnerActive(d)),a=n?CONST.DICE_ROLL_MODES.PUBLIC:game.settings.get("core","rollMode");r.log("hasPlayerOwnedActor",[n,a]),this.pendingRolls.set(o,{actors:t.map(d=>d.id),rollType:e,rollKey:s,config:i,results:new Map});const c=await this.postGroupMessage(l,a);return c&&this.groupRollMessages.set(o,c),c}static buildGroupRollData(t,e,s,i){r.log("ChatMessageUtils.buildGroupRollData",[t.length,e,s,i]);let o=this._buildFlavorText(e,s,i);const l=(i==null?void 0:i.dc)||(i==null?void 0:i.target),n=t.map(g=>{var h,p;return{actorId:g.id,actorImg:g.img||((p=(h=g.prototypeToken)==null?void 0:h.texture)==null?void 0:p.src)||"icons/svg/mystery-man.svg",actorName:g.name,rolled:!1,showDice:!0,total:null,success:!1,failure:!1}}),a=I.shouldShowDC(e),c=E(),d=A.get(c.showGroupDCToPlayers.tag);return{flavor:o,results:n,showDC:l!=null,dc:l,rollType:e,rollKey:s,supportsDC:a,showDCToPlayers:d,actors:t.map(g=>g.id),moduleId:_}}static _buildFlavorText(t,e,s){var o,l,n,a,c;let i="";switch(t==null?void 0:t.toLowerCase()){case"ability":case"abilitycheck":const d=((o=CONFIG.DND5E.abilities[e])==null?void 0:o.label)||e;i=game.i18n.format("DND5E.AbilityPromptTitle",{ability:d});break;case"save":case"savingthrow":const g=((l=CONFIG.DND5E.abilities[e])==null?void 0:l.label)||e;i=game.i18n.format("DND5E.SavePromptTitle",{ability:g});break;case"skill":const h=((n=CONFIG.DND5E.skills[e])==null?void 0:n.label)||e,p=(s==null?void 0:s.ability)||((a=CONFIG.DND5E.skills[e])==null?void 0:a.ability)||"int",m=((c=CONFIG.DND5E.abilities[p])==null?void 0:c.label)||p;i=game.i18n.format("DND5E.SkillPromptTitle",{skill:h,ability:m});break;case"tool":i=`Tool Check: ${e}`;break;case"initiative":i=game.i18n.localize("DND5E.Initiative");break;case"attack":i=(s==null?void 0:s.flavor)||"Attack Roll";break;case"damage":i=(s==null?void 0:s.flavor)||"Damage Roll";break;default:i=(s==null?void 0:s.flavor)||"Roll Request"}return i}static async postGroupMessage(t,e=null){r.log("ChatMessageUtils.postGroupMessage",[t,e]);try{const i={content:await G.renderTemplate(this.templatePath,t),speaker:{alias:"Group Roll"},flags:{[_]:{isGroupRoll:!0,groupRollId:t.groupRollId,rollData:t}}};return e&&ChatMessage.applyRollMode(i,e),await ChatMessage.create(i)}catch(s){return r.error("Failed to post group message",s),null}}static async updateGroupRollMessage(t,e,s){var d;if(r.log("ChatMessageUtils.updateGroupRollMessage",[t,e,s.total,game.user.isGM]),!game.user.isGM)return;let i=this.groupRollMessages.get(t),o=this.pendingRolls.get(t);if(i||(i=game.messages.contents.find(h=>h.getFlag(_,"groupRollId")===t&&h.getFlag(_,"isGroupRoll")),i&&(this.groupRollMessages.set(t,i),r.log("updateGroupRollMessage - Found and registered group message",[t]),o||(o={actors:i.getFlag(_,"rollData").results.map(p=>p.actorId),results:new Map},this.pendingRolls.set(t,o)))),!i){r.log("No group message found for groupRollId",t);return}o&&o.results&&o.results.set(e,{total:s.total,roll:s});const l=i.getFlag(_,"rollData"),n=l.results.findIndex(g=>g.actorId===e);if(n!==-1){l.results[n].rolled=!0,l.results[n].showDice=!1,l.results[n].total=s.total;try{l.results[n].rollBreakdown=await s.render()}catch(g){r.error("Error rendering roll breakdown",g),l.results[n].rollBreakdown=null}l.showDC&&l.dc&&(l.results[n].success=s.total>=l.dc,l.results[n].failure=s.total<l.dc)}l.allRolled=l.results.every(g=>g.rolled),l.messageId=i.id,l.supportsDC=I.shouldShowDC(l.rollType);const a=E();if(l.showDCToPlayers=A.get(a.showGroupDCToPlayers.tag),l.supportsDC&&l.showDC&&l.dc){const g=((d=l.actors)==null?void 0:d.map(p=>game.actors.get(p)).filter(p=>p))||[],h=I.getGroupResult(l.results,l.dc,g,l.rollType,l.rollKey);l.groupResult=h,r.log("updateGroupRollMessage - COMPLETE?",[h.complete]),h.complete&&h.details&&(l.groupSummary=h.details.summary)}const c=await G.renderTemplate(this.templatePath,l);await i.update({content:c,flags:{[_]:{rollData:l}}}),o!=null&&o.results&&(o!=null&&o.actors)&&o.results.size===o.actors.length&&(this.pendingRolls.delete(t),setTimeout(()=>{this.groupRollMessages.delete(t)},6e4))}static async updateGroupRollDC(t,e){var a;const s=t.getFlag(_,"rollData");if(!s||(s.supportsDC=I.shouldShowDC(s.rollType),!s.supportsDC))return;s.dc=e,s.showDC=!0,s.results.forEach(c=>{c.rolled&&c.total!==null&&(c.success=c.total>=e,c.failure=c.total<e)});const i=((a=s.actors)==null?void 0:a.map(c=>game.actors.get(c)).filter(c=>c))||[],o=I.getGroupResult(s.results,e,i,s.rollType,s.rollKey);s.groupResult=o,o.complete&&o.details&&(s.groupSummary=o.details.summary),s.allRolled=s.results.every(c=>c.rolled),s.messageId=t.id;const l=E();s.showDCToPlayers=A.get(l.showGroupDCToPlayers.tag);const n=await G.renderTemplate(this.templatePath,s);await t.update({content:n,flags:{[_]:{rollData:s}}})}static interceptRollMessage(t,e,s){var d,g,h;r.log("ChatMessageUtils.interceptRollMessage",[t,s]);const i=E();if(!A.get(i.groupRollsMsgEnabled.tag))return;const l=(d=t.speaker)==null?void 0:d.actor,n=game.actors.get(l);if(!l||!n)return;const a=t.getFlag(_,"groupRollId")||((g=n.getFlag(_,"tempInitiativeConfig"))==null?void 0:g.groupRollId);if(!a){r.log("interceptRollMessage - no groupRollId in flag");return}if(!game.user.isGM&&!this.groupRollMessages.has(a)){const m=game.messages.contents.find(R=>R.getFlag(_,"groupRollId")===a&&R.getFlag(_,"isGroupRoll"));m&&(this.groupRollMessages.set(a,m),r.log("interceptRollMessage - Registered group roll message",[a]))}if(!this.groupRollMessages.has(a)){r.log("interceptRollMessage - groupRollId not in map",[a,Array.from(this.groupRollMessages.keys())]);return}const c=(h=t.rolls)==null?void 0:h[0];if(c)if(e&&e instanceof HTMLElement&&e.style&&(e.style.display="none"),game.user.isGM){this.updateGroupRollMessage(a,l,c);const p=t.id;if(this.messagesScheduledForDeletion.has(p))return;this.messagesScheduledForDeletion.add(p),p&&setTimeout(async()=>{r.log("interceptRollMessage - deletion",[p]);try{game.messages.get(p)?(await t.delete(),r.log("interceptRollMessage - Deleted individual message",[p])):r.log("interceptRollMessage - Message already deleted",[p])}catch(m){r.log("interceptRollMessage - Error deleting message",[p,m.message])}finally{this.messagesScheduledForDeletion.delete(p)}},500)}else r.log("interceptRollMessage - Player roll intercepted, GM will handle update",[a])}static isGroupRoll(t){return this.pendingRolls.has(t)||this.groupRollMessages.has(t)}static async addGroupRollFlag(t,e,s=null){const i=E(),o=A.get(i.groupRollsMsgEnabled.tag);if(r.log("addGroupRollFlag called",[t,e.groupRollId,this.isGroupRoll(e.groupRollId)]),!game.user.isGM&&e.groupRollId&&s&&(await s.setFlag(_,"tempGroupRollId",e.groupRollId),r.log("addGroupRollFlag - Stored tempGroupRollId on actor for player",[e.groupRollId,s.id]),!this.groupRollMessages.has(e.groupRollId))){const n=game.messages.contents.find(a=>a.getFlag(_,"groupRollId")===e.groupRollId&&a.getFlag(_,"isGroupRoll"));n&&(this.groupRollMessages.set(e.groupRollId,n),r.log("addGroupRollFlag - Registered group roll message on player side",[e.groupRollId]))}o&&e.groupRollId&&(!game.user.isGM||this.isGroupRoll(e.groupRollId))&&(t.data=t.data||{},t.data.flags=t.data.flags||{},t.data.flags[_]=t.data.flags[_]||{},t.data.flags[_].groupRollId=e.groupRollId,r.log("addGroupRollFlag - Added flag to messageConfig",[t]))}static cleanup(){const t=Date.now()-3e5;for(const[e,s]of this.groupRollMessages.entries())s.timestamp<t&&(this.groupRollMessages.delete(e),this.pendingRolls.delete(e))}}D(B,"groupRollMessages",new Map),D(B,"pendingRolls",new Map),D(B,"messagesScheduledForDeletion",new Set),D(B,"templatePath","modules/flash-rolls-5e/templates/chat-msg-group-roll.hbs");const z={ability:async(u,t,e,s,i)=>{var l;r.log("RollHandlers.ability #1",[e]);const o=I.buildRollConfig(t,e,{ability:t.rollKey});r.log("RollHandlers.ability #2",[(l=o.rolls)==null?void 0:l[0]]),r.log("RollHandlers.ability - messageConfig",i),await B.addGroupRollFlag(i,t,u),await u.rollAbilityCheck(o,s,i)},abilitycheck:async(u,t,e,s,i)=>z.ability(u,t,e,s,i),save:async(u,t,e,s,i)=>{var l;const o=I.buildRollConfig(t,e,{ability:((l=t.config)==null?void 0:l.ability)||t.rollKey});await B.addGroupRollFlag(i,t,u),await u.rollSavingThrow(o,s,i)},savingthrow:async(u,t,e,s,i)=>z.save(u,t,e,s,i),skill:async(u,t,e,s,i)=>{var n,a,c,d,g,h;r.log("RollHandlers.skill #1",[t,e,s]);const o=((a=(n=u.system.skills)==null?void 0:n[t.rollKey])==null?void 0:a.ability)||((d=(c=CONFIG.DND5E.skills)==null?void 0:c[t.rollKey])==null?void 0:d.ability)||void 0,l=I.buildRollConfig(t,e,{skill:t.rollKey,chooseAbility:s.configure!==!1,ability:t.config.ability||o});if(t.config.ability&&s.configure===!1){const p=((g=CONFIG.DND5E.skills[t.rollKey])==null?void 0:g.label)||t.rollKey,m=((h=CONFIG.DND5E.abilities[t.config.ability])==null?void 0:h.label)||t.config.ability,R=game.i18n.format("DND5E.SkillPromptTitle",{skill:p,ability:m});i.data=i.data||{},i.data.flavor=R}r.log("RollHandlers.skill #2",[l,s,i]),await B.addGroupRollFlag(i,t,u),await u.rollSkill(l,s,i)},tool:async(u,t,e,s,i)=>{var a,c,d,g,h,p,m;r.log("RollHandlers.tool #1",[t,e]);const o=(a=u.system.tools)==null?void 0:a[t.rollKey],l=(o==null?void 0:o.ability)||((g=(d=(c=CONFIG.DND5E.enrichmentLookup)==null?void 0:c.tools)==null?void 0:d[t.rollKey])==null?void 0:g.ability)||"int",n=I.buildRollConfig(t,e,{tool:t.rollKey,chooseAbility:s.configure!==!1,ability:t.config.ability||l});if(t.config.ability&&s.configure===!1){const R=(p=(h=CONFIG.DND5E.enrichmentLookup)==null?void 0:h.tools)==null?void 0:p[t.rollKey];let y=t.rollKey;if(R!=null&&R.id){const S=dnd5e.documents.Trait.getBaseItem(R.id,{indexOnly:!0});y=(S==null?void 0:S.name)||t.rollKey}const L=((m=CONFIG.DND5E.abilities[t.config.ability])==null?void 0:m.label)||t.config.ability,b=game.i18n.format("DND5E.ToolPromptTitle",{tool:y,ability:L});i.data=i.data||{},i.data.flavor=b}r.log("RollHandlers.tool #2",[n,s,i]),await B.addGroupRollFlag(i,t,u),await u.rollToolCheck(n,s,i)},concentration:async(u,t,e,s,i)=>{const o=I.buildRollConfig(t,e);await B.addGroupRollFlag(i,t,u),await u.rollConcentration(o,s,i)},attack:async(u,t,e,s,i)=>{await z.handleActivityRoll(u,f.ATTACK,t,e,s,i)},damage:async(u,t,e,s,i)=>{await z.handleActivityRoll(u,f.DAMAGE,t,e,s,i)},itemsave:async(u,t,e,s,i)=>{await z.handleActivityRoll(u,f.ITEM_SAVE,t,e,s,i)},initiative:async(u,t,e,s,i)=>{var l,n,a;if(!game.combat){ui.notifications.warn(game.i18n.localize("COMBAT.NoneActive"));return}t.config.situational||(l=e.data)!=null&&l.situational,t.groupRollId;let o=u;if(!u.isToken){const c=canvas.tokens.placeables.find(d=>{var g;return((g=d.actor)==null?void 0:g.id)===u.id});if(c)o=c.actor;else{ui.notifications.error(game.i18n.format("COMBAT.NoneActive"));return}}await B.addGroupRollFlag(i,t,u),r.log("RollHandlers.initiative - START",[u,t,e,s]);try{if(s.configure){if(r.log("RollHandlers.initiative - Dialog",[]),t.config){const c=I.buildRollConfig(t,e,{ability:((a=(n=u.system.attributes)==null?void 0:n.init)==null?void 0:a.ability)||"dex"}),d={advantage:t.config.advantage||!1,disadvantage:t.config.disadvantage||!1,rollMode:t.config.rollMode||game.settings.get("core","rollMode"),rolls:c.rolls,groupRollId:t.groupRollId};await u.setFlag(_,"tempInitiativeConfig",d),await o.setFlag(_,"tempInitiativeConfig",d)}await o.rollInitiativeDialog()}else{r.log("RollHandlers.initiative - Not dialog");const c={rollMode:t.config.rollMode||game.settings.get("core","rollMode"),groupRollId:t.groupRollId};await u.setFlag(_,"tempInitiativeConfig",c),await o.setFlag(_,"tempInitiativeConfig",c);const d={createCombatants:!0,rerollInitiative:!0};await o.rollInitiative(d)}r.log("RollHandlers.initiative - COMPLETE")}catch(c){r.error("RollHandlers.initiative - Error",[c]),H.notify("error",`Initiative roll failed: ${c.message}`)}},initiativedialog:async(u,t,e,s,i)=>z.initiative(u,t,e,s,i),deathsave:async(u,t,e,s,i)=>{const o=I.buildRollConfig(t,e);await B.addGroupRollFlag(i,t,u),await u.rollDeathSave(o,s,i)},hitdie:async(u,t,e,s,i)=>{s.configure=game.user.isGM?s.configure:!0;const o=I.buildRollConfig(t,e,{denomination:t.rollKey});r.log("RollHandlers.hitdie",[o,s,i]),await u.rollHitDie(o,s,i)},custom:async(u,t,e,s,i)=>{await z.handleCustomRoll(u,t,s,i)},async handleActivityRoll(u,t,e,s,i,o){var l,n;if(r.log("RollHandlers.handleActivityRoll",[t,e,s]),e.rollKey){const a=I.buildRollConfig(e,s),c=((n=(l=a.rolls)==null?void 0:l[0])==null?void 0:n.options)||{},d={usage:{...e.config,rolls:a.rolls,...c.attackMode&&{attackMode:c.attackMode},...c.ammunition&&{ammunition:c.ammunition},...c.mastery!==void 0&&{mastery:c.mastery}},dialog:i,message:o};r.log("handleActivityRoll - final activity config",[d]),await ht.executeActivityRoll(u,t,e.rollKey,e.activityId,d)}},async handleCustomRoll(u,t,e,s){var l,n,a;const i=t.rollKey;if((e==null?void 0:e.configure)===!1){try{const c=new Roll(i,u.getRollData());c.options=c.options||{},c.options.isRollRequest=((l=t.config)==null?void 0:l.isRollRequest)!==!1,await c.evaluate({async:!0}),await c.toMessage({speaker:ChatMessage.getSpeaker({actor:u}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${f.CUSTOM}`),rollMode:(s==null?void 0:s.rollMode)||((n=t.config)==null?void 0:n.rollMode)||game.settings.get("core","rollMode"),isRollRequest:((a=t.config)==null?void 0:a.isRollRequest)!==!1,create:(s==null?void 0:s.create)!==!1})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:i}))}return}new _e({formula:i,readonly:!0,actor:u,callback:async c=>{try{const d=new Roll(c,u.getRollData());d.options=d.options||{},d.options.isRollRequest=!0,await d.evaluate({async:!0}),await d.toMessage({speaker:ChatMessage.getSpeaker({actor:u}),flavor:game.i18n.localize(`FLASH_ROLLS.rollTypes.${f.CUSTOM}`),rollMode:t.config.rollMode,isRollRequest:!0,_showRequestedBy:!0,_requestedBy:t.config.requestedBy||"GM"})}catch{ui.notifications.error(game.i18n.format("FLASH_ROLLS.ui.notifications.invalidFormula",{formula:c}))}}}).render(!0)},async handleHitDieRecovery(u){const t=foundry.utils.mergeObject({type:"long",deltas:{hitDice:0},newDay:!1,rolls:[],updateData:{},updateItems:[]},{});"dhd"in t&&(t.deltas.hitDice=t.dhd),u._getRestHitDiceRecovery({maxHitDice:u.system.attributes.hd.max,type:"long"},t),t.dhd=t.deltas.hitDice,t.longRest=!0;try{if(t.updateData&&Object.keys(t.updateData).length>0){const e=await u.update(t.updateData,{isRest:!1})}else r.log("No actor updates to perform",[]);if(t.updateItems&&t.updateItems.length>0){const e=await u.updateEmbeddedDocuments("Item",t.updateItems,{isRest:!1})}else r.log("No item updates to perform",[])}catch(e){throw r.error("Error during updates in handleHitDieRecovery:",[e]),e}return r.log("handleHitDieRecovery #3",[t]),t}};async function Ke(){return game.combat||(await(await Combat.create({scene:game.scenes.active.id})).activate(),H.notify("info",game.i18n.localize("FLASH_ROLLS.notifications.combatCreated"))),game.combat}async function Je(u,t){if(!t.combat)return u;const e=u.map(o=>t.actors.get(o)).filter(o=>o),s=[],i=new Set;for(const o of e)t.combat.getCombatantsByActor(o.id).some(a=>a.initiative!==null)&&(s.push(o.name),i.add(o.id));if(r.log("filterActorsForInitiative",[s]),s.length>0)if(await foundry.applications.api.DialogV2.confirm({window:{title:t.i18n.localize("FLASH_ROLLS.ui.dialogs.rerollInitiativeTitle"),classes:["flash5e-dialog"]},content:"<p>"+t.i18n.format("FLASH_ROLLS.ui.dialogs.rerollInitiative",{actors:s.join(", ")})+"</p>",rejectClose:!1,modal:!0})){if(t.user.isGM)for(const l of i){const n=t.combat.getCombatantsByActor(l);r.log("filterActorsForInitiative - resetting initiative for combatants",[n]);for(const a of n)await a.update({initiative:null})}else r.log("filterActorsForInitiative - Player cannot reset initiative, will let system handle re-roll");return u}else{const l=u.filter(n=>!i.has(n));return l.length===0&&H.notify("info",t.i18n.localize("FLASH_ROLLS.notifications.allActorsHaveInitiative")),l}return u}class Xe{static initialize(){r.log("RollInterceptor.initialize"),game.user.isGM&&this.registerHooks()}static registerHooks(){r.log("RollInterceptor.registerHooks"),this._registerHook(N.PRE_ROLL_ABILITY_CHECK,this._handlePreRoll.bind(this,f.ABILITY)),this._registerHook(N.PRE_ROLL_SAVING_THROW,this._handlePreRoll.bind(this,f.SAVE)),this._registerHook(N.PRE_ROLL_SKILL_V2,this._handlePreRoll.bind(this,f.SKILL)),this._registerHook(N.PRE_ROLL_TOOL_V2,this._handlePreRoll.bind(this,f.TOOL)),this._registerHook(N.PRE_ROLL_ATTACK_V2,this._handlePreRoll.bind(this,f.ATTACK)),this._registerHook(N.PRE_ROLL_DAMAGE_V2,this._handlePreRoll.bind(this,f.DAMAGE)),this._registerHook(N.PRE_ROLL_DEATH_SAVE_V2,this._handlePreRoll.bind(this,f.DEATH_SAVE)),this._registerHook(N.PRE_ROLL_HIT_DIE_V2,this._handlePreRoll.bind(this,f.HIT_DIE)),this._registerHook(N.PRE_ROLL_INITIATIVE,this._handlePreRollInitiative.bind(this,f.INITIATIVE)),this._registerHook(N.PRE_ROLL_INITIATIVE_DIALOG,this._handlePreRollInitiative.bind(this,f.INITIATIVE)),this._registerHook(N.ROLL_INITIATIVE,this._handleRollInitiative.bind(this,f.INITIATIVE))}static _registerHook(t,e){r.log("RollInterceptor._registerHook");const s=Hooks.on(t,e);this.registeredHooks.add({hookName:t,hookId:s})}static unregisterHooks(){r.log("RollInterceptor.unregisterHooks");for(const{hookName:t,hookId:e}of this.registeredHooks)Hooks.off(t,e);this.registeredHooks.clear()}static _handlePreRollInitiative(t,e,s){r.log("_handlePreRollInitiative",[t,e,s])}static _handlePreRoll(t,e,s,i){var h,p,m,R,y,L,b,S,T;if(r.log("_handlePreRoll #0",[t,e,s,i]),!game.user.isGM||e.isRollRequest===!1)return;G.isModuleOn(_,"midi-qol");const o=(e==null?void 0:e.hookNames)||(s==null?void 0:s.hookNames)||(i==null?void 0:i.hookNames)||[],l=o.includes("initiativeDialog")||o.includes("initiative");if(t===f.ATTACK){const C=(p=(h=e.subject)==null?void 0:h.item)==null?void 0:p.getFlag(_,"tempAttackConfig");if(r.log("_handlePreRoll - is Attack roll",[(m=e.subject)==null?void 0:m.item,C]),C){r.log("_handlePreRoll - found module flags, skipping interception",[C]);return}}if(t===f.DAMAGE){const C=(y=(R=e.subject)==null?void 0:R.item)==null?void 0:y.getFlag(_,"tempDamageConfig");if(r.log("RollInterceptor._handlePreRoll - is Damage roll",[(L=e.subject)==null?void 0:L.item,C]),C){r.log("RollInterceptor._handlePreRoll - found module flags, skipping interception",[C]);return}}if(l&&t===f.ABILITY&&(r.log("RollInterceptor._handlePreRoll - Overriding ability to initiative",[o]),t=f.INITIATIVE),e!=null&&e.isRollRequest||e.sendRequest===!1||s!=null&&s.isRollRequest||i!=null&&i.isRollRequest){r.log("_handlePreRoll - skipping interception (roll request)",[e,s,i]);return}let n;if(t===f.INITIATIVE&&e instanceof Actor){if(n=e,r.log("_handlePreRoll - Initiative",[e,s,i]),(s==null?void 0:s.isRollRequest)===!1||(i==null?void 0:i.isRollRequest)===!1)return}else t===f.HIT_DIE?n=((b=s==null?void 0:s.subject)==null?void 0:b.actor)||(s==null?void 0:s.subject)||(s==null?void 0:s.actor):t===f.ATTACK||t===f.DAMAGE?n=(S=e.subject)==null?void 0:S.actor:n=((T=e.subject)==null?void 0:T.actor)||e.subject||e.actor;const a=E();if(!A.get(a.rollInterceptionEnabled.tag)||!n||n.documentName!=="Actor")return;const d=G.getActorOwner(n);if(r.log("_handlePreRoll - ownership",[d]),!d||!d.active||d.id===game.user.id){r.log("_handlePreRoll - skipping interception (owner unavailable)",[d==null?void 0:d.name,d==null?void 0:d.active]);return}t===f.ATTACK&&(i={...i,rollMode:CONST.DICE_ROLL_MODES.PUBLIC});const g=e.midiOptions!==null&&e.midiOptions!==void 0;if(g&&game.user.isGM)return r.log("_handlePreRoll - isMidiActive",[g]),this._showGMConfigDialog(n,d,t,e,s,i),!1;if(s.configure===!1||e.isRollRequest===!1||e.skipRollDialog===!0||e.fastForward===!0){r.log("_handlePreRoll - skipping interception (config flags)",[s.configure,e]);return}return r.log("_handlePreRoll - intercepting roll #1",[e,i]),this._showGMConfigDialog(n,d,t,e,s,i),!1}static _handleRollInitiative(t,e,s,i,o){r.log("_handleRollInitiative",[t,e,s,i,o])}static async _handleInitiativePreChecks(t){return!game.combat&&!await Ke()?!1:(await Je([t.id],game)).length>0}static _getDialogClass(t){const e=t==null?void 0:t.toLowerCase();return[f.SKILL,f.TOOL].includes(e)?He:e===f.HIT_DIE?ve:e===f.ATTACK?ft:e===f.DAMAGE?gt:X}static _extractRollConfiguration(t,e,s,i){var a,c,d,g,h,p,m,R,y,L,b;const o=t==null?void 0:t.toLowerCase();let l=null;const n={rolls:[{parts:[],data:{},options:{}}]};switch(o){case f.SKILL:n.skill=e.skill,n.ability=e.ability||((a=e.subject)==null?void 0:a.ability),l=n.skill;break;case f.TOOL:n.tool=e.tool,n.ability=e.ability||((c=e.subject)==null?void 0:c.ability),l=n.tool;break;case f.ABILITY:case f.SAVE:n.ability=e.ability||((d=e.subject)==null?void 0:d.ability),l=n.ability,n.ability==="con"&&e.targetValue!==void 0&&(t=f.CONCENTRATION);break;case f.CONCENTRATION:n.ability="con",l="con";break;case f.INITIATIVE:case f.INITIATIVE_DIALOG:l=((h=(g=i.system.attributes)==null?void 0:g.init)==null?void 0:h.ability)||"dex";break;case f.HIT_DIE:n.denomination=typeof e=="string"?e:e.denomination||((p=e.subject)==null?void 0:p.denomination),l=n.denomination;break;case f.ATTACK:s!=null&&s.options&&(n.ammunition=s.options.ammunition,n.attackMode=s.options.attackMode,n.mastery=s.options.mastery),l=(R=(m=e.subject)==null?void 0:m.item)==null?void 0:R.id;break;case f.DAMAGE:n.item=(y=e.subject)==null?void 0:y.item,n.subject=e.subject,n.critical=e.critical||{},l=(b=(L=e.subject)==null?void 0:L.item)==null?void 0:b.id;break}return{rollKey:l,rollConfig:n}}static async _getDialogResult(t,e,s,i,o,l,n,a){const c=s==null?void 0:s.toLowerCase();if(o)return{sendRequest:!0,advantage:!1,disadvantage:!1,situational:"",rollMode:game.settings.get("core","rollMode")};if(!t.initConfiguration)throw r.error("DialogClass.initConfiguration not found",[t,t.name]),new Error(`DialogClass ${t.name} does not have initConfiguration method`);const d={skipRollDialog:!1,sendRequest:l};return c===f.ATTACK||c===f.DAMAGE?await t.initConfiguration([e],c,i,d,n,a):await t.initConfiguration([e],c,i,d)}static async _showGMConfigDialog(t,e,s,i,o,l){r.log("_showGMConfigDialog - config",[s,i]);const n=E(),a=A.get(n.rollRequestsEnabled.tag),c=A.get(n.skipRollDialog.tag);try{if((s==null?void 0:s.toLowerCase())===f.INITIATIVE&&!await this._handleInitiativePreChecks(t))return;const g=this._getDialogClass(s),{rollKey:h,rollConfig:p}=this._extractRollConfiguration(s,i,o,t);r.log("_showGMConfigDialog - rollConfig",[p,h]);const m=await this._getDialogResult(g,t,s,h,c,a,i,o);if(!m){r.log("_showGMConfigDialog - Dialog cancelled");return}if(!m.sendRequest||!a){r.log("_showGMConfigDialog - triggering _executeInterceptedRoll",[s,i,m]),await this._executeInterceptedRoll(t,s,i,m);return}delete i.event;const R={...i,...m,rolls:m.rolls,requestedBy:game.user.name,...s===f.ATTACK&&{chatMessage:!1}};r.log("_showGMConfigDialog - triggering _sendRollRequest",[s,R]),this._sendRollRequest(t,e,s,R)}catch(d){r.error("RollInterceptor._showGMConfigDialog - Error",[d])}}static async _executeInterceptedRoll(t,e,s,i){var h,p,m,R,y,L,b,S,T,C,O,w,M,U;r.log("RollInterceptor._executeInterceptedRoll",[t,e,s,i]);const o=e==null?void 0:e.toLowerCase(),l=((h=i.rolls)==null?void 0:h[0])||{parts:[],data:{},options:{}},n=((p=l.data)==null?void 0:p.situational)||i.situational||"";let a;switch(o){case f.SKILL:a=s.skill;break;case f.TOOL:a=s.tool;break;case f.ABILITY:case f.SAVE:a=s.ability||((m=s.subject)==null?void 0:m.ability);break;case f.HIT_DIE:a=s.denomination;break;default:a=s.ability||s.skill||s.tool||s.denomination}const c={rollKey:a,config:{advantage:i.advantage||s.advantage,disadvantage:i.disadvantage||s.disadvantage,target:i.target||i.dc||s.target,rollMode:i.rollMode||s.rollMode,situational:n,isRollRequest:!1,ability:s.ability}};if(o===f.SKILL&&!c.config.ability)c.config.ability=((y=(R=t.system.skills)==null?void 0:R[c.rollKey])==null?void 0:y.ability)||((b=(L=CONFIG.DND5E.skills)==null?void 0:L[c.rollKey])==null?void 0:b.ability);else if(o===f.TOOL&&!c.config.ability){const P=(S=t.system.tools)==null?void 0:S[c.rollKey];c.config.ability=(P==null?void 0:P.ability)||((O=(C=(T=CONFIG.DND5E.enrichmentLookup)==null?void 0:T.tools)==null?void 0:C[c.rollKey])==null?void 0:O.ability)||"int"}else(o===f.ABILITY||o===f.SAVE)&&!c.config.ability&&(c.config.ability=c.rollKey);r.log("RollInterceptor._executeInterceptedRoll - requestData",[c,s,i]);const d={configure:!1,isRollRequest:!1},g={rollMode:c.config.rollMode,create:!0,isRollRequest:!1};try{const P=f,q=z[o];r.log("RollInterceptor._executeInterceptedRoll - handler 1",[q,o,z[o]]),q?((o===f.ATTACK||o===f.DAMAGE||o===f.SAVE)&&(c.rollKey=(M=(w=s.subject)==null?void 0:w.item)==null?void 0:M.id,c.activityId=(U=s.subject)==null?void 0:U.id),r.log("RollInterceptor._executeInterceptedRoll - handler 2",[c,l,d,g]),await q(t,c,l,d,g)):r.warn(`No handler found for roll type: ${o}`)}catch(P){r.error("RollInterceptor._executeInterceptedRoll",[P])}}static async _sendRollRequest(t,e,s,i){var h;r.log("_sendRollRequest",[t,e,s,i]),r.log("_sendRollRequest - config.rolls",[i.rolls]);const o=E(),l=A.get(o.skipRollDialog.tag);let n=s==null?void 0:s.toLowerCase();n===f.INITIATIVE&&(n=f.INITIATIVE_DIALOG);let a=null,c=null;switch(n){case f.ABILITY:case f.SAVE:a=i.ability;break;case f.SKILL:a=i.skill;break;case f.TOOL:a=i.tool;break;case f.ATTACK:case f.DAMAGE:r.log("_sendRollRequest - Attack/Damage roll config",[s,i]),a=(h=i.subject.item)==null?void 0:h.id,c=i.subject.id;break;case f.HIT_DIE:a=typeof i=="string"?i:i.denomination;break;case f.INITIATIVE_DIALOG:case f.INITIATIVE:a=null;break;case f.DEATH_SAVE:a=null;break;default:r.warn(`Unknown roll type: ${s}`);return}const d={...i};delete d.subject,delete d.workflow,delete d.item,delete d.activity;const g={type:"rollRequest",requestId:foundry.utils.randomID(),actorId:t.id,rollType:n,rollKey:a,activityId:c,rollProcessConfig:{...d,_requestedBy:game.user.name},skipRollDialog:l,targetTokenIds:Array.from(game.user.targets).map(p=>p.id),preserveTargets:A.get(o.useGMTargetTokens.tag)};if(r.log("_sendRollRequest - requestData",[e,g]),!e||!g){ui.notifications.warn("Flash Rolls: No owner found for actor "+t.name);return}if(!e.active){const p=E();A.get(p.showOfflineNotifications.tag)&&ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:e.name})),await this._executeInterceptedRoll(t,s,i,{...i,sendRequest:!1});return}J.execForUser("handleRollRequest",e.id,g),ui.notifications.info(game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:(e==null?void 0:e.name)||"Unknown",actor:t.name||"Unknown"}))}}D(Xe,"registeredHooks",new Set);class Rt{static getActorStats(t){var o,l,n,a,c,d;const e=t.system,s=[];(o=e.attributes)!=null&&o.hp&&s.push({abbrev:"HP",value:e.attributes.hp.value}),(l=e.attributes)!=null&&l.ac&&s.push({abbrev:"AC",value:e.attributes.ac.value});const i=(a=(n=e.attributes)==null?void 0:n.spell)==null?void 0:a.dc;return i&&s.push({abbrev:"DC",value:i}),(d=(c=e.skills)==null?void 0:c.prc)!=null&&d.passive&&s.push({abbrev:"PRC",value:e.skills.prc.passive}),s}static getValidActorIds(t,e){return t.filter(s=>{const i=game.actors.get(s);if(!i)return!1;const o=Le(i),l=!o&&ye(i);return e==="pc"&&o||e==="npc"&&l})}}class Ve{static async getRollConfiguration(t,e,s,i,o){const l=E(),n=A.get(l.rollRequestsEnabled.tag);if(!i&&e!==f.CUSTOM){let a;[f.SKILL,f.TOOL].includes(e)?a=He:e===f.HIT_DIE?a=ve:a=X;const c=await a.initConfiguration(t,e,s,{skipRollDialog:i,sendRequest:n||!1});return r.log("getRollConfiguration",[c]),c}else{const a={rolls:[{parts:[],data:{},options:{}}],advantage:!1,disadvantage:!1,rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:!0,sendRequest:n&&o.length>0};return e===f.DEATH_SAVE&&(a.target=10),a}}static async handleCustomRoll(){return await this.showCustomRollDialog()}static async showCustomRollDialog(){return r.log("showCustomRollDialog"),_e.prompt({formula:"",readonly:!1})}}class bt{static async orchestrateRollsForActors(t,e,s,i,o){const l=E(),n=[],a=[],c=[];r.log("orchestrateRollsForActors",[t,e,s]);const d=foundry.utils.randomID(),g=[];if(t.sendRequest){for(const{actor:m,owner:R}of e)R.active?c.push({actor:m,owner:R}):(A.get(l.showOfflineNotifications.tag)&&H.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:R.name})),a.push(m));g.push(...c.map(({actor:m})=>m))}else s.push(...e.map(({actor:m})=>m));g.push(...a,...s);const h=A.get(l.groupRollsMsgEnabled.tag);h&&g.length>1&&await B.createGroupRollMessage(g,i,o,t,d);for(const{actor:m,owner:R}of c){const y=h&&g.length>1?d:null;await this.sendRollRequestToPlayer(m,R,i,o,t,!0,y),n.push({actor:m,owner:R}),await Se(100)}n.length>0&&this.showConsolidatedNotification(n,i,o);const p=[...a,...s];p.length>0&&(t.skipRollDialog=!0,t.groupRollId=h&&g.length>1?d:null,await this.handleGMRolls(p,i,o,t))}static async sendRollRequestToPlayer(t,e,s,i,o,l=!1,n=null){r.log("sendRollRequestToPlayer",[s,i]);const a=E();let c=s==null?void 0:s.toLowerCase();if(c===f.ABILITY_CHECK?c=f.ABILITY:c===f.SAVING_THROW?c=f.SAVE:c===f.INITIATIVE_DIALOG&&(c=f.INITIATIVE),c===f.HIT_DIE){const h=t.system.attributes.hd;if(h.value>0)i=h.largestAvailable;else if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessage",{actors:t.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){try{r.log("About to call handleHitDieRecovery for",[t.name]);const m=await z.handleHitDieRecovery(t);r.log("handleHitDieRecovery completed",[m])}catch(m){r.error("Error calling handleHitDieRecovery:",[m])}i=t.system.attributes.hd.largestAvailable,H.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:t.name})||`Hit dice refilled for ${t.name}`)}else return}const d={...o};delete d.subject,delete d.workflow,delete d.item,delete d.activity;const g={type:"rollRequest",groupRollId:n||foundry.utils.randomID(),actorId:t.id,rollType:c,rollKey:i,activityId:null,rollProcessConfig:{...d,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(h=>h.id),preserveTargets:A.get(a.useGMTargetTokens.tag)};r.log("sendRollRequestToPlayer - sending request",[g]),J.execForUser("handleRollRequest",e.id,g),l||H.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:e.name,actor:t.name}))}static showConsolidatedNotification(t,e,s){var n,a,c,d,g;r.log("showConsolidatedNotification");const i={};for(const{actor:h,owner:p}of t)i[p.id]||(i[p.id]={player:p,actors:[]}),i[p.id].actors.push(h);const o=e;let l=game.i18n.localize(`FLASH_ROLLS.rollTypes.${o}`)||o;if(s){const h=o.toLowerCase();if(h===f.SKILL)l=`${l} (${((n=CONFIG.DND5E.skills[s])==null?void 0:n.label)||s})`;else if(h===f.SAVING_THROW)l=`${l} (${((a=CONFIG.DND5E.abilities[s])==null?void 0:a.label)||s})`;else if(h===f.ABILITY_CHECK)l=`${l} (${((c=CONFIG.DND5E.abilities[s])==null?void 0:c.label)||s})`;else if(h===f.TOOL){const p=(g=(d=CONFIG.DND5E.enrichmentLookup)==null?void 0:d.tools)==null?void 0:g[s];if(p!=null&&p.id){const m=dnd5e.documents.Trait.getBaseItem(p.id,{indexOnly:!0});l=`${l} (${(m==null?void 0:m.name)||s})`}else l=`${l} (${s})`}else h===f.CUSTOM&&(l=`${l}: ${s}`)}H.notifyRollRequestsSent(i,l)}static async handleGMRolls(t,e,s,i){r.log("handleGMRolls",[t,e,s,i]);for(const o of t)await this.initiateRoll(o,e,s,i),await Se(100)}static async initiateRoll(t,e,s,i){var o,l,n,a,c;r.log("initiateRoll",[e,s,i]);try{const d=e.toLowerCase();let g=s;if(d===f.HIT_DIE){const b=t.system.attributes.hd;if(b){const S=["d6","d8","d10","d12","d20"];for(const T of S)if((((o=b[T])==null?void 0:o.value)||0)>0){g=T;break}}if(!g)if(r.log("initiateRoll - No hit dice available",[t.name]),await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessageLocal",{actors:t.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndRoll")||"Refill & Roll",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){const T=await z.handleHitDieRecovery(t);if(r.log("Hit die recovery result",[T]),H.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:t.name})),g=t.system.attributes.hd.largestAvailable,!g){H.notify("warn",game.i18n.format("DND5E.HitDiceWarn",{name:t.name}));return}}else return}const h=((a=(n=(l=i.rolls)==null?void 0:l[0])==null?void 0:n.data)==null?void 0:a.situational)||"",p={rollKey:g,groupRollId:i.groupRollId,config:{...i,situational:h,rollMode:i.rollMode||game.settings.get("core","rollMode"),advantage:i.advantage||!1,disadvantage:i.disadvantage||!1,target:i.target}},m={configure:!i.fastForward&&!i.skipRollDialog,isRollRequest:!0},R={rollMode:i.rollMode||game.settings.get("core","rollMode"),create:i.chatMessage!==!1,isRollRequest:!0},y=((c=i.rolls)==null?void 0:c[0])||{},L=z[d];L?await L(t,p,y,m,R):H.notify("warn",`Unknown roll type: ${e}`)}catch(d){r.error("executeActorRoll",[d]),H.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:t.name}))}}}class ae{static initializeDrag(t){const e=t.element.querySelector(this.DRAG_HANDLE_SELECTOR);if(!e){r.error("RollMenuDragUtil.initializeDrag - No drag handle found!");return}e.addEventListener("mousedown",s=>{this.handleDragStart(s,t)})}static handleDragStart(t,e){if(t.preventDefault(),t.stopPropagation(),e.isDragging=!0,!e.element)return;e.element.classList.add("dragging");const s=e.element.getBoundingClientRect(),i=t.clientX,o=t.clientY,l=s.left,n=s.top;e.element.parentElement,document.body.appendChild(e.element),e.element.style.position="fixed",e.element.style.inset="",e.element.style.top=`${n}px`,e.element.style.left=`${l}px`,e.element.style.right="auto",e.element.style.bottom="auto",e.element.style.zIndex="var(--z-index-app)",e.element.offsetHeight;const a={startX:i,startY:o,initialLeft:l,initialTop:n,currentLeft:l,currentTop:n},c=g=>this.handleDragMove(g,e,a),d=g=>this.handleDragEnd(g,e,a,c,d);document.addEventListener("mousemove",c),document.addEventListener("mouseup",d)}static handleDragMove(t,e,s){if(!e.isDragging)return;const i=t.clientX-s.startX,o=t.clientY-s.startY;s.currentLeft=s.initialLeft+i,s.currentTop=s.initialTop+o,e.element.style.inset="",e.element.style.right="auto",e.element.style.bottom="auto",e.element.style.position="fixed",e.element.style.top=`${s.currentTop}px`,e.element.style.left=`${s.currentLeft}px`;const l=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<l?e.element.classList.add("left-edge"):e.element.classList.remove("left-edge"),window.getComputedStyle(e.element),this.calculateSnapDistance(e)<this.SNAP_DISTANCE?e.element.classList.add("near-snap"):e.element.classList.remove("near-snap")}static async handleDragEnd(t,e,s,i,o){if(r.log("RollMenuDragUtil.handleDragEnd"),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",o),e.isDragging=!1,e.element.classList.remove("dragging"),e.element.classList.remove("near-snap"),e.element.style.zIndex="",this.calculateSnapDistance(e)<this.SNAP_DISTANCE){const n=document.querySelector("#chat-notifications");n&&n.insertBefore(e.element,n.firstChild),await this.snapToDefault(e)}else{e.isCustomPosition=!0,e.customPosition={x:s.currentLeft,y:s.currentTop,isCustom:!0},G.addCSSVars("--flash-rolls-menu-offset","0px"),await this.saveCustomPosition(e.customPosition),e.element.classList.add("custom-position");const n=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;s.currentLeft<n&&e.element.classList.add("left-edge")}}static calculateSnapDistance(t){const e=document.querySelector(this.LIGHTNING_BOLT_SELECTOR);if(!e)return 1/0;const s=t.element.getBoundingClientRect(),i=e.getBoundingClientRect(),o=Math.abs(i.left-s.right),l=window.innerHeight-s.bottom;return Math.max(o>50?1/0:o,l>50?1/0:l)}static async snapToDefault(t){r.log("RollMenuDragUtil.snapToDefault"),t.isCustomPosition=!1,t.customPosition=null,t.element.classList.remove("custom-position"),t.element.classList.remove("left-edge"),t.element.classList.add("snapping"),t.element.style.position="",t.element.style.inset="",t.element.style.left="",t.element.style.top="",t.element.style.right="",t.element.style.bottom="",t.element.style.zIndex="",Me(),await this.saveCustomPosition(null),setTimeout(()=>{t.element.classList.remove("snapping")},300)}static applyCustomPosition(t,e){if(!e||!e.isCustom)return;r.log("RollMenuDragUtil.applyCustomPosition",[e]),t.isCustomPosition=!0,t.customPosition=e,document.body.appendChild(t.element),t.element.style.position="fixed",t.element.style.inset="",t.element.style.top=`${e.y}px`,t.element.style.left=`${e.x}px`,t.element.style.right="auto",t.element.style.bottom="auto",G.addCSSVars("--flash-rolls-menu-offset","0px"),t.element.classList.add("custom-position");const s=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;e.x<s&&t.element.classList.add("left-edge")}static async saveCustomPosition(t){await game.user.setFlag(j.ID,"menuCustomPosition",t)}static loadCustomPosition(){return game.user.getFlag(j.ID,"menuCustomPosition")||null}static async resetPosition(t){await this.snapToDefault(t)}}D(ae,"SNAP_DISTANCE",50),D(ae,"DRAG_HANDLE_SELECTOR",".drag-handle"),D(ae,"LIGHTNING_BOLT_SELECTOR","#flash-rolls-icon");const{ApplicationV2:Lt,HandlebarsApplicationMixin:yt}=foundry.applications.api;var Q;const te=class te extends yt(Lt){constructor(e={}){r.log("RollRequestsMenu.constructor",[e]);super(e);D(this,"_onClickOutside",e=>{if(r.log("_onClickOutside"),this.isLocked)return;const s=this.element;s&&(e.target.closest(".flash-rolls-menu")||s.contains(e.target)||e.target.closest("#flash-rolls-icon")||e.target.closest(".dialog, .app, .notification, .application")||this.close())});this.selectedActors=new Set,this.currentTab="pc",this.selectedRequestType=null,this.isLocked=!1,this.optionsExpanded=game.user.getFlag(j.ID,"menuOptionsExpanded")??!1,this.accordionStates=game.user.getFlag(j.ID,"menuAccordionStates")??{},this.isDragging=!1,this.isCustomPosition=!1,this.customPosition=ae.loadCustomPosition(),this._initializeFromSelectedTokens()}async _prepareContext(e){var L;r.log("_prepareContext");const s=await super._prepareContext(e),i=game.actors.contents,o=[],l=[],n=game.scenes.active;for(const b of i){if(b.type!=="character"&&b.type!=="npc")continue;const S={id:b.id,uuid:b.uuid,name:b.name,img:b.img,selected:this.selectedActors.has(b.id),crlngnStats:Rt.getActorStats(b)};if(Object.entries(b.ownership).some(([C,O])=>{const w=game.users.get(C);return w&&!w.isGM&&O>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER})){const C=E();A.get((L=C.showOnlyPCsWithToken)==null?void 0:L.tag)?n!=null&&n.tokens.some(M=>M.actorId===b.id)&&o.push(S):o.push(S)}else((n==null?void 0:n.tokens.some(O=>O.actorId===b.id))||!1)&&l.push(S)}const a=E(),c=A.get(a.rollRequestsEnabled.tag),d=A.get(a.skipRollDialog.tag),g=A.get(a.groupRollsMsgEnabled.tag);A.get(a.showOnlyPCsWithToken.tag);const h=this.currentTab==="pc"?o:l,p=h.length>0&&h.every(b=>this.selectedActors.has(b.id)),m=this.selectedActors.size>0,R=[];if(m)for(const[b,S]of Object.entries(j.ROLL_REQUEST_OPTIONS)){const T={id:b,name:game.i18n.localize(`FLASH_ROLLS.rollTypes.${S.name}`)||S.label,rollable:S.subList==null,hasSubList:!!S.subList,selected:this.selectedRequestType===b,expanded:this.accordionStates[b]??!1,subItems:[]};S.subList&&(T.subItems=xe(b,this.selectedActors)),R.push(T)}const y=xe(this.selectedRequestType,this.selectedActors);return{...s,actors:h,currentTab:this.currentTab,isPCTab:this.currentTab==="pc",isNPCTab:this.currentTab==="npc",selectedTab:this.currentTab,rollRequestsEnabled:c,skipRollDialog:d,groupRollsMsgEnabled:g,selectAllOn:p,hasSelectedActors:this.selectedActors.size>0,requestTypes:R,rollTypes:y,showNames:!0,actorsLocked:this.isLocked,optionsExpanded:this.optionsExpanded}}async _renderFrame(e){const s=await super._renderFrame(e),i=this.customPosition||ae.loadCustomPosition();if(i!=null&&i.isCustom&&s){s.style.position="fixed",s.style.top=`${i.y}px`,s.style.left=`${i.x}px`,s.style.right="auto",s.style.bottom="auto",s.classList.add("custom-position");const o=parseFloat(getComputedStyle(document.documentElement).fontSize)*15;i.x<o&&s.classList.add("left-edge"),document.body.appendChild(s),G.addCSSVars("--flash-rolls-menu-offset","0px"),this.isCustomPosition=!0,this.customPosition=i}else{const o=document.querySelector("#chat-notifications");o&&s&&o.insertBefore(s,o.firstChild)}return s}_onRender(e,s){if(r.log("_onRender"),super._onRender(e,s),this._attachListeners(),Me(),this.optionsExpanded){const o=this.element.querySelector(".options-toggle"),l=this.element.querySelector("li.options");this.element.querySelector(".options-toggle-btn"),o==null||o.classList.add("expanded"),l==null||l.classList.add("expanded")}setTimeout(()=>{document.addEventListener("click",this._onClickOutside,!0)},100),this._tokenControlHook=Hooks.on(v.CONTROL_TOKEN,this._onTokenControlChange.bind(this)),this._actorUpdateHook=Hooks.on(v.UPDATE_ACTOR,this._onActorUpdate.bind(this)),this._updateItemHook=Hooks.on(v.UPDATE_ITEM,this._onItemUpdate.bind(this)),this._createItemHook=Hooks.on(v.CREATE_ITEM,this._onItemUpdate.bind(this)),this._deleteItemHook=Hooks.on(v.DELETE_ITEM,this._onItemUpdate.bind(this)),this._updateSettingHook=Hooks.on(v.UPDATE_SETTING,this._onSettingUpdate.bind(this)),this._updateSceneHook=Hooks.on(v.UPDATE_SCENE,this._onSceneUpdate.bind(this));const i=this.element.querySelector(ae.DRAG_HANDLE_SELECTOR);i&&i.addEventListener("mousedown",o=>{ae.handleDragStart(o,this)})}_onTokenControlChange(e,s){r.log("_onTokenControlChange"),this.rendered&&(this._ignoreTokenControl||(this._tokenUpdateTimeout&&clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=setTimeout(()=>{this._initializeFromSelectedTokens(),this.render(),this._tokenUpdateTimeout=null},100)))}_onActorUpdate(e,s,i,o){var d,g,h,p,m,R,y,L,b,S,T,C;if(r.log("_onActorUpdate",[e.id,s]),!this.rendered||!(((g=(d=s.system)==null?void 0:d.attributes)==null?void 0:g.hp)||((p=(h=s.system)==null?void 0:h.attributes)==null?void 0:p.ac)||((y=(R=(m=s.system)==null?void 0:m.attributes)==null?void 0:R.spell)==null?void 0:y.dc)||((b=(L=s.system)==null?void 0:L.skills)==null?void 0:b.prc)||((S=s.system)==null?void 0:S.abilities)||((C=(T=s.system)==null?void 0:T.attributes)==null?void 0:C.prof)))return;const n=this.currentTab,a=Object.entries(e.ownership).some(([O,w])=>{const M=game.users.get(O);return M&&!M.isGM&&w>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER});(n==="pc"&&a||n==="npc"&&!a&&ye(e))&&(this._actorUpdateTimeout&&clearTimeout(this._actorUpdateTimeout),this._actorUpdateTimeout=setTimeout(()=>{this.render(),this._actorUpdateTimeout=null},100))}_onItemUpdate(e,s,i,o){var g,h;if(!this.rendered||!(e.type==="equipment"||((g=s.system)==null?void 0:g.equipped)!==void 0||((h=s.system)==null?void 0:h.attunement)!==void 0))return;const n=e.parent;if(!n||n.documentName!=="Actor")return;const a=this.currentTab,c=Object.entries(n.ownership).some(([p,m])=>{const R=game.users.get(p);return R&&!R.isGM&&m>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER});(a==="pc"&&c||a==="npc"&&!c&&ye(n))&&(this._itemUpdateTimeout&&clearTimeout(this._itemUpdateTimeout),this._itemUpdateTimeout=setTimeout(()=>{r.log("Refreshing menu due to item change affecting AC",[e.name,n.name]),this.render(),this._itemUpdateTimeout=null},500))}_onSettingUpdate(e,s,i,o){if(!this.rendered)return;const l=E();e.key===`${j.ID}.${l.showOnlyPCsWithToken.tag}`&&this.render()}_onSceneUpdate(e,s,i,o){var l;if(this.rendered&&s.active===!0){const n=E();A.get((l=n.showOnlyPCsWithToken)==null?void 0:l.tag),this.render()}}_attachListeners(){var n,a,c,d,g,h;r.log("_attachListeners");const e=this.element;(n=e.querySelector("#flash-rolls-toggle"))==null||n.addEventListener("change",this._onToggleRollRequests.bind(this)),(a=e.querySelector("#flash5e-skip-dialogs"))==null||a.addEventListener("change",this._onToggleSkipDialogs.bind(this)),(c=e.querySelector("#flash5e-group-rolls-msg"))==null||c.addEventListener("change",this._onToggleGroupRollsMsg.bind(this)),(d=e.querySelector("#flash5e-actors-all"))==null||d.addEventListener("change",this._onToggleSelectAll.bind(this)),(g=e.querySelector("#flash5e-actors-lock"))==null||g.addEventListener("click",this._onToggleLock.bind(this)),(h=e.querySelector(".options-toggle-btn"))==null||h.addEventListener("click",this._onToggleOptions.bind(this)),e.querySelectorAll(".actor-tab").forEach(p=>{p.addEventListener("click",this._onTabClick.bind(this)),p.addEventListener("dblclick",this._onTabDoubleClick.bind(this))}),e.querySelectorAll(".actor").forEach(p=>{p.addEventListener("click",this._onActorClick.bind(this))}),e.querySelectorAll(".actor-select").forEach(p=>{p.addEventListener("click",this._onActorSelectClick.bind(this))});const i=e.querySelector(".search-input");i&&i.addEventListener("input",this._onSearchInput.bind(this));const o=e.querySelector(".request-types-accordion");o&&(e.addEventListener("mouseenter",()=>{this.selectedActors.size>0&&o.classList.add("hover-visible")}),e.addEventListener("mouseleave",()=>{o.classList.remove("hover-visible")}));const l=e.querySelector(".request-types");l&&l.addEventListener("click",p=>{const m=p.target.closest(".request-type-header");if(m){const y=m.closest(".request-type-item");if(m.classList.contains("accordion-header")){this._onAccordionToggle(p);return}if(m.classList.contains("toggle")&&y&&y.classList.contains("rollable")){const L={...p,currentTarget:y};this._onRequestTypeClick(L);return}}const R=p.target.closest(".sub-item");if(R&&R.dataset.id){const y={...p,currentTarget:R};this._onRollTypeClick(y)}})}async _onToggleRollRequests(e){r.log("_onToggleRollRequests");const s=E(),i=e.target.checked;await A.set(s.rollRequestsEnabled.tag,i),De.updateRollRequestsIcon(i)}async _onToggleSkipDialogs(e){r.log("_onToggleSkipDialogs");const s=E(),i=e.target.checked;await A.set(s.skipRollDialog.tag,i)}async _onToggleGroupRollsMsg(e){r.log("_onToggleGroupRollsMsg");const s=E(),i=e.target.checked;await A.set(s.groupRollsMsgEnabled.tag,i)}_onToggleSelectAll(e){var n;r.log("_onToggleSelectAll");const s=e.target.checked;this._ignoreTokenControl=!0;const i=E(),o=A.get((n=i.showOnlyPCsWithToken)==null?void 0:n.tag);(this.currentTab==="pc"?game.actors.contents.filter(a=>{if(!Le(a))return!1;if(o){const c=game.scenes.active;return(c==null?void 0:c.tokens.some(d=>d.actorId===a.id))||!1}return!0}):game.actors.contents.filter(a=>!Le(a)&&ye(a))).forEach(a=>{s?(this.selectedActors.add(a.id),be(a.id,!0)):(this.selectedActors.delete(a.id),be(a.id,!1))}),setTimeout(()=>{this._ignoreTokenControl=!1},200),this.render(),this._updateRequestTypesVisibility()}_onToggleLock(e){r.log("_onToggleLock"),e.preventDefault(),this.isLocked=!this.isLocked;const s=e.currentTarget;s.classList.remove("fa-lock-keyhole","fa-lock-keyhole-open"),s.classList.add(this.isLocked?"fa-lock-keyhole":"fa-lock-keyhole-open")}async _onToggleOptions(e){r.log("_onToggleOptions"),e.preventDefault(),e.stopPropagation(),this.optionsExpanded=!this.optionsExpanded,await game.user.setFlag(j.ID,"menuOptionsExpanded",this.optionsExpanded);const s=this.element.querySelector(".options-toggle");s&&s.classList.toggle("expanded",this.optionsExpanded);const i=this.element.querySelector("li.options");i&&i.classList.toggle("expanded",this.optionsExpanded)}_initializeFromSelectedTokens(){var s;r.log("_initializeFromSelectedTokens");const e=((s=canvas.tokens)==null?void 0:s.controlled)||[];this.selectedActors.clear();for(const i of e)if(i.actor&&(this.selectedActors.add(i.actor.id),this.selectedActors.size===1)){const o=Le(i.actor);this.currentTab=o?"pc":"npc"}r.log("_initializeFromSelectedTokens",[this.selectedActors])}async _onTabClick(e){r.log("_onTabClick");const s=e.currentTarget.dataset.tab;s!==this.currentTab&&(this.selectedRequestType=null,this.currentTab=s,await this.render())}async _onTabDoubleClick(e){var s;r.log("_onTabDoubleClick"),e.preventDefault(),e.stopPropagation(),this._ignoreTokenControl=!0,this.selectedActors.clear(),(s=canvas.tokens)==null||s.releaseAll(),this.selectedRequestType=null,setTimeout(()=>{this._ignoreTokenControl=!1},200),await this.render(),this._updateRequestTypesVisibility()}_onActorClick(e){if(r.log("_onActorClick"),e.target.closest(".actor-select"))return;const i=e.currentTarget.dataset.id;this._toggleActorSelection(i)}_onActorSelectClick(e){r.log("_onActorSelectClick"),e.stopPropagation();const s=e.currentTarget.dataset.id;this._toggleActorSelection(s)}_toggleActorSelection(e){r.log("_toggleActorSelection"),this._ignoreTokenControl=!0,this.selectedActors.has(e)?(this.selectedActors.delete(e),be(e,!1)):(this.selectedActors.add(e),be(e,!0)),setTimeout(()=>{this._ignoreTokenControl=!1},100),this.render(),this._updateRequestTypesVisibility(),this._updateSelectAllState()}_updateRequestTypesVisibility(){r.log("_updateRequestTypesVisibility"),this.render()}_updateSelectAllState(){r.log("_updateSelectAllState");const e=this.element.querySelector("#flash5e-actors-all"),s=this.currentTab==="pc"?"pc":"npc",i=this.element.querySelectorAll(`.${s}-actors .actor-item input[type="checkbox"]`),o=Array.from(i).filter(l=>l.checked).length;e.checked=o>0&&o===i.length,e.indeterminate=o>0&&o<i.length}_onSearchInput(e){r.log("_onSearchInput");const s=e.target.value.toLowerCase().trim(),i=this.element.querySelector(".request-types");if(!i)return;i.querySelectorAll(".request-type-item").forEach(l=>{var d;const n=((d=l.querySelector(".request-type-name"))==null?void 0:d.textContent.toLowerCase())||"",a=l.querySelectorAll(".sub-item");let c=!1;if(a.length>0){a.forEach(p=>{var y;const R=(((y=p.querySelector(".sub-item-name"))==null?void 0:y.textContent.toLowerCase())||"").includes(s);p.classList.toggle("hidden",!R),R&&(c=!0)});const g=n.includes(s),h=s===""||g||c;if(l.classList.toggle("hidden",!h),s&&c){const p=l.querySelector(".roll-types-nested"),m=l.querySelector(".accordion-toggle");p&&m&&(p.style.display="block",m.classList.add("expanded"))}}else{const g=s===""||n.includes(s);l.classList.toggle("hidden",!g)}})}async _onAccordionToggle(e){r.log("_onAccordionToggle"),e.stopPropagation();const i=e.target.closest(".request-type-header").closest(".request-type-item"),o=i.dataset.id,l=i.querySelector(".accordion-toggle"),n=i.querySelector(".roll-types-nested");if(!n)return;const a=l.classList.contains("expanded");l.classList.toggle("expanded",!a),n.style.display=a?"none":"block",this.accordionStates[o]=!a,await game.user.setFlag(j.ID,"menuAccordionStates",this.accordionStates)}async _onRequestTypeClick(e){const s=e.currentTarget,i=s.dataset.id,o=j.ROLL_REQUEST_OPTIONS[i];if(r.log("_onRequestTypeClick",[i,s.dataset,o]),!o){r.error("Unknown request type:",[i]);return}this.selectedRequestType===i?this.selectedRequestType=null:this.selectedRequestType=i,o.subList?await this.render():this.selectedRequestType&&this._triggerRoll(i,null)}_onRollTypeClick(e){r.log("_onRollTypeClick");const s=e.currentTarget.dataset.id,o=e.currentTarget.dataset.parent||this.selectedRequestType;this._triggerRoll(o,s)}async _getRollConfiguration(e,s,i,o,l){const n=E(),a=A.get(n.rollRequestsEnabled.tag);if(!o&&s!==f.CUSTOM){let c;[f.SKILL,f.TOOL].includes(s)?c=He:s===f.HIT_DIE?c=ve:c=X;const d=await c.initConfiguration(e,s,i,{skipRollDialog:o,sendRequest:a||!1});return r.log("_getRollConfiguration",[d]),d}else{const c={rolls:[{parts:[],data:{},options:{}}],advantage:!1,disadvantage:!1,rollMode:game.settings.get("core","rollMode"),chatMessage:!0,isRollRequest:!1,skipRollDialog:!0,sendRequest:a&&l.length>0};return s===f.DEATH_SAVE&&(c.target=10),c}}async _orchestrateRollsForActors(e,s,i,o,l){const n=E(),a=[],c=[],d=[];r.log("_orchestrateRollsForActors",[e,s,i]);const g=foundry.utils.randomID(),h=[];if(e.sendRequest){for(const{actor:R,owner:y}of s)y.active?d.push({actor:R,owner:y}):(A.get(n.showOfflineNotifications.tag)&&H.notify("info",game.i18n.format("FLASH_ROLLS.notifications.playerOffline",{player:y.name})),c.push(R));h.push(...d.map(({actor:R})=>R))}else i.push(...s.map(({actor:R})=>R));h.push(...c,...i);const p=A.get(n.groupRollsMsgEnabled.tag);p&&h.length>1&&await B.createGroupRollMessage(h,o,l,e,g);for(const{actor:R,owner:y}of d){const L=p&&h.length>1?g:null;await this._sendRollRequestToPlayer(R,y,o,l,e,!0,L),a.push({actor:R,owner:y}),await Se(100)}a.length>0&&this._showConsolidatedNotification(a,o,l);const m=[...c,...i];m.length>0&&(e.skipRollDialog=!0,e.groupRollId=p&&h.length>1?g:null,await this._handleGMRolls(m,o,l,e))}async _triggerRoll(e,s){var p,m,R;r.log("_triggerRoll",[e,s]);const i=E(),o=Array.from(this.selectedActors),l=A.get(i.skipRollDialog.tag);let n=o.map(y=>game.actors.get(y)).filter(y=>y);const a=j.ROLL_REQUEST_OPTIONS[e],c=(p=(a==null?void 0:a.name)||e)==null?void 0:p.toLowerCase();switch(c){case f.CUSTOM:if(s=await Ve.handleCustomRoll(),!s)return;break;case f.INITIATIVE:case f.INITIATIVE_DIALOG:if(await Ke()){r.log("_triggerRoll - initiative",[o]);for(const S of o){const T=game.actors.get(S);if(T){const C=game.combat.getCombatantsByActor(S);(!C||C.length===0)&&(r.log("_triggerRoll - adding actor to combat",T.name),await game.combat.createEmbeddedDocuments("Combatant",[{actorId:S,tokenId:(R=(m=T.getActiveTokens())==null?void 0:m[0])==null?void 0:R.id}]))}}const L=await Je(o,game);if(r.log("_triggerRoll filteredActorIds",[L,!L.length]),!L.length)return;n=L.map(S=>game.actors.get(S)).filter(S=>S),A.get(i.initiateCombatOnRequest.tag)&&game.combat.startCombat()}break;case f.DEATH_SAVE:n=await ut(n);break}if(!n.length){H.notify("warn","No valid actors selected");return}const{pcActors:d,npcActors:g}=dt(n),h=await Ve.getRollConfiguration(n,c,s,l,d);r.log("_triggerRoll config",[h]),h&&(await bt.orchestrateRollsForActors(h,d,g,c,s),this.isLocked||setTimeout(()=>this.close(),500))}async _sendRollRequestToPlayer(e,s,i,o,l,n=!1,a=null){r.log("_sendRollRequestToPlayer #A",[i,o]);const c=E();let d=i==null?void 0:i.toLowerCase();if(d===f.ABILITY_CHECK?d=f.ABILITY:d===f.SAVING_THROW?d=f.SAVE:d===f.INITIATIVE_DIALOG&&(d=f.INITIATIVE),d===f.HIT_DIE){const p=e.system.attributes.hd;if(p.value>0)o=p.largestAvailable;else if(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessage",{actors:e.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndSend")||"Refill & Send",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){try{r.log("About to call handleHitDieRecovery for",[e.name]);const R=await z.handleHitDieRecovery(e);r.log("handleHitDieRecovery completed",[R])}catch(R){r.error("Error calling handleHitDieRecovery:",[R])}o=e.system.attributes.hd.largestAvailable,H.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:e.name})||`Hit dice refilled for ${e.name}`)}else return}const g={...l};delete g.subject,delete g.workflow,delete g.item,delete g.activity;const h={type:"rollRequest",groupRollId:a||foundry.utils.randomID(),actorId:e.id,rollType:d,rollKey:o,activityId:null,rollProcessConfig:{...g,_requestedBy:game.user.name},skipRollDialog:!1,targetTokenIds:Array.from(game.user.targets).map(p=>p.id),preserveTargets:A.get(c.useGMTargetTokens.tag)};r.log("_sendRollRequestToPlayer - prepareMidiQOLSettings",[]),J.execForUser("handleRollRequest",s.id,h),n||H.notify("info",game.i18n.format("FLASH_ROLLS.notifications.rollRequestSent",{player:s.name,actor:e.name}))}_showConsolidatedNotification(e,s,i){var a,c,d,g,h;r.log("_showConsolidatedNotification");const o={};for(const{actor:p,owner:m}of e)o[m.id]||(o[m.id]={player:m,actors:[]}),o[m.id].actors.push(p);for(const[p,m]of Object.entries(j.ROLL_REQUEST_OPTIONS))if(m.name===s)break;const l=s;let n=game.i18n.localize(`FLASH_ROLLS.rollTypes.${l}`)||l;if(i){const p=l.toLowerCase();if(p===f.SKILL)n=`${n} (${((a=CONFIG.DND5E.skills[i])==null?void 0:a.label)||i})`;else if(p===f.SAVING_THROW)n=`${n} (${((c=CONFIG.DND5E.abilities[i])==null?void 0:c.label)||i})`;else if(p===f.ABILITY_CHECK)n=`${n} (${((d=CONFIG.DND5E.abilities[i])==null?void 0:d.label)||i})`;else if(p===f.TOOL){const m=(h=(g=CONFIG.DND5E.enrichmentLookup)==null?void 0:g.tools)==null?void 0:h[i];if(m!=null&&m.id){const R=dnd5e.documents.Trait.getBaseItem(m.id,{indexOnly:!0});n=`${n} (${(R==null?void 0:R.name)||i})`}else n=`${n} (${i})`}else p===f.CUSTOM&&(n=`${n}: ${i}`)}H.notifyRollRequestsSent(o,n)}async _handleGMRolls(e,s,i,o){r.log("_handleGMRolls",[e,s,i,o]);for(const l of e)await this._initiateRoll(l,s,i,o),await Se(100)}async _initiateRoll(e,s,i,o){var l,n,a,c,d;r.log("_initiateRoll",[s,i,o]);try{const g=s.toLowerCase();let h=i;if(g===f.HIT_DIE){const S=e.system.attributes.hd;if(S){const T=["d6","d8","d10","d12","d20"];for(const C of T)if((((l=S[C])==null?void 0:l.value)||0)>0){h=C;break}}if(!h)if(r.log("_initiateRoll - No hit dice available",[e.name]),await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillTitle")||"No Hit Dice Available",classes:["flash5e-hit-die-dialog"]},position:{width:420},content:`<p>${game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refillMessageLocal",{actors:e.name})||""}</p>`,modal:!0,rejectClose:!1,yes:{label:game.i18n.localize("FLASH_ROLLS.ui.dialogs.hitDie.refillAndRoll")||"Refill & Roll",icon:""},no:{label:game.i18n.localize("Cancel")||"Cancel",icon:""}})){const C=await z.handleHitDieRecovery(e);if(r.log("Hit die recovery result",[C]),H.notify("info",game.i18n.format("FLASH_ROLLS.ui.dialogs.hitDie.refilled",{actor:e.name})),h=e.system.attributes.hd.largestAvailable,!h){H.notify("warn",game.i18n.format("DND5E.HitDiceWarn",{name:e.name}));return}}else return}const p=((c=(a=(n=o.rolls)==null?void 0:n[0])==null?void 0:a.data)==null?void 0:c.situational)||"",m={rollKey:h,groupRollId:o.groupRollId,config:{...o,situational:p,rollMode:o.rollMode||game.settings.get("core","rollMode"),advantage:o.advantage||!1,disadvantage:o.disadvantage||!1,target:o.target}},R={configure:!o.fastForward&&!o.skipRollDialog,isRollRequest:!0},y={rollMode:o.rollMode||game.settings.get("core","rollMode"),create:o.chatMessage!==!1,isRollRequest:!0},L=((d=o.rolls)==null?void 0:d[0])||{},b=z[g];b?await b(e,m,L,R,y):H.notify("warn",`Unknown roll type: ${s}`)}catch(g){r.error("executeActorRoll",[g]),H.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:e.name}))}}async _onClose(e){if(r.log("_onClose",[e]),!!this.element){if(this.isCustomPosition&&this.element.parentElement===document.body){const s=document.querySelector("#chat-notifications");s&&s.insertBefore(this.element,s.firstChild),this.element.style.position="",this.element.style.inset="",this.element.style.top="",this.element.style.left="",this.element.style.right="",this.element.style.bottom="",this.element.classList.remove("custom-position")}await super._onClose(e),this.selectedActors.clear(),this.selectedRequestType=null,document.removeEventListener("click",this._onClickOutside,!0),this._tokenControlHook&&(Hooks.off(v.CONTROL_TOKEN,this._tokenControlHook),this._tokenControlHook=null),this._actorUpdateHook&&(Hooks.off(v.UPDATE_ACTOR,this._actorUpdateHook),this._actorUpdateHook=null),this._updateItemHook&&(Hooks.off(v.UPDATE_ITEM,this._updateItemHook),this._updateItemHook=null),this._createItemHook&&(Hooks.off(v.CREATE_ITEM,this._createItemHook),this._createItemHook=null),this._deleteItemHook&&(Hooks.off(v.DELETE_ITEM,this._deleteItemHook),this._deleteItemHook=null),this._tokenUpdateTimeout&&(clearTimeout(this._tokenUpdateTimeout),this._tokenUpdateTimeout=null),this._actorUpdateTimeout&&(clearTimeout(this._actorUpdateTimeout),this._actorUpdateTimeout=null),this._itemUpdateTimeout&&(clearTimeout(this._itemUpdateTimeout),this._itemUpdateTimeout=null),W(te,Q)===this&&re(te,Q,null)}}setPosition(e={}){return r.log("setPosition"),this}async _showCustomRollDialog(){return r.log("_showCustomRollDialog"),_e.prompt({formula:"",readonly:!1})}static toggle(){r.log("RollRequestsMenu.toggle"),document.querySelectorAll("#flash-rolls-menu").forEach(s=>{r.log("Removing orphaned menu element"),s.remove()}),W(this,Q)?W(this,Q).rendered?W(this,Q).close():(W(this,Q)._initializeFromSelectedTokens(),W(this,Q).render(!0)):(re(this,Q,new te),W(this,Q).render(!0))}};Q=new WeakMap,oe(te,Q,null),D(te,"DEFAULT_OPTIONS",{id:"flash-rolls-menu",classes:["flash-rolls-menu"],tag:"div",window:{frame:!1,resizable:!1,minimizable:!1},position:{}}),D(te,"PARTS",{main:{template:`modules/${j.ID}/templates/requests-menus.hbs`}});let Oe=te;class De{static addSidebarControls(t,e){if(r.log("addSidebarControls",[t,e]),!game.user.isGM||!t||t.id!=="sidebar")return;const s=document.querySelector("#roll-privacy");if(r.log("addSidebarControls",[s]),!s||s.querySelector(".flash-rolls-icon"))return;const i=E(),o=A.get(i.rollRequestsEnabled.tag),l=document.createElement("button");l.id="flash-rolls-icon",l.setAttribute("data-tooltip-direction","RIGHT"),l.className=`ui-control icon chat-control-icon flash-rolls-icon${o?" active":""}`,l.title=game.i18n.localize("FLASH_ROLLS.ui.menus.rollRequestsTitle"),l.innerHTML=`<i class="fas fa-bolt${o?"":"-slash"}"></i>`;const n=s.firstChild;n?n.parentNode.insertBefore(l,n):s.insertBefore(l,s.firstChild),r.log("addSidebarControls",[n,l]),l.addEventListener("click",a=>{a.stopPropagation(),a.preventDefault(),Oe.toggle()})}static updateRollRequestsIcon(t){const e=document.querySelector("#flash-rolls-icon i");e&&(e.className=`fas fa-bolt${t?"":"-slash"}`)}}const Z=class Z{static initialize(){Hooks.once(v.INIT,this._onInit.bind(this)),Hooks.once(v.READY,this._onReady.bind(this))}static _onInit(){E(),document.body.classList.add("flash5e"),A.registerSettings(),ne.initialize(),this._registerHooks()}static _onReady(){var t;A.registerSettingsMenu(),De.addSidebarControls(ui.sidebar,(t=ui.sidebar)==null?void 0:t.element),le.isModuleActive("midi-qol")?(r.log("HooksUtil.initialize",["midi-qol is active. Awaiting for it to be ready..."]),Hooks.once(ot.READY,this._initModule.bind(this))):(r.log("HooksUtil.initialize",["midi-qol is NOT active. Starting..."]),this._initModule())}static async _initModule(){const t=E();A.get(t.debugMode.tag)&&(CONFIG.debug.hooks=!0),await B.initialize(),game.user.isGM?(Xe.initialize(),this._registerGMHooks()):(ne.getDiceConfig(),this._registerPlayerHooks()),qe(Pe())}static _registerHooks(){this._registerHook(v.RENDER_SIDEBAR,this._onRenderSidebar.bind(this)),this._registerHook(v.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessage.bind(this)),this._registerHook(v.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageFlavor.bind(this)),this._registerHook(v.RENDER_CHAT_MESSAGE,this._onRenderChatMessageHTML.bind(this)),this._registerHook(v.CHANGE_SIDEBAR_TAB,this._onSidebarUpdate.bind(this)),this._registerHook(v.COLLAPSE_SIDE_BAR,this._onSidebarUpdate.bind(this)),this._registerHook(v.REFRESH_MEASURED_TEMPLATE,this.onRefreshTemplate.bind(this)),this._registerHook(N.RENDER_ROLL_CONFIGURATION_DIALOG,this._onRenderRollConfigDialog.bind(this)),this._registerHook(N.RENDER_SKILL_TOOL_ROLL_DIALOG,this._onRenderSkillToolDialog.bind(this)),this._registerHook(N.PRE_USE_ACTIVITY,this._onPreUseActivity.bind(this)),this._registerHook(N.POST_USE_ACTIVITY,this._onPostUseActivity.bind(this)),this._registerHook(N.PRE_ROLL_HIT_DIE_V2,this._onPreRollHitDieV2.bind(this)),this._registerHook(N.POST_ROLL_CONFIG,this._onPostRollConfig.bind(this))}static _registerGMHooks(){this._registerHook(v.USER_CONNECTED,this._onUserConnected.bind(this)),this._registerHook(v.PRE_CREATE_CHAT_MESSAGE,this._onPreCreateChatMessageGM.bind(this)),this._registerHook(N.PRE_ROLL_V2,this._onPreRoll.bind(this)),game.users.forEach(t=>{this._onUserConnected(t)})}static _registerPlayerHooks(){this._registerHook(N.PRE_ROLL_INITIATIVE_DIALOG,this._onPreRollInitiativeDialog.bind(this)),this._registerHook(N.PRE_ROLL_ATTACK_V2,this._onPreRollAttackV2.bind(this)),this._registerHook(N.PRE_ROLL_DAMAGE_V2,this._onPreRollDamageV2.bind(this)),Hooks.on(N.PRE_ROLL_ABILITY_CHECK,(t,e,s)=>{r.log("_onPreRollAbilityCheckV2",[t,e,s]),t.isRollRequest&&(e.configure=!0)})}static _onSidebarUpdate(t){r.log("_onSidebarUpdate",[t]),qe(Pe())}static _onPostRollConfig(t,e,s,i){e._showRequestedBy&&t.length>0&&(i.data=i.data||{},i.data._showRequestedBy=!0,i.data._requestedBy=e._requestedBy)}static _onPreCreateChatMessage(t,e,s,i){var o,l,n,a,c,d,g,h,p,m;if(e._showRequestedBy&&((o=e.rolls)==null?void 0:o.length)>0){const R=e._requestedBy||"GM",y=game.i18n.format("FLASH_ROLLS.chat.requestedBy",{gm:R}),L=e.flavor||"";e.flavor=L?`${L} ${y}`:y}if((n=(l=e.flags)==null?void 0:l[_])!=null&&n.groupRollId&&r.log("_onPreCreateChatMessage - Found groupRollId in data flags",[e]),((a=e.rolls)==null?void 0:a.length)>0||(d=(c=e.flags)==null?void 0:c.core)!=null&&d.initiativeRoll){const R=e.speaker,y=R==null?void 0:R.actor;if(y){let L=game.actors.get(y);if(!L&&(R!=null&&R.token)){const b=canvas.tokens.get(R.token);b!=null&&b.actor&&(L=b.actor,r.log("_onPreCreateChatMessage - Using token actor from speaker",[L.name,L.id]))}if(!L){r.log("_onPreCreateChatMessage - No actor found",[y,R]);return}if(game.user.isGM){const b=L.isToken?(g=L.actor)==null?void 0:g.id:L.id,S=[y,b].filter(T=>T);for(const[T,C]of B.pendingRolls.entries())if(S.some(O=>C.actors.includes(O))){e.flags=e.flags||{},e.flags[_]=e.flags[_]||{},e.flags[_].groupRollId=T,r.log("_onPreCreateChatMessage - Added groupRollId flag (GM)",[T,y]);break}}else{let b=L.getFlag(_,"tempGroupRollId");if(!b&&L.isToken){const T=game.actors.get((h=L.actor)==null?void 0:h.id);T&&(b=T.getFlag(_,"tempGroupRollId"),r.log("_onPreCreateChatMessage - Checking base actor for tempGroupRollId",[T.id,b]))}if(b&&(L.unsetFlag(_,"tempGroupRollId"),L.isToken)){const T=game.actors.get((p=L.actor)==null?void 0:p.id);T&&T.unsetFlag(_,"tempGroupRollId")}let S=L.getFlag(_,"tempInitiativeConfig");if(!S&&L.isToken){const T=game.actors.get((m=L.actor)==null?void 0:m.id);T&&(S=T.getFlag(_,"tempInitiativeConfig"),r.log("_onPreCreateChatMessage - Checking base actor for tempInitiativeConfig",[T.id,S]))}(S!=null&&S.groupRollId||b)&&(e.flags=e.flags||{},e.flags[_]=e.flags[_]||{},e.flags[_].groupRollId=b||S.groupRollId,r.log("_onPreCreateChatMessage - Added groupRollId flag from initiative config",[S.groupRollId,y]))}}}}static _onPreCreateChatMessageFlavor(t,e,s,i){var o,l;if(((o=e.rolls)==null?void 0:o.length)>0&&e.rolls[0])try{const n=e.rolls[0];(l=n.options)!=null&&l._customFlavor&&(e.flavor=n.options._customFlavor)}catch(n){r.error("_onPreCreateChatMessageFlavor",[n])}}static _onRenderRollConfigDialog(t,e,s){var o,l,n,a,c;if(r.log("_onRenderRollConfigDialog #0",[t,s]),t._flashRollsApplied)return;if(((l=(o=t.config)==null?void 0:o.hookNames)==null?void 0:l.includes("initiativeDialog"))||((a=(n=t.element)==null?void 0:n.id)==null?void 0:a.includes("initiative"))){const d=(c=t.config)==null?void 0:c.subject;if(!d)return;if(d.getFlag(_,"tempInitiativeConfig")){t._flashRollsApplied=!0;const h=e.querySelector('input[name*="situational"]');setTimeout(()=>{h.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))},50)}return}else e.querySelectorAll('input[name*="situational"]').forEach((g,h)=>{var p,m,R,y;!g.value&&((y=(R=(m=(p=t.config)==null?void 0:p.rolls)==null?void 0:m[0])==null?void 0:R.data)!=null&&y.situational)&&(g.value=t.config.rolls[0].data.situational),r.log("_onRenderRollConfigDialog #1",[g.value,t.config.rolls[0]]),g.value&&(t._flashRollsApplied=!0,setTimeout(()=>{var L,b,S;g.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1})),(S=(b=(L=t.config)==null?void 0:L.rolls)==null?void 0:b[0])!=null&&S.data&&delete t.config.rolls[0].data.situational},50))})}static _onPreCreateChatMessageGM(t,e,s,i){r.log("_onPreCreateChatMessageGM",[t,e,s,i])}static _onRenderChatMessageHTML(t,e,s){r.log("_onRenderChatMessageHTML",[t,e,s]),B.interceptRollMessage(t,e,s),this._addSelectTargetsButton(t,e)}static _addSelectTargetsButton(t,e){var i,o,l;if(r.log("_addSelectTargetsButton #0",[t,e,e.querySelector(".message-content")]),((l=(o=(i=t.flags)==null?void 0:i.dnd5e)==null?void 0:o.roll)==null?void 0:l.type)!=="damage"||e.querySelector(".select-targeted"))return;const s=document.createElement("button");s.className="select-targeted",s.type="button",s.setAttribute("data-tooltip-direction","LEFT"),s.setAttribute("data-tooltip","Select Targeted"),s.innerHTML='<i class="fas fa-crosshairs"></i>',s.addEventListener("click",n=>{n.preventDefault(),this._selectTargetedTokens(n)}),e.querySelector(".message-content").appendChild(s),t.update({content:e})}static _selectTargetedTokens(t){const e=t.currentTarget.closest(".chat-message"),s=e.querySelectorAll("[data-target-uuid]");if(s.length===0){ui.notifications.warn(game.i18n.localize("FLASH_ROLLS.notifications.noTargetedTokens"));return}r.log("_selectTargetedTokens",[e,s,canvas.tokens.placeables,game.scenes.active]);for(let i=0;i<s.length;i++){const l=s[i].dataset.targetUuid.split("Actor.")[1],n=canvas.tokens.placeables.find(a=>a.document.actorId===l);n==null||n.control({releaseOthers:i===0})}}static _onUserConnected(t){t.active&&t.id!==game.user.id&&ne.requestDiceConfigFromUser(t.id)}static _onRenderApplicationV2(t,e,s){r.log("_onRenderApplicationV2",[t,e,s])}static _onRenderSidebar(t,e,s){r.log("_onRenderSidebar",[t,e]),game.ready&&De.addSidebarControls(t,e)}static _registerHook(t,e){const s=Hooks.on(t,e);return this.registeredHooks.set(`${t}_${s}`,s),s}static unregisterAll(){this.registeredHooks.forEach((t,e)=>{const s=e.split("_")[0];Hooks.off(s,t)}),this.registeredHooks.clear()}static isRegistered(t){for(const e of this.registeredHooks.keys())if(e.startsWith(`${t}_`))return!0;return!1}static _onPreRoll(t,e,s,i){r.log("_onPreRoll #0",[t,e,s,i])}static _onPreRollHitDieV2(t,e,s){if(r.log("_onPreRollHitDieV2 triggered",[t,e,s]),t.rolls&&t.rolls.length>1){const i=[];for(let o=0;o<t.rolls.length;o++){const l=t.rolls[o];l&&l.data&&l.data.situational&&i.push(l.data.situational)}if(i.length>0){t.rolls[0].data||(t.rolls[0].data={});const o=[...new Set(i)];t.rolls[0].data.situational=o.map(l=>{const n=l.toString().trim();return n.startsWith("-")?`(${n})`:n.startsWith("+")?`${n.substring(1)}`:`${n}`}).join(" + "),game.user.isGM&&!t.rolls[0].parts.find(l=>l.includes("@situational"))&&t.rolls[0].parts.push("@situational")}t.rolls=t.rolls.slice(0,1),r.log("Cleaned up hit die rolls",t.rolls)}}static _onPreRollInitiativeDialog(t,e,s){var l,n,a,c,d;const o=t.subject.getFlag(_,"tempInitiativeConfig");r.log("_onPreRollInitiativeDialog triggered",[t,o,e,s]),t.advantage=(o==null?void 0:o.advantage)||t.advantage||!1,t.disadvantage=(o==null?void 0:o.disadvantage)||t.disadvantage||!1,t.rollMode=(o==null?void 0:o.rollMode)||t.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,s.rollMode=(o==null?void 0:o.rollMode)||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,(a=(n=(l=o.rolls)==null?void 0:l[0])==null?void 0:n.data)!=null&&a.situational&&((d=(c=t.rolls)==null?void 0:c[0])!=null&&d.data)&&(t.rolls[0].data.situational=o.rolls[0].data.situational)}static _onPreRollAttackV2(t,e,s){var o,l;r.log("_onPreRollAttackV2 triggered",[t,e,s]);const i=(l=(o=t.subject)==null?void 0:o.item)==null?void 0:l.getFlag(_,"tempAttackConfig");if(i){if(r.log("_onPreRollAttackV2 - Found stored request config from flag",[i]),i.isRollRequest===!1||i.skipRollDialog===!0||i.sendRequest===!1){r.log("_onPreRollAttackV2 - Not a roll request, skipping",[i]);return}i.attackMode&&(t.attackMode=i.attackMode),i.ammunition&&(t.ammunition=i.ammunition),i.mastery!==void 0&&(t.mastery=i.mastery),t.advantage=i.advantage||!1,t.disadvantage=i.disadvantage||!1,s.rollMode=i.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,i.situational&&((!t.rolls||t.rolls.length===0)&&(t.rolls=[{parts:[],data:{},options:{}}]),t.rolls[0].data||(t.rolls[0].data={}),t.rolls[0].data.situational=i.situational),r.log("_onPreRollAttackV2 - Applied stored configuration to attack roll",[t,s])}}static _onPreRollDamageV2(t,e,s){var o,l;r.log("_onPreRollDamageV2 triggered",[t,e,s]);const i=(l=(o=t.subject)==null?void 0:o.item)==null?void 0:l.getFlag(_,"tempDamageConfig");if(i){if(r.log("_onPreRollDamageV2 - Found stored request config from flag",[i,i.situational]),i.isRollRequest===!1||i.skipRollDialog===!0||i.sendRequest===!1){r.log("_onPreRollDamageV2 - Not a roll request, skipping",[i]);return}i.critical&&(t.critical=i.critical),s.rollMode=i.rollMode||s.rollMode||CONST.DICE_ROLL_MODES.PUBLIC,i.situational&&((!t.rolls||t.rolls.length===0)&&(t.rolls=[{parts:[],data:{},options:{}}]),t.rolls[0].data||(t.rolls[0].data={}),t.rolls[0].data.situational=i.situational),r.log("_onPreRollDamageV2 - Applied stored configuration to damage roll",[t,s])}}static _onPreUseActivity(t,e,s,i){r.log("_onPreUseActivity triggered",[t,e,s,i]);const o=E(),l=A.get(o.rollRequestsEnabled.tag),n=A.get(o.rollInterceptionEnabled.tag);if(r.log("_onPreUseActivity - Settings",[l,n]),t.item.unsetFlag(_,"tempAttackConfig"),t.item.unsetFlag(_,"tempDamageConfig"),t.item.unsetFlag(_,"tempSaveConfig"),G.isModuleOn(_,"midi-qol"),!game.user.isGM||!l||!n)return;const a=t.actor;if(!a)return;switch(A.get(o.consumptionConfigMode.tag)){case 1:s.configure=!1;break;case 2:s.configure=game.user.isGM;break;case 3:s.configure=!game.user.isGM;break;default:s.configure=!0;break}const d=G.getActorOwner(a);d&&d.active&&!d.isGM&&(r.log("Preventing usage message for player-owned actor",[a.name]),i.create=!1)}static _onPostUseActivity(t,e,s,i){var o;if(game.user.isGM&&t.type===Be.SAVE){r.log("_onPostUseActivity triggered",[t.damage]);const l=E(),n=A.get(l.skipRollDialog.tag);t.damage&&((o=t.damage.parts)==null?void 0:o.length)>0&&t.rollDamage(e,{...s,configure:!n},i)}}static _onRenderSkillToolDialog(t,e,s){var o,l;if(r.log("_onRenderSkillToolDialog triggered",[t]),t._abilityFlavorFixed)return;const i=e.querySelector('select[name="ability"]');if(i&&(o=t.config)!=null&&o.isRollRequest&&(l=t.config)!=null&&l.ability){const n=i.value,a=t.config.ability;n===a&&(t._abilityFlavorFixed=!0,setTimeout(()=>{const c=new Event("change",{bubbles:!0,cancelable:!0});i.dispatchEvent(c)},50))}}static onRefreshTemplate(t,e){if(!t.isOwner)return;const s=`refresh-template-${t.id}`,i=E(),o=A.get(i.templateAutoTarget.tag);Z.throttleTimers[s]&&clearTimeout(Z.throttleTimers[s]),Z.throttleTimers[s]=setTimeout(()=>{let l=3;switch(o){case 1:l=3;break;case 2:l=0;break;default:return}game.user.targets.forEach(a=>a.setTarget(!1,{releaseOthers:!1}));const n=[];for(let a of canvas.tokens.placeables)a.document.disposition<=l&&t.shape.contains(a.center.x-t.x,a.center.y-t.y)&&n.push(a);n.forEach((a,c)=>{a.setTarget(!0,{releaseOthers:c===0,groupSelection:!0})}),n.length>0&&game.user.broadcastActivity({targets:game.user.targets.ids}),delete Z.throttleTimers[s]},50)}};D(Z,"registeredHooks",new Map),D(Z,"midiTimeout",null),D(Z,"throttleTimers",{});let ke=Z;class Fe{static async handleRequest(t){var i;const e=G.isModuleOn(_,"midi-qol");if(r.log("handleRequest",[t]),game.user.isGM)return;const s=game.actors.get(t.actorId);!s||!s.isOwner||(e&&t.rollProcessConfig.midiOptions&&(t.rollProcessConfig.midiOptions={...t.rollProcessConfig.midiOptions,fastForward:!1,fastForwardAttack:!1,dialogOptions:{...t.rollProcessConfig.midiOptions.dialogOptions,fastForward:!1,fastForwardAttack:!1},workflowOptions:{...t.rollProcessConfig.midiOptions.workflowOptions,fastForward:!1,fastForwardAttack:!1}}),t.preserveTargets&&((i=t.targetTokenIds)==null?void 0:i.length)>0&&game.user.targets.size===0&&ct(t.targetTokenIds),H.notify("info","",{batch:!0,batchData:{actor:s.name,rollType:t.rollType,rollKey:t.rollKey,gm:t.rollProcessConfig._requestedBy||"GM"}}),Fe.executePlayerRollRequest(s,t))}static async executePlayerRollRequest(t,e){var i,o;const s=E();A.get(s.publicPlayerRolls.tag),r.log("executePlayerRollRequest",[t,e]);try{const l=(i=e.rollType)==null?void 0:i.toLowerCase(),n=((o=e.rollProcessConfig.rolls)==null?void 0:o[0])||{parts:[],data:{},options:{}},c={configure:!(game.user.isGM?e.skipRollDialog:!1)},d=e.rollProcessConfig.rollMode,g=game.settings.get("core","rollMode"),p={rollMode:d||g,create:e.rollProcessConfig.chatMessage!==!1},m={rollKey:e.rollKey,activityId:e.activityId,config:e.rollProcessConfig,groupRollId:e.groupRollId},R=z[l];R?await R(t,m,n,c,p):(r.warn(`No handler found for roll type: ${l}`),H.notify("warn",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:t.name||"Unknown Actor"})))}catch(l){r.error("Error executing roll request:",[l]),H.notify("error",game.i18n.format("FLASH_ROLLS.notifications.rollError",{actor:t.name||"Unknown Actor"}))}}}class ce{static init(){J.initialize(ce.registerSocketCalls),ke.initialize()}static getDiceConfig(){return ne.getDiceConfig()}static receiveDiceConfig(t,e){ne.receiveDiceConfig(t,e)}static async handleRollRequest(t){return r.log("Main.handleRollRequest",t),Fe.handleRequest(t)}static registerSocketCalls(){J.registerCall(Ie.getDiceConfig,ce.getDiceConfig),J.registerCall(Ie.receiveDiceConfig,ce.receiveDiceConfig),J.registerCall(Ie.handleRollRequest,ce.handleRollRequest)}}ce.init();
//# sourceMappingURL=flash-rolls-5e.js.map
